using FintrakBanking.Common.Enum;
using FintrakBanking.Entities.Models;
using FintrakBanking.ViewModels.Credit;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Data;
using NodaTime;
using FintrakBanking.ViewModels;
using FintrakBanking.Interfaces.Credit;
using System.ComponentModel.Composition;
using System.ServiceModel;
using FintrakBanking.Interfaces.Setups.General;
using XLeratorDLL_financial;
using OfficeOpenXml.Style;
using System.Drawing;
using OfficeOpenXml;
using FintrakBanking.Common.CustomException;
using FintrakBanking.Interfaces.Customer;

namespace FintrakBanking.Repositories.Credit
{
    using wct = XLeratorDLL_financial.XLeratorDLL_financial;
    using FinancialTypes = XLeratorDLL_financial.FinancialTypes;


    public class LoanScheduleRepository : ILoanScheduleRepository
    {
        private FinTrakBankingContext context;
        private IGeneralSetupRepository generalSetup;
        private ILoanCovenantRepository loanCovenant;

        public LoanScheduleRepository(FinTrakBankingContext _context, IGeneralSetupRepository _genSetup, ILoanCovenantRepository _loanCovenant)
        {
            this.context = _context;
            this.generalSetup = _genSetup;
            this.loanCovenant = _loanCovenant;
        }

        public int CalculateNumberOfInstallments(TenorModeEnum tenorModeId, short frequencyTypeId, int tenor)
        {
            double totalTenor = 0;

            if (tenorModeId == TenorModeEnum.Days)
                totalTenor = tenor / 365; //365 days in a year
            else if (tenorModeId == TenorModeEnum.Months)
                totalTenor = tenor / 12; //12 = months in a year
            else if (tenorModeId == TenorModeEnum.Years)
                totalTenor = tenor;

            if (frequencyTypeId == 10 || frequencyTypeId == 11) // 10 = end of period and 11 = now
                return 1;

            var frequencyValue = context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == frequencyTypeId).VALUE;

            var installments = totalTenor * frequencyValue;

            return (int)installments;
        }

        public int CalculateNumberOfInstallments(DateTime firstPaymentDate, DateTime maturityDate, FrequencyTypeEnum frequencyType)
        {
            var startdate = LocalDateTime.FromDateTime(firstPaymentDate);
            var endDate = LocalDateTime.FromDateTime(maturityDate);

            //Period period = Period.Between(startdate, endDate, PeriodUnits.Months);

            double numberOfpayments = 0;

            if (frequencyType == FrequencyTypeEnum.Daily)
                numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Days).Days;
            else if (frequencyType == FrequencyTypeEnum.Monthly)
                numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months;
            else if (frequencyType == FrequencyTypeEnum.Quarterly)
                numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months / 3.0;
            else if (frequencyType == FrequencyTypeEnum.SixTimesYearly)
                numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months / 2.0;
            else if (frequencyType == FrequencyTypeEnum.ThriceYearly)
                numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months / 4.0;
            else if (frequencyType == FrequencyTypeEnum.TwiceMonthly)
                numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months * 2.0;
            else if (frequencyType == FrequencyTypeEnum.TwiceYearly)
                numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months / 6.0;
            else if (frequencyType == FrequencyTypeEnum.Weekly)
                numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Weeks).Weeks;
            else if (frequencyType == FrequencyTypeEnum.Yearly)
                numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Years).Years;


            ////if (tenorModeId == TenorModeEnum.Days)
            //totalTenor = tenor / daysInAYear; //365 days in a year

            //var frequencyValue = context.tbl_Frequency_Type.FirstOrDefault(x => x.FrequencyTypeId == (short) frequencyType).Value;

            //var installments = totalTenor * frequencyValue;

            return Convert.ToInt32(numberOfpayments + 1);
        }

        public DateTime CalculateFirstPayDate(DateTime effectiveDate, short frequencyTypeId)
        {
            var frequencyValue = context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == frequencyTypeId).VALUE;

            DateTime output = effectiveDate.AddMonths(12 / (int)frequencyValue);
            return output;
        }

        public IEnumerable<LookupViewModel> GetAllLoanScheduleCategory()
        {
            return (from data in context.TBL_LOAN_SCHEDULE_CATEGORY
                    select new LookupViewModel()
                    {
                        lookupId = data.SCHEDULECATEGORYID,
                        lookupName = data.SCHEDULECATEGORYNAME
                    });
        }

        public IEnumerable<LookupViewModel> GetAllLoanScheduleType()
        {
            return (from data in context.TBL_LOAN_SCHEDULE_TYPE
                    select new LookupViewModel()
                    {
                        lookupId = data.SCHEDULETYPEID,
                        lookupName = data.SCHEDULETYPENAME,
                        lookupTypeId = data.SCHEDULECATEGORYID,
                        lookupTypeName = data.TBL_LOAN_SCHEDULE_CATEGORY.SCHEDULECATEGORYNAME
                    });
        }


        public List<LoanIrregularScheduleViewModel> GetIrregularSchedule(int loanApplicationDetailId)
        {

            List<LoanIrregularScheduleViewModel> result = new List<LoanIrregularScheduleViewModel>();

            try
            {
                result = (from a in context.TBL_LOAN_APPLICATION
                          join b in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONID equals b.LOANAPPLICATIONID
                          join c in context.TBL_LOAN on b.LOANAPPLICATIONDETAILID equals c.LOANAPPLICATIONDETAILID
                          join d in context.TBL_LOAN_SCHEDULE_IREGUL_INPUT on c.TERMLOANID equals d.LOANID
                          where b.LOANAPPLICATIONDETAILID == loanApplicationDetailId
                          select new LoanIrregularScheduleViewModel
                          {
                              realDate = d.PAYMENTDATE,
                              //interestAmount = d.PAYMENTAMOUNT,
                              payAmount = d.PAYMENTAMOUNT,
                              payTypeId = d.PAYMENTTYPEID,
                              //payType = Enum.GetName(typeof(LoanIrregularSchedulePaymentTypeEnum), d.PAYMENTTYPEID),
                          }).ToList().Select(x =>
                          {
                              x.payType = Enum.GetName(typeof(LoanIrregularSchedulePaymentTypeEnum), x.payTypeId);
                              return x;
                          }).ToList();


            }
            catch (Exception ex)
            {

                string me = ex.InnerException.InnerException.Message.ToString();
            }

            return result;

        }

        public IEnumerable<LookupViewModel> GetAllLoanScheduleType(short? productTypeId)
        {
            if (productTypeId == null || productTypeId <= 0)
            {
                return (from data in context.TBL_LOAN_SCHEDULE_TYPE
                        select new LookupViewModel()
                        {
                            lookupId = data.SCHEDULETYPEID,
                            lookupName = data.SCHEDULETYPENAME,
                            lookupTypeId = data.SCHEDULECATEGORYID,
                            lookupTypeName = data.TBL_LOAN_SCHEDULE_CATEGORY.SCHEDULECATEGORYNAME
                        });

            }
            else
            {
                return (from data in context.TBL_LOAN_SCHEDULE_TYPE
                        join t in context.TBL_LOAN_SCHEDULE_TYPE_PRODUCT
                        on data.SCHEDULETYPEID equals t.SCHEDULETYPEID
                        where t.PRODUCTTYPEID == productTypeId
                        select new LookupViewModel()
                        {
                            lookupId = data.SCHEDULETYPEID,
                            lookupName = data.SCHEDULETYPENAME,
                            lookupTypeId = data.SCHEDULECATEGORYID,
                            lookupTypeName = data.TBL_LOAN_SCHEDULE_CATEGORY.SCHEDULECATEGORYNAME
                        });
            }
        }

        public IEnumerable<LookupViewModel> GetLoanScheduleTypeByCategory(short categoryId)
        {
            return (from data in context.TBL_LOAN_SCHEDULE_TYPE
                    where data.SCHEDULECATEGORYID == categoryId
                    select new LookupViewModel()
                    {
                        lookupId = data.SCHEDULETYPEID,
                        lookupName = data.SCHEDULETYPENAME,
                        lookupTypeId = data.SCHEDULECATEGORYID,
                        lookupTypeName = data.TBL_LOAN_SCHEDULE_CATEGORY.SCHEDULECATEGORYNAME
                    });
        }

        public List<LoanPaymentSchedulePeriodicViewModel> GeneratePeriodicLoanSchedule(LoanPaymentScheduleInputViewModel loanInput)
        {
            List<LoanPaymentSchedulePeriodicViewModel> output = null; // new List<LoanPaymentSchedulePeriodicViewModel>();


            LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;


            if (loanInput.operationTypeId == (int)OperationsEnum.LoanRecapitilization)
            {
                loanInput.isExistingFacility = false;
            }

            if (loanInput.isExistingFacility == false)
            {

                if (loanInput.principalAmount <= 0)
                    throw new ConditionNotMetException("Please Enter Loan Amount");
                if (loanInput.interestRate < 0)
                    throw new ConditionNotMetException("Please Enter Loan Interest Amount");
                //if (loanInput.principalFirstpaymentDate < loanInput.effectiveDate)
                //    throw new ConditionNotMetException("First principal first payment date cannot be less than effective date ");
                //if (loanInput.interestFirstpaymentDate < loanInput.effectiveDate)
                //    throw new ConditionNotMetException("First interest first payment date cannot be less than effective date ");

                if (scheduleMethod != LoanScheduleTypeEnum.IrregularSchedule)
                {
                    if (loanInput.maturityDate < loanInput.effectiveDate)
                        throw new ConditionNotMetException("Maturity date cannot be less than effective date");
                }
                else
                {

                }

                if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                    output = GenerateIrregularPeriodicScheduleWithAmortisedCost(loanInput).ToList();
                else if (scheduleMethod == LoanScheduleTypeEnum.Annuity)
                {
                    if (loanInput.interestFirstpaymentDate == loanInput.principalFirstpaymentDate && loanInput.interestFrequency == loanInput.principalFrequency)
                        output = GenerateNormalAnnuityPeriodicSchedule(loanInput);
                    else
                        output = GenerateMoratoriumAnnuityPeriodicSchedule(loanInput);
                }
                else if (scheduleMethod == LoanScheduleTypeEnum.ReducingBalance)
                    output = GenerateReducingBalancePeriodicSchedule(loanInput);
                else if (scheduleMethod == LoanScheduleTypeEnum.BulletPayment)
                    output = GenerateBulletPeriodicScheduleWithAmortisedCost(loanInput);
                else if (scheduleMethod == LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                    output = GenerateConstantPrincipalAndInterestPeriodicScheduleWithAmortisedCost(loanInput);
                else if (scheduleMethod == LoanScheduleTypeEnum.BallonPayment)
                    output = GenerateBallonPeriodicSchedule(loanInput);

            }
            else
            {
                if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                    output = GenerateIrregularPeriodicScheduleWithAmortisedCost(loanInput).ToList();
                else if (scheduleMethod == LoanScheduleTypeEnum.Annuity)
                {
                    if (loanInput.interestFrequencyTypeId == loanInput.principalFrequencyTypeId)
                    {
                        if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.MaintainTenor)
                            output = PrepaymentWithNewAnnuity((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution);
                        else if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.UseExistingRepayment)
                            output = PrepaymentWithKeepExistingAnnuity((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution);
                        else if (loanInput.operationTypeId == (int)OperationsEnum.PaymentDateChange)
                        {
                            if ((int)loanInput.principalFrequencyTypeId == (int)FrequencyTypeEnum.Daily && (int)loanInput.interestFrequencyTypeId == (int)FrequencyTypeEnum.Daily)
                            {
                                throw new ConditionNotMetException("Payment Date Change Operation Cannot Be Apply To A Daily Schedule");
                            }

                            output = InterestRateChange((int)loanInput.loanId, loanInput.effectiveDate, loanInput.interestRate, (int)loanInput.interestFrequencyTypeId, loanInput.maturityDate);
                        }
                        else if (loanInput.prepaymentMethodId == null || loanInput.prepaymentMethodId == 0)
                            output = InterestRateChangeWithNewAnnuity((int)loanInput.loanId, loanInput.effectiveDate, loanInput.interestRate, (int)loanInput.interestFrequencyTypeId, loanInput.maturityDate);
                    }
                    else
                    {
                        if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.MaintainTenor)
                            output = PrepaymentWithNewAnnuityAndUnEqualPayment((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution, (int)loanInput.principalFrequencyTypeId, (int)loanInput.interestFrequencyTypeId);
                        else if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.UseExistingRepayment)
                            output = PrepaymentWithKeepExistingAnnuityAndUnEqualPayment((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution, (int)loanInput.principalFrequencyTypeId, (int)loanInput.interestFrequencyTypeId);
                        else if (loanInput.operationTypeId == (int)OperationsEnum.InterestandPrincipalFrequencyChange)
                        {
                            output = AnnuityFrequencyChange((int)loanInput.loanId, loanInput.effectiveDate, (int)loanInput.principalFrequencyTypeId, (int)loanInput.interestFrequencyTypeId, loanInput.interestRate, loanInput.maturityDate);
                        }
                        else if (loanInput.operationTypeId == (int)OperationsEnum.PaymentDateChange)
                        {
                            if ((int)loanInput.principalFrequencyTypeId == (int)FrequencyTypeEnum.Daily && (int)loanInput.interestFrequencyTypeId == (int)FrequencyTypeEnum.Daily)
                            {
                                throw new ConditionNotMetException("Payment Date Change Operation Cannot Be Apply To A Daily Schedule");
                            }

                            output = AnnuityFrequencyChange((int)loanInput.loanId, loanInput.effectiveDate, (int)loanInput.principalFrequencyTypeId, (int)loanInput.interestFrequencyTypeId, loanInput.interestRate, loanInput.maturityDate);
                        }
                        else
                            output = InterestRateChangeWithNewAnnuityAndUnEqualPayment((int)loanInput.loanId, loanInput.effectiveDate, (int)loanInput.principalFrequencyTypeId, (int)loanInput.interestFrequencyTypeId, loanInput.interestRate, loanInput.maturityDate);
                    }

                }
                else if (scheduleMethod == LoanScheduleTypeEnum.ReducingBalance)
                {
                    if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.MaintainTenor)
                        output = EvenPrincipalPaymentsKeepExistingNewAnnuity((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution);
                    else if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.UseExistingRepayment)
                        output = EvenPrincipalPaymentsKeepExistingAnnuity((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution);
                    else if (loanInput.interestFrequencyTypeId != loanInput.principalFrequencyTypeId)
                    {
                        throw new ConditionNotMetException("Different Frequency Method Cannot Be Apply To A Reducing Balance Schedule");
                    }
                    else if (loanInput.operationTypeId == (int)OperationsEnum.PaymentDateChange)
                    {
                        if ((int)loanInput.principalFrequencyTypeId == (int)FrequencyTypeEnum.Daily && (int)loanInput.interestFrequencyTypeId == (int)FrequencyTypeEnum.Daily)
                        {
                            throw new ConditionNotMetException("Payment Date Change Operation Cannot Be Apply To A Daily Schedule");
                        }

                        output = InterestRateChangeEvenPrincipalPaymentsKeepExistingNewAnnuityNew((int)loanInput.loanId, loanInput.effectiveDate, loanInput.interestRate, (int)loanInput.interestFrequencyTypeId, loanInput.maturityDate);
                    }
                    else
                        output = InterestRateChangeEvenPrincipalPaymentsKeepExistingNewAnnuity((int)loanInput.loanId, loanInput.effectiveDate, loanInput.interestRate, (int)loanInput.interestFrequencyTypeId, loanInput.maturityDate);
                }

                else if (scheduleMethod == LoanScheduleTypeEnum.BulletPayment)
                {
                    if (loanInput.equityContribution.HasValue && loanInput.equityContribution != 0)
                    {
                        output = BulletPrepayments((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution);
                    }
                    else if (loanInput.operationTypeId == (int)OperationsEnum.InterestandPrincipalFrequencyChange)
                    {
                        throw new ConditionNotMetException("Interest And Principal Frequency Change Operation Cannot Be Apply To A Bullet Payment Schedule");
                    }
                    else if (loanInput.operationTypeId == (int)OperationsEnum.PaymentDateChange)
                    {
                        throw new ConditionNotMetException("Payment Date Change Operation Cannot Be Apply To A Bullet Payment Schedule");
                    }
                    else
                    {
                        output = BulletInterestRateChange((int)loanInput.loanId, loanInput.effectiveDate, loanInput.interestRate, loanInput.maturityDate);
                    }

                }

                else if (scheduleMethod == LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                {
                    output = GenerateConstantPrincipalAndInterestPeriodicScheduleWithAmortisedCost(loanInput);
                }

                else if (scheduleMethod == LoanScheduleTypeEnum.BallonPayment)
                {
                    if (loanInput.equityContribution.HasValue && loanInput.equityContribution != 0)
                    {
                        output = BallonInterestRateChangePrepayment((int)loanInput.loanId, loanInput.effectiveDate, 0, (int)loanInput.interestFrequencyTypeId, loanInput.interestRate, (double)loanInput.equityContribution);
                    }
                    else if (loanInput.operationTypeId == (int)OperationsEnum.InterestandPrincipalFrequencyChange)
                    {
                        throw new ConditionNotMetException("Interest And Principal Frequency Change Operation Cannot Be Apply To A Ballon Payment Schedule");
                    }
                    else if (loanInput.operationTypeId == (int)OperationsEnum.PaymentDateChange)
                    {
                        throw new ConditionNotMetException("Payment Date Change Operation Cannot Be Apply To A Ballon Payment Schedule");
                    }
                    else
                    {
                        output = BallonInterestRateChange((int)loanInput.loanId, loanInput.effectiveDate, 0, (int)loanInput.interestFrequencyTypeId, loanInput.interestRate, loanInput.maturityDate);
                    }
                }

            }

            return output;
        }

        public byte[] GenerateLoanScheduleExport(LoanPaymentScheduleInputViewModel loanInput)
        {
            if (loanInput.principalAmount <= 0)
                throw new ConditionNotMetException("Please Enter Loan Amount");
            if (loanInput.interestRate < 0)
                throw new ConditionNotMetException("Please Enter Loan Interest Amount");
            List<LoanPaymentSchedulePeriodicViewModel> output = null; // new List<LoanPaymentSchedulePeriodicViewModel>();
            LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;

            if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                output = GenerateIrregularPeriodicScheduleWithAmortisedCost(loanInput).ToList();
            else if (scheduleMethod == LoanScheduleTypeEnum.Annuity)
            {
                if (loanInput.interestFirstpaymentDate == loanInput.principalFirstpaymentDate && loanInput.interestFrequency == loanInput.principalFrequency)
                    output = GenerateNormalAnnuityPeriodicSchedule(loanInput);
                else
                    output = GenerateMoratoriumAnnuityPeriodicSchedule(loanInput);
            }
            else if (scheduleMethod == LoanScheduleTypeEnum.ReducingBalance)
                output = GenerateReducingBalancePeriodicSchedule(loanInput);
            else if (scheduleMethod == LoanScheduleTypeEnum.BulletPayment)
                output = GenerateBulletPeriodicScheduleWithAmortisedCost(loanInput);
            else if (scheduleMethod == LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                output = GenerateConstantPrincipalAndInterestPeriodicScheduleWithAmortisedCost(loanInput);
            else if (scheduleMethod == LoanScheduleTypeEnum.BallonPayment)
                output = GenerateBallonPeriodicSchedule(loanInput);

            Byte[] fileBytes = null;

            if (output != null)
            {

                using (ExcelPackage pck = new ExcelPackage())
                {
                    ExcelWorksheet ws = pck.Workbook.Worksheets.Add("SearchReport");
                    ws.DefaultColWidth = 20;
                    ws.Cells.Style.WrapText = true;

                    ws.Cells["A2:F2"].Merge = true;
                    ws.Cells["A3:F3"].Merge = true;
                    ws.Cells["A4:F4"].Merge = true;
                    ws.Cells["A5:F5"].Merge = true;

                    ws.Cells["A2:F2"].Style.Font.Bold = true;
                    ws.Cells["A3:F3"].Style.Font.Bold = true;
                    ws.Cells["A4:F4"].Style.Font.Bold = true;
                    ws.Cells["A5:F5"].Style.Font.Bold = true;

                    ws.Cells[2, 1].Value = "GRANTED AMOUNT  :  " + loanInput.principalAmount;
                    ws.Cells[3, 1].Value = "INTEREST AMOUNT  :  " + loanInput.interestRate;
                    ws.Cells[4, 1].Value = "EFFECTIVE DATE  :  " + loanInput.effectiveDate;
                    ws.Cells[5, 1].Value = "MATURITY DATE  :  " + loanInput.maturityDate;

                    ws.Cells[7, 1].Value = "Payment Number";
                    ws.Cells[7, 2].Value = "Payment Date";
                    ws.Cells[7, 3].Value = "Start Principal";
                    ws.Cells[7, 4].Value = "Period Amount";
                    ws.Cells[7, 5].Value = "Principal Amount";
                    ws.Cells[7, 6].Value = "Interest Amount";
                    ws.Cells[7, 7].Value = "Balance";
                    ws.Cells[7, 8].Value = "AM Start Principal";
                    ws.Cells[7, 9].Value = "AM Periodic Amount";
                    ws.Cells[7, 10].Value = "AM Principal Amount";
                    ws.Cells[7, 11].Value = "AM Interest Amount";
                    ws.Cells[7, 12].Value = "AM Balancet";


                    Color colFromHex = System.Drawing.ColorTranslator.FromHtml("#B8860B");
                    ws.Cells["A7:K8"].Style.Fill.PatternType = ExcelFillStyle.Solid;
                    ws.Cells["A7:K8"].Style.Fill.BackgroundColor.SetColor(colFromHex);
                    ws.Cells["A7:K8"].Style.Font.Bold = true;

                    ws.Cells["A7:K8"].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    ws.Cells["A7:K8"].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    ws.Cells["A7:K8"].Style.Border.Right.Style = ExcelBorderStyle.Thin;
                    ws.Cells["A7:K8"].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;

                    for (int i = 8; i <= output.Count + 7; i++)
                    {
                        var record = output[i - 8];
                        ws.Cells[i, 1].Value = i - 7;
                        ws.Cells[i, 2].Value = record.paymentDate;
                        ws.Cells[i, 3].Value = record.startPrincipalAmount;
                        ws.Cells[i, 4].Value = record.periodPaymentAmount;
                        ws.Cells[i, 5].Value = record.periodPrincipalAmount;
                        ws.Cells[i, 6].Value = record.periodInterestAmount;
                        ws.Cells[i, 7].Value = record.endPrincipalAmount;
                        ws.Cells[i, 8].Value = record.amortisedStartPrincipalAmount;
                        ws.Cells[i, 9].Value = record.amortisedPeriodPaymentAmount;
                        ws.Cells[i, 10].Value = record.amortisedPeriodPrincipalAmount;
                        ws.Cells[i, 11].Value = record.amortisedPeriodInterestAmount;
                        ws.Cells[i, 12].Value = record.amortisedEndPrincipalAmount;

                    }
                    fileBytes = pck.GetAsByteArray();
                }


            }

            return fileBytes;
        }

        public int GetDaysInAYear(DayCountConventionEnum dayCountId)
        {
            if (dayCountId == DayCountConventionEnum.Actual_Actual)
            {
                var currentDate = DateTime.Now;
                var firstDate = new DateTime(currentDate.Year, 1, 1); //  DateTime.ParseExact(user, "MM-dd-yyyy", System.Globalization.CultureInfo.InvariantCulture);
                var lastdate = new DateTime(currentDate.Year, 12, 31);
                var difference = (lastdate - firstDate).TotalDays + 1;

                if (Convert.ToInt32(difference) > 365) difference = 365;

                return Convert.ToInt32(difference);
            }

            var value = context.TBL_DAY_COUNT_CONVENTION.FirstOrDefault(x => x.DAYCOUNTCONVENTIONID == (short)dayCountId).DAYSINAYEAR;
            if (value > 365) value = 365;

            return value;
        }

        private double CalculateIRR(LoanPaymentScheduleInputViewModel loanInput, List<LoanPaymentSchedulePeriodicViewModel> cashflow, int numberOfPayments, int numberOfPaymentsInAYear,
                                    int daysInAYear, Double FV, string interestRule, DateTime maturityDate)
        {
            double output = 0;


            if (loanInput.integralFeeAmount == 0)
                output = loanInput.interestRate / 100;
            else if (numberOfPayments < 2 && loanInput.interestRate > 0)
            {
                //var amounts = paymentSchedule.Where(x => x.paymentNumber > 0).Select(x => x.periodPaymentAmount).ToList();
                //var dates = paymentSchedule.Where(x => x.paymentNumber > 0).Select(x => x.paymentDate).ToList();

                List<double> cashflowAmounts = new List<double>();
                List<int> paymentNumbers = new List<int>();

                cashflowAmounts.Add((loanInput.principalAmount - loanInput.integralFeeAmount) * -1);
                paymentNumbers.Add(0);

                var counter = 0;
                foreach (var payment in cashflow)
                {
                    if (counter > 0)
                    {
                        cashflowAmounts.Add(payment.periodPaymentAmount);
                        paymentNumbers.Add(payment.paymentNumber);
                    }

                    counter += 1;
                }

                output = wct.IRR(cashflowAmounts, paymentNumbers, wct.NULL_DOUBLE);
            }
            else if (numberOfPayments > 1 && loanInput.interestRate > 0)
            {
                var pmt = wct.LPMT(loanInput.principalAmount, loanInput.effectiveDate, loanInput.interestRate / 100.0, loanInput.interestFirstpaymentDate, numberOfPayments, numberOfPaymentsInAYear,
                                   daysInAYear, FV, interestRule);

                output = wct.LRATE(loanInput.principalAmount - loanInput.integralFeeAmount, loanInput.effectiveDate, pmt, loanInput.interestFirstpaymentDate, numberOfPayments, numberOfPaymentsInAYear,
                                      daysInAYear, 0, interestRule, wct.NULL_DOUBLE);

                //  SELECT @IRR = wct.LRATE(
                // @la - @fa--PV
                //, @sd--Loan Date
                //,[wct].[LPMT](@la, @sd, cast(cast(@rt as float) / cast(100 as float) as float), @fpd, @np, @rfqy, @NDY, NULL, 'U')--PMT
                //, @fpd--FirstPayment Date
                //, @np--Number ofPaymens
                //, @rfqy--Payments peryear
                //, @NDY--Days in Year
                //, 0--FV
                //, 'U'--InterestRule
                //, NULL--Guess
                //)

            }
            else if (loanInput.interestRate <= 0)
                output = 0;

            if (loanInput.interestFirstpaymentDate == maturityDate)
            {
                Period period = Period.Between(LocalDateTime.FromDateTime(loanInput.interestFirstpaymentDate), LocalDateTime.FromDateTime(maturityDate));
                /// modify by Gbenga to be approve by Anu(Reasons that var maturityDate = output.Max(x => x.paymentDate) makes MaturityDate and FirstPaymentDate qual)
                if (period.Days == 0)
                {
                    output = output * (daysInAYear / 1);
                }
                else
                {
                    output = output * (daysInAYear / period.Days);
                }

                //output = output * (daysInAYear / period.Days);
            }

            return output * 100;
        }


        /// <summary>
        /// USE FOR NORMAL ANNUITY SCHEDULE AS SHOWN WHERE INTEREST AND PRINCIPAL DROPS THE SAME DAY
        /// </summary>
        /// <param name="loanInput"></param>
        /// <returns></returns>         
        private List<LoanPaymentSchedulePeriodicViewModel> GenerateNormalAnnuityPeriodicSchedule(LoanPaymentScheduleInputViewModel loanInput)
        {
            if (loanInput.effectiveDate == null)
                throw new ConditionNotMetException("Please Enter Effective Date");
            if (loanInput.maturityDate == null)
                throw new ConditionNotMetException("Please Enter Maturity Date");
            if (loanInput.interestFirstpaymentDate == null)
                throw new ConditionNotMetException("Please Enter First Interest Payment Date");
            if (loanInput.principalFirstpaymentDate == null)
                throw new ConditionNotMetException("Please Enter First Principal Payment Date");
            if (loanInput.principalAmount <= 0)
                throw new ConditionNotMetException("Please Enter Loan Amount");
            if (loanInput.effectiveDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("Effective Date must be less than the maturity date");
            if (loanInput.interestFirstpaymentDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("First Interest Payment Date must be less than the maturity date");
            if (loanInput.principalFirstpaymentDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("First Principal Payment Date must be less than the maturity date");
            if (loanInput.effectiveDate > loanInput.principalFirstpaymentDate)
                throw new ConditionNotMetException("First Principal Payment Date cannot be less than the effective date");
            if (loanInput.effectiveDate > loanInput.interestFirstpaymentDate)
                throw new ConditionNotMetException("First Interest Payment Date cannot be less than the effective date");
            if (loanInput.principalFirstpaymentDate < loanInput.interestFirstpaymentDate)
                throw new ConditionNotMetException("Principal first payment date cannot be less than the interest first payment date");

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanInput.accrualBasis);
            int numberOfPayments = CalculateNumberOfInstallments(loanInput.interestFirstpaymentDate, loanInput.maturityDate, (FrequencyTypeEnum)loanInput.interestFrequency);
            int numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loanInput.interestFrequency).VALUE;

            Double FV;
            FinancialTypes.InterestRuleType IntRule;
            FinancialTypes.AMORTSCHED_table result;

            FV = wct.NULL_DOUBLE;
            IntRule = FinancialTypes.InterestRuleType.US;

            //result = wct.AMORTSCHED(PV, LoanDate, rate, FirstPayDate, NumPmts, Pmtpyr, DaysInYr, FV, IntRule);
            try
            {
                result = wct.AMORTSCHED(loanInput.principalAmount, loanInput.effectiveDate, (loanInput.interestRate / 100.0), loanInput.interestFirstpaymentDate, numberOfPayments, numberOfPaymentsInAYear, daysInAYear, FV, IntRule);
            }
            catch (Exception ex)
            {
                throw new ConditionNotMetException("Sorry your schedule generation library solution licence has expired");
            }

            int counter = 0;
            foreach (DataRow row in result.Rows)
            {
                LoanPaymentSchedulePeriodicViewModel payment = new LoanPaymentSchedulePeriodicViewModel();
                payment.paymentNumber = Convert.ToInt32(row["num_pmt"]);
                payment.paymentDate = Convert.ToDateTime(row["date_pmt"]);
                payment.startPrincipalAmount = Convert.ToDouble(row["amt_prin_init"]);
                payment.periodPaymentAmount = Convert.ToDouble(row["amt_pmt"]);
                payment.periodInterestAmount = Convert.ToDouble(row["amt_int_pay"]);
                payment.periodPrincipalAmount = Convert.ToDouble(row["amt_prin_pay"]);
                payment.endPrincipalAmount = Convert.ToDouble(row["amt_prin_end"]);
                payment.interestRate = loanInput.interestRate;

                output.Add(payment);

                counter += 1;
            }

            var maturityDate = output.Max(x => x.paymentDate); //loanInput.maturityDate

            var internalRateOfReturn = CalculateIRR(loanInput, output, numberOfPayments, numberOfPaymentsInAYear,
                                             daysInAYear, FV, "U", maturityDate);

            FinancialTypes.AMORTSCHED_table amortisedResult;
            amortisedResult = wct.AMORTSCHED(loanInput.principalAmount - loanInput.integralFeeAmount, loanInput.effectiveDate, (internalRateOfReturn / 100.0), loanInput.interestFirstpaymentDate, numberOfPayments, numberOfPaymentsInAYear, daysInAYear, FV, IntRule);

            counter = 0;
            foreach (var payment in output)
            {
                payment.amortisedStartPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_init"]);
                payment.amortisedPeriodPaymentAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_pmt"]);
                payment.amortisedPeriodInterestAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_int_pay"]);
                payment.amortisedPeriodPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_pay"]);
                payment.amortisedEndPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_end"]);
                payment.effectiveInterestRate = internalRateOfReturn;

                counter += 1;
            }

            return output;

        }

        /// <summary>
        /// USE FOR ANNUITY SCHEDULE WHERE THERE IS A MORATORIUM 
        /// </summary>
        /// <param name="loanInput"></param>
        /// <returns></returns>         
        private List<LoanPaymentSchedulePeriodicViewModel> GenerateMoratoriumAnnuityPeriodicSchedule(LoanPaymentScheduleInputViewModel loanInput)
        {
            int principalPaymentMultiple;
            int ppm;
            if (loanInput.effectiveDate == null)
                throw new ConditionNotMetException("Please Enter Effective Date");
            if (loanInput.maturityDate == null)
                throw new ConditionNotMetException("Please Enter Maturity Date");
            if (loanInput.interestFirstpaymentDate == null)
                throw new ConditionNotMetException("Please Enter First Interest Payment Date");
            if (loanInput.principalFirstpaymentDate == null)
                throw new ConditionNotMetException("Please Enter First Principal Payment Date");
            if (loanInput.principalAmount <= 0)
                throw new ConditionNotMetException("Please Enter Loan Amount");
            if (loanInput.principalFrequency <= 0)
                throw new ConditionNotMetException("Please Select Principal Frequency");
            if (loanInput.interestFrequency <= 0)
                throw new ConditionNotMetException("Please Select Interest Frequency");
            if (loanInput.effectiveDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("Effective Date must be less than the maturity date");
            if (loanInput.interestFirstpaymentDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("First Interest Payment Date must be less than the maturity date");
            if (loanInput.principalFirstpaymentDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("First Principal Payment Date must be less than the maturity date");
            if (loanInput.effectiveDate > loanInput.principalFirstpaymentDate)
                throw new ConditionNotMetException("First Principal Payment Date cannot be less than the effective date");
            if (loanInput.effectiveDate > loanInput.interestFirstpaymentDate)
                throw new ConditionNotMetException("First Interest Payment Date cannot be less than the effective date");
            if (loanInput.principalFirstpaymentDate < loanInput.interestFirstpaymentDate)
                throw new ConditionNotMetException("Principal first payment date cannot be less than the interest first payment date");

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanInput.accrualBasis);
            int numberOfPayments = CalculateNumberOfInstallments(loanInput.interestFirstpaymentDate, loanInput.maturityDate, (FrequencyTypeEnum)loanInput.interestFrequency);

            int numberOfPrincipalPayments = CalculateNumberOfInstallments(loanInput.principalFirstpaymentDate, loanInput.maturityDate, (FrequencyTypeEnum)loanInput.interestFrequency);

            int numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loanInput.interestFrequency).VALUE;

            var principalPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loanInput.principalFrequency).VALUE;

            //principalPaymentMultiple  = Convert.ToInt32(12 / principalPaymentsInAYear);

            ppm = Convert.ToInt32(12 / principalPaymentsInAYear);

            if (ppm == 0)
            {
                principalPaymentMultiple = 1;
            }
            else
            {
                principalPaymentMultiple = ppm;
            }

            var principalFirstPaymentNumber = (numberOfPayments - numberOfPrincipalPayments) + 1;

            Double FV = 0;

            FinancialTypes.UNEQUALLOANPAYMENTS_table result;


            //result = wct.AMORTSCHED(loanInput.principalAmount, loanInput.effectiveDate, (loanInput.interestRate / 100.0), loanInput.interestFirstpaymentDate, numberOfPayments, numberOfPaymentsInAYear, daysInAYear, FV, IntRule);

            result = wct.UNEQUALLOANPAYMENTS(loanInput.principalAmount, (loanInput.interestRate / 100.0), loanInput.effectiveDate, numberOfPaymentsInAYear, loanInput.interestFirstpaymentDate, daysInAYear, principalPaymentMultiple, principalFirstPaymentNumber, numberOfPayments, wct.NULL_INT, FV, true);


            int counter = 0;
            foreach (DataRow row in result.Rows)
            {
                LoanPaymentSchedulePeriodicViewModel payment = new LoanPaymentSchedulePeriodicViewModel();
                payment.paymentNumber = Convert.ToInt32(row["num_pmt"]);
                payment.paymentDate = Convert.ToDateTime(row["date_pmt"]);
                payment.startPrincipalAmount = Convert.ToDouble(row["amt_prin_init"]);
                payment.periodPaymentAmount = Convert.ToDouble(row["amt_pmt"]);
                payment.periodInterestAmount = Convert.ToDouble(row["amt_int_pay"]);
                payment.periodPrincipalAmount = Convert.ToDouble(row["amt_prin_pay"]);
                payment.endPrincipalAmount = Convert.ToDouble(row["amt_prin_end"]);
                payment.interestRate = loanInput.interestRate;

                output.Add(payment);

                counter += 1;
            }

            var maturityDate = output.Max(x => x.paymentDate); //loanInput.maturityDate

            var internalRateOfReturn = CalculateIRR(loanInput, output, numberOfPayments, numberOfPaymentsInAYear,
                                             daysInAYear, FV, "U", maturityDate);

            FinancialTypes.UNEQUALLOANPAYMENTS_table amortisedResult;

            amortisedResult = wct.UNEQUALLOANPAYMENTS(loanInput.principalAmount - loanInput.integralFeeAmount, (internalRateOfReturn / 100.0), loanInput.effectiveDate, numberOfPaymentsInAYear, loanInput.interestFirstpaymentDate, daysInAYear, principalPaymentMultiple, principalFirstPaymentNumber, numberOfPayments, wct.NULL_INT, FV, true);

            counter = 0;
            foreach (var payment in output)
            {
                payment.amortisedStartPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_init"]);
                payment.amortisedPeriodPaymentAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_pmt"]);
                payment.amortisedPeriodInterestAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_int_pay"]);
                payment.amortisedPeriodPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_pay"]);
                payment.amortisedEndPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_end"]);
                payment.effectiveInterestRate = internalRateOfReturn;

                counter += 1;
            }

            return output;

        }

        private List<LoanPaymentSchedulePeriodicViewModel> GenerateBallonPeriodicSchedule(LoanPaymentScheduleInputViewModel loanInput)
        {
            if (loanInput.effectiveDate == null)
                throw new ConditionNotMetException("Please Enter Effective Date");
            if (loanInput.maturityDate == null)
                throw new ConditionNotMetException("Please Enter Maturity Date");

            //if (loanInput.principalFirstpaymentDate == null)
            //    throw new ConditionNotMetException("Please Enter First Principal Payment Date");

            if (loanInput.interestFrequency == null)
            {
                loanInput.interestFrequency = (short)loanInput.interestFrequencyTypeId;
            }

            if (loanInput.principalAmount <= 0)
                throw new ConditionNotMetException("Please Enter Loan Amount");
            if (loanInput.interestFrequencyTypeId <= 0)
                throw new ConditionNotMetException("Please Select Interest Frequency");
            if (loanInput.effectiveDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("Effective Date must be less than the maturity date");

            //if (loanInput.principalFirstpaymentDate >= loanInput.maturityDate)
            //    throw new ConditionNotMetException("First Principal Payment Date must be less than the maturity date");
            //if (loanInput.effectiveDate > loanInput.principalFirstpaymentDate)
            //    throw new ConditionNotMetException("First Principal Payment Date cannot be less than the effective date");
            //if (loanInput.principalFirstpaymentDate < loanInput.interestFirstpaymentDate)
            //    throw new ConditionNotMetException("Principal first payment date cannot be less than the interest first payment date");

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanInput.accrualBasis);
            int numberOfPayments = CalculateNumberOfInstallments(loanInput.interestFirstpaymentDate, loanInput.maturityDate, (FrequencyTypeEnum)loanInput.interestFrequency);

            int numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loanInput.interestFrequency).VALUE;

            int principalPaymentMultiple = 1;

            var principalFirstPaymentNumber = numberOfPayments;

            Double FV = 0;

            FinancialTypes.UNEQUALLOANPAYMENTS_table result;


            result = wct.UNEQUALLOANPAYMENTS(loanInput.principalAmount, (loanInput.interestRate / 100.0), loanInput.effectiveDate, numberOfPaymentsInAYear, loanInput.interestFirstpaymentDate, daysInAYear, principalPaymentMultiple, principalFirstPaymentNumber, numberOfPayments, wct.NULL_INT, FV, true);


            int counter = 0;
            foreach (DataRow row in result.Rows)
            {
                LoanPaymentSchedulePeriodicViewModel payment = new LoanPaymentSchedulePeriodicViewModel();
                payment.paymentNumber = Convert.ToInt32(row["num_pmt"]);
                payment.paymentDate = Convert.ToDateTime(row["date_pmt"]);
                payment.startPrincipalAmount = Convert.ToDouble(row["amt_prin_init"]);
                payment.periodPaymentAmount = Convert.ToDouble(row["amt_pmt"]);
                payment.periodInterestAmount = Convert.ToDouble(row["amt_int_pay"]);
                payment.periodPrincipalAmount = Convert.ToDouble(row["amt_prin_pay"]);
                payment.endPrincipalAmount = Convert.ToDouble(row["amt_prin_end"]);
                payment.interestRate = loanInput.interestRate;

                output.Add(payment);

                counter += 1;
            }

            var maturityDate = output.Max(x => x.paymentDate); //loanInput.maturityDate

            var internalRateOfReturn = CalculateIRR(loanInput, output, numberOfPayments, numberOfPaymentsInAYear,
                                             daysInAYear, FV, "U", maturityDate);

            FinancialTypes.UNEQUALLOANPAYMENTS_table amortisedResult;

            amortisedResult = wct.UNEQUALLOANPAYMENTS(loanInput.principalAmount - loanInput.integralFeeAmount, (internalRateOfReturn / 100.0), loanInput.effectiveDate, numberOfPaymentsInAYear, loanInput.interestFirstpaymentDate, daysInAYear, principalPaymentMultiple, principalFirstPaymentNumber, numberOfPayments, wct.NULL_INT, FV, true);

            counter = 0;
            foreach (var payment in output)
            {
                payment.amortisedStartPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_init"]);
                payment.amortisedPeriodPaymentAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_pmt"]);
                payment.amortisedPeriodInterestAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_int_pay"]);
                payment.amortisedPeriodPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_pay"]);
                payment.amortisedEndPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_end"]);
                payment.effectiveInterestRate = internalRateOfReturn;

                counter += 1;
            }

            return output;

        }
        /// <summary>
        /// USE FOR REDUCING BALANCE
        /// </summary>
        /// <param name="loanInput"></param>
        /// <returns></returns>         
        private List<LoanPaymentSchedulePeriodicViewModel> GenerateReducingBalancePeriodicSchedule(LoanPaymentScheduleInputViewModel loanInput)
        {
            if (loanInput.effectiveDate == null)
                throw new ConditionNotMetException("Please Enter Effective Date");
            if (loanInput.maturityDate == null)
                throw new ConditionNotMetException("Please Enter Maturity Date");
            if (loanInput.interestFirstpaymentDate == null)
                throw new ConditionNotMetException("Please Enter First Interest Payment Date");
            if (loanInput.principalFirstpaymentDate == null)
                throw new ConditionNotMetException("Please Enter First Principal Payment Date");
            if (loanInput.principalAmount <= 0)
                throw new ConditionNotMetException("Please Enter Loan Amount");
            if (loanInput.principalFrequency <= 0)
                throw new ConditionNotMetException("Please Select Principal Frequency");
            if (loanInput.interestFrequency <= 0)
                throw new ConditionNotMetException("Please Select Interest Frequency");
            if (loanInput.effectiveDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("Effective Date must be less than the maturity date");
            if (loanInput.interestFirstpaymentDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("First Interest Payment Date must be less than the maturity date");
            if (loanInput.principalFirstpaymentDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("First Principal Payment Date must be less than the maturity date");
            if (loanInput.effectiveDate > loanInput.principalFirstpaymentDate)
                throw new ConditionNotMetException("First Principal Payment Date cannot be less than the effective date");
            if (loanInput.effectiveDate > loanInput.interestFirstpaymentDate)
                throw new ConditionNotMetException("First Interest Payment Date cannot be less than the effective date");
            if (loanInput.principalFirstpaymentDate < loanInput.interestFirstpaymentDate)
                throw new ConditionNotMetException("Principal first payment date cannot be less than the interest first payment date");

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanInput.accrualBasis);
            int numberOfPayments = CalculateNumberOfInstallments(loanInput.interestFirstpaymentDate, loanInput.maturityDate, (FrequencyTypeEnum)loanInput.interestFrequency);

            int numberOfPrincipalPayments = CalculateNumberOfInstallments(loanInput.principalFirstpaymentDate, loanInput.maturityDate, (FrequencyTypeEnum)loanInput.interestFrequency);

            int numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loanInput.interestFrequency).VALUE;

            var principalPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loanInput.principalFrequency).VALUE;

            int principalPaymentMultiple = Convert.ToInt32(12 / principalPaymentsInAYear);

            var principalFirstPaymentNumber = (numberOfPayments - numberOfPrincipalPayments) + 1;

            int lastPaymentNumber = wct.NULL_INT;
            Double FV = wct.NULL_DOUBLE;
            Double PPMT = wct.NULL_DOUBLE;
            Boolean eom = true;

            FinancialTypes.CONSTPRINAMORT_table result;

            //result = wct.UNEQUALLOANPAYMENTS(loanInput.principalAmount, (loanInput.interestRate / 100.0), loanInput.effectiveDate, numberOfPaymentsInAYear, loanInput.interestFirstpaymentDate, daysInAYear, principalPaymentMultiple, principalFirstPaymentNumber, numberOfPayments, wct.NULL_INT, FV, true);

            result = wct.CONSTPRINAMORT(loanInput.principalAmount, (loanInput.interestRate / 100.0), loanInput.effectiveDate, numberOfPaymentsInAYear, loanInput.interestFirstpaymentDate, daysInAYear, numberOfPayments, lastPaymentNumber, principalFirstPaymentNumber, FV, PPMT, eom);

            int counter = 0;
            foreach (DataRow row in result.Rows)
            {
                LoanPaymentSchedulePeriodicViewModel payment = new LoanPaymentSchedulePeriodicViewModel();
                payment.paymentNumber = Convert.ToInt32(row["num_pmt"]);
                payment.paymentDate = Convert.ToDateTime(row["date_pmt"]);
                payment.startPrincipalAmount = Convert.ToDouble(row["amt_prin_init"]);
                payment.periodPaymentAmount = Convert.ToDouble(row["amt_pmt"]);
                payment.periodInterestAmount = Convert.ToDouble(row["amt_int_pay"]);
                payment.periodPrincipalAmount = Convert.ToDouble(row["amt_prin_pay"]);
                payment.endPrincipalAmount = Convert.ToDouble(row["amt_prin_end"]);
                payment.interestRate = loanInput.interestRate;

                output.Add(payment);

                counter += 1;
            }

            var maturityDate = output.Max(x => x.paymentDate); //loanInput.maturityDate

            var internalRateOfReturn = CalculateIRR(loanInput, output, numberOfPayments, numberOfPaymentsInAYear,
                                             daysInAYear, FV, "U", maturityDate);

            FinancialTypes.CONSTPRINAMORT_table amortisedResult;

            //amortisedResult = wct.UNEQUALLOANPAYMENTS(loanInput.principalAmount - loanInput.integralFeeAmount, (internalRateOfReturn / 100.0), loanInput.effectiveDate, numberOfPaymentsInAYear, loanInput.interestFirstpaymentDate, daysInAYear, principalPaymentMultiple, principalFirstPaymentNumber, numberOfPayments, wct.NULL_INT, FV, true);

            amortisedResult = wct.CONSTPRINAMORT(loanInput.principalAmount - loanInput.integralFeeAmount, (internalRateOfReturn / 100.0), loanInput.effectiveDate, numberOfPaymentsInAYear, loanInput.interestFirstpaymentDate, daysInAYear, numberOfPayments, lastPaymentNumber, principalFirstPaymentNumber, FV, PPMT, eom);

            counter = 0;
            foreach (var payment in output)
            {
                payment.amortisedStartPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_init"]);
                payment.amortisedPeriodPaymentAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_pmt"]);
                payment.amortisedPeriodInterestAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_int_pay"]);
                payment.amortisedPeriodPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_pay"]);
                payment.amortisedEndPrincipalAmount = Convert.ToDouble(amortisedResult.Rows[counter]["amt_prin_end"]);
                payment.effectiveInterestRate = internalRateOfReturn;

                counter += 1;
            }

            return output;

        }

        public List<LoanPaymentScheduleDailyViewModel> GenerateDailyLoanSchedule(LoanPaymentScheduleInputViewModel loanInput)
        {
            List<LoanPaymentScheduleDailyViewModel> output = new List<LoanPaymentScheduleDailyViewModel>();

            return output;

            //List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = GeneratePeriodicLoanSchedule(loanInput);

            //List<LoanPaymentScheduleDailyViewModel> output = new List<LoanPaymentScheduleDailyViewModel>();

            //var numberOfPeriods = periodicSchedule.Count() - 1;

            ////var numberOfPeriods = periodicSchedule.Count();

            //DateTime previousPaymentDate = loanInput.effectiveDate;

            //int dailyScheduleRowCount = 0;
            //int paymentNumber = 1;
            //foreach (var item in periodicSchedule)
            //{

            //    if (paymentNumber > 1)
            //    {
            //        //output.AddRange(GenerateDailyScheduleRange(item, previousPaymentDate));

            //        var dateDifferenceCount = (item.paymentDate - previousPaymentDate).TotalDays;
            //        var currentDate = previousPaymentDate; // item.paymentDate;
            //        double previousPrincipalAmount = item.startPrincipalAmount;
            //        double amPreviousPrincipalAmount = item.amortisedStartPrincipalAmount;
            //        double accuredInterest = 0;
            //        double amAccuredInterest = 0;

            //        for (int counter = 1; counter <= dateDifferenceCount; counter++)
            //        {
            //            LoanPaymentScheduleDailyViewModel dayValues = new LoanPaymentScheduleDailyViewModel();
            //            dayValues.paymentNumber = dailyScheduleRowCount;
            //            dayValues.paymentDate = item.paymentDate;
            //            dayValues.date = currentDate;

            //            dayValues.openingBalance = previousPrincipalAmount;
            //            dayValues.startPrincipalAmount = item.startPrincipalAmount;
            //            dayValues.dailyPrincipalAmount = item.periodPrincipalAmount / dateDifferenceCount;
            //            dayValues.dailyInterestAmount = item.periodInterestAmount / dateDifferenceCount;
            //            dayValues.dailyPaymentAmount = dayValues.dailyPrincipalAmount + dayValues.dailyInterestAmount;
            //            dayValues.closingBalance = dayValues.openingBalance - dayValues.dailyPrincipalAmount;
            //            dayValues.endPrincipalAmount = item.endPrincipalAmount;
            //            dayValues.accruedInterest = accuredInterest + dayValues.dailyInterestAmount;
            //            dayValues.amortisedCost = dayValues.startPrincipalAmount + dayValues.accruedInterest;
            //            dayValues.norminalInterestRate = loanInput.interestRate;

            //            dayValues.amOpeningBalance = amPreviousPrincipalAmount;
            //            dayValues.amStartPrincipalAmount = item.amortisedStartPrincipalAmount;
            //            dayValues.amDailyPrincipalAmount = item.amortisedPeriodPrincipalAmount / dateDifferenceCount;
            //            dayValues.amDailyInterestAmount = item.amortisedPeriodInterestAmount / dateDifferenceCount;
            //            dayValues.amDailyPaymentAmount = dayValues.amDailyPrincipalAmount + dayValues.amDailyInterestAmount;
            //            dayValues.amClosingBalance = dayValues.amOpeningBalance - dayValues.amDailyPrincipalAmount;
            //            dayValues.amEndPrincipalAmount = item.amortisedEndPrincipalAmount;
            //            dayValues.amAccruedInterest = amAccuredInterest + dayValues.amDailyInterestAmount;
            //            dayValues.amAmortisedCost = dayValues.amStartPrincipalAmount + dayValues.amAccruedInterest;

            //            dayValues.discountPremium = dayValues.amDailyInterestAmount - dayValues.dailyInterestAmount;
            //            dayValues.unEarnedFee = dayValues.amClosingBalance - dayValues.closingBalance;
            //            dayValues.earnedFee = loanInput.integralFeeAmount - dayValues.unEarnedFee;
            //            dayValues.effectiveInterestRate = item.effectiveInterestRate;
            //            dayValues.numberOfPeriods = numberOfPeriods;

            //            //public double balloonAmt { get; set; }


            //            output.Add(dayValues);

            //            accuredInterest = dayValues.accruedInterest;
            //            amAccuredInterest = dayValues.amAccruedInterest;

            //            previousPrincipalAmount = dayValues.closingBalance;
            //            amPreviousPrincipalAmount = dayValues.amClosingBalance;

            //            currentDate = currentDate.AddDays(1);
            //            dailyScheduleRowCount += 1;

            //        }

            //        previousPaymentDate = item.paymentDate;
            //    }

            //    paymentNumber += 1;
            //}

            //return output;

        }

        //private IEnumerable<LoanPaymentScheduleDailyViewModel> GenerateDailyScheduleRange(LoanPaymentSchedulePeriodicViewModel periodicSchedule, DateTime previousPaymentDate)
        //{
        //    List<LoanPaymentScheduleDailyViewModel> output = new List<LoanPaymentScheduleDailyViewModel>();

        //    var dateDifferenceCount = (previousPaymentDate - periodicSchedule.paymentDate).TotalDays;
        //    var currentDate = periodicSchedule.paymentDate;
        //    double previousPrincipalAmount = periodicSchedule.startPrincipalAmount;

        //    for (int counter = 1; counter <= dateDifferenceCount; counter++)
        //    {
        //        LoanPaymentScheduleDailyViewModel dayValues = new LoanPaymentScheduleDailyViewModel();
        //        dayValues.paymentNumber = _dailyScheduleRowCount;
        //        dayValues.paymentDate = periodicSchedule.paymentDate;
        //        dayValues.date = currentDate;

        //        dayValues.openingBalance = previousPrincipalAmount;
        //        dayValues.startPrincipalAmount = periodicSchedule.startPrincipalAmount;
        //        dayValues.dailyPrincipalAmount = periodicSchedule.periodPrincipalAmount / dateDifferenceCount;
        //        dayValues.dailyInterestAmount = periodicSchedule.periodInterestAmount / dateDifferenceCount;
        //        dayValues.dailyPaymentAmount = dayValues.dailyPrincipalAmount + dayValues.dailyInterestAmount;

        ////               public int paymentNumber { get; set; }
        ////public DateTime date { get; set; }
        ////public DateTime paymentDate { get; set; }

        //        //public double openingBalance { get; set; }
        //        //public double startPrincipalAmount { get; set; }
        //        //public double dailyPaymentAmount { get; set; }
        //        //public double dailyInterestAmount { get; set; }
        //        //public double dailyPrincipalAmount { get; set; }
        //        //public double closingBalance { get; set; }
        //        //public double endPrincipalAmount { get; set; }
        //        //public double accruedInterest { get; set; }
        //        //public double amortisedCost { get; set; }
        //        //public double norminalInterestRate { get; set; }

        //        output.Add(dayValues);

        //        previousPrincipalAmount = dayValues.closingBalance;
        //        currentDate = currentDate.AddDays(1);
        //        _dailyScheduleRowCount += 1;
        //    }

        //    return output;

        //}


        private List<LoanPaymentSchedulePeriodicViewModel> GenerateIrregularPeriodicScheduleWithAmortisedCost(LoanPaymentScheduleInputViewModel loanInput)
        {

            TBL_LOAN _loan = new TBL_LOAN();

            var loan = context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();


            if (loan == null)
            {
                _loan.INTERESTRATE = loanInput.interestRate;
            }
            else
            {
                _loan.INTERESTRATE = loan.INTERESTRATE;
            }


            if (_loan.INTERESTRATE == loanInput.interestRate)
            {

                if (loanInput.irregularPaymentSchedule.Count() == 0)
                    throw new ConditionNotMetException("Specify a repayment schedule");

                double sumAmt = loanInput.irregularPaymentSchedule.Sum(x => x.paymentAmount);

                //if (loanInput.principalAmount != (loanInput.irregularPaymentSchedule.Sum(x => x.paymentAmount)))
                if (!loanInput.principalAmount.Equals(sumAmt))
                    throw new ConditionNotMetException("Payment Amount is not equal to the principal Amount");

                var minimumPaymentDate = loanInput.irregularPaymentSchedule.Min(x => x.paymentDate);

                if (loanInput.effectiveDate > minimumPaymentDate)
                    throw new ConditionNotMetException("Effective Date should be less than the payment date(s)");

                var maximumPaymentDate = loanInput.irregularPaymentSchedule.Max(x => x.paymentDate);

                if (loanInput.effectiveDate > maximumPaymentDate)
                    throw new ConditionNotMetException("Effective Date should be less than the maturity date");

            }


            List<LoanPaymentSchedulePeriodicViewModel> paymentSchedule = new List<LoanPaymentSchedulePeriodicViewModel>();


            if (loanInput.isExistingFacility == true && loanInput.equityContribution != 0 && loanInput.equityContribution != null)
            {
                paymentSchedule = GenerateIrregularPeriodicScheduleForPrepayment(loanInput, false);
            }
            else if (_loan.INTERESTRATE != loanInput.interestRate && loanInput.operationTypeId != (int)OperationsEnum.LoanRecapitilization)
            {

                paymentSchedule = GenerateIrregularPeriodicScheduleForInterestRateChange(loanInput, false);
            }
            else
            {
                paymentSchedule = GenerateIrregularPeriodicSchedule(loanInput, false);
            }

            double internalRateOfReturn = 0;

            if (loanInput.integralFeeAmount > 0)
            {
                var amounts = paymentSchedule.Select(x => x.periodPaymentAmount).ToList();  //paymentSchedule.Where(x => x.paymentNumber > 0).Select(x => x.periodPaymentAmount).ToList();
                var dates = paymentSchedule.Select(x => x.paymentDate).ToList();

                amounts[0] = loanInput.principalAmount * -1;
                internalRateOfReturn = wct.XIRR(amounts, dates, wct.NULL_DOUBLE) * 100;
            }
            else
                internalRateOfReturn = loanInput.interestRate;

            //FinancialTypes.AMORTSCHED_table amortisedResult;
            //amortisedResult = wct.AMORTSCHED(loanInput.principalAmount - loanInput.integralFeeAmount, loanInput.effectiveDate, (internalRateOfReturn / 100.0), loanInput.interestFirstpaymentDate, numberOfPayments, numberOfPaymentsInAYear, daysInAYear, FV, IntRule);

            loanInput.principalAmount = loanInput.principalAmount - loanInput.integralFeeAmount;
            loanInput.interestRate = internalRateOfReturn;

            //List<LoanPaymentSchedulePeriodicViewModel> paymentScheduleArmotised = GenerateIrregularPeriodicSchedule(loanInput, true);

            List<LoanPaymentSchedulePeriodicViewModel> paymentScheduleArmotised = new List<LoanPaymentSchedulePeriodicViewModel>();

            if (loanInput.isExistingFacility == true && loanInput.equityContribution != 0 && loanInput.equityContribution != null)
            {
                paymentScheduleArmotised = GenerateIrregularPeriodicScheduleForPrepayment(loanInput, true);
            }
            else if (_loan.INTERESTRATE != loanInput.interestRate && loanInput.operationTypeId != (int)OperationsEnum.LoanRecapitilization)
            {
                paymentScheduleArmotised = GenerateIrregularPeriodicScheduleForInterestRateChange(loanInput, true);
            }
            else
            {
                paymentScheduleArmotised = GenerateIrregularPeriodicSchedule(loanInput, true);
            }


            int counter = 0;
            foreach (var payment in paymentSchedule)
            {
                payment.amortisedStartPrincipalAmount = paymentScheduleArmotised[counter].startPrincipalAmount;
                payment.amortisedPeriodPaymentAmount = paymentScheduleArmotised[counter].periodPaymentAmount;
                payment.amortisedPeriodInterestAmount = paymentScheduleArmotised[counter].periodInterestAmount;
                payment.amortisedPeriodPrincipalAmount = paymentScheduleArmotised[counter].periodPrincipalAmount;
                payment.amortisedEndPrincipalAmount = paymentScheduleArmotised[counter].endPrincipalAmount;
                payment.effectiveInterestRate = internalRateOfReturn;

                counter += 1;
            }

            //if (loanInput.integralFeeAmount > 0)
            //{
            //    var lastRecord = paymentSchedule.Count() - 1;
            //    paymentSchedule[lastRecord].amortisedPeriodPrincipalAmount = paymentSchedule[lastRecord].amortisedPeriodPrincipalAmount - loanInput.integralFeeAmount;
            //    paymentSchedule[lastRecord].amortisedPeriodPaymentAmount = paymentSchedule[lastRecord].amortisedPeriodPaymentAmount - loanInput.integralFeeAmount;
            //    paymentSchedule[lastRecord].amortisedEndPrincipalAmount = paymentSchedule[lastRecord].amortisedStartPrincipalAmount - paymentSchedule[lastRecord].amortisedPeriodPrincipalAmount;
            //}

            return paymentSchedule;
        }


        private List<LoanPaymentSchedulePeriodicViewModel> GenerateIrregularPeriodicSchedule(LoanPaymentScheduleInputViewModel loanInput, bool isArmotisedSchedule)
        {

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            output.Add(new LoanPaymentSchedulePeriodicViewModel
            {
                paymentNumber = 0,
                paymentDate = loanInput.effectiveDate.Date,
                startPrincipalAmount = 0,
                periodPrincipalAmount = 0,
                amortisedPeriodInterestAmount = 0,
                periodPaymentAmount = 0,
                endPrincipalAmount = loanInput.principalAmount
            });


            var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate.Date);


            double previousPrincipalAmount = loanInput.principalAmount;
            double cummulativeInterestAmount = 0;
            DateTime previousPaymentDate = loanInput.effectiveDate.Date;
            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanInput.accrualBasis);

            var itemCount = data.Count();

            int paymentNumber = 1;
            foreach (var item in data)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriod = new LoanPaymentSchedulePeriodicViewModel();

                LoanIrregularSchedulePaymentTypeEnum paymentType = (LoanIrregularSchedulePaymentTypeEnum)item.paymentTypeId;

                loanPeriod.paymentNumber = paymentNumber;
                loanPeriod.paymentDate = item.paymentDate.Date;


                loanPeriod.startPrincipalAmount = previousPrincipalAmount;

                if (isArmotisedSchedule == false)
                {
                    if (paymentType != LoanIrregularSchedulePaymentTypeEnum.InterestOnly)
                        loanPeriod.periodPrincipalAmount = item.paymentAmount;
                }
                else
                {
                    if (loanInput.integralFeeAmount > 0)
                    {
                        var feeDifferential = loanInput.principalAmount / (loanInput.principalAmount + loanInput.integralFeeAmount);
                        loanPeriod.periodPrincipalAmount = item.paymentAmount * feeDifferential;
                    }
                    else
                        loanPeriod.periodPrincipalAmount = item.paymentAmount;

                }

                var dateDifferenceCount = (item.paymentDate.Date - previousPaymentDate.Date).TotalDays;
                var currentInterestAmount = (previousPrincipalAmount * (loanInput.interestRate / 100.0)) * (dateDifferenceCount / daysInAYear);

                cummulativeInterestAmount = cummulativeInterestAmount + currentInterestAmount;

                if (paymentType != LoanIrregularSchedulePaymentTypeEnum.PrincipalOnly || paymentNumber == itemCount)
                {
                    loanPeriod.periodInterestAmount = cummulativeInterestAmount;
                    cummulativeInterestAmount = 0;
                }

                loanPeriod.periodPaymentAmount = loanPeriod.periodPrincipalAmount + loanPeriod.periodInterestAmount;

                loanPeriod.endPrincipalAmount = loanPeriod.startPrincipalAmount - loanPeriod.periodPrincipalAmount;

                loanPeriod.interestRate = loanInput.interestRate;

                output.Add(loanPeriod);

                previousPrincipalAmount = loanPeriod.endPrincipalAmount;

                previousPaymentDate = loanPeriod.paymentDate.Date;

                paymentNumber += 1;

            }

            return output;

        }

        public List<LoanPaymentSchedulePeriodicViewModel> GenerateIrregularPeriodicScheduleForPrepayment(LoanPaymentScheduleInputViewModel loanInput, bool isArmotisedSchedule)
        {

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            //output.Add(new LoanPaymentSchedulePeriodicViewModel
            //{
            //    paymentNumber = 0,
            //    paymentDate = loanInput.effectiveDate.Date,
            //    startPrincipalAmount = 0,
            //    periodPrincipalAmount = 0,
            //    amortisedPeriodInterestAmount = 0,
            //    periodPaymentAmount = 0,
            //    endPrincipalAmount = loanInput.principalAmount
            //});

            var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate.Date);

            //double sumAmountRemaining = data.Sum(x => x.paymentAmount);

            double nextRepaymentInterestAmount = 0;
            double previousPrincipalAmount = loanInput.principalAmount;
            double cummulativeInterestAmount = 0;
            DateTime previousPaymentDate = loanInput.effectiveDate.Date;
            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanInput.accrualBasis);

            var itemCount = data.Count();

            int paymentNumber = 1;

            int counter = 0;

            int setCounter = 0;

            foreach (var item in data)
            {

                counter = counter + 1;


                if (counter == 1)
                {

                    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanInput.loanId).FirstOrDefault();

                    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTDATE < loanInput.effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

                    if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
                    {
                        firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTNUMBER == 1).FirstOrDefault();
                    }

                    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTDATE == loanInput.effectiveDate).FirstOrDefault();

                    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTDATE < loanInput.effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

                    setCounter = previousPeriodicRepaymentData.PAYMENTNUMBER + 1;

                    if (previousPeriodicRepaymentData == null)
                    {
                        previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTNUMBER == 0).FirstOrDefault();
                    }

                    //double sumAmountDifference = Math.Abs(sumAmountRemaining - (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

                    var nextPeriodicRepaymentData = item;

                    int daysBeforeEffectiveDate = (loanInput.effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

                    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.paymentDate - loanInput.effectiveDate).Days;

                    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

                    double accruedInterestAfterEffectiveDate = (loanInput.interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - (double)loanInput.equityContribution);

                    nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

                }

                LoanPaymentSchedulePeriodicViewModel loanPeriod = new LoanPaymentSchedulePeriodicViewModel();

                LoanIrregularSchedulePaymentTypeEnum paymentType = (LoanIrregularSchedulePaymentTypeEnum)item.paymentTypeId;

                //loanPeriod.paymentNumber = paymentNumber;
                loanPeriod.paymentNumber = setCounter;
                loanPeriod.paymentDate = item.paymentDate.Date;


                loanPeriod.startPrincipalAmount = previousPrincipalAmount;

                if (isArmotisedSchedule == false)
                {
                    if (paymentType != LoanIrregularSchedulePaymentTypeEnum.InterestOnly)
                        loanPeriod.periodPrincipalAmount = item.paymentAmount;
                }
                else
                {
                    if (loanInput.integralFeeAmount > 0)
                    {
                        var feeDifferential = loanInput.principalAmount / (loanInput.principalAmount + loanInput.integralFeeAmount);
                        loanPeriod.periodPrincipalAmount = item.paymentAmount * feeDifferential;
                    }
                    else
                        loanPeriod.periodPrincipalAmount = item.paymentAmount;

                }

                double currentInterestAmount = 0;

                var dateDifferenceCount = (item.paymentDate.Date - previousPaymentDate.Date).TotalDays;

                if (counter == 1)
                {
                    currentInterestAmount = nextRepaymentInterestAmount;
                }
                else
                {
                    currentInterestAmount = (previousPrincipalAmount * (loanInput.interestRate / 100.0)) * (dateDifferenceCount / daysInAYear);
                }

                //var currentInterestAmount = (previousPrincipalAmount * (loanInput.interestRate / 100.0)) * (dateDifferenceCount / daysInAYear);

                cummulativeInterestAmount = cummulativeInterestAmount + currentInterestAmount;

                if (paymentType != LoanIrregularSchedulePaymentTypeEnum.PrincipalOnly || paymentNumber == itemCount)
                {
                    loanPeriod.periodInterestAmount = cummulativeInterestAmount;
                    cummulativeInterestAmount = 0;
                }

                loanPeriod.periodPaymentAmount = loanPeriod.periodPrincipalAmount + loanPeriod.periodInterestAmount;

                loanPeriod.endPrincipalAmount = loanPeriod.startPrincipalAmount - loanPeriod.periodPrincipalAmount;

                loanPeriod.interestRate = loanInput.interestRate;

                output.Add(loanPeriod);

                previousPrincipalAmount = loanPeriod.endPrincipalAmount;

                previousPaymentDate = loanPeriod.paymentDate.Date;

                setCounter += 1;

                paymentNumber += 1;

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTDATE < loanInput.effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                output.Add(loanPeriodicCalculation);

            }

            return output.OrderBy(c => c.paymentDate).ToList();

        }

        public List<LoanPaymentSchedulePeriodicViewModel> GenerateIrregularPeriodicScheduleForInterestRateChange(LoanPaymentScheduleInputViewModel loanInput, bool isArmotisedSchedule)
        {

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            //output.Add(new LoanPaymentSchedulePeriodicViewModel
            //{
            //    paymentNumber = 0,
            //    paymentDate = loanInput.effectiveDate.Date,
            //    startPrincipalAmount = 0,
            //    periodPrincipalAmount = 0,
            //    amortisedPeriodInterestAmount = 0,
            //    periodPaymentAmount = 0,
            //    endPrincipalAmount = loanInput.principalAmount
            //});

            var datas = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loanInput.loanId && x.PAYMENTDATE >= loanInput.effectiveDate).OrderBy(x => x.PAYMENTDATE);

            List<IrregularLoanScheduleInputViewModel> outputDataList = new List<IrregularLoanScheduleInputViewModel>();

            foreach (var item in datas)
            {
                IrregularLoanScheduleInputViewModel outputData = new IrregularLoanScheduleInputViewModel();

                outputData.paymentDate = item.PAYMENTDATE.Date;
                outputData.paymentAmount = (double)item.PERIODPRINCIPALAMOUNT;

                //outputData.paymentTypeId = (double)item.PERIODPRINCIPALAMOUNT;

                if (item.PERIODPRINCIPALAMOUNT != 0 && item.PERIODINTERESTAMOUNT != 0)
                {
                    outputData.paymentTypeId = 1;
                }
                else if (item.PERIODPRINCIPALAMOUNT != 0 && item.PERIODINTERESTAMOUNT == 0)
                {
                    outputData.paymentTypeId = 2;
                }
                else if (item.PERIODPRINCIPALAMOUNT == 0 && item.PERIODINTERESTAMOUNT != 0)
                {
                    outputData.paymentTypeId = 3;
                }

                outputDataList.Add(outputData);

            }


            var data = outputDataList.OrderBy(x => x.paymentDate.Date);

            //double sumAmountRemaining = data.Sum(x => x.paymentAmount);
            var previousPeriodicRepayment = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTDATE < loanInput.effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepayment == null)
            {
                previousPeriodicRepayment = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }


            double nextRepaymentInterestAmount = 0;
            double previousPrincipalAmount = (double)previousPeriodicRepayment.ENDPRINCIPALAMOUNT;
            double cummulativeInterestAmount = 0;
            DateTime previousPaymentDate = loanInput.effectiveDate.Date;
            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanInput.accrualBasis);

            var itemCount = data.Count();

            int paymentNumber = 1;

            int counter = 0;

            int setCounter = 0;

            foreach (var item in data)
            {

                counter = counter + 1;


                if (counter == 1)
                {

                    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanInput.loanId).FirstOrDefault();

                    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTDATE < loanInput.effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

                    if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
                    {
                        firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTNUMBER == 1).FirstOrDefault();
                    }

                    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTDATE == loanInput.effectiveDate).FirstOrDefault();

                    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTDATE < loanInput.effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

                    setCounter = previousPeriodicRepaymentData.PAYMENTNUMBER + 1;

                    if (previousPeriodicRepaymentData == null)
                    {
                        previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTNUMBER == 0).FirstOrDefault();
                    }

                    //double sumAmountDifference = Math.Abs(sumAmountRemaining - (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

                    var nextPeriodicRepaymentData = item;

                    int daysBeforeEffectiveDate = (loanInput.effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

                    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.paymentDate - loanInput.effectiveDate).Days;

                    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

                    double accruedInterestAfterEffectiveDate = (loanInput.interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

                    nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

                }

                LoanPaymentSchedulePeriodicViewModel loanPeriod = new LoanPaymentSchedulePeriodicViewModel();

                LoanIrregularSchedulePaymentTypeEnum paymentType = (LoanIrregularSchedulePaymentTypeEnum)item.paymentTypeId;

                //loanPeriod.paymentNumber = paymentNumber;
                loanPeriod.paymentNumber = setCounter;
                loanPeriod.paymentDate = item.paymentDate.Date;


                loanPeriod.startPrincipalAmount = previousPrincipalAmount;

                if (isArmotisedSchedule == false)
                {
                    if (paymentType != LoanIrregularSchedulePaymentTypeEnum.InterestOnly)
                        loanPeriod.periodPrincipalAmount = item.paymentAmount;
                }
                else
                {
                    if (loanInput.integralFeeAmount > 0)
                    {
                        var feeDifferential = loanInput.principalAmount / (loanInput.principalAmount + loanInput.integralFeeAmount);
                        loanPeriod.periodPrincipalAmount = item.paymentAmount * feeDifferential;
                    }
                    else
                        loanPeriod.periodPrincipalAmount = item.paymentAmount;

                }

                double currentInterestAmount = 0;

                var dateDifferenceCount = (item.paymentDate.Date - previousPaymentDate.Date).TotalDays;

                if (counter == 1)
                {
                    currentInterestAmount = nextRepaymentInterestAmount;
                }
                else
                {
                    currentInterestAmount = (previousPrincipalAmount * (loanInput.interestRate / 100.0)) * (dateDifferenceCount / daysInAYear);
                }

                //var currentInterestAmount = (previousPrincipalAmount * (loanInput.interestRate / 100.0)) * (dateDifferenceCount / daysInAYear);

                cummulativeInterestAmount = cummulativeInterestAmount + currentInterestAmount;

                if (paymentType != LoanIrregularSchedulePaymentTypeEnum.PrincipalOnly || paymentNumber == itemCount)
                {
                    loanPeriod.periodInterestAmount = cummulativeInterestAmount;
                    cummulativeInterestAmount = 0;
                }

                loanPeriod.periodPaymentAmount = loanPeriod.periodPrincipalAmount + loanPeriod.periodInterestAmount;

                loanPeriod.endPrincipalAmount = loanPeriod.startPrincipalAmount - loanPeriod.periodPrincipalAmount;

                loanPeriod.interestRate = loanInput.interestRate;

                output.Add(loanPeriod);

                previousPrincipalAmount = loanPeriod.endPrincipalAmount;

                previousPaymentDate = loanPeriod.paymentDate.Date;

                setCounter += 1;

                paymentNumber += 1;

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanInput.loanId && c.PAYMENTDATE < loanInput.effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                output.Add(loanPeriodicCalculation);

            }

            return output.OrderBy(c => c.paymentDate).ToList();

        }

        private List<LoanPaymentSchedulePeriodicViewModel> GenerateBulletPeriodicSchedule(LoanPaymentScheduleInputViewModel loanInput)
        {

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            output.Add(new LoanPaymentSchedulePeriodicViewModel
            {
                paymentNumber = 0,
                paymentDate = loanInput.effectiveDate,
                startPrincipalAmount = 0,
                periodPrincipalAmount = 0,
                amortisedPeriodInterestAmount = 0,
                periodPaymentAmount = 0,
                endPrincipalAmount = loanInput.principalAmount
            });


            //double previousPrincipalAmount = loanInput.principalAmount;
            //DateTime previousPaymentDate = loanInput.effectiveDate;
            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanInput.accrualBasis);


            LoanPaymentSchedulePeriodicViewModel loanPeriod = new LoanPaymentSchedulePeriodicViewModel();
            loanPeriod.paymentNumber = 1;
            loanPeriod.paymentDate = loanInput.maturityDate;
            loanPeriod.startPrincipalAmount = loanInput.principalAmount;
            loanPeriod.periodPrincipalAmount = loanInput.principalAmount;

            var dateDifferenceCount = (loanInput.maturityDate - loanInput.effectiveDate).TotalDays;

            loanPeriod.periodInterestAmount = (loanInput.principalAmount * (loanInput.interestRate / 100.0)) * (dateDifferenceCount / daysInAYear);
            loanPeriod.periodPaymentAmount = loanPeriod.periodPrincipalAmount + loanPeriod.periodInterestAmount;
            loanPeriod.endPrincipalAmount = loanPeriod.startPrincipalAmount - loanPeriod.periodPrincipalAmount;

            output.Add(loanPeriod);

            return output;
        }

        private List<LoanPaymentSchedulePeriodicViewModel> GenerateBulletPeriodicScheduleWithAmortisedCost(LoanPaymentScheduleInputViewModel loanInput)
        {
            if (loanInput.effectiveDate == null)
                throw new ConditionNotMetException("Please Enter Effective Date");
            if (loanInput.maturityDate == null)
                throw new ConditionNotMetException("Please Enter Maturity Date");
            if (loanInput.principalAmount <= 0)
                throw new ConditionNotMetException("Please Enter Loan Amount");
            if (loanInput.effectiveDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("Effective Date must be less than the maturity date");

            List<LoanPaymentSchedulePeriodicViewModel> paymentSchedule = GenerateBulletPeriodicSchedule(loanInput);

            double internalRateOfReturn = 0;

            if (loanInput.integralFeeAmount > 0)
            {
                var amounts = paymentSchedule.Select(x => x.periodPaymentAmount).ToList();  //paymentSchedule.Where(x => x.paymentNumber > 0).Select(x => x.periodPaymentAmount).ToList();
                var dates = paymentSchedule.Select(x => x.paymentDate).ToList();

                amounts[0] = loanInput.principalAmount * -1;
                internalRateOfReturn = wct.XIRR(amounts, dates, wct.NULL_DOUBLE) * 100;
            }
            else
                internalRateOfReturn = loanInput.interestRate;

            loanInput.principalAmount = loanInput.principalAmount - loanInput.integralFeeAmount;
            loanInput.interestRate = internalRateOfReturn;
            List<LoanPaymentSchedulePeriodicViewModel> paymentScheduleArmotised = GenerateBulletPeriodicSchedule(loanInput);

            int counter = 0;
            foreach (var payment in paymentSchedule)
            {
                payment.amortisedStartPrincipalAmount = paymentScheduleArmotised[counter].startPrincipalAmount;
                payment.amortisedPeriodPaymentAmount = paymentScheduleArmotised[counter].periodPaymentAmount;
                payment.amortisedPeriodInterestAmount = paymentScheduleArmotised[counter].periodInterestAmount;
                payment.amortisedPeriodPrincipalAmount = paymentScheduleArmotised[counter].periodPrincipalAmount;
                payment.amortisedEndPrincipalAmount = paymentScheduleArmotised[counter].endPrincipalAmount;
                payment.effectiveInterestRate = internalRateOfReturn;

                counter += 1;
            }

            return paymentSchedule;
        }

        private List<LoanPaymentSchedulePeriodicViewModel> GenerateConstantPrincipalAndInterestPeriodicSchedule(LoanPaymentScheduleInputViewModel loanInput)
        {

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanInput.accrualBasis);

            int numberOfPayments = CalculateNumberOfInstallments(loanInput.interestFirstpaymentDate, loanInput.maturityDate, (FrequencyTypeEnum)loanInput.interestFrequency);

            int numberOfPrincipalPayments = CalculateNumberOfInstallments(loanInput.principalFirstpaymentDate, loanInput.maturityDate, (FrequencyTypeEnum)loanInput.interestFrequency);

            int numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loanInput.interestFrequency).VALUE;

            var principalPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loanInput.principalFrequency).VALUE;

            int principalPaymentMultiple = Convert.ToInt32(12 / principalPaymentsInAYear);

            var principalFirstPaymentNumber = (numberOfPayments - numberOfPrincipalPayments) + 1;

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            output.Add(new LoanPaymentSchedulePeriodicViewModel
            {
                paymentNumber = 0,
                paymentDate = loanInput.effectiveDate,
                startPrincipalAmount = 0,
                periodPrincipalAmount = 0,
                amortisedPeriodInterestAmount = 0,
                periodPaymentAmount = 0,
                endPrincipalAmount = loanInput.principalAmount
            });


            double previousPrincipalAmount = loanInput.principalAmount;
            DateTime nextPaymentDate = loanInput.interestFirstpaymentDate;
            double periodPrincipalAmount = loanInput.principalAmount / numberOfPayments;
            double interestRate = loanInput.interestRate / 100.0;
            double periodInterestAmount = loanInput.principalAmount * (interestRate / numberOfPaymentsInAYear) * numberOfPayments;

            for (int i = 1; i <= numberOfPayments; i++)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriod = new LoanPaymentSchedulePeriodicViewModel();
                loanPeriod.paymentNumber = i;
                loanPeriod.paymentDate = nextPaymentDate;
                loanPeriod.startPrincipalAmount = previousPrincipalAmount;
                loanPeriod.periodPrincipalAmount = periodPrincipalAmount;

                loanPeriod.periodInterestAmount = periodInterestAmount;
                loanPeriod.periodPaymentAmount = loanPeriod.periodPrincipalAmount + loanPeriod.periodInterestAmount;
                loanPeriod.endPrincipalAmount = loanPeriod.startPrincipalAmount - loanPeriod.periodPrincipalAmount;

                output.Add(loanPeriod);

                previousPrincipalAmount = loanPeriod.endPrincipalAmount;
                nextPaymentDate = wct.NPD(loanPeriod.paymentDate, loanInput.interestFirstpaymentDate, numberOfPaymentsInAYear, numberOfPayments);
            }

            return output;

        }

        private List<LoanPaymentSchedulePeriodicViewModel> GenerateConstantPrincipalAndInterestPeriodicScheduleWithAmortisedCost(LoanPaymentScheduleInputViewModel loanInput)
        {
            if (loanInput.effectiveDate == null)
                throw new ConditionNotMetException("Please Enter Effective Date");
            if (loanInput.maturityDate == null)
                throw new ConditionNotMetException("Please Enter Maturity Date");
            if (loanInput.interestFirstpaymentDate == null)
                throw new ConditionNotMetException("Please Enter First Interest Payment Date");
            if (loanInput.principalFirstpaymentDate == null)
                throw new ConditionNotMetException("Please Enter First Principal Payment Date");
            if (loanInput.principalAmount <= 0)
                throw new ConditionNotMetException("Please Enter Loan Amount");
            if (loanInput.effectiveDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("Effective Date must be less than the maturity date");
            if (loanInput.interestFirstpaymentDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("First Interest Payment Date must be less than the maturity date");
            if (loanInput.principalFirstpaymentDate >= loanInput.maturityDate)
                throw new ConditionNotMetException("First Principal Payment Date must be less than the maturity date");
            if (loanInput.effectiveDate > loanInput.principalFirstpaymentDate)
                throw new ConditionNotMetException("First Principal Payment Date cannot be less than the effective date");
            if (loanInput.effectiveDate > loanInput.interestFirstpaymentDate)
                throw new ConditionNotMetException("First Interest Payment Date cannot be less than the effective date");
            if (loanInput.principalFirstpaymentDate < loanInput.interestFirstpaymentDate)
                throw new ConditionNotMetException("Principal first payment date cannot be less than the interest first payment date");

            List<LoanPaymentSchedulePeriodicViewModel> paymentSchedule = GenerateConstantPrincipalAndInterestPeriodicSchedule(loanInput);

            double internalRateOfReturn = 0;

            if (loanInput.integralFeeAmount > 0)
            {
                var amounts = paymentSchedule.Select(x => x.periodPaymentAmount).ToList();  //paymentSchedule.Where(x => x.paymentNumber > 0).Select(x => x.periodPaymentAmount).ToList();
                var dates = paymentSchedule.Select(x => x.paymentDate).ToList();

                amounts[0] = loanInput.principalAmount * -1;
                internalRateOfReturn = wct.XIRR(amounts, dates, wct.NULL_DOUBLE) * 100;
            }
            else
                internalRateOfReturn = loanInput.interestRate;

            loanInput.principalAmount = loanInput.principalAmount - loanInput.integralFeeAmount;
            loanInput.interestRate = internalRateOfReturn;
            List<LoanPaymentSchedulePeriodicViewModel> paymentScheduleArmotised = GenerateConstantPrincipalAndInterestPeriodicSchedule(loanInput);

            int counter = 0;
            foreach (var payment in paymentSchedule)
            {
                payment.amortisedStartPrincipalAmount = paymentScheduleArmotised[counter].startPrincipalAmount;
                payment.amortisedPeriodPaymentAmount = paymentScheduleArmotised[counter].periodPaymentAmount;
                payment.amortisedPeriodInterestAmount = paymentScheduleArmotised[counter].periodInterestAmount;
                payment.amortisedPeriodPrincipalAmount = paymentScheduleArmotised[counter].periodPrincipalAmount;
                payment.amortisedEndPrincipalAmount = paymentScheduleArmotised[counter].endPrincipalAmount;
                payment.effectiveInterestRate = internalRateOfReturn;

                counter += 1;
            }

            return paymentSchedule;
        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool AddLoanSchedule(int loanId, LoanPaymentScheduleInputViewModel loanInput, int staffId)
        {
            bool output = false;
            var applicationDate = generalSetup.GetApplicationDate();


            //---------------save irregular loan schedule input---------------------------
            List<TBL_LOAN_SCHEDULE_IREGUL_INPUT> tblIrregularSchedule = new List<TBL_LOAN_SCHEDULE_IREGUL_INPUT>();
            LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
            if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
            {
                var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                foreach (var item in data)
                {
                    TBL_LOAN_SCHEDULE_IREGUL_INPUT schedule = new TBL_LOAN_SCHEDULE_IREGUL_INPUT();
                    schedule.LOANID = loanId;
                    schedule.PAYMENTDATE = item.paymentDate;
                    schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                    schedule.CREATEDBY = staffId;
                    schedule.DATETIMECREATED = applicationDate;

                    tblIrregularSchedule.Add(schedule);
                }

            }
            //----------------------------------------------


            //----------generate and save periodic loan schedule -----------------------------------
            List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = GeneratePeriodicLoanSchedule(loanInput);

            List<TBL_LOAN_SCHEDULE_PERIODIC> tblPeriodicSchedule = new List<TBL_LOAN_SCHEDULE_PERIODIC>();
            foreach (var item in periodicSchedule)
            {
                TBL_LOAN_SCHEDULE_PERIODIC schedule = new TBL_LOAN_SCHEDULE_PERIODIC();
                schedule.LOANID = loanId;
                schedule.PAYMENTNUMBER = item.paymentNumber;
                schedule.PAYMENTDATE = item.paymentDate;
                schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                schedule.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                schedule.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                schedule.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                schedule.INTERESTRATE = loanInput.interestRate;

                schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                schedule.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                schedule.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                schedule.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                schedule.CREATEDBY = staffId;
                schedule.DATETIMECREATED = applicationDate;

                tblPeriodicSchedule.Add(schedule);
            }
            //-------------------------------------------------------------------------------------


            //----------generate and save daily loan schedule -----------------------------------
            List<LoanPaymentScheduleDailyViewModel> dailySchedule = GenerateDailyLoanSchedule(loanInput);

            List<TBL_LOAN_SCHEDULE_DAILY> tblDailySchedule = new List<TBL_LOAN_SCHEDULE_DAILY>();

            foreach (var item in dailySchedule)
            {
                TBL_LOAN_SCHEDULE_DAILY schedule = new TBL_LOAN_SCHEDULE_DAILY();

                schedule.LOANID = loanId;
                schedule.PAYMENTNUMBER = item.paymentNumber;
                schedule.DATE = item.date;
                schedule.PAYMENTDATE = item.paymentDate;
                schedule.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                schedule.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                schedule.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                schedule.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                schedule.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                schedule.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                schedule.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                schedule.INTERESTRATE = item.norminalInterestRate;

                schedule.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                schedule.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                schedule.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                schedule.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                schedule.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                schedule.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                schedule.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                schedule.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                schedule.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                schedule.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                schedule.NUMBEROFPERIODS = item.numberOfPeriods;
                schedule.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                schedule.CREATEDBY = staffId;
                schedule.DATETIMECREATED = applicationDate;

                tblDailySchedule.Add(schedule);
            }
            //----------------------------------------------------------------


            //------------adding records to the database--------------------------

            //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
            //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }


            this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule);

            this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(tblDailySchedule);

            //----------update loan details -----------------------------------
            var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
            loan.EFFECTIVEDATE = loanInput.effectiveDate;
            loan.MATURITYDATE = periodicSchedule.Max(x => x.paymentDate);
            loan.PRINCIPALNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
            loan.INTERESTNUMBEROFINSTALLMENT = loan.PRINCIPALNUMBEROFINSTALLMENT;
            loan.OUTSTANDINGPRINCIPAL = (decimal)loanInput.principalAmount;
            loan.OUTSTANDINGINTEREST = (decimal)(periodicSchedule.Select(x => x.periodInterestAmount)).Sum();
            //-------------------------------------------------

            context.SaveChanges();
            //-------------------------------------------------------

            output = true;

            return output;
        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool AddLoanFeeSchedule(int loanId, decimal amount, DateTime feeDate, DateTime loanMaturityDate, int feeDay, FrequencyTypeEnum frequency)
        {

            //-----------save recurring fee schedule----------------------------
            var recurringFees = context.TBL_LOAN_FEE.Where(x => x.LOANID == loanId && x.ISRECURRING == true);
            foreach (TBL_LOAN_FEE item in recurringFees)
            {
                var feeInfo = context.TBL_CHARGE_FEE.Where(x => x.CHARGEFEEID == item.CHARGEFEEID).FirstOrDefault();

                var feeSchedule = GenerateFeeSchedule(item.FEEAMOUNT, feeDate, loanMaturityDate, item.RECURRINGPAYMENTDAY, (FrequencyTypeEnum)feeInfo.FEEINTERVALID);

                List<TBL_LOAN_FEE_SCHEDULE> feeScheduleInfo = new List<TBL_LOAN_FEE_SCHEDULE>();

                foreach (var fee in feeSchedule)
                {
                    feeScheduleInfo.Add(new TBL_LOAN_FEE_SCHEDULE
                    {
                        FEEAMOUNT = fee.feeAmount,
                        FEEDATE = fee.feeDate,
                        FEENUMBER = fee.paymentNumber
                    });
                }

                this.context.TBL_LOAN_FEE_SCHEDULE.AddRange(feeScheduleInfo);

                context.SaveChanges();
            }
            //------------------------------------------------------------------


            return true;
        }

        public List<FeePaymentScheduleViewModel> GenerateFeeSchedule(decimal amount, DateTime feeDate, DateTime loanMaturityDate, int feeDay, FrequencyTypeEnum frequency)
        {

            List<FeePaymentScheduleViewModel> output = new List<FeePaymentScheduleViewModel>();

            int duration = 0;

            if (frequency == FrequencyTypeEnum.Monthly)
                duration = 1;
            else if (frequency == FrequencyTypeEnum.Quarterly)
                duration = 3;
            else if (frequency == FrequencyTypeEnum.ThriceYearly)
                duration = 4;
            else if (frequency == FrequencyTypeEnum.SixTimesYearly)
                duration = 2;
            else if (frequency == FrequencyTypeEnum.TwiceYearly)
                duration = 6;
            else if (frequency == FrequencyTypeEnum.Yearly)
                duration = 12;

            int paymentNumberCount = 1;

            var nextPeriodDate = feeDate.AddMonths(duration);

            var nextPayment = new DateTime(nextPeriodDate.Year, nextPeriodDate.Month, feeDay);

            while (nextPayment <= loanMaturityDate)
            {
                output.Add(new FeePaymentScheduleViewModel
                {
                    feeAmount = amount,
                    feeDate = nextPayment,
                    paymentNumber = paymentNumberCount
                });

                paymentNumberCount += 1;

                nextPeriodDate = nextPayment.AddMonths(duration);
                nextPayment = new DateTime(nextPeriodDate.Year, nextPeriodDate.Month, feeDay);
            }


            //var startdate = LocalDateTime.FromDateTime(firstPaymentDate);
            //var endDate = LocalDateTime.FromDateTime(maturityDate);

            ////Period period = Period.Between(startdate, endDate, PeriodUnits.Months);

            //double numberOfpayments = 0;

            //if (frequencyType == FrequencyTypeEnum.Daily)
            //    numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Days).Days;
            //else if (frequencyType == FrequencyTypeEnum.Monthly)
            //    numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months;
            //else if (frequencyType == FrequencyTypeEnum.Quarterly)
            //    numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months / 3.0;
            //else if (frequencyType == FrequencyTypeEnum.SixTimesYearly)
            //    numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months / 6.0;
            //else if (frequencyType == FrequencyTypeEnum.ThriceYearly)
            //    numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months / 4.0;
            //else if (frequencyType == FrequencyTypeEnum.TwiceMonthly)
            //    numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months * 2.0;
            //else if (frequencyType == FrequencyTypeEnum.TwiceYearly)
            //    numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Months).Months / 6.0;
            //else if (frequencyType == FrequencyTypeEnum.Weekly)
            //    numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Weeks).Weeks;
            //else if (frequencyType == FrequencyTypeEnum.Yearly)
            //    numberOfpayments = Period.Between(startdate, endDate, PeriodUnits.Years).Years;


            //output.Add(new LoanPaymentSchedulePeriodicViewModel
            //{
            //    paymentNumber = 0,
            //    paymentDate = loanInput.effectiveDate,
            //    startPrincipalAmount = 0,
            //    periodPrincipalAmount = 0,
            //    amortisedPeriodInterestAmount = 0,
            //    periodPaymentAmount = 0,
            //    endPrincipalAmount = loanInput.principalAmount
            //});


            //var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);


            //double previousPrincipalAmount = loanInput.principalAmount;
            //DateTime previousPaymentDate = loanInput.effectiveDate;
            //int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanInput.accurialBasis);

            //int paymentNumber = 1;
            //foreach (var item in data)
            //{
            //    LoanPaymentSchedulePeriodicViewModel loanPeriod = new LoanPaymentSchedulePeriodicViewModel();
            //    loanPeriod.paymentNumber = paymentNumber;
            //    loanPeriod.paymentDate = item.paymentDate;
            //    loanPeriod.startPrincipalAmount = previousPrincipalAmount;

            //    if (isArmotisedSchedule == false)
            //    { loanPeriod.periodPrincipalAmount = item.paymentAmount; }
            //    else
            //    {
            //        if (loanInput.integralFeeAmount > 0)
            //        {
            //            var feeDifferential = loanInput.principalAmount / (loanInput.principalAmount + loanInput.integralFeeAmount);
            //            loanPeriod.periodPrincipalAmount = item.paymentAmount * feeDifferential;
            //        }
            //        else
            //            loanPeriod.periodPrincipalAmount = item.paymentAmount;

            //    }

            //    var dateDifferenceCount = (item.paymentDate - previousPaymentDate).TotalDays;

            //    loanPeriod.periodInterestAmount = (previousPrincipalAmount * (loanInput.interestRate / 100.0)) * (dateDifferenceCount / daysInAYear);
            //    loanPeriod.periodPaymentAmount = loanPeriod.periodPrincipalAmount + loanPeriod.periodInterestAmount;
            //    loanPeriod.endPrincipalAmount = loanPeriod.startPrincipalAmount - loanPeriod.periodPrincipalAmount;

            //    output.Add(loanPeriod);

            //    previousPrincipalAmount = loanPeriod.endPrincipalAmount;
            //    previousPaymentDate = loanPeriod.paymentDate;
            //    paymentNumber += 1;

            //}

            return output;

        }

        public List<LoanPaymentSchedulePeriodicViewModel> PrepaymentWithKeepExistingAnnuity(int loanID, DateTime effectiveDate, double prepaymentAmount)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault(); //context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //     firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}


            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    //if (counter == 1)
                    //{
                    //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                    //else
                    //{
                    //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
                    //}

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

                    if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                        //if (loanPeriodic.PAYMENTNUMBER == 19)
                        //{
                        //    string me = string.Empty;
                        //}


                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                    }
                    else
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);


                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="loanID"></param>
        /// <param name="effectiveDate"></param>
        /// <param name="prepaymentAmount"></param>
        /// <returns></returns>
        public List<LoanPaymentSchedulePeriodicViewModel> PrepaymentWithNewAnnuity(int loanID, DateTime effectiveDate, double prepaymentAmount)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //     firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}


            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID);

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

            double annuity = 0;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                annuity = PMT(loan.INTERESTRATE, numberOfPayments, nextOpeningBalance, (int)loan.PRINCIPALFREQUENCYTYPEID, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                annuity = PMT(loan.INTERESTRATE, numberOfPayments, nextOpeningBalance, (int)loan.PRINCIPALFREQUENCYTYPEID, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
                //annuity = wct.LPMT(nextOpeningBalance, effectiveDate, loan.INTERESTRATE / 100, nextPeriodicRepaymentData.PAYMENTDATE, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
            }


            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;

            if (nextOpeningBalance >= annuity)
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                decimal bal = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);

                if (bal < 0)
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)0, 2);
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                    loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }
                else
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                    loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }


                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);


                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;

                while (initialCounter != finalCounter)
                {

                    numberOfPaymentsCount = numberOfPaymentsCount + 1;

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity && numberOfPaymentsCount != numberOfPayments)
                    if (numberOfPaymentsCount != numberOfPayments)
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                        //if (loanPeriodic.PAYMENTNUMBER == 19)
                        //{
                        //    string me = string.Empty;
                        //}

                        if (loanPeriodic.ENDPRINCIPALAMOUNT >= loanPeriodic.PERIODPAYMENTAMOUNT)
                        {
                            if (loan.MATURITYDATE != nextPaymentDate)
                            {
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;
                            }
                            else
                            {
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                                finalCounter = initialCounter;
                            }



                        }
                        else
                        {
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                            finalCounter = initialCounter;

                        }


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);



                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> PrepaymentWithKeepExistingAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, double prepaymentAmount, int principalRepaymentFrequency, int interestRepaymentFrequency)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (interestRepaymentFrequency == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0 && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();
            //}


            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (interestRepaymentFrequency == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

            DateTime nextPrincipalPeriodicDate = DateTime.Now;

            if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
            {
                var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                if (nextPrincipalPeriodicData != null)
                {
                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
                }
                else
                {
                    var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                    nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
                }

            }
            else
            {
                //if (loan.INTERESTFREQUENCYTYPEID != loan.PRINCIPALFREQUENCYTYPEID)
                //{
                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
                //}
                //else
                //{
                //    nextPrincipalPeriodicDate = nextPeriodicRepaymentData.PAYMENTDATE;
                //}
            }


            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();


                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                    loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }
                else
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                    loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }


                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);


                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

                    if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {

                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                        }

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                    }
                    else
                    {

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {

                            //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                            //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                            //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            finalCounter = initialCounter;
                        }


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);



                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> PrepaymentWithNewAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, double prepaymentAmount, int principalRepaymentFrequency, int interestRepaymentFrequency)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (interestRepaymentFrequency == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
            }


            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0 && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();


            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;


            if (interestRepaymentFrequency == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

            int numberOfPayments = 0;

            if (principalRepaymentFrequency == 0)
            {
                numberOfPayments = 1;
            }
            else
            {
                numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)principalRepaymentFrequency);
            }



            //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

            DateTime nextPrincipalPeriodicDate = DateTime.Now;

            if (principalRepaymentFrequency != 0)
            {
                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                    if (nextPrincipalPeriodicData != null)
                    {
                        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
                    }
                    else
                    {
                        var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                        nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
                    }

                }
                else
                {
                    //if (loan.INTERESTFREQUENCYTYPEID != loan.PRINCIPALFREQUENCYTYPEID)
                    //{
                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
                    //}
                    //else
                    //{
                    //    nextPrincipalPeriodicDate = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                }
            }
            else
            {
                nextPrincipalPeriodicDate = loan.MATURITYDATE;
            }


            double annuity = 0;

            if (interestRepaymentFrequency == 8)
            {
                //annuity = PMT(loan.INTERESTRATE, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));
                annuity = PMT(loan.INTERESTRATE, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                //annuity = wct.LPMT(nextOpeningBalance, effectiveDate, loan.INTERESTRATE / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
                annuity = PMT(loan.INTERESTRATE, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }

            //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, (numberOfPayments * numberOfPaymentsInAYear), numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);

            // double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, loan.INTERESTRATE / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);


            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= annuity)
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                    loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }
                else
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                    loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }


                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);


                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
                    if (numberOfPaymentsCount != numberOfPayments)
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            if (loan.MATURITYDATE != nextPaymentDate)
                            {
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            }
                            else
                            {
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            }


                        }
                        else
                        {

                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                        }

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {

                            //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                            //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.INTERESTRATE = interestRate;
                            //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            finalCounter = initialCounter;
                        }


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);



                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithKeepExistingAnnuity(int loanID, DateTime effectiveDate, double interestRate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
            }

            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //     firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;

            if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = (decimal)nextOpeningBalance;
                loanPeriodic.PERIODPAYMENTAMOUNT = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT;
                loanPeriodic.PERIODINTERESTAMOUNT = (decimal)nextRepaymentInterestAmount;
                loanPeriodic.PERIODPRINCIPALAMOUNT = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount;
                loanPeriodic.ENDPRINCIPALAMOUNT = (decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                while (initialCounter != finalCounter)
                {
                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

                    if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
                    {

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodic.PERIODPAYMENTAMOUNT = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT;
                        loanPeriodic.PERIODINTERESTAMOUNT = ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodic.PERIODPRINCIPALAMOUNT = (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT));
                        loanPeriodic.ENDPRINCIPALAMOUNT = loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT));
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE); //nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodic.PERIODPAYMENTAMOUNT = loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodic.PERIODINTERESTAMOUNT = ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodic.PERIODPRINCIPALAMOUNT = (loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT);
                        loanPeriodic.ENDPRINCIPALAMOUNT = loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT));
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);   //nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }

                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);



                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = (decimal)nextOpeningBalance;
                loanPeriodic.PERIODPAYMENTAMOUNT = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT;
                loanPeriodic.PERIODINTERESTAMOUNT = (decimal)nextRepaymentInterestAmount;
                loanPeriodic.PERIODPRINCIPALAMOUNT = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount;
                loanPeriodic.ENDPRINCIPALAMOUNT = (decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithNewAnnuity(int loanID, DateTime effectiveDate, double interestRate, int frequencyId, DateTime maturityDate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (frequencyId == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == frequencyId).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();


            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)frequencyId);

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (frequencyId == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }
            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, (int)frequencyId, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            double annuity = 0;

            if (frequencyId == 8)
            {
                annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, (int)frequencyId, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {

                //annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPeriodicRepaymentData.PAYMENTDATE, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
                annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, (int)frequencyId, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            }


            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;

            if (nextOpeningBalance >= annuity)
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();


                if (nextRepaymentInterestAmount < annuity)
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }
                else
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }




                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;


                while (initialCounter != finalCounter)
                {

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)frequencyId, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
                    if (numberOfPaymentsCount != numberOfPayments)
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                        //if (loanPeriodic.PAYMENTNUMBER == 19)
                        //{
                        //    string me = string.Empty;
                        //}


                        if (loanPeriodic.ENDPRINCIPALAMOUNT >= loanPeriodic.PERIODPAYMENTAMOUNT)
                        {
                            if (maturityDate != nextPaymentDate)
                            {
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = interestRate;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                            }
                            else
                            {
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = interestRate;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                                finalCounter = initialCounter;
                            }


                        }
                        else
                        {
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                            finalCounter = initialCounter;

                        }



                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);



                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithKeepExistingAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (interestRepaymentFrequency == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0 && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (interestRepaymentFrequency == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            DateTime nextPrincipalPeriodicDate = DateTime.Now;

            if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
            {
                var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                if (nextPrincipalPeriodicData != null)
                {
                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
                }
                else
                {
                    var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                    nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
                }

            }
            else
            {
                //if (loan.INTERESTFREQUENCYTYPEID != loan.PRINCIPALFREQUENCYTYPEID)
                //{
                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
                //}
                //else
                //{
                //    nextPrincipalPeriodicDate = nextPeriodicRepaymentData.PAYMENTDATE;
                //}
            }


            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();


                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }
                else
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }


                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;


                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

                    if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {

                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                        }

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


                    }
                    else
                    {

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {

                            //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                            //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.INTERESTRATE = interestRate;
                            //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            finalCounter = initialCounter;
                        }


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;




                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);



                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> EvenPrincipalPaymentsKeepExistingAnnuity(int loanID, DateTime effectiveDate, double prepaymentAmount)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;


            if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    //if (counter == 1)
                    //{
                    //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                    //else
                    //{
                    //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
                    //}

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

                    if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {
                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);


                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeEvenPrincipalPaymentsKeepExistingAnnuity(int loanID, DateTime effectiveDate, double interestRate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    //if (counter == 1)
                    //{
                    //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                    //else
                    //{
                    //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
                    //}

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

                    if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);


                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> EvenPrincipalPaymentsKeepExistingNewAnnuity(int loanID, DateTime effectiveDate, double prepaymentAmount)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if ((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == (short)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();


            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if ((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

            int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID);

            double annuity = nextOpeningBalance / numberOfPayments;

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + (decimal)annuity, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    //if (counter == 1)
                    //{
                    //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                    //else
                    //{
                    //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
                    //}

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
                    if (numberOfPaymentsCount != numberOfPayments)
                    {

                        numberOfPaymentsCount = numberOfPaymentsCount + 1;

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                    }
                    else
                    {


                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);


                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                //loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                ////loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                ////loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                ////loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                ////loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                ////loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                ////loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                ////loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                ////loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                ////loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                ////loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                ////loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                ////loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                ////loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                ////loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                ////loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                ////loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                ////loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                ////loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                //loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                //loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                //loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                //loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                //loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                //loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                //loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                //loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                //loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                //loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                //loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                //loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                //loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                //loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeEvenPrincipalPaymentsKeepExistingNewAnnuity(int loanID, DateTime effectiveDate, double interestRate, int frequencyId, DateTime maturityDate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if ((int)(FrequencyTypeEnum)frequencyId == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == (short)(FrequencyTypeEnum)frequencyId).VALUE;
            }


            // var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();


            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if ((int)(FrequencyTypeEnum)frequencyId == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)frequencyId);

            double annuity = nextOpeningBalance / numberOfPayments;

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;


            decimal firstPeriodicScheduleDataValue = 0;

            if (firstPeriodicScheduleData == null)
            {
                firstPeriodicScheduleDataValue = 0;
            }
            else
            {
                firstPeriodicScheduleDataValue = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT;
            }


            if (nextOpeningBalance >= (double)firstPeriodicScheduleDataValue)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + (decimal)annuity, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);


                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    //if (counter == 1)
                    //{
                    //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                    //else
                    //{
                    //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
                    //}

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
                    if (numberOfPaymentsCount != numberOfPayments)
                    {
                        numberOfPaymentsCount = numberOfPaymentsCount + 1;

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;


                        if (loanPeriodic.ENDPRINCIPALAMOUNT >= loanPeriodic.PERIODPAYMENTAMOUNT)
                        {
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }



                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {


                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);


                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeEvenPrincipalPaymentsKeepExistingNewAnnuity(int loanID, DateTime effectiveDate, double interestRate, double prepaymentAmount)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();


            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (loan.PRINCIPALFREQUENCYTYPEID == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

            int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID);

            double annuity = nextOpeningBalance / numberOfPayments;

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + (decimal)annuity, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;


                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    //if (counter == 1)
                    //{
                    //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                    //else
                    //{
                    //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
                    //}

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
                    if (numberOfPaymentsCount != numberOfPayments)
                    {

                        numberOfPaymentsCount = numberOfPaymentsCount + 1;

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {


                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);


                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        //public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithNewAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, DateTime maturityDate)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0 && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    //var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    int numberOfPaymentsNew = 0;

        //    int numberOfPayments = 0;

        //    if (principalRepaymentFrequency == 0)
        //    {
        //        numberOfPayments = 1;
        //    }
        //    else
        //    {
        //        numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)principalRepaymentFrequency);
        //        numberOfPaymentsNew = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)interestRepaymentFrequency);
        //    }



        //    //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

        //    DateTime nextPrincipalPeriodicDate = DateTime.Now;

        //    if (principalRepaymentFrequency != 0)
        //    {
        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //            if (nextPrincipalPeriodicData != null)
        //            {
        //                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
        //            }
        //            else
        //            {
        //                var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //                nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
        //            }

        //        }
        //        else
        //        {
        //            //if (loan.INTERESTFREQUENCYTYPEID != loan.PRINCIPALFREQUENCYTYPEID)
        //            //{
        //            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
        //            //}
        //            //else
        //            //{
        //            //    nextPrincipalPeriodicDate = nextPeriodicRepaymentData.PAYMENTDATE;
        //            //}
        //        }
        //    }
        //    else
        //    {
        //        nextPrincipalPeriodicDate = loan.MATURITYDATE;
        //    }


        //    //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, (numberOfPayments * numberOfPaymentsInAYear), numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);

        //    //double annuity = 0;

        //    //if (principalRepaymentFrequency != 0)
        //    //{
        //    //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    //}
        //    //else
        //    //{
        //    //    annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, ((loan.MATURITYDATE - effectiveDate).Days), GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    //}

        //    double annuity = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));
        //    }
        //    else
        //    {

        //        //annuity = nextOpeningBalance / numberOfPayments;
        //        //annuity = PMT(interestRate, numberOfPaymentsNew, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));
        //        annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    }


        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= annuity)
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //            loanPeriodic.INTERESTRATE = interestRate;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }
        //        else
        //        {

        //            if(nextRepaymentInterestAmount < annuity)
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //            }
        //            else
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //            }



        //        }


        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;


        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        int numberOfPaymentsCount = 0;

        //        // numberOfPayments = numberOfPayments - 1;
        //        numberOfPayments = numberOfPaymentsNew - 1;

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
        //            if (numberOfPaymentsCount != numberOfPayments && maturityDate > nextPaymentDate)
        //            {

        //                numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;


        //                if (nextPaymentDate == Convert.ToDateTime("05/23/2019"))
        //                {
        //                    var me = "";
        //                }

        //                if (nextPrincipalPeriodicDate != nextPaymentDate && maturityDate > nextPaymentDate)
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                }

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {

        //                //if (nextPaymentDate == Convert.ToDateTime("05/23/2019"))
        //                //{
        //                //    var me = "";
        //                //}

        //                if (nextPrincipalPeriodicDate != nextPaymentDate && maturityDate > loanPeriodic.PAYMENTDATE)
        //                {

        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                    //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                    //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.INTERESTRATE = interestRate;
        //                    //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    finalCounter = initialCounter;
        //                }


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);



        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithNewAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, DateTime maturityDate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();


            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (interestRepaymentFrequency == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
            }

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0 && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (interestRepaymentFrequency == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            int numberOfPayments = 0;

            if (principalRepaymentFrequency == 0)
            {
                numberOfPayments = 1;
            }
            else
            {
                numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)principalRepaymentFrequency);
            }

            int numberInterestOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)interestRepaymentFrequency);

            //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

            DateTime nextPrincipalPeriodicDate = DateTime.Now;

            if (principalRepaymentFrequency != 0)
            {
                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                    if (nextPrincipalPeriodicData != null)
                    {
                        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
                    }
                    else
                    {
                        var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                        nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
                    }

                }
                else
                {
                    //if (loan.INTERESTFREQUENCYTYPEID != loan.PRINCIPALFREQUENCYTYPEID)
                    //{
                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
                    //}
                    //else
                    //{
                    //    nextPrincipalPeriodicDate = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                }
            }
            else
            {
                nextPrincipalPeriodicDate = maturityDate;
            }


            //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, (numberOfPayments * numberOfPaymentsInAYear), numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);

            double annuity = 0;

            if (interestRepaymentFrequency == 8)
            {
                //annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));
                annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                //annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

                annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);

                //annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
            }



            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= annuity)
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }
                else
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }


                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;


                    if (nextPaymentDate == Convert.ToDateTime("01/05/2029"))
                    {
                        var me = "";
                    }

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)

                    //if (numberOfPaymentsCount != numberOfPayments)
                    if (numberOfPaymentsCount != numberInterestOfPayments)
                    {

                        numberOfPaymentsCount = numberOfPaymentsCount + 1;

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {

                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                        }

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {

                            //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                            //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.INTERESTRATE = interestRate;
                            //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            finalCounter = initialCounter;
                        }


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);



                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithNewAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, double prepaymentAmount)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (interestRepaymentFrequency == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
            }


            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0 && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (interestRepaymentFrequency == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

            int numberOfPayments = 0;

            if (principalRepaymentFrequency == 0)
            {
                numberOfPayments = 1;
            }
            else
            {
                numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)principalRepaymentFrequency);
            }



            //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

            DateTime nextPrincipalPeriodicDate = DateTime.Now;

            if (principalRepaymentFrequency != 0)
            {
                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                    if (nextPrincipalPeriodicData != null)
                    {
                        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
                    }
                    else
                    {
                        var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                        nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
                    }

                }
                else
                {
                    //if (loan.INTERESTFREQUENCYTYPEID != loan.PRINCIPALFREQUENCYTYPEID)
                    //{
                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
                    //}
                    //else
                    //{
                    //    nextPrincipalPeriodicDate = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                }
            }
            else
            {
                nextPrincipalPeriodicDate = loan.MATURITYDATE;
            }


            //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, (numberOfPayments * numberOfPaymentsInAYear), numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);

            //double annuity = 0;

            //if (principalRepaymentFrequency != 0)
            //{
            //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
            //}
            //else
            //{
            //    annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, ((loan.MATURITYDATE - effectiveDate).Days), GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
            //}

            double annuity = 0;

            if (interestRepaymentFrequency == 8)
            {
                //annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));
                annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                //annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
                annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }


            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= annuity)
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }
                else
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }


                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;


                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
                    if (numberOfPaymentsCount != numberOfPayments)
                    {

                        numberOfPaymentsCount = numberOfPaymentsCount + 1;

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {

                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                        }

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {

                            //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                            //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.INTERESTRATE = interestRate;
                            //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            finalCounter = initialCounter;
                        }


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);



                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> EvenPrincipalPaymentsNewAnnuity(int loanID, DateTime effectiveDate, DateTime maturityDate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if ((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == (short)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();


            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if ((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID);

            double annuity = nextOpeningBalance / numberOfPayments;

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + (decimal)annuity, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    //if (counter == 1)
                    //{
                    //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                    //else
                    //{
                    //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
                    //}

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
                    if (numberOfPaymentsCount != numberOfPayments)
                    {
                        numberOfPaymentsCount = numberOfPaymentsCount + 1;

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                    }
                    else
                    {


                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);


                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                //loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                ////loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                ////loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                ////loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                ////loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                ////loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                ////loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                ////loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                ////loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                ////loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                ////loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                ////loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                ////loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                ////loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                ////loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                ////loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                ////loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                ////loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                ////loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                //loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                //loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                //loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                //loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                //loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                //loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                //loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                //loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                //loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                //loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                //loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                //loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                //loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                //loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> BulletPrepayments(int loanID, DateTime effectiveDate, double prepaymentAmount)
        {

            var loanData = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            var bulletPreviouData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();

            var bulletNextData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            output.Add(new LoanPaymentSchedulePeriodicViewModel
            {
                paymentNumber = 0,
                paymentDate = bulletPreviouData.PAYMENTDATE,
                startPrincipalAmount = 0,
                periodPrincipalAmount = 0,
                amortisedPeriodInterestAmount = 0,
                periodPaymentAmount = 0,
                endPrincipalAmount = (double)bulletPreviouData.ENDPRINCIPALAMOUNT
            });


            //double previousPrincipalAmount = loanInput.principalAmount;
            //DateTime previousPaymentDate = loanInput.effectiveDate;
            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanData.SCHEDULEDAYCOUNTCONVENTIONID);


            LoanPaymentSchedulePeriodicViewModel loanPeriod = new LoanPaymentSchedulePeriodicViewModel();
            loanPeriod.paymentNumber = 1;
            loanPeriod.paymentDate = loanData.MATURITYDATE;
            loanPeriod.startPrincipalAmount = (double)bulletNextData.STARTPRINCIPALAMOUNT - prepaymentAmount;
            loanPeriod.periodPrincipalAmount = (double)bulletNextData.STARTPRINCIPALAMOUNT - prepaymentAmount;

            //var dateDifferenceCount = (loanData.MATURITYDATE - effectiveDate).TotalDays;

            //int daysBeforeEffectiveDate = (effectiveDate - loanData.EFFECTIVEDATE).Days;

            int daysBeforeEffectiveDate = (effectiveDate - loanData.EFFECTIVEDATE).Days;

            var dateDifferenceCount = (loanData.MATURITYDATE - effectiveDate).TotalDays;

            double amountBefore = (loanData.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)bulletNextData.STARTPRINCIPALAMOUNT;///(((double)bulletNextData.STARTPRINCIPALAMOUNT) * (loanData.INTERESTRATE / 100.0)) * (daysBeforeEffectiveDate / daysInAYear);
            double amountLater = (loanData.INTERESTRATE / 100.00000) / daysInAYear * dateDifferenceCount * ((double)bulletNextData.STARTPRINCIPALAMOUNT - prepaymentAmount); //(((double)bulletNextData.STARTPRINCIPALAMOUNT) * (interestRate / 100.0)) * (dateDifferenceCount / daysInAYear);

            loanPeriod.periodInterestAmount = amountBefore + amountLater;
            //loanPeriod.periodInterestAmount = (loanData.INTERESTRATE / 100.00000) / daysInAYear * dateDifferenceCount * ((double)bulletNextData.STARTPRINCIPALAMOUNT - prepaymentAmount) + (((double)bulletNextData.STARTPRINCIPALAMOUNT) * (loanData.INTERESTRATE / 100.0)) * (dateDifferenceCount / daysInAYear);//+ (((double)bulletNextData.STARTPRINCIPALAMOUNT - prepaymentAmount) //* (loanData.INTERESTRATE / 100.0)) * (daysBeforeEffectiveDate / daysInAYear);
            loanPeriod.periodPaymentAmount = loanPeriod.periodPrincipalAmount + loanPeriod.periodInterestAmount;
            loanPeriod.endPrincipalAmount = loanPeriod.startPrincipalAmount - loanPeriod.periodPrincipalAmount;

            output.Add(loanPeriod);

            return output;
        }

        public List<LoanPaymentSchedulePeriodicViewModel> BulletInterestRateChange(int loanID, DateTime effectiveDate, double interestRate, DateTime maturityDate)
        {

            var loanData = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            var bulletPreviouData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();

            var bulletNextData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

            output.Add(new LoanPaymentSchedulePeriodicViewModel
            {
                paymentNumber = 0,
                paymentDate = bulletPreviouData.PAYMENTDATE,
                startPrincipalAmount = 0,
                periodPrincipalAmount = 0,
                amortisedPeriodInterestAmount = 0,
                periodPaymentAmount = 0,
                endPrincipalAmount = (double)bulletPreviouData.ENDPRINCIPALAMOUNT
            });


            //double previousPrincipalAmount = loanInput.principalAmount;
            //DateTime previousPaymentDate = loanInput.effectiveDate;
            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanData.SCHEDULEDAYCOUNTCONVENTIONID);


            LoanPaymentSchedulePeriodicViewModel loanPeriod = new LoanPaymentSchedulePeriodicViewModel();
            loanPeriod.paymentNumber = 1;
            loanPeriod.paymentDate = maturityDate;
            loanPeriod.startPrincipalAmount = (double)bulletNextData.STARTPRINCIPALAMOUNT;
            loanPeriod.periodPrincipalAmount = (double)bulletNextData.STARTPRINCIPALAMOUNT;

            int daysBeforeEffectiveDate = (effectiveDate - loanData.EFFECTIVEDATE).Days;

            var dateDifferenceCount = (maturityDate - effectiveDate).TotalDays;

            double amountBefore = (loanData.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)bulletNextData.STARTPRINCIPALAMOUNT;///(((double)bulletNextData.STARTPRINCIPALAMOUNT) * (loanData.INTERESTRATE / 100.0)) * (daysBeforeEffectiveDate / daysInAYear);
            double amountLater = (interestRate / 100.00000) / daysInAYear * dateDifferenceCount * (double)bulletNextData.STARTPRINCIPALAMOUNT; //(((double)bulletNextData.STARTPRINCIPALAMOUNT) * (interestRate / 100.0)) * (dateDifferenceCount / daysInAYear);


            loanPeriod.periodInterestAmount = amountLater + amountBefore;
            loanPeriod.periodPaymentAmount = loanPeriod.periodPrincipalAmount + loanPeriod.periodInterestAmount;
            loanPeriod.endPrincipalAmount = loanPeriod.startPrincipalAmount - loanPeriod.periodPrincipalAmount;

            output.Add(loanPeriod);

            return output;
        }

        public List<LoanPaymentSchedulePeriodicViewModel> BallonInterestRateChangePrepayment(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, double prepaymentAmount)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (interestRepaymentFrequency == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
            }


            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0 && c.PAYMENTDATE == effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (interestRepaymentFrequency == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

            int numberOfPayments = 0;

            if (principalRepaymentFrequency == 0)
            {
                numberOfPayments = 1;
            }
            else
            {
                numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)principalRepaymentFrequency);
            }


            DateTime nextPrincipalPeriodicDate = DateTime.Now;

            if (principalRepaymentFrequency != 0)
            {
                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                    if (nextPrincipalPeriodicData != null)
                    {
                        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
                    }
                    else
                    {
                        var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                        nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
                    }

                }
                else
                {
                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
                }
            }
            else
            {
                nextPrincipalPeriodicDate = loan.MATURITYDATE;
            }

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            int exitLoopCounter = 0;

            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

            if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
            {
                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
            }
            else
            {
                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextOpeningBalance + (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = 0;
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

                exitLoopCounter = 1;
            }


            loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
            loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
            loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
            loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
            loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
            loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;


            loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
            loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
            loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

            nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

            loanPeriodic_List.Add(loanPeriodicCalculationNew);

            int numberOfPaymentsCount = 0;

            numberOfPayments = numberOfPayments - 1;

            while (initialCounter != finalCounter)
            {

                if (exitLoopCounter == 1)
                {
                    break;
                }

                counter = counter + 1;

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

                //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
                if (numberOfPaymentsCount != numberOfPayments)
                {

                    numberOfPaymentsCount = numberOfPaymentsCount + 1;

                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                    if (nextPrincipalPeriodicDate != nextPaymentDate)
                    {

                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                    }
                    else
                    {

                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextOpeningBalance + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = 0;
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                        exitLoopCounter = 1;

                    }

                    loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                    loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                    loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                    loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                    loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                    loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                    loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                    loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                    loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


                    loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                    loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                    loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                }
                else
                {

                    if (nextPrincipalPeriodicDate != nextPaymentDate)
                    {

                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                    }
                    else
                    {

                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.INTERESTRATE = interestRate;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        exitLoopCounter = 1;

                        finalCounter = initialCounter;
                    }


                    loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                    loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                    loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                    loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                    loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                    loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                    loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                    loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                    loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


                    loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                    loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                    loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                }


                if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                {
                    finalCounter = initialCounter;
                }


                loanPeriodic_List.Add(loanPeriodicCalculation);



            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> BallonInterestRateChange(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, DateTime maturityDate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (interestRepaymentFrequency == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
            }


            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0 && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (interestRepaymentFrequency == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            int numberOfPayments = 0;

            if (principalRepaymentFrequency == 0)
            {
                numberOfPayments = 1;
            }
            else
            {
                numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)principalRepaymentFrequency);
            }


            DateTime nextPrincipalPeriodicDate = DateTime.Now;

            if (principalRepaymentFrequency != 0)
            {
                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                    if (nextPrincipalPeriodicData != null)
                    {
                        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
                    }
                    else
                    {
                        var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                        nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
                    }

                }
                else
                {
                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
                }
            }
            else
            {
                nextPrincipalPeriodicDate = maturityDate;
            }

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            int exitLoopCounter = 0;

            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

            if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
            {
                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
            }
            else
            {
                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextOpeningBalance + (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = 0;
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

                exitLoopCounter = 1;
            }


            loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
            loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
            loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
            loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
            loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
            loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;


            loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
            loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
            loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
            loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

            nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

            loanPeriodic_List.Add(loanPeriodicCalculationNew);

            int numberOfPaymentsCount = 0;

            numberOfPayments = numberOfPayments - 1;

            while (initialCounter != finalCounter)
            {

                if (exitLoopCounter == 1)
                {
                    break;
                }

                counter = counter + 1;

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

                //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
                if (numberOfPaymentsCount != numberOfPayments)
                {

                    numberOfPaymentsCount = numberOfPaymentsCount + 1;

                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                    if (nextPrincipalPeriodicDate != nextPaymentDate)
                    {

                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                    }
                    else
                    {

                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextOpeningBalance + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = 0;
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                        exitLoopCounter = 1;

                    }

                    loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                    loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                    loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                    loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                    loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                    loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                    loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                    loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                    loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


                    loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                    loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                    loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                }
                else
                {

                    if (nextPrincipalPeriodicDate != nextPaymentDate)
                    {

                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                    }
                    else
                    {

                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.INTERESTRATE = interestRate;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        exitLoopCounter = 1;

                        finalCounter = initialCounter;
                    }


                    loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                    loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                    loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                    loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                    loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                    loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                    loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                    loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                    loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


                    loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                    loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                    loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                    loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                }


                if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                {
                    finalCounter = initialCounter;
                }


                loanPeriodic_List.Add(loanPeriodicCalculation);



            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public double PMT(double yearlyInterestRate, int numberOfPayments, double loanAmount, int interestFrequencyId, int dayCountConventionID)
        {

            //int daysInAYear = GetDaysInAYear((DayCountConventionEnum)dayCountConventionID);

            int numberOfPaymentsInAYear = 0;

            if (interestFrequencyId == 8)
            {
                //numberOfPaymentsInAYear = dayCountConventionID; //GetDaysInAYear((DayCountConventionEnum)dayCountConventionID);
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)dayCountConventionID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestFrequencyId).VALUE;
            }

            var rate = (double)yearlyInterestRate / 100 / numberOfPaymentsInAYear;
            var denominator = Math.Pow((1 + rate), numberOfPayments) - 1;
            return (rate + (rate / denominator)) * loanAmount;
        }

        //Specific Operation Modification

        public List<LoanPaymentSchedulePeriodicViewModel> AnnuityFrequencyChange(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, DateTime maturityDate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();


            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (interestRepaymentFrequency == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
            }

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0 && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (interestRepaymentFrequency == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
                //accruedInterestBeforeEffectiveDate = accruedInterestBeforeEffectiveDate;
            }

            //double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate; //+ accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            int numberOfPayments = 0;

            if (principalRepaymentFrequency == 0)
            {
                numberOfPayments = 1;
            }
            else
            {
                numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)principalRepaymentFrequency);
            }

            int numberInterestOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)interestRepaymentFrequency);

            //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

            DateTime nextPrincipalPeriodicDate = DateTime.Now;

            if (principalRepaymentFrequency != 0)
            {
                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                    if (nextPrincipalPeriodicData != null)
                    {
                        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
                    }
                    else
                    {
                        var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

                        nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
                    }

                }
                else
                {
                    //if (loan.INTERESTFREQUENCYTYPEID != loan.PRINCIPALFREQUENCYTYPEID)
                    //{
                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
                    //}
                    //else
                    //{
                    //    nextPrincipalPeriodicDate = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                }
            }
            else
            {
                nextPrincipalPeriodicDate = maturityDate;
            }


            //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, (numberOfPayments * numberOfPaymentsInAYear), numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);

            double annuity = 0;

            if (interestRepaymentFrequency == 8)
            {
                //annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

                annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);


            }
            else
            {
                //annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, principalRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

                annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, principalRepaymentFrequency, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);

                //annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
            }



            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;

            if (nextOpeningBalance >= annuity)
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    //loanPeriodic.PAYMENTDATE = effectiveDate;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }
                else
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    //loanPeriodic.PAYMENTDATE = effectiveDate;
                    loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }


                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                //nextPaymentDate = effectiveDate;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;


                    if (nextPaymentDate == Convert.ToDateTime("12/15/9999"))
                    {
                        var me = "";
                    }

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)

                    //if (numberOfPaymentsCount != numberOfPayments)
                    if (numberOfPaymentsCount != numberInterestOfPayments)
                    {

                        numberOfPaymentsCount = numberOfPaymentsCount + 1;

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {

                            var testNegativeValue = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);


                            if (testNegativeValue > 0)
                            {
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = interestRate;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);
                            }
                            else
                            {
                                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = interestRate;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                                finalCounter = initialCounter;
                            }




                        }

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {

                        if (nextPrincipalPeriodicDate != nextPaymentDate)
                        {

                            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {


                            var testNegativeValue = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);


                            if (testNegativeValue > 0)
                            {
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = interestRate;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);
                            }
                            else
                            {
                                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = interestRate;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                                finalCounter = initialCounter;
                            }

                            //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                            //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            //loanPeriodic.INTERESTRATE = interestRate;
                            //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

                            ////loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                            ////loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                            ////loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            ////loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            ////loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            ////loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            ////loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            ////loanPeriodic.INTERESTRATE = interestRate;
                            ////loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                            finalCounter = initialCounter;
                        }


                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);



                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChange(int loanID, DateTime effectiveDate, double interestRate, int frequencyId, DateTime maturityDate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if (frequencyId == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == frequencyId).VALUE;
            }


            //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();


            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)frequencyId);

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if (frequencyId == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }
            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate; //+ accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, (int)frequencyId, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            double annuity = 0;

            if (frequencyId == 8)
            {
                annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, (int)frequencyId, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {

                //annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPeriodicRepaymentData.PAYMENTDATE, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
                annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, (int)frequencyId, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            }


            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;

            if (nextOpeningBalance >= annuity)
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();


                if (nextRepaymentInterestAmount < annuity)
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    loanPeriodic.PAYMENTDATE = effectiveDate;
                    //loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }
                else
                {
                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                    loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                    loanPeriodic.INTERESTRATE = interestRate;
                    loanPeriodic.PAYMENTDATE = effectiveDate;
                    //loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                }




                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


                //nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

                nextPaymentDate = effectiveDate;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);

                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;


                while (initialCounter != finalCounter)
                {

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)frequencyId, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
                    if (numberOfPaymentsCount != numberOfPayments)
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

                        //if (loanPeriodic.PAYMENTNUMBER == 19)
                        //{
                        //    string me = string.Empty;
                        //}


                        if (loanPeriodic.ENDPRINCIPALAMOUNT >= loanPeriodic.PERIODPAYMENTAMOUNT)
                        {
                            if (maturityDate != nextPaymentDate)
                            {
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = interestRate;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                            }
                            else
                            {
                                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                                loanPeriodic.INTERESTRATE = interestRate;
                                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                                finalCounter = initialCounter;
                            }


                        }
                        else
                        {
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                            finalCounter = initialCounter;

                        }



                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {
                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);



                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeEvenPrincipalPaymentsKeepExistingNewAnnuityNew(int loanID, DateTime effectiveDate, double interestRate, int frequencyId, DateTime maturityDate)
        {

            var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

            int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

            int numberOfPaymentsInAYear = 0;

            if ((int)(FrequencyTypeEnum)frequencyId == 8)
            {
                numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
            }
            else
            {
                numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == (short)(FrequencyTypeEnum)frequencyId).VALUE;
            }


            // var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

            var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();


            //if (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT.Equals(0))
            //{
            //    firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();
            //}

            var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            if (previousPeriodicRepaymentData == null)
            {
                previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
            }

            var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

            int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

            //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

            int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

            double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            if ((int)(FrequencyTypeEnum)frequencyId == 8)
            {
                accruedInterestBeforeEffectiveDate = 0;
            }

            double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

            double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate; //+ accruedInterestAfterEffectiveDate;

            double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

            int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)frequencyId);

            double annuity = nextOpeningBalance / numberOfPayments;

            TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

            List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

            int initialCounter = 0;
            int finalCounter = 1;
            DateTime nextPaymentDate = DateTime.Now;
            DateTime nextInterestPaymentDate = DateTime.Now;
            int counter = 0;
            DateTime nextPaymentDateNew = DateTime.Now;


            decimal firstPeriodicScheduleDataValue = 0;

            if (firstPeriodicScheduleData == null)
            {
                firstPeriodicScheduleDataValue = 0;
            }
            else
            {
                firstPeriodicScheduleDataValue = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT;
            }

            if (nextOpeningBalance >= (double)firstPeriodicScheduleDataValue)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + (decimal)annuity, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                loanPeriodic.INTERESTRATE = interestRate;
                //loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
                loanPeriodic.PAYMENTDATE = effectiveDate;

                loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                //nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;
                nextPaymentDate = effectiveDate;

                loanPeriodic_List.Add(loanPeriodicCalculationNew);


                int numberOfPaymentsCount = 0;

                numberOfPayments = numberOfPayments - 1;

                while (initialCounter != finalCounter)
                {
                    counter = counter + 1;

                    //if (counter == 1)
                    //{
                    //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
                    //}
                    //else
                    //{
                    //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
                    //}

                    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                    nextPaymentDate = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, nextPaymentDate);

                    //if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
                    if (numberOfPaymentsCount != numberOfPayments)
                    {
                        numberOfPaymentsCount = numberOfPaymentsCount + 1;

                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;


                        if (loanPeriodic.ENDPRINCIPALAMOUNT >= loanPeriodic.PERIODPAYMENTAMOUNT)
                        {
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }
                        else
                        {
                            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                            loanPeriodic.INTERESTRATE = interestRate;
                            loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        }



                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                    }
                    else
                    {


                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        loanPeriodic.INTERESTRATE = interestRate;
                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                        finalCounter = initialCounter;

                    }


                    if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
                    {
                        finalCounter = initialCounter;
                    }


                    loanPeriodic_List.Add(loanPeriodicCalculation);


                }


            }
            else
            {

                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
                loanPeriodic.INTERESTRATE = interestRate;
                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
                //loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

            foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
            {
                LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

                loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
                loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
                loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
                loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
                loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

                loanPeriodic_List.Add(loanPeriodicCalculation);

            }

            return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        }

        public bool SaveNmrcSchedule(List<LoanPaymentSchedulePeriodicViewModel> Model, LoanPaymentScheduleInputViewModel LoanModel)
        {
            using (FinTrakBankingContext context = new FinTrakBankingContext())
            {
                using (var trans = context.Database.BeginTransaction())
                {
                    try
                    {
                        var LoanId = LoanModel.loanId;
                        var LoanInfo = context.TblNmrcRefinancingTranches.FirstOrDefault(x => x.Id == LoanId);
                        LoanInfo.Rate = (int)Model.FirstOrDefault().interestRate;
                        LoanInfo.IsScheduled = 1;
                        LoanInfo.Tenor = LoanModel.tenor;


                        var NmrcSchedule = new List<TBL_NMRC_LOAN_SCHEDULE_PERIODIC>();
                        foreach (var item in Model)
                        {
                            var Schedule = new TBL_NMRC_LOAN_SCHEDULE_PERIODIC();
                            Schedule.DATETIMECREATED = DateTime.Now;
                            Schedule.INTERESTRATE = item.interestRate;
                            Schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            Schedule.STARTPRINCIPALAMOUNT = (decimal)item.startPrincipalAmount;
                            Schedule.PERIODPAYMENTAMOUNT = (decimal)item.periodPaymentAmount;
                            Schedule.PERIODINTERESTAMOUNT = (decimal)item.periodInterestAmount;
                            Schedule.PERIODPRINCIPALAMOUNT = (decimal)item.periodPrincipalAmount;
                            Schedule.ENDPRINCIPALAMOUNT = (decimal)item.endPrincipalAmount;
                            Schedule.AMORTISEDSTARTPRINCIPALAMOUNT = (decimal)item.amortisedStartPrincipalAmount;
                            Schedule.AMORTISEDPERIODPAYMENTAMOUNT = (decimal)item.amortisedPeriodPaymentAmount;
                            Schedule.AMORTISEDPERIODINTERESTAMOUNT = (decimal)item.amortisedPeriodInterestAmount;
                            Schedule.AMORTISEDPERIODPRINCIPALAMOUNT = (decimal)item.amortisedPeriodPrincipalAmount;
                            Schedule.DATETIMEUPDATED = DateTime.Now;
                            Schedule.PAYMENTDATE = DateTime.Now;
                            Schedule.LOANID = (int)LoanId;
                            NmrcSchedule.Add(Schedule);

                        }
                        context.TBL_NMRC_LOAN_SCHEDULE_PERIODIC.AddRange(NmrcSchedule);

                        var output = context.SaveChanges() > 0;
                        trans.Commit();
                        trans.Dispose();


                        return true;
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();

                        throw;
                    }



                }
            }

        }









        public List<LoanPaymentSchedulePeriodicViewModel> GeneratePeriodicLoanScheduleNMRC(LoanPaymentScheduleInputViewModel loanInput)
        {
            List<LoanPaymentSchedulePeriodicViewModel> output = null; // new List<LoanPaymentSchedulePeriodicViewModel>();


            LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;


            if (loanInput.operationTypeId == (int)OperationsEnum.LoanRecapitilization)
            {
                loanInput.isExistingFacility = false;
            }

            if (loanInput.isExistingFacility == false)
            {

                if (loanInput.principalAmount <= 0)
                    throw new ConditionNotMetException("Please Enter Loan Amount");
                if (loanInput.interestRate < 0)
                    throw new ConditionNotMetException("Please Enter Loan Interest Amount");
                //if (loanInput.principalFirstpaymentDate < loanInput.effectiveDate)
                //    throw new ConditionNotMetException("First principal first payment date cannot be less than effective date ");
                //if (loanInput.interestFirstpaymentDate < loanInput.effectiveDate)
                //    throw new ConditionNotMetException("First interest first payment date cannot be less than effective date ");

                if (scheduleMethod != LoanScheduleTypeEnum.IrregularSchedule)
                {
                    if (loanInput.maturityDate < loanInput.effectiveDate)
                        throw new ConditionNotMetException("Maturity date cannot be less than effective date");
                }
                else
                {

                }

                if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                    output = GenerateIrregularPeriodicScheduleWithAmortisedCost(loanInput).ToList();
                else if (scheduleMethod == LoanScheduleTypeEnum.Annuity)
                {
                    if (loanInput.interestFirstpaymentDate == loanInput.principalFirstpaymentDate && loanInput.interestFrequency == loanInput.principalFrequency)
                    {
                        output = GenerateNormalAnnuityPeriodicSchedule(loanInput);
                        //SaveNmrcSchedule(output, loanInput);
                    }

                    else
                    {
                        output = GenerateMoratoriumAnnuityPeriodicSchedule(loanInput);
                        //SaveNmrcSchedule(output, loanInput);
                    }
                }
                else if (scheduleMethod == LoanScheduleTypeEnum.ReducingBalance)
                    output = GenerateReducingBalancePeriodicSchedule(loanInput);
                else if (scheduleMethod == LoanScheduleTypeEnum.BulletPayment)
                    output = GenerateBulletPeriodicScheduleWithAmortisedCost(loanInput);
                else if (scheduleMethod == LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                    output = GenerateConstantPrincipalAndInterestPeriodicScheduleWithAmortisedCost(loanInput);
                else if (scheduleMethod == LoanScheduleTypeEnum.BallonPayment)
                    output = GenerateBallonPeriodicSchedule(loanInput);

            }
            else
            {
                if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                    output = GenerateIrregularPeriodicScheduleWithAmortisedCost(loanInput).ToList();
                else if (scheduleMethod == LoanScheduleTypeEnum.Annuity)
                {
                    if (loanInput.interestFrequencyTypeId == loanInput.principalFrequencyTypeId)
                    {
                        if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.MaintainTenor)
                            output = PrepaymentWithNewAnnuity((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution);
                        else if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.UseExistingRepayment)
                            output = PrepaymentWithKeepExistingAnnuity((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution);
                        else if (loanInput.operationTypeId == (int)OperationsEnum.PaymentDateChange)
                        {
                            if ((int)loanInput.principalFrequencyTypeId == (int)FrequencyTypeEnum.Daily && (int)loanInput.interestFrequencyTypeId == (int)FrequencyTypeEnum.Daily)
                            {
                                throw new ConditionNotMetException("Payment Date Change Operation Cannot Be Apply To A Daily Schedule");
                            }

                            output = InterestRateChange((int)loanInput.loanId, loanInput.effectiveDate, loanInput.interestRate, (int)loanInput.interestFrequencyTypeId, loanInput.maturityDate);
                        }
                        else if (loanInput.prepaymentMethodId == null || loanInput.prepaymentMethodId == 0)
                            output = InterestRateChangeWithNewAnnuity((int)loanInput.loanId, loanInput.effectiveDate, loanInput.interestRate, (int)loanInput.interestFrequencyTypeId, loanInput.maturityDate);
                    }
                    else
                    {
                        if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.MaintainTenor)
                            output = PrepaymentWithNewAnnuityAndUnEqualPayment((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution, (int)loanInput.principalFrequencyTypeId, (int)loanInput.interestFrequencyTypeId);
                        else if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.UseExistingRepayment)
                            output = PrepaymentWithKeepExistingAnnuityAndUnEqualPayment((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution, (int)loanInput.principalFrequencyTypeId, (int)loanInput.interestFrequencyTypeId);
                        else if (loanInput.operationTypeId == (int)OperationsEnum.InterestandPrincipalFrequencyChange)
                        {
                            output = AnnuityFrequencyChange((int)loanInput.loanId, loanInput.effectiveDate, (int)loanInput.principalFrequencyTypeId, (int)loanInput.interestFrequencyTypeId, loanInput.interestRate, loanInput.maturityDate);
                        }
                        else if (loanInput.operationTypeId == (int)OperationsEnum.PaymentDateChange)
                        {
                            if ((int)loanInput.principalFrequencyTypeId == (int)FrequencyTypeEnum.Daily && (int)loanInput.interestFrequencyTypeId == (int)FrequencyTypeEnum.Daily)
                            {
                                throw new ConditionNotMetException("Payment Date Change Operation Cannot Be Apply To A Daily Schedule");
                            }

                            output = AnnuityFrequencyChange((int)loanInput.loanId, loanInput.effectiveDate, (int)loanInput.principalFrequencyTypeId, (int)loanInput.interestFrequencyTypeId, loanInput.interestRate, loanInput.maturityDate);
                        }
                        else
                            output = InterestRateChangeWithNewAnnuityAndUnEqualPayment((int)loanInput.loanId, loanInput.effectiveDate, (int)loanInput.principalFrequencyTypeId, (int)loanInput.interestFrequencyTypeId, loanInput.interestRate, loanInput.maturityDate);
                    }

                }
                else if (scheduleMethod == LoanScheduleTypeEnum.ReducingBalance)
                {
                    if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.MaintainTenor)
                        output = EvenPrincipalPaymentsKeepExistingNewAnnuity((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution);
                    else if (loanInput.prepaymentMethodId == (int)PrepaymentMethodEnum.UseExistingRepayment)
                        output = EvenPrincipalPaymentsKeepExistingAnnuity((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution);
                    else if (loanInput.interestFrequencyTypeId != loanInput.principalFrequencyTypeId)
                    {
                        throw new ConditionNotMetException("Different Frequency Method Cannot Be Apply To A Reducing Balance Schedule");
                    }
                    else if (loanInput.operationTypeId == (int)OperationsEnum.PaymentDateChange)
                    {
                        if ((int)loanInput.principalFrequencyTypeId == (int)FrequencyTypeEnum.Daily && (int)loanInput.interestFrequencyTypeId == (int)FrequencyTypeEnum.Daily)
                        {
                            throw new ConditionNotMetException("Payment Date Change Operation Cannot Be Apply To A Daily Schedule");
                        }

                        output = InterestRateChangeEvenPrincipalPaymentsKeepExistingNewAnnuityNew((int)loanInput.loanId, loanInput.effectiveDate, loanInput.interestRate, (int)loanInput.interestFrequencyTypeId, loanInput.maturityDate);
                    }
                    else
                        output = InterestRateChangeEvenPrincipalPaymentsKeepExistingNewAnnuity((int)loanInput.loanId, loanInput.effectiveDate, loanInput.interestRate, (int)loanInput.interestFrequencyTypeId, loanInput.maturityDate);
                }

                else if (scheduleMethod == LoanScheduleTypeEnum.BulletPayment)
                {
                    if (loanInput.equityContribution.HasValue && loanInput.equityContribution != 0)
                    {
                        output = BulletPrepayments((int)loanInput.loanId, loanInput.effectiveDate, (double)loanInput.equityContribution);
                    }
                    else if (loanInput.operationTypeId == (int)OperationsEnum.InterestandPrincipalFrequencyChange)
                    {
                        throw new ConditionNotMetException("Interest And Principal Frequency Change Operation Cannot Be Apply To A Bullet Payment Schedule");
                    }
                    else if (loanInput.operationTypeId == (int)OperationsEnum.PaymentDateChange)
                    {
                        throw new ConditionNotMetException("Payment Date Change Operation Cannot Be Apply To A Bullet Payment Schedule");
                    }
                    else
                    {
                        output = BulletInterestRateChange((int)loanInput.loanId, loanInput.effectiveDate, loanInput.interestRate, loanInput.maturityDate);
                    }

                }

                else if (scheduleMethod == LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                {
                    output = GenerateConstantPrincipalAndInterestPeriodicScheduleWithAmortisedCost(loanInput);
                }

                else if (scheduleMethod == LoanScheduleTypeEnum.BallonPayment)
                {
                    if (loanInput.equityContribution.HasValue && loanInput.equityContribution != 0)
                    {
                        output = BallonInterestRateChangePrepayment((int)loanInput.loanId, loanInput.effectiveDate, 0, (int)loanInput.interestFrequencyTypeId, loanInput.interestRate, (double)loanInput.equityContribution);
                    }
                    else if (loanInput.operationTypeId == (int)OperationsEnum.InterestandPrincipalFrequencyChange)
                    {
                        throw new ConditionNotMetException("Interest And Principal Frequency Change Operation Cannot Be Apply To A Ballon Payment Schedule");
                    }
                    else if (loanInput.operationTypeId == (int)OperationsEnum.PaymentDateChange)
                    {
                        throw new ConditionNotMetException("Payment Date Change Operation Cannot Be Apply To A Ballon Payment Schedule");
                    }
                    else
                    {
                        output = BallonInterestRateChange((int)loanInput.loanId, loanInput.effectiveDate, 0, (int)loanInput.interestFrequencyTypeId, loanInput.interestRate, loanInput.maturityDate);
                    }
                }

            }

            return output;
        }





        //public List<LoanPaymentSchedulePeriodicViewModel> AnnuityEqualFrequency(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, DateTime maturityDate)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();


        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
        //    }

        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0 && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    if (previousPeriodicRepaymentData == null)
        //    {
        //        previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();
        //    }

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    //int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        //accruedInterestBeforeEffectiveDate = 0;
        //        accruedInterestBeforeEffectiveDate = accruedInterestBeforeEffectiveDate;
        //    }

        //    //double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate; //+ accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    int numberOfPayments = 0;

        //    if (principalRepaymentFrequency == 0)
        //    {
        //        numberOfPayments = 1;
        //    }
        //    else
        //    {
        //        numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)principalRepaymentFrequency);
        //    }

        //    int numberInterestOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)interestRepaymentFrequency);

        //    //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

        //    DateTime nextPrincipalPeriodicDate = DateTime.Now;

        //    if (principalRepaymentFrequency != 0)
        //    {
        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //            if (nextPrincipalPeriodicData != null)
        //            {
        //                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
        //            }
        //            else
        //            {
        //                var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //                nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
        //            }

        //        }
        //        else
        //        {
        //            //if (loan.INTERESTFREQUENCYTYPEID != loan.PRINCIPALFREQUENCYTYPEID)
        //            //{
        //            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
        //            //}
        //            //else
        //            //{
        //            //    nextPrincipalPeriodicDate = nextPeriodicRepaymentData.PAYMENTDATE;
        //            //}
        //        }
        //    }
        //    else
        //    {
        //        nextPrincipalPeriodicDate = maturityDate;
        //    }


        //    //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, (numberOfPayments * numberOfPaymentsInAYear), numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);

        //    double annuity = (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT;

        //    //if (interestRepaymentFrequency == 8)
        //    //{
        //    //    annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));
        //    //}
        //    //else
        //    //{
        //    //    annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, principalRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

        //    //    //annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    //}



        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= annuity)
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //            loanPeriodic.INTERESTRATE = interestRate;
        //            //loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //            loanPeriodic.PAYMENTDATE = effectiveDate;
        //        }
        //        else
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //            loanPeriodic.INTERESTRATE = interestRate;
        //            // loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //            loanPeriodic.PAYMENTDATE = effectiveDate;
        //        }


        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        //nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        nextPaymentDate = effectiveDate;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        int numberOfPaymentsCount = 0;

        //        numberOfPayments = numberOfPayments - 1;

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;


        //            if (nextPaymentDate == Convert.ToDateTime("01/19/2019"))
        //            {
        //                var me = "";
        //            }

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)

        //            //if (numberOfPaymentsCount != numberOfPayments)
        //            if (numberOfPaymentsCount != numberInterestOfPayments)
        //            {

        //                numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    var testNegativeValue = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);


        //                    if (testNegativeValue > 0)
        //                    {
        //                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.INTERESTRATE = interestRate;
        //                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);
        //                    }
        //                    else
        //                    {
        //                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.INTERESTRATE = interestRate;
        //                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                        finalCounter = initialCounter;
        //                    }




        //                }

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {


        //                    var testNegativeValue = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);


        //                    if (testNegativeValue > 0)
        //                    {
        //                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.INTERESTRATE = interestRate;
        //                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);
        //                    }
        //                    else
        //                    {
        //                        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.INTERESTRATE = interestRate;
        //                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                        finalCounter = initialCounter;
        //                    }

        //                    //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                    //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.INTERESTRATE = interestRate;
        //                    //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                    ////loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                    ////loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    ////loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    ////loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    ////loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    ////loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    ////loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    ////loanPeriodic.INTERESTRATE = interestRate;
        //                    ////loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    finalCounter = initialCounter;
        //                }


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);



        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}


        //public List<LoanPaymentSchedulePeriodicViewModel> PrepaymentWithKeepExistingAnnuity(int loanID, DateTime effectiveDate, double prepaymentAmount)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
        //    }


        //    //var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            //if (counter == 1)
        //            //{
        //            //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
        //            //}
        //            //else
        //            //{
        //            //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
        //            //}

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

        //            if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //                //if (loanPeriodic.PAYMENTNUMBER == 19)
        //                //{
        //                //    string me = string.Empty;
        //                //}


        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //            }
        //            else
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //                finalCounter = initialCounter;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);


        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        ///// <summary>
        ///// 
        ///// </summary>
        ///// <param name="loanID"></param>
        ///// <param name="effectiveDate"></param>
        ///// <param name="prepaymentAmount"></param>
        ///// <returns></returns>
        //public List<LoanPaymentSchedulePeriodicViewModel> PrepaymentWithNewAnnuity(int loanID, DateTime effectiveDate, double prepaymentAmount)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID);

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

        //    double annuity = 0;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        annuity = PMT(loan.INTERESTRATE, numberOfPayments, nextOpeningBalance, (int)loan.PRINCIPALFREQUENCYTYPEID, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        annuity = wct.LPMT(nextOpeningBalance, effectiveDate, loan.INTERESTRATE / 100, nextPeriodicRepaymentData.PAYMENTDATE, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    }


        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;

        //    if (nextOpeningBalance >= annuity)
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        decimal bal = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);

        //        if (bal < 0)
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)0, 2);
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //            loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }
        //        else
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //            loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }


        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);


        //        int numberOfPaymentsCount = 0;

        //        numberOfPayments = numberOfPayments - 1;

        //        while (initialCounter != finalCounter)
        //        {

        //            numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity && numberOfPaymentsCount != numberOfPayments)
        //            if (numberOfPaymentsCount != numberOfPayments)
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //                //if (loanPeriodic.PAYMENTNUMBER == 19)
        //                //{
        //                //    string me = string.Empty;
        //                //}

        //                if (loanPeriodic.ENDPRINCIPALAMOUNT >= loanPeriodic.PERIODPAYMENTAMOUNT)
        //                {
        //                    if (loan.MATURITYDATE != nextPaymentDate)
        //                    {
        //                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;
        //                    }
        //                    else
        //                    {
        //                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

        //                        finalCounter = initialCounter;
        //                    }



        //                }
        //                else
        //                {
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

        //                    finalCounter = initialCounter;

        //                }


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //                finalCounter = initialCounter;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);



        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> PrepaymentWithKeepExistingAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, double prepaymentAmount, int principalRepaymentFrequency, int interestRepaymentFrequency)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

        //    DateTime nextPrincipalPeriodicDate = DateTime.Now;

        //    if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //    {
        //        var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //        if (nextPrincipalPeriodicData != null)
        //        {
        //            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
        //        }
        //        else
        //        {
        //            var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //            nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
        //        }

        //    }
        //    else
        //    {
        //        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
        //    }


        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();


        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //            loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }
        //        else
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //            loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }


        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);


        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

        //            if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                }

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //            }
        //            else
        //            {

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                    //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                    //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    finalCounter = initialCounter;
        //                }


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);



        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> PrepaymentWithNewAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, double prepaymentAmount, int principalRepaymentFrequency, int interestRepaymentFrequency)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;


        //    if (interestRepaymentFrequency == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

        //    int numberOfPayments = 0;

        //    if (principalRepaymentFrequency == 0)
        //    {
        //        numberOfPayments = 1;
        //    }
        //    else
        //    {
        //        numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)principalRepaymentFrequency);
        //    }



        //    //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

        //    DateTime nextPrincipalPeriodicDate = DateTime.Now;

        //    if (principalRepaymentFrequency != 0)
        //    {
        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //            if (nextPrincipalPeriodicData != null)
        //            {
        //                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
        //            }
        //            else
        //            {
        //                var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //                nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
        //            }

        //        }
        //        else
        //        {
        //            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
        //        }
        //    }
        //    else
        //    {
        //        nextPrincipalPeriodicDate = loan.MATURITYDATE;
        //    }


        //    double annuity = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        annuity = PMT(loan.INTERESTRATE, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));
        //    }
        //    else
        //    {
        //        annuity = wct.LPMT(nextOpeningBalance, effectiveDate, loan.INTERESTRATE / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    }

        //    //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, (numberOfPayments * numberOfPaymentsInAYear), numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);

        //    // double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, loan.INTERESTRATE / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);


        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= annuity)
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //            loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }
        //        else
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //            loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }


        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);


        //        int numberOfPaymentsCount = 0;

        //        numberOfPayments = numberOfPayments - 1;

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
        //            if (numberOfPaymentsCount != numberOfPayments)
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    if (loan.MATURITYDATE != nextPaymentDate)
        //                    {
        //                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    }
        //                    else
        //                    {
        //                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    }


        //                }
        //                else
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                }

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                    //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.INTERESTRATE = interestRate;
        //                    //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    finalCounter = initialCounter;
        //                }


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);



        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithKeepExistingAnnuity(int loanID, DateTime effectiveDate, double interestRate)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;

        //    if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = (decimal)nextOpeningBalance;
        //        loanPeriodic.PERIODPAYMENTAMOUNT = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT;
        //        loanPeriodic.PERIODINTERESTAMOUNT = (decimal)nextRepaymentInterestAmount;
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount;
        //        loanPeriodic.ENDPRINCIPALAMOUNT = (decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        while (initialCounter != finalCounter)
        //        {
        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

        //            if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //            {

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodic.PERIODPAYMENTAMOUNT = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT;
        //                loanPeriodic.PERIODINTERESTAMOUNT = ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT));
        //                loanPeriodic.ENDPRINCIPALAMOUNT = loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT));
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE); //nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodic.PERIODPAYMENTAMOUNT = loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodic.PERIODINTERESTAMOUNT = ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = (loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT));
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);   //nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //                finalCounter = initialCounter;

        //            }

        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);



        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = (decimal)nextOpeningBalance;
        //        loanPeriodic.PERIODPAYMENTAMOUNT = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT;
        //        loanPeriodic.PERIODINTERESTAMOUNT = (decimal)nextRepaymentInterestAmount;
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount;
        //        loanPeriodic.ENDPRINCIPALAMOUNT = (decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithNewAnnuity(int loanID, DateTime effectiveDate, double interestRate, int frequencyId, DateTime maturityDate)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (frequencyId == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == frequencyId).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)frequencyId);

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (frequencyId == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }
        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, (int)frequencyId, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    double annuity = 0;

        //    if (frequencyId == 8)
        //    {
        //        annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, (int)frequencyId, (int)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPeriodicRepaymentData.PAYMENTDATE, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    }


        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;

        //    if (nextOpeningBalance >= annuity)
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        int numberOfPaymentsCount = 0;

        //        numberOfPayments = numberOfPayments - 1;


        //        while (initialCounter != finalCounter)
        //        {

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate((int)frequencyId, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
        //            if (numberOfPaymentsCount != numberOfPayments)
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //                //if (loanPeriodic.PAYMENTNUMBER == 19)
        //                //{
        //                //    string me = string.Empty;
        //                //}


        //                if (loanPeriodic.ENDPRINCIPALAMOUNT >= loanPeriodic.PERIODPAYMENTAMOUNT)
        //                {
        //                    if (maturityDate != nextPaymentDate)
        //                    {
        //                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.INTERESTRATE = interestRate;
        //                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

        //                    }
        //                    else
        //                    {
        //                        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                        loanPeriodic.INTERESTRATE = interestRate;
        //                        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

        //                        finalCounter = initialCounter;
        //                    }


        //                }
        //                else
        //                {
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

        //                    finalCounter = initialCounter;

        //                }



        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);  //nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //                finalCounter = initialCounter;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);



        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)frequencyId, loanPeriodic.PAYMENTDATE);

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithKeepExistingAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    DateTime nextPrincipalPeriodicDate = DateTime.Now;

        //    if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //    {
        //        var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //        if (nextPrincipalPeriodicData != null)
        //        {
        //            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
        //        }
        //        else
        //        {
        //            var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //            nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
        //        }

        //    }
        //    else
        //    {
        //        nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
        //    }


        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();


        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //            loanPeriodic.INTERESTRATE = interestRate;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }
        //        else
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //            loanPeriodic.INTERESTRATE = interestRate;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }


        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;


        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

        //            if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                }

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //            }
        //            else
        //            {

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                    //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.INTERESTRATE = interestRate;
        //                    //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    finalCounter = initialCounter;
        //                }


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;




        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);



        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> EvenPrincipalPaymentsKeepExistingAnnuity(int loanID, DateTime effectiveDate, double prepaymentAmount)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            //if (counter == 1)
        //            //{
        //            //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
        //            //}
        //            //else
        //            //{
        //            //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
        //            //}

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

        //            if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {
        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //                finalCounter = initialCounter;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);


        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeEvenPrincipalPaymentsKeepExistingAnnuity(int loanID, DateTime effectiveDate, double interestRate)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            //if (counter == 1)
        //            //{
        //            //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
        //            //}
        //            //else
        //            //{
        //            //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
        //            //}

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

        //            if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
        //            {
        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //                finalCounter = initialCounter;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);


        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> EvenPrincipalPaymentsKeepExistingNewAnnuity(int loanID, DateTime effectiveDate, double prepaymentAmount)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if ((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == (short)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if ((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

        //    int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID);

        //    double annuity = nextOpeningBalance / numberOfPayments;

        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + (decimal)annuity, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        int numberOfPaymentsCount = 0;

        //        numberOfPayments = numberOfPayments - 1;

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            //if (counter == 1)
        //            //{
        //            //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
        //            //}
        //            //else
        //            //{
        //            //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
        //            //}

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
        //            if (numberOfPaymentsCount != numberOfPayments)
        //            {

        //                numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //            }
        //            else
        //            {


        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //                finalCounter = initialCounter;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);


        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        //loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        ////loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        ////loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        ////loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        ////loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        ////loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        ////loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //        ////loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        ////loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        ////loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        ////loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        ////loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        ////loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        ////loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        ////loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        ////loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //        ////loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //        ////loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        ////loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        //loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        //loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        //loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        //loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        //loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        //loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        //loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        //loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeEvenPrincipalPaymentsKeepExistingNewAnnuity(int loanID, DateTime effectiveDate, double interestRate, int frequencyId, DateTime maturityDate)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if ((int)(FrequencyTypeEnum)frequencyId == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == (short)(FrequencyTypeEnum)frequencyId).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if ((int)(FrequencyTypeEnum)frequencyId == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)frequencyId);

        //    double annuity = nextOpeningBalance / numberOfPayments;

        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + (decimal)annuity, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);


        //        int numberOfPaymentsCount = 0;

        //        numberOfPayments = numberOfPayments - 1;

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            //if (counter == 1)
        //            //{
        //            //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
        //            //}
        //            //else
        //            //{
        //            //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
        //            //}

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
        //            if (numberOfPaymentsCount != numberOfPayments)
        //            {
        //                numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;


        //                if (loanPeriodic.ENDPRINCIPALAMOUNT >= loanPeriodic.PERIODPAYMENTAMOUNT)
        //                {
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }



        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {


        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //                finalCounter = initialCounter;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);


        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)frequencyId, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeEvenPrincipalPaymentsKeepExistingNewAnnuity(int loanID, DateTime effectiveDate, double interestRate, double prepaymentAmount)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == loan.PRINCIPALFREQUENCYTYPEID).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (loan.PRINCIPALFREQUENCYTYPEID == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

        //    int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID);

        //    double annuity = nextOpeningBalance / numberOfPayments;

        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + (decimal)annuity, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        int numberOfPaymentsCount = 0;

        //        numberOfPayments = numberOfPayments - 1;


        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            //if (counter == 1)
        //            //{
        //            //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
        //            //}
        //            //else
        //            //{
        //            //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
        //            //}

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
        //            if (numberOfPaymentsCount != numberOfPayments)
        //            {

        //                numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {


        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //                finalCounter = initialCounter;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);


        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithNewAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, DateTime maturityDate)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    int numberOfPayments = 0;

        //    if (principalRepaymentFrequency == 0)
        //    {
        //        numberOfPayments = 1;
        //    }
        //    else
        //    {
        //        numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)principalRepaymentFrequency);
        //    }



        //    //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

        //    DateTime nextPrincipalPeriodicDate = DateTime.Now;

        //    if (principalRepaymentFrequency != 0)
        //    {
        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //            if (nextPrincipalPeriodicData != null)
        //            {
        //                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
        //            }
        //            else
        //            {
        //                var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //                nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
        //            }

        //        }
        //        else
        //        {
        //            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
        //        }
        //    }
        //    else
        //    {
        //        nextPrincipalPeriodicDate = maturityDate;
        //    }


        //    //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, (numberOfPayments * numberOfPaymentsInAYear), numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);

        //    double annuity = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));
        //    }
        //    else
        //    {
        //        annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    }



        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= annuity)
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //            loanPeriodic.INTERESTRATE = interestRate;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }
        //        else
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //            loanPeriodic.INTERESTRATE = interestRate;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }


        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        int numberOfPaymentsCount = 0;

        //        numberOfPayments = numberOfPayments - 1;

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
        //            if (numberOfPaymentsCount != numberOfPayments)
        //            {

        //                numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                }

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                    //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.INTERESTRATE = interestRate;
        //                    //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    finalCounter = initialCounter;
        //                }


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);



        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> InterestRateChangeWithNewAnnuityAndUnEqualPayment(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, double prepaymentAmount)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

        //    int numberOfPayments = 0;

        //    if (principalRepaymentFrequency == 0)
        //    {
        //        numberOfPayments = 1;
        //    }
        //    else
        //    {
        //        numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)principalRepaymentFrequency);
        //    }



        //    //double annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));

        //    DateTime nextPrincipalPeriodicDate = DateTime.Now;

        //    if (principalRepaymentFrequency != 0)
        //    {
        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //            if (nextPrincipalPeriodicData != null)
        //            {
        //                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
        //            }
        //            else
        //            {
        //                var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //                nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
        //            }

        //        }
        //        else
        //        {
        //            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
        //        }
        //    }
        //    else
        //    {
        //        nextPrincipalPeriodicDate = loan.MATURITYDATE;
        //    }


        //    //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, (numberOfPayments * numberOfPaymentsInAYear), numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);

        //    //double annuity = 0;

        //    //if (principalRepaymentFrequency != 0)
        //    //{
        //    //double annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    //}
        //    //else
        //    //{
        //    //    annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, ((loan.MATURITYDATE - effectiveDate).Days), GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    //}

        //    double annuity = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        annuity = PMT(interestRate, numberOfPayments, nextOpeningBalance, interestRepaymentFrequency, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID));
        //    }
        //    else
        //    {
        //        annuity = wct.LPMT(nextOpeningBalance, effectiveDate, interestRate / 100, nextPrincipalPeriodicDate, numberOfPayments, numberOfPaymentsInAYear, GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID), 0, null);
        //    }


        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= annuity)
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //            loanPeriodic.INTERESTRATE = interestRate;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }
        //        else
        //        {
        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //            loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //            loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //            loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //            loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //            loanPeriodic.INTERESTRATE = interestRate;
        //            loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //        }


        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;


        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        int numberOfPaymentsCount = 0;

        //        numberOfPayments = numberOfPayments - 1;

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
        //            if (numberOfPaymentsCount != numberOfPayments)
        //            {

        //                numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((decimal)annuity - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                }

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //            }
        //            else
        //            {

        //                if (nextPrincipalPeriodicDate != nextPaymentDate)
        //                {

        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                }
        //                else
        //                {

        //                    //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                    //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    //loanPeriodic.INTERESTRATE = interestRate;
        //                    //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                    loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                    loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                    loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                    loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                    loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                    loanPeriodic.INTERESTRATE = interestRate;
        //                    loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                    finalCounter = initialCounter;
        //                }


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);



        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity - (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - ((decimal)annuity - (decimal)nextRepaymentInterestAmount), 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> EvenPrincipalPaymentsNewAnnuity(int loanID, DateTime effectiveDate, DateTime maturityDate)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if ((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == (short)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if ((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    int numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID);

        //    double annuity = nextOpeningBalance / numberOfPayments;

        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    if (nextOpeningBalance >= (double)firstPeriodicScheduleData.PERIODPAYMENTAMOUNT)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount + (decimal)annuity, 2); //Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //        nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //        int numberOfPaymentsCount = 0;

        //        numberOfPayments = numberOfPayments - 1;

        //        while (initialCounter != finalCounter)
        //        {
        //            counter = counter + 1;

        //            //if (counter == 1)
        //            //{
        //            //    nextPaymentDateNew = nextPeriodicRepaymentData.PAYMENTDATE;
        //            //}
        //            //else
        //            //{
        //            //    nextPaymentDateNew = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);
        //            //}

        //            LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //            nextPaymentDate = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, nextPaymentDate);

        //            //if (loanPeriodic.ENDPRINCIPALAMOUNT >= firstPeriodicScheduleData.PERIODPRINCIPALAMOUNT)
        //            if (numberOfPaymentsCount != numberOfPayments)
        //            {
        //                numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //            }
        //            else
        //            {


        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //                loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //                loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //                loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //                loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //                loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //                loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //                finalCounter = initialCounter;

        //            }


        //            if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //            {
        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodic_List.Add(loanPeriodicCalculation);


        //        }


        //    }
        //    else
        //    {

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //        loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;


        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        //loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        //loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        //loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //        //loanPeriodic.INTERESTRATE = loan.INTERESTRATE;
        //        //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.INTERESTFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        ////loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        ////loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //        ////loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        ////loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)annuity + (((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //        ////loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)loan.INTERESTRATE / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //        ////loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)annuity, 2);
        //        ////loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        ////loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        ////loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        ////loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        ////loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        ////loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        ////loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //        ////loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        ////loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount, 2);
        //        ////loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (decimal)nextRepaymentInterestAmount), 2);
        //        ////loanPeriodic.INTERESTRATE = nextPeriodicRepaymentData.INTERESTRATE;
        //        ////loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate((int)loan.PRINCIPALFREQUENCYTYPEID, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //        //loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //        //loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //        //loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        //loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        //loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //        //loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;

        //        //loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //        //loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //        //loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //        //loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> BulletPrepayments(int loanID, DateTime effectiveDate, double prepaymentAmount)
        //{

        //    var loanData = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    var bulletPreviouData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();

        //    var bulletNextData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    output.Add(new LoanPaymentSchedulePeriodicViewModel
        //    {
        //        paymentNumber = 0,
        //        paymentDate = bulletPreviouData.PAYMENTDATE,
        //        startPrincipalAmount = 0,
        //        periodPrincipalAmount = 0,
        //        amortisedPeriodInterestAmount = 0,
        //        periodPaymentAmount = 0,
        //        endPrincipalAmount = (double)bulletPreviouData.ENDPRINCIPALAMOUNT
        //    });


        //    //double previousPrincipalAmount = loanInput.principalAmount;
        //    //DateTime previousPaymentDate = loanInput.effectiveDate;
        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanData.SCHEDULEDAYCOUNTCONVENTIONID);


        //    LoanPaymentSchedulePeriodicViewModel loanPeriod = new LoanPaymentSchedulePeriodicViewModel();
        //    loanPeriod.paymentNumber = 1;
        //    loanPeriod.paymentDate = loanData.MATURITYDATE;
        //    loanPeriod.startPrincipalAmount = (double)bulletNextData.STARTPRINCIPALAMOUNT - prepaymentAmount;
        //    loanPeriod.periodPrincipalAmount = (double)bulletNextData.STARTPRINCIPALAMOUNT - prepaymentAmount;

        //    var dateDifferenceCount = (loanData.MATURITYDATE - effectiveDate).TotalDays;

        //    loanPeriod.periodInterestAmount = (((double)bulletNextData.STARTPRINCIPALAMOUNT - prepaymentAmount) * (loanData.INTERESTRATE / 100.0)) * (dateDifferenceCount / daysInAYear);
        //    loanPeriod.periodPaymentAmount = loanPeriod.periodPrincipalAmount + loanPeriod.periodInterestAmount;
        //    loanPeriod.endPrincipalAmount = loanPeriod.startPrincipalAmount - loanPeriod.periodPrincipalAmount;

        //    output.Add(loanPeriod);

        //    return output;
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> BulletInterestRateChange(int loanID, DateTime effectiveDate, double interestRate, DateTime maturityDate)
        //{

        //    var loanData = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    var bulletPreviouData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 0).FirstOrDefault();

        //    var bulletNextData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTNUMBER == 1).FirstOrDefault();

        //    List<LoanPaymentSchedulePeriodicViewModel> output = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    output.Add(new LoanPaymentSchedulePeriodicViewModel
        //    {
        //        paymentNumber = 0,
        //        paymentDate = bulletPreviouData.PAYMENTDATE,
        //        startPrincipalAmount = 0,
        //        periodPrincipalAmount = 0,
        //        amortisedPeriodInterestAmount = 0,
        //        periodPaymentAmount = 0,
        //        endPrincipalAmount = (double)bulletPreviouData.ENDPRINCIPALAMOUNT
        //    });


        //    //double previousPrincipalAmount = loanInput.principalAmount;
        //    //DateTime previousPaymentDate = loanInput.effectiveDate;
        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loanData.SCHEDULEDAYCOUNTCONVENTIONID);


        //    LoanPaymentSchedulePeriodicViewModel loanPeriod = new LoanPaymentSchedulePeriodicViewModel();
        //    loanPeriod.paymentNumber = 1;
        //    loanPeriod.paymentDate = maturityDate;
        //    loanPeriod.startPrincipalAmount = (double)bulletNextData.STARTPRINCIPALAMOUNT;
        //    loanPeriod.periodPrincipalAmount = (double)bulletNextData.STARTPRINCIPALAMOUNT;

        //    var dateDifferenceCount = (maturityDate - effectiveDate).TotalDays;

        //    loanPeriod.periodInterestAmount = (((double)bulletNextData.STARTPRINCIPALAMOUNT) * (interestRate / 100.0)) * (dateDifferenceCount / daysInAYear);
        //    loanPeriod.periodPaymentAmount = loanPeriod.periodPrincipalAmount + loanPeriod.periodInterestAmount;
        //    loanPeriod.endPrincipalAmount = loanPeriod.startPrincipalAmount - loanPeriod.periodPrincipalAmount;

        //    output.Add(loanPeriod);

        //    return output;
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> BallonInterestRateChangePrepayment(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, double prepaymentAmount)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT - prepaymentAmount;

        //    int numberOfPayments = 0;

        //    if (principalRepaymentFrequency == 0)
        //    {
        //        numberOfPayments = 1;
        //    }
        //    else
        //    {
        //        numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, loan.MATURITYDATE, (FrequencyTypeEnum)principalRepaymentFrequency);
        //    }


        //    DateTime nextPrincipalPeriodicDate = DateTime.Now;

        //    if (principalRepaymentFrequency != 0)
        //    {
        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //            if (nextPrincipalPeriodicData != null)
        //            {
        //                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
        //            }
        //            else
        //            {
        //                var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //                nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
        //            }

        //        }
        //        else
        //        {
        //            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
        //        }
        //    }
        //    else
        //    {
        //        nextPrincipalPeriodicDate = loan.MATURITYDATE;
        //    }

        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    int exitLoopCounter = 0;

        //    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //    if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //    {
        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //    }
        //    else
        //    {
        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextOpeningBalance + (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = 0;
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        exitLoopCounter = 1;
        //    }


        //    loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //    loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //    loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //    loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //    loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //    loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;


        //    loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //    loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //    loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //    nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //    loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //    int numberOfPaymentsCount = 0;

        //    numberOfPayments = numberOfPayments - 1;

        //    while (initialCounter != finalCounter)
        //    {

        //        if (exitLoopCounter == 1)
        //        {
        //            break;
        //        }

        //        counter = counter + 1;

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

        //        //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
        //        if (numberOfPaymentsCount != numberOfPayments)
        //        {

        //            numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //            if (nextPrincipalPeriodicDate != nextPaymentDate)
        //            {

        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //            }
        //            else
        //            {

        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextOpeningBalance + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = 0;
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                exitLoopCounter = 1;

        //            }

        //            loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //            loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //            loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //            loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //            loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //            loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //            loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        }
        //        else
        //        {

        //            if (nextPrincipalPeriodicDate != nextPaymentDate)
        //            {

        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //            }
        //            else
        //            {

        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                //loanPeriodic.INTERESTRATE = interestRate;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                exitLoopCounter = 1;

        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //            loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //            loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //            loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //            loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //            loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //            loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //        }


        //        if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //        {
        //            finalCounter = initialCounter;
        //        }


        //        loanPeriodic_List.Add(loanPeriodicCalculation);



        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public List<LoanPaymentSchedulePeriodicViewModel> BallonInterestRateChange(int loanID, DateTime effectiveDate, int principalRepaymentFrequency, int interestRepaymentFrequency, double interestRate, DateTime maturityDate)
        //{

        //    var loan = context.TBL_LOAN.Where(c => c.TERMLOANID == loanID).FirstOrDefault();

        //    int daysInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestRepaymentFrequency).VALUE;
        //    }


        //    var firstPeriodicScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //    var isExactNextRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE == effectiveDate).FirstOrDefault();

        //    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    var nextPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate).OrderBy(c => c.PAYMENTDATE).Take(1).FirstOrDefault();

        //    int daysBeforeEffectiveDate = (effectiveDate - previousPeriodicRepaymentData.PAYMENTDATE).Days;

        //    int daysAfterEffectiveDate = (nextPeriodicRepaymentData.PAYMENTDATE - effectiveDate).Days + 1;

        //    double accruedInterestBeforeEffectiveDate = (loan.INTERESTRATE / 100.00000) / daysInAYear * daysBeforeEffectiveDate * (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    if (interestRepaymentFrequency == 8)
        //    {
        //        accruedInterestBeforeEffectiveDate = 0;
        //    }

        //    double accruedInterestAfterEffectiveDate = (interestRate / 100.00000) / daysInAYear * daysAfterEffectiveDate * ((double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT);

        //    double nextRepaymentInterestAmount = accruedInterestBeforeEffectiveDate + accruedInterestAfterEffectiveDate;

        //    double nextOpeningBalance = (double)previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;

        //    int numberOfPayments = 0;

        //    if (principalRepaymentFrequency == 0)
        //    {
        //        numberOfPayments = 1;
        //    }
        //    else
        //    {
        //        numberOfPayments = CalculateNumberOfInstallments(nextPeriodicRepaymentData.PAYMENTDATE, maturityDate, (FrequencyTypeEnum)principalRepaymentFrequency);
        //    }


        //    DateTime nextPrincipalPeriodicDate = DateTime.Now;

        //    if (principalRepaymentFrequency != 0)
        //    {
        //        if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //        {
        //            var nextPrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE <= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderByDescending(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //            if (nextPrincipalPeriodicData != null)
        //            {
        //                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPrincipalPeriodicData.PAYMENTDATE);
        //            }
        //            else
        //            {
        //                var nextAvailablePrincipalPeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE >= effectiveDate && c.PERIODPRINCIPALAMOUNT != 0).OrderBy(c => c.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //                nextPrincipalPeriodicDate = nextAvailablePrincipalPeriodicData.PAYMENTDATE;
        //            }

        //        }
        //        else
        //        {
        //            nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, nextPeriodicRepaymentData.PAYMENTDATE);
        //        }
        //    }
        //    else
        //    {
        //        nextPrincipalPeriodicDate = maturityDate;
        //    }

        //    TBL_LOAN_SCHEDULE_PERIODIC loanPeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


        //    List<LoanPaymentSchedulePeriodicViewModel> loanPeriodic_List = new List<LoanPaymentSchedulePeriodicViewModel>();

        //    int initialCounter = 0;
        //    int finalCounter = 1;
        //    DateTime nextPaymentDate = DateTime.Now;
        //    DateTime nextInterestPaymentDate = DateTime.Now;
        //    int counter = 0;
        //    DateTime nextPaymentDateNew = DateTime.Now;

        //    int exitLoopCounter = 0;

        //    LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculationNew = new LoanPaymentSchedulePeriodicViewModel();

        //    if (nextPeriodicRepaymentData.PERIODPRINCIPALAMOUNT == 0)
        //    {
        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //        loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;
        //    }
        //    else
        //    {
        //        loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //        loanPeriodic.PAYMENTNUMBER = nextPeriodicRepaymentData.PAYMENTNUMBER;
        //        loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextOpeningBalance + (decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((decimal)nextRepaymentInterestAmount, 2);
        //        loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //        loanPeriodic.ENDPRINCIPALAMOUNT = 0;
        //        loanPeriodic.INTERESTRATE = interestRate;
        //        loanPeriodic.PAYMENTDATE = nextPeriodicRepaymentData.PAYMENTDATE;

        //        exitLoopCounter = 1;
        //    }


        //    loanPeriodicCalculationNew.loanId = loanPeriodic.LOANID;
        //    loanPeriodicCalculationNew.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //    loanPeriodicCalculationNew.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //    loanPeriodicCalculationNew.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //    loanPeriodicCalculationNew.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.interestRate = loanPeriodic.INTERESTRATE;
        //    loanPeriodicCalculationNew.paymentDate = loanPeriodic.PAYMENTDATE;


        //    loanPeriodicCalculationNew.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //    loanPeriodicCalculationNew.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //    loanPeriodicCalculationNew.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //    loanPeriodicCalculationNew.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //    nextPaymentDate = nextPeriodicRepaymentData.PAYMENTDATE;

        //    loanPeriodic_List.Add(loanPeriodicCalculationNew);

        //    int numberOfPaymentsCount = 0;

        //    numberOfPayments = numberOfPayments - 1;

        //    while (initialCounter != finalCounter)
        //    {

        //        if (exitLoopCounter == 1)
        //        {
        //            break;
        //        }

        //        counter = counter + 1;

        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        nextPaymentDate = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, nextPaymentDate);

        //        //if (loanPeriodic.ENDPRINCIPALAMOUNT >= (decimal)annuity)
        //        if (numberOfPaymentsCount != numberOfPayments)
        //        {

        //            numberOfPaymentsCount = numberOfPaymentsCount + 1;

        //            loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //            loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;

        //            if (nextPrincipalPeriodicDate != nextPaymentDate)
        //            {

        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //            }
        //            else
        //            {

        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round((decimal)nextOpeningBalance + (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round((((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((decimal)nextOpeningBalance, 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = 0;
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                exitLoopCounter = 1;

        //            }

        //            loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //            loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //            loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //            loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //            loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //            loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //            loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;

        //        }
        //        else
        //        {

        //            if (nextPrincipalPeriodicDate != nextPaymentDate)
        //            {

        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = 0;
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.STARTPRINCIPALAMOUNT - loanPeriodic.PERIODPRINCIPALAMOUNT, 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //            }
        //            else
        //            {

        //                //loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(firstPeriodicScheduleData.PERIODPAYMENTAMOUNT, 2);
        //                //loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                //loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                //loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - (firstPeriodicScheduleData.PERIODPAYMENTAMOUNT - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                //loanPeriodic.INTERESTRATE = interestRate;
        //                //loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                //nextPrincipalPeriodicDate = loanCovenant.GetFrequencyDate(principalRepaymentFrequency, loanPeriodic.PAYMENTDATE);

        //                loanPeriodic.LOANID = nextPeriodicRepaymentData.LOANID;
        //                loanPeriodic.PAYMENTNUMBER = loanPeriodic.PAYMENTNUMBER + 1;
        //                loanPeriodic.STARTPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPAYMENTAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODINTERESTAMOUNT = Math.Round(((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT, 2);
        //                loanPeriodic.PERIODPRINCIPALAMOUNT = Math.Round((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT), 2);
        //                loanPeriodic.ENDPRINCIPALAMOUNT = Math.Round(loanPeriodic.ENDPRINCIPALAMOUNT - ((loanPeriodic.ENDPRINCIPALAMOUNT + ((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT) - (((decimal)interestRate / 100) / numberOfPaymentsInAYear * loanPeriodic.ENDPRINCIPALAMOUNT)), 2);
        //                loanPeriodic.INTERESTRATE = interestRate;
        //                loanPeriodic.PAYMENTDATE = loanCovenant.GetFrequencyDate(interestRepaymentFrequency, loanPeriodic.PAYMENTDATE);//nextPeriodicRepaymentData.PAYMENTDATE;

        //                exitLoopCounter = 1;

        //                finalCounter = initialCounter;
        //            }


        //            loanPeriodicCalculation.loanId = loanPeriodic.LOANID;
        //            loanPeriodicCalculation.paymentNumber = loanPeriodic.PAYMENTNUMBER;
        //            loanPeriodicCalculation.startPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.periodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //            loanPeriodicCalculation.periodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //            loanPeriodicCalculation.periodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.endPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.interestRate = loanPeriodic.INTERESTRATE;
        //            loanPeriodicCalculation.paymentDate = loanPeriodic.PAYMENTDATE;


        //            loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)loanPeriodic.STARTPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)loanPeriodic.PERIODPAYMENTAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)loanPeriodic.PERIODINTERESTAMOUNT;
        //            loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)loanPeriodic.PERIODPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)loanPeriodic.ENDPRINCIPALAMOUNT;
        //            loanPeriodicCalculation.effectiveInterestRate = loanPeriodic.INTERESTRATE;


        //        }


        //        if (loanPeriodic.ENDPRINCIPALAMOUNT == 0)
        //        {
        //            finalCounter = initialCounter;
        //        }


        //        loanPeriodic_List.Add(loanPeriodicCalculation);



        //    }

        //    var loanPeriodic_List_New = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loanID && c.PAYMENTDATE < effectiveDate).ToList();

        //    foreach (TBL_LOAN_SCHEDULE_PERIODIC _tblPeriodicSchedule in loanPeriodic_List_New)
        //    {
        //        LoanPaymentSchedulePeriodicViewModel loanPeriodicCalculation = new LoanPaymentSchedulePeriodicViewModel();

        //        loanPeriodicCalculation.loanId = _tblPeriodicSchedule.LOANID;
        //        loanPeriodicCalculation.paymentNumber = _tblPeriodicSchedule.PAYMENTNUMBER;
        //        loanPeriodicCalculation.startPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.periodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.periodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.periodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.endPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.interestRate = _tblPeriodicSchedule.INTERESTRATE;
        //        loanPeriodicCalculation.paymentDate = _tblPeriodicSchedule.PAYMENTDATE;

        //        loanPeriodicCalculation.amortisedStartPrincipalAmount = (double)_tblPeriodicSchedule.STARTPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPaymentAmount = (double)_tblPeriodicSchedule.PERIODPAYMENTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodInterestAmount = (double)_tblPeriodicSchedule.PERIODINTERESTAMOUNT;
        //        loanPeriodicCalculation.amortisedPeriodPrincipalAmount = (double)_tblPeriodicSchedule.PERIODPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.amortisedEndPrincipalAmount = (double)_tblPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //        loanPeriodicCalculation.effectiveInterestRate = _tblPeriodicSchedule.INTERESTRATE;

        //        loanPeriodic_List.Add(loanPeriodicCalculation);

        //    }

        //    return loanPeriodic_List.OrderBy(c => c.paymentDate).ToList();
        //}

        //public double PMT(double yearlyInterestRate, int numberOfPayments, double loanAmount, int interestFrequencyId, int dayCountConventionID)
        //{

        //    //int daysInAYear = GetDaysInAYear((DayCountConventionEnum)dayCountConventionID);

        //    int numberOfPaymentsInAYear = 0;

        //    if (interestFrequencyId == 8)
        //    {
        //        numberOfPaymentsInAYear = GetDaysInAYear((DayCountConventionEnum)dayCountConventionID);
        //    }
        //    else
        //    {
        //        numberOfPaymentsInAYear = (int)context.TBL_FREQUENCY_TYPE.FirstOrDefault(x => x.FREQUENCYTYPEID == interestFrequencyId).VALUE;
        //    }

        //    var rate = (double)yearlyInterestRate / 100 / numberOfPaymentsInAYear;
        //    var denominator = Math.Pow((1 + rate), numberOfPayments) - 1;
        //    return (rate + (rate / denominator)) * loanAmount;
        //}

    }
}
