using FintrakBanking.Common;
using FintrakBanking.Common.Enum;
using FintrakBanking.Entities.Models;
using FintrakBanking.Entities.StagingModels;
using FintrakBanking.Interfaces.Admin;
using FintrakBanking.Interfaces.CASA;
using FintrakBanking.Interfaces.Credit;
using FintrakBanking.Interfaces.Finance;
using FintrakBanking.Interfaces.Setups.Approval;
using FintrakBanking.Interfaces.Setups.General;
using FintrakBanking.Interfaces.Validation;
using FintrakBanking.Interfaces.WorkFlow;
using System.Runtime.InteropServices;
using FintrakBanking.ViewModels.CASA;
using FintrakBanking.ViewModels.Credit;
using FintrakBanking.ViewModels.Finance;
using FintrakBanking.ViewModels.ThridPartyIntegration;
using FintrakBanking.ViewModels.WorkFlow;
using System;
using System.Collections.Generic;
using System.Data.Entity;
using System.Data.Entity.Core.Objects;
using System.Data.Entity.Validation;
using System.Linq;
using System.ServiceModel;
using FintrakBanking.Common.CustomException;
using FinTrakBanking.ThirdPartyIntegration.Finacle.CWGAPI;
using static FinTrakBanking.ThirdPartyIntegration.TwoFactorAuthIntegration.TwoFactorAuthIntegrationService;
using FintrakBanking.Entities.DocumentModels;
using System.Net;
using System.Configuration;
using FintrakBanking.ViewModels.Setups.General;
using FintrakBanking.Common.AlertMonitoring;
using FintrakBanking.Interfaces.Customer;
using FintrakBanking.Repositories.WorkFlow;
using System.Diagnostics;
using System.Transactions;
using FintrakBanking.ViewModels;
using System.Globalization;

namespace FintrakBanking.Repositories.Credit

{
    //[DebuggerDisplay("{Title,nq}")]
    public class LoanOperationsRepository : ILoanOperationsRepository
    {
        private FinTrakBankingContext context;
        private IGeneralSetupRepository generalSetup;
        private IFinanceTransactionRepository financeTransaction;
        private IAuditTrailRepository auditTrail;
        private ILoanScheduleRepository loanSchedule;
        private IWorkflow workFlow;
        private IApprovalLevelStaffRepository level;
        private ICasaLienRepository casaLien;
        private ILoanRepository loanGenerate;
        private IOverDraftValidation validate;
        private FinTrakBankingStagingContext stagingContext;
        private IIntegrationWithFinacle finacle;
        bool USE_THIRD_PARTY_INTEGRATION = false;
        private ITwoFactorAuthIntegrationService twoFactoeAuth;
        private IAdminRepository admin;
        private IAccreditedConsultantsRepository consultant;
        // private ILoanApplicationRepository application;
        private FinTrakBankingDocumentsContext documentContext;
        private string _transactionReferenceNo = "";
        private ILoanCovenantRepository loanCovenant;
        TBL_INTEGRATION_CONTROL globalIntegrationSetting = new TBL_INTEGRATION_CONTROL();

        List<string> receiverEmailList = new List<string>();
        AlertsViewModel alert = new AlertsViewModel();

        public LoanOperationsRepository(
        FinTrakBankingContext _context, IGeneralSetupRepository _genSetup, IFinanceTransactionRepository _financeTransaction, IAuditTrailRepository _auditTrail,
            ILoanScheduleRepository _loanSchedule, IWorkflow _workFlow, IApprovalLevelStaffRepository _level, ICasaLienRepository _casaLien
            , ILoanRepository _loan, IOverDraftValidation validate, IIntegrationWithFinacle _finacle, FinTrakBankingStagingContext _stagingContext,
             ITwoFactorAuthIntegrationService _twoFactoeAuth, IAdminRepository _admin, IAccreditedConsultantsRepository _consultant,
             //ILoanApplicationRepository _application 
             FinTrakBankingDocumentsContext _documentContext, ILoanCovenantRepository _loanCovenant

            )
        {

            this.context = _context;
            this.generalSetup = _genSetup;
            this.financeTransaction = _financeTransaction;
            this.auditTrail = _auditTrail;
            this.loanSchedule = _loanSchedule;
            this.workFlow = _workFlow;
            this.level = _level;
            this.casaLien = _casaLien;
            this.loanGenerate = _loan;
            this.finacle = _finacle;
            this.stagingContext = _stagingContext;
            this.twoFactoeAuth = _twoFactoeAuth;
            this.admin = _admin;
            this.consultant = _consultant;
            //this.application = _application;
            this.documentContext = _documentContext;
            this.loanCovenant = _loanCovenant;

            var globalSetting = context.TBL_SETUP_GLOBAL.FirstOrDefault();
            globalIntegrationSetting = context.TBL_INTEGRATION_CONTROL.FirstOrDefault();

            USE_THIRD_PARTY_INTEGRATION = globalSetting.USE_THIRD_PARTY_INTEGRATION;
        }

        public string GetTransactionReferenceNo() { return _transactionReferenceNo; }

        public decimal GetCollateralSearchChargeAmount(int stateId)
        {
            var collateralSearchChargeAmount = this.context.TBL_STATE.FirstOrDefault(x => x.STATEID == stateId).COLLATERALSEARCHCHARGEAMOUNT;

            return collateralSearchChargeAmount;
        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool AddCollateralSearchLien(CasaLienViewModel model)
        {

            //var data = new TBL_CASA_LIEN
            //{
            //    //PRODUCTACCOUNTNUMBER = model.productAccountNumber,
            //    //LIENREFERENCENUMBER = CommonHelpers.GenerateRandomDigitCode(10),
            //    //SOURCEREFERENCENUMBER = model.sourceReferenceNumber,
            //    //BRANCHID = model.userBranchId,
            //    //COMPANYID = model.companyId,
            //    //LIENCREDITAMOUNT = GetCollateralSearchChargeAmount(model.stateId),
            //    //LIENDEBITAMOUNT = 0,
            //   // LIENTYPEID = (short)LienTypeEnum.CollateralSearch,
            //    //CREATEDBY = model.createdBy,
            //    //DESCRIPTION = "lien placed due to loan application collateral search", // model.description,
            //   // DATECREATED = generalSetup.GetApplicationDate()
            //};           

            model.lienAmount = GetCollateralSearchChargeAmount(model.stateId);
            model.branchId = model.userBranchId;
            model.lienTypeId = (short)LienTypeEnum.CollateralSearch;
            model.description = "lien placed due to loan application collateral search";
            model.dateTimeCreated = generalSetup.GetApplicationDate();

            var lienReference = casaLien.PlaceLien(model);

            return true;

        }

        #region Daily Operation

        [OperationBehavior(TransactionScopeRequired = true)]
        public List<DailyInterestAccrualViewModel> ProcessDailyTermLoansInterestAccrual(DateTime applicationDate, int companyId, int staffId, FinTrakBankingContext context)
        {
            try
            {
                bool result = false;
                //var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

                var currencyRates = (from b in context.TBL_LOAN
                                     where b.LOANSTATUSID == (short)LoanStatusEnum.Active && DbFunctions.TruncateTime(applicationDate) <= b.MATURITYDATE
                                     && b.COMPANYID == companyId
                                     select new CurrencyExchangeRateViewModel()
                                     {
                                         currencyId = b.CURRENCYID,
                                         companyId = b.COMPANYID,
                                     }).Distinct().ToList().Select(x =>
                                     {
                                         x.sellingRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, (int)x.companyId).sellingRate;
                                         return x;
                                     }).ToList();

                //.Select(x => new { x.currencyId, x.sellingRate}).Distinct().ToList();



                var scheduledLoan = (//from a in context.TBL_LOAN_SCHEDULE_DAILY
                                     from b in context.TBL_LOAN // on a.LOANID equals b.TERMLOANID
                                                                //join c in context.TBL_LOAN_SCHEDULE_PERIODIC on b.TERMLOANID equals c.LOANID
                                                                //join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
                                     join e in context.TBL_PRODUCT on b.PRODUCTID equals e.PRODUCTID
                                     join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
                                     where b.LOANSTATUSID == (short)LoanStatusEnum.Active && DbFunctions.TruncateTime(applicationDate) <= b.MATURITYDATE
                                     && b.COMPANYID == companyId
                                     //a.DATE == DbFunctions.TruncateTime(applicationDate) &&
                                     //&& a.PAYMENTDATE == c.PAYMENTDATE
                                     //&& a.DATE == applicationDate                                     
                                     //(f.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID != (short)LoanProductTypeEnum.ForeignXRevolving)

                                     select new DailyInterestAccrualViewModel()
                                     {
                                         referenceNumber = b.LOANREFERENCENUMBER,
                                         productId = b.PRODUCTID,
                                         branchId = b.BRANCHID,
                                         companyId = b.COMPANYID,
                                         currencyId = b.CURRENCYID,
                                         //exchangeRate = b.EXCHANGERATE,
                                         interestRate = b.INTERESTRATE, //a.INTERESTRATE
                                         date = applicationDate,
                                         //dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT,
                                         availableBalance = b.OUTSTANDINGPRINCIPAL,
                                         mainAmount = b.OUTSTANDINGPRINCIPAL, //c.PERIODINTERESTAMOUNT
                                                                              //mainAmount = a.STARTPRINCIPALAMOUNT,
                                         categoryId = (short)DailyAccrualCategory.TermLoan,
                                         transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                                         baseReferenceNumber = null,
                                         dayCountConventionId = b.SCHEDULEDAYCOUNTCONVENTIONID,

                                     }).ToList().Select(x =>
                                     {
                                         ///x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
                                         x.exchangeRate = currencyRates.Where(m => m.currencyId == x.currencyId).Select(m => m.sellingRate).FirstOrDefault();
                                         x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId)));
                                         return x;
                                     }).Where(x => x.dailyAccuralAmount > 0);

                ////var scheduledLoan = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                ////                     join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                ////                     //join c in context.TBL_LOAN_SCHEDULE_PERIODIC on b.TERMLOANID equals c.LOANID
                ////                     //join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
                ////                     join e in context.TBL_PRODUCT on b.PRODUCTID equals e.PRODUCTID
                ////                     join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
                ////                     where b.LOANSTATUSID == (short)LoanStatusEnum.Active && DbFunctions.TruncateTime(applicationDate) <= b.MATURITYDATE
                ////                     //a.DATE == DbFunctions.TruncateTime(applicationDate) &&
                ////                     //&& a.PAYMENTDATE == c.PAYMENTDATE
                ////                     && a.DATE == applicationDate
                ////                     //&&
                ////                     //(f.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID != (short)LoanProductTypeEnum.ForeignXRevolving)

                ////                     select new DailyInterestAccrualViewModel()
                ////                     {
                ////                         referenceNumber = b.LOANREFERENCENUMBER,
                ////                         productId = b.PRODUCTID,
                ////                         branchId = b.BRANCHID,
                ////                         companyId = b.COMPANYID,
                ////                         currencyId = b.CURRENCYID,
                ////                         //exchangeRate = b.EXCHANGERATE,
                ////                         interestRate = b.INTERESTRATE, //a.INTERESTRATE
                ////                         date = applicationDate,
                ////                         dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT,
                ////                         //availableBalance = b.OUTSTANDINGPRINCIPAL,
                ////                         //mainAmount = b.OUTSTANDINGPRINCIPAL, //c.PERIODINTERESTAMOUNT
                ////                         mainAmount = a.STARTPRINCIPALAMOUNT,
                ////                         categoryId = (short)DailyAccrualCategory.TermLoan,
                ////                         transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                ////                         baseReferenceNumber = null,
                ////                         dayCountConventionId = b.SCHEDULEDAYCOUNTCONVENTIONID,

                ////                     }).ToList().Select(x =>
                ////                     {
                ////                         x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
                ////                         //x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId)));
                ////                         return x;
                ////                     });


                //var unscheduledLoan = (from a in context.TBL_LOAN
                //                       join e in context.TBL_PRODUCT on a.PRODUCTID equals e.PRODUCTID
                //                       join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
                //                       //let daysInYear = (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)a.SCHEDULEDAYCOUNTCONVENTIONID)
                //                       where a.LOANSTATUSID == (short)LoanStatusEnum.Active &&
                //                        (f.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving)
                //                       && DbFunctions.TruncateTime(applicationDate) <= a.MATURITYDATE


                //                       select new DailyInterestAccrualViewModel()
                //                       {
                //                           referenceNumber = a.LOANREFERENCENUMBER, //a.SCHEDULEDAYCOUNTCONVENTIONID
                //                           productId = a.PRODUCTID,
                //                           branchId = a.BRANCHID,
                //                           companyId = a.COMPANYID,
                //                           currencyId = a.CURRENCYID,
                //                           //exchangeRate = a.EXCHANGERATE,
                //                           interestRate = a.INTERESTRATE,
                //                           date = applicationDate,
                //                           // dailyAccuralAmount = ((a.INTERESTRATE / 100) * (double)a.OUTSTANDINGPRINCIPAL * 1 / daysInYear,   //loanGenerate.getDaysInLoanPeriod(a.EFFECTIVEDATE, a.MATURITYDATE)),//((a.INTERESTRATE / 100) * (double)a.PRINCIPALAMOUNT * 1 / 365),
                //                           mainAmount = a.OUTSTANDINGPRINCIPAL,
                //                           categoryId = (short)DailyAccrualCategory.TermLoan,/// change to commercial paper 
                //                           availableBalance = a.OUTSTANDINGPRINCIPAL,
                //                           transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                //                           baseReferenceNumber = null,
                //                           dayCountConventionId = a.SCHEDULEDAYCOUNTCONVENTIONID,

                //                       }).ToList().Select(x =>
                //                       {
                //                           x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
                //                           x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * 1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId));
                //                           return x;
                //                       });

                //                       }).ToList().Select(x =>
                //                       {
                //                           x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
                //                           x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * 1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId));
                //                           return x;
                //                       });

                //var allLoans = scheduledLoan.Union(unscheduledLoan).ToList();

                //var allLoans = scheduledLoan.Union(unscheduledLoan).ToList();

                var allLoans = scheduledLoan.ToList();

                List<TBL_DAILY_ACCRUAL> allAccrual = new List<TBL_DAILY_ACCRUAL>();

                int count = 0;

                var check_Data = (from a in context.TBL_DAILY_ACCRUAL
                                  join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
                                  join c in context.TBL_BRANCH on a.BRANCHID equals c.BRANCHID
                                  join d in context.TBL_CURRENCY on a.CURRENCYID equals d.CURRENCYID
                                  where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan && a.COMPANYID == companyId
                                  select new DailyInterestAccrualViewModel()
                                  {
                                      productId = a.PRODUCTID,

                                  }).ToList();

                if (check_Data.Count() == 0)
                {
                    foreach (var item in allLoans)
                    {
                        _transactionReferenceNo = item.referenceNumber;

                        //if (count == 2)
                        //{
                        //    int a = 5; int b = 0;
                        //    var value = a / b;
                        //}

                        count = count + 1;

                        TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                        dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                        dailyAccrual.PRODUCTID = item.productId;
                        dailyAccrual.BRANCHID = item.branchId;
                        dailyAccrual.EXCHANGERATE = item.exchangeRate;
                        dailyAccrual.CURRENCYID = item.currencyId;
                        dailyAccrual.INTERESTRATE = item.interestRate;
                        dailyAccrual.DATE = item.date;
                        dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs(item.dailyAccuralAmount);
                        dailyAccrual.MAINAMOUNT = item.mainAmount;
                        dailyAccrual.CATEGORYID = item.categoryId;
                        dailyAccrual.COMPANYID = item.companyId;
                        dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
                        dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
                        dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;


                        allAccrual.Add(dailyAccrual);

                    }
                    context.TBL_DAILY_ACCRUAL.AddRange(allAccrual);
                    context.SaveChanges();
                }


                var model = (from a in context.TBL_DAILY_ACCRUAL
                             join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
                             join c in context.TBL_BRANCH on a.BRANCHID equals c.BRANCHID
                             join d in context.TBL_CURRENCY on a.CURRENCYID equals d.CURRENCYID
                             where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan && a.COMPANYID == companyId
                             group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, b.PRODUCTCODE, c.BRANCHCODE, d.CURRENCYCODE, a.CATEGORYID, a.EXCHANGERATE, a.REFERENCENUMBER } into groupedQ
                             select new DailyInterestAccrualViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 categoryId = groupedQ.Key.CATEGORYID,
                                 productCode = groupedQ.Key.PRODUCTCODE,
                                 currencyCode = groupedQ.Key.CURRENCYCODE,
                                 branchCode = groupedQ.Key.BRANCHCODE,
                                 exchangeRate = groupedQ.Key.EXCHANGERATE,
                                 referenceNumber = groupedQ.Key.REFERENCENUMBER,

                                 dailyAccuralAmount = (double)groupedQ.Sum(i => (double)i.DAILYACCURALAMOUNT * i.EXCHANGERATE),

                             }).ToList();
                //.Select(x =>
                //{
                //    x.referenceNumber = x.productCode + '/' + x.currencyCode + '/' + x.branchCode + '/' + x.companyId.ToString() + '/' + x.categoryId.ToString();
                //    return x;
                //}).ToList();

                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                if (setup.USE_THIRD_PARTY_INTEGRATION && globalIntegrationSetting.USE_THIRPARTY_POSTING)
                {
                    using (var stagingContext = new FinTrakBankingStagingContext())
                    {
                        BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                        result = bulkPosting.WriteBulkDailyTermLoanInterestAccuralToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate, out _transactionReferenceNo, companyId, staffId);

                    }
                }
                else
                {
                    foreach (var item in model)
                    {
                        item.date = applicationDate;

                        result = financeTransaction.PostDailyLoansInterestAccrual(item);
                    }
                }

                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;

            }

        }

        //[OperationBehavior(TransactionScopeRequired = true)]
        // public IEnumerable<DailyInterestAccrualViewModel> ProcessDailyTermLoansInterestAccrual(DateTime applicationDate, int companyId, int staffId)
        //{

        //    try
        //    {
        //        bool result = false;
        //        //var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

        //        var currencyRates = (from b in context.TBL_LOAN
        //                             where b.LOANSTATUSID == (short)LoanStatusEnum.Active && DbFunctions.TruncateTime(applicationDate) <= b.MATURITYDATE
        //                             && b.COMPANYID == companyId
        //                             select new CurrencyExchangeRateViewModel()
        //                             {
        //                                 currencyId = b.CURRENCYID,
        //                                 companyId = b.COMPANYID,
        //                             }).Distinct().ToList().Select(x =>
        //                             {
        //                                 x.sellingRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, (int)x.companyId).sellingRate;
        //                                 return x;
        //                             }).ToList();

        //        //.Select(x => new { x.currencyId, x.sellingRate}).Distinct().ToList();



        //        var scheduledLoan = (//from a in context.TBL_LOAN_SCHEDULE_DAILY
        //                             from b in context.TBL_LOAN // on a.LOANID equals b.TERMLOANID
        //                                                        //join c in context.TBL_LOAN_SCHEDULE_PERIODIC on b.TERMLOANID equals c.LOANID
        //                                                        //join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
        //                             join e in context.TBL_PRODUCT on b.PRODUCTID equals e.PRODUCTID
        //                             join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
        //                             where b.LOANSTATUSID == (short)LoanStatusEnum.Active && DbFunctions.TruncateTime(applicationDate) <= b.MATURITYDATE
        //                             && b.COMPANYID == companyId
        //                             //a.DATE == DbFunctions.TruncateTime(applicationDate) &&
        //                             //&& a.PAYMENTDATE == c.PAYMENTDATE
        //                             //&& a.DATE == applicationDate                                     
        //                             //(f.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID != (short)LoanProductTypeEnum.ForeignXRevolving)

        //                             select new DailyInterestAccrualViewModel()
        //                             {
        //                                 referenceNumber = b.LOANREFERENCENUMBER,
        //                                 productId = b.PRODUCTID,
        //                                 branchId = b.BRANCHID,
        //                                 companyId = b.COMPANYID,
        //                                 currencyId = b.CURRENCYID,
        //                                 //exchangeRate = b.EXCHANGERATE,
        //                                 interestRate = b.INTERESTRATE, //a.INTERESTRATE
        //                                 date = applicationDate,
        //                                 //dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT,
        //                                 availableBalance = b.OUTSTANDINGPRINCIPAL,
        //                                 mainAmount = b.OUTSTANDINGPRINCIPAL, //c.PERIODINTERESTAMOUNT
        //                                 //mainAmount = a.STARTPRINCIPALAMOUNT,
        //                                 categoryId = (short)DailyAccrualCategory.TermLoan,
        //                                 transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
        //                                 baseReferenceNumber = null,
        //                                 dayCountConventionId = b.SCHEDULEDAYCOUNTCONVENTIONID,

        //                             }).ToList().Select(x =>
        //                             {
        //                                 ///x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
        //                                 x.exchangeRate = currencyRates.Where(m => m.currencyId == x.currencyId).Select(m => m.sellingRate).FirstOrDefault();
        //                                 x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId)));
        //                                 return x;
        //                             }).Where(x => x.dailyAccuralAmount > 0);

        //        ////var scheduledLoan = (from a in context.TBL_LOAN_SCHEDULE_DAILY
        //        ////                     join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
        //        ////                     //join c in context.TBL_LOAN_SCHEDULE_PERIODIC on b.TERMLOANID equals c.LOANID
        //        ////                     //join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
        //        ////                     join e in context.TBL_PRODUCT on b.PRODUCTID equals e.PRODUCTID
        //        ////                     join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
        //        ////                     where b.LOANSTATUSID == (short)LoanStatusEnum.Active && DbFunctions.TruncateTime(applicationDate) <= b.MATURITYDATE
        //        ////                     //a.DATE == DbFunctions.TruncateTime(applicationDate) &&
        //        ////                     //&& a.PAYMENTDATE == c.PAYMENTDATE
        //        ////                     && a.DATE == applicationDate
        //        ////                     //&&
        //        ////                     //(f.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID != (short)LoanProductTypeEnum.ForeignXRevolving)

        //        ////                     select new DailyInterestAccrualViewModel()
        //        ////                     {
        //        ////                         referenceNumber = b.LOANREFERENCENUMBER,
        //        ////                         productId = b.PRODUCTID,
        //        ////                         branchId = b.BRANCHID,
        //        ////                         companyId = b.COMPANYID,
        //        ////                         currencyId = b.CURRENCYID,
        //        ////                         //exchangeRate = b.EXCHANGERATE,
        //        ////                         interestRate = b.INTERESTRATE, //a.INTERESTRATE
        //        ////                         date = applicationDate,
        //        ////                         dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT,
        //        ////                         //availableBalance = b.OUTSTANDINGPRINCIPAL,
        //        ////                         //mainAmount = b.OUTSTANDINGPRINCIPAL, //c.PERIODINTERESTAMOUNT
        //        ////                         mainAmount = a.STARTPRINCIPALAMOUNT,
        //        ////                         categoryId = (short)DailyAccrualCategory.TermLoan,
        //        ////                         transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
        //        ////                         baseReferenceNumber = null,
        //        ////                         dayCountConventionId = b.SCHEDULEDAYCOUNTCONVENTIONID,

        //        ////                     }).ToList().Select(x =>
        //        ////                     {
        //        ////                         x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
        //        ////                         //x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId)));
        //        ////                         return x;
        //        ////                     });


        //        //var unscheduledLoan = (from a in context.TBL_LOAN
        //        //                       join e in context.TBL_PRODUCT on a.PRODUCTID equals e.PRODUCTID
        //        //                       join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
        //        //                       //let daysInYear = (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)a.SCHEDULEDAYCOUNTCONVENTIONID)
        //        //                       where a.LOANSTATUSID == (short)LoanStatusEnum.Active &&
        //        //                        (f.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving)
        //        //                       && DbFunctions.TruncateTime(applicationDate) <= a.MATURITYDATE


        //        //                       select new DailyInterestAccrualViewModel()
        //        //                       {
        //        //                           referenceNumber = a.LOANREFERENCENUMBER, //a.SCHEDULEDAYCOUNTCONVENTIONID
        //        //                           productId = a.PRODUCTID,
        //        //                           branchId = a.BRANCHID,
        //        //                           companyId = a.COMPANYID,
        //        //                           currencyId = a.CURRENCYID,
        //        //                           //exchangeRate = a.EXCHANGERATE,
        //        //                           interestRate = a.INTERESTRATE,
        //        //                           date = applicationDate,
        //        //                           // dailyAccuralAmount = ((a.INTERESTRATE / 100) * (double)a.OUTSTANDINGPRINCIPAL * 1 / daysInYear,   //loanGenerate.getDaysInLoanPeriod(a.EFFECTIVEDATE, a.MATURITYDATE)),//((a.INTERESTRATE / 100) * (double)a.PRINCIPALAMOUNT * 1 / 365),
        //        //                           mainAmount = a.OUTSTANDINGPRINCIPAL,
        //        //                           categoryId = (short)DailyAccrualCategory.TermLoan,/// change to commercial paper 
        //        //                           availableBalance = a.OUTSTANDINGPRINCIPAL,
        //        //                           transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
        //        //                           baseReferenceNumber = null,
        //        //                           dayCountConventionId = a.SCHEDULEDAYCOUNTCONVENTIONID,

        //        //                       }).ToList().Select(x =>
        //        //                       {
        //        //                           x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
        //        //                           x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * 1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId));
        //        //                           return x;
        //        //                       });

        //        //                       }).ToList().Select(x =>
        //        //                       {
        //        //                           x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
        //        //                           x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * 1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId));
        //        //                           return x;
        //        //                       });

        //        //var allLoans = scheduledLoan.Union(unscheduledLoan).ToList();

        //        //var allLoans = scheduledLoan.Union(unscheduledLoan).ToList();

        //        var allLoans = scheduledLoan.ToList();

        //        List<TBL_DAILY_ACCRUAL> allAccrual = new List<TBL_DAILY_ACCRUAL>();

        //        int count = 0;

        //        var check_Data = (from a in context.TBL_DAILY_ACCRUAL
        //                          join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
        //                          join c in context.TBL_BRANCH on a.BRANCHID equals c.BRANCHID
        //                          join d in context.TBL_CURRENCY on a.CURRENCYID equals d.CURRENCYID
        //                          where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan && a.COMPANYID == companyId
        //                          select new DailyInterestAccrualViewModel()
        //                          {
        //                              productId = a.PRODUCTID,

        //                          }).ToList();

        //        if (check_Data.Count() == 0)
        //        {
        //            foreach (var item in allLoans)
        //            {
        //                _transactionReferenceNo = item.referenceNumber;

        //                //if (count == 2)
        //                //{
        //                //    int a = 5; int b = 0;
        //                //    var value = a / b;
        //                //}

        //                count = count + 1;

        //                TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

        //                dailyAccrual.REFERENCENUMBER = item.referenceNumber;
        //                dailyAccrual.PRODUCTID = item.productId;
        //                dailyAccrual.BRANCHID = item.branchId;
        //                dailyAccrual.EXCHANGERATE = item.exchangeRate;
        //                dailyAccrual.CURRENCYID = item.currencyId;
        //                dailyAccrual.INTERESTRATE = item.interestRate;
        //                dailyAccrual.DATE = item.date;
        //                dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs(item.dailyAccuralAmount);
        //                dailyAccrual.MAINAMOUNT = item.mainAmount;
        //                dailyAccrual.CATEGORYID = item.categoryId;
        //                dailyAccrual.COMPANYID = item.companyId;
        //                dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
        //                dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
        //                dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;


        //                allAccrual.Add(dailyAccrual);

        //            }
        //            this.context.TBL_DAILY_ACCRUAL.AddRange(allAccrual);
        //            context.SaveChanges();
        //        }


        //        var model = (from a in context.TBL_DAILY_ACCRUAL
        //                     join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
        //                     join c in context.TBL_BRANCH on a.BRANCHID equals c.BRANCHID
        //                     join d in context.TBL_CURRENCY on a.CURRENCYID equals d.CURRENCYID
        //                     where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan && a.COMPANYID == companyId
        //                     group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, b.PRODUCTCODE, c.BRANCHCODE, d.CURRENCYCODE, a.CATEGORYID, a.EXCHANGERATE, a.REFERENCENUMBER, } into groupedQ
        //                     select new DailyInterestAccrualViewModel()
        //                     {
        //                         productId = groupedQ.Key.PRODUCTID,
        //                         branchId = groupedQ.Key.BRANCHID,
        //                         companyId = groupedQ.Key.COMPANYID,
        //                         currencyId = groupedQ.Key.CURRENCYID,
        //                         categoryId = groupedQ.Key.CATEGORYID,
        //                         productCode = groupedQ.Key.PRODUCTCODE,
        //                         currencyCode = groupedQ.Key.CURRENCYCODE,
        //                         branchCode = groupedQ.Key.BRANCHCODE,
        //                         exchangeRate = groupedQ.Key.EXCHANGERATE,
        //                         referenceNumber = groupedQ.Key.REFERENCENUMBER,
        //                         createdBy = staffId,
        //                         dailyAccuralAmount = (double)groupedQ.Sum(i => (double)i.DAILYACCURALAMOUNT * i.EXCHANGERATE),

        //                     }).ToList();
        //        //.Select(x =>
        //        //{
        //        //    x.referenceNumber = x.productCode + '/' + x.currencyCode + '/' + x.branchCode + '/' + x.companyId.ToString() + '/' + x.categoryId.ToString();
        //        //    return x;
        //        //}).ToList();

        //        var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
        //        if (setup.USE_THIRD_PARTY_INTEGRATION)
        //        {
        //            BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

        //            result = bulkPosting.WriteBulkDailyTermLoanInterestAccuralToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate, out _transactionReferenceNo, companyId, staffId);

        //        }
        //        else
        //        {
        //            foreach (var item in model)
        //            {
        //                item.date = applicationDate;

        //                result = financeTransaction.PostDailyLoansInterestAccrual(item);
        //            }
        //        }

        //        if (result)
        //        {
        //            return model;
        //        }
        //        return null;
        //    }
        //    catch (Exception ex)
        //    {

        //        throw ex;

        //    }

        //}

        //public IEnumerable<DailyInterestAccrualViewModel> ProcessDailyTermLoansInterestAccrualOld(DateTime applicationDate)
        //{
        //    try
        //    {
        //        bool result = false;
        //        //var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);


        //        var scheduledLoan = (from a in context.TBL_LOAN_SCHEDULE_DAILY
        //                             join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
        //                             //join c in context.TBL_LOAN_SCHEDULE_PERIODIC on b.TERMLOANID equals c.LOANID
        //                             //join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
        //                             join e in context.TBL_PRODUCT on b.PRODUCTID equals e.PRODUCTID
        //                             join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
        //                             where b.LOANSTATUSID == (short)LoanStatusEnum.Active && DbFunctions.TruncateTime(applicationDate) <= b.MATURITYDATE
        //                             //a.DATE == DbFunctions.TruncateTime(applicationDate) &&
        //                             //&& a.PAYMENTDATE == c.PAYMENTDATE
        //                             && a.DATE == applicationDate
        //                             //&&
        //                             //(f.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID != (short)LoanProductTypeEnum.ForeignXRevolving)

        //                             select new DailyInterestAccrualViewModel()
        //                             {
        //                                 referenceNumber = b.LOANREFERENCENUMBER,
        //                                 productId = b.PRODUCTID,
        //                                 branchId = b.BRANCHID,
        //                                 companyId = b.COMPANYID,
        //                                 currencyId = b.CURRENCYID,
        //                                 //exchangeRate = b.EXCHANGERATE,
        //                                 interestRate = b.INTERESTRATE, //a.INTERESTRATE
        //                                 date = applicationDate,
        //                                 //dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT,
        //                                 availableBalance = b.OUTSTANDINGPRINCIPAL,
        //                                 //mainAmount = b.OUTSTANDINGPRINCIPAL, //c.PERIODINTERESTAMOUNT
        //                                 mainAmount = a.STARTPRINCIPALAMOUNT,
        //                                 categoryId = (short)DailyAccrualCategory.TermLoan,
        //                                 transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
        //                                 baseReferenceNumber = null,
        //                                 dayCountConventionId = b.SCHEDULEDAYCOUNTCONVENTIONID,

        //                             }).ToList().Select(x =>
        //                             {
        //                                 x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
        //                                 x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId)));
        //                                 return x;
        //                             });

        //        ////var scheduledLoan = (from a in context.TBL_LOAN_SCHEDULE_DAILY
        //        ////                     join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
        //        ////                     //join c in context.TBL_LOAN_SCHEDULE_PERIODIC on b.TERMLOANID equals c.LOANID
        //        ////                     //join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
        //        ////                     join e in context.TBL_PRODUCT on b.PRODUCTID equals e.PRODUCTID
        //        ////                     join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
        //        ////                     where b.LOANSTATUSID == (short)LoanStatusEnum.Active && DbFunctions.TruncateTime(applicationDate) <= b.MATURITYDATE
        //        ////                     //a.DATE == DbFunctions.TruncateTime(applicationDate) &&
        //        ////                     //&& a.PAYMENTDATE == c.PAYMENTDATE
        //        ////                     && a.DATE == applicationDate
        //        ////                     //&&
        //        ////                     //(f.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID != (short)LoanProductTypeEnum.ForeignXRevolving)

        //        ////                     select new DailyInterestAccrualViewModel()
        //        ////                     {
        //        ////                         referenceNumber = b.LOANREFERENCENUMBER,
        //        ////                         productId = b.PRODUCTID,
        //        ////                         branchId = b.BRANCHID,
        //        ////                         companyId = b.COMPANYID,
        //        ////                         currencyId = b.CURRENCYID,
        //        ////                         //exchangeRate = b.EXCHANGERATE,
        //        ////                         interestRate = b.INTERESTRATE, //a.INTERESTRATE
        //        ////                         date = applicationDate,
        //        ////                         dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT,
        //        ////                         //availableBalance = b.OUTSTANDINGPRINCIPAL,
        //        ////                         //mainAmount = b.OUTSTANDINGPRINCIPAL, //c.PERIODINTERESTAMOUNT
        //        ////                         mainAmount = a.STARTPRINCIPALAMOUNT,
        //        ////                         categoryId = (short)DailyAccrualCategory.TermLoan,
        //        ////                         transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
        //        ////                         baseReferenceNumber = null,
        //        ////                         dayCountConventionId = b.SCHEDULEDAYCOUNTCONVENTIONID,

        //        ////                     }).ToList().Select(x =>
        //        ////                     {
        //        ////                         x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
        //        ////                         //x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId)));
        //        ////                         return x;
        //        ////                     });


        //        //var unscheduledLoan = (from a in context.TBL_LOAN
        //        //                       join e in context.TBL_PRODUCT on a.PRODUCTID equals e.PRODUCTID
        //        //                       join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
        //        //                       //let daysInYear = (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)a.SCHEDULEDAYCOUNTCONVENTIONID)
        //        //                       where a.LOANSTATUSID == (short)LoanStatusEnum.Active &&
        //        //                        (f.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving)
        //        //                       && DbFunctions.TruncateTime(applicationDate) <= a.MATURITYDATE


        //        //                       select new DailyInterestAccrualViewModel()
        //        //                       {
        //        //                           referenceNumber = a.LOANREFERENCENUMBER, //a.SCHEDULEDAYCOUNTCONVENTIONID
        //        //                           productId = a.PRODUCTID,
        //        //                           branchId = a.BRANCHID,
        //        //                           companyId = a.COMPANYID,
        //        //                           currencyId = a.CURRENCYID,
        //        //                           //exchangeRate = a.EXCHANGERATE,
        //        //                           interestRate = a.INTERESTRATE,
        //        //                           date = applicationDate,
        //        //                           // dailyAccuralAmount = ((a.INTERESTRATE / 100) * (double)a.OUTSTANDINGPRINCIPAL * 1 / daysInYear,   //loanGenerate.getDaysInLoanPeriod(a.EFFECTIVEDATE, a.MATURITYDATE)),//((a.INTERESTRATE / 100) * (double)a.PRINCIPALAMOUNT * 1 / 365),
        //        //                           mainAmount = a.OUTSTANDINGPRINCIPAL,
        //        //                           categoryId = (short)DailyAccrualCategory.TermLoan,/// change to commercial paper 
        //        //                           availableBalance = a.OUTSTANDINGPRINCIPAL,
        //        //                           transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
        //        //                           baseReferenceNumber = null,
        //        //                           dayCountConventionId = a.SCHEDULEDAYCOUNTCONVENTIONID,

        //        //                       }).ToList().Select(x =>
        //        //                       {
        //        //                           x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
        //        //                           x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * 1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId));
        //        //                           return x;
        //        //                       });

        //        //                       }).ToList().Select(x =>
        //        //                       {
        //        //                           x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
        //        //                           x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.availableBalance * 1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId));
        //        //                           return x;
        //        //                       });

        //        //var allLoans = scheduledLoan.Union(unscheduledLoan).ToList();

        //        //var allLoans = scheduledLoan.Union(unscheduledLoan).ToList();

        //        var allLoans = scheduledLoan.ToList().Where(x => x.dailyAccuralAmount > 0);

        //        List<TBL_DAILY_ACCRUAL> allAccrual = new List<TBL_DAILY_ACCRUAL>();


        //        foreach (var item in allLoans)
        //        {
        //            TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

        //            dailyAccrual.REFERENCENUMBER = item.referenceNumber;
        //            dailyAccrual.PRODUCTID = item.productId;
        //            dailyAccrual.BRANCHID = item.branchId;
        //            dailyAccrual.EXCHANGERATE = item.exchangeRate;
        //            dailyAccrual.CURRENCYID = item.currencyId;
        //            dailyAccrual.INTERESTRATE = item.interestRate;
        //            dailyAccrual.DATE = item.date;
        //            dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs(item.dailyAccuralAmount);
        //            dailyAccrual.MAINAMOUNT = item.mainAmount;
        //            dailyAccrual.CATEGORYID = item.categoryId;
        //            dailyAccrual.COMPANYID = item.companyId;
        //            dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
        //            dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
        //            dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;


        //            allAccrual.Add(dailyAccrual);

        //        }
        //        this.context.TBL_DAILY_ACCRUAL.AddRange(allAccrual);
        //        context.SaveChanges();


        //        var model = (from a in context.TBL_DAILY_ACCRUAL
        //                     join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
        //                     join c in context.TBL_BRANCH on a.BRANCHID equals c.BRANCHID
        //                     join d in context.TBL_CURRENCY on a.CURRENCYID equals d.CURRENCYID
        //                     where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan
        //                     group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, b.PRODUCTCODE, c.BRANCHCODE, d.CURRENCYCODE, a.CATEGORYID } into groupedQ
        //                     select new DailyInterestAccrualViewModel()
        //                     {
        //                         productId = groupedQ.Key.PRODUCTID,
        //                         branchId = groupedQ.Key.BRANCHID,
        //                         companyId = groupedQ.Key.COMPANYID,
        //                         currencyId = groupedQ.Key.CURRENCYID,
        //                         categoryId = groupedQ.Key.CATEGORYID,
        //                         productCode = groupedQ.Key.PRODUCTCODE,
        //                         currencyCode = groupedQ.Key.CURRENCYCODE,
        //                         branchCode = groupedQ.Key.BRANCHCODE,

        //                         dailyAccuralAmount = (double)groupedQ.Sum(i => (double)i.DAILYACCURALAMOUNT * i.EXCHANGERATE),

        //                     }).ToList().Select(x =>
        //                     {
        //                         x.referenceNumber = x.productCode + '/' + x.currencyCode + '/' + x.branchCode + '/' + x.companyId.ToString() + '/' + x.categoryId.ToString();
        //                         return x;
        //                     }).ToList();

        //        var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
        //        if (setup.USE_THIRD_PARTY_INTEGRATION)
        //        {
        //            BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

        //            result = bulkPosting.WriteBulkDailyTermLoanInterestAccuralToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate);

        //        }
        //        else
        //        {
        //            foreach (var item in model)
        //            {
        //                item.date = applicationDate;

        //                result = financeTransaction.PostDailyLoansInterestAccrual(item);
        //            }
        //        }

        //        if (result)
        //        {
        //            return model;
        //        }
        //        return null;
        //    }
        //    catch (Exception ex)
        //    {

        //        throw ex;

        //    }

        //}


        public bool EarnUnEarnedFee(int loanId, short loanSystemTypeId, DateTime applicationDate, int loanReviewOperationId)
        {

            try
            {
                bool result = false;

                decimal earnAmount = 0;

                var loanFee = context.TBL_LOAN_FEE.Where(x => x.LOANID == loanId && x.LOANSYSTEMTYPEID == loanSystemTypeId && x.LOANREVIEWOPERATIONID != loanReviewOperationId).FirstOrDefault();

                if (loanFee != null)
                {

                    earnAmount = loanFee.FEEAMOUNT - loanFee.EARNEDFEEAMOUNT;

                    DailyInterestAccrualViewModel viewModel = new DailyInterestAccrualViewModel();

                    if (earnAmount > 0)
                    {
                        loanFee.EARNEDFEEAMOUNT = loanFee.EARNEDFEEAMOUNT + earnAmount;
                    }

                    if (loanSystemTypeId == (int)LoanSystemTypeEnum.ContingentLiability)
                    {
                        var contingents = (from a in context.TBL_LOAN_FEE
                                           join b in context.TBL_LOAN_CONTINGENT on a.LOANID equals b.CONTINGENTLOANID
                                           where b.LOANSTATUSID == (short)LoanStatusEnum.Active
                                           && a.LOANID == loanId && a.LOANSYSTEMTYPEID == loanSystemTypeId && a.LOANREVIEWOPERATIONID != loanReviewOperationId
                                           && b.LOANSYSTEMTYPEID == a.LOANSYSTEMTYPEID && (a.FEEAMOUNT - a.EARNEDFEEAMOUNT) > 0  //&& a.FEEAMOUNT > 0
                                           select new DailyInterestAccrualViewModel()
                                           {
                                               referenceNumber = b.LOANREFERENCENUMBER,
                                               productId = b.PRODUCTID,
                                               branchId = b.BRANCHID,
                                               companyId = b.COMPANYID,
                                               currencyId = b.CURRENCYID,
                                               exchangeRate = b.EXCHANGERATE,
                                               interestRate = 1,
                                               date = applicationDate,
                                               effectiveDate = b.EFFECTIVEDATE,
                                               maturityDate = b.MATURITYDATE,
                                               mainAmount = earnAmount,
                                               categoryId = (short)DailyAccrualCategory.Fee,
                                               transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                               baseReferenceNumber = null,
                                               chargedFeeId = a.CHARGEFEEID,
                                               loanChargedFeeId = a.LOANCHARGEFEEID,

                                           }).FirstOrDefault();

                        viewModel = contingents;


                    }
                    else if (loanSystemTypeId == (int)LoanSystemTypeEnum.LineFacility)
                    {
                        var loanApplicationDetails = (from a in context.TBL_LOAN_FEE
                                                      join b in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANID equals b.LOANAPPLICATIONDETAILID
                                                      join c in context.TBL_LOAN_APPLICATION on b.LOANAPPLICATIONID equals c.LOANAPPLICATIONID
                                                      where a.LOANID == loanId && a.LOANSYSTEMTYPEID == loanSystemTypeId && a.LOANREVIEWOPERATIONID != loanReviewOperationId
                                                      && a.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility && (a.FEEAMOUNT - a.EARNEDFEEAMOUNT) > 0 //&& a.FEEAMOUNT > 0
                                                      select new DailyInterestAccrualViewModel()
                                                      {
                                                          referenceNumber = c.APPLICATIONREFERENCENUMBER + '-' + b.LOANAPPLICATIONDETAILID,
                                                          productId = b.PROPOSEDPRODUCTID,
                                                          branchId = c.BRANCHID,
                                                          companyId = c.COMPANYID,
                                                          currencyId = b.CURRENCYID,
                                                          exchangeRate = b.EXCHANGERATE,
                                                          effectiveDate = (DateTime)b.EFFECTIVEDATE,
                                                          maturityDate = (DateTime)b.EXPIRYDATE,
                                                          interestRate = 1,
                                                          date = applicationDate,
                                                          mainAmount = earnAmount,
                                                          categoryId = (short)DailyAccrualCategory.Fee,
                                                          transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                                          baseReferenceNumber = null,
                                                          //dayCountConventionId = 1,
                                                          chargedFeeId = a.CHARGEFEEID,
                                                          loanChargedFeeId = a.LOANCHARGEFEEID,

                                                      }).FirstOrDefault();

                        viewModel = loanApplicationDetails;

                    }
                    else if (loanSystemTypeId == (int)LoanSystemTypeEnum.OverdraftFacility)
                    {
                        var revolving = (from a in context.TBL_LOAN_FEE
                                         join b in context.TBL_LOAN_REVOLVING on a.LOANID equals b.REVOLVINGLOANID
                                         where b.LOANSTATUSID == (short)LoanStatusEnum.Active && a.LOANID == loanId && a.LOANSYSTEMTYPEID == loanSystemTypeId && a.LOANREVIEWOPERATIONID != loanReviewOperationId
                                         && b.LOANSYSTEMTYPEID == a.LOANSYSTEMTYPEID && (a.FEEAMOUNT - a.EARNEDFEEAMOUNT) > 0  //&& a.FEEAMOUNT > 0
                                         select new DailyInterestAccrualViewModel()
                                         {
                                             referenceNumber = b.LOANREFERENCENUMBER,
                                             productId = b.PRODUCTID,
                                             branchId = b.BRANCHID,
                                             companyId = b.COMPANYID,
                                             currencyId = b.CURRENCYID,
                                             exchangeRate = b.EXCHANGERATE,
                                             effectiveDate = b.EFFECTIVEDATE,
                                             maturityDate = b.MATURITYDATE,
                                             interestRate = 1,
                                             date = applicationDate,
                                             mainAmount = earnAmount,
                                             categoryId = (short)DailyAccrualCategory.Fee,
                                             transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                             baseReferenceNumber = null,
                                             //dayCountConventionId = 1,
                                             chargedFeeId = a.CHARGEFEEID,
                                             loanChargedFeeId = a.LOANCHARGEFEEID,

                                         }).FirstOrDefault();

                        viewModel = revolving;

                    }
                    else if (loanSystemTypeId == (int)LoanSystemTypeEnum.TermDisbursedFacility)
                    {

                        var termLoans = (from a in context.TBL_LOAN_FEE
                                         join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                                         join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
                                         where b.LOANSTATUSID == (short)LoanStatusEnum.Active && a.LOANID == loanId && a.LOANSYSTEMTYPEID == loanSystemTypeId
                                         && (a.LOANREVIEWOPERATIONID.Value.Equals(null) || !a.LOANREVIEWOPERATIONID.Value.Equals(loanReviewOperationId))
                                         && b.LOANSYSTEMTYPEID == a.LOANSYSTEMTYPEID && (a.FEEAMOUNT - a.EARNEDFEEAMOUNT) > 0 //&& a.FEEAMOUNT>0 
                                         select new DailyInterestAccrualViewModel()
                                         {
                                             referenceNumber = b.LOANREFERENCENUMBER,
                                             productId = b.PRODUCTID,
                                             branchId = b.BRANCHID,
                                             companyId = b.COMPANYID,
                                             currencyId = b.CURRENCYID,
                                             exchangeRate = b.EXCHANGERATE,
                                             interestRate = b.INTERESTRATE,
                                             date = applicationDate,
                                             effectiveDate = b.EFFECTIVEDATE,
                                             maturityDate = b.MATURITYDATE,
                                             mainAmount = earnAmount,
                                             categoryId = (short)DailyAccrualCategory.Fee,
                                             transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                             baseReferenceNumber = null,
                                             //dayCountConventionId = d.DAYCOUNTCONVENTIONID,
                                             chargedFeeId = a.CHARGEFEEID,
                                             loanChargedFeeId = a.LOANCHARGEFEEID,
                                         }).FirstOrDefault();

                        viewModel = termLoans;
                    }
                    if (viewModel != null)
                    {
                        financeTransaction.PostEarnUnEarnedFeeOperationEntries(viewModel, viewModel.mainAmount, "Earn UnEarned Fee", (int)OperationsEnum.EarnUnEarnedFee, loanSystemTypeId);
                    }
                }


            }
            catch (Exception ex)
            {

                throw ex;

            }

            return false;

        }


        public IEnumerable<DailyInterestAccrualViewModel> ProcessDailyFeeAccrual(DateTime applicationDate, int companyId, int staffId)
        {

            try
            {
                bool result = false;
                var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

                var termLoans = (from a in context.TBL_LOAN_FEE
                                 join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                                 join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
                                 join c in context.TBL_CHARGE_FEE on a.CHARGEFEEID equals c.CHARGEFEEID
                                 where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.MATURITYDATE >= applicationDate
                                 && b.LOANSYSTEMTYPEID == a.LOANSYSTEMTYPEID && (a.FEEAMOUNT - a.EARNEDFEEAMOUNT) > 0 && b.COMPANYID == companyId
                                 && c.FEEAMORTISATIONTYPEID == (int)FeeAmortizationTypeEnum.StraightLine  //&& a.FEEAMOUNT > 0

                                 select new DailyInterestAccrualViewModel()
                                 {
                                     referenceNumber = b.LOANREFERENCENUMBER,
                                     productId = b.PRODUCTID,
                                     branchId = b.BRANCHID,
                                     companyId = b.COMPANYID,
                                     currencyId = b.CURRENCYID,
                                     exchangeRate = b.EXCHANGERATE,
                                     interestRate = b.INTERESTRATE,
                                     date = applicationDate,
                                     effectiveDate = b.EFFECTIVEDATE,
                                     maturityDate = b.MATURITYDATE,
                                     mainAmount = a.FEEAMOUNT,
                                     categoryId = (short)DailyAccrualCategory.Fee,
                                     transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                     baseReferenceNumber = null,
                                     //dayCountConventionId = d.DAYCOUNTCONVENTIONID,
                                     chargedFeeId = a.CHARGEFEEID,
                                     loanChargedFeeId = a.LOANCHARGEFEEID,

                                 }).ToList().Select(x =>
                                 {
                                     x.dailyAccuralAmount = (double)DailyAccruedInterest((DateTime)x.effectiveDate, x.maturityDate, x.mainAmount);
                                     return x;
                                 });


                var contingents = (from a in context.TBL_LOAN_FEE
                                   join b in context.TBL_LOAN_CONTINGENT on a.LOANID equals b.CONTINGENTLOANID
                                   join c in context.TBL_CHARGE_FEE on a.CHARGEFEEID equals c.CHARGEFEEID
                                   where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.MATURITYDATE >= applicationDate
                                   && b.LOANSYSTEMTYPEID == a.LOANSYSTEMTYPEID && (a.FEEAMOUNT - a.EARNEDFEEAMOUNT) > 0 && b.COMPANYID == companyId
                                   && c.FEEAMORTISATIONTYPEID == (int)FeeAmortizationTypeEnum.StraightLine
                                   //&& a.FEEAMOUNT > 0
                                   select new DailyInterestAccrualViewModel()
                                   {
                                       referenceNumber = b.LOANREFERENCENUMBER,
                                       productId = b.PRODUCTID,
                                       branchId = b.BRANCHID,
                                       companyId = b.COMPANYID,
                                       currencyId = b.CURRENCYID,
                                       exchangeRate = b.EXCHANGERATE,
                                       interestRate = 1,
                                       date = applicationDate,
                                       effectiveDate = b.EFFECTIVEDATE,
                                       maturityDate = b.MATURITYDATE,
                                       mainAmount = a.FEEAMOUNT,
                                       categoryId = (short)DailyAccrualCategory.Fee,
                                       transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                       baseReferenceNumber = null,
                                       // dayCountConventionId = 1,
                                       chargedFeeId = a.CHARGEFEEID,
                                       loanChargedFeeId = a.LOANCHARGEFEEID,

                                   }).ToList().Select(x =>
                                   {
                                       x.dailyAccuralAmount = (double)DailyAccruedInterest((DateTime)x.effectiveDate, x.maturityDate, x.mainAmount);
                                       return x;
                                   });


                var revolving = (from a in context.TBL_LOAN_FEE
                                 join b in context.TBL_LOAN_REVOLVING on a.LOANID equals b.REVOLVINGLOANID
                                 join c in context.TBL_CHARGE_FEE on a.CHARGEFEEID equals c.CHARGEFEEID
                                 where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.MATURITYDATE >= applicationDate
                                 && b.LOANSYSTEMTYPEID == a.LOANSYSTEMTYPEID && (a.FEEAMOUNT - a.EARNEDFEEAMOUNT) > 0 && b.COMPANYID == companyId
                                 && c.FEEAMORTISATIONTYPEID == (int)FeeAmortizationTypeEnum.StraightLine
                                 //&& a.FEEAMOUNT > 0

                                 select new DailyInterestAccrualViewModel()
                                 {
                                     referenceNumber = b.LOANREFERENCENUMBER,
                                     productId = b.PRODUCTID,
                                     branchId = b.BRANCHID,
                                     companyId = b.COMPANYID,
                                     currencyId = b.CURRENCYID,
                                     exchangeRate = b.EXCHANGERATE,
                                     effectiveDate = (DateTime)b.EFFECTIVEDATE,
                                     maturityDate = b.MATURITYDATE,
                                     interestRate = 1,
                                     date = applicationDate,
                                     mainAmount = a.FEEAMOUNT,
                                     categoryId = (short)DailyAccrualCategory.Fee,
                                     transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                     baseReferenceNumber = null,
                                     //dayCountConventionId = 1,
                                     chargedFeeId = a.CHARGEFEEID,
                                     loanChargedFeeId = a.LOANCHARGEFEEID,

                                 }).ToList().Select(x =>
                                 {
                                     x.dailyAccuralAmount = (double)DailyAccruedInterest((DateTime)x.effectiveDate, x.maturityDate, x.mainAmount);
                                     return x;
                                 });


                var loanApplicationDetails = (from a in context.TBL_LOAN_FEE
                                              join b in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANID equals b.LOANAPPLICATIONDETAILID
                                              join c in context.TBL_LOAN_APPLICATION on b.LOANAPPLICATIONID equals c.LOANAPPLICATIONID
                                              join d in context.TBL_CHARGE_FEE on a.CHARGEFEEID equals d.CHARGEFEEID
                                              where b.EXPIRYDATE >= applicationDate
                                 && a.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility && (a.FEEAMOUNT - a.EARNEDFEEAMOUNT) > 0 && c.COMPANYID == companyId
                                 && d.FEEAMORTISATIONTYPEID == (int)FeeAmortizationTypeEnum.StraightLine  //&& a.FEEAMOUNT > 0

                                              select new DailyInterestAccrualViewModel()
                                              {
                                                  //referenceNumber = c.APPLICATIONREFERENCENUMBER + '-' + b.LOANAPPLICATIONDETAILID,
                                                  //referenceNumber = c.APPLICATIONREFERENCENUMBER,
                                                  applicationReferenceNumber = c.APPLICATIONREFERENCENUMBER,
                                                  loanApplicationDetailId = b.LOANAPPLICATIONDETAILID,
                                                  productId = b.PROPOSEDPRODUCTID,
                                                  branchId = c.BRANCHID,
                                                  companyId = c.COMPANYID,
                                                  currencyId = b.CURRENCYID,
                                                  exchangeRate = b.EXCHANGERATE,
                                                  effectiveDate = (DateTime)b.EFFECTIVEDATE,
                                                  maturityDate = (DateTime)b.EXPIRYDATE,
                                                  interestRate = 1,
                                                  date = applicationDate,
                                                  mainAmount = a.FEEAMOUNT,
                                                  categoryId = (short)DailyAccrualCategory.Fee,
                                                  transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                                  baseReferenceNumber = null,
                                                  //dayCountConventionId = 1,
                                                  chargedFeeId = a.CHARGEFEEID,
                                                  loanChargedFeeId = a.LOANCHARGEFEEID,

                                              }).ToList().Select(x =>
                                              {
                                                  x.referenceNumber = x.applicationReferenceNumber + '-' + x.loanApplicationDetailId;
                                                  x.dailyAccuralAmount = (double)DailyAccruedInterest((DateTime)x.effectiveDate, x.maturityDate, x.mainAmount);
                                                  return x;
                                              });


                var allFacilities = termLoans.Union(contingents).Union(revolving).Union(loanApplicationDetails).ToList();

                List<TBL_DAILY_ACCRUAL> transAccrual = new List<TBL_DAILY_ACCRUAL>();


                var check_Data = (from a in context.TBL_DAILY_ACCRUAL
                                  where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.Fee && a.COMPANYID == companyId
                                  select new DailyInterestAccrualViewModel()
                                  {
                                      productId = a.PRODUCTID,

                                  }).ToList();

                if (check_Data.Count() == 0)
                {

                    foreach (var item in allFacilities)
                    {
                        TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                        dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                        dailyAccrual.PRODUCTID = item.productId;
                        dailyAccrual.BRANCHID = item.branchId;
                        dailyAccrual.EXCHANGERATE = item.exchangeRate;
                        dailyAccrual.CURRENCYID = item.currencyId;
                        dailyAccrual.INTERESTRATE = item.interestRate;
                        dailyAccrual.DATE = item.date;
                        dailyAccrual.DAILYACCURALAMOUNT = (decimal?)Math.Abs(item.dailyAccuralAmount) ?? 0;
                        dailyAccrual.MAINAMOUNT = item.mainAmount;
                        dailyAccrual.CATEGORYID = item.categoryId;
                        dailyAccrual.COMPANYID = item.companyId;
                        dailyAccrual.DAYCOUNTCONVENTIONID = (short?)DayCountConventionEnum.Actual_Actual ?? 0;
                        dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;

                        dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;
                        dailyAccrual.CHARGEFEEID = item.chargedFeeId;

                        transAccrual.Add(dailyAccrual);

                    }
                    context.TBL_DAILY_ACCRUAL.AddRange(transAccrual);


                    //List<TBL_LOAN_FEE> _loanFee = new List<TBL_LOAN_FEE>();

                    //foreach (var item in allFacilities)
                    //{
                    //    TBL_LOAN_FEE loanFee = new TBL_LOAN_FEE();

                    //    loanFee.LOANCHARGEFEEID = item.loanChargedFeeId;
                    //    loanFee.EARNEDFEEAMOUNT = (decimal)item.dailyAccuralAmount + context.TBL_LOAN_FEE.Where(x => x.LOANCHARGEFEEID == item.loanChargedFeeId).Select(x => x.EARNEDFEEAMOUNT).FirstOrDefault() ;
                    //    _loanFee.Add(loanFee);

                    //}

                    //context.TBL_LOAN_FEE.AddRange(_loanFee);


                    foreach (var item in allFacilities)
                    {
                        var loanFee = context.TBL_LOAN_FEE.Where(x => x.LOANCHARGEFEEID == item.loanChargedFeeId).FirstOrDefault();
                        loanFee.EARNEDFEEAMOUNT = loanFee.EARNEDFEEAMOUNT + (decimal)item.dailyAccuralAmount;

                    }

                    context.SaveChanges();

                }


                var model = (from a in context.TBL_DAILY_ACCRUAL
                             where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.Fee && a.COMPANYID == companyId
                             group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, a.CHARGEFEEID, a.REFERENCENUMBER } into groupedQ
                             select new DailyInterestAccrualViewModel()
                             {
                                 chargedFeeId = groupedQ.Key.CHARGEFEEID,
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 referenceNumber = groupedQ.Key.REFERENCENUMBER,
                                 dailyAccuralAmount = (double)groupedQ.Sum(i => i.DAILYACCURALAMOUNT),
                             }).ToList();


                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                if (setup.USE_THIRD_PARTY_INTEGRATION)
                {
                    BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                    result = bulkPosting.WriteBulkDailyFeeAccuralToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate, staffId);

                }
                else
                {
                    foreach (var item in model)
                    {
                        item.date = applicationDate;

                        // result = financeTransaction.PostDailyLoansInterestAccrual(item);
                    }
                }
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;


            }

        }


        public List<LoanViewModel> AddBulkPrepaymentReversal(LoanReviewOperationViewModel model, int companyId)
        {

            var applicationDate = generalSetup.GetApplicationDate();

            List<LoanViewModel> result = new List<LoanViewModel>();

            using (TransactionScope transactionScope = new TransactionScope())
            {

                try
                {
                    var batchCode = CommonHelpers.GenerateRandomDigitCodeNew(10);

                    long batchCodeInt = Convert.ToInt64(batchCode);

                    batchCodeInt = Math.Abs(batchCodeInt);



                    foreach (var data in model.dataCollection)
                    {
                        data.createdBy = model.createdBy;
                        data.companyId = model.companyId;
                        data.userBranchId = model.userBranchId;
                        data.applicationUrl = model.applicationUrl;
                        data.userIPAddress = model.userIPAddress;
                        data.applicationUrl = model.applicationUrl;

                        var response = AddBulkPrepaymentReversalData(data, (int)batchCodeInt, applicationDate);


                    };


                    var rec = context.TBL_BULK_PREPAYMENTREVERSAL.Where(x => x.BATCHID == (int)batchCodeInt).FirstOrDefault();


                    if (rec != null)
                    {

                        // Audit Section ---------------------------
                        var audit = new TBL_AUDIT
                        {
                            AUDITTYPEID = (short)AuditTypeEnum.CreateBulkPrepaymentReversal,
                            STAFFID = model.createdBy,
                            BRANCHID = model.userBranchId,
                            DETAIL = $"Initiated Bulk Prepayment with code '{batchCode}'",
                            IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                            URL = model.applicationUrl,
                            APPLICATIONDATE = applicationDate,
                            SYSTEMDATETIME = DateTime.Now,
                            DEVICENAME = CommonHelpers.GetDeviceName(),
                            OSNAME = CommonHelpers.FriendlyName(),
                        };

                        auditTrail.AddAuditTrail(audit);

                        var recSave = context.SaveChanges() > 0;

                        workFlow.StaffId = model.createdBy;
                        workFlow.CompanyId = model.companyId;
                        workFlow.StatusId = (int)ApprovalStatusEnum.Pending;
                        //workflow.TargetId = batchCode;
                        workFlow.TargetId = (int)batchCodeInt;
                        workFlow.Comment = "Bulk Prepayment Reversal Initiated";
                        workFlow.OperationId = (int)OperationsEnum.ReversalOfPrepayment;
                        workFlow.DeferredExecution = true; // false by default will call the internal SaveChanges()
                        workFlow.ExternalInitialization = true;
                        workFlow.LogActivity();

                        var runningLoan = (from l in context.TBL_LOAN
                                           join m in context.TBL_LOAN_REVIEW_OPERATION on l.TERMLOANID equals m.LOANID
                                           join n in context.TBL_BULK_PREPAYMENTREVERSAL on l.LOANREFERENCENUMBER equals n.LOANREFERENCENUMBER
                                           where l.COMPANYID == companyId && l.LOANSTATUSID == (short)LoanStatusEnum.Active
                                           && m.OPERATIONDATE == DbFunctions.TruncateTime(applicationDate) && m.OPERATIONTYPEID == (int)OperationsEnum.Prepayment && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                           && n.PROCESSDATE == DbFunctions.TruncateTime(applicationDate) && n.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                           select new LoanViewModel()
                                           {
                                               loanReviewOperationId = m.LOANREVIEWOPERATIONID,
                                               loanReferenceNumber = l.LOANREFERENCENUMBER,
                                               loanId = l.TERMLOANID,
                                               operationDate = (DateTime)m.OPERATIONDATE,
                                               prepaymentAmount = (decimal)m.PREPAYMENT,
                                           }).OrderBy(x => x.loanReviewOperationId).ToList();



                        if (runningLoan.Count().Equals(0))
                        {
                            result = runningLoan.ToList();
                        }

                    }

                    transactionScope.Complete();


                    transactionScope.Dispose();
                }
                catch (Exception ex)
                {
                    transactionScope.Dispose();

                    var innerException = "";
                    if (ex.InnerException != null)
                    {
                        innerException = ex.InnerException.InnerException.Message;
                    }

                    throw ex;
                }

            }



            return result;


        }

        public bool AddBulkPrepaymentReversalData(LoanViewModel data, int batchCode, DateTime applicationDate)
        {

            var bulkPrepaymentReversalInfo = new TBL_BULK_PREPAYMENTREVERSAL()
            {
                BATCHID = batchCode,
                LOANREFERENCENUMBER = data.loanReferenceNumber,
                AMOUNT = data.prepaymentAmount,
                CREATEDBY = data.createdBy,
                LASTUPDATEDBY = data.createdBy,
                PROCESSDATE = applicationDate,
                DATETIMECREATED = DateTime.Now,
                DELETED = false,
                APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,
            };

            context.TBL_BULK_PREPAYMENTREVERSAL.Add(bulkPrepaymentReversalInfo);

            var output = context.SaveChanges() > 0;

            return output;
        }


        public List<LoanViewModel> GetCurrentPrepayment(int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var runningLoan = (from l in context.TBL_LOAN
                               join m in context.TBL_LOAN_REVIEW_OPERATION on l.TERMLOANID equals m.LOANID
                               where l.COMPANYID == companyId && l.LOANSTATUSID == (short)LoanStatusEnum.Active
                               && m.OPERATIONDATE == DbFunctions.TruncateTime(applicationDate) && m.OPERATIONTYPEID == (int)OperationsEnum.Prepayment && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                               select new LoanViewModel()
                               {
                                   loanReviewOperationId = m.LOANREVIEWOPERATIONID,
                                   loanReferenceNumber = l.LOANREFERENCENUMBER,
                                   loanId = l.TERMLOANID,
                                   operationDate = (DateTime)m.OPERATIONDATE,
                                   prepaymentAmount = (decimal)m.PREPAYMENT,
                               }).OrderBy(x => x.loanReviewOperationId).ToList();

            return runningLoan;
        }



        public List<LoanViewModel> GetRunningPrepaymentLoans(int companyId, int loanId)
        {
            var applicationDate = generalSetup.GetApplicationDate();


            var runningLoan = (from l in context.TBL_LOAN
                               join m in context.TBL_LOAN_REVIEW_OPERATION on l.TERMLOANID equals m.LOANID
                               where l.COMPANYID == companyId && l.TERMLOANID == loanId && l.LOANSTATUSID == (short)LoanStatusEnum.Active
                               && m.OPERATIONDATE == DbFunctions.TruncateTime(applicationDate) && m.OPERATIONTYPEID == (int)OperationsEnum.Prepayment
                               select new LoanViewModel()
                               {
                                   loanReviewOperationId = m.LOANREVIEWOPERATIONID,
                                   loanId = l.TERMLOANID,
                                   operationDate = (DateTime)m.OPERATIONDATE,
                                   prepaymentAmount = (decimal)m.PREPAYMENT,
                               }).OrderBy(x => x.loanReviewOperationId).ToList();

            return runningLoan;
        }



        public IEnumerable<DailyInterestAccrualViewModel> ProcessDailyTaxAccrual(DateTime applicationDate)
        {
            try
            {
                bool result = false;
                var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

                var termLoans = (from a in context.TBL_LOAN_FEE
                                 join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                                 //join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
                                 where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.MATURITYDATE <= applicationDate
                                 && b.LOANSYSTEMTYPEID == a.LOANSYSTEMTYPEID && a.TAXAMOUNT > 0

                                 select new DailyInterestAccrualViewModel()
                                 {
                                     referenceNumber = b.LOANREFERENCENUMBER,
                                     mainAmount = a.TAXAMOUNT,
                                     productId = b.PRODUCTID,
                                     branchId = b.BRANCHID,
                                     companyId = b.COMPANYID,
                                     currencyId = b.CURRENCYID,
                                     exchangeRate = b.EXCHANGERATE,
                                     interestRate = b.INTERESTRATE,
                                     date = applicationDate,
                                     categoryId = (short)DailyAccrualCategory.Tax,
                                     transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                     baseReferenceNumber = null,
                                     //dayCountConventionId = d.DAYCOUNTCONVENTIONID,
                                     loanChargedFeeId = a.LOANCHARGEFEEID,
                                     effectiveDate = b.EFFECTIVEDATE,
                                     maturityDate = b.MATURITYDATE,
                                     chargedFeeId = a.CHARGEFEEID,

                                 }).ToList().Select(x =>
                                 {
                                     x.dailyAccuralAmount = (double)DailyAccruedInterest((DateTime)x.effectiveDate, x.maturityDate, x.mainAmount);
                                     return x;
                                 });


                var revolving = (from a in context.TBL_LOAN_FEE
                                 join b in context.TBL_LOAN_REVOLVING on a.LOANID equals b.REVOLVINGLOANID
                                 //join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
                                 where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.MATURITYDATE <= applicationDate
                                 && b.LOANSYSTEMTYPEID == a.LOANSYSTEMTYPEID && a.TAXAMOUNT > 0


                                 select new DailyInterestAccrualViewModel()
                                 {
                                     referenceNumber = b.LOANREFERENCENUMBER,
                                     mainAmount = a.TAXAMOUNT,
                                     productId = b.PRODUCTID,
                                     branchId = b.BRANCHID,
                                     companyId = b.COMPANYID,
                                     currencyId = b.CURRENCYID,
                                     exchangeRate = b.EXCHANGERATE,
                                     interestRate = b.INTERESTRATE,
                                     date = applicationDate,
                                     categoryId = (short)DailyAccrualCategory.Tax,
                                     transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                     baseReferenceNumber = null,
                                     //dayCountConventionId = d.DAYCOUNTCONVENTIONID,
                                     loanChargedFeeId = a.LOANCHARGEFEEID,
                                     effectiveDate = b.EFFECTIVEDATE,
                                     maturityDate = b.MATURITYDATE,
                                     chargedFeeId = a.CHARGEFEEID,

                                 }).ToList().Select(x =>
                                 {
                                     x.dailyAccuralAmount = (double)DailyAccruedInterest((DateTime)x.effectiveDate, x.maturityDate, x.mainAmount);
                                     return x;
                                 });

                var contingents = (from a in context.TBL_LOAN_FEE
                                   join b in context.TBL_LOAN_CONTINGENT on a.LOANID equals b.CONTINGENTLOANID
                                   where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.MATURITYDATE <= applicationDate
                                   && b.LOANSYSTEMTYPEID == a.LOANSYSTEMTYPEID && a.TAXAMOUNT > 0


                                   select new DailyInterestAccrualViewModel()
                                   {
                                       referenceNumber = b.LOANREFERENCENUMBER,
                                       mainAmount = a.TAXAMOUNT,
                                       productId = b.PRODUCTID,
                                       branchId = b.BRANCHID,
                                       companyId = b.COMPANYID,
                                       currencyId = b.CURRENCYID,
                                       exchangeRate = b.EXCHANGERATE,
                                       interestRate = 0,
                                       date = applicationDate,
                                       categoryId = (short)DailyAccrualCategory.Tax,
                                       transactionTypeId = (byte)LoanTransactionTypeEnum.Fees,
                                       baseReferenceNumber = null,
                                       //dayCountConventionId = d.DAYCOUNTCONVENTIONID,
                                       loanChargedFeeId = a.LOANCHARGEFEEID,
                                       effectiveDate = b.EFFECTIVEDATE,
                                       maturityDate = b.MATURITYDATE,
                                       chargedFeeId = a.CHARGEFEEID,


                                   }).ToList().Select(x =>
                                   {
                                       x.dailyAccuralAmount = (double)DailyAccruedInterest((DateTime)x.effectiveDate, x.maturityDate, x.mainAmount);
                                       return x;
                                   });


                var data = termLoans.Union(contingents).Union(revolving).ToList();

                List<TBL_DAILY_ACCRUAL> transAccrual = new List<TBL_DAILY_ACCRUAL>();


                foreach (var item in data)
                {
                    TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                    dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                    dailyAccrual.PRODUCTID = item.productId;
                    dailyAccrual.BRANCHID = item.branchId;
                    dailyAccrual.EXCHANGERATE = item.exchangeRate;
                    dailyAccrual.CURRENCYID = item.currencyId;
                    dailyAccrual.INTERESTRATE = item.interestRate;
                    dailyAccrual.DATE = item.date;
                    dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs(item.dailyAccuralAmount);
                    dailyAccrual.MAINAMOUNT = item.mainAmount;
                    dailyAccrual.CATEGORYID = (short)DailyAccrualCategory.Tax;
                    dailyAccrual.COMPANYID = item.companyId;
                    dailyAccrual.DAYCOUNTCONVENTIONID = (short)DayCountConventionEnum.Actual_Actual; // item.dayCountConventionId;
                    dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
                    dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;
                    dailyAccrual.CHARGEFEEID = item.chargedFeeId;

                    transAccrual.Add(dailyAccrual);

                }
                this.context.TBL_DAILY_ACCRUAL.AddRange(transAccrual);



                foreach (var item in data)
                {
                    var loanFee = context.TBL_LOAN_FEE.Where(x => x.LOANCHARGEFEEID == item.loanChargedFeeId).FirstOrDefault();
                    loanFee.EARNEDTAXAMOUNT = loanFee.EARNEDTAXAMOUNT + (decimal)item.dailyAccuralAmount;
                }



                context.SaveChanges();


                var model = (from a in context.TBL_DAILY_ACCRUAL
                                 //where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan
                             where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.Tax
                             group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, a.CHARGEFEEID } into groupedQ
                             select new DailyInterestAccrualViewModel()
                             {
                                 chargedFeeId = groupedQ.Key.CHARGEFEEID,
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 dailyAccuralAmount = (double)groupedQ.Sum(i => i.DAILYACCURALAMOUNT),

                             }).ToList();


                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                if (setup.USE_THIRD_PARTY_INTEGRATION)
                {
                    BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                    result = bulkPosting.WriteBulkDailyTaxAccuralToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate);

                }
                else
                {
                    foreach (var item in model)
                    {
                        item.date = applicationDate;

                        result = financeTransaction.PostDailyLoansInterestAccrual(item);
                    }
                }

                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        public IEnumerable<DailyInterestAccrualViewModel> ProcessDailyAuthorisedOverdraftInterestAccrual(DateTime applicationDate)

        {
            try
            {
                bool result = false;
                var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);


                var data = (from a in context.TBL_LOAN_REVOLVING
                            join b in context.TBL_CASA on a.CASAACCOUNTID equals b.CASAACCOUNTID
                            join c in context.TBL_DAY_COUNT_CONVENTION on a.DAYCOUNTCONVENTIONID equals c.DAYCOUNTCONVENTIONID
                            where a.LOANSTATUSID == (short)LoanStatusEnum.Active
                           && b.AVAILABLEBALANCE < 0 && a.SUSPENDINTEREST == false


                            select new DailyInterestAccrualViewModel()
                            {
                                referenceNumber = a.LOANREFERENCENUMBER,
                                productId = a.PRODUCTID,
                                branchId = a.BRANCHID,
                                companyId = a.COMPANYID,
                                currencyId = a.CURRENCYID,
                                exchangeRate = a.EXCHANGERATE,
                                interestRate = a.INTERESTRATE,
                                date = applicationDate,
                                dailyAccuralAmount = a.INTERESTRATE,
                                mainAmount = a.OVERDRAFTLIMIT,
                                categoryId = (short)DailyAccrualCategory.AuthorisedOverdraft,
                                availableBalance = b.AVAILABLEBALANCE,
                                transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                                baseReferenceNumber = null,
                                dayCountConventionId = c.DAYCOUNTCONVENTIONID,
                                //daysInAYear = c.DAYSINAYEAR,

                            }).ToList().Select(x =>
                            {
                                x.daysInAYear = loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId);
                                return x;
                            });

                List<TBL_DAILY_ACCRUAL> transAccrual = new List<TBL_DAILY_ACCRUAL>();


                foreach (var item in data)
                {
                    TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                    dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                    dailyAccrual.PRODUCTID = item.productId;
                    dailyAccrual.BRANCHID = item.branchId;
                    dailyAccrual.EXCHANGERATE = item.exchangeRate;
                    dailyAccrual.CURRENCYID = item.currencyId;
                    dailyAccrual.INTERESTRATE = item.interestRate;
                    dailyAccrual.DATE = item.date;
                    dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs((decimal)(item.dailyAccuralAmount / item.daysInAYear) * item.availableBalance);
                    dailyAccrual.MAINAMOUNT = item.mainAmount;
                    dailyAccrual.CATEGORYID = item.categoryId;
                    dailyAccrual.COMPANYID = item.companyId;
                    dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
                    dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
                    dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;


                    transAccrual.Add(dailyAccrual);
                }
                this.context.TBL_DAILY_ACCRUAL.AddRange(transAccrual);

                context.SaveChanges();

                var model = (from a in context.TBL_DAILY_ACCRUAL
                             where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.AuthorisedOverdraft
                             group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID } into groupedQ
                             select new DailyInterestAccrualViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 dailyAccuralAmount = (double)groupedQ.Sum(i => i.DAILYACCURALAMOUNT),
                             }).ToList();

                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                if (setup.USE_THIRD_PARTY_INTEGRATION)
                {
                    BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                    result = bulkPosting.WriteBulkDailyAuthorisedOverdraftInterestAccuralToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate);

                }
                else
                {
                    foreach (var item in model)
                    {
                        item.date = applicationDate;

                        result = financeTransaction.PostDailyLoansInterestAccrual(item);
                    }
                }

                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;

            }
        }

        public IEnumerable<DailyInterestAccrualViewModel> ProcessDailyUnauthorisedOverdraftInterestAccrual(DateTime applicationDate)

        {
            try
            {
                bool result = false;
                var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);


                var data = (from a in context.TBL_LOAN
                            join b in context.TBL_CASA on a.CASAACCOUNTID equals b.CASAACCOUNTID
                            join c in context.TBL_DAY_COUNT_CONVENTION on a.SCHEDULEDAYCOUNTCONVENTIONID equals c.DAYCOUNTCONVENTIONID
                            join d in context.TBL_SETUP_COMPANY on a.COMPANYID equals d.COMPANYID
                            where a.LOANSTATUSID == (short)LoanStatusEnum.Active
                            && b.AVAILABLEBALANCE < 0 && a.ALLOWFORCEDEBITREPAYMENT == false && a.SUSPENDINTEREST == false


                            select new DailyInterestAccrualViewModel()
                            {
                                referenceNumber = a.LOANREFERENCENUMBER,
                                productId = a.PRODUCTID,
                                branchId = a.BRANCHID,
                                companyId = a.COMPANYID,
                                currencyId = a.CURRENCYID,
                                exchangeRate = a.EXCHANGERATE,
                                interestRate = a.INTERESTRATE,
                                date = applicationDate,
                                dailyAccuralAmount = d.UNAUTHORISD_OVERDRAFT_INT_RATE,
                                mainAmount = b.AVAILABLEBALANCE,
                                categoryId = (short)DailyAccrualCategory.UnauthorisedOverdraft,
                                availableBalance = b.AVAILABLEBALANCE,
                                transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                                baseReferenceNumber = null,
                                dayCountConventionId = c.DAYCOUNTCONVENTIONID,
                                //daysInAYear = c.DAYSINAYEAR,

                            }).ToList().Select(x =>
                            {
                                x.daysInAYear = loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId);
                                return x;
                            });

                List<TBL_DAILY_ACCRUAL> transAccrual = new List<TBL_DAILY_ACCRUAL>();


                foreach (var item in data)
                {
                    TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                    dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                    dailyAccrual.PRODUCTID = item.productId;
                    dailyAccrual.BRANCHID = item.branchId;
                    dailyAccrual.EXCHANGERATE = item.exchangeRate;
                    dailyAccrual.CURRENCYID = item.currencyId;
                    dailyAccrual.INTERESTRATE = item.interestRate;
                    dailyAccrual.DATE = item.date;
                    dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs((decimal)(item.dailyAccuralAmount / item.daysInAYear) * item.availableBalance);
                    dailyAccrual.MAINAMOUNT = item.mainAmount;
                    dailyAccrual.CATEGORYID = item.categoryId;
                    dailyAccrual.COMPANYID = item.companyId;
                    dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
                    dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
                    dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;


                    transAccrual.Add(dailyAccrual);
                }
                this.context.TBL_DAILY_ACCRUAL.AddRange(transAccrual);

                context.SaveChanges();

                var model = (from a in context.TBL_DAILY_ACCRUAL
                             where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.UnauthorisedOverdraft
                             group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID } into groupedQ
                             select new DailyInterestAccrualViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 dailyAccuralAmount = (double)groupedQ.Sum(i => i.DAILYACCURALAMOUNT),
                             }).ToList();

                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                if (setup.USE_THIRD_PARTY_INTEGRATION)
                {
                    BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                    result = bulkPosting.WriteBulkDailyUnauthorisedOverdraftInterestAccuralToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate);

                }
                else
                {
                    foreach (var item in model)
                    {
                        item.date = applicationDate;

                        result = financeTransaction.PostDailyLoansInterestAccrual(item);
                    }
                }

                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }

        }

        public IEnumerable<DailyInterestAccrualViewModel> ProcessDailyInterestOnPastDueInterestAccrual(DateTime applicationDate, int companyId, int staffId)
        {
            try
            {
                bool result = false;
                var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

                var currencyRate = (from a in context.TBL_LOAN
                                    where a.LOANSTATUSID == (short)LoanStatusEnum.Active
                                         && a.ALLOWFORCEDEBITREPAYMENT == false && a.SUSPENDINTEREST == false && a.PASTDUEINTEREST > 0 && a.COMPANYID == companyId
                                    select new CurrencyExchangeRateViewModel()
                                    {
                                        currencyId = a.CURRENCYID,
                                        companyId = a.COMPANYID,
                                    }).ToList().Distinct().Select(x =>
                                    {
                                        x.sellingRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, (int)x.companyId).sellingRate;
                                        return x;
                                    }).ToList();


                var pastDues = (from a in context.TBL_LOAN
                                join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
                                join c in context.TBL_DAY_COUNT_CONVENTION on a.SCHEDULEDAYCOUNTCONVENTIONID equals c.DAYCOUNTCONVENTIONID
                                where a.LOANSTATUSID == (short)LoanStatusEnum.Active
                                && a.ALLOWFORCEDEBITREPAYMENT == false && a.SUSPENDINTEREST == false && a.PASTDUEINTEREST > 0 && a.COMPANYID == companyId
                                //&& a.PASTDUEDATE != null

                                select new DailyInterestAccrualViewModel()
                                {
                                    referenceNumber = a.LOANREFERENCENUMBER,
                                    productId = a.PRODUCTID,
                                    branchId = a.BRANCHID,
                                    companyId = a.COMPANYID,
                                    currencyId = a.CURRENCYID,
                                    //exchangeRate = a.EXCHANGERATE,
                                    interestRate = (double)a.TBL_PRODUCT.PENALCHARGERATE.Value,
                                    date = applicationDate,
                                    dailyAccuralAmount = a.INTERESTRATE,/// change to global charge rate 
                                    mainAmount = a.PASTDUEINTEREST,
                                    categoryId = (short)DailyAccrualCategory.PastDueInterest,
                                    availableBalance = a.PASTDUEINTEREST,
                                    transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                                    baseReferenceNumber = null,
                                    dayCountConventionId = c.DAYCOUNTCONVENTIONID,
                                    pastDueDate = a.PASTDUEDATE,
                                    gracePeriod = b.DEFAULTGRACEPERIOD
                                }).ToList().Select(x =>
                                {
                                    x.exchangeRate = currencyRate.Where(m => m.currencyId == x.currencyId).Select(m => m.sellingRate).FirstOrDefault();
                                    //x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
                                    x.daysInAYear = loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId);
                                    return x;
                                });



                List<TBL_DAILY_ACCRUAL> transAccrual = new List<TBL_DAILY_ACCRUAL>();


                var check_Data = (from a in context.TBL_DAILY_ACCRUAL
                                  join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
                                  join c in context.TBL_BRANCH on a.BRANCHID equals c.BRANCHID
                                  join d in context.TBL_CURRENCY on a.CURRENCYID equals d.CURRENCYID
                                  where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.PastDueInterest && a.COMPANYID == companyId
                                  select new DailyInterestAccrualViewModel()
                                  {
                                      productId = a.PRODUCTID,

                                  }).ToList();

                if (check_Data.Count() == 0)
                {
                    foreach (var item in pastDues)
                    {
                        _transactionReferenceNo = item.referenceNumber;

                        TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                        var accuralAmount = (decimal)Math.Abs((decimal)(item.interestRate / 100.0000) * item.availableBalance * (1 / (decimal)item.daysInAYear));

                        if (accuralAmount <= 0)
                            continue;

                        dailyAccrual.DAILYACCURALAMOUNT = accuralAmount;
                        dailyAccrual.DAILYACCURALAMOUNT2 = 0;

                        if (item.pastDueDate.HasValue && item.gracePeriod.HasValue)
                        {
                            var gracePeriod = item.gracePeriod.Value;
                            var gracePeriodEndDate = item.pastDueDate.Value.AddDays(gracePeriod);
                            if (applicationDate <= gracePeriodEndDate)
                            {
                                dailyAccrual.DAILYACCURALAMOUNT = 0;
                                dailyAccrual.DAILYACCURALAMOUNT2 = accuralAmount;
                            }
                            if (applicationDate == gracePeriodEndDate.AddDays(1))
                            {
                                DateTime gracePeriodStartDate = applicationDate.AddDays(gracePeriod * -1);

                                var pastDueInterestDaily = (from a in context.TBL_DAILY_ACCRUAL
                                                            where a.REFERENCENUMBER == item.referenceNumber && a.COMPANYID == item.companyId
                                                            && (a.DATE >= gracePeriodStartDate && a.DATE < applicationDate)
                                                            && a.CATEGORYID == (short)DailyAccrualCategory.PastDueInterest
                                                            && a.TRANSACTIONTYPEID == (byte)LoanTransactionTypeEnum.Interest
                                                            select a);


                                foreach (var itemDaily in pastDueInterestDaily)
                                {
                                    itemDaily.DAILYACCURALAMOUNT = itemDaily.DAILYACCURALAMOUNT2;
                                }

                            }
                        }


                        dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                        dailyAccrual.PRODUCTID = item.productId;
                        dailyAccrual.BRANCHID = item.branchId;
                        dailyAccrual.EXCHANGERATE = item.exchangeRate;
                        dailyAccrual.CURRENCYID = item.currencyId;
                        dailyAccrual.INTERESTRATE = item.interestRate;
                        dailyAccrual.DATE = item.date;
                        dailyAccrual.MAINAMOUNT = item.mainAmount;
                        dailyAccrual.CATEGORYID = item.categoryId;
                        dailyAccrual.COMPANYID = item.companyId;
                        dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
                        dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
                        dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;
                        dailyAccrual.REPAYMENTPOSTEDSTATUS = false;

                        transAccrual.Add(dailyAccrual);

                    }

                    this.context.TBL_DAILY_ACCRUAL.AddRange(transAccrual);

                    context.SaveChanges();
                }




                var model = (from a in context.TBL_DAILY_ACCRUAL
                             join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
                             join c in context.TBL_BRANCH on a.BRANCHID equals c.BRANCHID
                             join d in context.TBL_CURRENCY on a.CURRENCYID equals d.CURRENCYID
                             where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.PastDueInterest && a.COMPANYID == companyId
                             group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, b.PRODUCTCODE, c.BRANCHCODE, d.CURRENCYCODE, a.CATEGORYID, a.EXCHANGERATE, a.REFERENCENUMBER } into groupedQ
                             select new DailyInterestAccrualViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 categoryId = groupedQ.Key.CATEGORYID,
                                 productCode = groupedQ.Key.PRODUCTCODE,
                                 currencyCode = groupedQ.Key.CURRENCYCODE,
                                 branchCode = groupedQ.Key.BRANCHCODE,
                                 exchangeRate = groupedQ.Key.EXCHANGERATE,
                                 referenceNumber = groupedQ.Key.REFERENCENUMBER,
                                 //referenceNumber = groupedQ.Key.PRODUCTCODE + '/' + groupedQ.Key.CURRENCYCODE + '/' + groupedQ.Key.BRANCHCODE + '/' + groupedQ.Key.COMPANYID.ToString(),
                                 dailyAccuralAmount = (double)groupedQ.Sum(i => i.DAILYACCURALAMOUNT),
                             }).Where(x => x.dailyAccuralAmount > 0).ToList();
                //.Select(x =>
                //{
                //    x.referenceNumber = x.productCode + '/' + x.currencyCode + '/' + x.branchCode + '/' + x.companyId.ToString() + '/' + x.categoryId.ToString();
                //    return x;
                //}).ToList();

                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                if (setup.USE_THIRD_PARTY_INTEGRATION && globalIntegrationSetting.USE_THIRPARTY_POSTING)
                {
                    BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                    result = bulkPosting.WriteBulkDailyPastDueInterestAccrualToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate,
                                                                                        "Past Due Interest Accrual Posting - Interest", companyId, staffId, out _transactionReferenceNo);

                }
                else
                {
                    foreach (var item in model)
                    {
                        item.date = applicationDate;

                        result = financeTransaction.PostDailyLoansInterestAccrual(item);
                    }
                }

                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        public IEnumerable<DailyInterestAccrualViewModel> ProcessDailyInterestOnPastDuePrincipalAccrual(DateTime applicationDate, int companyId, int staffId)

        {
            try
            {

                bool result = false;
                var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

                var currencyRate = (from a in context.TBL_LOAN
                                    where a.LOANSTATUSID == (short)LoanStatusEnum.Active && a.ALLOWFORCEDEBITREPAYMENT == false
                                    && a.SUSPENDINTEREST == false && a.PASTDUEPRINCIPAL > 0 && a.COMPANYID == companyId
                                    select new CurrencyExchangeRateViewModel()
                                    {
                                        currencyId = a.CURRENCYID,
                                        companyId = a.COMPANYID,
                                    }).ToList().Distinct().Select(x =>
                                    {
                                        x.sellingRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, (int)x.companyId).sellingRate;
                                        return x;
                                    }).ToList();


                var pastDueLoans = (from a in context.TBL_LOAN
                                    join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
                                    join c in context.TBL_DAY_COUNT_CONVENTION on a.SCHEDULEDAYCOUNTCONVENTIONID equals c.DAYCOUNTCONVENTIONID
                                    where a.LOANSTATUSID == (short)LoanStatusEnum.Active && a.ALLOWFORCEDEBITREPAYMENT == false
                                    && a.SUSPENDINTEREST == false && a.PASTDUEPRINCIPAL > 0 && a.COMPANYID == companyId
                                    //&& a.PASTDUEDATE != null 

                                    select new DailyInterestAccrualViewModel()
                                    {
                                        referenceNumber = a.LOANREFERENCENUMBER,
                                        productId = a.PRODUCTID,
                                        branchId = a.BRANCHID,
                                        companyId = a.COMPANYID,
                                        currencyId = a.CURRENCYID,
                                        //exchangeRate = a.EXCHANGERATE,
                                        interestRate = (double)a.TBL_PRODUCT.PENALCHARGERATE.Value,
                                        date = applicationDate,
                                        dailyAccuralAmount = a.INTERESTRATE,/// change to global charge rate 
                                        mainAmount = a.PASTDUEPRINCIPAL,
                                        categoryId = (short)DailyAccrualCategory.PastDuePrincipal,
                                        availableBalance = a.PASTDUEPRINCIPAL,
                                        transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                                        baseReferenceNumber = null,
                                        dayCountConventionId = c.DAYCOUNTCONVENTIONID,
                                        pastDueDate = a.PASTDUEDATE,
                                        gracePeriod = b.DEFAULTGRACEPERIOD
                                    }).ToList().Select(x =>
                                    {
                                        //x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
                                        x.exchangeRate = currencyRate.Where(m => m.currencyId == x.currencyId).Select(m => m.sellingRate).FirstOrDefault();
                                        x.daysInAYear = loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId);
                                        return x;
                                    });


                List<TBL_DAILY_ACCRUAL> transAccrual = new List<TBL_DAILY_ACCRUAL>();


                var check_Data = (from a in context.TBL_DAILY_ACCRUAL
                                  join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
                                  join c in context.TBL_BRANCH on a.BRANCHID equals c.BRANCHID
                                  join d in context.TBL_CURRENCY on a.CURRENCYID equals d.CURRENCYID
                                  where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.PastDuePrincipal && a.COMPANYID == companyId
                                  select new DailyInterestAccrualViewModel()
                                  {
                                      productId = a.PRODUCTID,

                                  }).ToList();

                if (check_Data.Count() == 0)
                {

                    foreach (var item in pastDueLoans)
                    {
                        _transactionReferenceNo = item.referenceNumber;

                        TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                        var accuralAmount = (decimal)Math.Abs((decimal)(item.interestRate / 100.0000) * item.availableBalance * (1 / (decimal)item.daysInAYear));

                        if (accuralAmount <= 0)
                            continue;

                        dailyAccrual.DAILYACCURALAMOUNT = accuralAmount;
                        dailyAccrual.DAILYACCURALAMOUNT2 = 0;

                        if (item.pastDueDate.HasValue && item.gracePeriod.HasValue)
                        {
                            var gracePeriod = item.gracePeriod.Value;
                            var gracePeriodEndDate = item.pastDueDate.Value.AddDays(gracePeriod);
                            if (applicationDate <= gracePeriodEndDate)
                            {
                                dailyAccrual.DAILYACCURALAMOUNT = 0;
                                dailyAccrual.DAILYACCURALAMOUNT2 = accuralAmount;
                            }
                            if (applicationDate == gracePeriodEndDate.AddDays(1))
                            {
                                DateTime gracePeriodStartDate = applicationDate.AddDays(gracePeriod * -1);

                                var pastDueInterestDaily = (from a in context.TBL_DAILY_ACCRUAL
                                                            where a.REFERENCENUMBER == item.referenceNumber && a.COMPANYID == item.companyId
                                                            && (a.DATE >= gracePeriodStartDate && a.DATE < applicationDate)
                                                            && a.CATEGORYID == (short)DailyAccrualCategory.PastDuePrincipal
                                                            && a.TRANSACTIONTYPEID == (byte)LoanTransactionTypeEnum.Interest
                                                             && a.COMPANYID == companyId
                                                            select a);


                                foreach (var itemDaily in pastDueInterestDaily)
                                {
                                    itemDaily.DAILYACCURALAMOUNT = itemDaily.DAILYACCURALAMOUNT2;
                                }

                            }
                        }

                        dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                        dailyAccrual.PRODUCTID = item.productId;
                        dailyAccrual.BRANCHID = item.branchId;
                        dailyAccrual.EXCHANGERATE = item.exchangeRate;
                        dailyAccrual.CURRENCYID = item.currencyId;
                        dailyAccrual.INTERESTRATE = item.interestRate;
                        dailyAccrual.DATE = item.date;
                        dailyAccrual.MAINAMOUNT = item.mainAmount;
                        dailyAccrual.CATEGORYID = item.categoryId;
                        dailyAccrual.COMPANYID = item.companyId;
                        dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
                        dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
                        dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;
                        dailyAccrual.REPAYMENTPOSTEDSTATUS = false;

                        transAccrual.Add(dailyAccrual);
                    }

                    this.context.TBL_DAILY_ACCRUAL.AddRange(transAccrual);

                    context.SaveChanges();


                }



                var model = (from a in context.TBL_DAILY_ACCRUAL
                             join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
                             join c in context.TBL_BRANCH on a.BRANCHID equals c.BRANCHID
                             join d in context.TBL_CURRENCY on a.CURRENCYID equals d.CURRENCYID
                             where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.PastDuePrincipal
                             group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, b.PRODUCTCODE, c.BRANCHCODE, d.CURRENCYCODE, a.CATEGORYID, a.EXCHANGERATE, a.REFERENCENUMBER } into groupedQ
                             select new DailyInterestAccrualViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 categoryId = groupedQ.Key.CATEGORYID,
                                 productCode = groupedQ.Key.PRODUCTCODE,
                                 currencyCode = groupedQ.Key.CURRENCYCODE,
                                 branchCode = groupedQ.Key.BRANCHCODE,
                                 exchangeRate = groupedQ.Key.EXCHANGERATE,
                                 referenceNumber = groupedQ.Key.REFERENCENUMBER,

                                 //referenceNumber = groupedQ.Key.PRODUCTCODE + '/' + groupedQ.Key.CURRENCYCODE + '/' + groupedQ.Key.BRANCHCODE + '/' + groupedQ.Key.COMPANYID.ToString(),
                                 dailyAccuralAmount = (double)groupedQ.Sum(i => i.DAILYACCURALAMOUNT),
                             }).Where(x => x.dailyAccuralAmount > 0).ToList();
                //.Select(x =>
                //{
                //    x.referenceNumber = x.productCode + '/' + x.currencyCode + '/' + x.branchCode + '/' + x.companyId.ToString() + '/' + x.categoryId.ToString();
                //    return x;
                //}).ToList();

                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                if (setup.USE_THIRD_PARTY_INTEGRATION)
                {
                    BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                    result = bulkPosting.WriteBulkDailyPastDuePrincipalAccrualToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate,
                                                                                        "Past Due Interest Accrual Posting - Principal", companyId, staffId, out _transactionReferenceNo);

                }
                else
                {
                    foreach (var item in model)
                    {
                        item.date = applicationDate;

                        result = financeTransaction.PostDailyLoansInterestAccrual(item);
                    }
                }

                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        public IEnumerable<LoanClassificationViewModel> CalculateLoanClassification(DateTime applicationDate)

        {
            try
            {
                var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);
                var systemDate = generalSetup.GetApplicationDate();

                var data = (from a in context.TBL_LOAN
                            join b in context.TBL_LOAN_PAST_DUE on a.TERMLOANID equals b.LOANID
                            join c in context.TBL_DAY_COUNT_CONVENTION on a.SCHEDULEDAYCOUNTCONVENTIONID equals c.DAYCOUNTCONVENTIONID
                            join d in context.TBL_SETUP_COMPANY on a.COMPANYID equals d.COMPANYID
                            where b.DATE <= DbFunctions.TruncateTime(applicationDate) && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                           && (b.CREDITAMOUNT - b.DEBITAMOUNT) <= 0 && a.ALLOWFORCEDEBITREPAYMENT == false
                            group b by new { b.LOANID, b.PARENT_PASTDUECODE } into groupedQ
                            select new LoanClassificationViewModel()
                            {
                                loanId = groupedQ.Key.LOANID,
                                refNo = groupedQ.Key.PARENT_PASTDUECODE,
                                amount = groupedQ.Sum(i => i.CREDITAMOUNT - i.DEBITAMOUNT),
                            }).ToList();

                foreach (var item in data)
                {

                    var pastDueDate = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == item.loanId).NPLDATE;

                    if (pastDueDate == null && item.amount < 0)
                    {
                        TBL_LOAN loanResult = (from p in context.TBL_LOAN
                                               where p.TERMLOANID == item.loanId
                                               select p).SingleOrDefault();

                        loanResult.NPLDATE = systemDate;

                    }
                    else if (pastDueDate != null && item.amount > 0)
                    {
                        TBL_LOAN loanResult = (from p in context.TBL_LOAN
                                               where p.TERMLOANID == item.loanId
                                               select p).SingleOrDefault();

                        loanResult.NPLDATE = null;

                    }

                    else if (pastDueDate != null && item.amount < 0)
                    {
                        DateTime nplDate = (DateTime)context.TBL_LOAN.FirstOrDefault(a => a.TERMLOANID == item.loanId).NPLDATE;
                        int prudentialStatus = 0;
                        if ((nplDate - applicationDate).Days <= 60)
                        {
                            prudentialStatus = (int)LoanPrudentialStatusEnum.Performing;
                        }
                        else if ((nplDate - applicationDate).Days > 60 && (nplDate - applicationDate).Days <= 90)
                        {
                            prudentialStatus = (int)LoanPrudentialStatusEnum.WatchList;
                        }
                        else if ((nplDate - applicationDate).Days > 90 && (nplDate - applicationDate).Days <= 180)
                        {
                            prudentialStatus = (int)LoanPrudentialStatusEnum.Substandard;
                        }
                        else if ((nplDate - applicationDate).Days > 180 && (nplDate - applicationDate).Days <= 360)
                        {
                            prudentialStatus = (int)LoanPrudentialStatusEnum.Doubtful;
                        }
                        else if ((nplDate - applicationDate).Days > 360)
                        {
                            prudentialStatus = (int)LoanPrudentialStatusEnum.Lost;
                        }
                        TBL_LOAN loanResult = (from p in context.TBL_LOAN
                                               where p.TERMLOANID == item.loanId
                                               select p).SingleOrDefault();

                        loanResult.EXT_PRUDENT_GUIDELINE_STATUSID = prudentialStatus;
                    }

                }
                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return data;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        public IEnumerable<LoanClassificationViewModel> CalculateOverdraftClassification(DateTime applicationDate)

        {
            try
            {
                var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);
                var systemDate = generalSetup.GetApplicationDate();

                var data = (from a in context.TBL_LOAN_REVOLVING
                            join b in context.TBL_LOAN_PAST_DUE on a.REVOLVINGLOANID equals b.LOANID
                            join c in context.TBL_DAY_COUNT_CONVENTION on a.DAYCOUNTCONVENTIONID equals c.DAYCOUNTCONVENTIONID
                            join d in context.TBL_SETUP_COMPANY on a.COMPANYID equals d.COMPANYID
                            where b.DATE <= DbFunctions.TruncateTime(applicationDate) && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                           && (b.CREDITAMOUNT - b.DEBITAMOUNT) <= 0
                            group b by new { b.LOANID, b.PARENT_PASTDUECODE } into groupedQ
                            select new LoanClassificationViewModel()
                            {
                                loanId = groupedQ.Key.LOANID,
                                refNo = groupedQ.Key.PARENT_PASTDUECODE,
                                amount = groupedQ.Sum(i => i.CREDITAMOUNT - i.DEBITAMOUNT),
                            }).ToList();

                foreach (var item in data)
                {

                    var pastDueDate = context.TBL_LOAN_REVOLVING.FirstOrDefault(x => x.REVOLVINGLOANID == item.loanId).NPLDATE;

                    if (pastDueDate == null && item.amount < 0)
                    {
                        TBL_LOAN_REVOLVING loanResult = (from p in context.TBL_LOAN_REVOLVING
                                                         where p.REVOLVINGLOANID == item.loanId
                                                         select p).SingleOrDefault();

                        loanResult.NPLDATE = systemDate;
                    }
                    else if (pastDueDate != null && item.amount > 0)
                    {
                        TBL_LOAN_REVOLVING loanResult = (from p in context.TBL_LOAN_REVOLVING
                                                         where p.REVOLVINGLOANID == item.loanId
                                                         select p).SingleOrDefault();

                        loanResult.NPLDATE = null;
                    }

                    else if (pastDueDate != null && item.amount < 0)
                    {
                        DateTime nplDate = (DateTime)context.TBL_LOAN_REVOLVING.FirstOrDefault(a => a.REVOLVINGLOANID == item.loanId).NPLDATE;
                        int prudentialStatus = 0;
                        if ((nplDate - applicationDate).Days <= 60)
                        {
                            prudentialStatus = (int)LoanPrudentialStatusEnum.Performing;
                        }
                        else if ((nplDate - applicationDate).Days > 60 && (nplDate - applicationDate).Days <= 90)
                        {
                            prudentialStatus = (int)LoanPrudentialStatusEnum.WatchList;
                        }
                        else if ((nplDate - applicationDate).Days > 90 && (nplDate - applicationDate).Days <= 180)
                        {
                            prudentialStatus = (int)LoanPrudentialStatusEnum.Substandard;
                        }
                        else if ((nplDate - applicationDate).Days > 180 && (nplDate - applicationDate).Days <= 360)
                        {
                            prudentialStatus = (int)LoanPrudentialStatusEnum.Doubtful;
                        }
                        else if ((nplDate - applicationDate).Days > 360)
                        {
                            prudentialStatus = (int)LoanPrudentialStatusEnum.Lost;
                        }
                        TBL_LOAN_REVOLVING loanResult = (from p in context.TBL_LOAN_REVOLVING
                                                         where p.REVOLVINGLOANID == item.loanId
                                                         select p).SingleOrDefault();

                        loanResult.EXT_PRUDENT_GUIDELINE_STATUSID = prudentialStatus;
                    }

                }
                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return data;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        public IEnumerable<CleanUpViewModel> OverdraftCleanUp(DateTime applicationDate)

        {
            try
            {
                var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);


                var data = (from a in context.TBL_LOAN_REVOLVING
                            join b in context.TBL_CASA on a.CASAACCOUNTID equals b.CASAACCOUNTID
                            join d in context.TBL_LOAN_COVENANT_DETAIL on a.REVOLVINGLOANID equals d.LOANID
                            join e in context.TBL_LOAN_COVENANT_TYPE on d.COVENANTTYPEID equals e.COVENANTTYPEID
                            where a.LOANSTATUSID == (short)LoanStatusEnum.Active
                             && d.NEXTCOVENANTDATE == DbFunctions.TruncateTime(applicationDate)
                            select new CleanUpViewModel()
                            {
                                loanId = a.REVOLVINGLOANID,
                                nextCovenantDate = d.NEXTCOVENANTDATE,
                                casaBalance = b.AVAILABLEBALANCE,
                                freqValue = (short)d.FREQUENCYTYPEID,
                                casaAccountId = b.CASAACCOUNTID,
                                branchId = a.BRANCHID,
                            }).ToList();

                foreach (var item in data)
                {
                    if (item.casaBalance < 0)
                    {
                        var casa = context.TBL_CASA.FirstOrDefault(a => a.CASAACCOUNTID == item.casaAccountId);
                        var refNo = context.TBL_LOAN_REVOLVING.FirstOrDefault(a => a.CASAACCOUNTID == item.casaAccountId);

                        CasaLienViewModel lien = new CasaLienViewModel();

                        lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lien.sourceReferenceNumber = refNo.LOANREFERENCENUMBER;
                        lien.lienAmount = item.casaBalance;
                        lien.branchId = item.branchId;
                        lien.companyId = item.companyId;
                        lien.lienTypeId = (short)LienTypeEnum.OverdraftCleanUp;
                        lien.createdBy = (int)SystemStaff.System;
                        lien.description = "lien placed due to Account did not swing to positive";

                        casaLien.PlaceLien(lien);
                    }
                    else
                    {
                        int freqValue = context.TBL_FREQUENCY_TYPE.FirstOrDefault(a => a.FREQUENCYTYPEID == item.freqValue).NUMBEROFDAYS;

                        TBL_LOAN_COVENANT_DETAIL covenantResult = (from p in context.TBL_LOAN_COVENANT_DETAIL
                                                                   where p.LOANID == item.loanId
                                                                   select p).SingleOrDefault();

                        covenantResult.NEXTCOVENANTDATE = covenantResult.NEXTCOVENANTDATE.Value.Date.AddDays(freqValue);
                    }

                }
                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return data;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        public decimal DailyAccruedInterest(DateTime startDate, DateTime endDate, decimal Amount)
        {

            decimal dailyAmount = 0;

            int daysDif = ((int)(endDate - startDate).TotalDays);

            if (Amount == 0 || daysDif == 0)
            {
                dailyAmount = 0;
            }
            else
            {

                dailyAmount = (Amount / ((int)(endDate - startDate).TotalDays));

            }


            return dailyAmount;
        }

        public int DateDiff(DateTime startDate, DateTime endDate)
        {
            int noofdays = (((int)(endDate - startDate).TotalDays));
            return noofdays;
        }

        // [OperationBehavior(TransactionScopeRequired = true)]
        public bool GetRepaymentFromStaging()
        {

            var currentDateInfo = context.TBL_FINANCECURRENTDATE.FirstOrDefault();

            //if (currentDateInfo.REFRESHSTATUS == true)
            //{
            //    throw new ConditionNotMetException("Refresh status for " + currentDateInfo.CURRENTDATE + " has already been run.");

            //}

            var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
            bool output = false;
            byte transType = 0;
            //short lienType = 0;

            TBL_CUSTOM_TRANSACTION_BULK source = new TBL_CUSTOM_TRANSACTION_BULK();
            bool postingResult = false;

            var data = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
                        where (a.AMT_COLLECTED <= a.AMT) && a.FINTRAK_FLG != "Y" && a.TRAN_TYPE != "BL"  //|| a.PSTD_FLG == "P"
                        orderby a.SID ascending
                        select new FinanceTransactionStagingViewModel()
                        {
                            batchId = a.BATCH_ID,
                            batchRefId = (int)a.BATCH_REF_ID,
                            transType = a.TRAN_TYPE,
                            flowType = a.FLOW_TYPE,
                            amount = (decimal)a.AMT,
                            debitGlAccount = a.DR_ACCT,
                            creditGlAccount = a.CR_ACCT,
                            currencyRate = (double)a.RATE,
                            currencyRateCode = a.RATE_CODE,
                            description = a.NARRATION,
                            amountCollected = (decimal)a.AMT_COLLECTED,
                            bankId = a.BANK_ID,
                            sourceReferenceNumber = a.LOAN_ACCT,
                            transactionDate = a.RCRE_DATE,

                        }).ToList();

            //int counter = 0;

            foreach (var item in data)
            {
                if (item.amountCollected > item.amount)
                {
                    item.amountCollected = item.amount;
                }



                //if (item.sourceReferenceNumber == "759-0056-0000035" && item.batchId == "5181589020" && item.batchRefId == 6)
                //{
                //    var me = "";
                //}


                //if (item.sourceReferenceNumber == "759-0056-0000035")
                //{
                //    var me = "";
                //}


                source = (from p in context.TBL_CUSTOM_TRANSACTION_BULK
                          where p.BATCHID == item.batchId && p.BATCHREFID == item.batchRefId
                          select p).FirstOrDefault();

                if (source == null)
                    continue;

                var operationType = (OperationsEnum)source.OPERATIONID;


                FinanceTransactionStagingViewModel model = new FinanceTransactionStagingViewModel();
                if (item.amountCollected < 0)
                    continue;

                //item.amountCollected != source.AMOUNTCOLLECTED &&

                model.amount = item.amount;
                model.actualAmountCollected = Math.Abs(item.amountCollected - source.AMOUNTCOLLECTED);
                model.amountDue = item.amount - item.amountCollected; //10 - 2
                model.operationId = source.OPERATIONID;
                model.description = source.DESCRIPTION;
                model.valueDate = source.VALUEDATE;
                model.transactionDate = source.VALUEDATE;
                model.currencyId = source.CURRENCYID;
                model.currencyRate = source.CURRENCYRATE;
                model.companyId = source.COMPANYID;
                model.debitGlAccountId = source.DEBITGLACCOUNTID;
                model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
                model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
                model.sourceBranchId = (short)source.SOURCEBRANCHID;
                model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
                model.creditGlAccountId = source.CREDITGLACCOUNTID;
                model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
                model.batchId = source.BATCHID;
                model.batchRefId = source.BATCHREFID;
                model.loanId = source.LOANID;
                model.flowType = source.FLOWTYPE;

                if (model.amountDue >= 0 && model.actualAmountCollected > 0) //item.amountCollected
                {

                    postingResult = financeTransaction.BulkIntegrationPosting(model);

                    if (operationType == OperationsEnum.InterestLoanRepayment)
                    {
                        transType = (byte)LoanTransactionTypeEnum.Interest;
                        var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
                        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);

                        if (loan.PASTDUEINTEREST > 0)
                        {
                            var pastDue = new TBL_LOAN_PAST_DUE
                            {
                                LOANID = (int)model.loanId,
                                PASTDUECODE = PastDueCode,
                                CREDITAMOUNT = model.actualAmountCollected,
                                DESCRIPTION = "Past Due Payment on " + model.description + " as a result of Account funded",
                                DEBITAMOUNT = 0,
                                DATE = model.transactionDate,
                                TRANSACTIONTYPEID = transType,
                                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                                PRODUCTTYPEID = product.PRODUCTTYPEID,
                            };

                            context.TBL_LOAN_PAST_DUE.Add(pastDue);

                            updateloanTablePastDueInterest(model.loanId.Value, model.actualAmountCollected * -1);
                        }
                    }

                    if (operationType == OperationsEnum.PrincipalLoanRepayment)
                    {
                        transType = (byte)LoanTransactionTypeEnum.Principal;
                        var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
                        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);

                        if (loan.PASTDUEPRINCIPAL > 0)
                        {
                            var pastDue = new TBL_LOAN_PAST_DUE
                            {
                                LOANID = (int)model.loanId,
                                PASTDUECODE = PastDueCode,
                                CREDITAMOUNT = model.actualAmountCollected,
                                DESCRIPTION = "Past Due Payment on " + model.description + " as a result of Account funded",
                                DEBITAMOUNT = 0,
                                DATE = model.transactionDate,
                                TRANSACTIONTYPEID = transType,
                                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                                PRODUCTTYPEID = product.PRODUCTTYPEID,
                            };

                            context.TBL_LOAN_PAST_DUE.Add(pastDue);

                            updateloanTablePastDuePrincipal(model.loanId.Value, model.actualAmountCollected * -1);
                        }
                    }

                    if (operationType == OperationsEnum.InterestOnPastDueInterest)
                    {
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);

                        if (loan.INTERESTONPASTDUEINTEREST > 0)
                        {
                            updateloanTableInterestOnPastDueInterest(model.loanId.Value, model.actualAmountCollected * -1);
                        }
                    }

                    if (operationType == OperationsEnum.InterestOnPastDuePrincipal)
                    {
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);

                        if (loan.INTERESTONPASTDUEPRINCIPAL > 0)
                        {
                            updateloanTableInterestOnPastDuePrincipal(model.loanId.Value, model.actualAmountCollected * -1);
                        }
                    }
                }

                if (operationType == OperationsEnum.InterestLoanRepayment || operationType == OperationsEnum.PrincipalLoanRepayment && item.amountCollected <= item.amount)
                {

                    var pastDueExist = context.TBL_LOAN_PAST_DUE.Where(x => x.LOANID == model.loanId && x.DATE == model.transactionDate && x.DEBITAMOUNT > 0).ToList();

                    if (model.amountDue <= 0)
                        model.amountDue = model.amount;

                    //List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
                    //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();

                    var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                    var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
                    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
                    var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


                    if (model.flowType == "BIF")
                    {

                        if (item.amountCollected < item.amount) //past due block
                        {
                            transType = (byte)LoanTransactionTypeEnum.Interest;
                            //lienType = (short)LienTypeEnum.InterestRepayment;

                            var pastDueCount = pastDueExist.Where(x => x.TRANSACTIONTYPEID == transType).Count();
                            if (pastDueCount > 0)
                                continue;

                            var pastDue = new TBL_LOAN_PAST_DUE
                            {
                                LOANID = (int)model.loanId,
                                PASTDUECODE = PastDueCode,
                                CREDITAMOUNT = 0,
                                DESCRIPTION = "Past Due Entries on " + model.description + " as a result of Account not funded",
                                DEBITAMOUNT = Math.Abs(model.amountDue),
                                DATE = model.transactionDate,
                                TRANSACTIONTYPEID = transType,
                                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                                PRODUCTTYPEID = product.PRODUCTTYPEID,
                            };

                            context.TBL_LOAN_PAST_DUE.Add(pastDue);

                            updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT);
                        }
                    }
                    else if (model.flowType == "BPP")
                    {

                        if (item.amountCollected < item.amount) //past due block
                        {
                            transType = (byte)LoanTransactionTypeEnum.Principal;
                            //lienType = (short)LienTypeEnum.PrincipalRepayment;

                            var pastDueCount = pastDueExist.Where(x => x.TRANSACTIONTYPEID == transType).Count();
                            if (pastDueCount > 0)
                                continue;

                            var pastDue = new TBL_LOAN_PAST_DUE
                            {
                                LOANID = (int)model.loanId,
                                PASTDUECODE = PastDueCode,
                                CREDITAMOUNT = 0,
                                DESCRIPTION = "Past Due Entries on " + model.description + " as a result of Account not funded",
                                DEBITAMOUNT = Math.Abs(model.amountDue),
                                DATE = model.transactionDate,
                                TRANSACTIONTYPEID = transType,
                                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                                PRODUCTTYPEID = product.PRODUCTTYPEID,
                            };

                            context.TBL_LOAN_PAST_DUE.Add(pastDue);

                            updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);
                        }
                    }

                    if (item.amountCollected < item.amount) //past due block
                    {
                        updateloanPastDueDate((int)model.loanId, item.transactionDate);
                    }
                }


                source.AMOUNTCOLLECTED = item.amountCollected;



                context.SaveChanges();

                if (model.operationId == (int)OperationsEnum.CommercialLoanRollOver) ///TODO check this logic later
                {
                    var loan = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == model.sourceReferenceNumber);
                    var instruction = context.TBL_LOAN_MATURITY_INSTRUCTION.FirstOrDefault(x => x.LOANID == loan.TERMLOANID);

                    ArchiveLoan(loan.TERMLOANID, model.operationId, archiveBatchCode);//change to method that will disburs new loan

                }

                if (postingResult == true)
                {
                    if (source.AMOUNT == item.amountCollected)
                    {
                        source.ISPOSTED = true;

                        FINTRAK_TRAN_PROC_DETAILS bulk = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
                                                          where a.BATCH_ID == model.batchId && a.BATCH_REF_ID
                                                            == model.batchRefId
                                                          select a).FirstOrDefault();
                        bulk.FINTRAK_FLG = "Y";
                    }

                }

                output = stagingContext.SaveChanges() > 0;


                //FinanceTransactionStagingViewModel model = new FinanceTransactionStagingViewModel();
                //if (item.amountCollected != 0 && LoanPayment == 0)
                //{
                //    model.actualAmount = item.amountCollected - source.AMOUNTCOLLECTED;
                //    model.operationId = source.OPERATIONID;
                //    model.description = source.DESCRIPTION;
                //    model.valueDate = source.VALUEDATE;
                //    model.transactionDate = source.VALUEDATE;
                //    model.currencyId = source.CURRENCYID;
                //    model.currencyRate = source.CURRENCYRATE;
                //    model.companyId = source.COMPANYID;
                //    model.debitGlAccountId = source.DEBITGLACCOUNTID;
                //    model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
                //    model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
                //    model.sourceBranchId = (short)source.SOURCEBRANCHID;
                //    model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
                //    model.creditGlAccountId = source.CREDITGLACCOUNTID;
                //    model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
                //    model.batchId = source.BATCHID;
                //    model.batchRefId = source.BATCHREFID;
                //    model.loanId = source.LOANID;
                //    model.flowType = source.FLOWTYPE;

                //    postingResult = financeTransaction.BulkIntegrationPosting(model);

                //    if (model.flowType == "BIF")
                //    {
                //        updateloanTableInterest((int)model.loanId, model.actualAmount);
                //    }
                //    else if (model.flowType == "BPP")
                //    {
                //        updateloanTablePrincipal((int)model.loanId, model.actualAmount);
                //    }

                //    source.AMOUNTCOLLECTED = item.amountCollected;

                //    context.SaveChanges();

                //    if (model.operationId == (int)OperationsEnum.CommercialLoanRollOver)
                //    {
                //        var loan = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == model.sourceReferenceNumber);
                //        var instruction = context.TBL_LOAN_MATURITY_INSTRUCTION.FirstOrDefault(x => x.LOANID == loan.TERMLOANID);

                //        ArchiveLoan(loan.TERMLOANID, model.operationId, archiveBatchCode);//change to method that will disburs new loan

                //    }
                //    if (postingResult == true)
                //    {
                //        if (source.AMOUNT == item.amountCollected)
                //        {
                //            source.ISPOSTED = true;

                //            FINTRAK_TRAN_PROC_DETAILS bulk = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
                //                                              where a.BATCH_ID == model.batchId && a.BATCH_REF_ID
                //                                                == model.batchRefId
                //                                              select a).SingleOrDefault();
                //            bulk.FINTRAK_FLG = "Y";
                //        }

                //    }
                //    output = stagingContext.SaveChanges() > 0;
                //}



                //else if (item.amountCollected != 0 && fullAmount != 0)
                //{
                //    model.actualAmount = item.amountCollected - source.AMOUNTCOLLECTED;
                //    model.operationId = source.OPERATIONID;
                //    model.description = source.DESCRIPTION;
                //    model.valueDate = source.VALUEDATE;
                //    model.transactionDate = source.VALUEDATE;
                //    model.currencyId = source.CURRENCYID;
                //    model.currencyRate = source.CURRENCYRATE;
                //    model.companyId = source.COMPANYID;
                //    model.debitGlAccountId = source.DEBITGLACCOUNTID;
                //    model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
                //    model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
                //    model.sourceBranchId = (short)source.SOURCEBRANCHID;
                //    model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
                //    model.creditGlAccountId = source.CREDITGLACCOUNTID;
                //    model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
                //    model.batchId = source.BATCHID;
                //    model.batchRefId = source.BATCHREFID;
                //    model.loanId = source.LOANID;
                //    model.flowType = source.FLOWTYPE;

                //    if (model.actualAmount > 0)
                //    {
                //        postingResult = financeTransaction.BulkIntegrationPosting(model);

                //        if (operationType == OperationsEnum.InterestPastDueLoanRepayment || operationType == OperationsEnum.PrincipalPastDueLoanRepayment)
                //        {

                //            List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
                //            //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();
                //            var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                //            var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
                //            var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
                //            var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


                //            if (model.flowType == "BIF")
                //            {

                //                transType = (byte)LoanTransactionTypeEnum.Interest;
                //                lienType = (short)LienTypeEnum.InterestRepayment;

                //                updateloanTableInterest((int)model.loanId, model.actualAmount);

                //                var pastDue = new TBL_LOAN_PAST_DUE
                //                {
                //                    LOANID = (int)model.loanId,
                //                    PASTDUECODE = PastDueCode,
                //                    CREDITAMOUNT = 0,
                //                    DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
                //                    DEBITAMOUNT = Math.Abs(model.actualAmount),
                //                    DATE = model.transactionDate,
                //                    TRANSACTIONTYPEID = transType,
                //                    PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                //                    PRODUCTTYPEID = product.PRODUCTTYPEID,
                //                };

                //                transPastDue.Add(pastDue);

                //                updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT * -1);
                //            }
                //            else if (model.flowType == "BPP")
                //            {
                //                transType = (byte)LoanTransactionTypeEnum.Principal;
                //                lienType = (short)LienTypeEnum.PrincipalRepayment;

                //                updateloanTablePrincipal((int)model.loanId, model.actualAmount);

                //                var pastDue = new TBL_LOAN_PAST_DUE
                //                {
                //                    LOANID = (int)model.loanId,
                //                    PASTDUECODE = PastDueCode,
                //                    CREDITAMOUNT = 0,
                //                    DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
                //                    DEBITAMOUNT = Math.Abs(model.actualAmount),
                //                    DATE = model.transactionDate,
                //                    TRANSACTIONTYPEID = transType,
                //                    PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                //                    PRODUCTTYPEID = product.PRODUCTTYPEID,
                //                };

                //                transPastDue.Add(pastDue);

                //                updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT * -1);
                //            }

                //            updateloanPastDueDate((int)model.loanId, item.transactionDate);
                //        }

                //        //pastDue.LOANID = (int)item.loanId;
                //        //pastDue.PARENT_PASTDUECODE = PastDueCode;
                //        //pastDue.CREDITAMOUNT = 0;
                //        //pastDue.DESCRIPTION = "Past Due Entries on " + source.DESCRIPTION + "as a result of Account not funded";
                //        //pastDue.DEBITAMOUNT = Math.Abs(partailAmount);
                //        //pastDue.DATE = item.transactionDate;
                //        //pastDue.TRANSACTIONTYPEID = transType;
                //        //pastDue.PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER;
                //        //pastDue.PRODUCTTYPEID = product.PRODUCTTYPEID;

                //        //transPastDue.Add(pastDue);
                //        //updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);



                //        //CasaLienViewModel lien = new CasaLienViewModel();

                //        //lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                //        //lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
                //        //lien.lienAmount = pastDue.DEBITAMOUNT;
                //        //lien.branchId = item.branchId;
                //        //lien.companyId = item.companyId;
                //        //lien.lienTypeId = lienType;
                //        //lien.createdBy = (int)SystemStaff.System;
                //        //lien.description = "lien placed due to Account not funded at Anniversary Date";

                //        //casaLien.PlaceLien(lien);

                //        source.AMOUNTCOLLECTED = item.amountCollected;
                //        context.SaveChanges();
                //    }


                //}
                //else if (item.amountCollected == 0)
                //{

                //    model.actualAmount = 0;
                //    model.operationId = source.OPERATIONID;
                //    model.description = source.DESCRIPTION;
                //    model.valueDate = source.VALUEDATE;
                //    model.transactionDate = source.VALUEDATE;
                //    model.currencyId = source.CURRENCYID;
                //    model.currencyRate = source.CURRENCYRATE;
                //    model.companyId = source.COMPANYID;
                //    model.debitGlAccountId = source.DEBITGLACCOUNTID;
                //    model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
                //    model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
                //    model.sourceBranchId = (short)source.SOURCEBRANCHID;
                //    model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
                //    model.creditGlAccountId = source.CREDITGLACCOUNTID;
                //    model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
                //    model.batchId = source.BATCHID;
                //    model.batchRefId = source.BATCHREFID;
                //    model.loanId = source.LOANID;
                //    model.flowType = source.FLOWTYPE;

                //    if (operationType == OperationsEnum.InterestPastDueLoanRepayment || operationType == OperationsEnum.PrincipalPastDueLoanRepayment)
                //    {
                //        List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
                //        //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();
                //        var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                //        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
                //        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
                //        var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


                //        if (model.flowType == "BIF")
                //        {
                //            transType = (byte)LoanTransactionTypeEnum.Interest;
                //            lienType = (short)LienTypeEnum.InterestRepayment;
                //            var pastDue = new TBL_LOAN_PAST_DUE
                //            {
                //                LOANID = (int)model.loanId,
                //                PASTDUECODE = PastDueCode,
                //                CREDITAMOUNT = 0,
                //                DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
                //                DEBITAMOUNT = Math.Abs(partailAmount),
                //                DATE = model.transactionDate,
                //                TRANSACTIONTYPEID = transType,
                //                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                //                PRODUCTTYPEID = product.PRODUCTTYPEID,
                //            };
                //            transPastDue.Add(pastDue);
                //            context.SaveChanges();

                //            updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT);
                //        }
                //        else if (model.flowType == "BPP")
                //        {
                //            transType = (byte)LoanTransactionTypeEnum.Principal;
                //            lienType = (short)LienTypeEnum.PrincipalRepayment;

                //            var pastDue = new TBL_LOAN_PAST_DUE
                //            {
                //                LOANID = (int)model.loanId,
                //                PASTDUECODE = PastDueCode,
                //                CREDITAMOUNT = 0,
                //                DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
                //                DEBITAMOUNT = Math.Abs(partailAmount),
                //                DATE = model.transactionDate,
                //                TRANSACTIONTYPEID = transType,
                //                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                //                PRODUCTTYPEID = product.PRODUCTTYPEID,
                //            };

                //            transPastDue.Add(pastDue);
                //            context.SaveChanges();

                //            updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);
                //        }



                //        updateloanPastDueDate((int)model.loanId, model.transactionDate);
                //    }
                //    //CasaLienViewModel lien = new CasaLienViewModel();
                //    //lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                //    //lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
                //    //lien.lienAmount = pastDue.DEBITAMOUNT;
                //    //lien.branchId = item.branchId;
                //    //lien.companyId = item.companyId;
                //    //lien.lienTypeId = lienType;
                //    //lien.createdBy = (int)SystemStaff.System;
                //    //lien.description = "lien placed due to Account not funded at Anniversary Date";

                //    //casaLien.PlaceLien(lien);
                //    //source.AMOUNTCOLLECTED = item.amountCollected;
                //    context.SaveChanges();
                //}


                //}


            }



            currentDateInfo.REFRESHSTATUS = true;

            currentDateInfo.LASTEODREFRESHDATETIME = DateTime.Now;

            context.SaveChanges();

            GetRepaymentFromStagingBL();

            return true;
        }

        //public bool GetRepaymentFromStagingBLNew()
        //{

        //    var currentDateInfo = context.TBL_FINANCECURRENTDATE.FirstOrDefault();

        //    //if (currentDateInfo.REFRESHSTATUS == true)
        //    //{
        //    //    throw new ConditionNotMetException("Refresh status for " + currentDateInfo.CURRENTDATE + " has already been run.");

        //    //}

        //    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
        //    bool output = false;
        //    byte transType = 0;
        //    //short lienType = 0;

        //    TBL_CUSTOM_TRANSACTION_BULK source = new TBL_CUSTOM_TRANSACTION_BULK();
        //    bool postingResult = false;


        //    var finacleRecords = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
        //                where a.FINTRAK_FLG != "Y" && a.TRAN_TYPE != "BL"  //|| a.PSTD_FLG == "P"
        //                group a by new {a.FLOW_TYPE, a.LOAN_ACCT } into groupedQ
        //                //-- orderby a.SID ascending
        //                select new FinanceTransactionStagingViewModel()
        //                {
        //                   // batchId = a.BATCH_ID,
        //                   // batchRefId = (int)a.BATCH_REF_ID,
        //                   // transType = a.TRAN_TYPE,
        //                    flowType = groupedQ.Key.FLOW_TYPE,
        //                    amount = groupedQ.Sum(i => i.AMT),
        //                    //debitGlAccount = a.DR_ACCT,
        //                    //creditGlAccount = a.CR_ACCT,
        //                    //currencyRate = (double)a.RATE,
        //                    //currencyRateCode = a.RATE_CODE,
        //                    //description = a.NARRATION,
        //                    amountCollected = groupedQ.Sum(i => i.AMT_COLLECTED),
        //                    //bankId = a.BANK_ID,
        //                    sourceReferenceNumber = groupedQ.Key.LOAN_ACCT,
        //                    //transactionDate = a.RCRE_DATE,

        //                }).ToList();


        //    //var data = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
        //    //            where (a.AMT_COLLECTED <= a.AMT) && a.FINTRAK_FLG != "Y" && a.TRAN_TYPE != "BL"  //|| a.PSTD_FLG == "P"
        //    //            orderby a.SID ascending
        //    //            select new FinanceTransactionStagingViewModel()
        //    //            {
        //    //                batchId = a.BATCH_ID,
        //    //                batchRefId = (int)a.BATCH_REF_ID,
        //    //                transType = a.TRAN_TYPE,
        //    //                flowType = a.FLOW_TYPE,
        //    //                amount = (decimal)a.AMT,
        //    //                debitGlAccount = a.DR_ACCT,
        //    //                creditGlAccount = a.CR_ACCT,
        //    //                currencyRate = (double)a.RATE,
        //    //                currencyRateCode = a.RATE_CODE,
        //    //                description = a.NARRATION,
        //    //                amountCollected = (decimal)a.AMT_COLLECTED,
        //    //                bankId = a.BANK_ID,
        //    //                sourceReferenceNumber = a.LOAN_ACCT,
        //    //                transactionDate = a.RCRE_DATE,

        //    //            }).ToList();

        //    //int counter = 0;

        //    foreach (var item in finacleRecords)
        //    {
        //        if (item.amountCollected > item.amount)
        //        {
        //            item.amountCollected = item.amount;
        //        }



        //        //if (item.sourceReferenceNumber == "759-0056-0000035" && item.batchId == "5181589020" && item.batchRefId == 6)
        //        //{
        //        //    var me = "";
        //        //}


        //        //if (item.sourceReferenceNumber == "759-0056-0000035")
        //        //{
        //        //    var me = "";
        //        //}

        //        source = (
        //                  from p in context.TBL_CUSTOM_TRANSACTION_BULK
        //                  where p.FLOWTYPE == item.flowType && p.SOURCEREFERENCENUMBER == item.sourceReferenceNumber
        //                  group p by new { p.FLOWTYPE, p.SOURCEREFERENCENUMBER } into groupedQ
        //                  select new TBL_CUSTOM_TRANSACTION_BULK()//p
        //                  {
        //                      FLOWTYPE = groupedQ.Key.FLOWTYPE,
        //                      SOURCEREFERENCENUMBER = groupedQ.Key.SOURCEREFERENCENUMBER,
        //                      AMOUNT = groupedQ.Sum(i => i.AMOUNT),
        //                      AMOUNTCOLLECTED = groupedQ.Sum(i => i.AMOUNTCOLLECTED)
        //                  }
        //                  ).FirstOrDefault();

        //        //source = (
        //        //          from p in context.TBL_CUSTOM_TRANSACTION_BULK
        //        //          where p.BATCHID == item.batchId && p.BATCHREFID == item.batchRefId
        //        //          select p

        //        //          ).FirstOrDefault();

        //        if (source == null)
        //            continue;


        //        if (item.amountCollected > source.AMOUNTCOLLECTED)
        //        {
        //            decimal currentAmountCollected = item.amountCollected - source.AMOUNTCOLLECTED;

        //            var finacleItemRecords = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
        //                                     where a.FLOW_TYPE == item.flowType && a.LOAN_ACCT == item.sourceReferenceNumber
        //                                  //group a by new { a.FLOW_TYPE, a.LOAN_ACCT } into groupedQ
        //                                  //-- orderby a.SID ascending
        //                                  select new FinanceTransactionStagingViewModel()
        //                                  {
        //                                      batchId = a.BATCH_ID,
        //                                      batchRefId = (int)a.BATCH_REF_ID,
        //                                      transType = a.TRAN_TYPE,
        //                                      flowType = a.FLOW_TYPE,
        //                                      amount = (decimal)a.AMT,
        //                                      debitGlAccount = a.DR_ACCT,
        //                                      creditGlAccount = a.CR_ACCT,
        //                                      currencyRate = (double)a.RATE,
        //                                      currencyRateCode = a.RATE_CODE,
        //                                      description = a.NARRATION,
        //                                      amountCollected = (decimal)a.AMT_COLLECTED,
        //                                      bankId = a.BANK_ID,
        //                                      sourceReferenceNumber = a.LOAN_ACCT,
        //                                      transactionDate = a.RCRE_DATE,
        //                                  }).ToList();

        //        }


        //        var operationType = (OperationsEnum)source.OPERATIONID;


        //        FinanceTransactionStagingViewModel model = new FinanceTransactionStagingViewModel();
        //        if (item.amountCollected < 0)
        //            continue;

        //        //item.amountCollected != source.AMOUNTCOLLECTED &&

        //        model.amount = item.amount;
        //        model.actualAmountCollected = Math.Abs(item.amountCollected - source.AMOUNTCOLLECTED);
        //        model.amountDue = item.amount - item.amountCollected; //10 - 2
        //        model.operationId = source.OPERATIONID;
        //        model.description = source.DESCRIPTION;
        //        model.valueDate = source.VALUEDATE;
        //        model.transactionDate = source.VALUEDATE;
        //        model.currencyId = source.CURRENCYID;
        //        model.currencyRate = source.CURRENCYRATE;
        //        model.companyId = source.COMPANYID;
        //        model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //        model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //        model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //        model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //        model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //        model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //        model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //        model.batchId = source.BATCHID;
        //        model.batchRefId = source.BATCHREFID;
        //        model.loanId = source.LOANID;
        //        model.flowType = source.FLOWTYPE;

        //        if (model.amountDue >= 0 && model.actualAmountCollected > 0) //item.amountCollected
        //        {

        //            postingResult = financeTransaction.BulkIntegrationPosting(model);

        //            if (operationType == OperationsEnum.InterestLoanRepayment)
        //            {
        //                transType = (byte)LoanTransactionTypeEnum.Interest;
        //                var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //                var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);

        //                if (loan.PASTDUEINTEREST > 0)
        //                {
        //                    var pastDue = new TBL_LOAN_PAST_DUE
        //                    {
        //                        LOANID = (int)model.loanId,
        //                        PASTDUECODE = PastDueCode,
        //                        CREDITAMOUNT = model.actualAmountCollected,
        //                        DESCRIPTION = "Past Due Payment on " + model.description + " as a result of Account funded",
        //                        DEBITAMOUNT = 0,
        //                        DATE = model.transactionDate,
        //                        TRANSACTIONTYPEID = transType,
        //                        PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                        PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                    };

        //                    context.TBL_LOAN_PAST_DUE.Add(pastDue);

        //                    updateloanTablePastDueInterest(model.loanId.Value, model.actualAmountCollected * -1);
        //                }
        //            }

        //            if (operationType == OperationsEnum.PrincipalLoanRepayment)
        //            {
        //                transType = (byte)LoanTransactionTypeEnum.Principal;
        //                var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //                var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);

        //                if (loan.PASTDUEPRINCIPAL > 0)
        //                {
        //                    var pastDue = new TBL_LOAN_PAST_DUE
        //                    {
        //                        LOANID = (int)model.loanId,
        //                        PASTDUECODE = PastDueCode,
        //                        CREDITAMOUNT = model.actualAmountCollected,
        //                        DESCRIPTION = "Past Due Payment on " + model.description + " as a result of Account funded",
        //                        DEBITAMOUNT = 0,
        //                        DATE = model.transactionDate,
        //                        TRANSACTIONTYPEID = transType,
        //                        PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                        PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                    };

        //                    context.TBL_LOAN_PAST_DUE.Add(pastDue);

        //                    updateloanTablePastDuePrincipal(model.loanId.Value, model.actualAmountCollected * -1);
        //                }
        //            }

        //            if (operationType == OperationsEnum.InterestOnPastDueInterest)
        //            {
        //                var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);

        //                if (loan.INTERESTONPASTDUEINTEREST > 0)
        //                {
        //                    updateloanTableInterestOnPastDueInterest(model.loanId.Value, model.actualAmountCollected * -1);
        //                }
        //            }

        //            if (operationType == OperationsEnum.InterestOnPastDuePrincipal)
        //            {
        //                var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);

        //                if (loan.INTERESTONPASTDUEPRINCIPAL > 0)
        //                {
        //                    updateloanTableInterestOnPastDuePrincipal(model.loanId.Value, model.actualAmountCollected * -1);
        //                }
        //            }
        //        }

        //        if (operationType == OperationsEnum.InterestLoanRepayment || operationType == OperationsEnum.PrincipalLoanRepayment && item.amountCollected <= item.amount)
        //        {

        //            var pastDueExist = context.TBL_LOAN_PAST_DUE.Where(x => x.LOANID == model.loanId && x.DATE == model.transactionDate && x.DEBITAMOUNT > 0).ToList();

        //            if (model.amountDue <= 0)
        //                model.amountDue = model.amount;

        //            //List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
        //            //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();

        //            var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //            var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //            var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
        //            var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


        //            if (model.flowType == "BIF")
        //            {

        //                if (item.amountCollected < item.amount) //past due block
        //                {
        //                    transType = (byte)LoanTransactionTypeEnum.Interest;
        //                    //lienType = (short)LienTypeEnum.InterestRepayment;

        //                    var pastDueCount = pastDueExist.Where(x => x.TRANSACTIONTYPEID == transType).Count();
        //                    if (pastDueCount > 0)
        //                        continue;

        //                    var pastDue = new TBL_LOAN_PAST_DUE
        //                    {
        //                        LOANID = (int)model.loanId,
        //                        PASTDUECODE = PastDueCode,
        //                        CREDITAMOUNT = 0,
        //                        DESCRIPTION = "Past Due Entries on " + model.description + " as a result of Account not funded",
        //                        DEBITAMOUNT = Math.Abs(model.amountDue),
        //                        DATE = model.transactionDate,
        //                        TRANSACTIONTYPEID = transType,
        //                        PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                        PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                    };

        //                    context.TBL_LOAN_PAST_DUE.Add(pastDue);

        //                    updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //                }
        //            }
        //            else if (model.flowType == "BPP")
        //            {

        //                if (item.amountCollected < item.amount) //past due block
        //                {
        //                    transType = (byte)LoanTransactionTypeEnum.Principal;
        //                    //lienType = (short)LienTypeEnum.PrincipalRepayment;

        //                    var pastDueCount = pastDueExist.Where(x => x.TRANSACTIONTYPEID == transType).Count();
        //                    if (pastDueCount > 0)
        //                        continue;

        //                    var pastDue = new TBL_LOAN_PAST_DUE
        //                    {
        //                        LOANID = (int)model.loanId,
        //                        PASTDUECODE = PastDueCode,
        //                        CREDITAMOUNT = 0,
        //                        DESCRIPTION = "Past Due Entries on " + model.description + " as a result of Account not funded",
        //                        DEBITAMOUNT = Math.Abs(model.amountDue),
        //                        DATE = model.transactionDate,
        //                        TRANSACTIONTYPEID = transType,
        //                        PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                        PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                    };

        //                    context.TBL_LOAN_PAST_DUE.Add(pastDue);

        //                    updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //                }
        //            }

        //            if (item.amountCollected < item.amount) //past due block
        //            {
        //                updateloanPastDueDate((int)model.loanId, item.transactionDate);
        //            }
        //        }


        //        source.AMOUNTCOLLECTED = item.amountCollected;



        //        context.SaveChanges();

        //        if (model.operationId == (int)OperationsEnum.CommercialLoanRollOver) ///TODO check this logic later
        //        {
        //            var loan = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == model.sourceReferenceNumber);
        //            var instruction = context.TBL_LOAN_MATURITY_INSTRUCTION.FirstOrDefault(x => x.LOANID == loan.TERMLOANID);

        //            ArchiveLoan(loan.TERMLOANID, model.operationId, archiveBatchCode);//change to method that will disburs new loan

        //        }

        //        if (postingResult == true)
        //        {
        //            if (source.AMOUNT == item.amountCollected)
        //            {
        //                source.ISPOSTED = true;

        //                FINTRAK_TRAN_PROC_DETAILS bulk = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
        //                                                  where a.BATCH_ID == model.batchId && a.BATCH_REF_ID
        //                                                    == model.batchRefId
        //                                                  select a).FirstOrDefault();
        //                bulk.FINTRAK_FLG = "Y";
        //            }

        //        }

        //        output = stagingContext.SaveChanges() > 0;


        //        //FinanceTransactionStagingViewModel model = new FinanceTransactionStagingViewModel();
        //        //if (item.amountCollected != 0 && LoanPayment == 0)
        //        //{
        //        //    model.actualAmount = item.amountCollected - source.AMOUNTCOLLECTED;
        //        //    model.operationId = source.OPERATIONID;
        //        //    model.description = source.DESCRIPTION;
        //        //    model.valueDate = source.VALUEDATE;
        //        //    model.transactionDate = source.VALUEDATE;
        //        //    model.currencyId = source.CURRENCYID;
        //        //    model.currencyRate = source.CURRENCYRATE;
        //        //    model.companyId = source.COMPANYID;
        //        //    model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //        //    model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //        //    model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //        //    model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //        //    model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //        //    model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //        //    model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //        //    model.batchId = source.BATCHID;
        //        //    model.batchRefId = source.BATCHREFID;
        //        //    model.loanId = source.LOANID;
        //        //    model.flowType = source.FLOWTYPE;

        //        //    postingResult = financeTransaction.BulkIntegrationPosting(model);

        //        //    if (model.flowType == "BIF")
        //        //    {
        //        //        updateloanTableInterest((int)model.loanId, model.actualAmount);
        //        //    }
        //        //    else if (model.flowType == "BPP")
        //        //    {
        //        //        updateloanTablePrincipal((int)model.loanId, model.actualAmount);
        //        //    }

        //        //    source.AMOUNTCOLLECTED = item.amountCollected;

        //        //    context.SaveChanges();

        //        //    if (model.operationId == (int)OperationsEnum.CommercialLoanRollOver)
        //        //    {
        //        //        var loan = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == model.sourceReferenceNumber);
        //        //        var instruction = context.TBL_LOAN_MATURITY_INSTRUCTION.FirstOrDefault(x => x.LOANID == loan.TERMLOANID);

        //        //        ArchiveLoan(loan.TERMLOANID, model.operationId, archiveBatchCode);//change to method that will disburs new loan

        //        //    }
        //        //    if (postingResult == true)
        //        //    {
        //        //        if (source.AMOUNT == item.amountCollected)
        //        //        {
        //        //            source.ISPOSTED = true;

        //        //            FINTRAK_TRAN_PROC_DETAILS bulk = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
        //        //                                              where a.BATCH_ID == model.batchId && a.BATCH_REF_ID
        //        //                                                == model.batchRefId
        //        //                                              select a).SingleOrDefault();
        //        //            bulk.FINTRAK_FLG = "Y";
        //        //        }

        //        //    }
        //        //    output = stagingContext.SaveChanges() > 0;
        //        //}



        //        //else if (item.amountCollected != 0 && fullAmount != 0)
        //        //{
        //        //    model.actualAmount = item.amountCollected - source.AMOUNTCOLLECTED;
        //        //    model.operationId = source.OPERATIONID;
        //        //    model.description = source.DESCRIPTION;
        //        //    model.valueDate = source.VALUEDATE;
        //        //    model.transactionDate = source.VALUEDATE;
        //        //    model.currencyId = source.CURRENCYID;
        //        //    model.currencyRate = source.CURRENCYRATE;
        //        //    model.companyId = source.COMPANYID;
        //        //    model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //        //    model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //        //    model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //        //    model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //        //    model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //        //    model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //        //    model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //        //    model.batchId = source.BATCHID;
        //        //    model.batchRefId = source.BATCHREFID;
        //        //    model.loanId = source.LOANID;
        //        //    model.flowType = source.FLOWTYPE;

        //        //    if (model.actualAmount > 0)
        //        //    {
        //        //        postingResult = financeTransaction.BulkIntegrationPosting(model);

        //        //        if (operationType == OperationsEnum.InterestPastDueLoanRepayment || operationType == OperationsEnum.PrincipalPastDueLoanRepayment)
        //        //        {

        //        //            List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
        //        //            //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();
        //        //            var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //        //            var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //        //            var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
        //        //            var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


        //        //            if (model.flowType == "BIF")
        //        //            {

        //        //                transType = (byte)LoanTransactionTypeEnum.Interest;
        //        //                lienType = (short)LienTypeEnum.InterestRepayment;

        //        //                updateloanTableInterest((int)model.loanId, model.actualAmount);

        //        //                var pastDue = new TBL_LOAN_PAST_DUE
        //        //                {
        //        //                    LOANID = (int)model.loanId,
        //        //                    PASTDUECODE = PastDueCode,
        //        //                    CREDITAMOUNT = 0,
        //        //                    DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //        //                    DEBITAMOUNT = Math.Abs(model.actualAmount),
        //        //                    DATE = model.transactionDate,
        //        //                    TRANSACTIONTYPEID = transType,
        //        //                    PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //        //                    PRODUCTTYPEID = product.PRODUCTTYPEID,
        //        //                };

        //        //                transPastDue.Add(pastDue);

        //        //                updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT * -1);
        //        //            }
        //        //            else if (model.flowType == "BPP")
        //        //            {
        //        //                transType = (byte)LoanTransactionTypeEnum.Principal;
        //        //                lienType = (short)LienTypeEnum.PrincipalRepayment;

        //        //                updateloanTablePrincipal((int)model.loanId, model.actualAmount);

        //        //                var pastDue = new TBL_LOAN_PAST_DUE
        //        //                {
        //        //                    LOANID = (int)model.loanId,
        //        //                    PASTDUECODE = PastDueCode,
        //        //                    CREDITAMOUNT = 0,
        //        //                    DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //        //                    DEBITAMOUNT = Math.Abs(model.actualAmount),
        //        //                    DATE = model.transactionDate,
        //        //                    TRANSACTIONTYPEID = transType,
        //        //                    PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //        //                    PRODUCTTYPEID = product.PRODUCTTYPEID,
        //        //                };

        //        //                transPastDue.Add(pastDue);

        //        //                updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT * -1);
        //        //            }

        //        //            updateloanPastDueDate((int)model.loanId, item.transactionDate);
        //        //        }

        //        //        //pastDue.LOANID = (int)item.loanId;
        //        //        //pastDue.PARENT_PASTDUECODE = PastDueCode;
        //        //        //pastDue.CREDITAMOUNT = 0;
        //        //        //pastDue.DESCRIPTION = "Past Due Entries on " + source.DESCRIPTION + "as a result of Account not funded";
        //        //        //pastDue.DEBITAMOUNT = Math.Abs(partailAmount);
        //        //        //pastDue.DATE = item.transactionDate;
        //        //        //pastDue.TRANSACTIONTYPEID = transType;
        //        //        //pastDue.PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER;
        //        //        //pastDue.PRODUCTTYPEID = product.PRODUCTTYPEID;

        //        //        //transPastDue.Add(pastDue);
        //        //        //updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);



        //        //        //CasaLienViewModel lien = new CasaLienViewModel();

        //        //        //lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
        //        //        //lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
        //        //        //lien.lienAmount = pastDue.DEBITAMOUNT;
        //        //        //lien.branchId = item.branchId;
        //        //        //lien.companyId = item.companyId;
        //        //        //lien.lienTypeId = lienType;
        //        //        //lien.createdBy = (int)SystemStaff.System;
        //        //        //lien.description = "lien placed due to Account not funded at Anniversary Date";

        //        //        //casaLien.PlaceLien(lien);

        //        //        source.AMOUNTCOLLECTED = item.amountCollected;
        //        //        context.SaveChanges();
        //        //    }


        //        //}
        //        //else if (item.amountCollected == 0)
        //        //{

        //        //    model.actualAmount = 0;
        //        //    model.operationId = source.OPERATIONID;
        //        //    model.description = source.DESCRIPTION;
        //        //    model.valueDate = source.VALUEDATE;
        //        //    model.transactionDate = source.VALUEDATE;
        //        //    model.currencyId = source.CURRENCYID;
        //        //    model.currencyRate = source.CURRENCYRATE;
        //        //    model.companyId = source.COMPANYID;
        //        //    model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //        //    model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //        //    model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //        //    model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //        //    model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //        //    model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //        //    model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //        //    model.batchId = source.BATCHID;
        //        //    model.batchRefId = source.BATCHREFID;
        //        //    model.loanId = source.LOANID;
        //        //    model.flowType = source.FLOWTYPE;

        //        //    if (operationType == OperationsEnum.InterestPastDueLoanRepayment || operationType == OperationsEnum.PrincipalPastDueLoanRepayment)
        //        //    {
        //        //        List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
        //        //        //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();
        //        //        var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //        //        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //        //        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
        //        //        var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


        //        //        if (model.flowType == "BIF")
        //        //        {
        //        //            transType = (byte)LoanTransactionTypeEnum.Interest;
        //        //            lienType = (short)LienTypeEnum.InterestRepayment;
        //        //            var pastDue = new TBL_LOAN_PAST_DUE
        //        //            {
        //        //                LOANID = (int)model.loanId,
        //        //                PASTDUECODE = PastDueCode,
        //        //                CREDITAMOUNT = 0,
        //        //                DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //        //                DEBITAMOUNT = Math.Abs(partailAmount),
        //        //                DATE = model.transactionDate,
        //        //                TRANSACTIONTYPEID = transType,
        //        //                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //        //                PRODUCTTYPEID = product.PRODUCTTYPEID,
        //        //            };
        //        //            transPastDue.Add(pastDue);
        //        //            context.SaveChanges();

        //        //            updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //        //        }
        //        //        else if (model.flowType == "BPP")
        //        //        {
        //        //            transType = (byte)LoanTransactionTypeEnum.Principal;
        //        //            lienType = (short)LienTypeEnum.PrincipalRepayment;

        //        //            var pastDue = new TBL_LOAN_PAST_DUE
        //        //            {
        //        //                LOANID = (int)model.loanId,
        //        //                PASTDUECODE = PastDueCode,
        //        //                CREDITAMOUNT = 0,
        //        //                DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //        //                DEBITAMOUNT = Math.Abs(partailAmount),
        //        //                DATE = model.transactionDate,
        //        //                TRANSACTIONTYPEID = transType,
        //        //                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //        //                PRODUCTTYPEID = product.PRODUCTTYPEID,
        //        //            };

        //        //            transPastDue.Add(pastDue);
        //        //            context.SaveChanges();

        //        //            updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //        //        }



        //        //        updateloanPastDueDate((int)model.loanId, model.transactionDate);
        //        //    }
        //        //    //CasaLienViewModel lien = new CasaLienViewModel();
        //        //    //lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
        //        //    //lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
        //        //    //lien.lienAmount = pastDue.DEBITAMOUNT;
        //        //    //lien.branchId = item.branchId;
        //        //    //lien.companyId = item.companyId;
        //        //    //lien.lienTypeId = lienType;
        //        //    //lien.createdBy = (int)SystemStaff.System;
        //        //    //lien.description = "lien placed due to Account not funded at Anniversary Date";

        //        //    //casaLien.PlaceLien(lien);
        //        //    //source.AMOUNTCOLLECTED = item.amountCollected;
        //        //    context.SaveChanges();
        //        //}


        //        //}


        //    }

        //    currentDateInfo.REFRESHSTATUS = true;

        //    currentDateInfo.LASTEODREFRESHDATETIME = DateTime.Now;

        //    context.SaveChanges();

        //    GetRepaymentFromStagingBL();

        //    return true;
        //}

        public bool GetRepaymentFromStagingBL()
        {
            var currentDateInfo = context.TBL_FINANCECURRENTDATE.FirstOrDefault();

            //if (currentDateInfo.REFRESHSTATUS == true)
            //{
            //    throw new ConditionNotMetException("Refresh status for " + currentDateInfo.CURRENTDATE + " has already been run.");

            //}

            var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
            bool output = false;
            byte transType = 0;
            //short lienType = 0;

            TBL_CUSTOM_TRANSACTION_BULK source = new TBL_CUSTOM_TRANSACTION_BULK();
            bool postingResult = false;

            //var data = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
            //            where (a.AMT_COLLECTED <= a.AMT) && a.FINTRAK_FLG != "Y" && a.TRAN_TYPE == "BL"  //|| a.PSTD_FLG == "P"
            //            orderby a.SID ascending
            //            select new FinanceTransactionStagingViewModel()
            //            {
            //                batchId = a.BATCH_ID,
            //                batchRefId = (int)a.BATCH_REF_ID,
            //                transType = a.TRAN_TYPE,
            //                flowType = a.FLOW_TYPE,
            //                amount = (decimal)a.AMT,
            //                debitGlAccount = a.DR_ACCT,
            //                creditGlAccount = a.CR_ACCT,
            //                currencyRate = (double)a.RATE,
            //                currencyRateCode = a.RATE_CODE,
            //                description = a.NARRATION,
            //                amountCollected = (decimal)a.AMT_COLLECTED,
            //                bankId = a.BANK_ID,
            //                sourceReferenceNumber = a.LOAN_ACCT,
            //                transactionDate = a.RCRE_DATE,

            //            }).ToList();

            var data = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
                        where
                        //(a.AMT_COLLECTED <= a.AMT) && 
                        a.FINTRAK_FLG != "Y" && a.TRAN_TYPE == "BL"  //|| a.PSTD_FLG == "P"
                        orderby a.SID ascending
                        select new FinanceTransactionStagingViewModel()
                        {
                            sid = a.SID,
                            batchId = a.BATCH_ID,
                            batchRefId = (int)a.BATCH_REF_ID,
                            transType = a.TRAN_TYPE,
                            flowType = a.FLOW_TYPE,
                            amount = (decimal)a.AMT,
                            debitGlAccount = a.DR_ACCT,
                            creditGlAccount = a.CR_ACCT,
                            currencyRate = (double)a.RATE,
                            currencyRateCode = a.RATE_CODE,
                            description = a.NARRATION,
                            amountCollected = (decimal)a.AMT_COLLECTED,
                            bankId = a.BANK_ID,
                            sourceReferenceNumber = a.LOAN_ACCT,
                            transactionDate = a.RCRE_DATE,
                            lienAmount = a.LIEN_AMT,

                        }).ToList();

            //int counter = 0;

            foreach (var item in data)
            {

                decimal previouceLienAmount = 0;

                decimal previouceCurrentCompare = stagingContext.FINTRAK_TRAN_PROC_DETAILS.Where(x => x.FINTRAK_FLG != "Y" && x.TRAN_TYPE == "BL" && x.NARRATION == item.description && x.LOAN_ACCT == item.sourceReferenceNumber && x.SID <= item.sid).Sum(x => x.AMT - x.AMT_COLLECTED);

                if (previouceCurrentCompare == 0)
                {
                    previouceCurrentCompare = 0;
                }

                var previouceRecord = stagingContext.FINTRAK_TRAN_PROC_DETAILS.Where(x => x.FINTRAK_FLG != "Y" && x.TRAN_TYPE == "BL" && x.NARRATION == item.description && x.LOAN_ACCT == item.sourceReferenceNumber && x.SID < item.sid).OrderByDescending(x => x.SID).Take(1).FirstOrDefault();

                if (previouceRecord == null)
                {
                    previouceLienAmount = 0;
                }
                else
                {
                    previouceLienAmount = previouceRecord.LIEN_AMT;
                }


                if (item.actualAmountCollected == 0 && item.lienAmount == 0)
                {
                    item.amountCollected = 0;
                }
                else
                {
                    item.amountCollected = item.amount + previouceLienAmount - item.lienAmount;
                }



                ////if (item.amountCollected > item.amount)
                ////{
                ////    item.amountCollected = item.amount;
                ////}



                //if (item.sourceReferenceNumber == "759-0056-0000035" && item.batchId == "5181589020" && item.batchRefId == 6)
                //{
                //    var me = "";
                //}


                //if (item.sourceReferenceNumber == "759-0056-0000035")
                //{
                //    var me = "";
                //}


                source = (from p in context.TBL_CUSTOM_TRANSACTION_BULK
                          where p.BATCHID == item.batchId && p.BATCHREFID == item.batchRefId
                          select p).FirstOrDefault();


                if (source == null)
                    continue;


                var operationType = (OperationsEnum)source.OPERATIONID;


                FinanceTransactionStagingViewModel model = new FinanceTransactionStagingViewModel();
                if (item.amountCollected < 0)
                    continue;

                //item.amountCollected != source.AMOUNTCOLLECTED &&

                model.amount = item.amount;
                ////model.actualAmountCollected = Math.Abs(item.amountCollected - source.AMOUNTCOLLECTED);
                model.actualAmountCollected = item.amountCollected;
                ////model.amountDue = item.amount - item.amountCollected; //10 - 2
                model.amountDue = item.amount + previouceLienAmount - item.amountCollected;
                model.operationId = source.OPERATIONID;
                model.description = source.DESCRIPTION;
                model.valueDate = source.VALUEDATE;
                model.transactionDate = source.VALUEDATE;
                model.currencyId = source.CURRENCYID;
                model.currencyRate = source.CURRENCYRATE;
                model.companyId = source.COMPANYID;
                model.debitGlAccountId = source.DEBITGLACCOUNTID;
                model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
                model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
                model.sourceBranchId = (short)source.SOURCEBRANCHID;
                model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
                model.creditGlAccountId = source.CREDITGLACCOUNTID;
                model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
                model.batchId = source.BATCHID;
                model.batchRefId = source.BATCHREFID;
                model.loanId = source.LOANID;
                model.flowType = source.FLOWTYPE;

                if (model.amountDue >= 0 && model.actualAmountCollected > 0) //item.amountCollected
                {

                    postingResult = financeTransaction.BulkIntegrationPosting(model);

                    if (operationType == OperationsEnum.InterestLoanRepayment)
                    {
                        transType = (byte)LoanTransactionTypeEnum.Interest;
                        var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
                        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);

                        if (loan.PASTDUEINTEREST > 0)
                        {
                            var pastDue = new TBL_LOAN_PAST_DUE
                            {
                                LOANID = (int)model.loanId,
                                PASTDUECODE = PastDueCode,
                                CREDITAMOUNT = model.actualAmountCollected,
                                DESCRIPTION = "Past Due Payment on " + model.description + " as a result of Account funded",
                                DEBITAMOUNT = 0,
                                DATE = model.transactionDate,
                                TRANSACTIONTYPEID = transType,
                                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                                PRODUCTTYPEID = product.PRODUCTTYPEID,
                            };

                            context.TBL_LOAN_PAST_DUE.Add(pastDue);

                            updateloanTablePastDueInterest(model.loanId.Value, model.actualAmountCollected * -1);
                        }
                    }

                    if (operationType == OperationsEnum.PrincipalLoanRepayment)
                    {
                        transType = (byte)LoanTransactionTypeEnum.Principal;
                        var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
                        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);

                        if (loan.PASTDUEPRINCIPAL > 0)
                        {
                            var pastDue = new TBL_LOAN_PAST_DUE
                            {
                                LOANID = (int)model.loanId,
                                PASTDUECODE = PastDueCode,
                                CREDITAMOUNT = model.actualAmountCollected,
                                DESCRIPTION = "Past Due Payment on " + model.description + " as a result of Account funded",
                                DEBITAMOUNT = 0,
                                DATE = model.transactionDate,
                                TRANSACTIONTYPEID = transType,
                                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                                PRODUCTTYPEID = product.PRODUCTTYPEID,
                            };

                            context.TBL_LOAN_PAST_DUE.Add(pastDue);

                            updateloanTablePastDuePrincipal(model.loanId.Value, model.actualAmountCollected * -1);
                        }
                    }

                    if (operationType == OperationsEnum.InterestOnPastDueInterest)
                    {
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);

                        if (loan.INTERESTONPASTDUEINTEREST > 0)
                        {
                            updateloanTableInterestOnPastDueInterest(model.loanId.Value, model.actualAmountCollected * -1);
                        }
                    }

                    if (operationType == OperationsEnum.InterestOnPastDuePrincipal)
                    {
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);

                        if (loan.INTERESTONPASTDUEPRINCIPAL > 0)
                        {
                            updateloanTableInterestOnPastDuePrincipal(model.loanId.Value, model.actualAmountCollected * -1);
                        }
                    }
                }

                ////if (operationType == OperationsEnum.InterestLoanRepayment || operationType == OperationsEnum.PrincipalLoanRepayment && item.amountCollected <= item.amount)
                if (operationType == OperationsEnum.InterestLoanRepayment || operationType == OperationsEnum.PrincipalLoanRepayment)
                {

                    var pastDueExist = context.TBL_LOAN_PAST_DUE.Where(x => x.LOANID == model.loanId && x.DATE == model.transactionDate && x.DEBITAMOUNT > 0).ToList();

                    ////if (model.amountDue <= 0)
                    ////    model.amountDue = model.amount;

                    //List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
                    //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();

                    var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                    var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
                    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
                    var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


                    if (model.flowType == "BIF")
                    {

                        ////if (item.amountCollected < item.amount) //past due block
                        if (model.amountDue > 0) //past due block
                        {
                            transType = (byte)LoanTransactionTypeEnum.Interest;
                            //lienType = (short)LienTypeEnum.InterestRepayment;

                            var pastDueCount = pastDueExist.Where(x => x.TRANSACTIONTYPEID == transType).Count();
                            if (pastDueCount > 0)
                                continue;

                            var pastDue = new TBL_LOAN_PAST_DUE
                            {
                                LOANID = (int)model.loanId,
                                PASTDUECODE = PastDueCode,
                                CREDITAMOUNT = 0,
                                DESCRIPTION = "Past Due Entries on " + model.description + " as a result of Account not funded",
                                DEBITAMOUNT = Math.Abs(model.amountDue),
                                DATE = model.transactionDate,
                                TRANSACTIONTYPEID = transType,
                                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                                PRODUCTTYPEID = product.PRODUCTTYPEID,
                            };

                            context.TBL_LOAN_PAST_DUE.Add(pastDue);

                            updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT);
                        }
                    }
                    else if (model.flowType == "BPP")
                    {

                        ////if (item.amountCollected < item.amount) //past due block
                        if (model.amountDue > 0)
                        {
                            transType = (byte)LoanTransactionTypeEnum.Principal;
                            //lienType = (short)LienTypeEnum.PrincipalRepayment;

                            var pastDueCount = pastDueExist.Where(x => x.TRANSACTIONTYPEID == transType).Count();
                            if (pastDueCount > 0)
                                continue;

                            var pastDue = new TBL_LOAN_PAST_DUE
                            {
                                LOANID = (int)model.loanId,
                                PASTDUECODE = PastDueCode,
                                CREDITAMOUNT = 0,
                                DESCRIPTION = "Past Due Entries on " + model.description + " as a result of Account not funded",
                                DEBITAMOUNT = Math.Abs(model.amountDue),
                                DATE = model.transactionDate,
                                TRANSACTIONTYPEID = transType,
                                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
                                PRODUCTTYPEID = product.PRODUCTTYPEID,
                            };

                            context.TBL_LOAN_PAST_DUE.Add(pastDue);

                            updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);
                        }
                    }

                    ////if (item.amountCollected < item.amount) //past due block
                    if (model.amountDue > 0)
                    {
                        updateloanPastDueDate((int)model.loanId, item.transactionDate);
                    }
                }


                source.AMOUNTCOLLECTED = item.amountCollected;



                context.SaveChanges();

                //if (model.operationId == (int)OperationsEnum.CommercialLoanRollOver) ///TODO check this logic later
                //{
                //    var loan = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == model.sourceReferenceNumber);
                //    var instruction = context.TBL_LOAN_MATURITY_INSTRUCTION.FirstOrDefault(x => x.LOANID == loan.TERMLOANID);

                //    ArchiveLoan(loan.TERMLOANID, model.operationId, archiveBatchCode);//change to method that will disburs new loan

                //}

                if (postingResult == true)
                {
                    ////if (source.AMOUNT == item.amountCollected)
                    ////{
                    ////    source.ISPOSTED = true;

                    ////    FINTRAK_TRAN_PROC_DETAILS bulk = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
                    ////                                      where a.BATCH_ID == model.batchId && a.BATCH_REF_ID
                    ////                                        == model.batchRefId
                    ////                                      select a).FirstOrDefault();
                    ////    bulk.FINTRAK_FLG = "Y";
                    ////}

                    if (previouceCurrentCompare == 0)
                    {
                        ////source.ISPOSTED = true;
                        //// source = (from p in context.TBL_CUSTOM_TRANSACTION_BULK
                        //// where p.BATCHID == item.batchId && p.BATCHREFID == item.batchRefId
                        //// select p).FirstOrDefault();
                        ///
                        var closingRecords = stagingContext.FINTRAK_TRAN_PROC_DETAILS.Where(x => x.FINTRAK_FLG != "Y" && x.TRAN_TYPE == "BL" && x.NARRATION == item.description && x.LOAN_ACCT == item.sourceReferenceNumber && x.SID <= item.sid).ToList();

                        if (closingRecords.Count() != 0)
                        {
                            foreach (var closingRecord in closingRecords)
                            {
                                source = (from p in context.TBL_CUSTOM_TRANSACTION_BULK
                                          where p.SID == closingRecord.SID
                                          select p).FirstOrDefault();

                                if (source == null)
                                    continue;

                                source.ISPOSTED = true;

                                closingRecord.FINTRAK_FLG = "Y";

                            }
                        }

                        stagingContext.SaveChanges();

                        context.SaveChanges();

                    }

                }

                output = stagingContext.SaveChanges() > 0;


            }



            currentDateInfo.REFRESHSTATUS = true;

            currentDateInfo.LASTEODREFRESHDATETIME = DateTime.Now;

            context.SaveChanges();

            return true;
        }

        //public bool GetRepaymentFromStaging()
        //{

        //    var currentDateInfo = context.TBL_FINANCECURRENTDATE.FirstOrDefault();

        //    if (currentDateInfo.REFRESHSTATUS == true)
        //    {
        //        throw new ConditionNotMetException("Refresh status for " + currentDateInfo.CURRENTDATE + " has already been run.");

        //    }

        //    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
        //    bool output = false;
        //    byte transType = 0;
        //    //short lienType = 0;

        //    TBL_CUSTOM_TRANSACTION_BULK source = new TBL_CUSTOM_TRANSACTION_BULK();
        //    bool postingResult = false;

        //    var data = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
        //                where a.AMT_COLLECTED <= a.AMT && a.FINTRAK_FLG != "Y"  //|| a.PSTD_FLG == "P"
        //                orderby a.SID ascending
        //                select new FinanceTransactionStagingViewModel()
        //                {
        //                    batchId = a.BATCH_ID,
        //                    batchRefId = (int)a.BATCH_REF_ID,
        //                    transType = a.TRAN_TYPE,
        //                    flowType = a.FLOW_TYPE,
        //                    amount = (decimal)a.AMT,
        //                    debitGlAccount = a.DR_ACCT,
        //                    creditGlAccount = a.CR_ACCT,
        //                    currencyRate = (double)a.RATE,
        //                    currencyRateCode = a.RATE_CODE,
        //                    description = a.NARRATION,
        //                    amountCollected = (decimal)a.AMT_COLLECTED,
        //                    bankId = a.BANK_ID,
        //                    sourceReferenceNumber = a.LOAN_ACCT,


        //                }).ToList();

        //    //int counter = 0;

        //    foreach (var item in data)
        //    {
        //        if (item.amountCollected > item.amount)
        //        {
        //            item.amountCollected = item.amount;
        //        }

        //        source = (from p in context.TBL_CUSTOM_TRANSACTION_BULK
        //                  where p.BATCHID == item.batchId && p.BATCHREFID == item.batchRefId
        //                  select p).FirstOrDefault();

        //        if (source == null)
        //            continue;

        //        var operationType = (OperationsEnum)source.OPERATIONID;


        //        FinanceTransactionStagingViewModel model = new FinanceTransactionStagingViewModel();
        //        if (item.amountCollected < 0)
        //            continue;

        //        //item.amountCollected != source.AMOUNTCOLLECTED &&

        //        model.amount = item.amount;
        //        model.actualAmountCollected = Math.Abs(item.amountCollected - source.AMOUNTCOLLECTED);
        //        model.amountDue = item.amount - item.amountCollected; //10 - 2
        //        model.operationId = source.OPERATIONID;
        //        model.description = source.DESCRIPTION;
        //        model.valueDate = source.VALUEDATE;
        //        model.transactionDate = source.VALUEDATE;
        //        model.currencyId = source.CURRENCYID;
        //        model.currencyRate = source.CURRENCYRATE;
        //        model.companyId = source.COMPANYID;
        //        model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //        model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //        model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //        model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //        model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //        model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //        model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //        model.batchId = source.BATCHID;
        //        model.batchRefId = source.BATCHREFID;
        //        model.loanId = source.LOANID;
        //        model.flowType = source.FLOWTYPE;

        //        if (model.amountDue >= 0 && model.actualAmountCollected > 0) //item.amountCollected
        //        {

        //            postingResult = financeTransaction.BulkIntegrationPosting(model);


        //            if (operationType == OperationsEnum.InterestPastDueLoanRepayment)
        //            {
        //                transType = (byte)LoanTransactionTypeEnum.Interest;
        //                var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //                var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);


        //                var pastDue = new TBL_LOAN_PAST_DUE
        //                {
        //                    LOANID = (int)model.loanId,
        //                    PASTDUECODE = PastDueCode,
        //                    CREDITAMOUNT = model.actualAmountCollected,
        //                    DESCRIPTION = "Past Due Payment on " + model.description + " as a result of Account funded",
        //                    DEBITAMOUNT = 0,
        //                    DATE = model.transactionDate,
        //                    TRANSACTIONTYPEID = transType,
        //                    PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                    PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                };

        //                context.TBL_LOAN_PAST_DUE.Add(pastDue);

        //                updateloanTablePastDueInterest(model.loanId.Value, model.actualAmountCollected * -1);
        //            }

        //            if (operationType == OperationsEnum.PrincipalPastDueLoanRepayment)
        //            {
        //                transType = (byte)LoanTransactionTypeEnum.Principal;
        //                var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //                var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);

        //                var pastDue = new TBL_LOAN_PAST_DUE
        //                {
        //                    LOANID = (int)model.loanId,
        //                    PASTDUECODE = PastDueCode,
        //                    CREDITAMOUNT = model.actualAmountCollected,
        //                    DESCRIPTION = "Past Due Payment on " + model.description + " as a result of Account funded",
        //                    DEBITAMOUNT = 0,
        //                    DATE = model.transactionDate,
        //                    TRANSACTIONTYPEID = transType,
        //                    PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                    PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                };

        //                context.TBL_LOAN_PAST_DUE.Add(pastDue);

        //                updateloanTablePastDuePrincipal(model.loanId.Value, model.actualAmountCollected * -1);
        //            }
        //        }

        //        if (operationType == OperationsEnum.InterestLoanRepayment || operationType == OperationsEnum.PrincipalLoanRepayment && item.amountCollected <= item.amount)
        //        {

        //            var pastDueExist = context.TBL_LOAN_PAST_DUE.Where(x => x.LOANID == model.loanId && x.DATE == model.transactionDate && x.DEBITAMOUNT > 0).ToList();

        //            if (model.amountDue <= 0)
        //                model.amountDue = model.amount;

        //            //List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
        //            //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();

        //            var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //            var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //            var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
        //            var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


        //            if (model.flowType == "BIF")
        //            {

        //                if (item.amountCollected < item.amount) //past due block
        //                {
        //                    transType = (byte)LoanTransactionTypeEnum.Interest;
        //                    //lienType = (short)LienTypeEnum.InterestRepayment;

        //                    var pastDueCount = pastDueExist.Where(x => x.TRANSACTIONTYPEID == transType).Count();
        //                    if (pastDueCount > 0)
        //                        continue;

        //                    var pastDue = new TBL_LOAN_PAST_DUE
        //                    {
        //                        LOANID = (int)model.loanId,
        //                        PASTDUECODE = PastDueCode,
        //                        CREDITAMOUNT = 0,
        //                        DESCRIPTION = "Past Due Entries on " + model.description + " as a result of Account not funded",
        //                        DEBITAMOUNT = Math.Abs(model.amountDue),
        //                        DATE = model.transactionDate,
        //                        TRANSACTIONTYPEID = transType,
        //                        PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                        PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                    };

        //                    context.TBL_LOAN_PAST_DUE.Add(pastDue);

        //                    updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //                }
        //            }
        //            else if (model.flowType == "BPP")
        //            {

        //                if (item.amountCollected < item.amount) //past due block
        //                {
        //                    transType = (byte)LoanTransactionTypeEnum.Principal;
        //                    //lienType = (short)LienTypeEnum.PrincipalRepayment;

        //                    var pastDueCount = pastDueExist.Where(x => x.TRANSACTIONTYPEID == transType).Count();
        //                    if (pastDueCount > 0)
        //                        continue;

        //                    var pastDue = new TBL_LOAN_PAST_DUE
        //                    {
        //                        LOANID = (int)model.loanId,
        //                        PASTDUECODE = PastDueCode,
        //                        CREDITAMOUNT = 0,
        //                        DESCRIPTION = "Past Due Entries on " + model.description + " as a result of Account not funded",
        //                        DEBITAMOUNT = Math.Abs(model.amountDue),
        //                        DATE = model.transactionDate,
        //                        TRANSACTIONTYPEID = transType,
        //                        PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                        PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                    };

        //                    context.TBL_LOAN_PAST_DUE.Add(pastDue);

        //                    updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //                }
        //            }

        //            if (item.amountCollected < item.amount) //past due block
        //            {
        //                updateloanPastDueDate((int)model.loanId, item.transactionDate);
        //            }
        //        }


        //        source.AMOUNTCOLLECTED = item.amountCollected;



        //        context.SaveChanges();

        //        if (model.operationId == (int)OperationsEnum.CommercialLoanRollOver) ///TODO check this logic later
        //        {
        //            var loan = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == model.sourceReferenceNumber);
        //            var instruction = context.TBL_LOAN_MATURITY_INSTRUCTION.FirstOrDefault(x => x.LOANID == loan.TERMLOANID);

        //            ArchiveLoan(loan.TERMLOANID, model.operationId, archiveBatchCode);//change to method that will disburs new loan

        //        }

        //        if (postingResult == true)
        //        {
        //            if (source.AMOUNT == item.amountCollected)
        //            {
        //                source.ISPOSTED = true;

        //                FINTRAK_TRAN_PROC_DETAILS bulk = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
        //                                                  where a.BATCH_ID == model.batchId && a.BATCH_REF_ID
        //                                                    == model.batchRefId
        //                                                  select a).SingleOrDefault();
        //                bulk.FINTRAK_FLG = "Y";
        //            }

        //        }                

        //        output = stagingContext.SaveChanges() > 0;


        //        //FinanceTransactionStagingViewModel model = new FinanceTransactionStagingViewModel();
        //        //if (item.amountCollected != 0 && LoanPayment == 0)
        //        //{
        //        //    model.actualAmount = item.amountCollected - source.AMOUNTCOLLECTED;
        //        //    model.operationId = source.OPERATIONID;
        //        //    model.description = source.DESCRIPTION;
        //        //    model.valueDate = source.VALUEDATE;
        //        //    model.transactionDate = source.VALUEDATE;
        //        //    model.currencyId = source.CURRENCYID;
        //        //    model.currencyRate = source.CURRENCYRATE;
        //        //    model.companyId = source.COMPANYID;
        //        //    model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //        //    model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //        //    model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //        //    model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //        //    model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //        //    model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //        //    model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //        //    model.batchId = source.BATCHID;
        //        //    model.batchRefId = source.BATCHREFID;
        //        //    model.loanId = source.LOANID;
        //        //    model.flowType = source.FLOWTYPE;

        //        //    postingResult = financeTransaction.BulkIntegrationPosting(model);

        //        //    if (model.flowType == "BIF")
        //        //    {
        //        //        updateloanTableInterest((int)model.loanId, model.actualAmount);
        //        //    }
        //        //    else if (model.flowType == "BPP")
        //        //    {
        //        //        updateloanTablePrincipal((int)model.loanId, model.actualAmount);
        //        //    }

        //        //    source.AMOUNTCOLLECTED = item.amountCollected;

        //        //    context.SaveChanges();

        //        //    if (model.operationId == (int)OperationsEnum.CommercialLoanRollOver)
        //        //    {
        //        //        var loan = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == model.sourceReferenceNumber);
        //        //        var instruction = context.TBL_LOAN_MATURITY_INSTRUCTION.FirstOrDefault(x => x.LOANID == loan.TERMLOANID);

        //        //        ArchiveLoan(loan.TERMLOANID, model.operationId, archiveBatchCode);//change to method that will disburs new loan

        //        //    }
        //        //    if (postingResult == true)
        //        //    {
        //        //        if (source.AMOUNT == item.amountCollected)
        //        //        {
        //        //            source.ISPOSTED = true;

        //        //            FINTRAK_TRAN_PROC_DETAILS bulk = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
        //        //                                              where a.BATCH_ID == model.batchId && a.BATCH_REF_ID
        //        //                                                == model.batchRefId
        //        //                                              select a).SingleOrDefault();
        //        //            bulk.FINTRAK_FLG = "Y";
        //        //        }

        //        //    }
        //        //    output = stagingContext.SaveChanges() > 0;
        //        //}



        //        //else if (item.amountCollected != 0 && fullAmount != 0)
        //        //{
        //        //    model.actualAmount = item.amountCollected - source.AMOUNTCOLLECTED;
        //        //    model.operationId = source.OPERATIONID;
        //        //    model.description = source.DESCRIPTION;
        //        //    model.valueDate = source.VALUEDATE;
        //        //    model.transactionDate = source.VALUEDATE;
        //        //    model.currencyId = source.CURRENCYID;
        //        //    model.currencyRate = source.CURRENCYRATE;
        //        //    model.companyId = source.COMPANYID;
        //        //    model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //        //    model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //        //    model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //        //    model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //        //    model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //        //    model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //        //    model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //        //    model.batchId = source.BATCHID;
        //        //    model.batchRefId = source.BATCHREFID;
        //        //    model.loanId = source.LOANID;
        //        //    model.flowType = source.FLOWTYPE;

        //        //    if (model.actualAmount > 0)
        //        //    {
        //        //        postingResult = financeTransaction.BulkIntegrationPosting(model);

        //        //        if (operationType == OperationsEnum.InterestPastDueLoanRepayment || operationType == OperationsEnum.PrincipalPastDueLoanRepayment)
        //        //        {

        //        //            List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
        //        //            //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();
        //        //            var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //        //            var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //        //            var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
        //        //            var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


        //        //            if (model.flowType == "BIF")
        //        //            {

        //        //                transType = (byte)LoanTransactionTypeEnum.Interest;
        //        //                lienType = (short)LienTypeEnum.InterestRepayment;

        //        //                updateloanTableInterest((int)model.loanId, model.actualAmount);

        //        //                var pastDue = new TBL_LOAN_PAST_DUE
        //        //                {
        //        //                    LOANID = (int)model.loanId,
        //        //                    PASTDUECODE = PastDueCode,
        //        //                    CREDITAMOUNT = 0,
        //        //                    DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //        //                    DEBITAMOUNT = Math.Abs(model.actualAmount),
        //        //                    DATE = model.transactionDate,
        //        //                    TRANSACTIONTYPEID = transType,
        //        //                    PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //        //                    PRODUCTTYPEID = product.PRODUCTTYPEID,
        //        //                };

        //        //                transPastDue.Add(pastDue);

        //        //                updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT * -1);
        //        //            }
        //        //            else if (model.flowType == "BPP")
        //        //            {
        //        //                transType = (byte)LoanTransactionTypeEnum.Principal;
        //        //                lienType = (short)LienTypeEnum.PrincipalRepayment;

        //        //                updateloanTablePrincipal((int)model.loanId, model.actualAmount);

        //        //                var pastDue = new TBL_LOAN_PAST_DUE
        //        //                {
        //        //                    LOANID = (int)model.loanId,
        //        //                    PASTDUECODE = PastDueCode,
        //        //                    CREDITAMOUNT = 0,
        //        //                    DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //        //                    DEBITAMOUNT = Math.Abs(model.actualAmount),
        //        //                    DATE = model.transactionDate,
        //        //                    TRANSACTIONTYPEID = transType,
        //        //                    PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //        //                    PRODUCTTYPEID = product.PRODUCTTYPEID,
        //        //                };

        //        //                transPastDue.Add(pastDue);

        //        //                updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT * -1);
        //        //            }

        //        //            updateloanPastDueDate((int)model.loanId, item.transactionDate);
        //        //        }

        //        //        //pastDue.LOANID = (int)item.loanId;
        //        //        //pastDue.PARENT_PASTDUECODE = PastDueCode;
        //        //        //pastDue.CREDITAMOUNT = 0;
        //        //        //pastDue.DESCRIPTION = "Past Due Entries on " + source.DESCRIPTION + "as a result of Account not funded";
        //        //        //pastDue.DEBITAMOUNT = Math.Abs(partailAmount);
        //        //        //pastDue.DATE = item.transactionDate;
        //        //        //pastDue.TRANSACTIONTYPEID = transType;
        //        //        //pastDue.PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER;
        //        //        //pastDue.PRODUCTTYPEID = product.PRODUCTTYPEID;

        //        //        //transPastDue.Add(pastDue);
        //        //        //updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);



        //        //        //CasaLienViewModel lien = new CasaLienViewModel();

        //        //        //lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
        //        //        //lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
        //        //        //lien.lienAmount = pastDue.DEBITAMOUNT;
        //        //        //lien.branchId = item.branchId;
        //        //        //lien.companyId = item.companyId;
        //        //        //lien.lienTypeId = lienType;
        //        //        //lien.createdBy = (int)SystemStaff.System;
        //        //        //lien.description = "lien placed due to Account not funded at Anniversary Date";

        //        //        //casaLien.PlaceLien(lien);

        //        //        source.AMOUNTCOLLECTED = item.amountCollected;
        //        //        context.SaveChanges();
        //        //    }


        //        //}
        //        //else if (item.amountCollected == 0)
        //        //{

        //        //    model.actualAmount = 0;
        //        //    model.operationId = source.OPERATIONID;
        //        //    model.description = source.DESCRIPTION;
        //        //    model.valueDate = source.VALUEDATE;
        //        //    model.transactionDate = source.VALUEDATE;
        //        //    model.currencyId = source.CURRENCYID;
        //        //    model.currencyRate = source.CURRENCYRATE;
        //        //    model.companyId = source.COMPANYID;
        //        //    model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //        //    model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //        //    model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //        //    model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //        //    model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //        //    model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //        //    model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //        //    model.batchId = source.BATCHID;
        //        //    model.batchRefId = source.BATCHREFID;
        //        //    model.loanId = source.LOANID;
        //        //    model.flowType = source.FLOWTYPE;

        //        //    if (operationType == OperationsEnum.InterestPastDueLoanRepayment || operationType == OperationsEnum.PrincipalPastDueLoanRepayment)
        //        //    {
        //        //        List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
        //        //        //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();
        //        //        var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //        //        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //        //        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
        //        //        var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


        //        //        if (model.flowType == "BIF")
        //        //        {
        //        //            transType = (byte)LoanTransactionTypeEnum.Interest;
        //        //            lienType = (short)LienTypeEnum.InterestRepayment;
        //        //            var pastDue = new TBL_LOAN_PAST_DUE
        //        //            {
        //        //                LOANID = (int)model.loanId,
        //        //                PASTDUECODE = PastDueCode,
        //        //                CREDITAMOUNT = 0,
        //        //                DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //        //                DEBITAMOUNT = Math.Abs(partailAmount),
        //        //                DATE = model.transactionDate,
        //        //                TRANSACTIONTYPEID = transType,
        //        //                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //        //                PRODUCTTYPEID = product.PRODUCTTYPEID,
        //        //            };
        //        //            transPastDue.Add(pastDue);
        //        //            context.SaveChanges();

        //        //            updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //        //        }
        //        //        else if (model.flowType == "BPP")
        //        //        {
        //        //            transType = (byte)LoanTransactionTypeEnum.Principal;
        //        //            lienType = (short)LienTypeEnum.PrincipalRepayment;

        //        //            var pastDue = new TBL_LOAN_PAST_DUE
        //        //            {
        //        //                LOANID = (int)model.loanId,
        //        //                PASTDUECODE = PastDueCode,
        //        //                CREDITAMOUNT = 0,
        //        //                DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //        //                DEBITAMOUNT = Math.Abs(partailAmount),
        //        //                DATE = model.transactionDate,
        //        //                TRANSACTIONTYPEID = transType,
        //        //                PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //        //                PRODUCTTYPEID = product.PRODUCTTYPEID,
        //        //            };

        //        //            transPastDue.Add(pastDue);
        //        //            context.SaveChanges();

        //        //            updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //        //        }



        //        //        updateloanPastDueDate((int)model.loanId, model.transactionDate);
        //        //    }
        //        //    //CasaLienViewModel lien = new CasaLienViewModel();
        //        //    //lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
        //        //    //lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
        //        //    //lien.lienAmount = pastDue.DEBITAMOUNT;
        //        //    //lien.branchId = item.branchId;
        //        //    //lien.companyId = item.companyId;
        //        //    //lien.lienTypeId = lienType;
        //        //    //lien.createdBy = (int)SystemStaff.System;
        //        //    //lien.description = "lien placed due to Account not funded at Anniversary Date";

        //        //    //casaLien.PlaceLien(lien);
        //        //    //source.AMOUNTCOLLECTED = item.amountCollected;
        //        //    context.SaveChanges();
        //        //}


        //        //}


        //    }

        //    currentDateInfo.REFRESHSTATUS = true;

        //    context.SaveChanges();

        //    return true;
        //}

        //public bool GetRepaymentFromStagingOld()
        //{
        //    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
        //    bool output = false;
        //    decimal fullAmount = 0;
        //    decimal partailAmount = 0;
        //    byte transType = 0;
        //    short lienType = 0;
        //    TBL_CUSTOM_TRANSACTION_BULK source = new TBL_CUSTOM_TRANSACTION_BULK();
        //    bool postingResult = false;

        //    var data = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
        //                where a.AMT_COLLECTED <= a.AMT && a.FINTRAK_FLG != "Y"  //|| a.PSTD_FLG == "P"
        //                select new FinanceTransactionStagingViewModel()
        //                {
        //                    batchId = a.BATCH_ID,
        //                    batchRefId = (int)a.BATCH_REF_ID,
        //                    transType = a.TRAN_TYPE,
        //                    flowType = a.FLOW_TYPE,
        //                    amount = (decimal)a.AMT,
        //                    debitGlAccount = a.DR_ACCT,
        //                    creditGlAccount = a.CR_ACCT,
        //                    currencyRate = (double)a.RATE,
        //                    currencyRateCode = a.RATE_CODE,
        //                    description = a.NARRATION,
        //                    amountCollected = (decimal)a.AMT_COLLECTED,
        //                    bankId = a.BANK_ID,
        //                    sourceReferenceNumber = a.LOAN_ACCT,

        //                }).ToList();

        //    //int counter = 0;

        //    foreach (var item in data)
        //    {
        //        //counter += 1;

        //        //var test = item;

        //        source = (from p in context.TBL_CUSTOM_TRANSACTION_BULK
        //                  where p.BATCHID == item.batchId && p.BATCHREFID
        //                                          == item.batchRefId
        //                  select p).SingleOrDefault();


        //        if (source == null)
        //            continue;



        //        var operationType = (OperationsEnum)source.OPERATIONID;

        //        if (item.amountCollected != 0)
        //        {
        //            fullAmount = item.amountCollected - source.AMOUNT;
        //            partailAmount = source.AMOUNT - item.amountCollected;
        //        }
        //        else
        //        {
        //            partailAmount = source.AMOUNT - item.amountCollected;
        //        }

        //        FinanceTransactionStagingViewModel model = new FinanceTransactionStagingViewModel();
        //        if (item.amountCollected != 0 && fullAmount == 0)
        //        {
        //            model.actualAmount = item.amountCollected - source.AMOUNTCOLLECTED;
        //            model.operationId = source.OPERATIONID;
        //            model.description = source.DESCRIPTION;
        //            model.valueDate = source.VALUEDATE;
        //            model.transactionDate = source.VALUEDATE;
        //            model.currencyId = source.CURRENCYID;
        //            model.currencyRate = source.CURRENCYRATE;
        //            model.companyId = source.COMPANYID;
        //            model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //            model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //            model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //            model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //            model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //            model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //            model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //            model.batchId = source.BATCHID;
        //            model.batchRefId = source.BATCHREFID;
        //            model.loanId = source.LOANID;
        //            model.flowType = source.FLOWTYPE;

        //            postingResult = financeTransaction.BulkIntegrationPosting(model);

        //            if (model.flowType == "BIF")
        //            {
        //                updateloanTableInterest((int)model.loanId, model.actualAmount);
        //            }
        //            else if (model.flowType == "BPP")
        //            {
        //                updateloanTablePrincipal((int)model.loanId, model.actualAmount);
        //            }

        //            source.AMOUNTCOLLECTED = item.amountCollected;

        //            context.SaveChanges();
        //            if (model.operationId == (int)OperationsEnum.CommercialLoanRollOver)
        //            {
        //                var loan = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == model.sourceReferenceNumber);
        //                var instruction = context.TBL_LOAN_MATURITY_INSTRUCTION.FirstOrDefault(x => x.LOANID == loan.TERMLOANID);

        //                ArchiveLoan(loan.TERMLOANID, model.operationId, archiveBatchCode);//change to method that will disburs new loan

        //            }
        //            if (postingResult == true)
        //            {
        //                if (source.AMOUNT == item.amountCollected)
        //                {
        //                    source.ISPOSTED = true;

        //                    FINTRAK_TRAN_PROC_DETAILS bulk = (from a in stagingContext.FINTRAK_TRAN_PROC_DETAILS
        //                                                      where a.BATCH_ID == model.batchId && a.BATCH_REF_ID
        //                                                        == model.batchRefId
        //                                                      select a).SingleOrDefault();
        //                    bulk.FINTRAK_FLG = "Y";
        //                }

        //            }
        //            output = stagingContext.SaveChanges() > 0;
        //        }
        //        else if (item.amountCollected != 0 && fullAmount != 0)
        //        {
        //            model.actualAmount = item.amountCollected - source.AMOUNTCOLLECTED;
        //            model.operationId = source.OPERATIONID;
        //            model.description = source.DESCRIPTION;
        //            model.valueDate = source.VALUEDATE;
        //            model.transactionDate = source.VALUEDATE;
        //            model.currencyId = source.CURRENCYID;
        //            model.currencyRate = source.CURRENCYRATE;
        //            model.companyId = source.COMPANYID;
        //            model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //            model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //            model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //            model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //            model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //            model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //            model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //            model.batchId = source.BATCHID;
        //            model.batchRefId = source.BATCHREFID;
        //            model.loanId = source.LOANID;
        //            model.flowType = source.FLOWTYPE;

        //            if (model.actualAmount > 0)
        //            {
        //                postingResult = financeTransaction.BulkIntegrationPosting(model);

        //                if (operationType == OperationsEnum.InterestPastDueLoanRepayment || operationType == OperationsEnum.PrincipalPastDueLoanRepayment)
        //                {

        //                    List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
        //                    //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();
        //                    var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //                    var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //                    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
        //                    var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


        //                    if (model.flowType == "BIF")
        //                    {

        //                        transType = (byte)LoanTransactionTypeEnum.Principal;
        //                        lienType = (short)LienTypeEnum.PrincipalRepayment;
        //                        updateloanTableInterest((int)model.loanId, model.actualAmount);

        //                        var pastDue = new TBL_LOAN_PAST_DUE
        //                        {
        //                            LOANID = (int)model.loanId,
        //                            PASTDUECODE = PastDueCode,
        //                            CREDITAMOUNT = 0,
        //                            DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //                            DEBITAMOUNT = Math.Abs(partailAmount),
        //                            DATE = model.transactionDate,
        //                            TRANSACTIONTYPEID = transType,
        //                            PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                            PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                        };

        //                        transPastDue.Add(pastDue);
        //                        updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //                    }
        //                    else if (model.flowType == "BPP")
        //                    {
        //                        transType = (byte)LoanTransactionTypeEnum.Principal;
        //                        lienType = (short)LienTypeEnum.PrincipalRepayment;
        //                        updateloanTablePrincipal((int)model.loanId, model.actualAmount);
        //                        var pastDue = new TBL_LOAN_PAST_DUE
        //                        {
        //                            LOANID = (int)model.loanId,
        //                            PASTDUECODE = PastDueCode,
        //                            CREDITAMOUNT = 0,
        //                            DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //                            DEBITAMOUNT = Math.Abs(partailAmount),
        //                            DATE = model.transactionDate,
        //                            TRANSACTIONTYPEID = transType,
        //                            PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                            PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                        };

        //                        transPastDue.Add(pastDue);
        //                        updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //                    }

        //                    updateloanPastDueDate((int)model.loanId, item.transactionDate);
        //                }
        //                //pastDue.LOANID = (int)item.loanId;
        //                //pastDue.PARENT_PASTDUECODE = PastDueCode;
        //                //pastDue.CREDITAMOUNT = 0;
        //                //pastDue.DESCRIPTION = "Past Due Entries on " + source.DESCRIPTION + "as a result of Account not funded";
        //                //pastDue.DEBITAMOUNT = Math.Abs(partailAmount);
        //                //pastDue.DATE = item.transactionDate;
        //                //pastDue.TRANSACTIONTYPEID = transType;
        //                //pastDue.PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER;
        //                //pastDue.PRODUCTTYPEID = product.PRODUCTTYPEID;

        //                //transPastDue.Add(pastDue);
        //                //updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);



        //                //CasaLienViewModel lien = new CasaLienViewModel();

        //                //lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
        //                //lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
        //                //lien.lienAmount = pastDue.DEBITAMOUNT;
        //                //lien.branchId = item.branchId;
        //                //lien.companyId = item.companyId;
        //                //lien.lienTypeId = lienType;
        //                //lien.createdBy = (int)SystemStaff.System;
        //                //lien.description = "lien placed due to Account not funded at Anniversary Date";

        //                //casaLien.PlaceLien(lien);

        //                source.AMOUNTCOLLECTED = item.amountCollected;
        //                context.SaveChanges();
        //            }


        //        }
        //        else if (item.amountCollected == 0)
        //        {

        //            model.actualAmount = 0;
        //            model.operationId = source.OPERATIONID;
        //            model.description = source.DESCRIPTION;
        //            model.valueDate = source.VALUEDATE;
        //            model.transactionDate = source.VALUEDATE;
        //            model.currencyId = source.CURRENCYID;
        //            model.currencyRate = source.CURRENCYRATE;
        //            model.companyId = source.COMPANYID;
        //            model.debitGlAccountId = source.DEBITGLACCOUNTID;
        //            model.sourceReferenceNumber = source.SOURCEREFERENCENUMBER;
        //            model.debitCasaAccountId = source.DEBITCASAACCOUNTID;
        //            model.sourceBranchId = (short)source.SOURCEBRANCHID;
        //            model.destinationBranchId = (short)source.DESTINATIONBRANCHID;
        //            model.creditGlAccountId = source.CREDITGLACCOUNTID;
        //            model.creditCasaAccountId = source.CREDITCASAACCOUNTID;
        //            model.batchId = source.BATCHID;
        //            model.batchRefId = source.BATCHREFID;
        //            model.loanId = source.LOANID;
        //            model.flowType = source.FLOWTYPE;

        //            if (operationType == OperationsEnum.InterestPastDueLoanRepayment || operationType == OperationsEnum.PrincipalPastDueLoanRepayment)
        //            {
        //                List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();
        //                //TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();
        //                var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
        //                var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == model.loanId);
        //                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loan.PRODUCTID);
        //                var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID && x.COMPANYID == model.companyId);


        //                if (model.flowType == "BIF")
        //                {
        //                    transType = (byte)LoanTransactionTypeEnum.Interest;
        //                    lienType = (short)LienTypeEnum.InterestRepayment;
        //                    var pastDue = new TBL_LOAN_PAST_DUE
        //                    {
        //                        LOANID = (int)model.loanId,
        //                        PASTDUECODE = PastDueCode,
        //                        CREDITAMOUNT = 0,
        //                        DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //                        DEBITAMOUNT = Math.Abs(partailAmount),
        //                        DATE = model.transactionDate,
        //                        TRANSACTIONTYPEID = transType,
        //                        PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                        PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                    };
        //                    transPastDue.Add(pastDue);
        //                    context.SaveChanges();
        //                    updateloanTablePastDueInterest(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //                }
        //                else if (model.flowType == "BPP")
        //                {
        //                    transType = (byte)LoanTransactionTypeEnum.Principal;
        //                    lienType = (short)LienTypeEnum.PrincipalRepayment;

        //                    var pastDue = new TBL_LOAN_PAST_DUE
        //                    {
        //                        LOANID = (int)model.loanId,
        //                        PASTDUECODE = PastDueCode,
        //                        CREDITAMOUNT = 0,
        //                        DESCRIPTION = "Past Due Entries on " + model.description + "as a result of Account not funded",
        //                        DEBITAMOUNT = Math.Abs(partailAmount),
        //                        DATE = model.transactionDate,
        //                        TRANSACTIONTYPEID = transType,
        //                        PARENT_PASTDUECODE = loan.LOANREFERENCENUMBER,
        //                        PRODUCTTYPEID = product.PRODUCTTYPEID,
        //                    };

        //                    transPastDue.Add(pastDue);
        //                    context.SaveChanges();
        //                    updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);
        //                }



        //                updateloanPastDueDate((int)model.loanId, model.transactionDate);
        //            }
        //            //CasaLienViewModel lien = new CasaLienViewModel();
        //            //lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
        //            //lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
        //            //lien.lienAmount = pastDue.DEBITAMOUNT;
        //            //lien.branchId = item.branchId;
        //            //lien.companyId = item.companyId;
        //            //lien.lienTypeId = lienType;
        //            //lien.createdBy = (int)SystemStaff.System;
        //            //lien.description = "lien placed due to Account not funded at Anniversary Date";

        //            //casaLien.PlaceLien(lien);
        //            //source.AMOUNTCOLLECTED = item.amountCollected;
        //            context.SaveChanges();
        //        }


        //        //}


        //    }

        //    return true;
        //}


        #endregion

        #region Anniversary  Operation

        public void updateloanTablePrincipal(int loanId, decimal amoumt)
        {
            TBL_LOAN result = (from p in context.TBL_LOAN
                               where p.TERMLOANID == loanId
                               select p).SingleOrDefault();

            result.OUTSTANDINGPRINCIPAL = result.OUTSTANDINGPRINCIPAL - amoumt;


            context.SaveChanges();
        }

        public void updateloanTableInterest(int loanId, decimal amoumt)
        {
            TBL_LOAN result = (from p in context.TBL_LOAN
                               where p.TERMLOANID == loanId
                               select p).SingleOrDefault();

            result.OUTSTANDINGINTEREST = result.OUTSTANDINGINTEREST - amoumt;


            context.SaveChanges();
        }

        public void updateloanPastDueDate(int loanId, DateTime applicationdate)
        {

            var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);

            if (loan.PASTDUEDATE == null)
            {
                //TBL_LOAN result = (from p in context.TBL_LOAN
                //                   where p.TERMLOANID == loanId
                //                   select p).SingleOrDefault();

                loan.PASTDUEDATE = applicationdate;
            }
            else
            {
                if (loan.PASTDUEINTEREST + loan.PASTDUEPRINCIPAL <= 0)
                {
                    loan.PASTDUEDATE = null;
                }
            }


            context.SaveChanges();
        }

        public void updateloanTablePastDuePrincipal(int loanId, decimal amoumt)
        {
            TBL_LOAN result = (from p in context.TBL_LOAN
                               where p.TERMLOANID == loanId
                               select p).SingleOrDefault();

            var pastDue = result.PASTDUEPRINCIPAL + amoumt;
            if (pastDue < 0)
            {
                pastDue = 0;
            }

            result.PASTDUEPRINCIPAL = pastDue;

            context.SaveChanges();
        }

        public void updateloanTablePastDueInterest(int loanId, decimal amoumt)
        {
            TBL_LOAN result = (from p in context.TBL_LOAN
                               where p.TERMLOANID == loanId
                               select p).SingleOrDefault();

            var pastDue = result.PASTDUEINTEREST + amoumt;
            if (pastDue < 0)
            {
                pastDue = 0;
            }

            result.PASTDUEINTEREST = pastDue;

            context.SaveChanges();
        }

        private void updateloanTableInterestOnPastDueInterest(int loanId, decimal amoumt)
        {
            TBL_LOAN result = (from p in context.TBL_LOAN
                               where p.TERMLOANID == loanId
                               select p).SingleOrDefault();

            result.INTERESTONPASTDUEINTEREST = result.INTERESTONPASTDUEINTEREST + amoumt;

            context.SaveChanges();
        }

        private void updateloanTableInterestOnPastDuePrincipal(int loanId, decimal amoumt)
        {
            TBL_LOAN result = (from p in context.TBL_LOAN
                               where p.TERMLOANID == loanId
                               select p).SingleOrDefault();

            result.INTERESTONPASTDUEPRINCIPAL = result.INTERESTONPASTDUEPRINCIPAL + amoumt;

            context.SaveChanges();
        }

        public IEnumerable<LoanRepaymentViewModel> ProcessLoanRepaymentPostingForceDebit(DateTime applicationDate, int companyId, int staffId)
        {
            //try
            //{


            var currencyRate = (from b in context.TBL_LOAN
                                where b.LOANSTATUSID == (short)LoanStatusEnum.Active
                                 && b.ALLOWFORCEDEBITREPAYMENT == true && b.COMPANYID == companyId
                                select new CurrencyExchangeRateViewModel()
                                {
                                    currencyId = b.CURRENCYID,
                                    companyId = b.COMPANYID,
                                }).ToList().Distinct().Select(x =>
                                {
                                    x.sellingRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, (int)x.companyId).sellingRate;
                                    return x;
                                }).ToList().Distinct();




            DateTime dateChange = applicationDate;

            dateChange = dateChange.AddDays(-1);

            bool result = false;

            List<LoanRepaymentViewModel> model = new List<LoanRepaymentViewModel>();

            //var otherLoans = (from b in context.TBL_LOAN
            //                  where b.MATURITYDATE == DbFunctions.TruncateTime(applicationDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active
            //                  && b.ALLOWFORCEDEBITREPAYMENT == true && b.ISDISBURSED == true
            //                  && b.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan
            //                  //&& (b.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan || b.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.ForeignXRevolving)
            //                  select new LoanRepaymentViewModel()
            //                  {
            //                      productId = b.PRODUCTID,
            //                      branchId = b.BRANCHID,
            //                      companyId = b.COMPANYID,
            //                      currencyId = b.CURRENCYID,
            //                      exchangeRate = b.EXCHANGERATE,
            //                      //periodInterestAmount = b.OUTSTANDINGINTEREST,
            //                      periodPrincipalAmount = b.OUTSTANDINGPRINCIPAL,
            //                      interestRate = b.INTERESTRATE,
            //                      paymentDate = applicationDate,
            //                      loanId = b.TERMLOANID,
            //                      totalAmount = 0,
            //                      casaAccountId = b.CASAACCOUNTID,
            //                      loanRefNo = b.LOANREFERENCENUMBER,
            //                      casaAccountId2 = b.CASAACCOUNTID2,
            //                  }).ToList().Select(x =>
            //                  {
            //                      x.periodInterestAmount = GetPeriodInterestAmountFromAccural(x.loanRefNo, x.companyId);
            //                      return x;
            //                  }).ToList();

            //var commercialLoanMaturityDate = applicationDate; // applicationDate.AddDays(1);

            //var commercialLoans = (from b in context.TBL_LOAN
            //                       where b.MATURITYDATE == DbFunctions.TruncateTime(commercialLoanMaturityDate)
            //                       && b.LOANSTATUSID == (short)LoanStatusEnum.Active
            //                       && b.ALLOWFORCEDEBITREPAYMENT == true && b.ISDISBURSED == true
            //                       && b.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan
            //                       //&& (b.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan || b.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.ForeignXRevolving)
            //                       select new LoanRepaymentViewModel()
            //                       {
            //                           productId = b.PRODUCTID,
            //                           branchId = b.BRANCHID,
            //                           companyId = b.COMPANYID,
            //                           currencyId = b.CURRENCYID,
            //                           exchangeRate = b.EXCHANGERATE,
            //                           //periodInterestAmount = b.OUTSTANDINGINTEREST,
            //                           periodPrincipalAmount = b.OUTSTANDINGPRINCIPAL,
            //                           interestRate = b.INTERESTRATE,
            //                           paymentDate = applicationDate,
            //                           loanId = b.TERMLOANID,
            //                           totalAmount = 0,
            //                           casaAccountId = b.CASAACCOUNTID,
            //                           loanRefNo = b.LOANREFERENCENUMBER,
            //                           casaAccountId2 = b.CASAACCOUNTID2,
            //                       }).ToList().Select(x =>
            //                       {
            //                           x.periodInterestAmount = GetPeriodInterestAmountFromAccural(x.loanRefNo, x.companyId);
            //                           return x;
            //                       }).ToList();

            var commercialLoanMaturityDate = applicationDate; // applicationDate.AddDays(1);


            var scheduledLoan = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
                                 join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                                 where a.PAYMENTDATE == DbFunctions.TruncateTime(applicationDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active
                                 && b.ALLOWFORCEDEBITREPAYMENT == true && b.ISDISBURSED == true && (a.PERIODINTERESTAMOUNT + a.PERIODPRINCIPALAMOUNT) > 0 && b.COMPANYID == companyId
                                 select new LoanRepaymentViewModel()
                                 {
                                     productId = b.PRODUCTID,
                                     branchId = b.BRANCHID,
                                     companyId = b.COMPANYID,
                                     currencyId = b.CURRENCYID,
                                     //exchangeRate = b.EXCHANGERATE,
                                     periodInterestAmount = a.PERIODINTERESTAMOUNT,
                                     periodPrincipalAmount = a.PERIODPRINCIPALAMOUNT,
                                     interestRate = a.INTERESTRATE,
                                     paymentDate = applicationDate,
                                     loanId = a.LOANID,
                                     totalAmount = a.PERIODINTERESTAMOUNT + a.PERIODPRINCIPALAMOUNT,
                                     casaAccountId = b.CASAACCOUNTID,
                                     casaAccountId2 = b.CASAACCOUNTID2,
                                     loanRefNo = b.LOANREFERENCENUMBER,
                                     pastDueInterestAmount = b.PASTDUEINTEREST,
                                     pastDuePrincipalAmount = b.PASTDUEPRINCIPAL,
                                 }).ToList().Select(x =>
                                 {
                                     //x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
                                     x.exchangeRate = currencyRate.Where(m => m.currencyId == x.currencyId).Select(m => m.sellingRate).FirstOrDefault();
                                     return x;
                                 }).ToList();

            //.Select(x =>
            //{
            //    //x.periodInterestAmount = GetPeriodInterestAmountFromAccural(x.loanRefNo, x.companyId);  //GetPeriodInterestAmount(x.loanId, x.paymentDate);
            //    x.periodInterestAmount = GetPeriodInterestAmount(x.loanId, x.paymentDate);                                     
            //    return x;
            //}).ToList();


            model = scheduledLoan; // otherLoans.Union(commercialLoans).ToList(); // scheduledLoan.Union(scheduledLoan).Union(fxLoan).ToList();


            var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.EODDATE == dateChange && c.EODOPERATIONID == (int)EodOperationEnum.ProcessLoanRepaymentPostingForceDebit).ToList();

            if (checkExistence.Count() == 0)
            {

                foreach (var item in model)
                {
                    if (item.periodPrincipalAmount > 0)
                        updateloanTablePrincipal((int)item.loanId, item.periodPrincipalAmount);

                    if (item.periodInterestAmount > 0)
                        updateloanTableInterest((int)item.loanId, item.periodInterestAmount);
                }

            }


            List<TBL_LOAN_FORCE_DEBIT> transForceDebit = new List<TBL_LOAN_FORCE_DEBIT>();
            var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
            if (setup.USE_THIRD_PARTY_INTEGRATION)
            {
                BulkTransactionPosting bulkPosting = new BulkTransactionPosting();
                result = bulkPosting.WriteBulkLoanRepaymentPostingForceDebitToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate, companyId, staffId, out _transactionReferenceNo);

            }
            else
                foreach (var item in model)
                {
                    if (item.maturityInstructionTypeId == (int)MaturityInstructionTypeEnum.RolloverInterstAndPrincipal)
                    {
                        item.totalAmount = item.periodInterestAmount + item.periodPrincipalAmount;
                    }
                    else
                    {
                        item.totalAmount = item.periodPrincipalAmount;
                    }
                    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == item.productId);

                    var forceDebitCode = CommonHelpers.GenerateRandomDigitCode(10);
                    var casabalance = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == item.casaAccountId).AVAILABLEBALANCE;
                    if (casabalance >= item.totalAmount)
                    {
                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));


                    }
                    else if (casabalance > item.periodInterestAmount && casabalance < item.totalAmount)
                    {
                        TBL_LOAN_FORCE_DEBIT forceDebit = new TBL_LOAN_FORCE_DEBIT();
                        forceDebit.LOANID = item.loanId;
                        forceDebit.FORCEDEBITCODE = forceDebitCode;
                        forceDebit.CREDITAMOUNT = 0;
                        forceDebit.DESCRIPTION = "Force Debit as a result of Account not funded";
                        forceDebit.DEBITAMOUNT = Math.Abs(casabalance - item.totalAmount);
                        forceDebit.DATE = item.paymentDate;
                        forceDebit.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        forceDebit.PARENT_FORCEDEBITCODE = item.loanRefNo;
                        transForceDebit.Add(forceDebit);
                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "partial principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));

                    }
                    else if (casabalance < item.periodInterestAmount && casabalance > 0)
                    {
                        TBL_LOAN_FORCE_DEBIT forceDebitInterest = new TBL_LOAN_FORCE_DEBIT();

                        forceDebitInterest.LOANID = item.loanId;
                        forceDebitInterest.FORCEDEBITCODE = forceDebitCode;
                        forceDebitInterest.CREDITAMOUNT = 0;
                        forceDebitInterest.DESCRIPTION = "Force Debit as a result of Account not funded";
                        forceDebitInterest.DEBITAMOUNT = Math.Abs(casabalance - item.periodInterestAmount);
                        forceDebitInterest.DATE = item.paymentDate;
                        forceDebitInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                        forceDebitInterest.PARENT_FORCEDEBITCODE = item.loanRefNo;

                        transForceDebit.Add(forceDebitInterest);

                        TBL_LOAN_FORCE_DEBIT forceDebitPrincipal = new TBL_LOAN_FORCE_DEBIT();

                        forceDebitPrincipal.LOANID = item.loanId;
                        forceDebitPrincipal.FORCEDEBITCODE = forceDebitCode;
                        forceDebitPrincipal.CREDITAMOUNT = 0;
                        forceDebitPrincipal.DESCRIPTION = "Force Debit as a result of Account not funded";
                        forceDebitPrincipal.DEBITAMOUNT = item.periodPrincipalAmount;
                        forceDebitPrincipal.DATE = item.paymentDate;
                        forceDebitPrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        forceDebitPrincipal.PARENT_FORCEDEBITCODE = item.loanRefNo;
                        transForceDebit.Add(forceDebitPrincipal);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "partial interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));

                    }
                    else if (casabalance <= 0)
                    {
                        TBL_LOAN_FORCE_DEBIT forceDebitInterest = new TBL_LOAN_FORCE_DEBIT();

                        forceDebitInterest.LOANID = item.loanId;
                        forceDebitInterest.FORCEDEBITCODE = forceDebitCode;
                        forceDebitInterest.CREDITAMOUNT = 0;
                        forceDebitInterest.DESCRIPTION = "Force Debit as a result of Account not funded";
                        forceDebitInterest.DEBITAMOUNT = Math.Abs(item.periodInterestAmount);
                        forceDebitInterest.DATE = item.paymentDate;
                        forceDebitInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                        forceDebitInterest.PARENT_FORCEDEBITCODE = item.loanRefNo;
                        forceDebitInterest.PRODUCTTYPEID = (short)item.productId;

                        transForceDebit.Add(forceDebitInterest);

                        TBL_LOAN_FORCE_DEBIT forceDebitPrincipal = new TBL_LOAN_FORCE_DEBIT();

                        forceDebitPrincipal.LOANID = item.loanId;
                        forceDebitPrincipal.FORCEDEBITCODE = forceDebitCode;
                        forceDebitPrincipal.CREDITAMOUNT = 0;
                        forceDebitPrincipal.DESCRIPTION = "Force Debit as a result of Account not funded";
                        forceDebitPrincipal.DEBITAMOUNT = Math.Abs(item.periodPrincipalAmount);
                        forceDebitPrincipal.DATE = item.paymentDate;
                        forceDebitPrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        forceDebitPrincipal.PARENT_FORCEDEBITCODE = item.loanRefNo;
                        forceDebitPrincipal.PRODUCTTYPEID = (short)item.productId;

                        transForceDebit.Add(forceDebitPrincipal);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));
                    }
                }

            this.context.TBL_LOAN_FORCE_DEBIT.AddRange(transForceDebit);
            result = context.SaveChanges() > 0;
            if (result)
            {
                return model;
            }
            return null;
            //}
            //catch (Exception ex)
            //{

            //    throw ex;
            //}
        }

        public IEnumerable<LoanRepaymentViewModel> ProcessLoanDisbursmentRollOver(DateTime applicationDate, int companyId)
        {
            try
            {

                var currencyRate = (from b in context.TBL_LOAN
                                    where b.MATURITYDATE == DbFunctions.TruncateTime(applicationDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active
                                    && b.ALLOWFORCEDEBITREPAYMENT == true && b.ISDISBURSED == true && b.COMPANYID == companyId
                                    select new CurrencyExchangeRateViewModel()
                                    {
                                        currencyId = b.CURRENCYID,
                                        companyId = b.COMPANYID,
                                    }).ToList().Distinct().Select(x =>
                                    {
                                        x.sellingRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, (int)x.companyId).sellingRate;
                                        return x;
                                    }).ToList();


                bool result = false;
                var model = (from a in context.TBL_LOAN_MATURITY_INSTRUCTION
                             join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                             where b.MATURITYDATE == DbFunctions.TruncateTime(applicationDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active
                             && b.ALLOWFORCEDEBITREPAYMENT == true && a.ISUSED == false && b.ISDISBURSED == true && b.COMPANYID == companyId
                             select new LoanRepaymentViewModel()
                             {
                                 productId = b.PRODUCTID,
                                 branchId = b.BRANCHID,
                                 companyId = b.COMPANYID,
                                 currencyId = b.CURRENCYID,
                                 //exchangeRate = b.EXCHANGERATE,
                                 periodInterestAmount = b.OUTSTANDINGINTEREST,
                                 periodPrincipalAmount = b.OUTSTANDINGPRINCIPAL,
                                 interestRate = b.INTERESTRATE,
                                 paymentDate = applicationDate,
                                 loanId = b.TERMLOANID,
                                 totalAmount = 0,
                                 casaAccountId = b.CASAACCOUNTID,
                                 loanRefNo = b.LOANREFERENCENUMBER,
                                 maturityInstructionTypeId = a.INSTRUCTIONTYPEID

                             }).ToList().Select(x =>
                             {
                                 x.exchangeRate = currencyRate.Where(m => m.currencyId == x.currencyId).Select(m => m.sellingRate).FirstOrDefault();
                                 return x;
                             }).ToList();


                List<TBL_LOAN_FORCE_DEBIT> transForceDebit = new List<TBL_LOAN_FORCE_DEBIT>();
                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                if (setup.USE_THIRD_PARTY_INTEGRATION)
                {

                    BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                    result = bulkPosting.WriteBulkProcessLoanDisbursmentRollOverToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate, companyId, out _transactionReferenceNo);

                }
                else
                    foreach (var item in model)
                    {
                        if (item.maturityInstructionTypeId == (int)MaturityInstructionTypeEnum.RolloverInterstAndPrincipal)
                        {
                            item.totalAmount = item.periodInterestAmount + item.periodPrincipalAmount;
                        }
                        else
                        {
                            item.totalAmount = item.periodPrincipalAmount;
                        }
                        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == item.productId);

                        var forceDebitCode = CommonHelpers.GenerateRandomDigitCode(10);
                        var casabalance = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == item.casaAccountId).AVAILABLEBALANCE;
                        if (casabalance >= item.totalAmount)
                        {
                            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                            inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                            inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));


                        }
                        else if (casabalance > item.periodInterestAmount && casabalance < item.totalAmount)
                        {
                            TBL_LOAN_FORCE_DEBIT forceDebit = new TBL_LOAN_FORCE_DEBIT();
                            forceDebit.LOANID = item.loanId;
                            forceDebit.FORCEDEBITCODE = forceDebitCode;
                            forceDebit.CREDITAMOUNT = 0;
                            forceDebit.DESCRIPTION = "Force Debit as a result of Account not funded";
                            forceDebit.DEBITAMOUNT = Math.Abs(casabalance - item.totalAmount);
                            forceDebit.DATE = item.paymentDate;
                            forceDebit.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                            forceDebit.PARENT_FORCEDEBITCODE = item.loanRefNo;

                            transForceDebit.Add(forceDebit);

                            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                            inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                            inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "partial principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));

                        }
                        else if (casabalance < item.periodInterestAmount && casabalance > 0)
                        {
                            TBL_LOAN_FORCE_DEBIT forceDebitInterest = new TBL_LOAN_FORCE_DEBIT();

                            forceDebitInterest.LOANID = item.loanId;
                            forceDebitInterest.FORCEDEBITCODE = forceDebitCode;
                            forceDebitInterest.CREDITAMOUNT = 0;
                            forceDebitInterest.DESCRIPTION = "Force Debit as a result of Account not funded";
                            forceDebitInterest.DEBITAMOUNT = Math.Abs(casabalance - item.periodInterestAmount);
                            forceDebitInterest.DATE = item.paymentDate;
                            forceDebitInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                            forceDebitInterest.PARENT_FORCEDEBITCODE = item.loanRefNo;

                            transForceDebit.Add(forceDebitInterest);

                            TBL_LOAN_FORCE_DEBIT forceDebitPrincipal = new TBL_LOAN_FORCE_DEBIT();

                            forceDebitPrincipal.LOANID = item.loanId;
                            forceDebitPrincipal.FORCEDEBITCODE = forceDebitCode;
                            forceDebitPrincipal.CREDITAMOUNT = 0;
                            forceDebitPrincipal.DESCRIPTION = "Force Debit as a result of Account not funded";
                            forceDebitPrincipal.DEBITAMOUNT = item.periodPrincipalAmount;
                            forceDebitPrincipal.DATE = item.paymentDate;
                            forceDebitPrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                            forceDebitPrincipal.PARENT_FORCEDEBITCODE = item.loanRefNo;

                            transForceDebit.Add(forceDebitPrincipal);

                            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                            inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "partial interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                            inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));

                        }
                        else if (casabalance <= 0)
                        {
                            TBL_LOAN_FORCE_DEBIT forceDebitInterest = new TBL_LOAN_FORCE_DEBIT();

                            forceDebitInterest.LOANID = item.loanId;
                            forceDebitInterest.FORCEDEBITCODE = forceDebitCode;
                            forceDebitInterest.CREDITAMOUNT = 0;
                            forceDebitInterest.DESCRIPTION = "Force Debit as a result of Account not funded";
                            forceDebitInterest.DEBITAMOUNT = Math.Abs(item.periodInterestAmount);
                            forceDebitInterest.DATE = item.paymentDate;
                            forceDebitInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                            forceDebitInterest.PARENT_FORCEDEBITCODE = item.loanRefNo;
                            forceDebitInterest.PRODUCTTYPEID = (short)item.productId;

                            transForceDebit.Add(forceDebitInterest);

                            TBL_LOAN_FORCE_DEBIT forceDebitPrincipal = new TBL_LOAN_FORCE_DEBIT();

                            forceDebitPrincipal.LOANID = item.loanId;
                            forceDebitPrincipal.FORCEDEBITCODE = forceDebitCode;
                            forceDebitPrincipal.CREDITAMOUNT = 0;
                            forceDebitPrincipal.DESCRIPTION = "Force Debit as a result of Account not funded";
                            forceDebitPrincipal.DEBITAMOUNT = Math.Abs(item.periodPrincipalAmount);
                            forceDebitPrincipal.DATE = item.paymentDate;
                            forceDebitPrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                            forceDebitPrincipal.PARENT_FORCEDEBITCODE = item.loanRefNo;
                            forceDebitPrincipal.PRODUCTTYPEID = (short)item.productId;

                            transForceDebit.Add(forceDebitPrincipal);

                            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                            inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                            inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));
                        }
                    }

                this.context.TBL_LOAN_FORCE_DEBIT.AddRange(transForceDebit);
                result = context.SaveChanges() > 0;
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        private decimal GetPeriodInterestAmount(int loanId, DateTime paymentDate)
        {
            var interest = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == loanId && x.PAYMENTDATE == DbFunctions.TruncateTime(paymentDate));

            decimal interestAmount = 0;

            if (interest.Count() > 0)
            {
                interestAmount = interest.Sum(x => x.DAILYINTERESTAMOUNT);
            }
            else
            {
                interestAmount = 0;
            }


            return interestAmount;
        }

        private decimal GetPeriodInterestAmountFromAccural(string loanRefNo, int companyId)
        {
            var interestAmount = (from a in context.TBL_DAILY_ACCRUAL
                                  where a.REFERENCENUMBER == loanRefNo && a.COMPANYID == companyId
                                  && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan && a.REPAYMENTPOSTEDSTATUS == false
                                  && a.TRANSACTIONTYPEID == (byte)LoanTransactionTypeEnum.Interest
                                  select a.DAILYACCURALAMOUNT);

            decimal output = 0;

            if (interestAmount.Count() > 0)
            {
                output = interestAmount.Sum();
            }

            return output;
        }

        private decimal GetPeriodInterestOnPastDueInterestAmount(string loanRefNo, int companyId)
        {
            decimal output = 0;

            try
            {
                var pastDueInterest = (from a in context.TBL_DAILY_ACCRUAL
                                       where a.REFERENCENUMBER == loanRefNo && a.COMPANYID == companyId
                                       && a.CATEGORYID == (short)DailyAccrualCategory.PastDueInterest && a.REPAYMENTPOSTEDSTATUS == false
                                       && a.TRANSACTIONTYPEID == (byte)LoanTransactionTypeEnum.Interest
                                       select a.DAILYACCURALAMOUNT);

                if (pastDueInterest.Count() > 0)
                {
                    output = pastDueInterest.Sum();
                }

            }
            catch (Exception ex)
            {
                throw ex;
            }


            return output;

        }

        private decimal GetPeriodInterestOnPastDuePrincipalAmount(string loanRefNo, int companyId)
        {

            decimal output = 0;

            try
            {
                var pastDuePrincipal = (from a in context.TBL_DAILY_ACCRUAL
                                        where a.REFERENCENUMBER == loanRefNo && a.COMPANYID == companyId
                                        && a.CATEGORYID == (short)DailyAccrualCategory.PastDuePrincipal && a.REPAYMENTPOSTEDSTATUS == false
                                        && a.TRANSACTIONTYPEID == (byte)LoanTransactionTypeEnum.Interest
                                        select a.DAILYACCURALAMOUNT);

                if (pastDuePrincipal.Count() > 0)
                {
                    output = pastDuePrincipal.Sum();
                }
            }
            catch (Exception ex)
            {
                throw ex;
            }

            return output;

        }

        public IEnumerable<LoanRepaymentViewModel> ProcessLoanRepaymentPostingPastDue(DateTime applicationDate, int companyId, int staffId)
        {

            //try

            //{

            var currencyRate = (from b in context.TBL_LOAN
                                where b.LOANSTATUSID == (short)LoanStatusEnum.Active
                                 && b.ALLOWFORCEDEBITREPAYMENT == false && b.ISDISBURSED == true && b.COMPANYID == companyId
                                select new CurrencyExchangeRateViewModel()
                                {
                                    currencyId = b.CURRENCYID,
                                    companyId = b.COMPANYID,
                                }).ToList().Distinct().Select(x =>
                                {
                                    x.sellingRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, (int)x.companyId).sellingRate;
                                    return x;
                                }).ToList();


            DateTime dateChange = applicationDate;

            dateChange = dateChange.AddDays(-1);

            bool result = false;
            var scheduledLoan = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
                                 join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                                 where a.PAYMENTDATE == DbFunctions.TruncateTime(applicationDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active
                                 && b.ALLOWFORCEDEBITREPAYMENT == false && b.ISDISBURSED == true && (a.PERIODINTERESTAMOUNT + a.PERIODPRINCIPALAMOUNT) > 0 && b.COMPANYID == companyId
                                 select new LoanRepaymentViewModel()
                                 {
                                     productId = b.PRODUCTID,
                                     branchId = b.BRANCHID,
                                     companyId = b.COMPANYID,
                                     currencyId = b.CURRENCYID,
                                     //exchangeRate = b.EXCHANGERATE,
                                     periodInterestAmount = a.PERIODINTERESTAMOUNT,
                                     periodPrincipalAmount = a.PERIODPRINCIPALAMOUNT,
                                     interestRate = a.INTERESTRATE,
                                     paymentDate = applicationDate,
                                     loanId = a.LOANID,
                                     totalAmount = a.PERIODINTERESTAMOUNT + a.PERIODPRINCIPALAMOUNT,
                                     casaAccountId = b.CASAACCOUNTID,
                                     casaAccountId2 = b.CASAACCOUNTID2,
                                     loanRefNo = b.LOANREFERENCENUMBER,
                                     pastDueInterestAmount = b.PASTDUEINTEREST,
                                     pastDuePrincipalAmount = b.PASTDUEPRINCIPAL,
                                 }).ToList().Select(x =>
                                 {
                                     //x.periodInterestAmount = GetPeriodInterestAmountFromAccural(x.loanRefNo, x.companyId);  //GetPeriodInterestAmount(x.loanId, x.paymentDate);
                                     //x.periodInterestAmount = GetPeriodInterestAmount(x.loanId, x.paymentDate);
                                     //x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
                                     x.exchangeRate = currencyRate.Where(m => m.currencyId == x.currencyId).Select(m => m.sellingRate).FirstOrDefault();
                                     x.interestOnPastDueInterest = GetPeriodInterestOnPastDueInterestAmount(x.loanRefNo, x.companyId);
                                     x.interestOnPastDuePrincipal = GetPeriodInterestOnPastDuePrincipalAmount(x.loanRefNo, x.companyId);
                                     return x;
                                 }).ToList();


            //var scheduledLoanIds = (from a in scheduledLoan select a.loanId).ToList();

            //var unscheduledloans = (from b in context.TBL_LOAN
            //                        where b.MATURITYDATE == DbFunctions.TruncateTime(applicationDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active
            //                        && b.ALLOWFORCEDEBITREPAYMENT == false && b.ISDISBURSED == true && (b.OUTSTANDINGPRINCIPAL + b.OUTSTANDINGINTEREST) > 0
            //                        && !scheduledLoanIds.Contains(b.TERMLOANID)
            //                        select new LoanRepaymentViewModel()
            //                        {
            //                            productId = b.PRODUCTID,
            //                            branchId = b.BRANCHID,
            //                            companyId = b.COMPANYID,
            //                            currencyId = b.CURRENCYID,
            //                            exchangeRate = b.EXCHANGERATE,
            //                            periodInterestAmount = b.OUTSTANDINGINTEREST,
            //                            periodPrincipalAmount = b.OUTSTANDINGPRINCIPAL,
            //                            interestRate = b.INTERESTRATE,
            //                            paymentDate = applicationDate,
            //                            loanId = b.TERMLOANID,
            //                            totalAmount = b.OUTSTANDINGPRINCIPAL + b.OUTSTANDINGINTEREST,
            //                            casaAccountId = b.CASAACCOUNTID,
            //                            casaAccountId2 = b.CASAACCOUNTID2,
            //                            loanRefNo = b.LOANREFERENCENUMBER,
            //                            pastDueInterestAmount = b.PASTDUEINTEREST,
            //                            pastDuePrincipalAmount = b.PASTDUEPRINCIPAL,
            //                        }).ToList();


            var model = scheduledLoan.ToList(); //scheduledLoan.Union(unscheduledloans).ToList();


            List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();


            var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.EODDATE == dateChange && c.EODOPERATIONID == (int)EodOperationEnum.ProcessLoanRepaymentPostingPastDue).FirstOrDefault();

            if (checkExistence == null)
            {


                foreach (var item in model)
                {
                    if (item.periodPrincipalAmount > 0)
                        updateloanTablePrincipal(item.loanId, item.periodPrincipalAmount);

                    if (item.periodInterestAmount > 0)
                        updateloanTableInterest(item.loanId, item.periodInterestAmount);

                    if (item.interestOnPastDueInterest > 0)
                        updateloanTableInterestOnPastDueInterest(item.loanId, item.interestOnPastDueInterest);

                    if (item.interestOnPastDuePrincipal > 0)
                        updateloanTableInterestOnPastDuePrincipal(item.loanId, item.interestOnPastDuePrincipal);

                }


            }


            var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
            //setup.USE_THIRD_PARTY_INTEGRATION = false; // this is used here because posting api is not required on Access Credit360 
            bool doNotPostForAccess = false;
            if (doNotPostForAccess == true)
            {
                //foreach (var item in model)
                //{
                BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                result = bulkPosting.WriteBulkLoanRepaymentPostingPastDueToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate, companyId, staffId, out _transactionReferenceNo);
                //}

            }
            else
            {

                foreach (var item in model)
                {
                    var PastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == item.productId);
                    var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == item.casaAccountId && x.COMPANYID == item.companyId);
                    var casabalance = casa.AVAILABLEBALANCE;
                    decimal principalAmountNotCollected = 0;
                    decimal partialPrincipalAmountCollected = 0;
                    decimal partialInterestAmountCollected = 0;
                    decimal interestAmountNotCollected = 0;

                    if (casabalance >= item.totalAmount)
                    {

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));

                        updateloanTablePrincipal(item.loanId, item.periodPrincipalAmount);
                        updateloanTableInterest(item.loanId, item.periodInterestAmount);
                    }
                    else if (casabalance > item.periodInterestAmount && casabalance < item.totalAmount)
                    {
                        partialPrincipalAmountCollected = casabalance - item.periodInterestAmount; ;
                        principalAmountNotCollected = item.periodPrincipalAmount - partialPrincipalAmountCollected;
                        TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();


                        pastDue.LOANID = item.loanId;
                        //pastDue.PARENT_PASTDUECODE = PastDueCode;
                        pastDue.PASTDUECODE = PastDueCode;
                        pastDue.CREDITAMOUNT = 0;
                        pastDue.DESCRIPTION = "Past Due Entries on Principal as a result of Account not funded";
                        pastDue.DEBITAMOUNT = Math.Abs(principalAmountNotCollected);
                        pastDue.DATE = item.paymentDate;
                        pastDue.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        pastDue.PARENT_PASTDUECODE = item.loanRefNo;
                        pastDue.PRODUCTTYPEID = product.PRODUCTTYPEID;

                        transPastDue.Add(pastDue);
                        updateloanTablePastDuePrincipal(pastDue.LOANID, pastDue.DEBITAMOUNT);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));
                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, partialPrincipalAmountCollected, product.PRINCIPALBALANCEGL.Value, "partial principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));

                        updateloanTableInterest(item.loanId, item.periodInterestAmount);
                        updateloanTablePrincipal(item.loanId, partialPrincipalAmountCollected);

                        CasaLienViewModel lien = new CasaLienViewModel();

                        lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
                        lien.lienAmount = pastDue.DEBITAMOUNT;
                        lien.branchId = item.branchId;
                        lien.companyId = item.companyId;
                        lien.lienTypeId = (short)LienTypeEnum.PrincipalRepayment;
                        lien.createdBy = (int)SystemStaff.System;
                        lien.description = "lien placed due to Account not funded at Anniversary Date";

                        casaLien.PlaceLien(lien);
                    }
                    else if (casabalance < item.periodInterestAmount && casabalance > 0)
                    {
                        partialInterestAmountCollected = casabalance;
                        interestAmountNotCollected = item.periodInterestAmount - partialInterestAmountCollected;
                        TBL_LOAN_PAST_DUE pastDueInterest = new TBL_LOAN_PAST_DUE();

                        pastDueInterest.LOANID = item.loanId;
                        pastDueInterest.PASTDUECODE = PastDueCode;
                        pastDueInterest.CREDITAMOUNT = 0;
                        pastDueInterest.DESCRIPTION = "Past Due Entries on Interest as a result of Account not funded";
                        pastDueInterest.DEBITAMOUNT = Math.Abs(interestAmountNotCollected);
                        pastDueInterest.DATE = item.paymentDate;
                        pastDueInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                        pastDueInterest.PARENT_PASTDUECODE = item.loanRefNo;
                        pastDueInterest.PRODUCTTYPEID = product.PRODUCTTYPEID;

                        transPastDue.Add(pastDueInterest);

                        updateloanTablePastDueInterest(pastDueInterest.LOANID, pastDueInterest.DEBITAMOUNT);

                        TBL_LOAN_PAST_DUE pastDuePrincipal = new TBL_LOAN_PAST_DUE();

                        pastDuePrincipal.LOANID = item.loanId;
                        pastDuePrincipal.PASTDUECODE = PastDueCode;
                        pastDuePrincipal.CREDITAMOUNT = 0;
                        pastDuePrincipal.DESCRIPTION = "Past Due Entries on Principal as a result of Account not funded";
                        pastDuePrincipal.DEBITAMOUNT = item.periodPrincipalAmount;
                        pastDuePrincipal.DATE = item.paymentDate;
                        pastDuePrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        pastDuePrincipal.PARENT_PASTDUECODE = item.loanRefNo;
                        pastDuePrincipal.PRODUCTTYPEID = product.PRODUCTTYPEID;

                        transPastDue.Add(pastDuePrincipal);

                        updateloanTablePastDuePrincipal(pastDuePrincipal.LOANID, pastDuePrincipal.DEBITAMOUNT);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, partialInterestAmountCollected, product.INTERESTRECEIVABLEPAYABLEGL.Value, "partial interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        updateloanTableInterest(item.loanId, partialInterestAmountCollected);

                        CasaLienViewModel lien = new CasaLienViewModel();

                        lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lien.sourceReferenceNumber = pastDueInterest.PARENT_PASTDUECODE;
                        lien.lienAmount = pastDueInterest.DEBITAMOUNT;
                        lien.branchId = item.branchId;
                        lien.companyId = item.companyId;
                        lien.lienTypeId = (short)LienTypeEnum.InterestRepayment;
                        lien.createdBy = (int)SystemStaff.System;
                        lien.description = "lien placed due to Account not swinging to positive";

                        var lienReference = casaLien.PlaceLien(lien);

                        CasaLienViewModel lienPrincipal = new CasaLienViewModel();

                        lienPrincipal.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lienPrincipal.sourceReferenceNumber = pastDuePrincipal.PARENT_PASTDUECODE;
                        lienPrincipal.lienAmount = pastDuePrincipal.DEBITAMOUNT;
                        lienPrincipal.branchId = item.branchId;
                        lienPrincipal.companyId = item.companyId;
                        lienPrincipal.lienTypeId = (short)LienTypeEnum.PrincipalRepayment;
                        lienPrincipal.createdBy = (int)SystemStaff.System;
                        lienPrincipal.description = "lien placed due to Account not funded at Anniversary Date";

                        lienReference = casaLien.PlaceLien(lienPrincipal);
                    }
                    else if (casabalance <= 0)
                    {
                        TBL_LOAN_PAST_DUE pastDueInterest = new TBL_LOAN_PAST_DUE();

                        pastDueInterest.LOANID = item.loanId;
                        pastDueInterest.PASTDUECODE = PastDueCode;
                        pastDueInterest.CREDITAMOUNT = 0;
                        pastDueInterest.DESCRIPTION = "Past Due Entries on Interest as a result of Account not funded";
                        pastDueInterest.DEBITAMOUNT = Math.Abs(item.periodInterestAmount);
                        pastDueInterest.DATE = item.paymentDate;
                        pastDueInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                        pastDueInterest.PARENT_PASTDUECODE = item.loanRefNo;
                        pastDueInterest.PRODUCTTYPEID = product.PRODUCTTYPEID;

                        transPastDue.Add(pastDueInterest);

                        updateloanTablePastDueInterest(pastDueInterest.LOANID, pastDueInterest.DEBITAMOUNT);

                        TBL_LOAN_PAST_DUE pastDuePrincipal = new TBL_LOAN_PAST_DUE();

                        pastDuePrincipal.LOANID = item.loanId;
                        pastDuePrincipal.PASTDUECODE = PastDueCode;
                        pastDuePrincipal.CREDITAMOUNT = 0;
                        pastDuePrincipal.DESCRIPTION = "Past Due Entries on Principal as a result of Account not funded";
                        pastDuePrincipal.DEBITAMOUNT = Math.Abs(item.periodPrincipalAmount);
                        pastDuePrincipal.DATE = item.paymentDate;
                        pastDuePrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        pastDuePrincipal.PARENT_PASTDUECODE = item.loanRefNo;
                        pastDuePrincipal.PRODUCTTYPEID = product.PRODUCTTYPEID;

                        transPastDue.Add(pastDuePrincipal); ;
                        updateloanTablePastDuePrincipal(pastDuePrincipal.LOANID, pastDuePrincipal.DEBITAMOUNT);

                        CasaLienViewModel lien = new CasaLienViewModel();

                        lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lien.sourceReferenceNumber = pastDueInterest.PARENT_PASTDUECODE;
                        lien.lienAmount = pastDueInterest.DEBITAMOUNT;
                        lien.branchId = item.branchId;
                        lien.companyId = item.companyId;
                        lien.lienTypeId = (short)LienTypeEnum.InterestRepayment;
                        lien.createdBy = (int)SystemStaff.System;
                        lien.description = "lien placed due to Account not funded at Anniversary Date";

                        var lienReference = casaLien.PlaceLien(lien);

                        CasaLienViewModel lienPrincipal = new CasaLienViewModel();

                        lienPrincipal.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lienPrincipal.sourceReferenceNumber = pastDuePrincipal.PARENT_PASTDUECODE;
                        lienPrincipal.lienAmount = pastDuePrincipal.DEBITAMOUNT;
                        lienPrincipal.branchId = item.branchId;
                        lienPrincipal.companyId = item.companyId;
                        lienPrincipal.lienTypeId = (short)LienTypeEnum.PrincipalRepayment;
                        lienPrincipal.createdBy = (int)SystemStaff.System;
                        lienPrincipal.description = "lien placed due to Account not funded at Anniversary Date";

                        lienReference = casaLien.PlaceLien(lienPrincipal);
                    }
                }
            }


            this.context.TBL_LOAN_PAST_DUE.AddRange(transPastDue);

            if (result)
            {
                return model;
            }
            return null;
            //}
            //catch (Exception ex)
            //{
            //    throw ex;
            //}
        }

        public IEnumerable<LoanRepaymentViewModel> ProcessAuthorisedOverdraftRepaymentPostingForceDebit(DateTime applicationDate)
        {
            try
            {
                var firstDayOfMonth = new DateTime(applicationDate.Year, applicationDate.Month, 1);
                var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
                var model = (from a in context.TBL_LOAN_REVOLVING
                             join b in context.TBL_CASA on a.CASAACCOUNTID equals b.CASAACCOUNTID
                             join c in context.TBL_DAILY_ACCRUAL on a.LOANREFERENCENUMBER equals c.REFERENCENUMBER
                             where firstDayOfMonth <= DbFunctions.TruncateTime(applicationDate) && lastDayOfMonth <= DbFunctions.TruncateTime(applicationDate)
                             && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                             && c.CATEGORYID == (short)DailyAccrualCategory.AuthorisedOverdraft
                             && b.AVAILABLEBALANCE < 0
                             group c by new
                             {
                                 a.PRODUCTID,
                                 a.BRANCHID,
                                 a.COMPANYID,
                                 a.CURRENCYID,
                                 a.EXCHANGERATE,
                                 a.LOANREFERENCENUMBER,
                                 c.INTERESTRATE,
                                 a.REVOLVINGLOANID,
                                 b.CASAACCOUNTID
                             } into groupedQ
                             select new LoanRepaymentViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 exchangeRate = groupedQ.Key.EXCHANGERATE,
                                 interestRate = groupedQ.Key.INTERESTRATE,
                                 paymentDate = applicationDate,
                                 loanId = groupedQ.Key.REVOLVINGLOANID,
                                 casaAccountId = groupedQ.Key.CASAACCOUNTID,
                                 loanRefNo = groupedQ.Key.LOANREFERENCENUMBER,
                                 periodInterestAmount = groupedQ.Sum(i => i.DAILYACCURALAMOUNT)


                             }).ToList();

                List<TBL_LOAN_FORCE_DEBIT> transForceDebit = new List<TBL_LOAN_FORCE_DEBIT>();


                foreach (var item in model)
                {
                    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == item.productId);
                    var forceDebitCode = CommonHelpers.GenerateRandomDigitCode(10);
                    item.createdBy = (int)SystemStaff.System;
                    List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                    inputTransactions.Add(financeTransaction.PostBuildAuthorisedOverdraftRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                }

                this.context.TBL_LOAN_FORCE_DEBIT.AddRange(transForceDebit);

                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public IEnumerable<LoanRepaymentViewModel> ProcessUnauthorisedOverdraftRepaymentPostingForceDebit(DateTime applicationDate)
        {
            try
            {
                var firstDayOfMonth = new DateTime(applicationDate.Year, applicationDate.Month, 1);
                var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
                var model = (from a in context.TBL_LOAN
                             join b in context.TBL_CASA on a.CASAACCOUNTID equals b.CASAACCOUNTID
                             join c in context.TBL_DAILY_ACCRUAL on a.LOANREFERENCENUMBER equals c.REFERENCENUMBER
                             where firstDayOfMonth <= DbFunctions.TruncateTime(applicationDate) && lastDayOfMonth <= DbFunctions.TruncateTime(applicationDate)
                             && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                             && c.CATEGORYID == (short)DailyAccrualCategory.UnauthorisedOverdraft
                             && b.AVAILABLEBALANCE < 0
                             group c by new
                             { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, a.EXCHANGERATE, a.LOANREFERENCENUMBER, c.INTERESTRATE, a.TERMLOANID, b.CASAACCOUNTID } into groupedQ
                             select new LoanRepaymentViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 exchangeRate = groupedQ.Key.EXCHANGERATE,
                                 interestRate = groupedQ.Key.INTERESTRATE,
                                 paymentDate = applicationDate,
                                 loanId = groupedQ.Key.TERMLOANID,
                                 casaAccountId = groupedQ.Key.CASAACCOUNTID,
                                 loanRefNo = groupedQ.Key.LOANREFERENCENUMBER,
                                 periodInterestAmount = groupedQ.Sum(i => i.DAILYACCURALAMOUNT)


                             }).ToList();

                List<TBL_LOAN_FORCE_DEBIT> transForceDebit = new List<TBL_LOAN_FORCE_DEBIT>();


                foreach (var item in model)
                {
                    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == item.productId);
                    var forceDebitCode = CommonHelpers.GenerateRandomDigitCode(10);
                    item.createdBy = (int)SystemStaff.System;
                    List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                    inputTransactions.Add(financeTransaction.PostBuildAuthorisedOverdraftRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));
                }

                this.context.TBL_LOAN_FORCE_DEBIT.AddRange(transForceDebit);

                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        public IEnumerable<LoanPastDueViewModel> ProcessUnauthorisedOverdraftInterestRepaymentPostingPastDue(DateTime applicationDate)

        {
            try
            {
                var firstDayOfMonth = new DateTime(applicationDate.Year, applicationDate.Month, 1);
                var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

                var model = (from a in context.TBL_LOAN_PAST_DUE
                             where firstDayOfMonth <= DbFunctions.TruncateTime(applicationDate) && lastDayOfMonth <= DbFunctions.TruncateTime(applicationDate)
                             && a.TRANSACTIONTYPEID == (byte)LoanTransactionTypeEnum.Interest
                             group a by new
                             { a.LOANID, a.TRANSACTIONTYPEID, a.PASTDUECODE, a.PARENT_PASTDUECODE } into groupedQ
                             select new LoanPastDueViewModel()
                             {
                                 loanId = groupedQ.Key.LOANID,
                                 transactionTypeId = groupedQ.Key.TRANSACTIONTYPEID,
                                 pastDueCode = groupedQ.Key.PASTDUECODE,
                                 parent_PastDueCode = groupedQ.Key.PARENT_PASTDUECODE,
                                 totalAmount = groupedQ.Sum(i => (i.DEBITAMOUNT - i.CREDITAMOUNT)),
                             }).ToList();

                List<TBL_LOAN_PAST_DUE> loanPastDue = new List<TBL_LOAN_PAST_DUE>();

                foreach (var item in model)
                {
                    TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();

                    pastDue.LOANID = item.loanId;
                    pastDue.PASTDUECODE = item.pastDueCode;
                    pastDue.CREDITAMOUNT = 0;
                    pastDue.DESCRIPTION = "Interest Accrual as a result of Past Due";
                    pastDue.DEBITAMOUNT = Math.Abs(item.totalAmount);
                    pastDue.DATE = applicationDate;
                    pastDue.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                    pastDue.PARENT_PASTDUECODE = item.parent_PastDueCode;

                    loanPastDue.Add(pastDue);

                }

                this.context.TBL_LOAN_PAST_DUE.AddRange(loanPastDue);

                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        public IEnumerable<LoanPastDueViewModel> ProcessUnauthorisedOverdraftPrincipalRepaymentPostingPastDue(DateTime applicationDate)

        {
            try
            {
                var firstDayOfMonth = new DateTime(applicationDate.Year, applicationDate.Month, 1);
                var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

                var model = (from a in context.TBL_LOAN_PAST_DUE
                             where firstDayOfMonth <= DbFunctions.TruncateTime(applicationDate) && lastDayOfMonth <= DbFunctions.TruncateTime(applicationDate)
                             && a.TRANSACTIONTYPEID == (byte)LoanTransactionTypeEnum.Principal
                             group a by new
                             { a.LOANID, a.TRANSACTIONTYPEID, a.PASTDUECODE, a.PARENT_PASTDUECODE } into groupedQ
                             select new LoanPastDueViewModel()
                             {
                                 loanId = groupedQ.Key.LOANID,
                                 transactionTypeId = groupedQ.Key.TRANSACTIONTYPEID,
                                 pastDueCode = groupedQ.Key.PASTDUECODE,
                                 parent_PastDueCode = groupedQ.Key.PARENT_PASTDUECODE,
                                 totalAmount = groupedQ.Sum(i => (i.DEBITAMOUNT - i.CREDITAMOUNT)),
                             }).ToList();

                List<TBL_LOAN_PAST_DUE> loanPastDue = new List<TBL_LOAN_PAST_DUE>();



                foreach (var item in model)
                {
                    TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();


                    pastDue.LOANID = item.loanId;
                    pastDue.PASTDUECODE = item.pastDueCode;
                    pastDue.CREDITAMOUNT = 0;
                    pastDue.DESCRIPTION = "Principal Accrual as a result of Past Due";
                    pastDue.DEBITAMOUNT = Math.Abs(item.totalAmount);
                    pastDue.DATE = applicationDate;
                    pastDue.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                    pastDue.PARENT_PASTDUECODE = item.parent_PastDueCode;

                    loanPastDue.Add(pastDue);

                }

                this.context.TBL_LOAN_PAST_DUE.AddRange(loanPastDue);

                var result = context.SaveChanges() > 0;
                if (result)
                {

                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }


        }

        public IEnumerable<LoanRepaymentViewModel> ProcessLoanRepaymentPostingForceDebitForInterestReview(DateTime applicationDate, int loanId)
        {
            try
            {
                var systemDate = generalSetup.GetApplicationDate();

                var model = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
                             join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                             where b.LOANSTATUSID == (short)LoanStatusEnum.Active
                             && b.ALLOWFORCEDEBITREPAYMENT == true && a.LOANID == loanId
                             && a.PAYMENTDATE >= DbFunctions.TruncateTime(applicationDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(systemDate)
                             && (a.PERIODINTERESTAMOUNT + a.PERIODPRINCIPALAMOUNT) > 0
                             select new LoanRepaymentViewModel()
                             {
                                 productId = b.PRODUCTID,
                                 branchId = b.BRANCHID,
                                 companyId = b.COMPANYID,
                                 currencyId = b.CURRENCYID,
                                 exchangeRate = b.EXCHANGERATE,
                                 periodInterestAmount = a.PERIODINTERESTAMOUNT,
                                 periodPrincipalAmount = a.PERIODPRINCIPALAMOUNT,
                                 interestRate = a.INTERESTRATE,
                                 paymentDate = applicationDate,
                                 loanId = a.LOANID,
                                 totalAmount = a.PERIODINTERESTAMOUNT + a.PERIODPRINCIPALAMOUNT,
                                 casaAccountId = b.CASAACCOUNTID,
                                 loanRefNo = b.LOANREFERENCENUMBER

                             }).ToList();

                List<TBL_LOAN_FORCE_DEBIT> transForceDebit = new List<TBL_LOAN_FORCE_DEBIT>();


                foreach (var item in model)
                {
                    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == item.productId);

                    var forceDebitCode = CommonHelpers.GenerateRandomDigitCode(10);
                    var casabalance = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == item.casaAccountId).AVAILABLEBALANCE;
                    if (casabalance >= item.totalAmount)
                    {
                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));

                    }
                    else if (casabalance > item.periodInterestAmount && casabalance < item.totalAmount)
                    {
                        TBL_LOAN_FORCE_DEBIT forceDebit = new TBL_LOAN_FORCE_DEBIT();

                        forceDebit.LOANID = item.loanId;
                        forceDebit.FORCEDEBITCODE = forceDebitCode;
                        forceDebit.CREDITAMOUNT = 0;
                        forceDebit.DESCRIPTION = "Force Debit as a result of Account not funded";
                        forceDebit.DEBITAMOUNT = Math.Abs(casabalance - item.totalAmount);
                        forceDebit.DATE = item.paymentDate;
                        forceDebit.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        forceDebit.PARENT_FORCEDEBITCODE = item.loanRefNo;

                        transForceDebit.Add(forceDebit);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "partial principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));
                    }
                    else if (casabalance < item.periodInterestAmount && casabalance > 0)
                    {
                        TBL_LOAN_FORCE_DEBIT forceDebitInterest = new TBL_LOAN_FORCE_DEBIT();

                        forceDebitInterest.LOANID = item.loanId;
                        forceDebitInterest.FORCEDEBITCODE = forceDebitCode;
                        forceDebitInterest.CREDITAMOUNT = 0;
                        forceDebitInterest.DESCRIPTION = "Force Debit as a result of Account not funded";
                        forceDebitInterest.DEBITAMOUNT = Math.Abs(casabalance - item.periodInterestAmount);
                        forceDebitInterest.DATE = item.paymentDate;
                        forceDebitInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                        forceDebitInterest.PARENT_FORCEDEBITCODE = item.loanRefNo;

                        transForceDebit.Add(forceDebitInterest);

                        TBL_LOAN_FORCE_DEBIT forceDebitPrincipal = new TBL_LOAN_FORCE_DEBIT();

                        forceDebitPrincipal.LOANID = item.loanId;
                        forceDebitPrincipal.FORCEDEBITCODE = forceDebitCode;
                        forceDebitPrincipal.CREDITAMOUNT = 0;
                        forceDebitPrincipal.DESCRIPTION = "Force Debit as a result of Account not funded";
                        forceDebitPrincipal.DEBITAMOUNT = item.periodPrincipalAmount;
                        forceDebitPrincipal.DATE = item.paymentDate;
                        forceDebitPrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        forceDebitPrincipal.PARENT_FORCEDEBITCODE = item.loanRefNo;

                        transForceDebit.Add(forceDebitPrincipal);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "partial interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));
                    }
                    else if (casabalance <= 0)
                    {
                        TBL_LOAN_FORCE_DEBIT forceDebitInterest = new TBL_LOAN_FORCE_DEBIT();

                        forceDebitInterest.LOANID = item.loanId;
                        forceDebitInterest.FORCEDEBITCODE = forceDebitCode;
                        forceDebitInterest.CREDITAMOUNT = 0;
                        forceDebitInterest.DESCRIPTION = "Force Debit as a result of Account not funded";
                        forceDebitInterest.DEBITAMOUNT = Math.Abs(item.periodInterestAmount);
                        forceDebitInterest.DATE = item.paymentDate;
                        forceDebitInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                        forceDebitInterest.PARENT_FORCEDEBITCODE = item.loanRefNo;
                        forceDebitInterest.PRODUCTTYPEID = (short)item.productId;

                        transForceDebit.Add(forceDebitInterest);

                        TBL_LOAN_FORCE_DEBIT forceDebitPrincipal = new TBL_LOAN_FORCE_DEBIT();

                        forceDebitPrincipal.LOANID = item.loanId;
                        forceDebitPrincipal.FORCEDEBITCODE = forceDebitCode;
                        forceDebitPrincipal.CREDITAMOUNT = 0;
                        forceDebitPrincipal.DESCRIPTION = "Force Debit as a result of Account not funded";
                        forceDebitPrincipal.DEBITAMOUNT = Math.Abs(item.periodPrincipalAmount);
                        forceDebitPrincipal.DATE = item.paymentDate;
                        forceDebitPrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        forceDebitPrincipal.PARENT_FORCEDEBITCODE = item.loanRefNo;
                        forceDebitPrincipal.PRODUCTTYPEID = (short)item.productId;

                        transForceDebit.Add(forceDebitPrincipal);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));
                    }
                }

                this.context.TBL_LOAN_FORCE_DEBIT.AddRange(transForceDebit);

                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        public IEnumerable<LoanRepaymentViewModel> ProcessLoanRepaymentPostingPastDueForInterestReview(DateTime applicationDate, int loanId)

        {
            try
            {
                var systemDate = generalSetup.GetApplicationDate();

                var model = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
                             join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                             where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.ALLOWFORCEDEBITREPAYMENT == false && a.LOANID == loanId
                              && a.PAYMENTDATE >= DbFunctions.TruncateTime(applicationDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(systemDate)
                             group a by new
                             {
                                 b.PRODUCTID,
                                 b.BRANCHID,
                                 b.COMPANYID,
                                 b.CURRENCYID,
                                 b.EXCHANGERATE,
                                 a.INTERESTRATE,
                                 a.LOANID,
                                 b.CASAACCOUNTID,
                                 b.LOANREFERENCENUMBER,
                                 applicationDate
                             } into groupedQ
                             select new LoanRepaymentViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 exchangeRate = groupedQ.Key.EXCHANGERATE,
                                 interestRate = groupedQ.Key.INTERESTRATE,
                                 paymentDate = groupedQ.Key.applicationDate,
                                 loanId = groupedQ.Key.LOANID,
                                 casaAccountId = groupedQ.Key.CASAACCOUNTID,
                                 loanRefNo = groupedQ.Key.LOANREFERENCENUMBER,
                                 periodInterestAmount = groupedQ.Sum(i => i.PERIODINTERESTAMOUNT),
                                 periodPrincipalAmount = groupedQ.Sum(i => i.PERIODPRINCIPALAMOUNT),
                                 totalAmount = groupedQ.Sum(i => i.PERIODINTERESTAMOUNT) + groupedQ.Sum(i => i.PERIODPRINCIPALAMOUNT),
                             }).ToList();

                List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();

                foreach (var item in model)
                {
                    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == item.productId);

                    var pastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                    var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == item.casaAccountId);
                    var casabalance = casa.AVAILABLEBALANCE;
                    if (casabalance >= item.totalAmount)
                    {

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));
                    }
                    else if (casabalance > item.periodInterestAmount && casabalance < item.totalAmount)
                    {
                        TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();

                        pastDue.LOANID = item.loanId;
                        pastDue.PASTDUECODE = pastDueCode;
                        pastDue.CREDITAMOUNT = 0;
                        pastDue.DESCRIPTION = "Force Debit as a result of Account not funded";
                        pastDue.DEBITAMOUNT = Math.Abs(casabalance - item.totalAmount);
                        pastDue.DATE = item.paymentDate;
                        pastDue.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        pastDue.PARENT_PASTDUECODE = item.loanRefNo;

                        transPastDue.Add(pastDue);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));
                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, pastDue.DEBITAMOUNT, product.PRINCIPALBALANCEGL.Value, "partial principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));

                        CasaLienViewModel lien = new CasaLienViewModel();

                        lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
                        lien.lienAmount = pastDue.DEBITAMOUNT;
                        lien.branchId = item.branchId;
                        lien.companyId = item.companyId;
                        lien.lienTypeId = (short)LienTypeEnum.PrincipalRepayment;
                        lien.createdBy = (int)SystemStaff.System;
                        lien.description = "lien placed due to Account not funded at Restructure Date";

                        var lienReference = casaLien.PlaceLien(lien);

                    }
                    else if (casabalance < item.periodInterestAmount && casabalance > 0)
                    {
                        TBL_LOAN_PAST_DUE pastDueInterest = new TBL_LOAN_PAST_DUE();

                        pastDueInterest.LOANID = item.loanId;
                        pastDueInterest.PASTDUECODE = pastDueCode;
                        pastDueInterest.CREDITAMOUNT = 0;
                        pastDueInterest.DESCRIPTION = "Force Debit as a result of Account not funded";
                        pastDueInterest.DEBITAMOUNT = Math.Abs(casabalance - item.periodInterestAmount);
                        pastDueInterest.DATE = item.paymentDate;
                        pastDueInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                        pastDueInterest.PARENT_PASTDUECODE = item.loanRefNo;

                        transPastDue.Add(pastDueInterest);

                        TBL_LOAN_PAST_DUE pastDuePrincipal = new TBL_LOAN_PAST_DUE();

                        pastDuePrincipal.LOANID = item.loanId;
                        pastDuePrincipal.PASTDUECODE = pastDueCode;
                        pastDuePrincipal.CREDITAMOUNT = 0;
                        pastDuePrincipal.DESCRIPTION = "Force Debit as a result of Account not funded";
                        pastDuePrincipal.DEBITAMOUNT = item.periodPrincipalAmount;
                        pastDuePrincipal.DATE = item.paymentDate;
                        pastDuePrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        pastDuePrincipal.PARENT_PASTDUECODE = item.loanRefNo;

                        transPastDue.Add(pastDuePrincipal);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, pastDueInterest.DEBITAMOUNT, product.INTERESTRECEIVABLEPAYABLEGL.Value, "partial interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        CasaLienViewModel lien = new CasaLienViewModel();

                        lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lien.sourceReferenceNumber = pastDueInterest.PARENT_PASTDUECODE;
                        lien.lienAmount = pastDueInterest.DEBITAMOUNT;
                        lien.branchId = item.branchId;
                        lien.companyId = item.companyId;
                        lien.lienTypeId = (short)LienTypeEnum.InterestRepayment;
                        lien.createdBy = (int)SystemStaff.System;
                        lien.description = "lien placed due to Account not funded at Restructure Date";

                        var lienReference = casaLien.PlaceLien(lien);

                        CasaLienViewModel lienPrincipal = new CasaLienViewModel();

                        lienPrincipal.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lienPrincipal.sourceReferenceNumber = pastDuePrincipal.PARENT_PASTDUECODE;
                        lienPrincipal.lienAmount = pastDuePrincipal.DEBITAMOUNT;
                        lienPrincipal.branchId = item.branchId;
                        lienPrincipal.companyId = item.companyId;
                        lienPrincipal.lienTypeId = (short)LienTypeEnum.PrincipalRepayment;
                        lienPrincipal.createdBy = (int)SystemStaff.System;
                        lienPrincipal.description = "lien placed due to Account not funded at Restructure Date";

                        casaLien.PlaceLien(lienPrincipal);


                    }
                    else if (casabalance <= 0)
                    {
                        TBL_LOAN_PAST_DUE pastDueInterest = new TBL_LOAN_PAST_DUE();

                        pastDueInterest.LOANID = item.loanId;
                        pastDueInterest.PASTDUECODE = pastDueCode;
                        pastDueInterest.CREDITAMOUNT = 0;
                        pastDueInterest.DESCRIPTION = "Force Debit as a result of Account not funded";
                        pastDueInterest.DEBITAMOUNT = Math.Abs(item.periodInterestAmount);
                        pastDueInterest.DATE = item.paymentDate;
                        pastDueInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                        pastDueInterest.PARENT_PASTDUECODE = item.loanRefNo;
                        pastDueInterest.PRODUCTTYPEID = item.productId;

                        transPastDue.Add(pastDueInterest);

                        TBL_LOAN_PAST_DUE pastDuePrincipal = new TBL_LOAN_PAST_DUE();

                        pastDuePrincipal.LOANID = item.loanId;
                        pastDuePrincipal.PASTDUECODE = pastDueCode;
                        pastDuePrincipal.CREDITAMOUNT = 0;
                        pastDuePrincipal.DESCRIPTION = "Force Debit as a result of Account not funded";
                        pastDuePrincipal.DEBITAMOUNT = Math.Abs(item.periodPrincipalAmount);
                        pastDuePrincipal.DATE = item.paymentDate;
                        pastDuePrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        pastDuePrincipal.PARENT_PASTDUECODE = item.loanRefNo;
                        pastDuePrincipal.PRODUCTTYPEID = item.productId;

                        transPastDue.Add(pastDuePrincipal);

                        CasaLienViewModel lien = new CasaLienViewModel();

                        lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lien.sourceReferenceNumber = pastDueInterest.PARENT_PASTDUECODE;
                        lien.lienAmount = pastDueInterest.DEBITAMOUNT;
                        lien.branchId = item.branchId;
                        lien.companyId = item.companyId;
                        lien.lienTypeId = (short)LienTypeEnum.InterestRepayment;
                        lien.createdBy = (int)SystemStaff.System;
                        lien.description = "lien placed due to Account not funded at Restructure Date";

                        var lienReference = casaLien.PlaceLien(lien);

                        CasaLienViewModel lienPrincipal = new CasaLienViewModel();

                        lienPrincipal.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lienPrincipal.sourceReferenceNumber = pastDuePrincipal.PARENT_PASTDUECODE;
                        lienPrincipal.lienAmount = pastDuePrincipal.DEBITAMOUNT;
                        lienPrincipal.branchId = item.branchId;
                        lienPrincipal.companyId = item.companyId;
                        lienPrincipal.lienTypeId = (short)LienTypeEnum.PrincipalRepayment;
                        lienPrincipal.createdBy = (int)SystemStaff.System;
                        lienPrincipal.description = "lien placed due to Account not funded at Restructure Date";

                        casaLien.PlaceLien(lienPrincipal);

                    }
                }

                this.context.TBL_LOAN_PAST_DUE.AddRange(transPastDue);

                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        public IEnumerable<LoanRepaymentViewModel> ProcessLoanRepaymentPostingPastDueForBulkInterestReview(DateTime applicationDate)

        {
            try
            {
                var systemDate = generalSetup.GetApplicationDate();

                var model = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
                             join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                             where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.ALLOWFORCEDEBITREPAYMENT == false
                              && a.PAYMENTDATE >= DbFunctions.TruncateTime(applicationDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(systemDate)
                             group a by new
                             {
                                 b.PRODUCTID,
                                 b.BRANCHID,
                                 b.COMPANYID,
                                 b.CURRENCYID,
                                 b.EXCHANGERATE,
                                 a.INTERESTRATE,
                                 a.LOANID,
                                 b.CASAACCOUNTID,
                                 b.LOANREFERENCENUMBER,
                                 applicationDate
                             } into groupedQ
                             select new LoanRepaymentViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 exchangeRate = groupedQ.Key.EXCHANGERATE,
                                 interestRate = groupedQ.Key.INTERESTRATE,
                                 paymentDate = groupedQ.Key.applicationDate,
                                 loanId = groupedQ.Key.LOANID,
                                 casaAccountId = groupedQ.Key.CASAACCOUNTID,
                                 loanRefNo = groupedQ.Key.LOANREFERENCENUMBER,
                                 periodInterestAmount = groupedQ.Sum(i => i.PERIODINTERESTAMOUNT),
                                 periodPrincipalAmount = groupedQ.Sum(i => i.PERIODPRINCIPALAMOUNT),
                                 totalAmount = groupedQ.Sum(i => i.PERIODINTERESTAMOUNT) + groupedQ.Sum(i => i.PERIODPRINCIPALAMOUNT),
                             }).ToList();

                List<TBL_LOAN_PAST_DUE> transPastDue = new List<TBL_LOAN_PAST_DUE>();

                foreach (var item in model)
                {
                    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == item.productId);

                    var pastDueCode = CommonHelpers.GenerateRandomDigitCode(10);
                    var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == item.casaAccountId);
                    var casabalance = casa.AVAILABLEBALANCE;
                    if (casabalance >= item.totalAmount)
                    {

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));
                    }
                    else if (casabalance > item.periodInterestAmount && casabalance < item.totalAmount)
                    {
                        TBL_LOAN_PAST_DUE pastDue = new TBL_LOAN_PAST_DUE();


                        pastDue.LOANID = item.loanId;
                        pastDue.PASTDUECODE = pastDueCode;
                        pastDue.CREDITAMOUNT = 0;
                        pastDue.DESCRIPTION = "Force Debit as a result of Account not funded";
                        pastDue.DEBITAMOUNT = Math.Abs(casabalance - item.totalAmount);
                        pastDue.DATE = item.paymentDate;
                        pastDue.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        pastDue.PARENT_PASTDUECODE = item.loanRefNo;

                        transPastDue.Add(pastDue);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment", (int)OperationsEnum.InterestLoanRepayment));
                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, pastDue.DEBITAMOUNT, product.PRINCIPALBALANCEGL.Value, "partial principal repayment", (int)OperationsEnum.PrincipalLoanRepayment));

                        CasaLienViewModel lien = new CasaLienViewModel();

                        lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lien.sourceReferenceNumber = pastDue.PARENT_PASTDUECODE;
                        lien.lienAmount = pastDue.DEBITAMOUNT;
                        lien.branchId = item.branchId;
                        lien.companyId = item.companyId;
                        lien.lienTypeId = (short)LienTypeEnum.PrincipalRepayment;
                        lien.createdBy = (int)SystemStaff.System;
                        lien.description = "lien placed due to Account not funded at Restructure Date";

                        var lienReference = casaLien.PlaceLien(lien);

                    }
                    else if (casabalance < item.periodInterestAmount && casabalance > 0)
                    {
                        TBL_LOAN_PAST_DUE pastDueInterest = new TBL_LOAN_PAST_DUE();

                        pastDueInterest.LOANID = item.loanId;
                        pastDueInterest.PASTDUECODE = pastDueCode;
                        pastDueInterest.CREDITAMOUNT = 0;
                        pastDueInterest.DESCRIPTION = "Force Debit as a result of Account not funded";
                        pastDueInterest.DEBITAMOUNT = Math.Abs(casabalance - item.periodInterestAmount);
                        pastDueInterest.DATE = item.paymentDate;
                        pastDueInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                        pastDueInterest.PARENT_PASTDUECODE = item.loanRefNo;

                        transPastDue.Add(pastDueInterest);

                        TBL_LOAN_PAST_DUE pastDuePrincipal = new TBL_LOAN_PAST_DUE();

                        pastDuePrincipal.LOANID = item.loanId;
                        pastDuePrincipal.PASTDUECODE = pastDueCode;
                        pastDuePrincipal.CREDITAMOUNT = 0;
                        pastDuePrincipal.DESCRIPTION = "Force Debit as a result of Account not funded";
                        pastDuePrincipal.DEBITAMOUNT = item.periodPrincipalAmount;
                        pastDuePrincipal.DATE = item.paymentDate;
                        pastDuePrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        pastDuePrincipal.PARENT_PASTDUECODE = item.loanRefNo;

                        transPastDue.Add(pastDuePrincipal);

                        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                        inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, pastDueInterest.DEBITAMOUNT, product.INTERESTRECEIVABLEPAYABLEGL.Value, "partial interest repayment", (int)OperationsEnum.InterestLoanRepayment));

                        CasaLienViewModel lien = new CasaLienViewModel();

                        lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lien.sourceReferenceNumber = pastDueInterest.PARENT_PASTDUECODE;
                        lien.lienAmount = pastDueInterest.DEBITAMOUNT;
                        lien.branchId = item.branchId;
                        lien.companyId = item.companyId;
                        lien.lienTypeId = (short)LienTypeEnum.InterestRepayment;
                        lien.createdBy = (int)SystemStaff.System;
                        lien.description = "lien placed due to Account not funded at Restructure Date";

                        var lienReference = casaLien.PlaceLien(lien);

                        CasaLienViewModel lienPrincipal = new CasaLienViewModel();

                        lienPrincipal.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lienPrincipal.sourceReferenceNumber = pastDuePrincipal.PARENT_PASTDUECODE;
                        lienPrincipal.lienAmount = pastDuePrincipal.DEBITAMOUNT;
                        lienPrincipal.branchId = item.branchId;
                        lienPrincipal.companyId = item.companyId;
                        lienPrincipal.lienTypeId = (short)LienTypeEnum.PrincipalRepayment;
                        lienPrincipal.createdBy = (int)SystemStaff.System;
                        lienPrincipal.description = "lien placed due to Account not funded at Restructure Date";

                        lienReference = casaLien.PlaceLien(lienPrincipal);

                    }
                    else if (casabalance <= 0)
                    {
                        TBL_LOAN_PAST_DUE pastDueInterest = new TBL_LOAN_PAST_DUE();

                        pastDueInterest.LOANID = item.loanId;
                        pastDueInterest.PASTDUECODE = pastDueCode;
                        pastDueInterest.CREDITAMOUNT = 0;
                        pastDueInterest.DESCRIPTION = "Force Debit as a result of Account not funded";
                        pastDueInterest.DEBITAMOUNT = Math.Abs(item.periodInterestAmount);
                        pastDueInterest.DATE = item.paymentDate;
                        pastDueInterest.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                        pastDueInterest.PARENT_PASTDUECODE = item.loanRefNo;
                        pastDueInterest.PRODUCTTYPEID = item.productId;

                        transPastDue.Add(pastDueInterest);

                        TBL_LOAN_PAST_DUE pastDuePrincipal = new TBL_LOAN_PAST_DUE();

                        pastDuePrincipal.LOANID = item.loanId;
                        pastDuePrincipal.PASTDUECODE = pastDueCode;
                        pastDuePrincipal.CREDITAMOUNT = 0;
                        pastDuePrincipal.DESCRIPTION = "Force Debit as a result of Account not funded";
                        pastDuePrincipal.DEBITAMOUNT = Math.Abs(item.periodPrincipalAmount);
                        pastDuePrincipal.DATE = item.paymentDate;
                        pastDuePrincipal.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Principal;
                        pastDuePrincipal.PARENT_PASTDUECODE = item.loanRefNo;
                        pastDuePrincipal.PRODUCTTYPEID = item.productId;

                        transPastDue.Add(pastDuePrincipal);

                        CasaLienViewModel lien = new CasaLienViewModel();

                        lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lien.sourceReferenceNumber = pastDueInterest.PARENT_PASTDUECODE;
                        lien.lienAmount = pastDueInterest.DEBITAMOUNT;
                        lien.branchId = item.branchId;
                        lien.companyId = item.companyId;
                        lien.lienTypeId = (short)LienTypeEnum.InterestRepayment;
                        lien.createdBy = (int)SystemStaff.System;
                        lien.description = "lien placed due to Account not funded at Restructure Date";

                        var lienReference = casaLien.PlaceLien(lien);

                        CasaLienViewModel lienPrincipal = new CasaLienViewModel();

                        lienPrincipal.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                        lienPrincipal.sourceReferenceNumber = pastDuePrincipal.PARENT_PASTDUECODE;
                        lienPrincipal.lienAmount = pastDuePrincipal.DEBITAMOUNT;
                        lienPrincipal.branchId = item.branchId;
                        lienPrincipal.companyId = item.companyId;
                        lienPrincipal.lienTypeId = (short)LienTypeEnum.PrincipalRepayment;
                        lienPrincipal.createdBy = (int)SystemStaff.System;
                        lienPrincipal.description = "lien placed due to Account not funded at Restructure Date";

                        casaLien.PlaceLien(lienPrincipal);

                    }
                }

                this.context.TBL_LOAN_PAST_DUE.AddRange(transPastDue);

                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw ex;
            }
        }

        #endregion

        #region Periodic  Operation

        public IEnumerable<LoanViewModel> ProcessIntervalFeeandCommissionPosting(DateTime applicationDate)
        {
            try
            {

                bool result = false;
                var model1 = (from a in context.TBL_LOAN_FEE
                              join c in context.TBL_LOAN_FEE_SCHEDULE on a.LOANCHARGEFEEID equals c.LOANCHARGEFEEID
                              join d in context.TBL_LOAN on a.LOANID equals d.TERMLOANID
                              join e in context.TBL_CASA on d.CASAACCOUNTID equals e.CASAACCOUNTID
                              where c.FEEDATE == DbFunctions.TruncateTime(applicationDate) && a.ISRECURRING == true
                              select new LoanViewModel()
                              {
                                  productId = d.PRODUCTID,
                                  branchId = d.BRANCHID,
                                  companyId = d.COMPANYID,
                                  currencyId = d.CURRENCYID,
                                  exchangeRate = d.EXCHANGERATE,
                                  interestRate = d.INTERESTRATE,
                                  paymentDate = applicationDate,
                                  loanId = a.LOANID,
                                  totalAmount = c.FEEAMOUNT,
                                  casaAccountId = e.CASAACCOUNTID,
                                  loanReferenceNumber = d.LOANREFERENCENUMBER,
                                  chargeFeeId = a.CHARGEFEEID,



                              }).ToList();

                var model2 = (from a in context.TBL_LOAN_FEE
                              join c in context.TBL_LOAN_FEE_SCHEDULE on a.LOANCHARGEFEEID equals c.LOANCHARGEFEEID
                              join d in context.TBL_LOAN_REVOLVING on a.LOANID equals d.REVOLVINGLOANID
                              join e in context.TBL_CASA on d.CASAACCOUNTID equals e.CASAACCOUNTID
                              where c.FEEDATE == DbFunctions.TruncateTime(applicationDate) && a.ISRECURRING == true
                              select new LoanViewModel()
                              {
                                  productId = d.PRODUCTID,
                                  branchId = d.BRANCHID,
                                  companyId = d.COMPANYID,
                                  currencyId = d.CURRENCYID,
                                  exchangeRate = d.EXCHANGERATE,
                                  interestRate = d.INTERESTRATE,
                                  paymentDate = applicationDate,
                                  loanId = a.LOANID,
                                  totalAmount = c.FEEAMOUNT,
                                  casaAccountId = e.CASAACCOUNTID,
                                  loanReferenceNumber = d.LOANREFERENCENUMBER,
                                  chargeFeeId = a.CHARGEFEEID,


                              }).ToList();

                var model = model1.Union(model2).ToList();

                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                foreach (var item in model)
                {
                    result = financeTransaction.PostBuildLoanChargeFeesPosting(item);
                }
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public bool ProcessReleaseLien(DateTime applicationDate, int companyId, int staffId)
        {
                List<TBL_LOAN> _TBL_LOAN = new List<TBL_LOAN>();

                bool status = false;

                //var loans = context.TBL_LOAN.Where(x => x.LOANSTATUSID == (short)LoanStatusEnum.Active && x.PRODUCTID == (short)ProductClassEnum.InvoiceDiscountingFacility && x.MATURITYDATE == applicationDate && x.COMPANYID == companyId);

                var loans = from l in context.TBL_LOAN
                            join p in context.TBL_PRODUCT on l.PRODUCTID equals p.PRODUCTID
                            where p.PRODUCTCLASSID == (short)ProductClassEnum.InvoiceDiscountingFacility
                            && l.LOANSTATUSID == (short)LoanStatusEnum.Active && l.MATURITYDATE == applicationDate && l.COMPANYID == companyId
                            select l;

                var eod_Operation_Log = context.TBL_EOD_OPERATION_LOG.Where(c => c.EODDATE == applicationDate && c.EODOPERATIONID == (int)EodOperationEnum.ProcessReleaseLien && c.COMPANYID == companyId).FirstOrDefault();


                List<TBL_EOD_OPERATION_LOG_DETAIL> eod_operation_Detail_List = new List<TBL_EOD_OPERATION_LOG_DETAIL>();

                if (loans.Count() != 0)
                {
                    var eodOperations = context.TBL_EOD_OPERATION.OrderBy(x => x.POSITION).ToList();

                    foreach (TBL_LOAN loan in loans)
                    {

                        TBL_EOD_OPERATION_LOG_DETAIL eod_operation_Detail = new TBL_EOD_OPERATION_LOG_DETAIL();

                        var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFERENCENUMBER == loan.LOANREFERENCENUMBER && c.EODDATE == applicationDate && c.EODOPERATIONID == (int)EodOperationEnum.ProcessReleaseLien).FirstOrDefault();

                        if (checkExistence == null)
                        {
                            eod_operation_Detail.EODOPERATIONLOGID = eod_Operation_Log.EODOPERATIONLOGID;
                            eod_operation_Detail.EODSTATUSID = (int)EodOperationStatusEnum.Processing;
                            eod_operation_Detail.REFERENCENUMBER = loan.LOANREFERENCENUMBER;
                            eod_operation_Detail.EODOPERATIONID = (int)EodOperationEnum.ProcessReleaseLien;
                            eod_operation_Detail.EODDATE = applicationDate;
                            eod_operation_Detail.EODUSERID = staffId;
                            eod_operation_Detail_List.Add(eod_operation_Detail);

                        }

                    }

                    context.TBL_EOD_OPERATION_LOG_DETAIL.AddRange(eod_operation_Detail_List);

                    context.SaveChanges();

                }


                if (loans.Count() > 0)
                {

                    foreach (var item in loans)
                    {

                        var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFERENCENUMBER == item.LOANREFERENCENUMBER && c.EODDATE == applicationDate && c.EODSTATUSID != (int)EodOperationStatusEnum.Completed && c.EODOPERATIONID == (int)EodOperationEnum.ProcessReleaseLien).FirstOrDefault();


                        if (checkExistence != null)
                        {

                            var eod_Operation_Log_Detail_Set_Value = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFERENCENUMBER == item.LOANREFERENCENUMBER && c.EODDATE == applicationDate && c.EODOPERATIONID == (int)EodOperationEnum.ProcessReleaseLien).FirstOrDefault();

                            eod_Operation_Log_Detail_Set_Value.STARTDATETIME = DateTime.Now;
                            eod_Operation_Log_Detail_Set_Value.EODUSERID = staffId;

                            context.SaveChanges();

                            try
                            {

                                var casaLienInfo = context.TBL_CASA_LIEN.FirstOrDefault(x => x.SOURCEREFERENCENUMBER == item.LOANREFERENCENUMBER && x.COMPANYID == item.COMPANYID);

                                _transactionReferenceNo = item.LOANREFERENCENUMBER;

                                CasaLienViewModel model = new CasaLienViewModel
                                {
                                    lienReferenceNumber = casaLienInfo.LIENREFERENCENUMBER,
                                    companyId = item.COMPANYID,
                                    productAccountNumber = casaLienInfo.PRODUCTACCOUNTNUMBER,
                                    description = casaLienInfo.DESCRIPTION,
                                    branchId = item.BRANCHID,
                                    createdBy = staffId

                                };

                                status = casaLien.ReleaseLien(model, null, false);

                                //if (status == true)
                                //{
                                //    item.LOANSTATUSID = (short)LoanStatusEnum.Completed;
                                //}

                                eod_Operation_Log_Detail_Set_Value.ENDDATETIME = DateTime.Now;
                                eod_Operation_Log_Detail_Set_Value.EODSTATUSID = (int)EodOperationStatusEnum.Completed;
                                eod_Operation_Log_Detail_Set_Value.EODUSERID = staffId;
                                eod_Operation_Log_Detail_Set_Value.ERRORINFORMATION = "No Error";
                                //context.SaveChanges();

                                context.SaveChanges();

                            }
                            catch (Exception ex)
                            {

                                eod_Operation_Log_Detail_Set_Value.ENDDATETIME = DateTime.Now;
                                eod_Operation_Log_Detail_Set_Value.EODSTATUSID = (int)EodOperationStatusEnum.Error;
                                eod_Operation_Log_Detail_Set_Value.EODUSERID = staffId;
                                eod_Operation_Log_Detail_Set_Value.ERRORINFORMATION = $"Ref No - {item.LOANREFERENCENUMBER} Exception - {ex.Message}  - inner exception -  {ex.InnerException}";
                                context.SaveChanges();
                            }



                        }


                    }

                    return true;

                }

                return false;

        }

        public IEnumerable<LimitSuspensionViewModel> ProcessNPLByBranchSuspension()
        {
            var model = (from a in context.TBL_LOAN
                         join b in context.TBL_BRANCH on a.BRANCHID equals b.BRANCHID
                         group a by new
                         {
                             a.BRANCHID,// c.LIMITID, c.MAXIMUMVALUE
                         } into groupedQ
                         select new LimitSuspensionViewModel()
                         {
                             branchId = groupedQ.Key.BRANCHID,
                             amount = groupedQ.Sum(i => (i.PRINCIPALAMOUNT)),

                         }).ToList();


            foreach (var item in model)
            {
                if (item.amount <= item.limitAmount)
                {
                    TBL_BRANCH result = (from p in context.TBL_BRANCH
                                         where p.BRANCHID == item.branchId
                                         select p).SingleOrDefault();

                    result.NPL_LIMITEXCEEDED = true;


                    context.SaveChanges();
                }


            }
            return model;

        }

        public IEnumerable<LimitSuspensionViewModel> ProcessNPLByRMSuspension()
        {
            var model = (from a in context.TBL_LOAN
                         join b in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals b.STAFFID
                         group a by new
                         {
                             a.RELATIONSHIPMANAGERID, //c.LIMITID, c.MAXIMUMVALUE
                         } into groupedQ
                         select new LimitSuspensionViewModel()
                         {
                             staffId = groupedQ.Key.RELATIONSHIPMANAGERID,
                             amount = groupedQ.Sum(i => (i.PRINCIPALAMOUNT)),

                         }).ToList();


            foreach (var item in model)
            {
                if (item.amount >= item.limitAmount)
                {
                    TBL_STAFF result = (from p in context.TBL_STAFF
                                        where p.STAFFID == item.staffId
                                        select p).SingleOrDefault();

                    result.NPL_LIMITEXCEEDED = true;


                    context.SaveChanges();
                }


            }
            return model;

        }

        public IEnumerable<LoanCovenantDetailViewModel> ProcessOverdraftBalanceSuspensionBaseOnCleanUp(DateTime applicationDate)
        {
            var model = (from a in context.TBL_LOAN_REVOLVING
                         join b in context.TBL_CASA on a.CASAACCOUNTID equals b.CASAACCOUNTID
                         join c in context.TBL_LOAN_COVENANT_DETAIL on a.REVOLVINGLOANID equals c.LOANID
                         join d in context.TBL_LOAN_COVENANT_TYPE on c.COVENANTTYPEID equals d.COVENANTTYPEID
                         where a.CASAACCOUNTID == b.CASAACCOUNTID && a.REVOLVINGLOANID == c.LOANID
                         && c.COVENANTTYPEID == d.COVENANTTYPEID && c.NEXTCOVENANTDATE == DbFunctions.TruncateTime(applicationDate)
                          && d.COVENANTTYPEID == (short)LoanCovenantTypeEnum.Cleanup
                         select new LoanCovenantDetailViewModel()
                         {
                             loanCovenantDetailId = c.LOANCOVENANTDETAILID,
                             loanId = a.REVOLVINGLOANID,
                             loanRef = a.LOANREFERENCENUMBER,
                             casaId = a.CASAACCOUNTID,
                             frequencyTypeId = c.FREQUENCYTYPEID,

                         }).ToList();


            foreach (var item in model)
            {
                var casabalance = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == item.casaId).AVAILABLEBALANCE;
                if (casabalance >= 0)
                {
                    TBL_LOAN_COVENANT_DETAIL result = (from p in context.TBL_LOAN_COVENANT_DETAIL
                                                       where p.LOANCOVENANTDETAILID == item.loanCovenantDetailId
                                                       select p).SingleOrDefault();

                    result.COVENANTDATE = applicationDate;
                    result.NEXTCOVENANTDATE = applicationDate.AddMonths((short)item.frequencyTypeId);///check if is monthly otherwise pick from setup


                    context.SaveChanges();
                }
                else
                {
                    TBL_CASA result = (from p in context.TBL_CASA
                                       where p.CASAACCOUNTID == item.casaId
                                       select p).SingleOrDefault();

                    result.POSTNOSTATUSID = (short)CASAPostNoStatusEnum.PostNoDebit;

                    context.SaveChanges();
                }


            }
            return model;

        }

        public IEnumerable<LoanCovenantDetailViewModel> ProcessOverdraftBalanceSuspensionBaseOnCovenant(DateTime applicationDate)
        {
            var model = (from a in context.TBL_LOAN_REVOLVING
                         join b in context.TBL_CASA on a.CASAACCOUNTID equals b.CASAACCOUNTID
                         join c in context.TBL_LOAN_COVENANT_DETAIL on a.REVOLVINGLOANID equals c.LOANID
                         join d in context.TBL_LOAN_COVENANT_TYPE on c.COVENANTTYPEID equals d.COVENANTTYPEID
                         where a.CASAACCOUNTID == b.CASAACCOUNTID && a.REVOLVINGLOANID == c.LOANID
                         && c.COVENANTTYPEID == d.COVENANTTYPEID && c.NEXTCOVENANTDATE == DbFunctions.TruncateTime(applicationDate)
                         && d.COVENANTTYPEID == (short)LoanCovenantTypeEnum.Turnover
                         select new LoanCovenantDetailViewModel()
                         {
                             loanCovenantDetailId = c.LOANCOVENANTDETAILID,
                             loanId = a.REVOLVINGLOANID,
                             loanRef = a.LOANREFERENCENUMBER,
                             casaId = a.CASAACCOUNTID,
                             covenantAmount = c.COVENANTAMOUNT,
                             covenantDate = c.COVENANTDATE,
                             frequencyTypeId = c.FREQUENCYTYPEID,

                         }).ToList();


            foreach (var item in model)
            {
                var casabalance = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == item.casaId).AVAILABLEBALANCE;///pick from transaction table in finnacle to get inflows pass Date Range
                if (casabalance >= item.covenantAmount)
                {
                    TBL_LOAN_COVENANT_DETAIL result = (from p in context.TBL_LOAN_COVENANT_DETAIL
                                                       where p.LOANCOVENANTDETAILID == item.loanCovenantDetailId
                                                       select p).SingleOrDefault();

                    result.COVENANTDATE = applicationDate;
                    result.NEXTCOVENANTDATE = applicationDate.AddMonths((short)item.frequencyTypeId);///check if is monthly otherwise pick from setup


                    context.SaveChanges();
                }
                else
                {
                    TBL_CASA result = (from p in context.TBL_CASA
                                       where p.CASAACCOUNTID == item.casaId
                                       select p).SingleOrDefault();

                    result.POSTNOSTATUSID = (short)CASAPostNoStatusEnum.PostNoDebit;

                    context.SaveChanges();
                }


            }
            return model;

        }

        public IEnumerable<LoanCovenantDetailViewModel> ProcessLPOExpiryAndlocking(DateTime applicationDate)
        {
            var model = (from a in context.TBL_LOAN_REVOLVING
                         join b in context.TBL_CASA on a.CASAACCOUNTID equals b.CASAACCOUNTID
                         join e in context.TBL_PRODUCT on a.PRODUCTID equals e.PRODUCTID
                         join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
                         where a.CASAACCOUNTID == b.CASAACCOUNTID && a.PRODUCTID == e.PRODUCTID
                         && e.PRODUCTTYPEID == f.PRODUCTTYPEID && a.EFFECTIVEDATE <= DbFunctions.TruncateTime(applicationDate)
                         && e.PRODUCTTYPEID == (short)LoanProductTypeEnum.LPO
                         select new LoanCovenantDetailViewModel()
                         {
                             loanId = a.REVOLVINGLOANID,
                             loanRef = a.LOANREFERENCENUMBER,
                             casaId = a.CASAACCOUNTID,
                             effectiveDate = a.EFFECTIVEDATE,
                             maximumDrawDownDuration = (int)e.MAXIMUMDRAWDOWNDURATION,//(int)e.ExpiryPeriod, // change to MaximumDrawDownDuration after scarfolding
                         }).ToList();


            foreach (var item in model)
            {
                var maxDay = (applicationDate - item.effectiveDate).TotalDays;
                if (maxDay >= item.maximumDrawDownDuration)
                {
                    TBL_CASA result = (from p in context.TBL_CASA
                                       where p.CASAACCOUNTID == item.casaId
                                       select p).SingleOrDefault();

                    result.POSTNOSTATUSID = (short)CASAPostNoStatusEnum.PostNoDebit;

                    context.SaveChanges();
                }


            }
            return model;

        }

        public IEnumerable<LoanCovenantDetailViewModel> ProcessCFFExpiryAndlocking(DateTime applicationDate)
        {
            var model = (from a in context.TBL_LOAN_REVOLVING
                         join b in context.TBL_CASA on a.CASAACCOUNTID equals b.CASAACCOUNTID
                         join e in context.TBL_PRODUCT on a.PRODUCTID equals e.PRODUCTID
                         join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
                         where a.CASAACCOUNTID == b.CASAACCOUNTID && a.PRODUCTID == e.PRODUCTID
                         && e.PRODUCTTYPEID == f.PRODUCTTYPEID && a.EFFECTIVEDATE <= DbFunctions.TruncateTime(applicationDate)
                         && e.PRODUCTTYPEID == (short)LoanProductTypeEnum.CFF
                         select new LoanCovenantDetailViewModel()
                         {
                             loanId = a.REVOLVINGLOANID,
                             loanRef = a.LOANREFERENCENUMBER,
                             casaId = a.CASAACCOUNTID,
                             effectiveDate = a.EFFECTIVEDATE,
                             maximumDrawDownDuration = (int)e.MAXIMUMDRAWDOWNDURATION,//(int)e.ExpiryPeriod, // change to MaximumDrawDownDuration after scarfolding
                         }).ToList();


            foreach (var item in model)
            {
                var maxDay = (applicationDate - item.effectiveDate).TotalDays;
                if (maxDay >= item.maximumDrawDownDuration)
                {
                    TBL_CASA result = (from p in context.TBL_CASA
                                       where p.CASAACCOUNTID == item.casaId
                                       select p).SingleOrDefault();

                    result.POSTNOSTATUSID = (short)CASAPostNoStatusEnum.PostNoDebit;

                    context.SaveChanges();
                }


            }
            return model;

        }

        public IEnumerable<LoanCovenantDetailViewModel> ProcessIDFExpiryAndlocking(DateTime applicationDate)
        {
            var model = (from a in context.TBL_LOAN_REVOLVING
                         join b in context.TBL_CASA on a.CASAACCOUNTID equals b.CASAACCOUNTID
                         join e in context.TBL_PRODUCT on a.PRODUCTID equals e.PRODUCTID
                         join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
                         where a.CASAACCOUNTID == b.CASAACCOUNTID && a.PRODUCTID == e.PRODUCTID
                         && e.PRODUCTTYPEID == f.PRODUCTTYPEID && a.EFFECTIVEDATE <= DbFunctions.TruncateTime(applicationDate)
                         && e.PRODUCTTYPEID == (short)LoanProductTypeEnum.IDF
                         select new LoanCovenantDetailViewModel()
                         {
                             loanId = a.REVOLVINGLOANID,
                             loanRef = a.LOANREFERENCENUMBER,
                             casaId = a.CASAACCOUNTID,
                             effectiveDate = a.EFFECTIVEDATE,
                             maximumDrawDownDuration = (int)e.MAXIMUMDRAWDOWNDURATION,//(int)e.ExpiryPeriod, // change to MaximumDrawDownDuration after scarfolding
                         }).ToList();


            foreach (var item in model)
            {
                var maxDay = (applicationDate - item.effectiveDate).TotalDays;
                if (maxDay >= item.maximumDrawDownDuration)
                {
                    TBL_CASA result = (from p in context.TBL_CASA
                                       where p.CASAACCOUNTID == item.casaId
                                       select p).SingleOrDefault();

                    result.POSTNOSTATUSID = (short)CASAPostNoStatusEnum.PostNoDebit;

                    context.SaveChanges();
                }


            }
            return model;

        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool ProcessChargeReversal(TwoFactorAutheticationViewModel twoFactorAuth, int loanId, int operationId, int staffId, int loanReviewOperationsId)
        {
            var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
            try
            {
                bool output = false;
                var systemDate = generalSetup.GetApplicationDate();
                var chargeDetails = this.context.TBL_LOAN_REVIEW_OPERATION.FirstOrDefault(x => x.LOANREVIEWOPERATIONID == loanReviewOperationsId && x.OPERATIONCOMPLETED == false);
                int productType = chargeDetails.LOANSYSTEMTYPEID;

                var tax = this.context.TBL_CHARGE_FEE_DETAIL.Where(x => x.CHARGEFEEID == chargeDetails.INTERESTFREQUENCYTYPEID);
                decimal NewTaxRate = (decimal)tax.FirstOrDefault().VALUE;

                //int DateDiff = 0;
                //decimal DailyAccruedFee = 0;
                //decimal AccruedFeeToDate = 0;
                //decimal EarnedFeeAmount = 0;
                //decimal NewFeeAmount = 0;
                //decimal NewTaxAmount = 0;
                //decimal DailyAccruedTax = 0;
                //decimal AccruedTaxToDate = 0;

                //int chargeTypeId = 0;


                LoanPaymentRestructureScheduleInputViewModel model = new LoanPaymentRestructureScheduleInputViewModel();

                model = (
                from a in context.TBL_LOAN_REVIEW_OPERATION
                join c in context.TBL_LOAN_FEE on a.LOANID equals c.LOANID
                where a.LOANREVIEWOPERATIONID == loanReviewOperationsId

                select new LoanPaymentRestructureScheduleInputViewModel()
                {
                    loanId = a.LOANID,

                    staffId = staffId,
                    createdBy = staffId,
                    // customerId = b.CUSTOMERID,
                    payAmount = (double)a.PREPAYMENT,
                    feeRate = c.FEERATEVALUE,
                    earnedFeeAmount = c.EARNEDFEEAMOUNT,
                    feeAmount = c.FEEAMOUNT,
                    newInterest = (double)a.INTERATERATE,
                    chargeFeeId = c.CHARGEFEEID, //(int)a.PRINCIPALFREQUENCYTYPEID,
                    chargeFeeTypeId = c.TBL_CHARGE_FEE.TBL_FEE_TYPE.FEETYPEID, //(int)a.INTERESTFREQUENCYTYPEID,


                }).FirstOrDefault();

                LoanViewModel loanModel = new LoanViewModel();
                LoanChargeFeeViewModel loanChargeFeeModel = new LoanChargeFeeViewModel();

                loanChargeFeeModel.feeAmount = (decimal)model.payAmount;
                loanChargeFeeModel.chargeFeeId = model.chargeFeeId;
                loanChargeFeeModel.feeDependentAmount = (decimal)model.payAmount;
                loanChargeFeeModel.feeRate = model.feeRate;
                loanChargeFeeModel.loanId = model.loanId ?? 0;
                loanChargeFeeModel.isPosted = false;

                //loanModel.loanChargeFee.Add(loanChargeFeeModel);


                if (productType == (int)LoanSystemTypeEnum.TermDisbursedFacility)
                {
                    var runningFacility = context.TBL_LOAN.Find(model.loanId);
                    model.interestRate = runningFacility.INTERESTRATE;
                    model.effectiveDate = runningFacility.EFFECTIVEDATE;
                    model.operationId = runningFacility.OPERATIONID ?? 0;
                    model.companyId = runningFacility.COMPANYID;
                    model.principalAmount = (double)runningFacility.PRINCIPALAMOUNT;
                    model.casaAccountId = runningFacility.CASAACCOUNTID;
                    model.sourceBranchId = runningFacility.BRANCHID;
                    model.sourceReferenceNumber = runningFacility.LOANREFERENCENUMBER;
                    model.loanId = runningFacility.TERMLOANID;
                    model.loanSystemTypeId = runningFacility.LOANSYSTEMTYPEID;

                    loanModel.interestRate = runningFacility.INTERESTRATE;
                    loanModel.effectiveDate = runningFacility.EFFECTIVEDATE;
                    loanModel.operationId = runningFacility.OPERATIONID ?? 0;
                    loanModel.companyId = runningFacility.COMPANYID;
                    loanModel.principalAmount = runningFacility.PRINCIPALAMOUNT;
                    loanModel.casaAccountId = runningFacility.CASAACCOUNTID;
                    loanModel.sourceBranchId = runningFacility.BRANCHID;
                    loanModel.branchId = runningFacility.BRANCHID;
                    loanModel.sourceReferenceNumber = runningFacility.LOANREFERENCENUMBER;
                    loanModel.loanReferenceNumber = runningFacility.LOANREFERENCENUMBER;
                    loanModel.loanId = runningFacility.TERMLOANID;
                }
                if (productType == (int)LoanSystemTypeEnum.OverdraftFacility)
                {
                    var runningFacility = context.TBL_LOAN_REVOLVING.Find(model.loanId);
                    model.interestRate = runningFacility.INTERESTRATE;
                    model.effectiveDate = runningFacility.EFFECTIVEDATE;
                    model.operationId = runningFacility.OPERATIONID ?? 0;
                    model.companyId = runningFacility.COMPANYID;
                    model.principalAmount = (double)runningFacility.OVERDRAFTLIMIT;
                    model.casaAccountId = runningFacility.CASAACCOUNTID;
                    model.sourceBranchId = runningFacility.BRANCHID;
                    model.sourceReferenceNumber = runningFacility.LOANREFERENCENUMBER;
                    model.loanId = runningFacility.REVOLVINGLOANID;
                    model.loanSystemTypeId = runningFacility.LOANSYSTEMTYPEID;

                    loanModel.interestRate = runningFacility.INTERESTRATE;
                    loanModel.effectiveDate = runningFacility.EFFECTIVEDATE;
                    loanModel.operationId = runningFacility.OPERATIONID ?? 0;
                    loanModel.companyId = runningFacility.COMPANYID;
                    loanModel.principalAmount = runningFacility.OVERDRAFTLIMIT;
                    loanModel.casaAccountId = runningFacility.CASAACCOUNTID;
                    loanModel.sourceBranchId = runningFacility.BRANCHID;
                    loanModel.branchId = runningFacility.BRANCHID;
                    loanModel.sourceReferenceNumber = runningFacility.LOANREFERENCENUMBER;
                    loanModel.loanReferenceNumber = runningFacility.LOANREFERENCENUMBER;
                    loanModel.loanId = runningFacility.REVOLVINGLOANID;

                }
                if (productType == (int)LoanSystemTypeEnum.ContingentLiability)
                {
                    var runningFacility = context.TBL_LOAN_CONTINGENT.Find(model.loanId);
                    model.interestRate = 1;
                    model.effectiveDate = runningFacility.EFFECTIVEDATE;
                    model.operationId = runningFacility.OPERATIONID ?? 0;
                    model.companyId = runningFacility.COMPANYID;
                    model.principalAmount = (double)runningFacility.CONTINGENTAMOUNT;
                    model.casaAccountId = runningFacility.CASAACCOUNTID;
                    model.sourceBranchId = runningFacility.BRANCHID;
                    model.sourceReferenceNumber = runningFacility.LOANREFERENCENUMBER;
                    model.loanId = runningFacility.CONTINGENTLOANID;
                    model.loanSystemTypeId = runningFacility.LOANSYSTEMTYPEID;

                    loanModel.interestRate = 1;
                    loanModel.effectiveDate = runningFacility.EFFECTIVEDATE;
                    loanModel.operationId = runningFacility.OPERATIONID ?? 0;
                    loanModel.companyId = runningFacility.COMPANYID;
                    loanModel.principalAmount = runningFacility.CONTINGENTAMOUNT;
                    loanModel.casaAccountId = runningFacility.CASAACCOUNTID;
                    loanModel.sourceBranchId = runningFacility.BRANCHID;
                    loanModel.branchId = runningFacility.BRANCHID;
                    loanModel.sourceReferenceNumber = runningFacility.LOANREFERENCENUMBER;
                    loanModel.loanReferenceNumber = runningFacility.LOANREFERENCENUMBER;
                    loanModel.loanId = runningFacility.CONTINGENTLOANID;

                }

                if ((decimal)model.feeAmount < (decimal)model.payAmount)
                {
                    throw new ConditionNotMetException("Transaction Failed. The screen is for fee reduction only. Use Manual Fee page for addition. ");
                }
                //model.feeAmountDiff = (decimal)model.feeAmount - (decimal)model.payAmount;

                //workFlow.StaffId = staffId;
                //workFlow.CompanyId = model.companyId;
                //workFlow.StatusId = (int)ApprovalStatusEnum.Processing ;
                //workFlow.TargetId = loanReviewOperationsId;
                //workFlow.Comment = entity.comment;
                //workFlow.OperationId = entity.operationId;
                //workFlow.DeferredExecution = true;
                //workFlow.ExternalInitialization = false;

                //workflow.LogActivity();

                //context.SaveChanges();

                List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();
                //inputTransactions.AddRange(financeTransaction.BuildLoanChargeFeesPostingReversal(loanModel, loanChargeFeeModel));
                //financeTransaction.PostTransaction(inputTransactions, false, twoFactorAuth);

                //var feeResult = context.TBL_LOAN_FEE.Where(x => x.LOANID == loanId && x.CHARGEFEEID == model.chargeFeeId && x.LOANSYSTEMTYPEID == chargeDetails.LOANSYSTEMTYPEID).ToList();
                //ArchiveLoanFee(feeResult, model);
                //var loanFeeeeRecord =feeResult.FirstOrDefault();
                //loanFeeeeRecord.FEEAMOUNT = loanChargeFeeModel.feeAmount;



                List<LoanPaymentRestructureScheduleInputViewModel> entity = new List<LoanPaymentRestructureScheduleInputViewModel>();

                inputTransactions.AddRange(financeTransaction.BuildChargeReversalPosting(model, twoFactorAuth, "Main"));

                entity.Add(model);
                var feeVATRecord = context.TBL_CHARGE_FEE_DETAIL.Where(x => x.CHARGEFEEID == model.chargeFeeId && x.DETAILTYPEID == (short)ChargeFeeDealTypeEnum.Tax && x.DELETED == false).FirstOrDefault();
                if (feeVATRecord != null)
                {
                    model.chargeFeeId = feeVATRecord.CHARGEFEEID;
                    inputTransactions.AddRange(financeTransaction.BuildChargeReversalPosting(model, twoFactorAuth, "VAT"));
                    entity.Add(model);
                }
                financeTransaction.PostTransaction(inputTransactions, false, twoFactorAuth);

                var feeResult = context.TBL_LOAN_FEE.Find(chargeDetails.TARGETID);

                if (feeResult != null)
                {
                    ArchiveLoanFee(feeResult, model);
                    var feeRecord = context.TBL_CHARGE_FEE_DETAIL.Where(x => x.CHARGEFEEID == model.chargeFeeId
                                    && (x.DETAILTYPEID == (short)ChargeFeeDealTypeEnum.Customer || x.DETAILTYPEID == (short)ChargeFeeDealTypeEnum.Customer)
                                    && x.DELETED == false).FirstOrDefault();

                    if (feeRecord != null)
                    {
                        feeResult.FEEAMOUNT = feeResult.FEEAMOUNT - (decimal)model.payAmount;
                    }
                }

                chargeDetails.OPERATIONCOMPLETED = true;

                var result = context.SaveChanges() > 0;
                if (result)
                {
                    output = true;
                }
                return output;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        private bool ArchiveLoanFee(TBL_LOAN_FEE existingItem, LoanPaymentRestructureScheduleInputViewModel model)
        {
            TBL_LOAN_FEE_ARCHIVE newFeeRecord = new TBL_LOAN_FEE_ARCHIVE();

            //newFeeRecord.LOANCHARGEFEEARCHIVEID = existingItem ,
            newFeeRecord.ISAPPLIED = true;
            newFeeRecord.OPERATIONID = model.operationId;
            newFeeRecord.CHANGEREASON = "Reduction";
            newFeeRecord.LOANID = existingItem.LOANID;
            newFeeRecord.LOANSYSTEMTYPEID = existingItem.LOANSYSTEMTYPEID;
            newFeeRecord.CHARGEFEEID = existingItem.CHARGEFEEID;
            newFeeRecord.ISPOSTED = existingItem.ISPOSTED;
            newFeeRecord.APPROVALSTATUSID = existingItem.APPROVALSTATUSID;
            newFeeRecord.FEERATEVALUE = existingItem.FEERATEVALUE;
            newFeeRecord.FEEDEPENDENTAMOUNT = existingItem.FEEDEPENDENTAMOUNT;
            newFeeRecord.FEEAMOUNT = existingItem.FEEAMOUNT;
            newFeeRecord.EARNEDFEEAMOUNT = existingItem.EARNEDFEEAMOUNT;
            newFeeRecord.TAXAMOUNT = existingItem.TAXAMOUNT;
            newFeeRecord.EARNEDTAXAMOUNT = existingItem.EARNEDTAXAMOUNT;
            newFeeRecord.ISINTEGRALFEE = existingItem.ISINTEGRALFEE;
            newFeeRecord.ISRECURRING = existingItem.ISRECURRING;
            newFeeRecord.RECURRINGPAYMENTDAY = existingItem.RECURRINGPAYMENTDAY;
            newFeeRecord.CREATEDBY = existingItem.CREATEDBY;
            newFeeRecord.DATETIMECREATED = existingItem.DATETIMECREATED;
            newFeeRecord.LASTUPDATEDBY = existingItem.LASTUPDATEDBY;
            newFeeRecord.DATETIMEUPDATED = existingItem.DATETIMEUPDATED;
            newFeeRecord.DELETED = existingItem.DELETED;
            newFeeRecord.DELETEDBY = existingItem.DELETEDBY;
            newFeeRecord.DATETIMEDELETED = existingItem.DATETIMEDELETED;
            newFeeRecord.CHANGEEFFECTIVEDATE = DateTime.Now;

            context.TBL_LOAN_FEE_ARCHIVE.Add(newFeeRecord);

            return true;
        }
        public bool AddChargeReversal(LoanChargeFeeViewModel model, DateTime applicationDate, int staffId)
        {
            bool output = false;
            var systemDate = generalSetup.GetApplicationDate();

            var productType = this.context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == model.productId && x.COMPANYID == model.companyId).PRODUCTTYPEID;

            TBL_LOAN_FEE loanFee = new TBL_LOAN_FEE();

            loanFee.LOANID = model.loanId;
            loanFee.CHARGEFEEID = model.chargeFeeId;
            loanFee.FEERATEVALUE = model.feeRateValue;
            loanFee.FEEDEPENDENTAMOUNT = model.feeDependentAmount;
            loanFee.FEEAMOUNT = model.feeAmountDiff;
            loanFee.ISINTEGRALFEE = false;
            loanFee.ISRECURRING = false;
            loanFee.RECURRINGPAYMENTDAY = 0;
            loanFee.CREATEDBY = staffId;
            loanFee.DATETIMECREATED = applicationDate;
            loanFee.LASTUPDATEDBY = null;
            loanFee.DATETIMEUPDATED = systemDate;
            loanFee.DELETED = false;
            loanFee.DELETEDBY = null;
            loanFee.DATETIMEDELETED = systemDate;

            this.context.TBL_LOAN_FEE.Add(loanFee); ////change to Temp table

            context.SaveChanges();
            output = true;

            return output;
        }

        public bool AddCASAOverdraft(int casaId, decimal amount, string description)
        {
            bool output = false;
            var systemDate = generalSetup.GetApplicationDate();

            TBL_CASA_OVERDRAFT casaOverdraft = new TBL_CASA_OVERDRAFT();

            casaOverdraft.CASAACCOUNTID = casaId;
            casaOverdraft.EFFECTIVEDATE = systemDate;
            casaOverdraft.CREDITAMOUNT = amount;
            casaOverdraft.DEBITAMOUNT = 0;
            casaOverdraft.DESCRIPTION = description;
            casaOverdraft.CREATEDBY = (int)SystemStaff.System;
            casaOverdraft.DATECREATED = systemDate;
            this.context.TBL_CASA_OVERDRAFT.Add(casaOverdraft);

            context.SaveChanges();
            output = true;

            return output;
        }

        public bool OverdraftTopUp(TwoFactorAutheticationViewModel twoFactorAuth, int loanId, decimal amount)
        {
            bool output = false;
            ResponseMessageViewModel topResult = new ResponseMessageViewModel();
            try
            {

                var systemDate = generalSetup.GetApplicationDate();
                var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
                //DeleteLoanExist(loanId, systemDate);
                ArchiveOverDraft(loanId, archiveBatchCode);
                var model = (from a in context.TBL_LOAN_REVOLVING
                             join b in context.TBL_LOAN_REVIEW_OPERATION on a.REVOLVINGLOANID equals b.LOANID
                             where a.REVOLVINGLOANID == loanId && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                             && b.OPERATIONDATE.Equals(null)
                             select new RevolvingLoanViewModel()
                             {
                                 loanId = a.REVOLVINGLOANID,
                                 loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                 customerId = a.CUSTOMERID,
                                 productId = a.PRODUCTID,
                                 companyId = a.COMPANYID,
                                 casaAccountId = a.CASAACCOUNTID,
                                 branchId = a.BRANCHID,
                                 currencyId = a.CURRENCYID,
                                 loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                 exchangeRate = a.EXCHANGERATE,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 relatedLoanReferenceNumber = a.RELATED_LOAN_REFERENCE_NUMBER,
                                 subSectorId = a.SUBSECTORID,
                                 relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                 relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                 misCode = a.MISCODE,
                                 teamMiscode = a.TEAMMISCODE,
                                 interestRate = (double)b.INTERATERATE,
                                 effectiveDate = b.EFFECTIVEDATE,
                                 maturityDate = (DateTime)b.MATURITYDATE,
                                 bookingDate = DateTime.Today,
                                 overdraftLimit = (decimal)b.OVERDRAFTTOPUP,
                                 pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                 pastDueInterest = a.PASTDUEINTEREST,
                                 interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                 interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                 penalChargeAmount = a.PENALCHARGEAMOUNT,
                                 approvalStatusId = a.APPROVALSTATUSID,
                                 approvedBy = (int)a.APPROVEDBY,
                                 approverComment = a.APPROVERCOMMENT,
                                 dateApproved = a.DATEAPPROVED,
                                 loanStatusId = a.LOANSTATUSID,
                                 isDisbursed = a.ISDISBURSED,
                                 disbursedBy = a.DISBURSEDBY,
                                 disburserComment = a.DISBURSERCOMMENT,
                                 disburseDate = a.DISBURSEDATE,
                                 operationId = b.OPERATIONTYPEID,
                                 dischargeLetter = a.DISCHARGELETTER,
                                 suspendInterest = a.SUSPENDINTEREST,
                                 dayCountConventionId = a.DAYCOUNTCONVENTIONID,
                                 internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                                 externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                                 nplDate = a.NPLDATE,
                                 createdBy = a.CREATEDBY,
                                 dateTimeCreated = DateTime.Today,
                                 revolvingTypeId = a.REVOLVINGTYPEID,
                                 productAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                 serialNumber = a.SERIALNUMBER,

                             }).FirstOrDefault();



                // List<TBL_LOAN_REVOLVING> overDraft = new List<TBL_LOAN_REVOLVING>();

                //model.productTypeId = (int)LoanSystemTypeEnum.OverdraftFacility;
                //var loanReferenceNumber = loanGenerate.GenerateLoanReferenceNumber(model.branchId, model.productId, model.productTypeId);
                //TBL_LOAN_REVOLVING addOverDraft = new TBL_LOAN_REVOLVING();

                //addOverDraft.CUSTOMERID = model.customerId;
                //addOverDraft.LOANSYSTEMTYPEID = model.loanSystemTypeId;
                //addOverDraft.PRODUCTID = model.productId;
                //addOverDraft.COMPANYID = model.companyId;
                //addOverDraft.CASAACCOUNTID = model.casaAccountId;
                //addOverDraft.BRANCHID = model.branchId;
                //addOverDraft.CURRENCYID = model.currencyId;
                //addOverDraft.LOANAPPLICATIONDETAILID = model.loanApplicationDetailId;
                //addOverDraft.EXCHANGERATE = model.exchangeRate;
                //addOverDraft.LOANREFERENCENUMBER = loanReferenceNumber;
                //addOverDraft.RELATED_LOAN_REFERENCE_NUMBER = model.loanReferenceNumber;
                //addOverDraft.SUBSECTORID = model.subSectorId;
                //addOverDraft.RELATIONSHIPOFFICERID = model.relationshipOfficerId;
                //addOverDraft.RELATIONSHIPMANAGERID = model.relationshipManagerId;
                //addOverDraft.MISCODE = model.misCode;
                //addOverDraft.TEAMMISCODE = model.teamMiscode;
                //addOverDraft.INTERESTRATE = model.interestRate;
                //addOverDraft.EFFECTIVEDATE = model.effectiveDate;
                //addOverDraft.MATURITYDATE = model.maturityDate;
                //addOverDraft.BOOKINGDATE = model.bookingDate;
                //addOverDraft.OVERDRAFTLIMIT = model.overdraftLimit;
                //addOverDraft.APPROVALSTATUSID = model.approvalStatusId;
                //addOverDraft.APPROVEDBY = model.approvedBy;
                //addOverDraft.APPROVERCOMMENT = model.approverComment;
                //addOverDraft.DATEAPPROVED = model.dateApproved;
                //addOverDraft.LOANSTATUSID = model.loanStatusId;
                //addOverDraft.ISDISBURSED = model.isDisbursed;
                //addOverDraft.DISBURSEDBY = model.disbursedBy;
                //addOverDraft.DISBURSERCOMMENT = model.disburserComment;
                //addOverDraft.DISBURSEDATE = model.disburseDate;
                //addOverDraft.OPERATIONID = model.operationId;
                //addOverDraft.CREATEDBY = model.createdBy;
                //addOverDraft.DATETIMECREATED = model.dateTimeCreated;
                //addOverDraft.DISCHARGELETTER = model.dischargeLetter;
                //addOverDraft.SUSPENDINTEREST = model.suspendInterest;
                //addOverDraft.DAYCOUNTCONVENTIONID = (short)model.dayCountConventionId;
                //addOverDraft.INT_PRUDENT_GUIDELINE_STATUSID = 1; //model.internalPrudentialGuidelineStatusId;
                //addOverDraft.EXT_PRUDENT_GUIDELINE_STATUSID = 1; //model.externalPrudentialGuidelineStatusId;
                //addOverDraft.USER_PRUDENTIAL_GUIDE_STATUSID = 1;
                //addOverDraft.NPLDATE = model.nplDate;
                //addOverDraft.CREATEDBY = model.createdBy;
                //addOverDraft.DATETIMECREATED = model.dateTimeCreated;
                //addOverDraft.REVOLVINGTYPEID = model.revolvingTypeId;


                //overDraft.Add(addOverDraft);
                // }

                //this.context.TBL_LOAN_REVOLVING.AddRange(overDraft);



                if (USE_THIRD_PARTY_INTEGRATION)
                {

                    var data1 = context.TBL_LOAN_REVOLVING.Find(loanId);

                    if (data1.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                    {
                        if (data1.MATURITYDATE.Date < systemDate.Date)
                        {
                            throw new SecureException("The tenor for the top-up amount is not expected to exceed the expiry date of the current limit");
                        }
                        var loan = model;
                        var reviewDate = loan.maturityDate.AddDays(-1);
                        var data = new OverDraftTopUpAndRenewViewModel
                        {
                            //sanctionLimit = String.Format("{0:0.00}", loan.overdraftLimit),
                            //sanctionReferenceNumber = loan.loanReferenceNumber,
                            //accountNumber = loan.productAccountNumber,
                            //expiryDate = loan.maturityDate.ToString("dd-MMM-yyyy", null),
                            //reviewedDate = reviewDate.ToString("dd-MMM-yyyy", null),
                            //createdDate = systemDate,

                            sanctionLimit = String.Format("{0:0.00}", loan.overdraftLimit),
                            sanctionReferenceNumber = loan.loanReferenceNumber,
                            accountNumber = loan.productAccountNumber,
                            expiryDate = loan.maturityDate.ToString("dd-MMM-yyyy", null),
                            reviewedDate = reviewDate.ToString("dd-MMM-yyyy", null),
                            createdDate = systemDate,
                            sanctionLevel = "003",
                            sanctionAuthorizer = "999",
                            sourceReferenceNumber = loan.loanReferenceNumber

                        };
                        topResult = finacle.OverDraftTopUp(data, twoFactorAuth);

                    }
                    else
                    {
                        throw new SecureException("Limit has experied or is inactive");
                    }
                }

                //addOverDraft.SERIALNUMBER = topResult.serialNumber;

                var overDraft = context.TBL_LOAN_REVOLVING.Where(x => x.REVOLVINGLOANID == model.loanId).FirstOrDefault();
                overDraft.OVERDRAFTLIMIT = overDraft.OVERDRAFTLIMIT + model.overdraftLimit;

                var result = context.SaveChanges() > 0;
                if (topResult != null && result == true)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;

            }
            return output;
        }

        public bool OverdraftRenewal(TwoFactorAutheticationViewModel twoFactorAuth, int loanReviewOperationsId, int loanId, decimal amount)
        {

            bool output = false;
            ResponseMessageViewModel renewalResult = new ResponseMessageViewModel();
            try
            {
                var systemDate = generalSetup.GetApplicationDate();
                var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
                //DeleteLoanExist(loanId, systemDate);
                ArchiveOverDraft(loanId, archiveBatchCode);
                var model = (from a in context.TBL_LOAN_REVOLVING
                             join b in context.TBL_LOAN_REVIEW_OPERATION on a.REVOLVINGLOANID equals b.LOANID
                             where a.REVOLVINGLOANID == loanId && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                             && b.LOANREVIEWOPERATIONID == loanReviewOperationsId
                             && b.OPERATIONDATE.Equals(null)
                             select new RevolvingLoanViewModel()
                             {
                                 loanId = a.REVOLVINGLOANID,
                                 loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                 customerId = a.CUSTOMERID,
                                 productId = a.PRODUCTID,
                                 companyId = a.COMPANYID,
                                 casaAccountId = a.CASAACCOUNTID,
                                 branchId = a.BRANCHID,
                                 currencyId = a.CURRENCYID,
                                 loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                 exchangeRate = a.EXCHANGERATE,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 relatedLoanReferenceNumber = a.RELATED_LOAN_REFERENCE_NUMBER,
                                 subSectorId = a.SUBSECTORID,
                                 relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                 relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                 misCode = a.MISCODE,
                                 teamMiscode = a.TEAMMISCODE,
                                 interestRate = (double)b.INTERATERATE,
                                 effectiveDate = b.EFFECTIVEDATE,
                                 maturityDate = (DateTime)b.MATURITYDATE,
                                 bookingDate = DateTime.Today,
                                 overdraftLimit = (decimal)b.OVERDRAFTTOPUP,
                                 pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                 pastDueInterest = a.PASTDUEINTEREST,
                                 interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                 interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                 penalChargeAmount = a.PENALCHARGEAMOUNT,
                                 approvalStatusId = a.APPROVALSTATUSID,
                                 approvedBy = (int)a.APPROVEDBY,
                                 approverComment = a.APPROVERCOMMENT,
                                 dateApproved = a.DATEAPPROVED,
                                 loanStatusId = a.LOANSTATUSID,
                                 isDisbursed = a.ISDISBURSED,
                                 disbursedBy = a.DISBURSEDBY,
                                 disburserComment = a.DISBURSERCOMMENT,
                                 disburseDate = a.DISBURSEDATE,
                                 operationId = b.OPERATIONTYPEID,
                                 dischargeLetter = a.DISCHARGELETTER,
                                 suspendInterest = a.SUSPENDINTEREST,
                                 dayCountConventionId = a.DAYCOUNTCONVENTIONID,
                                 internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                                 externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                                 nplDate = a.NPLDATE,
                                 createdBy = a.CREATEDBY,
                                 dateTimeCreated = DateTime.Today,
                                 revolvingTypeId = a.REVOLVINGTYPEID,
                                 productAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                 serialNumber = a.SERIALNUMBER,

                             }).FirstOrDefault();

                List<TBL_LOAN_REVOLVING> overDraft = new List<TBL_LOAN_REVOLVING>();

                model.productTypeId = (int)LoanSystemTypeEnum.OverdraftFacility;
                var loanReferenceNumber = loanGenerate.GenerateLoanReferenceNumber(model.branchId, model.productId, model.productTypeId);
                TBL_LOAN_REVOLVING addOverDraft = new TBL_LOAN_REVOLVING();

                addOverDraft.CUSTOMERID = model.customerId;
                addOverDraft.LOANSYSTEMTYPEID = model.loanSystemTypeId;
                addOverDraft.PRODUCTID = model.productId;
                addOverDraft.COMPANYID = model.companyId;
                addOverDraft.CASAACCOUNTID = model.casaAccountId;
                addOverDraft.BRANCHID = model.branchId;
                addOverDraft.CURRENCYID = model.currencyId;
                addOverDraft.LOANAPPLICATIONDETAILID = model.loanApplicationDetailId;
                addOverDraft.EXCHANGERATE = model.exchangeRate;
                addOverDraft.LOANREFERENCENUMBER = loanReferenceNumber;
                addOverDraft.RELATED_LOAN_REFERENCE_NUMBER = model.loanReferenceNumber;
                addOverDraft.SUBSECTORID = model.subSectorId;
                addOverDraft.RELATIONSHIPOFFICERID = model.relationshipOfficerId;
                addOverDraft.RELATIONSHIPMANAGERID = model.relationshipManagerId;
                addOverDraft.MISCODE = model.misCode;
                addOverDraft.TEAMMISCODE = model.teamMiscode;
                addOverDraft.INTERESTRATE = model.interestRate;
                addOverDraft.EFFECTIVEDATE = model.effectiveDate;
                addOverDraft.MATURITYDATE = model.maturityDate;
                addOverDraft.BOOKINGDATE = model.bookingDate;
                addOverDraft.OVERDRAFTLIMIT = model.overdraftLimit;
                addOverDraft.APPROVALSTATUSID = model.approvalStatusId;
                addOverDraft.APPROVEDBY = model.approvedBy;
                addOverDraft.APPROVERCOMMENT = model.approverComment;
                addOverDraft.DATEAPPROVED = model.dateApproved;
                addOverDraft.LOANSTATUSID = model.loanStatusId;
                addOverDraft.ISDISBURSED = model.isDisbursed;
                addOverDraft.DISBURSEDBY = model.disbursedBy;
                addOverDraft.DISBURSERCOMMENT = model.disburserComment;
                addOverDraft.DISBURSEDATE = model.disburseDate;
                addOverDraft.OPERATIONID = model.operationId;
                addOverDraft.CREATEDBY = model.createdBy;
                addOverDraft.DATETIMECREATED = model.dateTimeCreated;
                addOverDraft.DISCHARGELETTER = model.dischargeLetter;
                addOverDraft.SUSPENDINTEREST = model.suspendInterest;
                addOverDraft.DAYCOUNTCONVENTIONID = (short)model.dayCountConventionId;
                addOverDraft.INT_PRUDENT_GUIDELINE_STATUSID = 1; //model.internalPrudentialGuidelineStatusId;
                addOverDraft.EXT_PRUDENT_GUIDELINE_STATUSID = 1; //model.externalPrudentialGuidelineStatusId;
                addOverDraft.USER_PRUDENTIAL_GUIDE_STATUSID = 1;
                addOverDraft.NPLDATE = model.nplDate;
                addOverDraft.CREATEDBY = model.createdBy;
                addOverDraft.DATETIMECREATED = model.dateTimeCreated;
                addOverDraft.REVOLVINGTYPEID = model.revolvingTypeId;

                overDraft.Add(addOverDraft);
                // }

                this.context.TBL_LOAN_REVOLVING.AddRange(overDraft);
                if (USE_THIRD_PARTY_INTEGRATION)
                {
                    var loan = model;
                    var reviewDate = model.effectiveDate.AddDays(31);
                    if (reviewDate >= model.maturityDate)
                    {
                        throw new ConditionNotMetException("The review date must be prior to the expiry date. Review date is equal to effective date plus one month.");
                    }

                    var data = new OverDraftTopUpAndRenewViewModel
                    {
                        sanctionLimit = String.Format("{0:0.00}", loan.overdraftLimit),
                        applicationDate = systemDate.ToString("dd-MMM-yyyy", null), // loan.effectiveDate.ToString("dd-MMM-yyyy", null),
                        sanctionReferenceNumber = loan.serialNumber,
                        accountNumber = loan.productAccountNumber,
                        reviewedDate = reviewDate.ToString("dd-MMM-yyyy", null),
                        expiryDate = model.maturityDate.ToString("dd-MMM-yyyy", null),
                        sanctionDate = model.effectiveDate.ToString("dd-MMM-yyyy", null),
                        createdDate = systemDate,
                        sanctionLevel = "003",
                        sanctionAuthorizer = "999",
                        sourceReferenceNumber = model.loanReferenceNumber
                    };
                    renewalResult = finacle.OverDraftRenew(data, twoFactorAuth);
                }
                addOverDraft.SERIALNUMBER = renewalResult.serialNumber;
                var result = context.SaveChanges() > 0;

                if (renewalResult != null && result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;

            }
            return output;
        }

        public bool OverdraftExtension(TwoFactorAutheticationViewModel twoFactorAuth, int loanId, decimal amount)
        {
            bool output = false;
            ResponseMessageViewModel extentionResult = new ResponseMessageViewModel();
            try
            {
                var systemDate = generalSetup.GetApplicationDate();
                var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
                //DeleteLoanExist(loanId, systemDate);
                ArchiveOverDraft(loanId, archiveBatchCode);
                var model = (from a in context.TBL_LOAN_REVOLVING
                             join b in context.TBL_LOAN_REVIEW_OPERATION on a.REVOLVINGLOANID equals b.LOANID
                             where a.REVOLVINGLOANID == loanId && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                             && b.OPERATIONDATE.Equals(null)
                             select new RevolvingLoanViewModel()
                             {
                                 loanId = a.REVOLVINGLOANID,
                                 loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                 customerId = a.CUSTOMERID,
                                 productId = a.PRODUCTID,
                                 companyId = a.COMPANYID,
                                 casaAccountId = a.CASAACCOUNTID,
                                 branchId = a.BRANCHID,
                                 currencyId = a.CURRENCYID,
                                 loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                 exchangeRate = a.EXCHANGERATE,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 relatedLoanReferenceNumber = a.RELATED_LOAN_REFERENCE_NUMBER,
                                 subSectorId = a.SUBSECTORID,
                                 relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                 relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                 misCode = a.MISCODE,
                                 teamMiscode = a.TEAMMISCODE,
                                 interestRate = (double)b.INTERATERATE,
                                 effectiveDate = b.EFFECTIVEDATE,
                                 maturityDate = (DateTime)b.MATURITYDATE,
                                 bookingDate = DateTime.Today,
                                 overdraftLimit = (decimal)b.OVERDRAFTTOPUP,
                                 pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                 pastDueInterest = a.PASTDUEINTEREST,
                                 interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                 interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                 penalChargeAmount = a.PENALCHARGEAMOUNT,
                                 approvalStatusId = a.APPROVALSTATUSID,
                                 approvedBy = (int)a.APPROVEDBY,
                                 approverComment = a.APPROVERCOMMENT,
                                 dateApproved = a.DATEAPPROVED,
                                 loanStatusId = a.LOANSTATUSID,
                                 isDisbursed = a.ISDISBURSED,
                                 disbursedBy = a.DISBURSEDBY,
                                 disburserComment = a.DISBURSERCOMMENT,
                                 disburseDate = a.DISBURSEDATE,
                                 operationId = b.OPERATIONTYPEID,
                                 dischargeLetter = a.DISCHARGELETTER,
                                 suspendInterest = a.SUSPENDINTEREST,
                                 dayCountConventionId = a.DAYCOUNTCONVENTIONID,
                                 internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                                 externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                                 nplDate = a.NPLDATE,
                                 createdBy = a.CREATEDBY,
                                 dateTimeCreated = DateTime.Today,
                                 revolvingTypeId = a.REVOLVINGTYPEID,
                                 productAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                 serialNumber = a.SERIALNUMBER,

                             }).FirstOrDefault();

                List<TBL_LOAN_REVOLVING> overDraft = new List<TBL_LOAN_REVOLVING>();

                model.productTypeId = (int)LoanSystemTypeEnum.OverdraftFacility;
                var loanReferenceNumber = loanGenerate.GenerateLoanReferenceNumber(model.branchId, model.productId, model.productTypeId);
                TBL_LOAN_REVOLVING addOverDraft = new TBL_LOAN_REVOLVING();

                addOverDraft.CUSTOMERID = model.customerId;
                addOverDraft.LOANSYSTEMTYPEID = model.loanSystemTypeId;
                addOverDraft.PRODUCTID = model.productId;
                addOverDraft.COMPANYID = model.companyId;
                addOverDraft.CASAACCOUNTID = model.casaAccountId;
                addOverDraft.BRANCHID = model.branchId;
                addOverDraft.CURRENCYID = model.currencyId;
                addOverDraft.LOANAPPLICATIONDETAILID = model.loanApplicationDetailId;
                addOverDraft.EXCHANGERATE = model.exchangeRate;
                addOverDraft.LOANREFERENCENUMBER = loanReferenceNumber;
                addOverDraft.RELATED_LOAN_REFERENCE_NUMBER = model.loanReferenceNumber;
                addOverDraft.SUBSECTORID = model.subSectorId;
                addOverDraft.RELATIONSHIPOFFICERID = model.relationshipOfficerId;
                addOverDraft.RELATIONSHIPMANAGERID = model.relationshipManagerId;
                addOverDraft.MISCODE = model.misCode;
                addOverDraft.TEAMMISCODE = model.teamMiscode;
                addOverDraft.INTERESTRATE = model.interestRate;
                addOverDraft.EFFECTIVEDATE = model.effectiveDate;
                addOverDraft.MATURITYDATE = model.maturityDate;
                addOverDraft.BOOKINGDATE = model.bookingDate;
                addOverDraft.OVERDRAFTLIMIT = model.overdraftLimit;
                addOverDraft.APPROVALSTATUSID = model.approvalStatusId;
                addOverDraft.APPROVEDBY = model.approvedBy;
                addOverDraft.APPROVERCOMMENT = model.approverComment;
                addOverDraft.DATEAPPROVED = model.dateApproved;
                addOverDraft.LOANSTATUSID = model.loanStatusId;
                addOverDraft.ISDISBURSED = model.isDisbursed;
                addOverDraft.DISBURSEDBY = model.disbursedBy;
                addOverDraft.DISBURSERCOMMENT = model.disburserComment;
                addOverDraft.DISBURSEDATE = model.disburseDate;
                addOverDraft.OPERATIONID = model.operationId;
                addOverDraft.CREATEDBY = model.createdBy;
                addOverDraft.DATETIMECREATED = model.dateTimeCreated;
                addOverDraft.DISCHARGELETTER = model.dischargeLetter;
                addOverDraft.SUSPENDINTEREST = model.suspendInterest;
                addOverDraft.DAYCOUNTCONVENTIONID = (short)model.dayCountConventionId;
                addOverDraft.INT_PRUDENT_GUIDELINE_STATUSID = 1; //model.internalPrudentialGuidelineStatusId;
                addOverDraft.EXT_PRUDENT_GUIDELINE_STATUSID = 1; //model.externalPrudentialGuidelineStatusId;
                addOverDraft.USER_PRUDENTIAL_GUIDE_STATUSID = 1;
                addOverDraft.NPLDATE = model.nplDate;
                addOverDraft.CREATEDBY = model.createdBy;
                addOverDraft.DATETIMECREATED = model.dateTimeCreated;
                addOverDraft.REVOLVINGTYPEID = model.revolvingTypeId;

                overDraft.Add(addOverDraft);

                this.context.TBL_LOAN_REVOLVING.AddRange(overDraft);

                if (USE_THIRD_PARTY_INTEGRATION)
                {
                    var loan = model;
                    //var reviewDate = loan.bookingDate.AddMonths(1);
                    var reviewDate = loan.maturityDate.AddDays(-1);
                    var data = new OverDraftExtendViewModel
                    {
                        sanctionLimit = String.Format("{0:0.00}", loan.overdraftLimit),
                        sanctionReferenceNumber = loan.serialNumber,
                        accountNumber = loan.productAccountNumber,
                        expiryDate = loan.maturityDate.ToString("dd-MMM-yyyy", null),
                        reviewedDate = reviewDate.ToString("dd-MMM-yyyy", null),
                        createdDate = systemDate,
                    };
                    extentionResult = finacle.OverDraftExtend(data, twoFactorAuth);
                }

                addOverDraft.SERIALNUMBER = extentionResult.serialNumber;
                var result = context.SaveChanges() > 0;
                if (extentionResult != null && result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;

            }

            return output;
        }

        private bool ChangeOperativeAccount(int casaAccountId, int newCasaAccountId, int loanId, LoanSystemTypeEnum facilityType)
        {
            bool output = false;
            try
            {
                //if(facilityType == LoanSystemTypeEnum.OverdraftFacility)

                if (facilityType == LoanSystemTypeEnum.TermDisbursedFacility)
                {
                    //   var data = context.TBL_LOAN_REVOLVING.Where(x => x.REVOLVINGLOANID == loanId && x.CASAACCOUNTID == casaAccountId).FirstOrDefault();
                    //TBL_LOAN loanResult = (from p in context.TBL_LOAN
                    //                       where p.CASAACCOUNTID == casaAccountId && p.TERMLOANID == loanId
                    //                        && p.LOANSTATUSID == (short)LoanStatusEnum.Active
                    //                       select p).SingleOrDefault();

                    TBL_LOAN loanResult = (from p in context.TBL_LOAN
                                           where p.TERMLOANID == loanId
                                            && p.LOANSTATUSID == (short)LoanStatusEnum.Active
                                           select p).SingleOrDefault();

                    //var casa = this.context.TBL_CASA.Where(x => x.CASAACCOUNTID == newCasaAccountId && x.ACCOUNTSTATUSID == (short)CASAAccountStatusEnum.Active).FirstOrDefault().CASAACCOUNTID;
                    var casa = this.context.TBL_CASA.Where(x => x.CASAACCOUNTID == newCasaAccountId && x.ACCOUNTSTATUSID == (short)CASAAccountStatusEnum.Active).FirstOrDefault().CASAACCOUNTID;

                    //loanResult.CASAACCOUNTID = casa;

                    loanResult.CASAACCOUNTID2 = casa;

                    context.SaveChanges(); // var result = context.SaveChanges() > 0;

                    return true;

                }
                //else if (facilityType == LoanSystemTypeEnum.OverdraftFacility)
                //{
                //    TBL_LOAN_REVOLVING loanResult = (from p in context.TBL_LOAN_REVOLVING
                //                                     where p.CASAACCOUNTID == casaAccountId && p.REVOLVINGLOANID == loanId
                //                            && p.LOANSTATUSID == (short)LoanStatusEnum.Active
                //                                     select p).SingleOrDefault();
                //    var casa = this.context.TBL_CASA.Where(x => x.CASAACCOUNTID == newCasaAccountId && x.ACCOUNTSTATUSID == (short)CASAAccountStatusEnum.Active).FirstOrDefault().CASAACCOUNTID;

                //    loanResult.CASAACCOUNTID = casa;
                //}



            }
            catch (Exception ex)
            {
                throw ex;
            }

            return output;
        }

        public bool SubAllocation(TwoFactorAutheticationViewModel twoFactorAuth, int loanId, decimal amount, DateTime applicationDate, int staffId)
        {
            bool output = false;
            ResponseMessageViewModel subAllocationExtentionResult = new ResponseMessageViewModel();
            ResponseMessageViewModel subAllocationResult = new ResponseMessageViewModel();
            var initialLimit = this.context.TBL_LOAN_REVOLVING.Where(x => x.REVOLVINGLOANID == loanId).FirstOrDefault().OVERDRAFTLIMIT;

            try
            {
                var systemDate = generalSetup.GetApplicationDate();
                var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
                DeleteLoanExist(loanId, systemDate);
                ArchiveOverDraft(loanId, archiveBatchCode);
                var model = (from a in context.TBL_LOAN_REVOLVING
                             join b in context.TBL_LOAN_REVIEW_OPERATION on a.REVOLVINGLOANID equals b.LOANID
                             join c in context.TBL_CASA on b.CASA_ACCOUNTID equals c.CASAACCOUNTID
                             where a.REVOLVINGLOANID == loanId && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                             && b.OPERATIONDATE.Equals(null)
                             select new RevolvingLoanViewModel()
                             {
                                 loanId = a.REVOLVINGLOANID,
                                 loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                 customerId = a.CUSTOMERID,
                                 productId = a.PRODUCTID,
                                 companyId = a.COMPANYID,
                                 casaAccountId = a.CASAACCOUNTID,
                                 branchId = a.BRANCHID,
                                 currencyId = a.CURRENCYID,
                                 loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                 exchangeRate = a.EXCHANGERATE,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 relatedLoanReferenceNumber = a.RELATED_LOAN_REFERENCE_NUMBER,
                                 subSectorId = a.SUBSECTORID,
                                 relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                 relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                 misCode = a.MISCODE,
                                 teamMiscode = a.TEAMMISCODE,
                                 interestRate = (double)b.INTERATERATE,
                                 effectiveDate = b.EFFECTIVEDATE,
                                 maturityDate = (DateTime)b.MATURITYDATE,
                                 bookingDate = systemDate,
                                 overdraftLimit = (decimal)b.OVERDRAFTTOPUP,
                                 pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                 pastDueInterest = a.PASTDUEINTEREST,
                                 interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                 interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                 penalChargeAmount = a.PENALCHARGEAMOUNT,
                                 approvalStatusId = a.APPROVALSTATUSID,
                                 approvedBy = (int)a.APPROVEDBY,
                                 approverComment = a.APPROVERCOMMENT,
                                 dateApproved = a.DATEAPPROVED,
                                 loanStatusId = a.LOANSTATUSID,
                                 isDisbursed = a.ISDISBURSED,
                                 disbursedBy = a.DISBURSEDBY,
                                 disburserComment = a.DISBURSERCOMMENT,
                                 disburseDate = a.DISBURSEDATE,
                                 operationId = b.OPERATIONTYPEID,
                                 dischargeLetter = a.DISCHARGELETTER,
                                 suspendInterest = a.SUSPENDINTEREST,
                                 dayCountConventionId = a.DAYCOUNTCONVENTIONID,
                                 internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                                 externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                                 nplDate = a.NPLDATE,
                                 createdBy = a.CREATEDBY,
                                 dateTimeCreated = DateTime.Today,
                                 revolvingTypeId = a.REVOLVINGTYPEID,
                                 productAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                 serialNumber = a.SERIALNUMBER,
                                 casaAccountNumber = c.PRODUCTACCOUNTNUMBER,


                             }).FirstOrDefault();

                List<TBL_LOAN_REVOLVING> overDraft = new List<TBL_LOAN_REVOLVING>();

                model.productTypeId = (int)LoanSystemTypeEnum.OverdraftFacility;
                var loanReferenceNumber = loanGenerate.GenerateLoanReferenceNumber(model.branchId, model.productId, model.productTypeId);
                TBL_LOAN_REVOLVING addOverDraft = new TBL_LOAN_REVOLVING();

                addOverDraft.CUSTOMERID = model.customerId;
                addOverDraft.LOANSYSTEMTYPEID = model.loanSystemTypeId;
                addOverDraft.PRODUCTID = model.productId;
                addOverDraft.COMPANYID = model.companyId;
                addOverDraft.CASAACCOUNTID = model.casaAccountId;
                addOverDraft.BRANCHID = model.branchId;
                addOverDraft.CURRENCYID = model.currencyId;
                addOverDraft.LOANAPPLICATIONDETAILID = model.loanApplicationDetailId;
                addOverDraft.EXCHANGERATE = model.exchangeRate;
                addOverDraft.LOANREFERENCENUMBER = loanReferenceNumber;
                addOverDraft.RELATED_LOAN_REFERENCE_NUMBER = model.loanReferenceNumber;
                addOverDraft.SUBSECTORID = model.subSectorId;
                addOverDraft.RELATIONSHIPOFFICERID = model.relationshipOfficerId;
                addOverDraft.RELATIONSHIPMANAGERID = model.relationshipManagerId;
                addOverDraft.MISCODE = model.misCode;
                addOverDraft.TEAMMISCODE = model.teamMiscode;
                addOverDraft.INTERESTRATE = model.interestRate;
                addOverDraft.EFFECTIVEDATE = model.effectiveDate;
                addOverDraft.MATURITYDATE = model.maturityDate;
                addOverDraft.BOOKINGDATE = model.bookingDate;
                addOverDraft.OVERDRAFTLIMIT = model.overdraftLimit;
                addOverDraft.APPROVALSTATUSID = model.approvalStatusId;
                addOverDraft.APPROVEDBY = model.approvedBy;
                addOverDraft.APPROVERCOMMENT = model.approverComment;
                addOverDraft.DATEAPPROVED = model.dateApproved;
                addOverDraft.LOANSTATUSID = model.loanStatusId;
                addOverDraft.ISDISBURSED = model.isDisbursed;
                addOverDraft.DISBURSEDBY = model.disbursedBy;
                addOverDraft.DISBURSERCOMMENT = model.disburserComment;
                addOverDraft.DISBURSEDATE = model.disburseDate;
                addOverDraft.OPERATIONID = model.operationId;
                addOverDraft.CREATEDBY = model.createdBy;
                addOverDraft.DATETIMECREATED = model.dateTimeCreated;
                addOverDraft.DISCHARGELETTER = model.dischargeLetter;
                addOverDraft.SUSPENDINTEREST = model.suspendInterest;
                addOverDraft.DAYCOUNTCONVENTIONID = (short)model.dayCountConventionId;
                addOverDraft.INT_PRUDENT_GUIDELINE_STATUSID = 1; //model.internalPrudentialGuidelineStatusId;
                addOverDraft.EXT_PRUDENT_GUIDELINE_STATUSID = 1; //model.externalPrudentialGuidelineStatusId;
                addOverDraft.USER_PRUDENTIAL_GUIDE_STATUSID = 1;
                addOverDraft.NPLDATE = model.nplDate;
                addOverDraft.CREATEDBY = model.createdBy;
                addOverDraft.DATETIMECREATED = model.dateTimeCreated;
                addOverDraft.REVOLVINGTYPEID = model.revolvingTypeId;

                overDraft.Add(addOverDraft);

                this.context.TBL_LOAN_REVOLVING.AddRange(overDraft);

                if (USE_THIRD_PARTY_INTEGRATION)
                {
                    var batchCode = CommonHelpers.GenerateRandomDigitCode(10);
                    var loan = model;
                    //var reviewDate = loan.bookingDate.AddMonths(1);
                    var reviewDate = loan.maturityDate.AddDays(-1);
                    var data = new OverDraftExtendViewModel
                    {
                        sanctionLimit = String.Format("{0:0.00}", initialLimit - loan.overdraftLimit),
                        sanctionReferenceNumber = loan.serialNumber,
                        accountNumber = loan.productAccountNumber,
                        expiryDate = loan.maturityDate.ToString("dd-MMM-yyyy", null),
                        reviewedDate = reviewDate.ToString("dd-MMM-yyyy", null),
                        createdDate = systemDate,
                        sanctionLevel = "003",
                        sanctionAuthorizer = "999"
                    };
                    subAllocationExtentionResult = finacle.OverDraftExtend(data, twoFactorAuth);
                    var data1 = new OverDraftNormalViewModel
                    {
                        accountNumber = loan.casaAccountNumber,
                        applicationDate = loan.bookingDate.ToString("dd-MMM-yyyy", null),
                        documentDate = loan.bookingDate.ToString("dd-MMM-yyyy", null),
                        expiryDate = loan.maturityDate.ToString("dd-MMM-yyyy", null),
                        reviewedDate = reviewDate.ToString("dd-MMM-yyyy", null),
                        sanctionDate = loan.bookingDate.ToString("dd-MMM-yyyy", null),
                        sanctionLimit = String.Format("{0:0.00}", loan.overdraftLimit),
                        sanctionReferenceNumber = batchCode,//revolvingLoanRecord.LOANREFERENCENUMBER
                        sanctionLevel = "003",
                        sanctionAuthorizer = "999"
                    };

                    subAllocationResult = finacle.OverDraftNormal(data1, twoFactorAuth);
                }

                addOverDraft.SERIALNUMBER = subAllocationResult.serialNumber;


                TBL_LOAN_REVOLVING results = (from p in context.TBL_LOAN_REVOLVING
                                              where p.REVOLVINGLOANID == loanId
                                              && p.LOANSTATUSID == (short)LoanStatusEnum.Active
                                              select p).SingleOrDefault();

                results.OVERDRAFTLIMIT = results.OVERDRAFTLIMIT - amount;
                var result = context.SaveChanges() > 0;

                if (subAllocationExtentionResult != null && subAllocationResult != null && result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;


            }
            return output;
        }

        public bool OverdraftInterestRate(TwoFactorAutheticationViewModel twoFactorAuth, int loanId)
        {
            bool output = false;
            bool interestRateResult = false;
            //ResponseMessageViewModel interestRateResult = new ResponseMessageViewModel();
            InterestRateInquiryViewModel accountOutput = null;
            try
            {

                var systemDate = generalSetup.GetApplicationDate();
                var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);

                ArchiveOverDraft(loanId, archiveBatchCode);
                var model = (from a in context.TBL_LOAN_REVOLVING
                             join b in context.TBL_LOAN_REVIEW_OPERATION on a.REVOLVINGLOANID equals b.LOANID
                             where a.REVOLVINGLOANID == loanId && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                             && b.OPERATIONDATE.Equals(null)
                             && b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.OverdraftFacility
                             select new RevolvingLoanViewModel()
                             {
                                 loanId = a.REVOLVINGLOANID,
                                 loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                 customerId = a.CUSTOMERID,
                                 productId = a.PRODUCTID,
                                 companyId = a.COMPANYID,
                                 casaAccountId = a.CASAACCOUNTID,
                                 branchId = a.BRANCHID,
                                 currencyId = a.CURRENCYID,
                                 loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                 exchangeRate = a.EXCHANGERATE,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 relatedLoanReferenceNumber = a.RELATED_LOAN_REFERENCE_NUMBER,
                                 subSectorId = a.SUBSECTORID,
                                 relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                 relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                 misCode = a.MISCODE,
                                 teamMiscode = a.TEAMMISCODE,
                                 interestRate = (double)b.INTERATERATE,
                                 effectiveDate = b.EFFECTIVEDATE,
                                 maturityDate = (DateTime)b.MATURITYDATE,
                                 bookingDate = DateTime.Today,
                                 overdraftLimit = (decimal?)b.OVERDRAFTTOPUP ?? 0,
                                 pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                 pastDueInterest = a.PASTDUEINTEREST,
                                 interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                 interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                 penalChargeAmount = a.PENALCHARGEAMOUNT,
                                 approvalStatusId = a.APPROVALSTATUSID,
                                 approvedBy = (int)a.APPROVEDBY,
                                 approverComment = a.APPROVERCOMMENT,
                                 dateApproved = a.DATEAPPROVED,
                                 loanStatusId = a.LOANSTATUSID,
                                 isDisbursed = a.ISDISBURSED,
                                 disbursedBy = a.DISBURSEDBY,
                                 disburserComment = a.DISBURSERCOMMENT,
                                 disburseDate = a.DISBURSEDATE,
                                 operationId = b.OPERATIONTYPEID,
                                 dischargeLetter = a.DISCHARGELETTER,
                                 suspendInterest = a.SUSPENDINTEREST,
                                 dayCountConventionId = a.DAYCOUNTCONVENTIONID,
                                 internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                                 externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                                 nplDate = a.NPLDATE,
                                 createdBy = a.CREATEDBY,
                                 dateTimeCreated = DateTime.Today,
                                 revolvingTypeId = a.REVOLVINGTYPEID,
                                 productAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                 serialNumber = a.SERIALNUMBER,

                             }).FirstOrDefault();


                model.productTypeId = (int)LoanSystemTypeEnum.OverdraftFacility;

                var validateThirdPartyIntegration = USE_THIRD_PARTY_INTEGRATION;

                if (USE_THIRD_PARTY_INTEGRATION)
                {

                    var data1 = context.TBL_LOAN_REVOLVING.Find(loanId);

                    if (data1.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                    {
                        var loan = model;
                        var acctType = "DR";
                        accountOutput = finacle.GetInterestRateInquiry(loan.productAccountNumber, acctType);
                        var reviewDate = data1.BOOKINGDATE.AddMonths(1);
                        var data = new InterestRateInquiryViewModel
                        {
                            interestRateAmount = String.Format("{0:0.00}", loan.interestRate),
                            interestTableCode = accountOutput.interestTableCode,
                            accountNumber = loan.productAccountNumber,
                            endDate = loan.maturityDate.ToString("dd-MMM-yyyy", null),
                            accountType = acctType,
                            startDate = loan.effectiveDate.ToString("dd-MMM-yyyy", null),
                        };

                        interestRateResult = finacle.ChangeOverDraftInterestRate(data, data.accountType, twoFactorAuth);
                    }
                    else
                    {
                        throw new SecureException("Limit has experied or is inactive");
                    }
                }


                var loanRevolving = context.TBL_LOAN_REVOLVING.Where(x => x.REVOLVINGLOANID == model.loanId).FirstOrDefault();
                loanRevolving.INTERESTRATE = model.interestRate;


                var result = context.SaveChanges() > 0;

                if (validateThirdPartyIntegration)
                {
                    if (interestRateResult == true && result == true)
                    {
                        output = true;
                    }
                    else
                    {
                        throw new SecureException("OD Operation Not Completed because interest rate cannot be set");
                    }
                }
                else
                {
                    if (result)
                    {
                        output = true;
                    }
                    else
                    {
                        throw new SecureException("OD Operation Not Completed because interest rate cannot be set");
                    }
                }






            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;
        }

        #endregion

        #region Re-phasement  Operation
        //---------------------------------- Begining of Loan re-phasement-------------------------------------

        //---------------------------------- Rate Revision-------------------------------------

        public IEnumerable<LoanOperationTypeViewModel> GetOperationTypeByContingent()
        {
            return (from data in context.TBL_OPERATIONS
                    where data.OPERATIONID == (int)OperationsEnum.ContingentLiabilityRenewal
                     || data.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTermination
                     || data.OPERATIONID == (int)OperationsEnum.ContingentLiabilityAmountReduction
                     || data.OPERATIONID == (int)OperationsEnum.ContingentLiabilityAmountAddition
                     || data.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTenorExtension
                     || data.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook
                     || data.OPERATIONID == (int)OperationsEnum.AnnualReview
                    select new LoanOperationTypeViewModel()
                    {
                        operationTypeId = data.OPERATIONID,
                        operationTypeName = data.OPERATIONNAME
                    });
        }

        public int LoanExist(int loanId)
        {
            var loanRef = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
                           where a.LOANID == loanId
                           select a);
            int loanRefResults = loanRef.Count();

            return loanRefResults;
        }


        public bool DeleteLoanContingentExist(int loanId, DateTime applicationDate)
        {
            bool output = false;

            var removeLoan_Archive = (from p in context.TBL_LOAN_ARCHIVE
                                      where p.LOANID == loanId && p.CHANGEEFFECTIVEDATE == applicationDate
                                      select p);
            var removeLoan_Schedule_Periodic_Archive = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC_ARC
                                                        where p.LOANID == loanId && p.ARCHIVEDATE == applicationDate
                                                        select p);
            var removeLoan_Schedule_Daily_Archive = (from p in context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV
                                                     where p.LOANID == loanId && p.ARCHIVEDATE == applicationDate
                                                     select p);
            var removeLoan_Schedule_Daily_Temp = (from p in context.TBL_LOAN_SCHEDULE_DAILY_TEMP
                                                  where p.LOANID == loanId
                                                  select p);
            var removeLoan_Schedule_Periodic_Temp = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC_TMP
                                                     where p.LOANID == loanId
                                                     select p);

            //var removeOD_Archive = (from p in context.TBL_LOAN_REVOLVING_ARCHIVE
            //                        where p.REVOLVINGLOANID == loanId && p.ARCHIVEDATE == applicationDate
            //                        select p);

            var removeLoan_IrregularSchedule = (from p in context.TBL_LOAN_SCHEDULE_IREGUL_INPUT
                                                where p.LOANID == loanId
                                                select p);

            if (removeLoan_Archive != null)
            {
                context.TBL_LOAN_ARCHIVE.RemoveRange(removeLoan_Archive);
            }
            if (removeLoan_Schedule_Periodic_Archive != null)
            {
                context.TBL_LOAN_SCHEDULE_PERIODIC_ARC.RemoveRange(removeLoan_Schedule_Periodic_Archive);

            }
            if (removeLoan_Schedule_Daily_Archive != null)
            {
                context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV.RemoveRange(removeLoan_Schedule_Daily_Archive);

            }
            if (removeLoan_Schedule_Daily_Temp != null)
            {
                context.TBL_LOAN_SCHEDULE_DAILY_TEMP.RemoveRange(removeLoan_Schedule_Daily_Temp);

            }
            if (removeLoan_Schedule_Periodic_Temp != null)
            {
                context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.RemoveRange(removeLoan_Schedule_Periodic_Temp);

            }

            //if (removeOD_Archive != null)
            //{
            //    context.TBL_LOAN_REVOLVING_ARCHIVE.RemoveRange(removeOD_Archive);

            //}

            if (removeLoan_IrregularSchedule != null)
            {
                context.TBL_LOAN_SCHEDULE_IREGUL_INPUT.RemoveRange(removeLoan_IrregularSchedule);

            }

            try
            {
                context.SaveChanges();
            }
            catch (System.Data.Entity.Validation.DbEntityValidationException ex)
            {
                string errorMessages = string.Join("; ", ex.EntityValidationErrors.SelectMany(x => x.ValidationErrors).Select(x => x.ErrorMessage));
                throw new System.Data.Entity.Validation.DbEntityValidationException(errorMessages);
            }
            output = true;

            return output;
        }

        public bool DeleteLoanExist(int loanId, DateTime applicationDate)
        {
            bool output = false;

            var removeLoan_Archive = (from p in context.TBL_LOAN_ARCHIVE
                                      where p.LOANID == loanId && p.CHANGEEFFECTIVEDATE == applicationDate
                                      select p);
            var removeLoan_Schedule_Periodic_Archive = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC_ARC
                                                        where p.LOANID == loanId && p.ARCHIVEDATE == applicationDate
                                                        select p);
            var removeLoan_Schedule_Daily_Archive = (from p in context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV
                                                     where p.LOANID == loanId && p.ARCHIVEDATE == applicationDate
                                                     select p);
            var removeLoan_Schedule_Daily_Temp = (from p in context.TBL_LOAN_SCHEDULE_DAILY_TEMP
                                                  where p.LOANID == loanId
                                                  select p);
            var removeLoan_Schedule_Periodic_Temp = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC_TMP
                                                     where p.LOANID == loanId
                                                     select p);

            var removeOD_Archive = (from p in context.TBL_LOAN_REVOLVING_ARCHIVE
                                    where p.REVOLVINGLOANID == loanId && p.ARCHIVEDATE == applicationDate
                                    select p);

            var removeLoan_IrregularSchedule = (from p in context.TBL_LOAN_SCHEDULE_IREGUL_INPUT
                                                where p.LOANID == loanId
                                                select p);

            if (removeLoan_Archive != null)
            {
                context.TBL_LOAN_ARCHIVE.RemoveRange(removeLoan_Archive);
            }
            if (removeLoan_Schedule_Periodic_Archive != null)
            {
                context.TBL_LOAN_SCHEDULE_PERIODIC_ARC.RemoveRange(removeLoan_Schedule_Periodic_Archive);

            }
            if (removeLoan_Schedule_Daily_Archive != null)
            {
                context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV.RemoveRange(removeLoan_Schedule_Daily_Archive);

            }
            if (removeLoan_Schedule_Daily_Temp != null)
            {
                context.TBL_LOAN_SCHEDULE_DAILY_TEMP.RemoveRange(removeLoan_Schedule_Daily_Temp);

            }
            if (removeLoan_Schedule_Periodic_Temp != null)
            {
                context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.RemoveRange(removeLoan_Schedule_Periodic_Temp);

            }
            if (removeOD_Archive != null)
            {
                context.TBL_LOAN_REVOLVING_ARCHIVE.RemoveRange(removeOD_Archive);

            }

            if (removeLoan_IrregularSchedule != null)
            {
                context.TBL_LOAN_SCHEDULE_IREGUL_INPUT.RemoveRange(removeLoan_IrregularSchedule);

            }

            try
            {
                context.SaveChanges();
            }
            catch (System.Data.Entity.Validation.DbEntityValidationException ex)
            {
                string errorMessages = string.Join("; ", ex.EntityValidationErrors.SelectMany(x => x.ValidationErrors).Select(x => x.ErrorMessage));
                throw new System.Data.Entity.Validation.DbEntityValidationException(errorMessages);
            }
            output = true;

            return output;
        }

        public bool DeleteLoanExistingOnDailyAndPeriodicSchedule(int loanId)
        {
            bool output = false;

            var removeLoan_Schedule_Daily = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                                             where p.LOANID == loanId
                                             select p);

            var removeLoan_Schedule_Periodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                                                where p.LOANID == loanId
                                                select p);

            if (removeLoan_Schedule_Daily != null)
            {
                context.TBL_LOAN_SCHEDULE_DAILY.RemoveRange(removeLoan_Schedule_Daily);
            }

            if (removeLoan_Schedule_Periodic != null)
            {
                context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(removeLoan_Schedule_Periodic);

            }

            try
            {
                context.SaveChanges();
            }
            catch (System.Data.Entity.Validation.DbEntityValidationException ex)
            {
                string errorMessages = string.Join("; ", ex.EntityValidationErrors.SelectMany(x => x.ValidationErrors).Select(x => x.ErrorMessage));
                throw new System.Data.Entity.Validation.DbEntityValidationException(errorMessages);
            }
            output = true;

            return output;
        }

        public LoanViewModel ArchiveLoanContingent(int loanId, int operationId, string archiveBatchCode)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var model = (from a in context.TBL_LOAN
                         where a.TERMLOANID == loanId && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                         select new LoanViewModel()
                         {
                             loanId = a.TERMLOANID,
                             productPriceIndexRate = (double)a.PRODUCTPRICEINDEXRATE,
                             customerRiskRatingId = a.CUSTOMERRISKRATINGID,
                             loanSystemTypeId = (short)a.LOANSYSTEMTYPEID,
                             customerId = a.CUSTOMERID,
                             productId = a.PRODUCTID,
                             companyId = a.COMPANYID,
                             casaAccountId = a.CASAACCOUNTID,
                             branchId = a.BRANCHID,
                             currencyId = a.CURRENCYID,
                             exchangeRate = a.EXCHANGERATE,
                             loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                             loanReferenceNumber = a.LOANREFERENCENUMBER,
                             subSectorId = a.SUBSECTORID,
                             principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID,
                             interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID,
                             principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                             interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                             relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                             relationshipManagerId = a.RELATIONSHIPMANAGERID,
                             misCode = a.MISCODE,
                             teamMiscode = a.TEAMMISCODE,
                             interestRate = a.INTERESTRATE,
                             effectiveDate = a.EFFECTIVEDATE,
                             lastRestructureDate = (DateTime)a.LASTRESTRUCTUREDATE,
                             maturityDate = a.MATURITYDATE,
                             bookingDate = a.BOOKINGDATE,
                             principalAmount = a.PRINCIPALAMOUNT,
                             principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                             interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                             approvalStatusId = a.APPROVALSTATUSID,
                             approvedBy = a.APPROVEDBY,
                             approverComment = a.APPROVERCOMMENT,
                             dateApproved = a.DATEAPPROVED,
                             loanStatusId = a.LOANSTATUSID,
                             scheduleTypeId = a.SCHEDULETYPEID,
                             scheduleDayCountConventionId = a.SCHEDULEDAYCOUNTCONVENTIONID,
                             scheduleDayInterestTypeId = a.SCHEDULEDAYINTERESTTYPEID,
                             isDisbursed = a.ISDISBURSED,
                             disbursedBy = a.DISBURSEDBY,
                             disburserComment = a.DISBURSERCOMMENT,
                             disburseDate = a.DISBURSEDATE,
                             operationId = a.OPERATIONID,
                             customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                             loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                             equityContribution = a.EQUITYCONTRIBUTION,
                             firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                             firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                             outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                             outstandingInterest = a.OUTSTANDINGINTEREST,
                             pastDuePrincipal = a.PASTDUEPRINCIPAL,
                             pastDueInterest = a.PASTDUEINTEREST,
                             interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                             interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                             penalChargeAmount = a.PENALCHARGEAMOUNT,
                             principalAdditionCount = a.PRINCIPALADDITIONCOUNT,
                             principalReductionCount = a.PRINCIPALREDUCTIONCOUNT,
                             fixedPrincipal = a.FIXEDPRINCIPAL,
                             profileLoan = a.PROFILELOAN,
                             dischargeLetter = a.DISCHARGELETTER,
                             suspendInterest = a.SUSPENDINTEREST,
                             isScheduledPrepayment = a.ISSCHEDULEDPREPAYMENT,
                             allowForceDebitRepayment = a.ALLOWFORCEDEBITREPAYMENT,
                             scheduledPrepaymentAmount = a.SCHEDULEDPREPAYMENTAMOUNT,
                             scheduledPrepaymentDate = a.SCHEDULEDPREPAYMENTDATE,
                             scheduledPrepaymentFrequencyTypeId = a.SCH_PREPAYMENT_FREQUENCY_TYPID,
                             internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                             externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                             userPrudentialGuidelineStatusId = a.USER_PRUDENTIAL_GUIDE_STATUSID,
                             nplDate = a.NPLDATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,

                         }).FirstOrDefault();

            List<TBL_LOAN_ARCHIVE> loanArchive = new List<TBL_LOAN_ARCHIVE>();

            TBL_LOAN_ARCHIVE addLoanArchive = new TBL_LOAN_ARCHIVE();


            addLoanArchive.CHANGEEFFECTIVEDATE = systemDate;
            addLoanArchive.ISAPPLIED = false;
            addLoanArchive.CHANGEREASON = "Rephasement";
            addLoanArchive.LOANID = model.loanId;
            addLoanArchive.PRODUCTPRICEINDEXRATE = model.productPriceIndexRate;
            addLoanArchive.CUSTOMERRISKRATINGID = model.customerRiskRatingId;
            addLoanArchive.LOANSYSTEMTYPEID = model.loanSystemTypeId;
            addLoanArchive.CUSTOMERID = model.customerId;
            addLoanArchive.PRODUCTID = model.productId;
            addLoanArchive.COMPANYID = model.companyId;
            addLoanArchive.CASAACCOUNTID = model.casaAccountId;
            addLoanArchive.BRANCHID = model.branchId;
            addLoanArchive.CURRENCYID = (short)model.currencyId;
            addLoanArchive.EXCHANGERATE = model.exchangeRate;
            addLoanArchive.LOANAPPLICATIONDETAILID = model.loanApplicationDetailId;
            addLoanArchive.LOANREFERENCENUMBER = model.loanReferenceNumber;
            addLoanArchive.SUBSECTORID = model.subSectorId;
            addLoanArchive.PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId;
            addLoanArchive.INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId;
            addLoanArchive.PRINCIPALNUMBEROFINSTALLMENT = model.principalNumberOfInstallment;
            addLoanArchive.INTERESTNUMBEROFINSTALLMENT = model.interestNumberOfInstallment;
            addLoanArchive.RELATIONSHIPOFFICERID = model.relationshipOfficerId;
            addLoanArchive.RELATIONSHIPMANAGERID = model.relationshipManagerId;
            addLoanArchive.MISCODE = model.misCode;
            addLoanArchive.TEAMMISCODE = model.teamMiscode;
            addLoanArchive.INTERESTRATE = model.interestRate;
            addLoanArchive.EFFECTIVEDATE = model.effectiveDate;
            addLoanArchive.LASTRESTRUCTUREDATE = model.lastRestructureDate;
            addLoanArchive.MATURITYDATE = model.maturityDate;
            addLoanArchive.BOOKINGDATE = model.bookingDate;
            addLoanArchive.PRINCIPALAMOUNT = model.principalAmount;
            addLoanArchive.PRINCIPALINSTALLMENTLEFT = model.principalInstallmentLeft;
            addLoanArchive.INTERESTINSTALLMENTLEFT = model.interestInstallmentLeft;
            addLoanArchive.APPROVALSTATUSID = model.approvalStatusId;
            addLoanArchive.APPROVEDBY = model.approvedBy;
            addLoanArchive.APPROVERCOMMENT = model.approverComment;
            addLoanArchive.DATEAPPROVED = model.dateApproved;
            addLoanArchive.LOANSTATUSID = model.loanStatusId;
            addLoanArchive.CREATEDBY = model.createdBy;
            addLoanArchive.DATETIMECREATED = model.dateTimeCreated;
            addLoanArchive.SCHEDULETYPEID = model.scheduleTypeId;
            addLoanArchive.SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountConventionId;
            addLoanArchive.SCHEDULEDAYINTERESTTYPEID = model.scheduleDayInterestTypeId;
            addLoanArchive.ISDISBURSED = model.isDisbursed;
            addLoanArchive.DISBURSEDBY = model.disbursedBy;
            addLoanArchive.DISBURSERCOMMENT = model.disburserComment;
            addLoanArchive.DISBURSEDATE = model.disburseDate;
            addLoanArchive.OPERATIONID = operationId;
            addLoanArchive.EQUITYCONTRIBUTION = model.equityContribution;
            addLoanArchive.FIRSTPRINCIPALPAYMENTDATE = model.firstPrincipalPaymentDate;
            addLoanArchive.FIRSTINTERESTPAYMENTDATE = model.firstInterestPaymentDate;
            addLoanArchive.OUTSTANDINGPRINCIPAL = model.outstandingPrincipal;
            addLoanArchive.OUTSTANDINGINTEREST = model.outstandingInterest;
            addLoanArchive.PASTDUEPRINCIPAL = model.pastDuePrincipal;
            addLoanArchive.PASTDUEINTEREST = model.pastDueInterest;
            addLoanArchive.INTERESTONPASTDUEPRINCIPAL = model.interestOnPastDuePrincipal;
            addLoanArchive.INTERESTONPASTDUEINTEREST = model.interesrtOnPastDueInterest;
            addLoanArchive.PENALCHARGEAMOUNT = model.penalChargeAmount;
            addLoanArchive.PRINCIPALADDITIONCOUNT = model.principalAdditionCount;
            addLoanArchive.PRINCIPALREDUCTIONCOUNT = model.principalReductionCount;
            addLoanArchive.FIXEDPRINCIPAL = model.fixedPrincipal;
            addLoanArchive.PROFILELOAN = model.profileLoan;
            addLoanArchive.DISCHARGELETTER = model.dischargeLetter;
            addLoanArchive.SUSPENDINTEREST = model.suspendInterest;
            addLoanArchive.ISSCHEDULEDPREPAYMENT = model.isScheduledPrepayment;
            addLoanArchive.ALLOWFORCEDEBITREPAYMENT = model.allowForceDebitRepayment;
            addLoanArchive.SCHEDULEDPREPAYMENTAMOUNT = model.scheduledPrepaymentAmount;
            addLoanArchive.SCHEDULEDPREPAYMENTDATE = model.scheduledPrepaymentDate;
            addLoanArchive.SCH_PREPAYMENT_FREQUENCY_TYPID = model.principalFrequencyTypeId;//scheduledPrepaymentFrequencyTypeId;
            addLoanArchive.INT_PRUDENT_GUIDELINE_STATUSID = (int)model.internalPrudentialGuidelineStatusId;
            addLoanArchive.EXT_PRUDENT_GUIDELINE_STATUSID = (int)model.externalPrudentialGuidelineStatusId;
            addLoanArchive.USER_PRUDENTIAL_GUIDE_STATUSID = (int)model.userPrudentialGuidelineStatusId;
            addLoanArchive.NPLDATE = model.nplDate;
            addLoanArchive.CREATEDBY = model.createdBy;
            addLoanArchive.DATETIMECREATED = model.dateTimeCreated;
            addLoanArchive.ARCHIVEBATCHCODE = archiveBatchCode;

            //loanArchive.Add(addLoanArchive);

            //this.context.TBL_LOAN_ARCHIVE.AddRange(loanArchive);

            this.context.TBL_LOAN_ARCHIVE.Add(addLoanArchive);

            context.SaveChanges();
            return model;
        }


        public LoanViewModel ArchiveLoan(int loanId, int operationId, string archiveBatchCode, FinTrakBankingContext context, string changeReason = "Rephasement")
        {
            var systemDate = generalSetup.GetApplicationDate();
            var model = (from a in context.TBL_LOAN
                         where a.TERMLOANID == loanId
                         //&& a.LOANSTATUSID == (short)LoanStatusEnum.Active
                         select new LoanViewModel()
                         {
                             loanId = a.TERMLOANID,
                             productPriceIndexRate = (double)a.PRODUCTPRICEINDEXRATE,
                             customerRiskRatingId = a.CUSTOMERRISKRATINGID,
                             loanSystemTypeId = (short)a.LOANSYSTEMTYPEID,
                             customerId = a.CUSTOMERID,
                             productId = a.PRODUCTID,
                             companyId = a.COMPANYID,
                             casaAccountId = a.CASAACCOUNTID,
                             branchId = a.BRANCHID,
                             currencyId = a.CURRENCYID,
                             exchangeRate = a.EXCHANGERATE,
                             loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                             loanReferenceNumber = a.LOANREFERENCENUMBER,
                             subSectorId = a.SUBSECTORID,
                             principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID,
                             interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID,
                             principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                             interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                             relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                             relationshipManagerId = a.RELATIONSHIPMANAGERID,
                             misCode = a.MISCODE,
                             teamMiscode = a.TEAMMISCODE,
                             interestRate = a.INTERESTRATE,
                             effectiveDate = a.EFFECTIVEDATE,
                             lastRestructureDate = (DateTime)a.LASTRESTRUCTUREDATE,
                             maturityDate = a.MATURITYDATE,
                             bookingDate = a.BOOKINGDATE,
                             principalAmount = a.PRINCIPALAMOUNT,
                             principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                             interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                             approvalStatusId = a.APPROVALSTATUSID,
                             approvedBy = a.APPROVEDBY,
                             approverComment = a.APPROVERCOMMENT,
                             dateApproved = a.DATEAPPROVED,
                             loanStatusId = a.LOANSTATUSID,
                             scheduleTypeId = a.SCHEDULETYPEID,
                             scheduleDayCountConventionId = a.SCHEDULEDAYCOUNTCONVENTIONID,
                             scheduleDayInterestTypeId = a.SCHEDULEDAYINTERESTTYPEID,
                             isDisbursed = a.ISDISBURSED,
                             disbursedBy = a.DISBURSEDBY,
                             disburserComment = a.DISBURSERCOMMENT,
                             disburseDate = a.DISBURSEDATE,
                             operationId = a.OPERATIONID,
                             customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                             loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                             equityContribution = a.EQUITYCONTRIBUTION,
                             firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                             firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                             outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                             outstandingInterest = a.OUTSTANDINGINTEREST,
                             pastDuePrincipal = a.PASTDUEPRINCIPAL,
                             pastDueInterest = a.PASTDUEINTEREST,
                             interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                             interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                             penalChargeAmount = a.PENALCHARGEAMOUNT,
                             principalAdditionCount = a.PRINCIPALADDITIONCOUNT,
                             principalReductionCount = a.PRINCIPALREDUCTIONCOUNT,
                             fixedPrincipal = a.FIXEDPRINCIPAL,
                             profileLoan = a.PROFILELOAN,
                             dischargeLetter = a.DISCHARGELETTER,
                             suspendInterest = a.SUSPENDINTEREST,
                             isScheduledPrepayment = a.ISSCHEDULEDPREPAYMENT,
                             allowForceDebitRepayment = a.ALLOWFORCEDEBITREPAYMENT,
                             scheduledPrepaymentAmount = a.SCHEDULEDPREPAYMENTAMOUNT,
                             scheduledPrepaymentDate = a.SCHEDULEDPREPAYMENTDATE,
                             scheduledPrepaymentFrequencyTypeId = a.SCH_PREPAYMENT_FREQUENCY_TYPID,
                             internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                             externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                             userPrudentialGuidelineStatusId = a.USER_PRUDENTIAL_GUIDE_STATUSID,
                             nplDate = a.NPLDATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,

                         }).FirstOrDefault();

            List<TBL_LOAN_ARCHIVE> loanArchive = new List<TBL_LOAN_ARCHIVE>();

            TBL_LOAN_ARCHIVE addLoanArchive = new TBL_LOAN_ARCHIVE();


            addLoanArchive.CHANGEEFFECTIVEDATE = systemDate;
            addLoanArchive.ISAPPLIED = false;
            addLoanArchive.CHANGEREASON = changeReason; //"Rephasement";
            addLoanArchive.LOANID = model.loanId;
            addLoanArchive.PRODUCTPRICEINDEXRATE = model.productPriceIndexRate;
            addLoanArchive.CUSTOMERRISKRATINGID = model.customerRiskRatingId;
            addLoanArchive.LOANSYSTEMTYPEID = model.loanSystemTypeId;
            addLoanArchive.CUSTOMERID = model.customerId;
            addLoanArchive.PRODUCTID = model.productId;
            addLoanArchive.COMPANYID = model.companyId;
            addLoanArchive.CASAACCOUNTID = model.casaAccountId;
            addLoanArchive.BRANCHID = model.branchId;
            addLoanArchive.CURRENCYID = (short)model.currencyId;
            addLoanArchive.EXCHANGERATE = model.exchangeRate;
            addLoanArchive.LOANAPPLICATIONDETAILID = model.loanApplicationDetailId;
            addLoanArchive.LOANREFERENCENUMBER = model.loanReferenceNumber;
            addLoanArchive.SUBSECTORID = model.subSectorId;
            addLoanArchive.PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId;
            addLoanArchive.INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId;
            addLoanArchive.PRINCIPALNUMBEROFINSTALLMENT = model.principalNumberOfInstallment;
            addLoanArchive.INTERESTNUMBEROFINSTALLMENT = model.interestNumberOfInstallment;
            addLoanArchive.RELATIONSHIPOFFICERID = model.relationshipOfficerId;
            addLoanArchive.RELATIONSHIPMANAGERID = model.relationshipManagerId;
            addLoanArchive.MISCODE = model.misCode;
            addLoanArchive.TEAMMISCODE = model.teamMiscode;
            addLoanArchive.INTERESTRATE = model.interestRate;
            addLoanArchive.EFFECTIVEDATE = model.effectiveDate;
            addLoanArchive.LASTRESTRUCTUREDATE = model.lastRestructureDate;
            addLoanArchive.MATURITYDATE = model.maturityDate;
            addLoanArchive.BOOKINGDATE = model.bookingDate;
            addLoanArchive.PRINCIPALAMOUNT = model.principalAmount;
            addLoanArchive.PRINCIPALINSTALLMENTLEFT = model.principalInstallmentLeft;
            addLoanArchive.INTERESTINSTALLMENTLEFT = model.interestInstallmentLeft;
            addLoanArchive.APPROVALSTATUSID = model.approvalStatusId;
            addLoanArchive.APPROVEDBY = model.approvedBy;
            addLoanArchive.APPROVERCOMMENT = model.approverComment;
            addLoanArchive.DATEAPPROVED = model.dateApproved;
            addLoanArchive.LOANSTATUSID = model.loanStatusId;
            addLoanArchive.CREATEDBY = model.createdBy;
            addLoanArchive.DATETIMECREATED = model.dateTimeCreated;
            addLoanArchive.SCHEDULETYPEID = model.scheduleTypeId;
            addLoanArchive.SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountConventionId;
            addLoanArchive.SCHEDULEDAYINTERESTTYPEID = model.scheduleDayInterestTypeId;
            addLoanArchive.ISDISBURSED = model.isDisbursed;
            addLoanArchive.DISBURSEDBY = model.disbursedBy;
            addLoanArchive.DISBURSERCOMMENT = model.disburserComment;
            addLoanArchive.DISBURSEDATE = model.disburseDate;
            addLoanArchive.OPERATIONID = operationId;
            addLoanArchive.EQUITYCONTRIBUTION = model.equityContribution;
            addLoanArchive.FIRSTPRINCIPALPAYMENTDATE = model.firstPrincipalPaymentDate;
            addLoanArchive.FIRSTINTERESTPAYMENTDATE = model.firstInterestPaymentDate;
            addLoanArchive.OUTSTANDINGPRINCIPAL = model.outstandingPrincipal;
            addLoanArchive.OUTSTANDINGINTEREST = model.outstandingInterest;
            addLoanArchive.PASTDUEPRINCIPAL = model.pastDuePrincipal;
            addLoanArchive.PASTDUEINTEREST = model.pastDueInterest;
            addLoanArchive.INTERESTONPASTDUEPRINCIPAL = model.interestOnPastDuePrincipal;
            addLoanArchive.INTERESTONPASTDUEINTEREST = model.interesrtOnPastDueInterest;
            addLoanArchive.PENALCHARGEAMOUNT = model.penalChargeAmount;
            addLoanArchive.PRINCIPALADDITIONCOUNT = model.principalAdditionCount;
            addLoanArchive.PRINCIPALREDUCTIONCOUNT = model.principalReductionCount;
            addLoanArchive.FIXEDPRINCIPAL = model.fixedPrincipal;
            addLoanArchive.PROFILELOAN = model.profileLoan;
            addLoanArchive.DISCHARGELETTER = model.dischargeLetter;
            addLoanArchive.SUSPENDINTEREST = model.suspendInterest;
            addLoanArchive.ISSCHEDULEDPREPAYMENT = model.isScheduledPrepayment;
            addLoanArchive.ALLOWFORCEDEBITREPAYMENT = model.allowForceDebitRepayment;
            addLoanArchive.SCHEDULEDPREPAYMENTAMOUNT = model.scheduledPrepaymentAmount;
            addLoanArchive.SCHEDULEDPREPAYMENTDATE = model.scheduledPrepaymentDate;
            addLoanArchive.SCH_PREPAYMENT_FREQUENCY_TYPID = model.principalFrequencyTypeId;//scheduledPrepaymentFrequencyTypeId;
            addLoanArchive.INT_PRUDENT_GUIDELINE_STATUSID = (int)model.internalPrudentialGuidelineStatusId;
            addLoanArchive.EXT_PRUDENT_GUIDELINE_STATUSID = (int)model.externalPrudentialGuidelineStatusId;
            addLoanArchive.USER_PRUDENTIAL_GUIDE_STATUSID = (int)model.userPrudentialGuidelineStatusId;
            addLoanArchive.NPLDATE = model.nplDate;
            addLoanArchive.CREATEDBY = model.createdBy;
            addLoanArchive.DATETIMECREATED = model.dateTimeCreated;
            addLoanArchive.ARCHIVEBATCHCODE = archiveBatchCode;

            //loanArchive.Add(addLoanArchive);

            //context.TBL_LOAN_ARCHIVE.AddRange(loanArchive);

            context.TBL_LOAN_ARCHIVE.Add(addLoanArchive);

            context.SaveChanges();
            return model;
        }


        public LoanViewModel ArchiveLoan(int loanId, int operationId, string archiveBatchCode, string changeReason = "Rephasement")
        {
            var systemDate = generalSetup.GetApplicationDate();
            var model = (from a in context.TBL_LOAN
                         where a.TERMLOANID == loanId
                         //&& a.LOANSTATUSID == (short)LoanStatusEnum.Active
                         select new LoanViewModel()
                         {
                             loanId = a.TERMLOANID,
                             productPriceIndexRate = (double)a.PRODUCTPRICEINDEXRATE,
                             customerRiskRatingId = a.CUSTOMERRISKRATINGID,
                             loanSystemTypeId = (short)a.LOANSYSTEMTYPEID,
                             customerId = a.CUSTOMERID,
                             productId = a.PRODUCTID,
                             companyId = a.COMPANYID,
                             casaAccountId = a.CASAACCOUNTID,
                             branchId = a.BRANCHID,
                             currencyId = a.CURRENCYID,
                             exchangeRate = a.EXCHANGERATE,
                             loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                             loanReferenceNumber = a.LOANREFERENCENUMBER,
                             subSectorId = a.SUBSECTORID,
                             principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID,
                             interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID,
                             principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                             interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                             relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                             relationshipManagerId = a.RELATIONSHIPMANAGERID,
                             misCode = a.MISCODE,
                             teamMiscode = a.TEAMMISCODE,
                             interestRate = a.INTERESTRATE,
                             effectiveDate = a.EFFECTIVEDATE,
                             lastRestructureDate = (DateTime)a.LASTRESTRUCTUREDATE,
                             maturityDate = a.MATURITYDATE,
                             bookingDate = a.BOOKINGDATE,
                             principalAmount = a.PRINCIPALAMOUNT,
                             principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                             interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                             approvalStatusId = a.APPROVALSTATUSID,
                             approvedBy = a.APPROVEDBY,
                             approverComment = a.APPROVERCOMMENT,
                             dateApproved = a.DATEAPPROVED,
                             loanStatusId = a.LOANSTATUSID,
                             scheduleTypeId = a.SCHEDULETYPEID,
                             scheduleDayCountConventionId = a.SCHEDULEDAYCOUNTCONVENTIONID,
                             scheduleDayInterestTypeId = a.SCHEDULEDAYINTERESTTYPEID,
                             isDisbursed = a.ISDISBURSED,
                             disbursedBy = a.DISBURSEDBY,
                             disburserComment = a.DISBURSERCOMMENT,
                             disburseDate = a.DISBURSEDATE,
                             operationId = a.OPERATIONID,
                             customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                             loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                             equityContribution = a.EQUITYCONTRIBUTION,
                             firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                             firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                             outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                             outstandingInterest = a.OUTSTANDINGINTEREST,
                             pastDuePrincipal = a.PASTDUEPRINCIPAL,
                             pastDueInterest = a.PASTDUEINTEREST,
                             interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                             interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                             penalChargeAmount = a.PENALCHARGEAMOUNT,
                             principalAdditionCount = a.PRINCIPALADDITIONCOUNT,
                             principalReductionCount = a.PRINCIPALREDUCTIONCOUNT,
                             fixedPrincipal = a.FIXEDPRINCIPAL,
                             profileLoan = a.PROFILELOAN,
                             dischargeLetter = a.DISCHARGELETTER,
                             suspendInterest = a.SUSPENDINTEREST,
                             isScheduledPrepayment = a.ISSCHEDULEDPREPAYMENT,
                             allowForceDebitRepayment = a.ALLOWFORCEDEBITREPAYMENT,
                             scheduledPrepaymentAmount = a.SCHEDULEDPREPAYMENTAMOUNT,
                             scheduledPrepaymentDate = a.SCHEDULEDPREPAYMENTDATE,
                             scheduledPrepaymentFrequencyTypeId = a.SCH_PREPAYMENT_FREQUENCY_TYPID,
                             internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                             externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                             userPrudentialGuidelineStatusId = a.USER_PRUDENTIAL_GUIDE_STATUSID,
                             nplDate = a.NPLDATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,

                         }).FirstOrDefault();

            List<TBL_LOAN_ARCHIVE> loanArchive = new List<TBL_LOAN_ARCHIVE>();

            TBL_LOAN_ARCHIVE addLoanArchive = new TBL_LOAN_ARCHIVE();


            addLoanArchive.CHANGEEFFECTIVEDATE = systemDate;
            addLoanArchive.ISAPPLIED = false;
            addLoanArchive.CHANGEREASON = changeReason; //"Rephasement";
            addLoanArchive.LOANID = model.loanId;
            addLoanArchive.PRODUCTPRICEINDEXRATE = model.productPriceIndexRate;
            addLoanArchive.CUSTOMERRISKRATINGID = model.customerRiskRatingId;
            addLoanArchive.LOANSYSTEMTYPEID = model.loanSystemTypeId;
            addLoanArchive.CUSTOMERID = model.customerId;
            addLoanArchive.PRODUCTID = model.productId;
            addLoanArchive.COMPANYID = model.companyId;
            addLoanArchive.CASAACCOUNTID = model.casaAccountId;
            addLoanArchive.BRANCHID = model.branchId;
            addLoanArchive.CURRENCYID = (short)model.currencyId;
            addLoanArchive.EXCHANGERATE = model.exchangeRate;
            addLoanArchive.LOANAPPLICATIONDETAILID = model.loanApplicationDetailId;
            addLoanArchive.LOANREFERENCENUMBER = model.loanReferenceNumber;
            addLoanArchive.SUBSECTORID = model.subSectorId;
            addLoanArchive.PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId;
            addLoanArchive.INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId;
            addLoanArchive.PRINCIPALNUMBEROFINSTALLMENT = model.principalNumberOfInstallment;
            addLoanArchive.INTERESTNUMBEROFINSTALLMENT = model.interestNumberOfInstallment;
            addLoanArchive.RELATIONSHIPOFFICERID = model.relationshipOfficerId;
            addLoanArchive.RELATIONSHIPMANAGERID = model.relationshipManagerId;
            addLoanArchive.MISCODE = model.misCode;
            addLoanArchive.TEAMMISCODE = model.teamMiscode;
            addLoanArchive.INTERESTRATE = model.interestRate;
            addLoanArchive.EFFECTIVEDATE = model.effectiveDate;
            addLoanArchive.LASTRESTRUCTUREDATE = model.lastRestructureDate;
            addLoanArchive.MATURITYDATE = model.maturityDate;
            addLoanArchive.BOOKINGDATE = model.bookingDate;
            addLoanArchive.PRINCIPALAMOUNT = model.principalAmount;
            addLoanArchive.PRINCIPALINSTALLMENTLEFT = model.principalInstallmentLeft;
            addLoanArchive.INTERESTINSTALLMENTLEFT = model.interestInstallmentLeft;
            addLoanArchive.APPROVALSTATUSID = model.approvalStatusId;
            addLoanArchive.APPROVEDBY = model.approvedBy;
            addLoanArchive.APPROVERCOMMENT = model.approverComment;
            addLoanArchive.DATEAPPROVED = model.dateApproved;
            addLoanArchive.LOANSTATUSID = model.loanStatusId;
            addLoanArchive.CREATEDBY = model.createdBy;
            addLoanArchive.DATETIMECREATED = model.dateTimeCreated;
            addLoanArchive.SCHEDULETYPEID = model.scheduleTypeId;
            addLoanArchive.SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountConventionId;
            addLoanArchive.SCHEDULEDAYINTERESTTYPEID = model.scheduleDayInterestTypeId;
            addLoanArchive.ISDISBURSED = model.isDisbursed;
            addLoanArchive.DISBURSEDBY = model.disbursedBy;
            addLoanArchive.DISBURSERCOMMENT = model.disburserComment;
            addLoanArchive.DISBURSEDATE = model.disburseDate;
            addLoanArchive.OPERATIONID = operationId;
            addLoanArchive.EQUITYCONTRIBUTION = model.equityContribution;
            addLoanArchive.FIRSTPRINCIPALPAYMENTDATE = model.firstPrincipalPaymentDate;
            addLoanArchive.FIRSTINTERESTPAYMENTDATE = model.firstInterestPaymentDate;
            addLoanArchive.OUTSTANDINGPRINCIPAL = model.outstandingPrincipal;
            addLoanArchive.OUTSTANDINGINTEREST = model.outstandingInterest;
            addLoanArchive.PASTDUEPRINCIPAL = model.pastDuePrincipal;
            addLoanArchive.PASTDUEINTEREST = model.pastDueInterest;
            addLoanArchive.INTERESTONPASTDUEPRINCIPAL = model.interestOnPastDuePrincipal;
            addLoanArchive.INTERESTONPASTDUEINTEREST = model.interesrtOnPastDueInterest;
            addLoanArchive.PENALCHARGEAMOUNT = model.penalChargeAmount;
            addLoanArchive.PRINCIPALADDITIONCOUNT = model.principalAdditionCount;
            addLoanArchive.PRINCIPALREDUCTIONCOUNT = model.principalReductionCount;
            addLoanArchive.FIXEDPRINCIPAL = model.fixedPrincipal;
            addLoanArchive.PROFILELOAN = model.profileLoan;
            addLoanArchive.DISCHARGELETTER = model.dischargeLetter;
            addLoanArchive.SUSPENDINTEREST = model.suspendInterest;
            addLoanArchive.ISSCHEDULEDPREPAYMENT = model.isScheduledPrepayment;
            addLoanArchive.ALLOWFORCEDEBITREPAYMENT = model.allowForceDebitRepayment;
            addLoanArchive.SCHEDULEDPREPAYMENTAMOUNT = model.scheduledPrepaymentAmount;
            addLoanArchive.SCHEDULEDPREPAYMENTDATE = model.scheduledPrepaymentDate;
            addLoanArchive.SCH_PREPAYMENT_FREQUENCY_TYPID = model.principalFrequencyTypeId;//scheduledPrepaymentFrequencyTypeId;
            addLoanArchive.INT_PRUDENT_GUIDELINE_STATUSID = (int)model.internalPrudentialGuidelineStatusId;
            addLoanArchive.EXT_PRUDENT_GUIDELINE_STATUSID = (int)model.externalPrudentialGuidelineStatusId;
            addLoanArchive.USER_PRUDENTIAL_GUIDE_STATUSID = (int)model.userPrudentialGuidelineStatusId;
            addLoanArchive.NPLDATE = model.nplDate;
            addLoanArchive.CREATEDBY = model.createdBy;
            addLoanArchive.DATETIMECREATED = model.dateTimeCreated;
            addLoanArchive.ARCHIVEBATCHCODE = archiveBatchCode;

            //loanArchive.Add(addLoanArchive);

            //this.context.TBL_LOAN_ARCHIVE.AddRange(loanArchive);

            this.context.TBL_LOAN_ARCHIVE.Add(addLoanArchive);

            context.SaveChanges();
            return model;
        }

        public RevolvingLoanViewModel ArchiveOverDraft(int overDraftId, string archiveBatchCode)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var model = (from a in context.TBL_LOAN_REVOLVING
                         where a.REVOLVINGLOANID == overDraftId && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                         select new RevolvingLoanViewModel()
                         {
                             loanId = a.REVOLVINGLOANID,
                             loanSystemTypeId = (short)a.LOANSYSTEMTYPEID,
                             customerId = a.CUSTOMERID,
                             productId = a.PRODUCTID,
                             companyId = a.COMPANYID,
                             casaAccountId = a.CASAACCOUNTID,
                             branchId = a.BRANCHID,
                             currencyId = a.CURRENCYID,
                             loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                             exchangeRate = a.EXCHANGERATE,
                             loanReferenceNumber = a.LOANREFERENCENUMBER,
                             relatedLoanReferenceNumber = a.RELATED_LOAN_REFERENCE_NUMBER,
                             subSectorId = a.SUBSECTORID,
                             relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                             relationshipManagerId = a.RELATIONSHIPMANAGERID,
                             misCode = a.MISCODE,
                             teamMiscode = a.TEAMMISCODE,
                             interestRate = a.INTERESTRATE,
                             effectiveDate = a.EFFECTIVEDATE,
                             maturityDate = a.MATURITYDATE,
                             bookingDate = a.BOOKINGDATE,
                             overdraftLimit = a.OVERDRAFTLIMIT,
                             pastDuePrincipal = a.PASTDUEPRINCIPAL,
                             pastDueInterest = a.PASTDUEINTEREST,
                             interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                             interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                             penalChargeAmount = a.PENALCHARGEAMOUNT,
                             approvalStatusId = a.APPROVALSTATUSID,
                             approvedBy = (int)a.APPROVEDBY,
                             approverComment = a.APPROVERCOMMENT,
                             dateApproved = a.DATEAPPROVED,
                             loanStatusId = a.LOANSTATUSID,
                             isDisbursed = a.ISDISBURSED,
                             disbursedBy = a.DISBURSEDBY,
                             disburserComment = a.DISBURSERCOMMENT,
                             disburseDate = a.DISBURSEDATE,
                             operationId = a.OPERATIONID,
                             dischargeLetter = a.DISCHARGELETTER,
                             suspendInterest = a.SUSPENDINTEREST,
                             dayCountConventionId = a.DAYCOUNTCONVENTIONID,
                             internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                             externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                             userPrudentialGuidelineStatusId = a.USER_PRUDENTIAL_GUIDE_STATUSID,
                             nplDate = a.NPLDATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,
                             revolvingTypeId = a.REVOLVINGTYPEID,

                         }).FirstOrDefault();

            List<TBL_LOAN_REVOLVING_ARCHIVE> overDraftArchive = new List<TBL_LOAN_REVOLVING_ARCHIVE>();

            TBL_LOAN_REVOLVING_ARCHIVE addOverDraftArchive = new TBL_LOAN_REVOLVING_ARCHIVE();


            addOverDraftArchive.ARCHIVEDATE = systemDate;
            addOverDraftArchive.REVOLVINGLOANID = model.loanId;
            addOverDraftArchive.CUSTOMERID = model.customerId;
            addOverDraftArchive.LOANSYSTEMTYPEID = model.loanSystemTypeId;
            addOverDraftArchive.PRODUCTID = model.productId;
            addOverDraftArchive.COMPANYID = model.companyId;
            addOverDraftArchive.CASAACCOUNTID = model.casaAccountId;
            addOverDraftArchive.BRANCHID = model.branchId;
            addOverDraftArchive.CURRENCYID = model.currencyId;
            addOverDraftArchive.LOANAPPLICATIONDETAILID = model.loanApplicationDetailId;
            addOverDraftArchive.EXCHANGERATE = model.exchangeRate;
            addOverDraftArchive.LOANREFERENCENUMBER = model.loanReferenceNumber;
            addOverDraftArchive.RELATED_LOAN_REFERENCE_NUMBER = model.relatedLoanReferenceNumber;
            addOverDraftArchive.SUBSECTORID = model.subSectorId;
            addOverDraftArchive.RELATIONSHIPOFFICERID = model.relationshipOfficerId;
            addOverDraftArchive.RELATIONSHIPMANAGERID = model.relationshipManagerId;
            addOverDraftArchive.MISCODE = model.misCode;
            addOverDraftArchive.TEAMMISCODE = model.teamMiscode;
            addOverDraftArchive.INTERESTRATE = model.interestRate;
            addOverDraftArchive.EFFECTIVEDATE = model.effectiveDate;
            addOverDraftArchive.MATURITYDATE = model.maturityDate;
            addOverDraftArchive.BOOKINGDATE = model.bookingDate;
            addOverDraftArchive.OVERDRAFTLIMIT = model.overdraftLimit;
            addOverDraftArchive.APPROVALSTATUSID = model.approvalStatusId;
            addOverDraftArchive.APPROVEDBY = model.approvedBy;
            addOverDraftArchive.APPROVERCOMMENT = model.approverComment;
            addOverDraftArchive.DATEAPPROVED = model.dateApproved;
            addOverDraftArchive.LOANSTATUSID = model.loanStatusId;
            addOverDraftArchive.ISDISBURSED = model.isDisbursed;
            addOverDraftArchive.DISBURSEDBY = model.disbursedBy;
            addOverDraftArchive.DISBURSERCOMMENT = model.disburserComment;
            addOverDraftArchive.DISBURSEDATE = model.disburseDate;
            addOverDraftArchive.OPERATIONID = model.operationId;
            addOverDraftArchive.CREATEDBY = model.createdBy;
            addOverDraftArchive.DATETIMECREATED = model.dateTimeCreated;
            addOverDraftArchive.DISCHARGELETTER = model.dischargeLetter;
            addOverDraftArchive.SUSPENDINTEREST = model.suspendInterest;
            addOverDraftArchive.DAYCOUNTCONVENTIONID = (short)model.dayCountConventionId;
            addOverDraftArchive.INT_PRUDENT_GUIDELINE_STATUSID = (int)model.internalPrudentialGuidelineStatusId;
            addOverDraftArchive.EXT_PRUDENT_GUIDELINE_STATUSID = (int)model.externalPrudentialGuidelineStatusId;
            addOverDraftArchive.USER_PRUDENTIAL_GUIDE_STATUSID = (int)model.userPrudentialGuidelineStatusId;
            addOverDraftArchive.NPLDATE = model.nplDate;
            addOverDraftArchive.CREATEDBY = model.createdBy;
            addOverDraftArchive.DATETIMECREATED = model.dateTimeCreated;
            addOverDraftArchive.REVOLVINGTYPEID = model.revolvingTypeId;
            addOverDraftArchive.ARCHIVEBATCHCODE = archiveBatchCode;

            overDraftArchive.Add(addOverDraftArchive);
            this.context.TBL_LOAN_REVOLVING_ARCHIVE.AddRange(overDraftArchive);

            context.SaveChanges();
            return model;
        }

        public IEnumerable<LoanPaymentSchedulePeriodicViewModel> ArchivePeriodicSchedule(int loanId, string archiveBatchCode)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var model = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
                         where a.LOANID == loanId
                         select new LoanPaymentSchedulePeriodicViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             paymentDate = a.PAYMENTDATE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             periodPaymentAmount = (double)a.PERIODPAYMENTAMOUNT,
                             periodInterestAmount = (double)a.PERIODINTERESTAMOUNT,
                             periodPrincipalAmount = (double)a.PERIODPRINCIPALAMOUNT,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             interestRate = a.INTERESTRATE,
                             amortisedStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amortisedPeriodPaymentAmount = (double)a.AMORTISEDPERIODPAYMENTAMOUNT,
                             amortisedPeriodInterestAmount = (double)a.AMORTISEDPERIODINTERESTAMOUNT,
                             amortisedPeriodPrincipalAmount = (double)a.AMORTISEDPERIODPRINCIPALAMOUNT,
                             amortisedEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,

                         }).ToList();

            List<TBL_LOAN_SCHEDULE_PERIODIC_ARC> loanSchedulePeriodicArchive = new List<TBL_LOAN_SCHEDULE_PERIODIC_ARC>();



            foreach (var item in model)
            {

                TBL_LOAN_SCHEDULE_PERIODIC_ARC addLoanSchedulePeriodicArchive = new TBL_LOAN_SCHEDULE_PERIODIC_ARC();


                addLoanSchedulePeriodicArchive.LOANID = item.loanId;
                addLoanSchedulePeriodicArchive.ARCHIVEDATE = systemDate;
                addLoanSchedulePeriodicArchive.PAYMENTNUMBER = item.paymentNumber;
                addLoanSchedulePeriodicArchive.PAYMENTDATE = item.paymentDate;
                addLoanSchedulePeriodicArchive.STARTPRINCIPALAMOUNT = (decimal)item.startPrincipalAmount;
                addLoanSchedulePeriodicArchive.PERIODPAYMENTAMOUNT = (decimal)item.periodPaymentAmount;
                addLoanSchedulePeriodicArchive.PERIODINTERESTAMOUNT = (decimal)item.periodInterestAmount;
                addLoanSchedulePeriodicArchive.PERIODPRINCIPALAMOUNT = (decimal)item.periodPrincipalAmount;
                addLoanSchedulePeriodicArchive.ENDPRINCIPALAMOUNT = (decimal)item.endPrincipalAmount;
                addLoanSchedulePeriodicArchive.INTERESTRATE = item.interestRate;
                addLoanSchedulePeriodicArchive.AMORTISEDSTARTPRINCIPALAMOUNT = (decimal)item.amortisedStartPrincipalAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDPERIODPAYMENTAMOUNT = (decimal)item.amortisedPeriodPaymentAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDPERIODINTERESTAMOUNT = (decimal)item.amortisedPeriodInterestAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDPERIODPRINCIPALAMOUNT = (decimal)item.amortisedPeriodPrincipalAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDENDPRINCIPALAMOUNT = (decimal)item.amortisedEndPrincipalAmount;
                addLoanSchedulePeriodicArchive.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanSchedulePeriodicArchive.CREATEDBY = item.createdBy;
                addLoanSchedulePeriodicArchive.DATETIMECREATED = item.dateTimeCreated;
                addLoanSchedulePeriodicArchive.ARCHIVEBATCHCODE = archiveBatchCode;

                loanSchedulePeriodicArchive.Add(addLoanSchedulePeriodicArchive);

            }

            this.context.TBL_LOAN_SCHEDULE_PERIODIC_ARC.AddRange(loanSchedulePeriodicArchive);

            context.SaveChanges();
            return model;
        }


        public IEnumerable<LoanPaymentScheduleDailyViewModel> MergeDailySchedule(int loanId, DateTime applicationDate)
        {

            var systemDate = generalSetup.GetApplicationDate();
            int no = 0;//number.Count() - 1;

            var model = (from a in context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV
                         where a.LOANID == loanId && a.ARCHIVEDATE == DbFunctions.TruncateTime(systemDate)
                         && a.DATE < DbFunctions.TruncateTime(applicationDate)
                         orderby a.PAYMENTNUMBER ascending
                         select new LoanPaymentScheduleDailyViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             date = a.DATE,
                             paymentDate = a.PAYMENTDATE,
                             openingBalance = (double)a.OPENINGBALANCE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             dailyPaymentAmount = (double)a.DAILYPAYMENTAMOUNT,
                             dailyInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                             dailyPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                             closingBalance = (double)a.CLOSINGBALANCE,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             amortisedCost = (double)a.AMORTISEDCOST,
                             accruedInterest = (double)a.ACCRUEDINTEREST,
                             norminalInterestRate = a.INTERESTRATE,

                             amOpeningBalance = (double)a.AMORTISEDOPENINGBALANCE,
                             amStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amDailyPaymentAmount = (double)a.AMORTISEDDAILYPAYMENTAMOUNT,
                             amDailyInterestAmount = (double)a.AMORTISEDDAILYINTERESTAMOUNT,
                             amDailyPrincipalAmount = (double)a.AMORTISEDDAILYPRINCIPALAMOUNT,
                             amClosingBalance = (double)a.AMORTISEDCLOSINGBALANCE,
                             amEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             amAccruedInterest = (double)a.AMORTISEDACCRUEDINTEREST,
                             amAmortisedCost = (double)a.AMORTISED_AMORTISEDCOST,
                             discountPremium = (double)a.DISCOUNTPREMIUM,
                             unEarnedFee = (double)a.UNEARNEDFEE,
                             earnedFee = (double)a.EARNEDFEE,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             numberOfPeriods = a.NUMBEROFPERIODS,
                             ballonAmount = (double)a.BALLONAMOUNT,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,
                         }).Concat
                         (from a in context.TBL_LOAN_SCHEDULE_DAILY_TEMP
                          where a.LOANID == loanId && a.DATE >= DbFunctions.TruncateTime(applicationDate)
                          orderby a.PAYMENTNUMBER ascending
                          select new LoanPaymentScheduleDailyViewModel()
                          {
                              loanId = a.LOANID,
                              paymentNumber = a.PAYMENTNUMBER,
                              date = a.DATE,
                              paymentDate = a.PAYMENTDATE,
                              openingBalance = (double)a.OPENINGBALANCE,
                              startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                              dailyPaymentAmount = (double)a.DAILYPAYMENTAMOUNT,
                              dailyInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                              dailyPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                              closingBalance = (double)a.CLOSINGBALANCE,
                              endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                              amortisedCost = (double)a.AMORTISEDCOST,
                              accruedInterest = (double)a.ACCRUEDINTEREST,
                              norminalInterestRate = a.INTERESTRATE,
                              amOpeningBalance = (double)a.AMORTISEDOPENINGBALANCE,
                              amStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                              amDailyPaymentAmount = (double)a.AMORTISEDDAILYPAYMENTAMOUNT,
                              amDailyInterestAmount = (double)a.AMORTISEDDAILYINTERESTAMOUNT,
                              amDailyPrincipalAmount = (double)a.AMORTISEDDAILYPRINCIPALAMOUNT,
                              amClosingBalance = (double)a.AMORTISEDCLOSINGBALANCE,
                              amEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                              amAccruedInterest = (double)a.AMORTISEDACCRUEDINTEREST,
                              amAmortisedCost = (double)a.AMORTISED_AMORTISEDCOST,
                              discountPremium = (double)a.DISCOUNTPREMIUM,
                              unEarnedFee = (double)a.UNEARNEDFEE,
                              earnedFee = (double)a.EARNEDFEE,
                              effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                              numberOfPeriods = a.NUMBEROFPERIODS,
                              ballonAmount = (double)a.BALLONAMOUNT,
                              createdBy = a.CREATEDBY,
                              dateTimeCreated = a.DATETIMECREATED,
                          }).ToList();

            List<TBL_LOAN_SCHEDULE_DAILY> loanScheduleDaily = new List<TBL_LOAN_SCHEDULE_DAILY>();


            foreach (var item in model)
            {
                TBL_LOAN_SCHEDULE_DAILY addLoanScheduleDaily = new TBL_LOAN_SCHEDULE_DAILY();

                addLoanScheduleDaily.LOANID = loanId;
                addLoanScheduleDaily.PAYMENTNUMBER = ++no - 1;
                addLoanScheduleDaily.DATE = item.date;
                addLoanScheduleDaily.PAYMENTDATE = item.paymentDate;
                addLoanScheduleDaily.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                addLoanScheduleDaily.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                addLoanScheduleDaily.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                addLoanScheduleDaily.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                addLoanScheduleDaily.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                addLoanScheduleDaily.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                addLoanScheduleDaily.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                addLoanScheduleDaily.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                addLoanScheduleDaily.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                addLoanScheduleDaily.INTERESTRATE = item.norminalInterestRate;
                addLoanScheduleDaily.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                addLoanScheduleDaily.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                addLoanScheduleDaily.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                addLoanScheduleDaily.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                addLoanScheduleDaily.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                addLoanScheduleDaily.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                addLoanScheduleDaily.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                addLoanScheduleDaily.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                addLoanScheduleDaily.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                addLoanScheduleDaily.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                addLoanScheduleDaily.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                addLoanScheduleDaily.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                addLoanScheduleDaily.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanScheduleDaily.NUMBEROFPERIODS = item.numberOfPeriods;
                addLoanScheduleDaily.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                addLoanScheduleDaily.CREATEDBY = item.createdBy;
                addLoanScheduleDaily.DATETIMECREATED = item.dateTimeCreated;

                loanScheduleDaily.Add(addLoanScheduleDaily);

            }

            var itemToRemove = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                                where p.LOANID == loanId
                                select p);

            if (itemToRemove != null)
            {
                context.TBL_LOAN_SCHEDULE_DAILY.RemoveRange(itemToRemove);
                context.SaveChanges();
            }

            this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(loanScheduleDaily);




            context.SaveChanges();
            return model;
        }


        public IEnumerable<LoanPaymentScheduleDailyViewModel> ArchiveDailySchedule(int loanId, string archiveBatchCode)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var model = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                         where a.LOANID == loanId
                         select new LoanPaymentScheduleDailyViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             date = a.DATE,
                             paymentDate = a.PAYMENTDATE,
                             openingBalance = (double)a.OPENINGBALANCE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             dailyPaymentAmount = (double)a.DAILYPAYMENTAMOUNT,
                             dailyInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                             dailyPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                             closingBalance = (double)a.CLOSINGBALANCE,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             amortisedCost = (double)a.AMORTISEDCOST,
                             accruedInterest = (double)a.ACCRUEDINTEREST,
                             norminalInterestRate = a.INTERESTRATE,
                             amOpeningBalance = (double)a.AMORTISEDOPENINGBALANCE,
                             amStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amDailyPaymentAmount = (double)a.AMORTISEDDAILYPAYMENTAMOUNT,
                             amDailyInterestAmount = (double)a.AMORTISEDDAILYINTERESTAMOUNT,
                             amDailyPrincipalAmount = (double)a.AMORTISEDDAILYPRINCIPALAMOUNT,
                             amClosingBalance = (double)a.AMORTISEDCLOSINGBALANCE,
                             amEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             amAccruedInterest = (double)a.AMORTISEDACCRUEDINTEREST,
                             amAmortisedCost = (double)a.AMORTISED_AMORTISEDCOST,
                             discountPremium = (double)a.DISCOUNTPREMIUM,
                             unEarnedFee = (double)a.UNEARNEDFEE,
                             earnedFee = (double)a.EARNEDFEE,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             numberOfPeriods = a.NUMBEROFPERIODS,
                             ballonAmount = (double)a.BALLONAMOUNT,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,

                         }).ToList();

            List<TBL_LOAN_SCHEDULE_DAILY_ARCHIV> loanScheduleDailyArchive = new List<TBL_LOAN_SCHEDULE_DAILY_ARCHIV>();

            foreach (var item in model)
            {
                TBL_LOAN_SCHEDULE_DAILY_ARCHIV addLoanScheduleDailyArchive = new TBL_LOAN_SCHEDULE_DAILY_ARCHIV();

                addLoanScheduleDailyArchive.LOANID = loanId;
                addLoanScheduleDailyArchive.ARCHIVEDATE = systemDate;
                addLoanScheduleDailyArchive.PAYMENTNUMBER = item.paymentNumber;
                addLoanScheduleDailyArchive.DATE = item.date;
                addLoanScheduleDailyArchive.PAYMENTDATE = item.paymentDate;
                addLoanScheduleDailyArchive.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                addLoanScheduleDailyArchive.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                addLoanScheduleDailyArchive.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                addLoanScheduleDailyArchive.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                addLoanScheduleDailyArchive.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                addLoanScheduleDailyArchive.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                addLoanScheduleDailyArchive.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                addLoanScheduleDailyArchive.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                addLoanScheduleDailyArchive.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                addLoanScheduleDailyArchive.INTERESTRATE = item.norminalInterestRate;
                addLoanScheduleDailyArchive.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                addLoanScheduleDailyArchive.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                addLoanScheduleDailyArchive.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                addLoanScheduleDailyArchive.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                addLoanScheduleDailyArchive.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                addLoanScheduleDailyArchive.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                addLoanScheduleDailyArchive.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                addLoanScheduleDailyArchive.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                addLoanScheduleDailyArchive.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                addLoanScheduleDailyArchive.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                addLoanScheduleDailyArchive.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                addLoanScheduleDailyArchive.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                addLoanScheduleDailyArchive.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanScheduleDailyArchive.NUMBEROFPERIODS = item.numberOfPeriods;
                addLoanScheduleDailyArchive.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                addLoanScheduleDailyArchive.CREATEDBY = item.createdBy;
                addLoanScheduleDailyArchive.DATETIMECREATED = item.dateTimeCreated;
                addLoanScheduleDailyArchive.ARCHIVEDATE = generalSetup.GetApplicationDate();
                addLoanScheduleDailyArchive.ARCHIVEBATCHCODE = archiveBatchCode;

                loanScheduleDailyArchive.Add(addLoanScheduleDailyArchive);

            }

            this.context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV.AddRange(loanScheduleDailyArchive);

            context.SaveChanges();
            return model;
        }

        public IEnumerable<LoanPaymentSchedulePeriodicViewModel> MergePeriodicSchedule(int loanId, DateTime applicationDate)
        {

            var systemDate = generalSetup.GetApplicationDate();
            int no = 0;//number.Count() - 1;

            var model = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC_ARC
                         where a.LOANID == loanId && a.ARCHIVEDATE == DbFunctions.TruncateTime(systemDate)
                         && a.PAYMENTDATE < DbFunctions.TruncateTime(applicationDate)
                         orderby a.PAYMENTNUMBER ascending
                         select new LoanPaymentSchedulePeriodicViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             paymentDate = a.PAYMENTDATE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             periodPaymentAmount = (double)a.PERIODPAYMENTAMOUNT,
                             periodInterestAmount = (double)a.PERIODINTERESTAMOUNT,
                             periodPrincipalAmount = (double)a.PERIODPRINCIPALAMOUNT,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             interestRate = a.INTERESTRATE,
                             amortisedStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amortisedPeriodPaymentAmount = (double)a.AMORTISEDPERIODPAYMENTAMOUNT,
                             amortisedPeriodInterestAmount = (double)a.AMORTISEDPERIODINTERESTAMOUNT,
                             amortisedPeriodPrincipalAmount = (double)a.AMORTISEDPERIODPRINCIPALAMOUNT,
                             amortisedEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,
                         }).Concat
                         (from a in context.TBL_LOAN_SCHEDULE_PERIODIC_TMP
                          where a.LOANID == loanId && a.PAYMENTDATE >= DbFunctions.TruncateTime(applicationDate)
                          && a.PAYMENTNUMBER != 0
                          orderby a.PAYMENTNUMBER ascending
                          select new LoanPaymentSchedulePeriodicViewModel()
                          {
                              loanId = a.LOANID,
                              paymentNumber = a.PAYMENTNUMBER,//lastNo + 1,
                              paymentDate = a.PAYMENTDATE,
                              startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                              periodPaymentAmount = (double)a.PERIODPAYMENTAMOUNT,
                              periodInterestAmount = (double)a.PERIODINTERESTAMOUNT,
                              periodPrincipalAmount = (double)a.PERIODPRINCIPALAMOUNT,
                              endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                              interestRate = a.INTERESTRATE,
                              amortisedStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                              amortisedPeriodPaymentAmount = (double)a.AMORTISEDPERIODPAYMENTAMOUNT,
                              amortisedPeriodInterestAmount = (double)a.AMORTISEDPERIODINTERESTAMOUNT,
                              amortisedPeriodPrincipalAmount = (double)a.AMORTISEDPERIODPRINCIPALAMOUNT,
                              amortisedEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                              effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                              createdBy = a.CREATEDBY,
                              dateTimeCreated = a.DATETIMECREATED,
                          }).ToList();

            List<TBL_LOAN_SCHEDULE_PERIODIC> loanSchedulePeriodic = new List<TBL_LOAN_SCHEDULE_PERIODIC>();


            foreach (var item in model)
            {
                TBL_LOAN_SCHEDULE_PERIODIC addLoanSchedulePeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


                addLoanSchedulePeriodic.LOANID = item.loanId;
                addLoanSchedulePeriodic.PAYMENTNUMBER = ++no - 1;//item.paymentNumber;
                addLoanSchedulePeriodic.PAYMENTDATE = item.paymentDate;
                addLoanSchedulePeriodic.STARTPRINCIPALAMOUNT = (decimal)item.startPrincipalAmount;
                addLoanSchedulePeriodic.PERIODPAYMENTAMOUNT = (decimal)item.periodPaymentAmount;
                addLoanSchedulePeriodic.PERIODINTERESTAMOUNT = (decimal)item.periodInterestAmount;
                addLoanSchedulePeriodic.PERIODPRINCIPALAMOUNT = (decimal)item.periodPrincipalAmount;
                addLoanSchedulePeriodic.ENDPRINCIPALAMOUNT = (decimal)item.endPrincipalAmount;
                addLoanSchedulePeriodic.INTERESTRATE = item.interestRate;
                addLoanSchedulePeriodic.AMORTISEDSTARTPRINCIPALAMOUNT = (decimal)item.amortisedStartPrincipalAmount;
                addLoanSchedulePeriodic.AMORTISEDPERIODPAYMENTAMOUNT = (decimal)item.amortisedPeriodPaymentAmount;
                addLoanSchedulePeriodic.AMORTISEDPERIODINTERESTAMOUNT = (decimal)item.amortisedPeriodInterestAmount;
                addLoanSchedulePeriodic.AMORTISEDPERIODPRINCIPALAMOUNT = (decimal)item.amortisedPeriodPrincipalAmount;
                addLoanSchedulePeriodic.AMORTISEDENDPRINCIPALAMOUNT = (decimal)item.amortisedEndPrincipalAmount;
                addLoanSchedulePeriodic.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanSchedulePeriodic.CREATEDBY = item.createdBy;
                addLoanSchedulePeriodic.DATETIMECREATED = item.dateTimeCreated;


                loanSchedulePeriodic.Add(addLoanSchedulePeriodic);

            }


            var itemToRemove = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                                where p.LOANID == loanId
                                select p);
            if (itemToRemove != null)
            {
                context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemove);
                context.SaveChanges();
            }

            this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(loanSchedulePeriodic);

            context.SaveChanges();
            return model;
        }

        public IEnumerable<LoanPaymentSchedulePeriodicViewModel> UpdatePeriodicSchedule(int loanId, DateTime applicationDate)
        {

            var systemDate = generalSetup.GetApplicationDate();
            int no = 0;//number.Count() - 1;

            var model = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC_TMP
                         where a.LOANID == loanId
                         orderby a.PAYMENTNUMBER ascending
                         select new LoanPaymentSchedulePeriodicViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,//lastNo + 1,
                             paymentDate = a.PAYMENTDATE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             periodPaymentAmount = (double)a.PERIODPAYMENTAMOUNT,
                             periodInterestAmount = (double)a.PERIODINTERESTAMOUNT,
                             periodPrincipalAmount = (double)a.PERIODPRINCIPALAMOUNT,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             interestRate = a.INTERESTRATE,
                             amortisedStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amortisedPeriodPaymentAmount = (double)a.AMORTISEDPERIODPAYMENTAMOUNT,
                             amortisedPeriodInterestAmount = (double)a.AMORTISEDPERIODINTERESTAMOUNT,
                             amortisedPeriodPrincipalAmount = (double)a.AMORTISEDPERIODPRINCIPALAMOUNT,
                             amortisedEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,
                         }).ToList();

            List<TBL_LOAN_SCHEDULE_PERIODIC> loanSchedulePeriodic = new List<TBL_LOAN_SCHEDULE_PERIODIC>();



            foreach (var item in model)
            {
                TBL_LOAN_SCHEDULE_PERIODIC addLoanSchedulePeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();


                addLoanSchedulePeriodic.LOANID = item.loanId;
                addLoanSchedulePeriodic.PAYMENTNUMBER = ++no - 1;//item.paymentNumber;
                addLoanSchedulePeriodic.PAYMENTDATE = item.paymentDate;
                addLoanSchedulePeriodic.STARTPRINCIPALAMOUNT = (decimal)item.startPrincipalAmount;
                addLoanSchedulePeriodic.PERIODPAYMENTAMOUNT = (decimal)item.periodPaymentAmount;
                addLoanSchedulePeriodic.PERIODINTERESTAMOUNT = (decimal)item.periodInterestAmount;
                addLoanSchedulePeriodic.PERIODPRINCIPALAMOUNT = (decimal)item.periodPrincipalAmount;
                addLoanSchedulePeriodic.ENDPRINCIPALAMOUNT = (decimal)item.endPrincipalAmount;
                addLoanSchedulePeriodic.INTERESTRATE = item.interestRate;
                addLoanSchedulePeriodic.AMORTISEDSTARTPRINCIPALAMOUNT = (decimal)item.amortisedStartPrincipalAmount;
                addLoanSchedulePeriodic.AMORTISEDPERIODPAYMENTAMOUNT = (decimal)item.amortisedPeriodPaymentAmount;
                addLoanSchedulePeriodic.AMORTISEDPERIODINTERESTAMOUNT = (decimal)item.amortisedPeriodInterestAmount;
                addLoanSchedulePeriodic.AMORTISEDPERIODPRINCIPALAMOUNT = (decimal)item.amortisedPeriodPrincipalAmount;
                addLoanSchedulePeriodic.AMORTISEDENDPRINCIPALAMOUNT = (decimal)item.amortisedEndPrincipalAmount;
                addLoanSchedulePeriodic.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanSchedulePeriodic.CREATEDBY = item.createdBy;
                addLoanSchedulePeriodic.DATETIMECREATED = item.dateTimeCreated;


                loanSchedulePeriodic.Add(addLoanSchedulePeriodic);

            }


            var itemToRemove = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                                where p.LOANID == loanId
                                select p);
            if (itemToRemove != null)
            {
                context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemove);
                context.SaveChanges();
            }

            this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(loanSchedulePeriodic);

            context.SaveChanges();
            return model;
        }

        public IEnumerable<LoanPaymentScheduleDailyViewModel> MergeDailyScheduleNew(int loanId, DateTime applicationDate, List<LoanPaymentScheduleDailyViewModel> dailySchedule)
        {

            var systemDate = generalSetup.GetApplicationDate();
            int no = 0;//number.Count() - 1;

            List<LoanPaymentScheduleDailyViewModel> model1 = new List<LoanPaymentScheduleDailyViewModel>();
            List<LoanPaymentScheduleDailyViewModel> model2 = new List<LoanPaymentScheduleDailyViewModel>();
            List<LoanPaymentScheduleDailyViewModel> model = new List<LoanPaymentScheduleDailyViewModel>();

            int counter = 0;

            try
            {
                model1 = (from a in context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV
                          where a.LOANID == loanId && a.ARCHIVEDATE == DbFunctions.TruncateTime(systemDate)
                          && a.DATE < DbFunctions.TruncateTime(applicationDate)
                          orderby a.PAYMENTNUMBER ascending
                          select new LoanPaymentScheduleDailyViewModel()
                          {
                              loanId = a.LOANID,
                              paymentNumber = a.PAYMENTNUMBER,
                              date = a.DATE,
                              paymentDate = a.PAYMENTDATE,
                              openingBalance = (double)a.OPENINGBALANCE,
                              startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                              dailyPaymentAmount = (double)a.DAILYPAYMENTAMOUNT,
                              dailyInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                              dailyPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                              closingBalance = (double)a.CLOSINGBALANCE,
                              endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                              amortisedCost = (double)a.AMORTISEDCOST,
                              accruedInterest = (double)a.ACCRUEDINTEREST,
                              norminalInterestRate = a.INTERESTRATE,

                              amOpeningBalance = (double)a.AMORTISEDOPENINGBALANCE,
                              amStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                              amDailyPaymentAmount = (double)a.AMORTISEDDAILYPAYMENTAMOUNT,
                              amDailyInterestAmount = (double)a.AMORTISEDDAILYINTERESTAMOUNT,
                              amDailyPrincipalAmount = (double)a.AMORTISEDDAILYPRINCIPALAMOUNT,
                              amClosingBalance = (double)a.AMORTISEDCLOSINGBALANCE,
                              amEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                              amAccruedInterest = (double)a.AMORTISEDACCRUEDINTEREST,
                              amAmortisedCost = (double)a.AMORTISED_AMORTISEDCOST,
                              discountPremium = (double)a.DISCOUNTPREMIUM,
                              unEarnedFee = (double)a.UNEARNEDFEE,
                              earnedFee = (double)a.EARNEDFEE,
                              effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                              numberOfPeriods = a.NUMBEROFPERIODS,
                              ballonAmount = (double)a.BALLONAMOUNT,
                              createdBy = a.CREATEDBY,
                              dateTimeCreated = a.DATETIMECREATED,
                          }).ToList();

                //.Concat

                counter = model1.Count();


                //model2 = dailySchedule.Where(a => a.loanId == loanId && a.date >= DbFunctions.TruncateTime(applicationDate)).OrderBy(a => a.paymentDate).ToList();

                model2 = dailySchedule.OrderBy(a => a.paymentDate).ToList();

                List<LoanPaymentScheduleDailyViewModel> LoanPaymentScheduleDaily = new List<LoanPaymentScheduleDailyViewModel>();

                foreach (LoanPaymentScheduleDailyViewModel _model in model2)
                {

                    if (_model.date >= applicationDate)
                    {
                        LoanPaymentScheduleDailyViewModel _LoanPaymentScheduleDaily = new LoanPaymentScheduleDailyViewModel();

                        counter = counter + 1;

                        _LoanPaymentScheduleDaily.loanId = _model.loanId;
                        _LoanPaymentScheduleDaily.paymentNumber = counter;
                        _LoanPaymentScheduleDaily.date = _model.date;
                        _LoanPaymentScheduleDaily.paymentDate = _model.paymentDate;
                        _LoanPaymentScheduleDaily.openingBalance = (double)_model.openingBalance;
                        _LoanPaymentScheduleDaily.startPrincipalAmount = (double)_model.startPrincipalAmount;
                        _LoanPaymentScheduleDaily.dailyPaymentAmount = (double)_model.dailyPaymentAmount;
                        _LoanPaymentScheduleDaily.dailyInterestAmount = (double)_model.dailyInterestAmount;
                        _LoanPaymentScheduleDaily.dailyPrincipalAmount = (double)_model.dailyPrincipalAmount;
                        _LoanPaymentScheduleDaily.closingBalance = (double)_model.closingBalance;
                        _LoanPaymentScheduleDaily.endPrincipalAmount = (double)_model.endPrincipalAmount;
                        _LoanPaymentScheduleDaily.amortisedCost = (double)_model.amortisedCost;
                        _LoanPaymentScheduleDaily.accruedInterest = (double)_model.accruedInterest;
                        _LoanPaymentScheduleDaily.norminalInterestRate = _model.norminalInterestRate;
                        _LoanPaymentScheduleDaily.amOpeningBalance = (double)_model.amOpeningBalance;
                        _LoanPaymentScheduleDaily.amStartPrincipalAmount = (double)_model.amStartPrincipalAmount;
                        _LoanPaymentScheduleDaily.amDailyPaymentAmount = (double)_model.amDailyPaymentAmount;
                        _LoanPaymentScheduleDaily.amDailyInterestAmount = (double)_model.amDailyInterestAmount;
                        _LoanPaymentScheduleDaily.amDailyPrincipalAmount = (double)_model.amDailyPrincipalAmount;
                        _LoanPaymentScheduleDaily.amClosingBalance = (double)_model.amClosingBalance;
                        _LoanPaymentScheduleDaily.amEndPrincipalAmount = (double)_model.amEndPrincipalAmount;
                        _LoanPaymentScheduleDaily.amAccruedInterest = (double)_model.amAccruedInterest;
                        _LoanPaymentScheduleDaily.amAmortisedCost = (double)_model.amAmortisedCost;
                        _LoanPaymentScheduleDaily.discountPremium = (double)_model.discountPremium;
                        _LoanPaymentScheduleDaily.unEarnedFee = (double)_model.unEarnedFee;
                        _LoanPaymentScheduleDaily.earnedFee = (double)_model.earnedFee;
                        _LoanPaymentScheduleDaily.effectiveInterestRate = _model.effectiveInterestRate;
                        _LoanPaymentScheduleDaily.numberOfPeriods = _model.numberOfPeriods;
                        _LoanPaymentScheduleDaily.ballonAmount = (double)_model.ballonAmount;
                        _LoanPaymentScheduleDaily.createdBy = _model.createdBy;
                        _LoanPaymentScheduleDaily.dateTimeCreated = _model.dateTimeCreated;

                        LoanPaymentScheduleDaily.Add(_LoanPaymentScheduleDaily);
                    }


                }

                //model2 = (from a in dailySchedule.Where(a => a.loanId == loanId && a.date >= (applicationDate)).OrderBy(a => a.paymentDate).ToList()
                //orderby a.paymentDate ascending

                //model2 = (from a in dailySchedule
                //          join b in context.TBL_LOAN on a.loanId equals b.TERMLOANID
                //          select new LoanPaymentScheduleDailyViewModel()
                //          {
                //              loanId = a.loanId,
                //              paymentNumber = a.paymentNumber,
                //              date = a.date,
                //              paymentDate = a.paymentDate,
                //              openingBalance = (double)a.openingBalance,
                //              startPrincipalAmount = (double)a.startPrincipalAmount,
                //              dailyPaymentAmount = (double)a.dailyPaymentAmount,
                //              dailyInterestAmount = (double)a.dailyInterestAmount,
                //              dailyPrincipalAmount = (double)a.dailyPrincipalAmount,
                //              closingBalance = (double)a.closingBalance,
                //              endPrincipalAmount = (double)a.endPrincipalAmount,
                //              amortisedCost = (double)a.amortisedCost,
                //              accruedInterest = (double)a.accruedInterest,
                //              norminalInterestRate = a.norminalInterestRate,
                //              amOpeningBalance = (double)a.amOpeningBalance,
                //              amStartPrincipalAmount = (double)a.amStartPrincipalAmount,
                //              amDailyPaymentAmount = (double)a.amDailyPaymentAmount,
                //              amDailyInterestAmount = (double)a.amDailyInterestAmount,
                //              amDailyPrincipalAmount = (double)a.amDailyPrincipalAmount,
                //              amClosingBalance = (double)a.amClosingBalance,
                //              amEndPrincipalAmount = (double)a.amEndPrincipalAmount,
                //              amAccruedInterest = (double)a.amAccruedInterest,
                //              amAmortisedCost = (double)a.amAmortisedCost,
                //              discountPremium = (double)a.discountPremium,
                //              unEarnedFee = (double)a.unEarnedFee,
                //              earnedFee = (double)a.earnedFee,
                //              effectiveInterestRate = a.effectiveInterestRate,
                //              numberOfPeriods = a.numberOfPeriods,
                //              ballonAmount = (double)a.ballonAmount,
                //              createdBy = a.createdBy,
                //              dateTimeCreated = a.dateTimeCreated,
                //          }).ToList();


                model = model1.Union(model2).OrderBy(x => x.paymentNumber).ToList();

                List<TBL_LOAN_SCHEDULE_DAILY> loanScheduleDaily = new List<TBL_LOAN_SCHEDULE_DAILY>();


                foreach (var item in model)
                {
                    TBL_LOAN_SCHEDULE_DAILY addLoanScheduleDaily = new TBL_LOAN_SCHEDULE_DAILY();

                    addLoanScheduleDaily.LOANID = loanId;
                    addLoanScheduleDaily.PAYMENTNUMBER = ++no - 1;
                    addLoanScheduleDaily.DATE = item.date;
                    addLoanScheduleDaily.PAYMENTDATE = item.paymentDate;
                    addLoanScheduleDaily.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                    addLoanScheduleDaily.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                    addLoanScheduleDaily.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                    addLoanScheduleDaily.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                    addLoanScheduleDaily.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                    addLoanScheduleDaily.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                    addLoanScheduleDaily.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                    addLoanScheduleDaily.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                    addLoanScheduleDaily.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                    addLoanScheduleDaily.INTERESTRATE = item.norminalInterestRate;
                    addLoanScheduleDaily.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                    addLoanScheduleDaily.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                    addLoanScheduleDaily.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                    addLoanScheduleDaily.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                    addLoanScheduleDaily.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                    addLoanScheduleDaily.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                    addLoanScheduleDaily.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                    addLoanScheduleDaily.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                    addLoanScheduleDaily.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                    addLoanScheduleDaily.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                    addLoanScheduleDaily.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                    addLoanScheduleDaily.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                    addLoanScheduleDaily.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                    addLoanScheduleDaily.NUMBEROFPERIODS = item.numberOfPeriods;
                    addLoanScheduleDaily.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                    addLoanScheduleDaily.CREATEDBY = item.createdBy;
                    addLoanScheduleDaily.DATETIMECREATED = item.dateTimeCreated;

                    loanScheduleDaily.Add(addLoanScheduleDaily);

                }

                var itemToRemove = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                                    where p.LOANID == loanId
                                    select p);

                if (itemToRemove != null)
                {
                    context.TBL_LOAN_SCHEDULE_DAILY.RemoveRange(itemToRemove);
                    context.SaveChanges();
                }

                this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(loanScheduleDaily);

            }


            catch (Exception ex)
            {

                throw ex;
            }


            context.SaveChanges();
            return model;
        }

        public IEnumerable<LoanPaymentScheduleDailyViewModel> UpdateDailySchedule(int loanId, DateTime applicationDate)
        {

            var systemDate = generalSetup.GetApplicationDate();
            int no = 0;//number.Count() - 1;

            var model = (from a in context.TBL_LOAN_SCHEDULE_DAILY_TEMP
                         where a.LOANID == loanId
                         orderby a.PAYMENTNUMBER ascending
                         select new LoanPaymentScheduleDailyViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             date = a.DATE,
                             paymentDate = a.PAYMENTDATE,
                             openingBalance = (double)a.OPENINGBALANCE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             dailyPaymentAmount = (double)a.DAILYPAYMENTAMOUNT,
                             dailyInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                             dailyPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                             closingBalance = (double)a.CLOSINGBALANCE,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             amortisedCost = (double)a.AMORTISEDCOST,
                             accruedInterest = (double)a.ACCRUEDINTEREST,
                             norminalInterestRate = a.INTERESTRATE,
                             amOpeningBalance = (double)a.AMORTISEDOPENINGBALANCE,
                             amStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amDailyPaymentAmount = (double)a.AMORTISEDDAILYPAYMENTAMOUNT,
                             amDailyInterestAmount = (double)a.AMORTISEDDAILYINTERESTAMOUNT,
                             amDailyPrincipalAmount = (double)a.AMORTISEDDAILYPRINCIPALAMOUNT,
                             amClosingBalance = (double)a.AMORTISEDCLOSINGBALANCE,
                             amEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             amAccruedInterest = (double)a.AMORTISEDACCRUEDINTEREST,
                             amAmortisedCost = (double)a.AMORTISED_AMORTISEDCOST,
                             discountPremium = (double)a.DISCOUNTPREMIUM,
                             unEarnedFee = (double)a.UNEARNEDFEE,
                             earnedFee = (double)a.EARNEDFEE,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             numberOfPeriods = a.NUMBEROFPERIODS,
                             ballonAmount = (double)a.BALLONAMOUNT,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,
                         }).ToList();

            List<TBL_LOAN_SCHEDULE_DAILY> loanScheduleDaily = new List<TBL_LOAN_SCHEDULE_DAILY>();


            foreach (var item in model)
            {
                TBL_LOAN_SCHEDULE_DAILY addLoanScheduleDaily = new TBL_LOAN_SCHEDULE_DAILY();

                addLoanScheduleDaily.LOANID = loanId;
                addLoanScheduleDaily.PAYMENTNUMBER = ++no - 1;
                addLoanScheduleDaily.DATE = item.date;
                addLoanScheduleDaily.PAYMENTDATE = item.paymentDate;
                addLoanScheduleDaily.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                addLoanScheduleDaily.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                addLoanScheduleDaily.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                addLoanScheduleDaily.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                addLoanScheduleDaily.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                addLoanScheduleDaily.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                addLoanScheduleDaily.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                addLoanScheduleDaily.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                addLoanScheduleDaily.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                addLoanScheduleDaily.INTERESTRATE = item.norminalInterestRate;
                addLoanScheduleDaily.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                addLoanScheduleDaily.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                addLoanScheduleDaily.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                addLoanScheduleDaily.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                addLoanScheduleDaily.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                addLoanScheduleDaily.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                addLoanScheduleDaily.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                addLoanScheduleDaily.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                addLoanScheduleDaily.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                addLoanScheduleDaily.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                addLoanScheduleDaily.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                addLoanScheduleDaily.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                addLoanScheduleDaily.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanScheduleDaily.NUMBEROFPERIODS = item.numberOfPeriods;
                addLoanScheduleDaily.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                addLoanScheduleDaily.CREATEDBY = item.createdBy;
                addLoanScheduleDaily.DATETIMECREATED = item.dateTimeCreated;

                loanScheduleDaily.Add(addLoanScheduleDaily);

            }

            var itemToRemove = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                                where p.LOANID == loanId
                                select p);

            if (itemToRemove != null)
            {
                context.TBL_LOAN_SCHEDULE_DAILY.RemoveRange(itemToRemove);
                context.SaveChanges();
            }

            this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(loanScheduleDaily);

            context.SaveChanges();
            return model;
        }

        public IEnumerable<LoanPaymentSchedulePeriodicViewModel> MergePeriodicScheduleForInterest(int loanId, DateTime applicationDate)
        {


            int no = 0;//number.Count() - 1;

            var model = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC_ARC
                         where a.LOANID == loanId && a.PAYMENTDATE < DbFunctions.TruncateTime(applicationDate)
                         orderby a.PAYMENTNUMBER ascending
                         select new LoanPaymentSchedulePeriodicViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             paymentDate = a.PAYMENTDATE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             periodPaymentAmount = (double)a.PERIODPAYMENTAMOUNT,
                             periodInterestAmount = (double)a.PERIODINTERESTAMOUNT,
                             periodPrincipalAmount = (double)a.PERIODPRINCIPALAMOUNT,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             previousInterestAmount = (double)a.PERIODINTERESTAMOUNT,
                             previousPrincipalAmount = (double)a.PERIODPRINCIPALAMOUNT,
                             interestRate = a.INTERESTRATE,
                             amortisedStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amortisedPeriodPaymentAmount = (double)a.AMORTISEDPERIODPAYMENTAMOUNT,
                             amortisedPeriodInterestAmount = (double)a.AMORTISEDPERIODINTERESTAMOUNT,
                             amortisedPeriodPrincipalAmount = (double)a.AMORTISEDPERIODPRINCIPALAMOUNT,
                             amortisedEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,
                         }).Concat
                         (from a in context.TBL_LOAN_SCHEDULE_PERIODIC_TMP
                          join b in context.TBL_LOAN_SCHEDULE_PERIODIC_ARC on a.LOANID equals b.LOANID
                          where a.LOANID == loanId && a.PAYMENTDATE == b.PAYMENTDATE && a.PAYMENTDATE >= DbFunctions.TruncateTime(applicationDate)
                          && a.PAYMENTNUMBER != 0
                          orderby a.PAYMENTNUMBER ascending
                          select new LoanPaymentSchedulePeriodicViewModel()
                          {
                              loanId = a.LOANID,
                              paymentNumber = a.PAYMENTNUMBER,//lastNo + 1,
                              paymentDate = a.PAYMENTDATE,
                              startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                              periodPaymentAmount = (double)a.PERIODPAYMENTAMOUNT,
                              periodInterestAmount = (double)a.PERIODINTERESTAMOUNT,
                              periodPrincipalAmount = (double)a.PERIODPRINCIPALAMOUNT,
                              endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                              previousInterestAmount = (double)b.PERIODINTERESTAMOUNT,
                              previousPrincipalAmount = (double)b.PERIODPRINCIPALAMOUNT,
                              interestRate = a.INTERESTRATE,
                              amortisedStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                              amortisedPeriodPaymentAmount = (double)a.AMORTISEDPERIODPAYMENTAMOUNT,
                              amortisedPeriodInterestAmount = (double)a.AMORTISEDPERIODINTERESTAMOUNT,
                              amortisedPeriodPrincipalAmount = (double)a.AMORTISEDPERIODPRINCIPALAMOUNT,
                              amortisedEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                              effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                              createdBy = a.CREATEDBY,
                              dateTimeCreated = a.DATETIMECREATED,
                          }).ToList();

            List<TBL_LOAN_SCHEDULE_PERIODIC> loanSchedulePeriodic = new List<TBL_LOAN_SCHEDULE_PERIODIC>();

            foreach (var item in model)
            {
                TBL_LOAN_SCHEDULE_PERIODIC addLoanSchedulePeriodic = new TBL_LOAN_SCHEDULE_PERIODIC();

                addLoanSchedulePeriodic.LOANID = item.loanId;
                addLoanSchedulePeriodic.PAYMENTNUMBER = ++no - 1;//item.paymentNumber;
                addLoanSchedulePeriodic.PAYMENTDATE = item.paymentDate;
                addLoanSchedulePeriodic.STARTPRINCIPALAMOUNT = (decimal)item.startPrincipalAmount;
                addLoanSchedulePeriodic.PERIODPAYMENTAMOUNT = (decimal)item.periodPaymentAmount;
                addLoanSchedulePeriodic.PERIODINTERESTAMOUNT = (decimal)item.periodInterestAmount;
                addLoanSchedulePeriodic.PERIODPRINCIPALAMOUNT = (decimal)item.periodPrincipalAmount;
                addLoanSchedulePeriodic.ENDPRINCIPALAMOUNT = (decimal)item.endPrincipalAmount;
                addLoanSchedulePeriodic.PREVIOUSINTERESTAMOUNT = (decimal)item.previousInterestAmount;
                addLoanSchedulePeriodic.PREVIOUSPRINCIPALAMOUNT = (decimal)item.previousPrincipalAmount;
                addLoanSchedulePeriodic.INTERESTRATE = item.interestRate;
                addLoanSchedulePeriodic.AMORTISEDSTARTPRINCIPALAMOUNT = (decimal)item.amortisedStartPrincipalAmount;
                addLoanSchedulePeriodic.AMORTISEDPERIODPAYMENTAMOUNT = (decimal)item.amortisedPeriodPaymentAmount;
                addLoanSchedulePeriodic.AMORTISEDPERIODINTERESTAMOUNT = (decimal)item.amortisedPeriodInterestAmount;
                addLoanSchedulePeriodic.AMORTISEDPERIODPRINCIPALAMOUNT = (decimal)item.amortisedPeriodPrincipalAmount;
                addLoanSchedulePeriodic.AMORTISEDENDPRINCIPALAMOUNT = (decimal)item.amortisedEndPrincipalAmount;
                addLoanSchedulePeriodic.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanSchedulePeriodic.CREATEDBY = item.createdBy;
                addLoanSchedulePeriodic.DATETIMECREATED = item.dateTimeCreated;

                loanSchedulePeriodic.Add(addLoanSchedulePeriodic);

            }

            var itemToRemove = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                                where p.LOANID == loanId
                                select p);

            if (itemToRemove != null)
            {
                context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemove);
                context.SaveChanges();
            }

            this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(loanSchedulePeriodic);

            context.SaveChanges();
            return model;
        }

        public IEnumerable<LoanPaymentScheduleDailyViewModel> MergeDailyScheduleForInterest(int loanId, DateTime applicationDate)
        {
            int no = 0;//number.Count() - 1;

            var model = (from a in context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV
                         where a.LOANID == loanId && a.DATE < DbFunctions.TruncateTime(applicationDate)
                         orderby a.PAYMENTNUMBER ascending
                         select new LoanPaymentScheduleDailyViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             date = a.DATE,
                             paymentDate = a.PAYMENTDATE,
                             openingBalance = (double)a.OPENINGBALANCE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             dailyPaymentAmount = (double)a.DAILYPAYMENTAMOUNT,
                             dailyInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                             dailyPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                             closingBalance = (double)a.CLOSINGBALANCE,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             amortisedCost = (double)a.AMORTISEDCOST,
                             accruedInterest = (double)a.ACCRUEDINTEREST,
                             norminalInterestRate = a.INTERESTRATE,
                             previousInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                             previousPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                             amOpeningBalance = (double)a.AMORTISEDOPENINGBALANCE,
                             amStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amDailyPaymentAmount = (double)a.AMORTISEDDAILYPAYMENTAMOUNT,
                             amDailyInterestAmount = (double)a.AMORTISEDDAILYINTERESTAMOUNT,
                             amDailyPrincipalAmount = (double)a.AMORTISEDDAILYPRINCIPALAMOUNT,
                             amClosingBalance = (double)a.AMORTISEDCLOSINGBALANCE,
                             amEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             amAccruedInterest = (double)a.AMORTISEDACCRUEDINTEREST,
                             amAmortisedCost = (double)a.AMORTISED_AMORTISEDCOST,
                             discountPremium = (double)a.DISCOUNTPREMIUM,
                             unEarnedFee = (double)a.UNEARNEDFEE,
                             earnedFee = (double)a.EARNEDFEE,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             numberOfPeriods = a.NUMBEROFPERIODS,
                             ballonAmount = (double)a.BALLONAMOUNT,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,
                         }).Concat
                          (from a in context.TBL_LOAN_SCHEDULE_DAILY_TEMP
                           join b in context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV on a.LOANID equals b.LOANID
                           where a.LOANID == loanId && a.DATE == b.DATE && a.DATE >= DbFunctions.TruncateTime(applicationDate)
                           && a.PAYMENTNUMBER != 0
                           orderby a.PAYMENTNUMBER ascending
                           select new LoanPaymentScheduleDailyViewModel()
                           {
                               loanId = a.LOANID,
                               paymentNumber = a.PAYMENTNUMBER,
                               date = a.DATE,
                               paymentDate = a.PAYMENTDATE,
                               openingBalance = (double)a.OPENINGBALANCE,
                               startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                               dailyPaymentAmount = (double)a.DAILYPAYMENTAMOUNT,
                               dailyInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                               dailyPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                               closingBalance = (double)a.CLOSINGBALANCE,
                               endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                               amortisedCost = (double)a.AMORTISEDCOST,
                               accruedInterest = (double)a.ACCRUEDINTEREST,
                               norminalInterestRate = a.INTERESTRATE,
                               previousInterestAmount = (double)b.DAILYINTERESTAMOUNT,
                               previousPrincipalAmount = (double)b.DAILYPRINCIPALAMOUNT,
                               amOpeningBalance = (double)a.AMORTISEDOPENINGBALANCE,
                               amStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                               amDailyPaymentAmount = (double)a.AMORTISEDDAILYPAYMENTAMOUNT,
                               amDailyInterestAmount = (double)a.AMORTISEDDAILYINTERESTAMOUNT,
                               amDailyPrincipalAmount = (double)a.AMORTISEDDAILYPRINCIPALAMOUNT,
                               amClosingBalance = (double)a.AMORTISEDCLOSINGBALANCE,
                               amEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                               amAccruedInterest = (double)a.AMORTISEDACCRUEDINTEREST,
                               amAmortisedCost = (double)a.AMORTISED_AMORTISEDCOST,
                               discountPremium = (double)a.DISCOUNTPREMIUM,
                               unEarnedFee = (double)a.UNEARNEDFEE,
                               earnedFee = (double)a.EARNEDFEE,
                               effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                               numberOfPeriods = a.NUMBEROFPERIODS,
                               ballonAmount = (double)a.BALLONAMOUNT,
                               createdBy = a.CREATEDBY,
                               dateTimeCreated = a.DATETIMECREATED,
                           }).ToList();

            List<TBL_LOAN_SCHEDULE_DAILY> loanScheduleDaily = new List<TBL_LOAN_SCHEDULE_DAILY>();

            foreach (var item in model)
            {
                TBL_LOAN_SCHEDULE_DAILY addLoanScheduleDaily = new TBL_LOAN_SCHEDULE_DAILY();

                addLoanScheduleDaily.LOANID = loanId;
                addLoanScheduleDaily.PAYMENTNUMBER = ++no - 1;
                addLoanScheduleDaily.DATE = item.date;
                addLoanScheduleDaily.PAYMENTDATE = item.paymentDate;
                addLoanScheduleDaily.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                addLoanScheduleDaily.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                addLoanScheduleDaily.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                addLoanScheduleDaily.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                addLoanScheduleDaily.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                addLoanScheduleDaily.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                addLoanScheduleDaily.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                addLoanScheduleDaily.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                addLoanScheduleDaily.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                addLoanScheduleDaily.INTERESTRATE = item.norminalInterestRate;
                addLoanScheduleDaily.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                addLoanScheduleDaily.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                addLoanScheduleDaily.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                addLoanScheduleDaily.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                addLoanScheduleDaily.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                addLoanScheduleDaily.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                addLoanScheduleDaily.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                addLoanScheduleDaily.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                addLoanScheduleDaily.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                addLoanScheduleDaily.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                addLoanScheduleDaily.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                addLoanScheduleDaily.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                addLoanScheduleDaily.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanScheduleDaily.NUMBEROFPERIODS = item.numberOfPeriods;
                addLoanScheduleDaily.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                addLoanScheduleDaily.CREATEDBY = item.createdBy;
                addLoanScheduleDaily.DATETIMECREATED = item.dateTimeCreated;
                addLoanScheduleDaily.PREVIOUSINTERESTAMOUNT = Convert.ToDecimal(item.previousInterestAmount);
                addLoanScheduleDaily.PREVIOUSPRINCIPALAMOUNT = Convert.ToDecimal(item.previousPrincipalAmount);

                loanScheduleDaily.Add(addLoanScheduleDaily);

            }

            var itemToRemove = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                                where p.LOANID == loanId
                                select p);

            if (itemToRemove != null)
            {
                context.TBL_LOAN_SCHEDULE_DAILY.RemoveRange(itemToRemove);
                context.SaveChanges();
            }

            this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(loanScheduleDaily);

            context.SaveChanges();
            return model;
        }


        public void ProcessAutomaticInterestRepricing(DateTime applicationDate, int staffId, int companyId)
        {
            var loans = from a in context.TBL_LOAN
                        where a.NEXT_INTEREST_REPRICINGDATE == applicationDate && a.LOANSTATUSID == (short)LoanStatusEnum.Active && a.REPRICINGMODEID == (short)LoanRepricingModeEnum.FixedToMaturityWithRepricing && a.COMPANYID == companyId
                        select a;

            LoanPaymentRestructureScheduleInputViewModel loanInput = new LoanPaymentRestructureScheduleInputViewModel();

            var eod_Operation_Log = context.TBL_EOD_OPERATION_LOG.Where(c => c.EODDATE == applicationDate && c.EODOPERATIONID == (int)EodOperationEnum.ProcessAutomaticInterestRepricing && c.COMPANYID == companyId).FirstOrDefault();


            List<TBL_EOD_OPERATION_LOG_DETAIL> eod_operation_Detail_List = new List<TBL_EOD_OPERATION_LOG_DETAIL>();

            if (loans.Count() != 0)
            {
                var eodOperations = context.TBL_EOD_OPERATION.OrderBy(x => x.POSITION).ToList();

                foreach (TBL_LOAN loan in loans)
                {

                    TBL_EOD_OPERATION_LOG_DETAIL eod_operation_Detail = new TBL_EOD_OPERATION_LOG_DETAIL();

                    var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFERENCENUMBER == loan.LOANREFERENCENUMBER && c.EODDATE == applicationDate && c.EODOPERATIONID == (int)EodOperationEnum.ProcessAutomaticInterestRepricing).FirstOrDefault();

                    if (checkExistence == null)
                    {
                        eod_operation_Detail.EODOPERATIONLOGID = eod_Operation_Log.EODOPERATIONLOGID;
                        eod_operation_Detail.EODSTATUSID = (int)EodOperationStatusEnum.Processing;
                        eod_operation_Detail.REFERENCENUMBER = loan.LOANREFERENCENUMBER;
                        eod_operation_Detail.EODOPERATIONID = (int)EodOperationEnum.ProcessAutomaticInterestRepricing;
                        eod_operation_Detail.EODDATE = applicationDate;
                        eod_operation_Detail.EODUSERID = staffId;
                        eod_operation_Detail_List.Add(eod_operation_Detail);

                    }

                }

                context.TBL_EOD_OPERATION_LOG_DETAIL.AddRange(eod_operation_Detail_List);

                context.SaveChanges();

            }


            foreach (var item in loans)
            {

                var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFERENCENUMBER == item.LOANREFERENCENUMBER && c.EODDATE == applicationDate && c.EODSTATUSID != (int)EodOperationStatusEnum.Completed && c.EODOPERATIONID == (int)EodOperationEnum.ProcessAutomaticInterestRepricing).FirstOrDefault();

                if (checkExistence != null)
                {

                    var eod_Operation_Log_Detail_Set_Value = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFERENCENUMBER == item.LOANREFERENCENUMBER && c.EODDATE == applicationDate && c.EODOPERATIONID == (int)EodOperationEnum.ProcessAutomaticInterestRepricing).FirstOrDefault();

                    eod_Operation_Log_Detail_Set_Value.STARTDATETIME = DateTime.Now;
                    eod_Operation_Log_Detail_Set_Value.EODUSERID = staffId;

                    context.SaveChanges();

                    try
                    {


                        var priceIndex = context.TBL_PRODUCT_PRICE_INDEX.FirstOrDefault(x => x.PRODUCTPRICEINDEXID == item.PRODUCTPRICEINDEXID);
                        if (priceIndex != null)
                        {
                            var customerRate = item.INTERESTRATE - item.PRODUCTPRICEINDEXRATE;
                            var newInterestRate = priceIndex.PRICEINDEXRATE + customerRate;

                            loanInput.operationId = (int)OperationsEnum.InterestRepricing; // item.OPERATIONID;
                            loanInput.loanId = item.TERMLOANID;
                            loanInput.interestRate = newInterestRate;

                            _transactionReferenceNo = item.LOANREFERENCENUMBER;

                            InterestRateReview((int)loanInput.loanId, loanInput, applicationDate, staffId);

                            item.PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE;
                            item.NEXT_INTEREST_REPRICINGDATE = item.NEXT_INTEREST_REPRICINGDATE.Value.AddDays(item.REPRICINGDURATION.Value);

                        }

                        eod_Operation_Log_Detail_Set_Value.ENDDATETIME = DateTime.Now;
                        eod_Operation_Log_Detail_Set_Value.EODSTATUSID = (int)EodOperationStatusEnum.Completed;
                        eod_Operation_Log_Detail_Set_Value.EODUSERID = staffId;
                        eod_Operation_Log_Detail_Set_Value.ERRORINFORMATION = "No Error";
                        context.SaveChanges();
                    }
                    catch (Exception ex)
                    {

                        eod_Operation_Log_Detail_Set_Value.ENDDATETIME = DateTime.Now;
                        eod_Operation_Log_Detail_Set_Value.EODSTATUSID = (int)EodOperationStatusEnum.Error;
                        eod_Operation_Log_Detail_Set_Value.EODUSERID = staffId;
                        eod_Operation_Log_Detail_Set_Value.ERRORINFORMATION = $"Ref No - {item.LOANREFERENCENUMBER} Exception - {ex.Message}  - inner exception -  {ex.InnerException}";
                        context.SaveChanges();
                    }



                }




            }

            if (loans.Count() > 0)
                context.SaveChanges();
        }

        //public bool InterestRateReview(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        //{
        //    bool output = false;

        //    try
        //    {
        //        var systemDate = generalSetup.GetApplicationDate();
        //        loanInput.date = systemDate;
        //        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
        //        var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();

        //        if (LoanExist(loanId) > 0)
        //        {

        //            var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);

        //            DeleteLoanExist(loanId, systemDate, context);
        //            ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode, context);/////loanId change this to OperationId
        //            ArchivePeriodicSchedule(loanId, archiveBatchCode, context);
        //            ArchiveDailySchedule(loanId, archiveBatchCode, context);


        //            if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
        //            {

        //                //----------generate and save periodic loan schedule -----------------------------------
        //                List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

        //                List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();

        //                foreach (var item in periodicScheduleTemp)
        //                {
        //                    TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

        //                    scheduleTemp.LOANID = loanId;
        //                    scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
        //                    scheduleTemp.PAYMENTDATE = item.paymentDate;
        //                    scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                    scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
        //                    scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
        //                    scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
        //                    scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                    scheduleTemp.INTERESTRATE = loanInput.interestRate;
        //                    scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
        //                    scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
        //                    scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
        //                    scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
        //                    scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
        //                    scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                    scheduleTemp.CREATEDBY = staffId;
        //                    scheduleTemp.DATETIMECREATED = systemDate;

        //                    tblPeriodicScheduleTemp.Add(scheduleTemp);
        //                }
        //                //-------------------------------------------------------------------------------------


        //                //----------generate and save daily loan schedule -----------------------------------
        //                List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

        //                List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

        //                foreach (var item in dailyScheduleTemp)
        //                {
        //                    TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

        //                    scheduleTemp.LOANID = loanId;
        //                    scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
        //                    scheduleTemp.DATE = item.date;
        //                    scheduleTemp.PAYMENTDATE = item.paymentDate;
        //                    scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
        //                    scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                    scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
        //                    scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
        //                    scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
        //                    scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
        //                    scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                    scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
        //                    scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
        //                    scheduleTemp.INTERESTRATE = item.norminalInterestRate;
        //                    scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
        //                    scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
        //                    scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
        //                    scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
        //                    scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
        //                    scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
        //                    scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
        //                    scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
        //                    scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
        //                    scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
        //                    scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
        //                    scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
        //                    scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                    scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
        //                    scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
        //                    scheduleTemp.CREATEDBY = staffId;
        //                    scheduleTemp.DATETIMECREATED = systemDate;

        //                    tblDailyScheduleTemp.Add(scheduleTemp);
        //                }
        //                //----------------------------------------------------------------


        //                //------------adding records to the database--------------------------

        //                //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
        //                //{ context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table


        //                context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

        //                context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
        //                context.SaveChanges();

        //                MergeDailySchedule(loanId, applicationDate);
        //                MergePeriodicSchedule(loanId, applicationDate);

        //                //----------update loan details -----------------------------------
        //                var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
        //                loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
        //                loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
        //                loan.INTERESTNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;


        //                decimal newOutstandingPrincipal = 0;

        //                var loanPeriodicSchedule = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID && x.PAYMENTDATE == applicationDate).FirstOrDefault();

        //                if (loanPeriodicSchedule != null)
        //                {
        //                    newOutstandingPrincipal = loanPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //                }
        //                else
        //                {
        //                    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loan.TERMLOANID && c.PAYMENTDATE < applicationDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();
        //                    newOutstandingPrincipal = previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;
        //                }



        //                //loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
        //                loan.INTERESTRATE = (double)reviewData.INTERATERATE;
        //                loan.OUTSTANDINGPRINCIPAL = newOutstandingPrincipal;
        //                //context.SaveChanges();
        //                //-------------------------------------------------
        //            }
        //            else
        //            {

        //                //----------generate and save periodic loan schedule -----------------------------------
        //                List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

        //                List<TBL_LOAN_SCHEDULE_PERIODIC> tblPeriodicSchedule = new List<TBL_LOAN_SCHEDULE_PERIODIC>();

        //                foreach (var item in periodicSchedule)
        //                {
        //                    TBL_LOAN_SCHEDULE_PERIODIC schedule = new TBL_LOAN_SCHEDULE_PERIODIC();

        //                    schedule.LOANID = loanId;
        //                    schedule.PAYMENTNUMBER = item.paymentNumber;
        //                    schedule.PAYMENTDATE = item.paymentDate;
        //                    schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                    schedule.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
        //                    schedule.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
        //                    schedule.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
        //                    schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                    schedule.INTERESTRATE = loanInput.interestRate;
        //                    schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
        //                    schedule.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
        //                    schedule.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
        //                    schedule.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
        //                    schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
        //                    schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                    schedule.CREATEDBY = staffId;
        //                    schedule.DATETIMECREATED = systemDate;

        //                    tblPeriodicSchedule.Add(schedule);
        //                }
        //                //-------------------------------------------------------------------------------------


        //                List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

        //                MergeDailyScheduleNew(loanId, applicationDate, dailySchedule, context);

        //                var itemToRemovePeriodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
        //                                            where p.LOANID == loanId
        //                                            select p);

        //                if (itemToRemovePeriodic != null)
        //                {
        //                    context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemovePeriodic);
        //                    context.SaveChanges();
        //                }

        //                context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule); ////change to Temp table
        //                context.SaveChanges();

        //                //////----------generate and save daily loan schedule -----------------------------------
        //                ////List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

        //                ////List<TBL_LOAN_SCHEDULE_DAILY> tblDailySchedule = new List<TBL_LOAN_SCHEDULE_DAILY>();

        //                ////foreach (var item in dailySchedule)
        //                ////{
        //                ////    TBL_LOAN_SCHEDULE_DAILY schedule = new TBL_LOAN_SCHEDULE_DAILY();

        //                ////    schedule.LOANID = loanId;
        //                ////    schedule.PAYMENTNUMBER = item.paymentNumber;
        //                ////    schedule.DATE = item.date;
        //                ////    schedule.PAYMENTDATE = item.paymentDate;
        //                ////    schedule.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
        //                ////    schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                ////    schedule.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
        //                ////    schedule.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
        //                ////    schedule.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
        //                ////    schedule.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
        //                ////    schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                ////    schedule.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
        //                ////    schedule.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
        //                ////    schedule.INTERESTRATE = item.norminalInterestRate;
        //                ////    schedule.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
        //                ////    schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
        //                ////    schedule.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
        //                ////    schedule.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
        //                ////    schedule.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
        //                ////    schedule.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
        //                ////    schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
        //                ////    schedule.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
        //                ////    schedule.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
        //                ////    schedule.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
        //                ////    schedule.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
        //                ////    schedule.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
        //                ////    schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                ////    schedule.NUMBEROFPERIODS = item.numberOfPeriods;
        //                ////    schedule.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
        //                ////    schedule.CREATEDBY = staffId;
        //                ////    schedule.DATETIMECREATED = systemDate;

        //                ////    tblDailySchedule.Add(schedule);
        //                ////}
        //                //////----------------------------------------------------------------


        //                //------------adding records to the database--------------------------

        //                //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
        //                //{ context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table


        //                //var itemToRemovePeriodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
        //                //                            where p.LOANID == loanId
        //                //                            select p);

        //                //if (itemToRemovePeriodic != null)
        //                //{
        //                //    context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemovePeriodic);
        //                //    context.SaveChanges();
        //                //}


        //                //var itemToRemoveDaily = (from p in context.TBL_LOAN_SCHEDULE_DAILY
        //                //                         where p.LOANID == loanId
        //                //                         select p);

        //                //if (itemToRemoveDaily != null)
        //                //{
        //                //    context.TBL_LOAN_SCHEDULE_DAILY.RemoveRange(itemToRemoveDaily);
        //                //    context.SaveChanges();
        //                //}

        //                //context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule);////change to Temp table

        //                ////context.TBL_LOAN_SCHEDULE_DAILY.AddRange(tblDailySchedule); ////change to Temp table
        //                //context.SaveChanges();

        //                //MergeDailySchedule(loanId, applicationDate);
        //                //MergePeriodicSchedule(loanId, applicationDate);

        //                //----------update loan details -----------------------------------
        //                var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
        //                loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
        //                loan.PRINCIPALNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
        //                loan.INTERESTNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;


        //                decimal newOutstandingPrincipal = 0;

        //                var loanPeriodicSchedule = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID && x.PAYMENTDATE == applicationDate).FirstOrDefault();

        //                if (loanPeriodicSchedule != null)
        //                {
        //                    newOutstandingPrincipal = loanPeriodicSchedule.ENDPRINCIPALAMOUNT;
        //                }
        //                else
        //                {
        //                    var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loan.TERMLOANID && c.PAYMENTDATE < applicationDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();
        //                    newOutstandingPrincipal = previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;
        //                }


        //                //loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
        //                loan.INTERESTRATE = (double)reviewData.INTERATERATE;
        //                loan.OUTSTANDINGPRINCIPAL = newOutstandingPrincipal;
        //                //context.SaveChanges();
        //                //-------------------------------------------------

        //            }

        //            var result = false;

        //            result = context.SaveChanges() > 0;

        //            if (reviewData.EFFECTIVEDATE < systemDate)
        //            {
        //                //result = LoanBackDateFunction(loanId, applicationDate, systemDate, (decimal)product.PENALCHARGERATE, loanInput);
        //                result = LoanBackDateFunction(loanId, applicationDate, systemDate, loanInput, context);
        //            }

        //            if (result)
        //            {
        //                output = true;
        //            }
        //        }
        //    }
        //    catch (Exception ex)
        //    {

        //        throw ex;

        //    }
        //    return output;
        //}

        public bool InterestRateReview(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        {
            bool output = false;

            try
            {
                var systemDate = generalSetup.GetApplicationDate();
                loanInput.date = systemDate;
                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();

                if (LoanExist(loanId) > 0)
                {

                    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);

                    DeleteLoanExist(loanId, systemDate);
                    ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
                    ArchivePeriodicSchedule(loanId, archiveBatchCode);
                    ArchiveDailySchedule(loanId, archiveBatchCode);


                    if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                    {

                        //----------generate and save periodic loan schedule -----------------------------------
                        List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();

                        foreach (var item in periodicScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.INTERESTRATE = loanInput.interestRate;
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblPeriodicScheduleTemp.Add(scheduleTemp);
                        }
                        //-------------------------------------------------------------------------------------


                        //----------generate and save daily loan schedule -----------------------------------
                        List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

                        foreach (var item in dailyScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.DATE = item.date;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                            scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                            scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                            scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                            scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                            scheduleTemp.INTERESTRATE = item.norminalInterestRate;
                            scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                            scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                            scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                            scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                            scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                            scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                            scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                            scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                            scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                            scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
                            scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblDailyScheduleTemp.Add(scheduleTemp);
                        }
                        //----------------------------------------------------------------


                        //------------adding records to the database--------------------------

                        //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table


                        this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

                        this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
                        context.SaveChanges();

                        MergeDailySchedule(loanId, applicationDate);
                        MergePeriodicSchedule(loanId, applicationDate);

                        //----------update loan details -----------------------------------
                        var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;


                        decimal newOutstandingPrincipal = 0;

                        var loanPeriodicSchedule = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID && x.PAYMENTDATE == applicationDate).FirstOrDefault();

                        if (loanPeriodicSchedule != null)
                        {
                            newOutstandingPrincipal = loanPeriodicSchedule.ENDPRINCIPALAMOUNT;
                        }
                        else
                        {
                            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loan.TERMLOANID && c.PAYMENTDATE < applicationDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();
                            newOutstandingPrincipal = previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;
                        }



                        //loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
                        loan.INTERESTRATE = (double)reviewData.INTERATERATE;
                        loan.OUTSTANDINGPRINCIPAL = newOutstandingPrincipal;
                        //context.SaveChanges();
                        //-------------------------------------------------
                    }
                    else
                    {

                        //----------generate and save periodic loan schedule -----------------------------------
                        List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_PERIODIC> tblPeriodicSchedule = new List<TBL_LOAN_SCHEDULE_PERIODIC>();

                        foreach (var item in periodicSchedule)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC schedule = new TBL_LOAN_SCHEDULE_PERIODIC();

                            schedule.LOANID = loanId;
                            schedule.PAYMENTNUMBER = item.paymentNumber;
                            schedule.PAYMENTDATE = item.paymentDate;
                            schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            schedule.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            schedule.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            schedule.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            schedule.INTERESTRATE = loanInput.interestRate;
                            schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            schedule.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            schedule.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            schedule.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            schedule.CREATEDBY = staffId;
                            schedule.DATETIMECREATED = systemDate;

                            tblPeriodicSchedule.Add(schedule);
                        }
                        //-------------------------------------------------------------------------------------


                        List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        MergeDailyScheduleNew(loanId, applicationDate, dailySchedule);

                        var itemToRemovePeriodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                                                    where p.LOANID == loanId
                                                    select p);

                        if (itemToRemovePeriodic != null)
                        {
                            context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemovePeriodic);
                            context.SaveChanges();
                        }

                        this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule); ////change to Temp table
                        context.SaveChanges();

                        //////----------generate and save daily loan schedule -----------------------------------
                        ////List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        ////List<TBL_LOAN_SCHEDULE_DAILY> tblDailySchedule = new List<TBL_LOAN_SCHEDULE_DAILY>();

                        ////foreach (var item in dailySchedule)
                        ////{
                        ////    TBL_LOAN_SCHEDULE_DAILY schedule = new TBL_LOAN_SCHEDULE_DAILY();

                        ////    schedule.LOANID = loanId;
                        ////    schedule.PAYMENTNUMBER = item.paymentNumber;
                        ////    schedule.DATE = item.date;
                        ////    schedule.PAYMENTDATE = item.paymentDate;
                        ////    schedule.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                        ////    schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                        ////    schedule.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                        ////    schedule.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                        ////    schedule.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                        ////    schedule.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                        ////    schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                        ////    schedule.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                        ////    schedule.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                        ////    schedule.INTERESTRATE = item.norminalInterestRate;
                        ////    schedule.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                        ////    schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                        ////    schedule.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                        ////    schedule.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                        ////    schedule.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                        ////    schedule.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                        ////    schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                        ////    schedule.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                        ////    schedule.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                        ////    schedule.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                        ////    schedule.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                        ////    schedule.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                        ////    schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                        ////    schedule.NUMBEROFPERIODS = item.numberOfPeriods;
                        ////    schedule.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                        ////    schedule.CREATEDBY = staffId;
                        ////    schedule.DATETIMECREATED = systemDate;

                        ////    tblDailySchedule.Add(schedule);
                        ////}
                        //////----------------------------------------------------------------


                        //------------adding records to the database--------------------------

                        //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table


                        //var itemToRemovePeriodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                        //                            where p.LOANID == loanId
                        //                            select p);

                        //if (itemToRemovePeriodic != null)
                        //{
                        //    context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemovePeriodic);
                        //    context.SaveChanges();
                        //}


                        //var itemToRemoveDaily = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                        //                         where p.LOANID == loanId
                        //                         select p);

                        //if (itemToRemoveDaily != null)
                        //{
                        //    context.TBL_LOAN_SCHEDULE_DAILY.RemoveRange(itemToRemoveDaily);
                        //    context.SaveChanges();
                        //}

                        //this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule);////change to Temp table

                        ////this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(tblDailySchedule); ////change to Temp table
                        //context.SaveChanges();

                        //MergeDailySchedule(loanId, applicationDate);
                        //MergePeriodicSchedule(loanId, applicationDate);

                        //----------update loan details -----------------------------------
                        var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;


                        decimal newOutstandingPrincipal = 0;

                        var loanPeriodicSchedule = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID && x.PAYMENTDATE == applicationDate).FirstOrDefault();

                        if (loanPeriodicSchedule != null)
                        {
                            newOutstandingPrincipal = loanPeriodicSchedule.ENDPRINCIPALAMOUNT;
                        }
                        else
                        {
                            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loan.TERMLOANID && c.PAYMENTDATE < applicationDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();
                            newOutstandingPrincipal = previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;
                        }


                        //loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
                        loan.INTERESTRATE = (double)reviewData.INTERATERATE;
                        loan.OUTSTANDINGPRINCIPAL = newOutstandingPrincipal;
                        //context.SaveChanges();
                        //-------------------------------------------------

                    }

                    var result = false;

                    result = context.SaveChanges() > 0;

                    if (reviewData.EFFECTIVEDATE < systemDate)
                    {
                        //result = LoanBackDateFunction(loanId, applicationDate, systemDate, (decimal)product.PENALCHARGERATE, loanInput);
                        result = LoanBackDateFunction(loanId, applicationDate, systemDate, loanInput);
                    }

                    if (result)
                    {
                        output = true;
                    }
                }
            }
            catch (Exception ex)
            {

                throw ex;

            }
            return output;
        }

        public IEnumerable<LoanViewModel> LoanHistory()
        {
            try
            {
                var systemDate = generalSetup.GetApplicationDate();
                var batchCode = CommonHelpers.GenerateRandomDigitCode(5);
                var model = (from a in context.TBL_LOAN
                             where a.LOANSTATUSID == (short)LoanStatusEnum.Active
                             select new LoanViewModel()
                             {
                                 loanId = a.TERMLOANID,
                                 productPriceIndexRate = a.PRODUCTPRICEINDEXRATE,
                                 customerRiskRatingId = a.CUSTOMERRISKRATINGID,
                                 loanSystemTypeId = (short)a.LOANSYSTEMTYPEID,
                                 customerId = a.CUSTOMERID,
                                 productId = a.PRODUCTID,
                                 companyId = a.COMPANYID,
                                 casaAccountId = a.CASAACCOUNTID,
                                 branchId = a.BRANCHID,
                                 currencyId = a.CURRENCYID,
                                 exchangeRate = a.EXCHANGERATE,
                                 loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 subSectorId = a.SUBSECTORID,
                                 principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID,
                                 interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID,
                                 principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                 interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                 relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                 relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                 misCode = a.MISCODE,
                                 teamMiscode = a.TEAMMISCODE,
                                 interestRate = a.INTERESTRATE,
                                 effectiveDate = a.EFFECTIVEDATE,
                                 lastRestructureDate = (DateTime)a.LASTRESTRUCTUREDATE,
                                 maturityDate = a.MATURITYDATE,
                                 bookingDate = a.BOOKINGDATE,
                                 principalAmount = a.PRINCIPALAMOUNT,
                                 principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                 interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                 approvalStatusId = a.APPROVALSTATUSID,
                                 approvedBy = a.APPROVEDBY,
                                 approverComment = a.APPROVERCOMMENT,
                                 dateApproved = a.DATEAPPROVED,
                                 loanStatusId = a.LOANSTATUSID,
                                 scheduleTypeId = a.SCHEDULETYPEID,
                                 scheduleDayCountConventionId = a.SCHEDULEDAYCOUNTCONVENTIONID,
                                 scheduleDayInterestTypeId = a.SCHEDULEDAYINTERESTTYPEID,
                                 isDisbursed = a.ISDISBURSED,
                                 disbursedBy = a.DISBURSEDBY,
                                 disburserComment = a.DISBURSERCOMMENT,
                                 disburseDate = a.DISBURSEDATE,
                                 operationId = a.OPERATIONID,
                                 customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                 loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                 equityContribution = a.EQUITYCONTRIBUTION,
                                 firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                 firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                 outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                 outstandingInterest = a.OUTSTANDINGINTEREST,
                                 pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                 pastDueInterest = a.PASTDUEINTEREST,
                                 interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                 interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                 penalChargeAmount = a.PENALCHARGEAMOUNT,
                                 principalAdditionCount = a.PRINCIPALADDITIONCOUNT,
                                 principalReductionCount = a.PRINCIPALREDUCTIONCOUNT,
                                 fixedPrincipal = a.FIXEDPRINCIPAL,
                                 profileLoan = a.PROFILELOAN,
                                 dischargeLetter = a.DISCHARGELETTER,
                                 suspendInterest = a.SUSPENDINTEREST,
                                 isScheduledPrepayment = a.ISSCHEDULEDPREPAYMENT,
                                 allowForceDebitRepayment = a.ALLOWFORCEDEBITREPAYMENT,
                                 scheduledPrepaymentAmount = a.SCHEDULEDPREPAYMENTAMOUNT,
                                 scheduledPrepaymentDate = a.SCHEDULEDPREPAYMENTDATE,
                                 scheduledPrepaymentFrequencyTypeId = a.SCH_PREPAYMENT_FREQUENCY_TYPID,
                                 internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                                 externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                                 userPrudentialGuidelineStatusId = a.USER_PRUDENTIAL_GUIDE_STATUSID,
                                 nplDate = a.NPLDATE,
                                 createdBy = a.CREATEDBY,
                                 dateTimeCreated = a.DATETIMECREATED,

                             }).ToList();

                List<TBL_LOAN_ARCHIVE> loanHistory = new List<TBL_LOAN_ARCHIVE>();

                foreach (var item in model)
                {
                    TBL_LOAN_ARCHIVE addLoanHistory = new TBL_LOAN_ARCHIVE();
                    addLoanHistory.CHANGEEFFECTIVEDATE = systemDate;
                    addLoanHistory.ISAPPLIED = false;
                    addLoanHistory.CHANGEREASON = "Loan History";
                    addLoanHistory.LOANID = item.loanId;
                    addLoanHistory.PRODUCTPRICEINDEXRATE = item.productPriceIndexRate;
                    addLoanHistory.CUSTOMERRISKRATINGID = item.customerRiskRatingId;
                    addLoanHistory.LOANSYSTEMTYPEID = item.loanSystemTypeId;
                    addLoanHistory.CUSTOMERID = item.customerId;
                    addLoanHistory.PRODUCTID = item.productId;
                    addLoanHistory.COMPANYID = item.companyId;
                    addLoanHistory.CASAACCOUNTID = item.casaAccountId;
                    addLoanHistory.BRANCHID = item.branchId;
                    addLoanHistory.CURRENCYID = (short)item.currencyId;
                    addLoanHistory.EXCHANGERATE = item.exchangeRate;
                    addLoanHistory.LOANAPPLICATIONDETAILID = item.loanApplicationDetailId;
                    addLoanHistory.LOANREFERENCENUMBER = item.loanReferenceNumber;
                    addLoanHistory.SUBSECTORID = item.subSectorId;
                    addLoanHistory.PRINCIPALFREQUENCYTYPEID = item.principalFrequencyTypeId;
                    addLoanHistory.INTERESTFREQUENCYTYPEID = item.interestFrequencyTypeId;
                    addLoanHistory.PRINCIPALNUMBEROFINSTALLMENT = item.principalNumberOfInstallment;
                    addLoanHistory.INTERESTNUMBEROFINSTALLMENT = item.interestNumberOfInstallment;
                    addLoanHistory.RELATIONSHIPOFFICERID = item.relationshipOfficerId;
                    addLoanHistory.RELATIONSHIPMANAGERID = item.relationshipManagerId;
                    addLoanHistory.MISCODE = item.misCode;
                    addLoanHistory.TEAMMISCODE = item.teamMiscode;
                    addLoanHistory.INTERESTRATE = item.interestRate;
                    addLoanHistory.EFFECTIVEDATE = item.effectiveDate;
                    addLoanHistory.LASTRESTRUCTUREDATE = item.lastRestructureDate;
                    addLoanHistory.MATURITYDATE = item.maturityDate;
                    addLoanHistory.BOOKINGDATE = item.bookingDate;
                    addLoanHistory.PRINCIPALAMOUNT = item.principalAmount;
                    addLoanHistory.PRINCIPALINSTALLMENTLEFT = item.principalInstallmentLeft;
                    addLoanHistory.INTERESTINSTALLMENTLEFT = item.interestInstallmentLeft;
                    addLoanHistory.APPROVALSTATUSID = item.approvalStatusId;
                    addLoanHistory.APPROVEDBY = item.approvedBy;
                    addLoanHistory.APPROVERCOMMENT = item.approverComment;
                    addLoanHistory.DATEAPPROVED = item.dateApproved;
                    addLoanHistory.LOANSTATUSID = item.loanStatusId;
                    addLoanHistory.CREATEDBY = item.createdBy;
                    addLoanHistory.DATETIMECREATED = item.dateTimeCreated;
                    addLoanHistory.SCHEDULETYPEID = item.scheduleTypeId;
                    addLoanHistory.SCHEDULEDAYCOUNTCONVENTIONID = item.scheduleDayCountConventionId;
                    addLoanHistory.SCHEDULEDAYINTERESTTYPEID = item.scheduleDayInterestTypeId;
                    addLoanHistory.ISDISBURSED = item.isDisbursed;
                    addLoanHistory.DISBURSEDBY = item.disbursedBy;
                    addLoanHistory.DISBURSERCOMMENT = item.disburserComment;
                    addLoanHistory.DISBURSEDATE = item.disburseDate;
                    addLoanHistory.OPERATIONID = (int)item.operationId;
                    addLoanHistory.EQUITYCONTRIBUTION = item.equityContribution;
                    addLoanHistory.FIRSTPRINCIPALPAYMENTDATE = item.firstPrincipalPaymentDate;
                    addLoanHistory.FIRSTINTERESTPAYMENTDATE = item.firstInterestPaymentDate;
                    addLoanHistory.OUTSTANDINGPRINCIPAL = item.outstandingPrincipal;
                    addLoanHistory.OUTSTANDINGINTEREST = item.outstandingInterest;
                    addLoanHistory.PASTDUEPRINCIPAL = item.pastDuePrincipal;
                    addLoanHistory.PASTDUEINTEREST = item.pastDueInterest;
                    addLoanHistory.INTERESTONPASTDUEPRINCIPAL = item.interestOnPastDuePrincipal;
                    addLoanHistory.INTERESTONPASTDUEINTEREST = item.interesrtOnPastDueInterest;
                    addLoanHistory.PENALCHARGEAMOUNT = item.penalChargeAmount;
                    addLoanHistory.PRINCIPALADDITIONCOUNT = item.principalAdditionCount;
                    addLoanHistory.PRINCIPALREDUCTIONCOUNT = item.principalReductionCount;
                    addLoanHistory.FIXEDPRINCIPAL = item.fixedPrincipal;
                    addLoanHistory.PROFILELOAN = item.profileLoan;
                    addLoanHistory.DISCHARGELETTER = item.dischargeLetter;
                    addLoanHistory.SUSPENDINTEREST = item.suspendInterest;
                    addLoanHistory.ISSCHEDULEDPREPAYMENT = item.isScheduledPrepayment;
                    addLoanHistory.ALLOWFORCEDEBITREPAYMENT = item.allowForceDebitRepayment;
                    addLoanHistory.SCHEDULEDPREPAYMENTAMOUNT = item.scheduledPrepaymentAmount;
                    addLoanHistory.SCHEDULEDPREPAYMENTDATE = item.scheduledPrepaymentDate;
                    addLoanHistory.SCH_PREPAYMENT_FREQUENCY_TYPID = item.principalFrequencyTypeId;//scheduledPrepaymentFrequencyTypeId;
                    addLoanHistory.INT_PRUDENT_GUIDELINE_STATUSID = (int)item.internalPrudentialGuidelineStatusId;
                    addLoanHistory.EXT_PRUDENT_GUIDELINE_STATUSID = (int)item.externalPrudentialGuidelineStatusId;
                    addLoanHistory.USER_PRUDENTIAL_GUIDE_STATUSID = (int)item.userPrudentialGuidelineStatusId;
                    addLoanHistory.NPLDATE = item.nplDate;
                    addLoanHistory.CREATEDBY = item.createdBy;
                    addLoanHistory.DATETIMECREATED = item.dateTimeCreated;

                    loanHistory.Add(addLoanHistory);
                }
                this.context.TBL_LOAN_ARCHIVE.AddRange(loanHistory);

                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        public IEnumerable<RevolvingLoanViewModel> OverDraftHistory()
        {
            try
            {
                var systemDate = generalSetup.GetApplicationDate();
                var batchCode = CommonHelpers.GenerateRandomDigitCode(5);
                var model = (from a in context.TBL_LOAN_REVOLVING
                             where a.LOANSTATUSID == (short)LoanStatusEnum.Active
                             select new RevolvingLoanViewModel()
                             {
                                 loanId = a.REVOLVINGLOANID,
                                 loanSystemTypeId = (short)a.LOANSYSTEMTYPEID,
                                 customerId = a.CUSTOMERID,
                                 productId = a.PRODUCTID,
                                 companyId = a.COMPANYID,
                                 casaAccountId = a.CASAACCOUNTID,
                                 branchId = a.BRANCHID,
                                 currencyId = a.CURRENCYID,
                                 loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                 exchangeRate = a.EXCHANGERATE,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 relatedLoanReferenceNumber = a.RELATED_LOAN_REFERENCE_NUMBER,
                                 subSectorId = a.SUBSECTORID,
                                 relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                 relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                 misCode = a.MISCODE,
                                 teamMiscode = a.TEAMMISCODE,
                                 interestRate = a.INTERESTRATE,
                                 effectiveDate = a.EFFECTIVEDATE,
                                 maturityDate = a.MATURITYDATE,
                                 bookingDate = a.BOOKINGDATE,
                                 overdraftLimit = a.OVERDRAFTLIMIT,
                                 pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                 pastDueInterest = a.PASTDUEINTEREST,
                                 interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                 interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                 penalChargeAmount = a.PENALCHARGEAMOUNT,
                                 approvalStatusId = a.APPROVALSTATUSID,
                                 approvedBy = (int)a.APPROVEDBY,
                                 approverComment = a.APPROVERCOMMENT,
                                 dateApproved = a.DATEAPPROVED,
                                 loanStatusId = a.LOANSTATUSID,
                                 isDisbursed = a.ISDISBURSED,
                                 disbursedBy = a.DISBURSEDBY,
                                 disburserComment = a.DISBURSERCOMMENT,
                                 disburseDate = a.DISBURSEDATE,
                                 operationId = a.OPERATIONID,
                                 dischargeLetter = a.DISCHARGELETTER,
                                 suspendInterest = a.SUSPENDINTEREST,
                                 dayCountConventionId = a.DAYCOUNTCONVENTIONID,
                                 internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                                 externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                                 userPrudentialGuidelineStatusId = a.USER_PRUDENTIAL_GUIDE_STATUSID,
                                 nplDate = a.NPLDATE,
                                 createdBy = a.CREATEDBY,
                                 dateTimeCreated = a.DATETIMECREATED,

                             }).ToList();

                List<TBL_LOAN_REVOLVING_ARCHIVE> overDraftHistory = new List<TBL_LOAN_REVOLVING_ARCHIVE>();

                foreach (var item in model)
                {

                    TBL_LOAN_REVOLVING_ARCHIVE addOverDraftHistory = new TBL_LOAN_REVOLVING_ARCHIVE();

                    addOverDraftHistory.ARCHIVEDATE = systemDate;
                    addOverDraftHistory.REVOLVINGLOANID = item.loanId;
                    addOverDraftHistory.CUSTOMERID = item.customerId;
                    addOverDraftHistory.LOANSYSTEMTYPEID = item.loanSystemTypeId;
                    addOverDraftHistory.PRODUCTID = item.productId;
                    addOverDraftHistory.COMPANYID = item.companyId;
                    addOverDraftHistory.CASAACCOUNTID = item.casaAccountId;
                    addOverDraftHistory.BRANCHID = item.branchId;
                    addOverDraftHistory.CURRENCYID = item.currencyId;
                    addOverDraftHistory.LOANAPPLICATIONDETAILID = item.loanApplicationDetailId;
                    addOverDraftHistory.EXCHANGERATE = item.exchangeRate;
                    addOverDraftHistory.LOANREFERENCENUMBER = item.loanReferenceNumber;
                    addOverDraftHistory.RELATED_LOAN_REFERENCE_NUMBER = item.relatedLoanReferenceNumber;
                    addOverDraftHistory.SUBSECTORID = item.subSectorId;
                    addOverDraftHistory.RELATIONSHIPOFFICERID = item.relationshipOfficerId;
                    addOverDraftHistory.RELATIONSHIPMANAGERID = item.relationshipManagerId;
                    addOverDraftHistory.MISCODE = item.misCode;
                    addOverDraftHistory.TEAMMISCODE = item.teamMiscode;
                    addOverDraftHistory.INTERESTRATE = item.interestRate;
                    addOverDraftHistory.EFFECTIVEDATE = item.effectiveDate;
                    addOverDraftHistory.MATURITYDATE = item.maturityDate;
                    addOverDraftHistory.BOOKINGDATE = item.bookingDate;
                    addOverDraftHistory.OVERDRAFTLIMIT = item.overdraftLimit;
                    addOverDraftHistory.APPROVALSTATUSID = item.approvalStatusId;
                    addOverDraftHistory.APPROVEDBY = item.approvedBy;
                    addOverDraftHistory.APPROVERCOMMENT = item.approverComment;
                    addOverDraftHistory.DATEAPPROVED = item.dateApproved;
                    addOverDraftHistory.LOANSTATUSID = item.loanStatusId;
                    addOverDraftHistory.ISDISBURSED = item.isDisbursed;
                    addOverDraftHistory.DISBURSEDBY = item.disbursedBy;
                    addOverDraftHistory.DISBURSERCOMMENT = item.disburserComment;
                    addOverDraftHistory.DISBURSEDATE = item.disburseDate;
                    addOverDraftHistory.OPERATIONID = item.operationId;
                    addOverDraftHistory.CREATEDBY = item.createdBy;
                    addOverDraftHistory.DATETIMECREATED = item.dateTimeCreated;
                    addOverDraftHistory.DISCHARGELETTER = item.dischargeLetter;
                    addOverDraftHistory.SUSPENDINTEREST = item.suspendInterest;
                    addOverDraftHistory.DAYCOUNTCONVENTIONID = (short)item.dayCountConventionId;
                    addOverDraftHistory.INT_PRUDENT_GUIDELINE_STATUSID = (int)item.internalPrudentialGuidelineStatusId;
                    addOverDraftHistory.EXT_PRUDENT_GUIDELINE_STATUSID = (int)item.externalPrudentialGuidelineStatusId;
                    addOverDraftHistory.USER_PRUDENTIAL_GUIDE_STATUSID = (int)item.userPrudentialGuidelineStatusId;
                    addOverDraftHistory.NPLDATE = item.nplDate;
                    addOverDraftHistory.CREATEDBY = item.createdBy;
                    addOverDraftHistory.DATETIMECREATED = item.dateTimeCreated;

                    overDraftHistory.Add(addOverDraftHistory);
                }

                this.context.TBL_LOAN_REVOLVING_ARCHIVE.AddRange(overDraftHistory);

                var result = context.SaveChanges() > 0;
                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {
                throw ex;

            }

        }

        //---------------------------------- Rate Revision End-------------------------------------


        //----------------------------------Bulk Rate Revision-------------------------------------
        public IEnumerable<LoanPaymentSchedulePeriodicViewModel> BulkArchivePeriodicSchedule(int priceindexId)
        {
            var batchCode = CommonHelpers.GenerateRandomDigitCode(5);
            var model = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
                         join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                         where b.TBL_PRODUCT.TBL_PRODUCT_PRICE_INDEX.PRODUCTPRICEINDEXID == priceindexId
                         && b.LOANSTATUSID == (short)LoanStatusEnum.Active
                         && !context.TBL_LOAN_PRICEINDEX_EXCEPTION.Any(d => d.LOANID == b.TERMLOANID) // a.LoanId == loanId
                         select new LoanPaymentSchedulePeriodicViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             paymentDate = a.PAYMENTDATE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             periodPaymentAmount = (double)a.PERIODPAYMENTAMOUNT,
                             periodInterestAmount = (double)a.PERIODINTERESTAMOUNT,
                             periodPrincipalAmount = (double)a.PERIODPRINCIPALAMOUNT,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             interestRate = a.INTERESTRATE,
                             amortisedStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amortisedPeriodPaymentAmount = (double)a.AMORTISEDPERIODPAYMENTAMOUNT,
                             amortisedPeriodInterestAmount = (double)a.AMORTISEDPERIODINTERESTAMOUNT,
                             amortisedPeriodPrincipalAmount = (double)a.AMORTISEDPERIODPRINCIPALAMOUNT,
                             amortisedEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,

                         }).ToList();

            List<TBL_LOAN_SCHEDULE_PERIODIC_ARC> loanSchedulePeriodicArchive = new List<TBL_LOAN_SCHEDULE_PERIODIC_ARC>();



            foreach (var item in model)
            {

                TBL_LOAN_SCHEDULE_PERIODIC_ARC addLoanSchedulePeriodicArchive = new TBL_LOAN_SCHEDULE_PERIODIC_ARC();


                addLoanSchedulePeriodicArchive.LOANID = item.loanId;
                addLoanSchedulePeriodicArchive.PAYMENTNUMBER = item.paymentNumber;
                addLoanSchedulePeriodicArchive.PAYMENTDATE = item.paymentDate;
                addLoanSchedulePeriodicArchive.STARTPRINCIPALAMOUNT = (decimal)item.startPrincipalAmount;
                addLoanSchedulePeriodicArchive.PERIODPAYMENTAMOUNT = (decimal)item.periodPaymentAmount;
                addLoanSchedulePeriodicArchive.PERIODINTERESTAMOUNT = (decimal)item.periodInterestAmount;
                addLoanSchedulePeriodicArchive.PERIODPRINCIPALAMOUNT = (decimal)item.periodPrincipalAmount;
                addLoanSchedulePeriodicArchive.ENDPRINCIPALAMOUNT = (decimal)item.endPrincipalAmount;
                addLoanSchedulePeriodicArchive.INTERESTRATE = item.interestRate;
                addLoanSchedulePeriodicArchive.AMORTISEDSTARTPRINCIPALAMOUNT = (decimal)item.amortisedStartPrincipalAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDPERIODPAYMENTAMOUNT = (decimal)item.amortisedPeriodPaymentAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDPERIODINTERESTAMOUNT = (decimal)item.amortisedPeriodInterestAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDPERIODPRINCIPALAMOUNT = (decimal)item.amortisedPeriodPrincipalAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDENDPRINCIPALAMOUNT = (decimal)item.amortisedEndPrincipalAmount;
                addLoanSchedulePeriodicArchive.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanSchedulePeriodicArchive.CREATEDBY = item.createdBy;
                addLoanSchedulePeriodicArchive.DATETIMECREATED = item.dateTimeCreated;
                addLoanSchedulePeriodicArchive.ARCHIVEDATE = generalSetup.GetApplicationDate();
                addLoanSchedulePeriodicArchive.ARCHIVEBATCHCODE = batchCode;

                loanSchedulePeriodicArchive.Add(addLoanSchedulePeriodicArchive);

            }

            this.context.TBL_LOAN_SCHEDULE_PERIODIC_ARC.AddRange(loanSchedulePeriodicArchive);

            context.SaveChanges();
            return model;
        }

        public IEnumerable<LoanPaymentScheduleDailyViewModel> BulkArchiveDailySchedule()
        {
            var batchCode = CommonHelpers.GenerateRandomDigitCode(5);
            var model = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                         join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                         where b.LOANSTATUSID == (short)LoanStatusEnum.Active
                         && !context.TBL_LOAN_PRICEINDEX_EXCEPTION.Any(d => d.LOANID == b.TERMLOANID)
                         select new LoanPaymentScheduleDailyViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             date = a.DATE,
                             paymentDate = a.PAYMENTDATE,
                             openingBalance = (double)a.OPENINGBALANCE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             dailyPaymentAmount = (double)a.DAILYPAYMENTAMOUNT,
                             dailyInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                             dailyPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                             closingBalance = (double)a.CLOSINGBALANCE,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             amortisedCost = (double)a.AMORTISEDCOST,
                             accruedInterest = (double)a.ACCRUEDINTEREST,
                             norminalInterestRate = a.INTERESTRATE,
                             amOpeningBalance = (double)a.AMORTISEDOPENINGBALANCE,
                             amStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amDailyPaymentAmount = (double)a.AMORTISEDDAILYPAYMENTAMOUNT,
                             amDailyInterestAmount = (double)a.AMORTISEDDAILYINTERESTAMOUNT,
                             amDailyPrincipalAmount = (double)a.AMORTISEDDAILYPRINCIPALAMOUNT,
                             amClosingBalance = (double)a.AMORTISEDCLOSINGBALANCE,
                             amEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             amAccruedInterest = (double)a.AMORTISEDACCRUEDINTEREST,
                             amAmortisedCost = (double)a.AMORTISED_AMORTISEDCOST,
                             discountPremium = (double)a.DISCOUNTPREMIUM,
                             unEarnedFee = (double)a.UNEARNEDFEE,
                             earnedFee = (double)a.EARNEDFEE,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             numberOfPeriods = a.NUMBEROFPERIODS,
                             ballonAmount = (double)a.BALLONAMOUNT,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,


                         }).ToList();

            List<TBL_LOAN_SCHEDULE_DAILY_ARCHIV> loanScheduleDailyArchive = new List<TBL_LOAN_SCHEDULE_DAILY_ARCHIV>();

            foreach (var item in model)
            {
                TBL_LOAN_SCHEDULE_DAILY_ARCHIV addLoanScheduleDailyArchive = new TBL_LOAN_SCHEDULE_DAILY_ARCHIV();

                addLoanScheduleDailyArchive.LOANID = item.loanId;
                addLoanScheduleDailyArchive.PAYMENTNUMBER = item.paymentNumber;
                addLoanScheduleDailyArchive.DATE = item.date;
                addLoanScheduleDailyArchive.PAYMENTDATE = item.paymentDate;
                addLoanScheduleDailyArchive.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                addLoanScheduleDailyArchive.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                addLoanScheduleDailyArchive.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                addLoanScheduleDailyArchive.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                addLoanScheduleDailyArchive.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                addLoanScheduleDailyArchive.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                addLoanScheduleDailyArchive.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                addLoanScheduleDailyArchive.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                addLoanScheduleDailyArchive.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                addLoanScheduleDailyArchive.INTERESTRATE = item.norminalInterestRate;
                addLoanScheduleDailyArchive.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                addLoanScheduleDailyArchive.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                addLoanScheduleDailyArchive.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                addLoanScheduleDailyArchive.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                addLoanScheduleDailyArchive.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                addLoanScheduleDailyArchive.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                addLoanScheduleDailyArchive.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                addLoanScheduleDailyArchive.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                addLoanScheduleDailyArchive.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                addLoanScheduleDailyArchive.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                addLoanScheduleDailyArchive.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                addLoanScheduleDailyArchive.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                addLoanScheduleDailyArchive.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanScheduleDailyArchive.NUMBEROFPERIODS = item.numberOfPeriods;
                addLoanScheduleDailyArchive.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                addLoanScheduleDailyArchive.CREATEDBY = item.createdBy;
                addLoanScheduleDailyArchive.DATETIMECREATED = item.dateTimeCreated;
                addLoanScheduleDailyArchive.ARCHIVEDATE = generalSetup.GetApplicationDate();
                addLoanScheduleDailyArchive.ARCHIVEBATCHCODE = batchCode;

                loanScheduleDailyArchive.Add(addLoanScheduleDailyArchive);

            }

            this.context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV.AddRange(loanScheduleDailyArchive);

            context.SaveChanges();
            return model;
        }

        public IEnumerable<LoanViewModel> BulkArchiveLoan()
        {
            var batchCode = CommonHelpers.GenerateRandomDigitCode(5);
            var model = (from a in context.TBL_LOAN
                         where a.LOANSTATUSID == (short)LoanStatusEnum.Active
                          && !context.TBL_LOAN_PRICEINDEX_EXCEPTION.Any(d => d.LOANID == a.TERMLOANID)
                         select new LoanViewModel()
                         {
                             loanId = a.TERMLOANID,
                             productPriceIndexRate = a.PRODUCTPRICEINDEXRATE,
                             customerRiskRatingId = a.CUSTOMERRISKRATINGID,
                             customerId = a.CUSTOMERID,
                             productId = a.PRODUCTID,
                             companyId = a.COMPANYID,
                             casaAccountId = a.CASAACCOUNTID,
                             branchId = a.BRANCHID,
                             currencyId = a.CURRENCYID,
                             exchangeRate = a.EXCHANGERATE,
                             loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                             loanReferenceNumber = a.LOANREFERENCENUMBER,
                             subSectorId = a.SUBSECTORID,
                             principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID,
                             interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID,
                             principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                             interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                             relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                             relationshipManagerId = a.RELATIONSHIPMANAGERID,
                             misCode = a.MISCODE,
                             teamMiscode = a.TEAMMISCODE,
                             interestRate = a.INTERESTRATE,
                             effectiveDate = a.EFFECTIVEDATE,
                             maturityDate = a.MATURITYDATE,
                             bookingDate = a.BOOKINGDATE,
                             principalAmount = a.PRINCIPALAMOUNT,
                             principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                             interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                             approvalStatusId = a.APPROVALSTATUSID,
                             approvedBy = a.APPROVEDBY,
                             approverComment = a.APPROVERCOMMENT,
                             dateApproved = a.DATEAPPROVED,
                             loanStatusId = a.LOANSTATUSID,
                             scheduleTypeId = a.SCHEDULETYPEID,
                             scheduleDayCountConventionId = a.SCHEDULEDAYCOUNTCONVENTIONID,
                             scheduleDayInterestTypeId = a.SCHEDULEDAYINTERESTTYPEID,
                             isDisbursed = a.ISDISBURSED,
                             disbursedBy = a.DISBURSEDBY,
                             disburserComment = a.DISBURSERCOMMENT,
                             disburseDate = a.DISBURSEDATE,
                             operationId = a.OPERATIONID,
                             customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                             loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                             equityContribution = a.EQUITYCONTRIBUTION,
                             firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                             firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                             outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                             outstandingInterest = a.OUTSTANDINGINTEREST,
                             principalAdditionCount = a.PRINCIPALADDITIONCOUNT,
                             principalReductionCount = a.PRINCIPALREDUCTIONCOUNT,
                             fixedPrincipal = a.FIXEDPRINCIPAL,
                             profileLoan = a.PROFILELOAN,
                             dischargeLetter = a.DISCHARGELETTER,
                             suspendInterest = a.SUSPENDINTEREST,
                             isScheduledPrepayment = a.ISSCHEDULEDPREPAYMENT,
                             allowForceDebitRepayment = a.ALLOWFORCEDEBITREPAYMENT,
                             scheduledPrepaymentAmount = a.SCHEDULEDPREPAYMENTAMOUNT,
                             scheduledPrepaymentDate = a.SCHEDULEDPREPAYMENTDATE,
                             scheduledPrepaymentFrequencyTypeId = a.SCH_PREPAYMENT_FREQUENCY_TYPID,
                             internalPrudentialGuidelineStatusId = a.INT_PRUDENT_GUIDELINE_STATUSID,
                             externalPrudentialGuidelineStatusId = a.EXT_PRUDENT_GUIDELINE_STATUSID,
                             nplDate = a.NPLDATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,

                         }).ToList();

            List<TBL_LOAN_ARCHIVE> loanArchive = new List<TBL_LOAN_ARCHIVE>();

            foreach (var item in model)
            {
                TBL_LOAN_ARCHIVE addLoanArchive = new TBL_LOAN_ARCHIVE();

                addLoanArchive.CHANGEEFFECTIVEDATE = DateTime.Today;
                addLoanArchive.ISAPPLIED = false;
                addLoanArchive.CHANGEREASON = "Rephasement";
                addLoanArchive.LOANID = item.loanId;
                addLoanArchive.PRODUCTPRICEINDEXRATE = item.productPriceIndexRate;
                addLoanArchive.CUSTOMERRISKRATINGID = item.customerRiskRatingId;
                addLoanArchive.CUSTOMERID = item.customerId;
                addLoanArchive.PRODUCTID = item.productId;
                addLoanArchive.COMPANYID = item.companyId;
                addLoanArchive.CASAACCOUNTID = item.casaAccountId;
                addLoanArchive.BRANCHID = item.branchId;
                addLoanArchive.CURRENCYID = (short)item.currencyId;
                addLoanArchive.EXCHANGERATE = item.exchangeRate;
                addLoanArchive.LOANAPPLICATIONDETAILID = item.loanApplicationDetailId;
                addLoanArchive.LOANREFERENCENUMBER = item.loanReferenceNumber;
                addLoanArchive.SUBSECTORID = item.subSectorId;
                addLoanArchive.PRINCIPALFREQUENCYTYPEID = item.principalFrequencyTypeId;
                addLoanArchive.INTERESTFREQUENCYTYPEID = item.interestFrequencyTypeId;
                addLoanArchive.PRINCIPALNUMBEROFINSTALLMENT = item.principalNumberOfInstallment;
                addLoanArchive.INTERESTNUMBEROFINSTALLMENT = item.interestNumberOfInstallment;
                addLoanArchive.RELATIONSHIPOFFICERID = item.relationshipOfficerId;
                addLoanArchive.RELATIONSHIPMANAGERID = item.relationshipManagerId;
                addLoanArchive.MISCODE = item.misCode;
                addLoanArchive.TEAMMISCODE = item.teamMiscode;
                addLoanArchive.INTERESTRATE = item.interestRate;
                addLoanArchive.EFFECTIVEDATE = item.effectiveDate;
                addLoanArchive.MATURITYDATE = item.maturityDate;
                addLoanArchive.BOOKINGDATE = item.bookingDate;
                addLoanArchive.PRINCIPALAMOUNT = item.principalAmount;
                addLoanArchive.PRINCIPALINSTALLMENTLEFT = item.principalInstallmentLeft;
                addLoanArchive.INTERESTINSTALLMENTLEFT = item.interestInstallmentLeft;
                addLoanArchive.APPROVALSTATUSID = item.approvalStatusId;
                addLoanArchive.APPROVEDBY = item.approvedBy;
                addLoanArchive.APPROVERCOMMENT = item.approverComment;
                addLoanArchive.DATEAPPROVED = item.dateApproved;
                addLoanArchive.LOANSTATUSID = item.loanStatusId;
                addLoanArchive.CREATEDBY = item.createdBy;
                addLoanArchive.DATETIMECREATED = item.dateTimeCreated;
                addLoanArchive.SCHEDULETYPEID = item.scheduleTypeId;
                addLoanArchive.SCHEDULEDAYCOUNTCONVENTIONID = item.scheduleDayCountConventionId;
                addLoanArchive.SCHEDULEDAYINTERESTTYPEID = item.scheduleDayInterestTypeId;
                addLoanArchive.ISDISBURSED = item.isDisbursed;
                addLoanArchive.DISBURSEDBY = item.disbursedBy;
                addLoanArchive.DISBURSERCOMMENT = item.disburserComment;
                addLoanArchive.DISBURSEDATE = item.disburseDate;
                addLoanArchive.OPERATIONID = (int)item.operationId;
                addLoanArchive.EQUITYCONTRIBUTION = item.equityContribution;
                addLoanArchive.FIRSTPRINCIPALPAYMENTDATE = item.firstPrincipalPaymentDate;
                addLoanArchive.FIRSTINTERESTPAYMENTDATE = item.firstInterestPaymentDate;
                addLoanArchive.OUTSTANDINGPRINCIPAL = item.outstandingPrincipal;
                addLoanArchive.OUTSTANDINGINTEREST = item.outstandingInterest;
                addLoanArchive.PRINCIPALADDITIONCOUNT = item.principalAdditionCount;
                addLoanArchive.PRINCIPALREDUCTIONCOUNT = item.principalReductionCount;
                addLoanArchive.FIXEDPRINCIPAL = item.fixedPrincipal;
                addLoanArchive.PROFILELOAN = item.profileLoan;
                addLoanArchive.DISCHARGELETTER = item.dischargeLetter;
                addLoanArchive.SUSPENDINTEREST = item.suspendInterest;
                addLoanArchive.ISSCHEDULEDPREPAYMENT = item.isScheduledPrepayment;
                addLoanArchive.ALLOWFORCEDEBITREPAYMENT = item.allowForceDebitRepayment;
                addLoanArchive.SCHEDULEDPREPAYMENTAMOUNT = item.scheduledPrepaymentAmount;
                addLoanArchive.SCHEDULEDPREPAYMENTDATE = item.scheduledPrepaymentDate;
                addLoanArchive.SCH_PREPAYMENT_FREQUENCY_TYPID = item.principalFrequencyTypeId;//scheduledPrepaymentFrequencyTypeId;
                addLoanArchive.INT_PRUDENT_GUIDELINE_STATUSID = 1; //item.internalPrudentialGuidelineStatusId;
                addLoanArchive.EXT_PRUDENT_GUIDELINE_STATUSID = 1; //item.externalPrudentialGuidelineStatusId;
                addLoanArchive.NPLDATE = item.nplDate;
                addLoanArchive.CREATEDBY = item.createdBy;
                addLoanArchive.DATETIMECREATED = item.dateTimeCreated;

                loanArchive.Add(addLoanArchive);

            }

            this.context.TBL_LOAN_ARCHIVE.AddRange(loanArchive);

            context.SaveChanges();
            return model;
        }

        [OperationBehavior(TransactionScopeRequired = true)]////Review This Method
        public bool BulkRateReview(short priceindexId, double newRate, DateTime applicationDate, int staffId, int operationId)
        {
            bool output = false;

            var currentRate = this.context.TBL_PRODUCT_PRICE_INDEX.Where(x => x.PRODUCTPRICEINDEXID == priceindexId).FirstOrDefault().PRICEINDEXRATE;

            var rateChange = newRate - currentRate;

            var model = (
                         from a in context.TBL_LOAN
                         where a.TBL_PRODUCT.TBL_PRODUCT_PRICE_INDEX.PRODUCTPRICEINDEXID == priceindexId
                         && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                         && applicationDate < a.MATURITYDATE && a.FIRSTINTERESTPAYMENTDATE < a.MATURITYDATE && a.FIRSTPRINCIPALPAYMENTDATE < a.MATURITYDATE
                         && !context.TBL_LOAN_PRICEINDEX_EXCEPTION.Any(d => d.LOANID == a.TERMLOANID)
                         orderby a.TERMLOANID
                         select new LoanPaymentRestructureScheduleInputViewModel()
                         {
                             loanId = a.TERMLOANID,
                             scheduleMethodId = a.SCHEDULETYPEID,
                             principalAmount = (double)a.OUTSTANDINGPRINCIPAL,
                             principalFrequency = (short)a.PRINCIPALFREQUENCYTYPEID,
                             interestFrequency = (short)a.INTERESTFREQUENCYTYPEID,
                             newEffectiveDate = applicationDate,
                             principalFirstpaymentDate = (DateTime)a.FIRSTPRINCIPALPAYMENTDATE,
                             interestFirstpaymentDate = (DateTime)a.FIRSTINTERESTPAYMENTDATE,
                             interestRate = a.INTERESTRATE + rateChange,
                             effectiveDate = applicationDate,
                             maturityDate = a.MATURITYDATE,
                             accrualBasis = a.SCHEDULEDAYCOUNTCONVENTIONID,
                             firstDayType = a.SCHEDULEDAYINTERESTTYPEID,
                             integralFeeAmount = 0,
                             operationId = operationId,
                         }).ToList();

            foreach (var item in model)
            {
                var unEarnedFee = from d in context.TBL_LOAN_SCHEDULE_DAILY
                                  where d.LOANID == item.loanId
                                  let sumUnEarnedFee = context.TBL_LOAN_SCHEDULE_DAILY.Where(a => a.LOANID == item.loanId
                                  && a.DATE >= DbFunctions.TruncateTime(applicationDate)).Sum(a => (double?)a.UNEARNEDFEE ?? 0)
                                  select sumUnEarnedFee;

                var firstPrinDate = this.context.TBL_LOAN.Where(x => x.TERMLOANID == item.loanId).FirstOrDefault().FIRSTPRINCIPALPAYMENTDATE.Value;
                var effectiveDate = this.context.TBL_LOAN.Where(x => x.TERMLOANID == item.loanId).FirstOrDefault().EFFECTIVEDATE;
                var firstIntDate = this.context.TBL_LOAN.Where(x => x.TERMLOANID == item.loanId).FirstOrDefault().FIRSTINTERESTPAYMENTDATE.Value;
                int pricDateDiff = (firstPrinDate - effectiveDate).Days;
                int intDateDiff = (firstIntDate - effectiveDate).Days;
                item.principalFirstpaymentDate = applicationDate.AddDays(pricDateDiff);
                item.interestFirstpaymentDate = applicationDate.AddDays(intDateDiff);

                InterestRateReview((int)item.loanId, item, applicationDate, staffId);


            }

            context.SaveChanges();
            //---------------------------------------------.----------
            output = true;

            return output;
        }
        //----------------------------------Bulk Rate Revision End-------------------------------------
        public void updateloanTableStatus(int loanId)
        {
            TBL_LOAN result = (from p in context.TBL_LOAN
                               where p.TERMLOANID == loanId
                               select p).SingleOrDefault();

            result.LOANSTATUSID = (short)LoanStatusEnum.Completed;



            context.SaveChanges();
        }

        public void updateLoanReviewOperation(int loanReviewOperationsId, int loanId)
        {

            var systemDate = generalSetup.GetApplicationDate();

            TBL_LOAN_REVIEW_OPERATION result = (from p in context.TBL_LOAN_REVIEW_OPERATION
                                                where p.LOANID == loanId && p.LOANREVIEWOPERATIONID == loanReviewOperationsId
                                                select p).SingleOrDefault();

            result.OPERATIONDATE = systemDate;
            result.OPERATIONCOMPLETED = true;

            context.SaveChanges();
        }

        public void updateLoanPrincipalInterestPaymentDate(DateTime firstPrincipalPaymentDate, DateTime firstInterestPaymentDate, int loanId)
        {
            TBL_LOAN result = (from p in context.TBL_LOAN
                               where p.TERMLOANID == loanId //&& p.FIRSTINTERESTPAYMENTDATE == firstPrincipalPaymentDate && p.FIRSTINTERESTPAYMENTDATE == firstInterestPaymentDate
                               select p).SingleOrDefault();

            result.FIRSTINTERESTPAYMENTDATE = firstInterestPaymentDate;
            result.FIRSTPRINCIPALPAYMENTDATE = firstPrincipalPaymentDate;



            context.SaveChanges();
        }

        public void updateLoanFrequency(short PrincipalFrequency, short InterestFrequency, int loanId)
        {
            TBL_LOAN result = (from p in context.TBL_LOAN
                               where p.TERMLOANID == loanId //&& p.FIRSTINTERESTPAYMENTDATE == firstPrincipalPaymentDate && p.FIRSTINTERESTPAYMENTDATE == firstInterestPaymentDate
                               select p).SingleOrDefault();

            result.PRINCIPALFREQUENCYTYPEID = PrincipalFrequency;
            result.INTERESTFREQUENCYTYPEID = InterestFrequency;
            context.SaveChanges();
        }

        public bool ProcessLoanPrepayment(TwoFactorAutheticationViewModel twoFactorAuth, int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId, int loanReviewOperationsId)
        {
            bool output = false;
            loanInput.isExistingFacility = true;
            //double penalAmount = 0;
            try

            {
                var systemDate = generalSetup.GetApplicationDate();
                //var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();
                var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == loanReviewOperationsId).FirstOrDefault();
                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                //var penalCharge = context.TBL_CHARGE_FEE.FirstOrDefault(x => x.OPERATIONID == (int)OperationsEnum.Prepayment);
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
                decimal principalOutStandingBalance = loan.OUTSTANDINGPRINCIPAL;
                //decimal accruedInterest = 0;
                //var accrued = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                //               where a.TBL_LOAN.TERMLOANID == loanId && a.DATE == applicationDate
                //               select a).FirstOrDefault();

                //if(accrued != null)
                //{
                //    accruedInterest = accrued.ACCRUEDINTEREST;
                //}
                //else
                //{
                //    throw new SecureException("Application Date not found in Payment Schedule");
                //}
                //accruedInterest = decimal.Round(accruedInterest, 2, MidpointRounding.AwayFromZero);
                principalOutStandingBalance = decimal.Round(principalOutStandingBalance, 2, MidpointRounding.AwayFromZero);
                //decimal pastDue = decimal.Round((loan.PASTDUEINTEREST + loan.INTERESTONPASTDUEINTEREST + loan.INTERESTONPASTDUEPRINCIPAL), 2, MidpointRounding.AwayFromZero);
                decimal totalamount = (principalOutStandingBalance);
                //if (penalCharge == null)
                //{
                //    penalAmount = 0;
                //}

                //decimal partPayment = (decimal)loanInput.payAmount - (pastDue);

                int value = product.INTERESTRECEIVABLEPAYABLEGL.Value;


                //if (loanInput.payAmount >= (double)(totalamount))
                //{
                //    List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                //    //inputTransactions.Add(financeTransaction.PostBuildLoanPrepaymentFeePosting(loanInput, (decimal)penalAmount, penalCharge.CHARGEFEEID, "Penal Charge", (int)OperationsEnum.Prepayment));///change to charge GL

                //    //if (pastDue != 0)
                //    //{
                //    //    inputTransactions.AddRange(financeTransaction.BuildLoanPrepaymentPosting(loanInput, twoFactorAuth, pastDue, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Past Due Interest", (int)OperationsEnum.InterestPastDueLoanRepayment));

                //    //}
                //    //inputTransactions.Add(financeTransaction.PostBuildLoanPrepaymentPosting(loanInput, twoFactorAuth, accruedInterest, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest", (int)OperationsEnum.InterestLoanRepayment));

                //    inputTransactions.AddRange(financeTransaction.BuildLoanPrepaymentPosting(loanInput, twoFactorAuth, principalOutStandingBalance, product.PRINCIPALBALANCEGL.Value, "Principal Amount Prepayment", (int)OperationsEnum.PrincipalLoanRepayment));

                //    financeTransaction.PostTransaction(inputTransactions, false, twoFactorAuth);

                //    //updateloanTableStatus(loanInput.loanId);
                //}
                //else
                //{
                List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                // inputTransactions.Add(financeTransaction.PostBuildLoanPrepaymentFeePosting(loanInput, (decimal)penalAmount, penalCharge.CHARGEFEEID, "Penal Charge", (int)OperationsEnum.Prepayment));///change to charge GL

                //if (pastDue != 0)
                //{
                //    inputTransactions.AddRange(financeTransaction.BuildLoanPrepaymentPosting(loanInput, twoFactorAuth, pastDue, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Past Due Interest", (int)OperationsEnum.InterestPastDueLoanRepayment));
                //}
                //inputTransactions.Add(financeTransaction.PostBuildLoanPrepaymentPosting(loanInput, twoFactorAuth, accruedInterest, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest", (int)OperationsEnum.InterestLoanRepayment));


                inputTransactions.AddRange(financeTransaction.BuildLoanPrepaymentPosting(loanInput, twoFactorAuth, (decimal)loanInput.payAmount, product.PRINCIPALBALANCEGL.Value, "Principal Amount Prepayment", (int)OperationsEnum.PrincipalLoanRepayment));
                financeTransaction.PostTransaction(inputTransactions, false, twoFactorAuth);


                if (LoanExist(loanId) > 0)
                {
                    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
                    DeleteLoanExist(loanId, systemDate);
                    ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
                    ArchivePeriodicSchedule(loanId, archiveBatchCode);
                    ArchiveDailySchedule(loanId, archiveBatchCode);

                    loanInput.principalAmount = ((double)totalamount - (double)loanInput.payAmount);


                    //---------------save irregular loan schedule input---------------------------
                    List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
                    LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
                    if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                    {
                        var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                        foreach (var item in data)
                        {
                            TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
                            schedule.LOANREVIEWOPERATIONID = loanId;
                            schedule.PAYMENTDATE = item.paymentDate;
                            schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                            schedule.CREATEDBY = staffId;
                            schedule.DATETIMECREATED = applicationDate;

                            tblIrregularSchedule.Add(schedule);
                        }

                    }
                    //----------------------------------------------


                    //----------generate and save periodic loan schedule -----------------------------------

                    //loanInput.principalAmount = loanInput.newAmount;
                    LoanPaymentScheduleInputViewModel loanSheduleInput = loanInput;
                    loanSheduleInput.equityContribution = loanInput.payAmount;
                    loanSheduleInput.loanId = loanId;


                    if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                    {
                        List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = GeneratePrepaymentSchedule(loanSheduleInput);  //loanSchedule.GeneratePeriodicLoanSchedule(loanInput); 
                        List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();

                        foreach (var item in periodicScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.INTERESTRATE = loanInput.interestRate;

                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblPeriodicScheduleTemp.Add(scheduleTemp);
                        }
                        //-------------------------------------------------------------------------------------

                        //----------generate and save daily loan schedule -----------------------------------

                        //loanInput.principalAmount = loanInput.newAmount;
                        List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

                        foreach (var item in dailyScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.DATE = item.date;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                            scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                            scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                            scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                            scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                            scheduleTemp.INTERESTRATE = item.norminalInterestRate;
                            scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                            scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                            scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                            scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                            scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                            scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                            scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                            scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                            scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                            scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
                            scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblDailyScheduleTemp.Add(scheduleTemp);
                        }
                        //----------------------------------------------------------------

                        //------------adding records to the database--------------------------

                        //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        //{ this.context.tbl_Loan_Review_Operation_Irregular_Schedule.AddRange(tblIrregularSchedule); }////change to Temp table


                        this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

                        this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table

                        context.SaveChanges();



                        MergePeriodicSchedule(loanId, applicationDate);
                        MergeDailySchedule(loanId, applicationDate);

                        var outstInterest = from d in context.TBL_LOAN_SCHEDULE_PERIODIC_TMP
                                            where d.LOANID == loanId
                                            let sumPrincipalAmount = context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.Where(a => a.LOANID == loanId).Sum(a => a.PERIODINTERESTAMOUNT)
                                            select sumPrincipalAmount;
                        var outstandingInterest = outstInterest.FirstOrDefault();
                        //----------update loan details -----------------------------------
                        //var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;

                        loan.OUTSTANDINGPRINCIPAL = loan.OUTSTANDINGPRINCIPAL - (decimal)loanInput.payAmount;

                        loan.OUTSTANDINGINTEREST = outstandingInterest;
                        loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
                        loan.PASTDUEPRINCIPAL = 0;
                        loan.PASTDUEINTEREST = 0;
                        loan.INTERESTONPASTDUEINTEREST = 0;
                        loan.INTERESTONPASTDUEPRINCIPAL = 0;
                        //-------------------------------------------------

                    }
                    else
                    {
                        List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = GeneratePrepaymentSchedule(loanSheduleInput);  //loanSchedule.GeneratePeriodicLoanSchedule(loanInput); 
                        List<TBL_LOAN_SCHEDULE_PERIODIC> tblPeriodicSchedule = new List<TBL_LOAN_SCHEDULE_PERIODIC>();

                        foreach (var item in periodicSchedule)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC schedule = new TBL_LOAN_SCHEDULE_PERIODIC();

                            schedule.LOANID = loanId;
                            schedule.PAYMENTNUMBER = item.paymentNumber;
                            schedule.PAYMENTDATE = item.paymentDate;
                            schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            schedule.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            schedule.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            schedule.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            schedule.INTERESTRATE = loanInput.interestRate;

                            schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            schedule.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            schedule.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            schedule.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            schedule.CREATEDBY = staffId;
                            schedule.DATETIMECREATED = systemDate;

                            tblPeriodicSchedule.Add(schedule);
                        }
                        //-------------------------------------------------------------------------------------

                        //----------generate and save daily loan schedule -----------------------------------

                        //loanInput.principalAmount = loanInput.newAmount;

                        List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        MergeDailyScheduleNew(loanId, applicationDate, dailySchedule);

                        var itemToRemovePeriodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                                                    where p.LOANID == loanId
                                                    select p);

                        if (itemToRemovePeriodic != null)
                        {
                            context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemovePeriodic);
                            context.SaveChanges();
                        }


                        //var itemToRemoveDaily = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                        //                         where p.LOANID == loanId
                        //                         select p);

                        //if (itemToRemoveDaily != null)
                        //{
                        //    context.TBL_LOAN_SCHEDULE_DAILY.RemoveRange(itemToRemoveDaily);
                        //    context.SaveChanges();
                        //}




                        this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule);////change to Temp table

                        //this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(tblDailySchedule); ////change to Temp table

                        context.SaveChanges();

                        var outstInterest = from d in context.TBL_LOAN_SCHEDULE_PERIODIC
                                            where d.LOANID == loanId
                                            let sumPrincipalAmount = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(a => a.LOANID == loanId).Sum(a => a.PERIODINTERESTAMOUNT)
                                            select sumPrincipalAmount;
                        var outstandingInterest = outstInterest.FirstOrDefault();
                        //----------update loan details -----------------------------------
                        //var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;

                        loan.OUTSTANDINGPRINCIPAL = loan.OUTSTANDINGPRINCIPAL - (decimal)loanInput.payAmount;

                        loan.OUTSTANDINGINTEREST = outstandingInterest;
                        loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
                        loan.PASTDUEPRINCIPAL = 0;
                        loan.PASTDUEINTEREST = 0;
                        loan.INTERESTONPASTDUEINTEREST = 0;
                        loan.INTERESTONPASTDUEPRINCIPAL = 0;
                        //-------------------------------------------------

                    }

                }


                //}

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (BadLogicException be)
            {
                throw new BadLogicException(be.Message);
            }
            catch (ConditionNotMetException ce)
            {
                throw new ConditionNotMetException(ce.Message);
            }
            catch (APIErrorException ae)
            {
                throw new APIErrorException(ae.Message);
            }
            catch (TwoFactorAuthenticationException fa)
            {
                throw new TwoFactorAuthenticationException(fa.Message);
            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;

        }

        public bool PaymentFrequencyChange(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        {
            bool output = false;
            try
            {
                loanInput.interestFrequencyTypeId = loanInput.newInterestFrequency;
                loanInput.principalFrequencyTypeId = loanInput.newPrincipalFrequency;

                var systemDate = generalSetup.GetApplicationDate();
                var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();

                if (LoanExist(loanId) > 0)
                {
                    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
                    DeleteLoanExist(loanId, systemDate);
                    ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
                    ArchivePeriodicSchedule(loanId, archiveBatchCode);
                    ArchiveDailySchedule(loanId, archiveBatchCode);




                    if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                    {
                        //---------------save irregular loan schedule input---------------------------
                        List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
                        LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
                        if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        {
                            var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                            foreach (var item in data)
                            {
                                TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
                                schedule.LOANREVIEWOPERATIONID = reviewData.LOANREVIEWOPERATIONID;
                                schedule.PAYMENTDATE = item.paymentDate;
                                schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                                schedule.CREATEDBY = staffId;
                                schedule.DATETIMECREATED = applicationDate;

                                tblIrregularSchedule.Add(schedule);
                            }

                        }
                        //----------------------------------------------

                        //----------generate and save periodic loan schedule -----------------------------------

                        loanInput.principalFrequency = (short)loanInput.newPrincipalFrequency;
                        loanInput.interestFrequency = (short)loanInput.newInterestFrequency;

                        List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();
                        foreach (var item in periodicScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.INTERESTRATE = loanInput.interestRate;
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblPeriodicScheduleTemp.Add(scheduleTemp);
                        }
                        //-------------------------------------------------------------------------------------

                        //----------generate and save daily loan schedule -----------------------------------

                        //loanInput.principalAmount = loanInput.newAmount;
                        List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

                        foreach (var item in dailyScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.DATE = item.date;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                            scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                            scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                            scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                            scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                            scheduleTemp.INTERESTRATE = item.norminalInterestRate;
                            scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                            scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                            scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                            scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                            scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                            scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                            scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                            scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                            scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                            scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
                            scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblDailyScheduleTemp.Add(scheduleTemp);
                        }
                        //----------------------------------------------------------------


                        //------------adding records to the database--------------------------

                        //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table

                        this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

                        this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
                        context.SaveChanges();

                        MergeDailySchedule(loanId, applicationDate);
                        MergePeriodicSchedule(loanId, applicationDate);

                        //----------update loan details -----------------------------------
                        var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                        loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;

                        if (loanInput.operationId == (short)OperationsEnum.InterestandPrincipalFrequencyChange)
                        {
                            loan.INTERESTFREQUENCYTYPEID = (short)reviewData.INTERESTFREQUENCYTYPEID;
                            loan.PRINCIPALFREQUENCYTYPEID = (short)reviewData.PRINCIPALFREQUENCYTYPEID;
                        }
                        else if (loanInput.operationId == (short)OperationsEnum.InterestFrequencyChange)
                        {
                            loan.INTERESTFREQUENCYTYPEID = (short)reviewData.INTERESTFREQUENCYTYPEID;
                        }
                        else
                        {
                            loan.PRINCIPALFREQUENCYTYPEID = (short)reviewData.PRINCIPALFREQUENCYTYPEID;
                        }
                        //-------------------------------------------------------

                    }
                    else
                    {
                        //---------------save irregular loan schedule input---------------------------
                        List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
                        LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
                        if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        {
                            var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                            foreach (var item in data)
                            {
                                TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
                                schedule.LOANREVIEWOPERATIONID = reviewData.LOANREVIEWOPERATIONID;
                                schedule.PAYMENTDATE = item.paymentDate;
                                schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                                schedule.CREATEDBY = staffId;
                                schedule.DATETIMECREATED = applicationDate;

                                tblIrregularSchedule.Add(schedule);
                            }

                        }
                        //----------------------------------------------

                        //----------generate and save periodic loan schedule -----------------------------------

                        loanInput.principalFrequency = (short)loanInput.newPrincipalFrequency;
                        loanInput.interestFrequency = (short)loanInput.newInterestFrequency;

                        List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_PERIODIC> tblPeriodicSchedule = new List<TBL_LOAN_SCHEDULE_PERIODIC>();
                        foreach (var item in periodicSchedule)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC schedule = new TBL_LOAN_SCHEDULE_PERIODIC();

                            schedule.LOANID = loanId;
                            schedule.PAYMENTNUMBER = item.paymentNumber;
                            schedule.PAYMENTDATE = item.paymentDate;
                            schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            schedule.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            schedule.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            schedule.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            schedule.INTERESTRATE = loanInput.interestRate;
                            schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            schedule.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            schedule.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            schedule.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            schedule.CREATEDBY = staffId;
                            schedule.DATETIMECREATED = systemDate;

                            tblPeriodicSchedule.Add(schedule);
                        }
                        //-------------------------------------------------------------------------------------

                        //----------generate and save daily loan schedule -----------------------------------
                        List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        MergeDailyScheduleNew(loanId, applicationDate, dailySchedule);

                        var itemToRemovePeriodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                                                    where p.LOANID == loanId
                                                    select p);

                        if (itemToRemovePeriodic != null)
                        {
                            context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemovePeriodic);
                            context.SaveChanges();
                        }

                        this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule); ////change to Temp table
                        context.SaveChanges();

                        ////loanInput.principalAmount = loanInput.newAmount;
                        //List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        //List<TBL_LOAN_SCHEDULE_DAILY> tblDailySchedule = new List<TBL_LOAN_SCHEDULE_DAILY>();

                        //foreach (var item in dailySchedule)
                        //{
                        //    TBL_LOAN_SCHEDULE_DAILY schedule = new TBL_LOAN_SCHEDULE_DAILY();

                        //    schedule.LOANID = loanId;
                        //    schedule.PAYMENTNUMBER = item.paymentNumber;
                        //    schedule.DATE = item.date;
                        //    schedule.PAYMENTDATE = item.paymentDate;
                        //    schedule.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                        //    schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                        //    schedule.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                        //    schedule.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                        //    schedule.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                        //    schedule.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                        //    schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                        //    schedule.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                        //    schedule.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                        //    schedule.INTERESTRATE = item.norminalInterestRate;
                        //    schedule.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                        //    schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                        //    schedule.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                        //    schedule.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                        //    schedule.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                        //    schedule.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                        //    schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                        //    schedule.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                        //    schedule.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                        //    schedule.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                        //    schedule.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                        //    schedule.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                        //    schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                        //    schedule.NUMBEROFPERIODS = item.numberOfPeriods;
                        //    schedule.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                        //    schedule.CREATEDBY = staffId;
                        //    schedule.DATETIMECREATED = systemDate;

                        //    tblDailySchedule.Add(schedule);
                        //}
                        ////----------------------------------------------------------------


                        ////------------adding records to the database--------------------------

                        ////if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        ////{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table

                        //this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule);////change to Temp table

                        //this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(tblDailySchedule); ////change to Temp table
                        //context.SaveChanges();

                        //MergeDailySchedule(loanId, applicationDate);
                        //MergePeriodicSchedule(loanId, applicationDate);

                        //----------update loan details -----------------------------------
                        var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        //loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                        loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;

                        if (loanInput.operationId == (short)OperationsEnum.InterestandPrincipalFrequencyChange)
                        {
                            loan.INTERESTFREQUENCYTYPEID = (short)reviewData.INTERESTFREQUENCYTYPEID;
                            loan.PRINCIPALFREQUENCYTYPEID = (short)reviewData.PRINCIPALFREQUENCYTYPEID;
                        }
                        else if (loanInput.operationId == (short)OperationsEnum.InterestFrequencyChange)
                        {
                            loan.INTERESTFREQUENCYTYPEID = (short)reviewData.INTERESTFREQUENCYTYPEID;
                        }
                        else
                        {
                            loan.PRINCIPALFREQUENCYTYPEID = (short)reviewData.PRINCIPALFREQUENCYTYPEID;
                        }


                        decimal newOutstandingPrincipal = 0;

                        DateTime maturityDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID).Max(x => x.PAYMENTDATE);

                        var loanPeriodicSchedule = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID && x.PAYMENTDATE == applicationDate).FirstOrDefault();

                        if (loanPeriodicSchedule != null)
                        {
                            newOutstandingPrincipal = loanPeriodicSchedule.ENDPRINCIPALAMOUNT;
                        }
                        else
                        {
                            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loan.TERMLOANID && c.PAYMENTDATE < applicationDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();
                            newOutstandingPrincipal = previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;
                        }


                        loan.OUTSTANDINGPRINCIPAL = newOutstandingPrincipal;
                        loan.MATURITYDATE = maturityDate;



                        //-------------------------------------------------------

                    }

                }

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;
            }

            return output;
        }


        //public bool PaymentFrequencyChange(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        //{
        //    bool output = false;
        //    try
        //    {
        //        var systemDate = generalSetup.GetApplicationDate();
        //        var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();

        //        if (LoanExist(loanId) > 0)

        //        {
        //            var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
        //            DeleteLoanExist(loanId, systemDate);
        //            ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
        //            ArchivePeriodicSchedule(loanId, archiveBatchCode);
        //            ArchiveDailySchedule(loanId, archiveBatchCode);


        //            //---------------save irregular loan schedule input---------------------------
        //            List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
        //            LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
        //            if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
        //            {
        //                var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
        //                foreach (var item in data)
        //                {
        //                    TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
        //                    schedule.LOANREVIEWOPERATIONID = reviewData.LOANREVIEWOPERATIONID;
        //                    schedule.PAYMENTDATE = item.paymentDate;
        //                    schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
        //                    schedule.CREATEDBY = staffId;
        //                    schedule.DATETIMECREATED = applicationDate;

        //                    tblIrregularSchedule.Add(schedule);
        //                }

        //            }
        //            //----------------------------------------------

        //            //----------generate and save periodic loan schedule -----------------------------------

        //            loanInput.principalFrequency = (short)loanInput.newPrincipalFrequency;
        //            loanInput.interestFrequency = (short)loanInput.newInterestFrequency;

        //            List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

        //            List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();
        //            foreach (var item in periodicScheduleTemp)
        //            {
        //                TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

        //                scheduleTemp.LOANID = loanId;
        //                scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
        //                scheduleTemp.PAYMENTDATE = item.paymentDate;
        //                scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
        //                scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
        //                scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
        //                scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                scheduleTemp.INTERESTRATE = loanInput.interestRate;
        //                scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
        //                scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
        //                scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
        //                scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
        //                scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
        //                scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                scheduleTemp.CREATEDBY = staffId;
        //                scheduleTemp.DATETIMECREATED = systemDate;

        //                tblPeriodicScheduleTemp.Add(scheduleTemp);
        //            }
        //            //-------------------------------------------------------------------------------------

        //            //----------generate and save daily loan schedule -----------------------------------

        //            //loanInput.principalAmount = loanInput.newAmount;
        //            List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

        //            List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

        //            foreach (var item in dailyScheduleTemp)
        //            {
        //                TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

        //                scheduleTemp.LOANID = loanId;
        //                scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
        //                scheduleTemp.DATE = item.date;
        //                scheduleTemp.PAYMENTDATE = item.paymentDate;
        //                scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
        //                scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
        //                scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
        //                scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
        //                scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
        //                scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
        //                scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
        //                scheduleTemp.INTERESTRATE = item.norminalInterestRate;
        //                scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
        //                scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
        //                scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
        //                scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
        //                scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
        //                scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
        //                scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
        //                scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
        //                scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
        //                scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
        //                scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
        //                scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
        //                scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
        //                scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
        //                scheduleTemp.CREATEDBY = staffId;
        //                scheduleTemp.DATETIMECREATED = systemDate;

        //                tblDailyScheduleTemp.Add(scheduleTemp);
        //            }
        //            //----------------------------------------------------------------


        //            //------------adding records to the database--------------------------

        //            //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
        //            //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table

        //            this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

        //            this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
        //            context.SaveChanges();

        //            MergeDailySchedule(loanId, applicationDate);
        //            MergePeriodicSchedule(loanId, applicationDate);
        //            //----------update loan details -----------------------------------
        //            var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
        //            loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
        //            loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
        //            loan.INTERESTNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
        //            loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;

        //            if (loanInput.operationId == (short)OperationsEnum.InterestandPrincipalFrequencyChange)
        //            {
        //                loan.INTERESTFREQUENCYTYPEID = (short)reviewData.INTERESTFREQUENCYTYPEID;
        //                loan.PRINCIPALFREQUENCYTYPEID = (short)reviewData.PRINCIPALFREQUENCYTYPEID;
        //            }
        //            else if (loanInput.operationId == (short)OperationsEnum.InterestFrequencyChange)
        //            {
        //                loan.INTERESTFREQUENCYTYPEID = (short)reviewData.INTERESTFREQUENCYTYPEID;
        //            }
        //            else
        //            {
        //                loan.PRINCIPALFREQUENCYTYPEID = (short)reviewData.PRINCIPALFREQUENCYTYPEID;
        //            }
        //            //-------------------------------------------------------
        //        }

        //        var result = context.SaveChanges() > 0;

        //        if (result)
        //        {
        //            output = true;
        //        }
        //    }
        //    catch (Exception ex)
        //    {

        //        throw ex;
        //    }

        //    return output;
        //}





        public bool PaymentDateChange(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        {
            bool output = false;
            try
            {

                var systemDate = generalSetup.GetApplicationDate();
                var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();

                if (LoanExist(loanId) > 0)
                {
                    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
                    DeleteLoanExist(loanId, systemDate);
                    ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
                    ArchivePeriodicSchedule(loanId, archiveBatchCode);
                    ArchiveDailySchedule(loanId, archiveBatchCode);




                    if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                    {
                        //---------------save irregular loan schedule input---------------------------
                        List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
                        LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
                        if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        {
                            var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                            foreach (var item in data)
                            {
                                TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
                                schedule.LOANREVIEWOPERATIONID = reviewData.LOANREVIEWOPERATIONID;
                                schedule.PAYMENTDATE = item.paymentDate;
                                schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                                schedule.CREATEDBY = staffId;
                                schedule.DATETIMECREATED = applicationDate;

                                tblIrregularSchedule.Add(schedule);
                            }

                        }
                        //----------------------------------------------

                        //----------generate and save periodic loan schedule -----------------------------------

                        loanInput.principalFrequency = (short)loanInput.newPrincipalFrequency;
                        loanInput.interestFrequency = (short)loanInput.newInterestFrequency;

                        List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();
                        foreach (var item in periodicScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.INTERESTRATE = loanInput.interestRate;
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblPeriodicScheduleTemp.Add(scheduleTemp);
                        }
                        //-------------------------------------------------------------------------------------

                        //----------generate and save daily loan schedule -----------------------------------

                        //loanInput.principalAmount = loanInput.newAmount;
                        List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

                        foreach (var item in dailyScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.DATE = item.date;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                            scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                            scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                            scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                            scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                            scheduleTemp.INTERESTRATE = item.norminalInterestRate;
                            scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                            scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                            scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                            scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                            scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                            scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                            scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                            scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                            scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                            scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
                            scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblDailyScheduleTemp.Add(scheduleTemp);
                        }
                        //----------------------------------------------------------------


                        //------------adding records to the database--------------------------

                        //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table

                        this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

                        this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
                        context.SaveChanges();

                        MergeDailySchedule(loanId, applicationDate);
                        MergePeriodicSchedule(loanId, applicationDate);

                        //----------update loan details -----------------------------------
                        var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                        loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;

                        if (loanInput.operationId == (short)OperationsEnum.InterestandPrincipalFrequencyChange)
                        {
                            loan.INTERESTFREQUENCYTYPEID = (short)reviewData.INTERESTFREQUENCYTYPEID;
                            loan.PRINCIPALFREQUENCYTYPEID = (short)reviewData.PRINCIPALFREQUENCYTYPEID;
                        }
                        else if (loanInput.operationId == (short)OperationsEnum.InterestFrequencyChange)
                        {
                            loan.INTERESTFREQUENCYTYPEID = (short)reviewData.INTERESTFREQUENCYTYPEID;
                        }
                        else
                        {
                            loan.PRINCIPALFREQUENCYTYPEID = (short)reviewData.PRINCIPALFREQUENCYTYPEID;
                        }
                        //-------------------------------------------------------

                    }
                    else
                    {
                        //---------------save irregular loan schedule input---------------------------
                        List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
                        LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
                        if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        {
                            var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                            foreach (var item in data)
                            {
                                TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
                                schedule.LOANREVIEWOPERATIONID = reviewData.LOANREVIEWOPERATIONID;
                                schedule.PAYMENTDATE = item.paymentDate;
                                schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                                schedule.CREATEDBY = staffId;
                                schedule.DATETIMECREATED = applicationDate;

                                tblIrregularSchedule.Add(schedule);
                            }

                        }
                        //----------------------------------------------

                        //----------generate and save periodic loan schedule -----------------------------------

                        loanInput.principalFrequency = (short)loanInput.newPrincipalFrequency;
                        loanInput.interestFrequency = (short)loanInput.newInterestFrequency;

                        List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_PERIODIC> tblPeriodicSchedule = new List<TBL_LOAN_SCHEDULE_PERIODIC>();
                        foreach (var item in periodicSchedule)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC schedule = new TBL_LOAN_SCHEDULE_PERIODIC();

                            schedule.LOANID = loanId;
                            schedule.PAYMENTNUMBER = item.paymentNumber;
                            schedule.PAYMENTDATE = item.paymentDate;
                            schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            schedule.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            schedule.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            schedule.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            schedule.INTERESTRATE = loanInput.interestRate;
                            schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            schedule.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            schedule.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            schedule.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            schedule.CREATEDBY = staffId;
                            schedule.DATETIMECREATED = systemDate;

                            tblPeriodicSchedule.Add(schedule);
                        }
                        //-------------------------------------------------------------------------------------

                        //----------generate and save daily loan schedule -----------------------------------
                        List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        MergeDailyScheduleNew(loanId, applicationDate, dailySchedule);

                        var itemToRemovePeriodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                                                    where p.LOANID == loanId
                                                    select p);

                        if (itemToRemovePeriodic != null)
                        {
                            context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemovePeriodic);
                            context.SaveChanges();
                        }

                        this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule); ////change to Temp table
                        context.SaveChanges();

                        ////loanInput.principalAmount = loanInput.newAmount;
                        //List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        //List<TBL_LOAN_SCHEDULE_DAILY> tblDailySchedule = new List<TBL_LOAN_SCHEDULE_DAILY>();

                        //foreach (var item in dailySchedule)
                        //{
                        //    TBL_LOAN_SCHEDULE_DAILY schedule = new TBL_LOAN_SCHEDULE_DAILY();

                        //    schedule.LOANID = loanId;
                        //    schedule.PAYMENTNUMBER = item.paymentNumber;
                        //    schedule.DATE = item.date;
                        //    schedule.PAYMENTDATE = item.paymentDate;
                        //    schedule.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                        //    schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                        //    schedule.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                        //    schedule.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                        //    schedule.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                        //    schedule.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                        //    schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                        //    schedule.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                        //    schedule.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                        //    schedule.INTERESTRATE = item.norminalInterestRate;
                        //    schedule.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                        //    schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                        //    schedule.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                        //    schedule.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                        //    schedule.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                        //    schedule.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                        //    schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                        //    schedule.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                        //    schedule.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                        //    schedule.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                        //    schedule.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                        //    schedule.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                        //    schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                        //    schedule.NUMBEROFPERIODS = item.numberOfPeriods;
                        //    schedule.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                        //    schedule.CREATEDBY = staffId;
                        //    schedule.DATETIMECREATED = systemDate;

                        //    tblDailySchedule.Add(schedule);
                        //}
                        ////----------------------------------------------------------------


                        ////------------adding records to the database--------------------------

                        ////if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        ////{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table

                        //this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule);////change to Temp table

                        //this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(tblDailySchedule); ////change to Temp table
                        //context.SaveChanges();

                        //MergeDailySchedule(loanId, applicationDate);
                        //MergePeriodicSchedule(loanId, applicationDate);

                        //----------update loan details -----------------------------------
                        var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        //loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                        loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;

                        if (loanInput.operationId == (short)OperationsEnum.InterestandPrincipalFrequencyChange)
                        {
                            loan.INTERESTFREQUENCYTYPEID = (short)reviewData.INTERESTFREQUENCYTYPEID;
                            loan.PRINCIPALFREQUENCYTYPEID = (short)reviewData.PRINCIPALFREQUENCYTYPEID;
                        }
                        else if (loanInput.operationId == (short)OperationsEnum.InterestFrequencyChange)
                        {
                            loan.INTERESTFREQUENCYTYPEID = (short)reviewData.INTERESTFREQUENCYTYPEID;
                        }
                        else
                        {
                            loan.PRINCIPALFREQUENCYTYPEID = (short)reviewData.PRINCIPALFREQUENCYTYPEID;
                        }


                        decimal newOutstandingPrincipal = 0;

                        DateTime maturityDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID).Max(x => x.PAYMENTDATE);

                        var loanPeriodicSchedule = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID && x.PAYMENTDATE == applicationDate).FirstOrDefault();

                        if (loanPeriodicSchedule != null)
                        {
                            newOutstandingPrincipal = loanPeriodicSchedule.ENDPRINCIPALAMOUNT;
                        }
                        else
                        {
                            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loan.TERMLOANID && c.PAYMENTDATE < applicationDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();
                            newOutstandingPrincipal = previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;
                        }


                        loan.OUTSTANDINGPRINCIPAL = newOutstandingPrincipal;
                        loan.MATURITYDATE = maturityDate;



                        //-------------------------------------------------------

                    }

                }

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;
            }

            return output;
        }





        //public bool PaymentDateChange(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        //{
        //    bool output = false;
        //    try
        //    {

        //        var systemDate = generalSetup.GetApplicationDate();
        //        var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();
        //        if (LoanExist(loanId) > 0)
        //        {
        //            var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
        //            DeleteLoanExist(loanId, systemDate);
        //            ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
        //            ArchivePeriodicSchedule(loanId, archiveBatchCode);
        //            ArchiveDailySchedule(loanId, archiveBatchCode);


        //            //---------------save irregular loan schedule input---------------------------

        //            LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
        //            if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
        //            {
        //                List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();

        //                var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
        //                foreach (var item in data)
        //                {
        //                    TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
        //                    schedule.LOANREVIEWOPERATIONID = loanId;
        //                    schedule.PAYMENTDATE = item.paymentDate;
        //                    schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
        //                    schedule.CREATEDBY = staffId;
        //                    schedule.DATETIMECREATED = applicationDate;

        //                    tblIrregularSchedule.Add(schedule);
        //                }

        //            }
        //            //----------------------------------------------

        //            //----------generate and save periodic loan schedule -----------------------------------

        //            //loanInput.principalFirstpaymentDate = loanInput.newPrincipalFirstpaymentDate;
        //            //loanInput.interestFirstpaymentDate = loanInput.newInterestFirstpaymentDate;

        //            List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

        //            List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();
        //            foreach (var item in periodicScheduleTemp)
        //            {
        //                TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

        //                scheduleTemp.LOANID = loanId;
        //                scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
        //                scheduleTemp.PAYMENTDATE = item.paymentDate;
        //                scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
        //                scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
        //                scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
        //                scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                scheduleTemp.INTERESTRATE = loanInput.interestRate;
        //                scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
        //                scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
        //                scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
        //                scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
        //                scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
        //                scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                scheduleTemp.CREATEDBY = staffId;
        //                scheduleTemp.DATETIMECREATED = systemDate;

        //                tblPeriodicScheduleTemp.Add(scheduleTemp);
        //            }
        //            //-------------------------------------------------------------------------------------
        //            //----------generate and save daily loan schedule -----------------------------------

        //            //loanInput.principalAmount = loanInput.newAmount;
        //            List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

        //            List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

        //            foreach (var item in dailyScheduleTemp)
        //            {
        //                TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

        //                scheduleTemp.LOANID = loanId;
        //                scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
        //                scheduleTemp.DATE = item.date;
        //                scheduleTemp.PAYMENTDATE = item.paymentDate;
        //                scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
        //                scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
        //                scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
        //                scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
        //                scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
        //                scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
        //                scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
        //                scheduleTemp.INTERESTRATE = item.norminalInterestRate;
        //                scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
        //                scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
        //                scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
        //                scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
        //                scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
        //                scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
        //                scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
        //                scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
        //                scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
        //                scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
        //                scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
        //                scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
        //                scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
        //                scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
        //                scheduleTemp.CREATEDBY = staffId;
        //                scheduleTemp.DATETIMECREATED = systemDate;

        //                tblDailyScheduleTemp.Add(scheduleTemp);
        //            }
        //            //----------------------------------------------------------------


        //            //------------adding records to the database--------------------------

        //            //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
        //            //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table

        //            this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

        //            this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
        //            context.SaveChanges();

        //            MergeDailySchedule(loanId, applicationDate);
        //            MergePeriodicSchedule(loanId, applicationDate);
        //            //----------update loan details -----------------------------------
        //            var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
        //            loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
        //            loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
        //            loan.INTERESTNUMBEROFINSTALLMENT = loan.PRINCIPALNUMBEROFINSTALLMENT;
        //            loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
        //            loan.FIRSTINTERESTPAYMENTDATE = reviewData.INTERESTFIRSTPAYMENTDATE;
        //            loan.FIRSTPRINCIPALPAYMENTDATE = reviewData.PRINCIPALFIRSTPAYMENTDATE;
        //            //-------------------------------------------------

        //        }
        //        var result = context.SaveChanges() > 0;

        //        if (result)
        //        {
        //            output = true;
        //        }
        //    }
        //    catch (Exception ex)
        //    {

        //        throw ex;
        //    }

        //    return output;
        //}

        public bool LoanReversal(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, TwoFactorAutheticationViewModel twoFactorAuth, DateTime applicationDate, int staffId)
        {
            bool output = false;
            bool result = false;
            try
            {
                //decimal pastDueRate = 0;//change to pastdueRate
                //decimal pastDueRate = (decimal)context.TBL_SETUP_COMPANY.Where(x => x.COMPANYID == loanInput.companyId).Select(x => x.PASTDUEINDEFAULT_INTERESTRATE).FirstOrDefault();//change to pastdueRate
                decimal pastDueRate = (decimal)context.TBL_PRODUCT.Where(x => x.PRODUCTID == loanInput.productId).Select(x => x.PENALCHARGERATE).FirstOrDefault();//change to pastdueRate


                var systemDate = generalSetup.GetApplicationDate();
                loanInput.date = applicationDate;
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
                decimal principalOutStandingBalance = loan.OUTSTANDINGPRINCIPAL + loan.OUTSTANDINGINTEREST;
                //var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID);
                var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID2);
                decimal accruedInterest = 0;
                var accrued = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                               where a.TBL_LOAN.TERMLOANID == loanId && a.DATE == applicationDate
                               select a).FirstOrDefault();

                if (accrued != null)
                {
                    accruedInterest = accrued.ACCRUEDINTEREST;
                }
                else
                {
                    throw new SecureException("Application Date not found in Payment Schedule");
                }

                accruedInterest = decimal.Round(accruedInterest, 2, MidpointRounding.AwayFromZero);
                principalOutStandingBalance = decimal.Round(principalOutStandingBalance, 2, MidpointRounding.AwayFromZero);

                decimal pastDueAndInterests = decimal.Round((loan.PASTDUEPRINCIPAL + loan.PASTDUEINTEREST + loan.INTERESTONPASTDUEINTEREST + loan.INTERESTONPASTDUEPRINCIPAL), 2, MidpointRounding.AwayFromZero);
                decimal totalamount = (accruedInterest + principalOutStandingBalance + pastDueAndInterests);

                List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();
                var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);

                DeleteLoanExist(loanId, applicationDate);

                ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
                ArchivePeriodicSchedule(loanId, archiveBatchCode);
                ArchiveDailySchedule(loanId, archiveBatchCode);

                DeleteLoanExistingOnDailyAndPeriodicSchedule(loanId);

                //----------generate and save periodic loan schedule -----------------------------------
                List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                List<TBL_LOAN_SCHEDULE_PERIODIC> tblPeriodicSchedule = new List<TBL_LOAN_SCHEDULE_PERIODIC>();

                foreach (var item in periodicSchedule)
                {
                    TBL_LOAN_SCHEDULE_PERIODIC schedule = new TBL_LOAN_SCHEDULE_PERIODIC();

                    schedule.LOANID = loanId;
                    schedule.PAYMENTNUMBER = item.paymentNumber;
                    schedule.PAYMENTDATE = item.paymentDate;
                    schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                    schedule.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                    schedule.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                    schedule.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                    schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                    schedule.INTERESTRATE = loanInput.interestRate;
                    schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                    schedule.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                    schedule.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                    schedule.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                    schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                    schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                    schedule.CREATEDBY = staffId;
                    schedule.DATETIMECREATED = systemDate;

                    tblPeriodicSchedule.Add(schedule);
                }
                //-------------------------------------------------------------------------------------


                //----------generate and save daily loan schedule -----------------------------------
                List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                List<TBL_LOAN_SCHEDULE_DAILY> tblDailySchedule = new List<TBL_LOAN_SCHEDULE_DAILY>();

                foreach (var item in dailySchedule)
                {
                    TBL_LOAN_SCHEDULE_DAILY schedule = new TBL_LOAN_SCHEDULE_DAILY();

                    schedule.LOANID = loanId;
                    schedule.PAYMENTNUMBER = item.paymentNumber;
                    schedule.DATE = item.date;
                    schedule.PAYMENTDATE = item.paymentDate;
                    schedule.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                    schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                    schedule.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                    schedule.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                    schedule.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                    schedule.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                    schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                    schedule.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                    schedule.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                    schedule.INTERESTRATE = item.norminalInterestRate;
                    schedule.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                    schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                    schedule.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                    schedule.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                    schedule.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                    schedule.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                    schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                    schedule.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                    schedule.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                    schedule.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                    schedule.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                    schedule.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                    schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                    schedule.NUMBEROFPERIODS = item.numberOfPeriods;
                    schedule.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                    schedule.CREATEDBY = staffId;
                    schedule.DATETIMECREATED = systemDate;

                    tblDailySchedule.Add(schedule);
                }
                //----------------------------------------------------------------


                //------------adding records to the database--------------------------

                this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule);////change to Temp table

                this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(tblDailySchedule); ////change to Temp table
                context.SaveChanges();
                //----------update loan details -----------------------------------
                loan.MATURITYDATE = periodicSchedule.Max(x => x.paymentDate);
                loan.PRINCIPALNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                loan.INTERESTNUMBEROFINSTALLMENT = loan.PRINCIPALNUMBEROFINSTALLMENT;
                //-------------------------------------------------

                context.SaveChanges();
                //-------------------------------------------------------
                result = LoanBackDateFunction(loanId, applicationDate, systemDate, loanInput);


                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;
        }

        public bool LoanBackDateFunction(int loanId, DateTime effectiveDate, DateTime currentDate, LoanPaymentRestructureScheduleInputViewModel loanInput)
        {

            bool output = false;
            var result = "";
            var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
            var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();

            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

            int counter = 0;

            var loanSchePeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.TBL_LOAN.TERMLOANID == loanId
                 && x.PAYMENTDATE >= effectiveDate && x.PAYMENTDATE <= currentDate && x.PAYMENTNUMBER != 0).OrderByDescending(x => x.PERIODICSCHEDULEID);

            decimal loanSchePeriodicPrincipal = 0;

            try
            {
                loanSchePeriodicPrincipal = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.TBL_LOAN.TERMLOANID == loanId
               && x.PAYMENTDATE >= effectiveDate && x.PAYMENTDATE <= currentDate && x.PAYMENTNUMBER != 0).Sum(x => x.PERIODPRINCIPALAMOUNT);
            }
            catch (Exception)
            {
                loanSchePeriodicPrincipal = 0;
            }


            var loanSchePeriodicDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.TBL_LOAN.TERMLOANID == loanId
                && x.PAYMENTDATE >= effectiveDate && x.PAYMENTDATE <= currentDate && x.PAYMENTNUMBER != 0).OrderByDescending(x => x.PAYMENTDATE).Take(1).FirstOrDefault();


            int dateDiff = DateDiff(effectiveDate, currentDate);

            List<TBL_DAILY_ACCRUAL_TEMP> tblDailyAccrualTempList = new List<TBL_DAILY_ACCRUAL_TEMP>();

            for (int i = 0; i < dateDiff; i++)
            {

                TBL_DAILY_ACCRUAL_TEMP tblDailyAccrualTemp = new TBL_DAILY_ACCRUAL_TEMP();

                DateTime dateAdd = effectiveDate.AddDays(i);

                if (dateAdd == currentDate)
                {
                    break;
                }

                tblDailyAccrualTemp.REFERENCENUMBER = loan.LOANREFERENCENUMBER;
                tblDailyAccrualTemp.CATEGORYID = (short)DailyAccrualCategory.TermLoan;
                tblDailyAccrualTemp.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                tblDailyAccrualTemp.PRODUCTID = loan.PRODUCTID;
                tblDailyAccrualTemp.COMPANYID = loan.COMPANYID;
                tblDailyAccrualTemp.BRANCHID = loan.BRANCHID;
                tblDailyAccrualTemp.CURRENCYID = loan.CURRENCYID;
                tblDailyAccrualTemp.EXCHANGERATE = loan.EXCHANGERATE;
                tblDailyAccrualTemp.MAINAMOUNT = GetRepaymentStartAmount(loanId, dateAdd);
                tblDailyAccrualTemp.INTERESTRATE = loanInput.interestRate;
                tblDailyAccrualTemp.DAYCOUNTCONVENTIONID = loan.SCHEDULEDAYCOUNTCONVENTIONID;
                tblDailyAccrualTemp.DAILYACCURALAMOUNT = (decimal)((loanInput.interestRate / 100) * (double)GetRepaymentStartAmount(loanId, dateAdd) * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID)));
                tblDailyAccrualTemp.REPAYMENTPOSTEDSTATUS = false;
                tblDailyAccrualTemp.SYSTEMDATETIME = 0;
                tblDailyAccrualTemp.CHARGEFEEID = (int)ChargeFeeDetailTypeEnum.Primary;
                tblDailyAccrualTemp.DATE = dateAdd;
                tblDailyAccrualTemp.DAILYACCURALAMOUNT2 = 0;


                tblDailyAccrualTempList.Add(tblDailyAccrualTemp);

            }

            var deleteDailyAccrcual = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER).ToList();

            if (deleteDailyAccrcual != null)
            {
                context.TBL_DAILY_ACCRUAL_TEMP.RemoveRange(deleteDailyAccrcual);
                context.SaveChanges();
            }

            if (tblDailyAccrualTempList.Count() != 0)
            {
                context.TBL_DAILY_ACCRUAL_TEMP.AddRange(tblDailyAccrualTempList);
                context.SaveChanges();
            }


            counter = loanSchePeriodicData.Count();

            DateTime newCurrentDate = currentDate.AddDays(-1);

            if (counter == 0)
            {

                decimal previousDailyInterest = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newCurrentDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan).Sum(x => x.DAILYACCURALAMOUNT);

                decimal currentDailyInterest = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newCurrentDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan).Sum(x => x.DAILYACCURALAMOUNT);

                decimal previousAccruedDailyInterest = (decimal?)previousDailyInterest ?? 0;
                decimal.Round(previousAccruedDailyInterest, 2, MidpointRounding.AwayFromZero);

                double dailyAccuralAmount = ((loanInput.interestRate / 100) * (double)loan.OUTSTANDINGPRINCIPAL * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID)));

                decimal currentAccruedDailyInterest = (decimal?)currentDailyInterest ?? 0;
                decimal.Round(currentAccruedDailyInterest, 2, MidpointRounding.AwayFromZero);

                decimal accruedDailyInterestDiff = previousAccruedDailyInterest - currentAccruedDailyInterest;

                if (accruedDailyInterestDiff != 0)
                {
                    inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, (decimal)accruedDailyInterestDiff, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest Reversal", loanInput.operationId));

                    output = true;

                }


            }
            else
            {

                DateTime newDate = loanSchePeriodicDate.PAYMENTDATE.AddDays(-1);
                var dailyAccrualRecord = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= newCurrentDate && x.DATE <= loanSchePeriodicDate.PAYMENTDATE && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan);


                decimal previousDailyInterest = dailyAccrualRecord.Any() ? dailyAccrualRecord.Sum(x => x.DAILYACCURALAMOUNT) : 0;
                var currentDailyInterestRecord = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= newCurrentDate && x.DATE <= loanSchePeriodicDate.PAYMENTDATE && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan);
                decimal currentDailyInterest = currentDailyInterestRecord.Any() ? currentDailyInterestRecord.Sum(x => x.DAILYACCURALAMOUNT) : 0;

                decimal previousAccruedDailyInterest = (decimal?)previousDailyInterest ?? 0;

                decimal.Round(previousAccruedDailyInterest, 2, MidpointRounding.AwayFromZero);

                double dailyAccuralAmount = ((loanInput.interestRate / 100) * (double)loan.OUTSTANDINGPRINCIPAL * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID)));

                decimal currentAccruedDailyInterest = (decimal?)currentDailyInterest ?? 0;
                decimal.Round(currentAccruedDailyInterest, 2, MidpointRounding.AwayFromZero);

                decimal accruedDailyInterestDiff = previousAccruedDailyInterest - currentAccruedDailyInterest;

                if (accruedDailyInterestDiff != 0)
                {
                    inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, (decimal)accruedDailyInterestDiff, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest Reversal", loanInput.operationId));

                    output = true;

                }

                var previousPeriodicForPrincipal = from d in context.TBL_LOAN_SCHEDULE_PERIODIC_ARC
                                                   where d.LOANID == loanId
                                                   let periodicPrincipal = context.TBL_LOAN_SCHEDULE_PERIODIC_ARC.Where(a => a.LOANID == loanId
                                                   && a.PAYMENTDATE >= DbFunctions.TruncateTime(effectiveDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(currentDate)
                                                   ).Sum(a => (double?)a.PERIODPRINCIPALAMOUNT ?? 0)
                                                   select periodicPrincipal;

                var currentPeriodicForPrincipal = from d in context.TBL_LOAN_SCHEDULE_PERIODIC
                                                  where d.LOANID == loanId
                                                  let periodicPrincipal = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(a => a.LOANID == loanId
                                                  && a.PAYMENTDATE >= DbFunctions.TruncateTime(effectiveDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(currentDate)
                                                  ).Sum(a => (double?)a.PERIODPRINCIPALAMOUNT ?? 0)
                                                  select periodicPrincipal;


                decimal previousPeriodicPrincipal = (decimal?)previousPeriodicForPrincipal.FirstOrDefault() ?? 0;
                decimal.Round(previousPeriodicPrincipal, 2, MidpointRounding.AwayFromZero);

                decimal currentPeriodicPrincipal = (decimal?)currentPeriodicForPrincipal.FirstOrDefault() ?? 0;
                decimal.Round(currentPeriodicPrincipal, 2, MidpointRounding.AwayFromZero);

                decimal periodicPrincipalDiff = previousPeriodicPrincipal - currentPeriodicPrincipal;

                if (periodicPrincipalDiff != 0)
                {
                    inputTransactions.Add(financeTransaction.PostLoanPositiveReversalCasaEntries(loanInput, periodicPrincipalDiff, product.PRINCIPALBALANCEGL.Value, "Principal Reversal", loanInput.operationId));

                    output = true;
                }

                var previousPeriodicRecord = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan).ToList();
                decimal previousPeriodic = 0;
                decimal currentPeriodic = 0;
                if (previousPeriodicRecord.Count() > 0)
                {
                    previousPeriodic = previousPeriodicRecord.Sum(x => x.DAILYACCURALAMOUNT);
                }

                //decimal previousPeriodic = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan).Sum(x => x.DAILYACCURALAMOUNT);

                var currentPeriodicRecord = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan);
                if (currentPeriodicRecord.Count() > 0)
                {
                    currentPeriodic = currentPeriodicRecord.Sum(x => x.DAILYACCURALAMOUNT);
                }

                // currentPeriodic = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan).Sum(x => x.DAILYACCURALAMOUNT);

                decimal previousPeriodicInterest = (decimal?)previousPeriodic ?? 0;
                decimal.Round(previousPeriodicInterest, 2, MidpointRounding.AwayFromZero);

                decimal currentPeriodicInterest = (decimal?)currentPeriodic ?? 0;
                decimal.Round(currentPeriodicInterest, 2, MidpointRounding.AwayFromZero);

                decimal periodicInterestDiff = previousPeriodicInterest - currentPeriodicInterest;


                if (periodicInterestDiff != 0)
                {
                    inputTransactions.Add(financeTransaction.PostLoanPositiveReversalCasaEntries(loanInput, periodicInterestDiff, product.PRINCIPALBALANCEGL.Value, "Interest Reversal", loanInput.operationId));

                    output = true;

                }


            }


            var tblDailyAccrualTempNew = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= currentDate).ToList().OrderBy(x => x.DATE);

            List<TBL_DAILY_ACCRUAL_ARCHIVE> tblDailyAccrualListNew = new List<TBL_DAILY_ACCRUAL_ARCHIVE>();

            foreach (TBL_DAILY_ACCRUAL tblDailyAccrual in tblDailyAccrualTempNew)
            {
                TBL_DAILY_ACCRUAL_ARCHIVE tblDailyAccrualNew = new TBL_DAILY_ACCRUAL_ARCHIVE();

                tblDailyAccrualNew.REFERENCENUMBER = tblDailyAccrual.REFERENCENUMBER;
                tblDailyAccrualNew.CATEGORYID = tblDailyAccrual.CATEGORYID;
                tblDailyAccrualNew.TRANSACTIONTYPEID = tblDailyAccrual.TRANSACTIONTYPEID;
                tblDailyAccrualNew.PRODUCTID = tblDailyAccrual.PRODUCTID;
                tblDailyAccrualNew.COMPANYID = tblDailyAccrual.COMPANYID;
                tblDailyAccrualNew.BRANCHID = tblDailyAccrual.BRANCHID;
                tblDailyAccrualNew.CURRENCYID = tblDailyAccrual.CURRENCYID;
                tblDailyAccrualNew.EXCHANGERATE = tblDailyAccrual.EXCHANGERATE;
                tblDailyAccrualNew.MAINAMOUNT = tblDailyAccrual.MAINAMOUNT;
                tblDailyAccrualNew.INTERESTRATE = tblDailyAccrual.INTERESTRATE;
                tblDailyAccrualNew.DAYCOUNTCONVENTIONID = tblDailyAccrual.DAYCOUNTCONVENTIONID;
                tblDailyAccrualNew.DAILYACCURALAMOUNT = tblDailyAccrual.DAILYACCURALAMOUNT;
                tblDailyAccrualNew.REPAYMENTPOSTEDSTATUS = tblDailyAccrual.REPAYMENTPOSTEDSTATUS;
                tblDailyAccrualNew.SYSTEMDATETIME = tblDailyAccrual.SYSTEMDATETIME;
                tblDailyAccrualNew.DATE = tblDailyAccrual.DATE;
                tblDailyAccrualNew.DAILYACCURALAMOUNT2 = tblDailyAccrual.DAILYACCURALAMOUNT2;
                tblDailyAccrualNew.CHARGEFEEID = (int)ChargeFeeDetailTypeEnum.Primary;
                tblDailyAccrualNew.ARCHIVEBATCHCODE = CommonHelpers.GenerateRandomDigitCode(10);
                tblDailyAccrualNew.ARCHIVEDATE = currentDate;
                tblDailyAccrualNew.DAILYACCURALID = tblDailyAccrual.DAILYACCURALID;


                tblDailyAccrualListNew.Add(tblDailyAccrualNew);
            }


            if (tblDailyAccrualListNew.Count() != 0)
            {
                context.TBL_DAILY_ACCRUAL_ARCHIVE.AddRange(tblDailyAccrualListNew);
                context.SaveChanges();
            }

            var deleteDailyAccrualNew = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= currentDate).ToList();

            if (deleteDailyAccrualNew != null)
            {
                context.TBL_DAILY_ACCRUAL.RemoveRange(deleteDailyAccrualNew);
                context.SaveChanges();
            }

            var dailyAccrualNew = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= currentDate).ToList();

            List<TBL_DAILY_ACCRUAL> tblDailyAccrualList = new List<TBL_DAILY_ACCRUAL>();

            foreach (TBL_DAILY_ACCRUAL_TEMP tblDailyAccrual in dailyAccrualNew)
            {
                TBL_DAILY_ACCRUAL tblDailyAccruallNew = new TBL_DAILY_ACCRUAL();

                tblDailyAccruallNew.REFERENCENUMBER = tblDailyAccrual.REFERENCENUMBER;
                tblDailyAccruallNew.CATEGORYID = tblDailyAccrual.CATEGORYID;
                tblDailyAccruallNew.TRANSACTIONTYPEID = tblDailyAccrual.TRANSACTIONTYPEID;
                tblDailyAccruallNew.PRODUCTID = tblDailyAccrual.PRODUCTID;
                tblDailyAccruallNew.COMPANYID = tblDailyAccrual.COMPANYID;
                tblDailyAccruallNew.BRANCHID = tblDailyAccrual.BRANCHID;
                tblDailyAccruallNew.CURRENCYID = tblDailyAccrual.CURRENCYID;
                tblDailyAccruallNew.EXCHANGERATE = tblDailyAccrual.EXCHANGERATE;
                tblDailyAccruallNew.MAINAMOUNT = tblDailyAccrual.MAINAMOUNT;
                tblDailyAccruallNew.INTERESTRATE = tblDailyAccrual.INTERESTRATE;
                tblDailyAccruallNew.DAYCOUNTCONVENTIONID = tblDailyAccrual.DAYCOUNTCONVENTIONID;
                tblDailyAccruallNew.DAILYACCURALAMOUNT = tblDailyAccrual.DAILYACCURALAMOUNT;
                tblDailyAccruallNew.REPAYMENTPOSTEDSTATUS = tblDailyAccrual.REPAYMENTPOSTEDSTATUS;
                tblDailyAccruallNew.SYSTEMDATETIME = tblDailyAccrual.SYSTEMDATETIME;
                tblDailyAccruallNew.DATE = tblDailyAccrual.DATE;
                tblDailyAccruallNew.DAILYACCURALAMOUNT2 = tblDailyAccrual.DAILYACCURALAMOUNT2;
                //tblDailyAccruallNew.CHARGEFEEID = (int)ChargeFeeDetailTypeEnum.Primary;


                tblDailyAccrualList.Add(tblDailyAccruallNew);
            }


            if (tblDailyAccrualList.Count() != 0)
            {
                context.TBL_DAILY_ACCRUAL.AddRange(tblDailyAccrualList);
                context.SaveChanges();
            }


            return output;
        }


        private decimal GetRepaymentStartAmount(int loanId, DateTime date)
        {

            decimal repaymentStartAmount = 0;

            var loanScheduleData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.PAYMENTDATE <= date && x.LOANID == loanId).OrderByDescending(x => x.PAYMENTDATE).Take(1).FirstOrDefault();

            repaymentStartAmount = loanScheduleData.ENDPRINCIPALAMOUNT;

            return repaymentStartAmount;

        }



        //public bool LoanBackDateFunction(int loanId, DateTime effectiveDate, DateTime currentDate, decimal pastDueRate, LoanPaymentRestructureScheduleInputViewModel loanInput)
        //{
        //    bool output = false;
        //    var result = "";
        //    var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
        //    var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();

        //    var loanSchePeriodic = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.TBL_LOAN.TERMLOANID == loanId
        //           && x.PAYMENTDATE >= effectiveDate && x.PAYMENTDATE <= currentDate && x.PAYMENTNUMBER != 0).OrderBy(x => x.PERIODICSCHEDULEID);

        //    int countRepayments = loanSchePeriodic.Count();

        //    if (countRepayments == 0)
        //    {
        //        throw new SecureException("Application Date not found in Payment Schedule");
        //    }

        //    var previousDailyInterest = from d in context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV
        //                                where d.LOANID == loanId
        //                                let dailyAccruedInterest = context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV.Where(a => a.LOANID == loanId
        //                                && a.DATE >= DbFunctions.TruncateTime(effectiveDate) && a.DATE <= DbFunctions.TruncateTime(currentDate)
        //                                ).Sum(a => (double?)a.DAILYINTERESTAMOUNT ?? 0)
        //                                select dailyAccruedInterest;

        //    decimal previousAccruedDailyInterest = (decimal?)previousDailyInterest.FirstOrDefault() ?? 0;

        //    decimal.Round(previousAccruedDailyInterest, 2, MidpointRounding.AwayFromZero);



        //    var currentDailyInterest = from d in context.TBL_LOAN_SCHEDULE_DAILY //_TEMP
        //                               where d.LOANID == loanId
        //                               let dailyAccruedInterest = context.TBL_LOAN_SCHEDULE_DAILY.Where(a => a.LOANID == loanId //
        //                               && a.DATE >= DbFunctions.TruncateTime(effectiveDate) && a.DATE <= DbFunctions.TruncateTime(currentDate)
        //                               ).Sum(a => (double?)a.DAILYINTERESTAMOUNT ?? 0)
        //                               select dailyAccruedInterest;


        //    decimal currentAccruedDailyInterest = (decimal?)currentDailyInterest.FirstOrDefault() ?? 0;
        //    decimal.Round(currentAccruedDailyInterest, 2, MidpointRounding.AwayFromZero);

        //    var previousPeriodic = from d in context.TBL_LOAN_SCHEDULE_PERIODIC_ARC
        //                           where d.LOANID == loanId
        //                           let periodicInterest = context.TBL_LOAN_SCHEDULE_PERIODIC_ARC.Where(a => a.LOANID == loanId
        //                           && a.PAYMENTDATE >= DbFunctions.TruncateTime(effectiveDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(currentDate)
        //                           ).Sum(a => (double?)a.PERIODINTERESTAMOUNT ?? 0)
        //                           select periodicInterest;

        //    decimal previousPeriodicInterest = (decimal?)previousPeriodic.FirstOrDefault() ?? 0;
        //    decimal.Round(previousPeriodicInterest, 2, MidpointRounding.AwayFromZero);

        //    var currentPeriodic = from d in context.TBL_LOAN_SCHEDULE_PERIODIC //_TMP
        //                          where d.LOANID == loanId
        //                          let periodicInterest = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(a => a.LOANID == loanId //_TMP
        //                          && a.PAYMENTDATE >= DbFunctions.TruncateTime(effectiveDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(currentDate)
        //                          ).Sum(a => (double?)a.PERIODINTERESTAMOUNT ?? 0)
        //                          select periodicInterest;

        //    decimal currentPeriodicInterest = (decimal?)currentPeriodic.FirstOrDefault() ?? 0;
        //    decimal.Round(currentPeriodicInterest, 2, MidpointRounding.AwayFromZero);


        //    var previousPeriodicForPrincipal = from d in context.TBL_LOAN_SCHEDULE_PERIODIC_ARC
        //                                       where d.LOANID == loanId
        //                                       let periodicPrincipal = context.TBL_LOAN_SCHEDULE_PERIODIC_ARC.Where(a => a.LOANID == loanId
        //                                       && a.PAYMENTDATE >= DbFunctions.TruncateTime(effectiveDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(currentDate)
        //                                       ).Sum(a => (double?)a.PERIODPRINCIPALAMOUNT ?? 0)
        //                                       select periodicPrincipal;

        //    decimal previousPeriodicPrincipal = (decimal?)previousPeriodicForPrincipal.FirstOrDefault() ?? 0;
        //    decimal.Round(previousPeriodicPrincipal, 2, MidpointRounding.AwayFromZero);

        //    var currentPeriodicForPrincipal = from d in context.TBL_LOAN_SCHEDULE_PERIODIC //_TMP
        //                                      where d.LOANID == loanId
        //                                      let periodicPrincipal = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(a => a.LOANID == loanId //_TMP
        //                                      && a.PAYMENTDATE >= DbFunctions.TruncateTime(effectiveDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(currentDate)
        //                                      ).Sum(a => (double?)a.PERIODPRINCIPALAMOUNT ?? 0)
        //                                      select periodicPrincipal;

        //    decimal currentPeriodicPrincipal = (decimal?)currentPeriodicForPrincipal.FirstOrDefault() ?? 0;
        //    decimal.Round(currentPeriodicPrincipal, 2, MidpointRounding.AwayFromZero);



        //    var pastDueList = (from a in context.TBL_LOAN_PAST_DUE
        //                       join b in context.TBL_LOAN_SCHEDULE_PERIODIC on a.LOANID equals b.LOANID
        //                       where a.DATE >= DbFunctions.TruncateTime(effectiveDate) && a.DATE <= DbFunctions.TruncateTime(currentDate)
        //                       && a.TRANSACTIONTYPEID == (int)LoanTransactionTypeEnum.Interest && a.DATE == b.PAYMENTDATE

        //                       select new PastDueOnPastDueViewModel()
        //                       {
        //                           date = a.DATE,
        //                           amount = b.PERIODINTERESTAMOUNT
        //                       }).ToList();




        //    List<PastDueOnPastDueViewModel1> currentPastDuesInterst = new List<PastDueOnPastDueViewModel1>();


        //    foreach (var item in pastDueList)
        //    {
        //        PastDueOnPastDueViewModel1 xyz = new PastDueOnPastDueViewModel1();

        //        xyz.date = item.date;
        //        xyz.amount = item.amount;
        //        xyz.count = (int)(currentDate - item.date).TotalDays;
        //        xyz.interestOnAmount = ((pastDueRate / 100) * ((int)(currentDate - item.date).TotalDays) * item.amount);

        //        currentPastDuesInterst.Add(xyz);

        //    }

        //    var pastDueItems = from d in currentPastDuesInterst
        //                       select d.interestOnAmount;
        //    decimal currentPastDueInterest = (decimal?)pastDueItems.FirstOrDefault() ?? 0;


        //    var pastDueForPrincipals = (from a in context.TBL_LOAN_PAST_DUE
        //                                join b in context.TBL_LOAN_SCHEDULE_PERIODIC on a.LOANID equals b.LOANID
        //                                where a.DATE >= DbFunctions.TruncateTime(effectiveDate) && a.DATE <= DbFunctions.TruncateTime(currentDate)
        //                                && a.TRANSACTIONTYPEID == (int)LoanTransactionTypeEnum.Principal && a.DATE == b.PAYMENTDATE

        //                                select new PastDueOnPastDueViewModel()
        //                                {
        //                                    date = a.DATE,
        //                                    amount = b.PERIODINTERESTAMOUNT

        //                                }).ToList();

        //    List<PastDueOnPastDueViewModel1> currentPastDuesPrincipal = new List<PastDueOnPastDueViewModel1>();


        //    foreach (var item in pastDueForPrincipals)
        //    {
        //        PastDueOnPastDueViewModel1 xyzPrincipal = new PastDueOnPastDueViewModel1();

        //        xyzPrincipal.date = item.date;
        //        xyzPrincipal.amount = item.amount;
        //        xyzPrincipal.count = (int)(currentDate - item.date).TotalDays;
        //        xyzPrincipal.interestOnAmount = ((pastDueRate / 100) * ((int)(currentDate - item.date).TotalDays) * item.amount);

        //        currentPastDuesPrincipal.Add(xyzPrincipal);
        //    }

        //    var pastDueItemsPrincipal = from d in currentPastDuesPrincipal
        //                                select d.interestOnAmount;

        //    decimal currentPastDuePrincipal = (decimal?)pastDueItemsPrincipal.FirstOrDefault() ?? 0;


        //    decimal accruedDailyInterestDiff = previousAccruedDailyInterest - currentAccruedDailyInterest;
        //    decimal periodicInterestDiff = previousPeriodicInterest - currentPeriodicInterest;
        //    decimal periodicPrincipalDiff = previousPeriodicPrincipal - currentPeriodicPrincipal;
        //    decimal pastDueInterestDiff = loan.INTERESTONPASTDUEINTEREST - currentPastDueInterest;
        //    decimal pastDuePrincipalDiff = loan.INTERESTONPASTDUEPRINCIPAL - currentPastDuePrincipal;

        //    List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();
        //    //All the posting here are not correct please, we need to build each if we are to debit or credit the customer
        //    if (countRepayments < 1 && effectiveDate == currentDate)
        //    {
        //    }
        //    else if (countRepayments < 1 && effectiveDate <= currentDate)
        //    {
        //        if (accruedDailyInterestDiff != 0)
        //        {
        //            inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, accruedDailyInterestDiff, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest Reversal", loanInput.operationId)); //change later));
        //        }

        //        //result = financeTransaction.PostTransaction(inputTransactions);
        //    }
        //    else
        //    {

        //        if (accruedDailyInterestDiff != 0)
        //        {
        //            inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, accruedDailyInterestDiff, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest Reversal", loanInput.operationId));
        //        }

        //        if (periodicInterestDiff != 0)
        //        {
        //            inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, periodicInterestDiff, product.PRINCIPALBALANCEGL.Value, "Interest Reversal", loanInput.operationId));
        //        }

        //        if (periodicPrincipalDiff != 0)
        //        {
        //            inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, periodicPrincipalDiff, product.PRINCIPALBALANCEGL.Value, "Principal Reversal", loanInput.operationId));
        //        }

        //        if (pastDueInterestDiff != 0)
        //        {
        //            inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, pastDueInterestDiff, product.PRINCIPALBALANCEGL.Value, "PastDue Interest Reversal", loanInput.operationId));
        //        }


        //        if (pastDuePrincipalDiff > 0)
        //        {
        //            inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, pastDuePrincipalDiff, product.PRINCIPALBALANCEGL.Value, "PastDue Principal Reversal", loanInput.operationId));
        //        }

        //        //result = financeTransaction.PostTransaction(inputTransactions);
        //    }
        //    return output;
        //}

        public bool RegenerateSchedule(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        {
            bool output = false;
            try
            {

                var systemDate = generalSetup.GetApplicationDate();

                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
                ///call disturbs loan method and posting
                //---------------save irregular loan schedule input---------------------------
                List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
                LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
                if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                {
                    var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                    foreach (var item in data)
                    {
                        TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
                        schedule.LOANREVIEWOPERATIONID = loanId;
                        schedule.PAYMENTDATE = item.paymentDate;
                        schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                        schedule.CREATEDBY = staffId;
                        schedule.DATETIMECREATED = applicationDate;

                        tblIrregularSchedule.Add(schedule);
                    }

                }
                //----------------------------------------------
                //----------generate and save periodic loan schedule -----------------------------------

                //loanInput.principalAmount = loanInput.newAmount;

                List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                List<TBL_LOAN_SCHEDULE_PERIODIC> tblPeriodicSchedule = new List<TBL_LOAN_SCHEDULE_PERIODIC>();
                foreach (var item in periodicSchedule)
                {
                    TBL_LOAN_SCHEDULE_PERIODIC schedule = new TBL_LOAN_SCHEDULE_PERIODIC();

                    schedule.LOANID = loanId;
                    schedule.PAYMENTNUMBER = item.paymentNumber;
                    schedule.PAYMENTDATE = item.paymentDate;
                    schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                    schedule.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                    schedule.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                    schedule.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                    schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                    schedule.INTERESTRATE = loanInput.interestRate;
                    schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                    schedule.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                    schedule.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                    schedule.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                    schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                    schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                    schedule.CREATEDBY = staffId;
                    schedule.DATETIMECREATED = systemDate;

                    tblPeriodicSchedule.Add(schedule);
                }
                //-------------------------------------------------------------------------------------


                //----------generate and save daily loan schedule -----------------------------------

                //loanInput.principalAmount = loanInput.newAmount;
                List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                List<TBL_LOAN_SCHEDULE_DAILY> tblDailySchedule = new List<TBL_LOAN_SCHEDULE_DAILY>();

                foreach (var item in dailySchedule)
                {
                    TBL_LOAN_SCHEDULE_DAILY schedule = new TBL_LOAN_SCHEDULE_DAILY();

                    schedule.LOANID = loanId;
                    schedule.PAYMENTNUMBER = item.paymentNumber;
                    schedule.DATE = item.date;
                    schedule.PAYMENTDATE = item.paymentDate;
                    schedule.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                    schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                    schedule.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                    schedule.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                    schedule.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                    schedule.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                    schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                    schedule.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                    schedule.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                    schedule.INTERESTRATE = item.norminalInterestRate;
                    schedule.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                    schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                    schedule.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                    schedule.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                    schedule.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                    schedule.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                    schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                    schedule.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                    schedule.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                    schedule.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                    schedule.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                    schedule.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                    schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                    schedule.NUMBEROFPERIODS = item.numberOfPeriods;
                    schedule.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                    schedule.CREATEDBY = staffId;
                    schedule.DATETIMECREATED = systemDate;

                    tblDailySchedule.Add(schedule);
                }
                //----------------------------------------------------------------

                //------------adding records to the database--------------------------

                //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                //{ this.context.tbl_Loan_Review_Operation_Irregular_Schedule.AddRange(tblIrregularSchedule); }////change to Temp table


                this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule);////change to Temp table

                this.context.TBL_LOAN_SCHEDULE_DAILY.AddRange(tblDailySchedule); ////change to Temp table
                context.SaveChanges();

                var outstInterest = from d in context.TBL_LOAN_SCHEDULE_PERIODIC
                                    where d.LOANID == loanId
                                    let sumPrincipalAmount = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(a => a.LOANID == loanId).Sum(a => a.PERIODINTERESTAMOUNT)
                                    select sumPrincipalAmount;
                var outstandingInterest = outstInterest.FirstOrDefault();
                //----------update loan details -----------------------------------
                //var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                loan.EFFECTIVEDATE = loanInput.effectiveDate;
                loan.MATURITYDATE = periodicSchedule.Max(x => x.paymentDate);
                loan.PRINCIPALNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                loan.INTERESTNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                loan.OUTSTANDINGPRINCIPAL = (decimal)loanInput.principalAmount;
                loan.OUTSTANDINGINTEREST = (decimal)(periodicSchedule.Select(x => x.periodInterestAmount)).Sum();
                //------------------------------------------------

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;

        }

        public bool TerminateAndRebookLoanSchedule(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, TwoFactorAutheticationViewModel twoFactorAuth, DateTime applicationDate, int staffId)
        {
            bool output = false;
            try
            {
                var systemDate = generalSetup.GetApplicationDate();
                loanInput.date = applicationDate;

                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
                decimal principalOutStandingBalance = loan.OUTSTANDINGPRINCIPAL;
                var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID);
                decimal accruedInterest = 0;
                var accrued = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                               where a.TBL_LOAN.TERMLOANID == loanId && a.DATE == applicationDate
                               select a).FirstOrDefault();

                if (accrued != null)
                {
                    accruedInterest = accrued.ACCRUEDINTEREST;
                }
                else
                {
                    throw new SecureException("Application Date not found in Payment Schedule");
                }
                accruedInterest = decimal.Round(accruedInterest, 2, MidpointRounding.AwayFromZero);
                principalOutStandingBalance = decimal.Round(principalOutStandingBalance, 2, MidpointRounding.AwayFromZero);
                decimal pastDue = decimal.Round((loan.PASTDUEINTEREST + loan.INTERESTONPASTDUEINTEREST + loan.INTERESTONPASTDUEPRINCIPAL), 2, MidpointRounding.AwayFromZero);
                decimal totalamount = (accruedInterest + principalOutStandingBalance + pastDue);

                List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                inputTransactions.Add(financeTransaction.TerminateAndRebookPosting(loanId, loanInput, accruedInterest, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest"));

                inputTransactions.Add(financeTransaction.TerminateAndRebookPosting(loanId, loanInput, principalOutStandingBalance, product.PRINCIPALBALANCEGL.Value, "Loan Outstanding Principal Balance"));

                TBL_LOAN results = (from p in context.TBL_LOAN
                                    where p.TERMLOANID == loanId
                                    select p).SingleOrDefault();


                CreateLoan(loanId);

                results.LOANSTATUSID = (short)LoanStatusEnum.Terminated;
                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;
            }

            return output;

        }

        public LoanViewModel CreateLoan(int loanId)
        {


            var data = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanId).FirstOrDefault();
            var refNo = loanGenerate.GenerateLoanReferenceNumber((int)data.BRANCHID, (int)data.PRODUCTID, (int)LoanSystemTypeEnum.TermDisbursedFacility);
            var model = (from b in context.TBL_LOAN_REVIEW_OPERATION
                         join a in context.TBL_LOAN on b.LOANID equals a.TERMLOANID
                         where b.LOANID == loanId && b.OPERATIONCOMPLETED == false
                         select new LoanViewModel()
                         {
                             productPriceIndexRate = a.PRODUCTPRICEINDEXRATE,
                             customerRiskRatingId = a.CUSTOMERRISKRATINGID,
                             customerId = a.CUSTOMERID,
                             productId = a.PRODUCTID,
                             companyId = a.COMPANYID,
                             casaAccountId = a.CASAACCOUNTID,
                             casaAccountId2 = (int)a.CASAACCOUNTID2,
                             branchId = a.BRANCHID,
                             currencyId = a.CURRENCYID,
                             exchangeRate = a.EXCHANGERATE,
                             loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                             loanReferenceNumber = refNo,
                             relatedloanReferenceNumber = a.LOANREFERENCENUMBER,
                             subSectorId = a.SUBSECTORID,
                             principalFrequencyTypeId = (short)b.PRINCIPALFREQUENCYTYPEID,
                             interestFrequencyTypeId = (short)b.INTERESTFREQUENCYTYPEID,
                             principalNumberOfInstallment = 0,
                             interestNumberOfInstallment = 0,
                             relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                             relationshipManagerId = a.RELATIONSHIPMANAGERID,
                             misCode = a.MISCODE,
                             teamMiscode = a.TEAMMISCODE,
                             interestRate = (double)b.INTERATERATE,
                             effectiveDate = b.EFFECTIVEDATE,
                             maturityDate = (DateTime)b.MATURITYDATE,
                             bookingDate = DateTime.Today,
                             principalAmount = (decimal)b.PREPAYMENT,
                             loanSystemTypeId = a.LOANSYSTEMTYPEID,
                             principalInstallmentLeft = 0,
                             interestInstallmentLeft = 0,
                             approvalStatusId = a.APPROVALSTATUSID,
                             approvedBy = a.APPROVEDBY,
                             approverComment = a.APPROVERCOMMENT,
                             dateApproved = DateTime.Today,
                             loanStatusId = (short)LoanStatusEnum.Active,
                             scheduleTypeId = (short)b.SCHEDULETYPEID,//1,///add column in table b
                             scheduleDayCountConventionId = 0,
                             scheduleDayInterestTypeId = 0,
                             shouldDisbursed = a.SHOULD_DISBURSE,
                             isDisbursed = true,
                             disbursedBy = null,
                             disburserComment = null,
                             disburseDate = DateTime.Today,
                             operationId = 1,
                             customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                             loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                             equityContribution = 0,
                             firstPrincipalPaymentDate = b.PRINCIPALFIRSTPAYMENTDATE,
                             firstInterestPaymentDate = b.INTERESTFIRSTPAYMENTDATE,
                             outstandingPrincipal = (decimal)b.PREPAYMENT,
                             outstandingInterest = 0,
                             pastDuePrincipal = 0,
                             pastDueInterest = 0,
                             interestOnPastDuePrincipal = 0,
                             interesrtOnPastDueInterest = 0,
                             penalChargeAmount = 0,
                             principalAdditionCount = 0,
                             principalReductionCount = 0,
                             fixedPrincipal = false,
                             profileLoan = false,
                             dischargeLetter = false,
                             suspendInterest = false,
                             isScheduledPrepayment = a.ISSCHEDULEDPREPAYMENT,
                             allowForceDebitRepayment = a.ALLOWFORCEDEBITREPAYMENT,
                             scheduledPrepaymentAmount = a.SCHEDULEDPREPAYMENTAMOUNT,
                             scheduledPrepaymentDate = a.SCHEDULEDPREPAYMENTDATE,
                             scheduledPrepaymentFrequencyTypeId = a.SCH_PREPAYMENT_FREQUENCY_TYPID,
                             internalPrudentialGuidelineStatusId = 1,
                             externalPrudentialGuidelineStatusId = 1,
                             userPrudentialGuidelineStatusId = 1,
                             nplDate = null,
                             createdBy = (int)SystemStaff.System,
                             dateTimeCreated = DateTime.Today,

                         }).FirstOrDefault();

            List<TBL_LOAN> loan = new List<TBL_LOAN>();

            TBL_LOAN addLoan = new TBL_LOAN();

            addLoan.PRODUCTPRICEINDEXRATE = model.productPriceIndexRate;
            addLoan.CUSTOMERRISKRATINGID = model.customerRiskRatingId;
            addLoan.LOANSYSTEMTYPEID = model.loanSystemTypeId;
            addLoan.CUSTOMERID = model.customerId;
            addLoan.PRODUCTID = model.productId;
            addLoan.COMPANYID = model.companyId;
            addLoan.CASAACCOUNTID = model.casaAccountId;
            addLoan.CASAACCOUNTID2 = model.casaAccountId2;
            addLoan.BRANCHID = model.branchId;
            addLoan.CURRENCYID = (short)model.currencyId;
            addLoan.EXCHANGERATE = model.exchangeRate;
            addLoan.LOANAPPLICATIONDETAILID = model.loanApplicationDetailId;
            addLoan.LOANREFERENCENUMBER = model.loanReferenceNumber;
            addLoan.RELATED_LOAN_REFERENCE_NUMBER = model.relatedloanReferenceNumber;
            addLoan.SUBSECTORID = model.subSectorId;
            addLoan.PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId;
            addLoan.INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId;
            addLoan.PRINCIPALNUMBEROFINSTALLMENT = model.principalNumberOfInstallment;
            addLoan.INTERESTNUMBEROFINSTALLMENT = model.interestNumberOfInstallment;
            addLoan.RELATIONSHIPOFFICERID = model.relationshipOfficerId;
            addLoan.RELATIONSHIPMANAGERID = model.relationshipManagerId;
            addLoan.MISCODE = model.misCode;
            addLoan.TEAMMISCODE = model.teamMiscode;
            addLoan.INTERESTRATE = model.interestRate;
            addLoan.EFFECTIVEDATE = model.effectiveDate;
            addLoan.MATURITYDATE = model.maturityDate;
            addLoan.BOOKINGDATE = model.bookingDate;
            addLoan.PRINCIPALAMOUNT = model.principalAmount;
            addLoan.PRINCIPALINSTALLMENTLEFT = model.principalInstallmentLeft;
            addLoan.INTERESTINSTALLMENTLEFT = model.interestInstallmentLeft;
            addLoan.APPROVALSTATUSID = model.approvalStatusId;
            addLoan.APPROVEDBY = model.approvedBy;
            addLoan.APPROVERCOMMENT = model.approverComment;
            addLoan.DATEAPPROVED = model.dateApproved;
            addLoan.LOANSTATUSID = model.loanStatusId;
            addLoan.SCHEDULETYPEID = model.scheduleTypeId;
            addLoan.SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountConventionId;
            addLoan.SCHEDULEDAYINTERESTTYPEID = model.scheduleDayInterestTypeId;
            addLoan.SHOULD_DISBURSE = model.shouldDisbursed;
            addLoan.ISDISBURSED = model.isDisbursed;
            addLoan.DISBURSEDBY = model.disbursedBy;
            addLoan.DISBURSERCOMMENT = model.disburserComment;
            addLoan.DISBURSEDATE = model.disburseDate;
            addLoan.OPERATIONID = model.operationId;
            addLoan.EQUITYCONTRIBUTION = model.equityContribution;
            addLoan.FIRSTPRINCIPALPAYMENTDATE = model.firstPrincipalPaymentDate;
            addLoan.FIRSTINTERESTPAYMENTDATE = model.firstInterestPaymentDate;
            addLoan.OUTSTANDINGPRINCIPAL = model.outstandingPrincipal;
            addLoan.OUTSTANDINGINTEREST = model.outstandingInterest;
            addLoan.PASTDUEPRINCIPAL = model.pastDuePrincipal;
            addLoan.PASTDUEINTEREST = model.pastDueInterest;
            addLoan.INTERESTONPASTDUEPRINCIPAL = model.interestOnPastDuePrincipal;
            addLoan.INTERESTONPASTDUEINTEREST = model.interesrtOnPastDueInterest;
            addLoan.PENALCHARGEAMOUNT = model.penalChargeAmount;
            addLoan.PRINCIPALADDITIONCOUNT = model.principalAdditionCount;
            addLoan.PRINCIPALREDUCTIONCOUNT = model.principalReductionCount;
            addLoan.FIXEDPRINCIPAL = model.fixedPrincipal;
            addLoan.PROFILELOAN = model.profileLoan;
            addLoan.DISCHARGELETTER = model.dischargeLetter;
            addLoan.SUSPENDINTEREST = model.suspendInterest;
            addLoan.ISSCHEDULEDPREPAYMENT = model.isScheduledPrepayment;
            addLoan.ALLOWFORCEDEBITREPAYMENT = model.allowForceDebitRepayment;
            addLoan.SCHEDULEDPREPAYMENTAMOUNT = model.scheduledPrepaymentAmount;
            addLoan.SCHEDULEDPREPAYMENTDATE = model.scheduledPrepaymentDate;
            addLoan.LOANSYSTEMTYPEID = model.loanSystemTypeId;
            addLoan.SCH_PREPAYMENT_FREQUENCY_TYPID = model.scheduledPrepaymentFrequencyTypeId;
            addLoan.INT_PRUDENT_GUIDELINE_STATUSID = (int)model.internalPrudentialGuidelineStatusId;
            addLoan.EXT_PRUDENT_GUIDELINE_STATUSID = (int)model.externalPrudentialGuidelineStatusId;
            addLoan.USER_PRUDENTIAL_GUIDE_STATUSID = (int)model.userPrudentialGuidelineStatusId;
            addLoan.NPLDATE = model.nplDate;
            addLoan.CREATEDBY = model.createdBy;
            addLoan.DATETIMECREATED = model.dateTimeCreated;

            loan.Add(addLoan);
            this.context.TBL_LOAN.AddRange(loan);

            context.SaveChanges();
            return model;
        }

        public bool FullAndFinalCompleteWriteOff(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, TwoFactorAutheticationViewModel twoFactorAuth, DateTime applicationDate, int staffId)
        {
            bool output = false;

            try
            {

                var systemDate = generalSetup.GetApplicationDate();

                loanInput.date = systemDate;

                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
                decimal principalOutStandingBalance = loan.OUTSTANDINGPRINCIPAL + loan.PASTDUEPRINCIPAL;
                //var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID);
                var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID2);

                principalOutStandingBalance = decimal.Round(principalOutStandingBalance, 2, MidpointRounding.AwayFromZero);
                decimal pastDueInterest = decimal.Round((loan.PASTDUEINTEREST), 2, MidpointRounding.AwayFromZero);
                decimal totalamountPrincipalAmount = (principalOutStandingBalance);
                decimal interestOnPastDue = loan.INTERESTONPASTDUEINTEREST + loan.INTERESTONPASTDUEPRINCIPAL;

                decimal totalamountInterestAmount = (interestOnPastDue + pastDueInterest);

                decimal totalamount = (totalamountPrincipalAmount + totalamountInterestAmount);

                var _otherOperationAccount = context.TBL_OTHER_OPERATION_ACCOUNT.Where(x => x.OTHEROPERATIONID == (int)OtherOperationEnum.WriteOffLoanFacilities).FirstOrDefault();

                var otherOperationAccount = context.TBL_OTHER_OPERATION_ACCOUNT.Where(x => x.OTHEROPERATIONID == (int)OtherOperationEnum.PrincipalOffBalansheetCompleteWriteOffAccount).FirstOrDefault();

                var sllp = _otherOperationAccount.GLACCOUNTID;

                if (totalamount != 0)
                {
                    financeTransaction.PostTerminateAndRebookEntries(loanId, loanInput, totalamount, sllp, "Full And Final Complete Write-off", twoFactorAuth);

                    financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, totalamount, otherOperationAccount.GLACCOUNTID, (int)otherOperationAccount.GLACCOUNTID2, "Full And Final Complete Write-off", twoFactorAuth);

                }


                TBL_LOAN results = (from p in context.TBL_LOAN
                                    where p.TERMLOANID == loanId
                                    select p).SingleOrDefault();

                results.LOANSTATUSID = (short)LoanStatusEnum.FullAndFinalWriteOff;
                results.FULLANDFINALSTATUSID = (int)FullAndFinalStatusEnum.Completed;
                context.SaveChanges();

                TBL_LOAN_CAMSOL loanCamsol = new TBL_LOAN_CAMSOL();
                var customer = context.TBL_CUSTOMER.FirstOrDefault(x => x.CUSTOMERID == loanInput.customerId);
                loanCamsol.LOANID = loanId;
                loanCamsol.COMPANYID = loanInput.companyId;
                loanCamsol.BALANCE = totalamount;
                loanCamsol.DATE = applicationDate;
                loanCamsol.CUSTOMERCODE = customer.CUSTOMERCODE;
                loanCamsol.LOANSYSTEMTYPEID = (int)LoanSystemTypeEnum.TermDisbursedFacility;
                loanCamsol.CUSTOMERNAME = customer.FIRSTNAME + ' ' + customer.LASTNAME;
                loanCamsol.PRINCIPAL = totalamount;
                loanCamsol.INTERESTINSUSPENSE = 0;
                loanCamsol.CAMSOLTYPEID = (int)CamsolTypeEnum.FullAndFinal;///create casmol type enum
                loanCamsol.ACCOUNTNUMBER = casa.PRODUCTACCOUNTNUMBER;
                loanCamsol.ACCOUNTNAME = casa.PRODUCTACCOUNTNAME;
                loanCamsol.REMARK = "Full And Final Complete Write off";
                loanCamsol.CANTAKELOAN = false;
                loanCamsol.CREATEDBY = staffId;
                loanCamsol.DATETIMECREATED = applicationDate;
                loanCamsol.DELETED = false;
                loanCamsol.DATE = applicationDate;
                loanCamsol.WRITTENOFFACCRUALAMOUNT = 0;

                this.context.TBL_LOAN_CAMSOL.Add(loanCamsol);

                context.SaveChanges();

                output = true;

            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;

        }

        public bool CompleteWriteOff(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, TwoFactorAutheticationViewModel twoFactorAuth, DateTime applicationDate, int staffId)
        {
            bool output = false;

            try
            {

                var systemDate = generalSetup.GetApplicationDate();

                loanInput.date = systemDate;

                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
                decimal principalOutStandingBalance = loan.OUTSTANDINGPRINCIPAL + loan.PASTDUEPRINCIPAL;
                var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID2);
                //var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID);

                //decimal accruedInterest = 0;
                //var accrued = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                //               where a.TBL_LOAN.TERMLOANID == loanId && a.DATE == loanInput.date
                //               select a).FirstOrDefault();

                //if (accrued != null)
                //{
                //    accruedInterest = accrued.ACCRUEDINTEREST;
                //}
                ////else
                ////{
                ////    throw new SecureException("Application Date not found in Payment Schedule");
                ////}

                //accruedInterest = decimal.Round(accruedInterest, 2, MidpointRounding.AwayFromZero);


                principalOutStandingBalance = decimal.Round(principalOutStandingBalance, 2, MidpointRounding.AwayFromZero);
                decimal pastDueInterest = decimal.Round((loan.PASTDUEINTEREST), 2, MidpointRounding.AwayFromZero);
                decimal totalamountPrincipalAmount = (principalOutStandingBalance);
                decimal interestOnPastDue = loan.INTERESTONPASTDUEINTEREST + loan.INTERESTONPASTDUEPRINCIPAL;


                //decimal totalamountInterestAmount = (interestOnPastDue + accruedInterest + pastDueInterest);

                decimal totalamountInterestAmount = (interestOnPastDue + pastDueInterest);

                decimal totalamount = (totalamountPrincipalAmount + totalamountInterestAmount);

                //var _otherOperation = context.TBL_OTHER_OPERATION.Where(x => x.OTHEROPERATIONID == (int)OtherOperationEnum.WriteOffLoanFacilities).FirstOrDefault();

                var _otherOperationAccount = context.TBL_OTHER_OPERATION_ACCOUNT.Where(x => x.OTHEROPERATIONID == (int)OtherOperationEnum.WriteOffLoanFacilities).FirstOrDefault();

                var otherOperationAccount = context.TBL_OTHER_OPERATION_ACCOUNT.Where(x => x.OTHEROPERATIONID == (int)OtherOperationEnum.PrincipalOffBalansheetCompleteWriteOffAccount).FirstOrDefault();

                if (_otherOperationAccount == null) { throw new ConditionNotMetException(" No operation account for the write-off loan facility"); }

                if (otherOperationAccount == null) { throw new ConditionNotMetException(" No operation account for Principal Off Balansheet Complete WriteOff Account"); }
                //if (_otherOperationEnum == null)


                //var sllp = 27;////Get SLLP GL

                var sllp = _otherOperationAccount.GLACCOUNTID;

                //List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();


                if (principalOutStandingBalance != 0)
                {
                    financeTransaction.PostTerminateAndRebookEntries(loanId, loanInput, principalOutStandingBalance, sllp, "principal Write off", twoFactorAuth);

                    financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, principalOutStandingBalance, otherOperationAccount.GLACCOUNTID, (int)otherOperationAccount.GLACCOUNTID2, "principal Write off", twoFactorAuth);

                }

                if (pastDueInterest != 0)
                {
                    twoFactorAuth.skipAuthentication = true;

                    var creditGL = product.INTERESTRECEIVABLEPAYABLEGL.Value;

                    financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, pastDueInterest, sllp, creditGL, "past due interest write off", twoFactorAuth);

                    financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, pastDueInterest, otherOperationAccount.GLACCOUNTID, (int)otherOperationAccount.GLACCOUNTID2, "past due interest write off", twoFactorAuth);

                    //var debitGL = product.INTERESTINCOMEEXPENSEGL.Value;
                    //var creditGL = product.INTERESTRECEIVABLEPAYABLEGL.Value;

                    //financeTransaction.PostLoanGLEntries(loanInput, pastDueInterest, debitGL, creditGL, "past due interest write off", loanInput.operationId);

                }

                //if (accruedInterest != 0)
                //{
                //    //var debitGL = product.INTERESTINCOMEEXPENSEGL.Value;
                //    var creditGL = product.INTERESTRECEIVABLEPAYABLEGL.Value;

                //    //financeTransaction.PostLoanGLEntries(loanInput, accruedInterest, debitGL, creditGL, "Accrued Interest Reversal", loanInput.operationId);


                //    //financeTransaction.PostTerminateAndRebookEntries(loanId, loanInput, accruedInterest, sllp, "Accrued Interest Reversal", twoFactorAuth);


                //    financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, accruedInterest, sllp, creditGL, "Accrued Interest On Write-off", twoFactorAuth);

                //    financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, accruedInterest, otherOperationAccount.GLACCOUNTID, (int)otherOperationAccount.GLACCOUNTID2, "Accrued Interest On Write-off", twoFactorAuth);


                //}

                if (interestOnPastDue > 0)
                {
                    //var debitGL = product.PENALCHARGEGL.Value;
                    var creditGL = product.PENALCHARGEGL.Value;

                    //financeTransaction.PostLoanGLEntries(loanInput, interestOnPastDue, debitGL, creditGL, "interest on past due write off", loanInput.operationId);


                    //financeTransaction.PostTerminateAndRebookEntries(loanId, loanInput, accruedInterest, sllp, "interest on past due write off", twoFactorAuth);

                    financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, interestOnPastDue, sllp, creditGL, "interest on past due write off", twoFactorAuth);

                    financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, interestOnPastDue, otherOperationAccount.GLACCOUNTID, (int)otherOperationAccount.GLACCOUNTID2, "interest on past due write off", twoFactorAuth);


                }


                TBL_LOAN results = (from p in context.TBL_LOAN
                                    where p.TERMLOANID == loanId
                                    select p).SingleOrDefault();

                results.LOANSTATUSID = (short)LoanStatusEnum.WriteOff;
                context.SaveChanges();

                TBL_LOAN_CAMSOL loanCamsol = new TBL_LOAN_CAMSOL();
                var customer = context.TBL_CUSTOMER.FirstOrDefault(x => x.CUSTOMERID == loanInput.customerId);
                loanCamsol.LOANID = loanId;
                loanCamsol.COMPANYID = loanInput.companyId;
                loanCamsol.BALANCE = totalamount;
                loanCamsol.DATE = applicationDate;
                loanCamsol.CUSTOMERCODE = customer.CUSTOMERCODE;
                loanCamsol.LOANSYSTEMTYPEID = (int)LoanSystemTypeEnum.TermDisbursedFacility;
                loanCamsol.CUSTOMERNAME = customer.FIRSTNAME + ' ' + customer.LASTNAME;
                loanCamsol.PRINCIPAL = totalamountPrincipalAmount;
                loanCamsol.INTERESTINSUSPENSE = totalamountInterestAmount;
                loanCamsol.CAMSOLTYPEID = 1;///create casmol type enum
                loanCamsol.ACCOUNTNUMBER = casa.PRODUCTACCOUNTNUMBER;
                loanCamsol.ACCOUNTNAME = casa.PRODUCTACCOUNTNAME;
                loanCamsol.REMARK = "Write off";
                loanCamsol.CANTAKELOAN = false;
                loanCamsol.CREATEDBY = staffId;
                loanCamsol.DATETIMECREATED = applicationDate;
                loanCamsol.DELETED = false;
                loanCamsol.DATE = applicationDate;
                loanCamsol.WRITTENOFFACCRUALAMOUNT = 0;


                this.context.TBL_LOAN_CAMSOL.Add(loanCamsol);
                CasaLienViewModel lien = new CasaLienViewModel();

                lien.productAccountNumber = casa.PRODUCTACCOUNTNUMBER;
                lien.sourceReferenceNumber = loan.LOANREFERENCENUMBER;
                lien.lienAmount = totalamount;
                lien.branchId = loan.BRANCHID;
                lien.companyId = loan.COMPANYID;
                lien.lienTypeId = (short)LienTypeEnum.WriteOff;
                lien.createdBy = (int)SystemStaff.System;
                lien.description = "lien placed due to Loan Write Off";

                twoFactorAuth.skipAuthentication = true;

                var lienReference = casaLien.PlaceLien(lien, twoFactorAuth);



                //var result = context.SaveChanges() > 0;

                context.SaveChanges();

                //if (result)
                //{
                output = true;
                // }
            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;

        }

        public bool LoanCancellation(int loanId, DateTime applicationDate, int staffId)
        {
            bool output = false;
            try
            {
                var systemDate = generalSetup.GetApplicationDate();

                TBL_LOAN results = (from p in context.TBL_LOAN
                                    where p.TERMLOANID == loanId
                                    select p).SingleOrDefault();

                results.LOANSTATUSID = (short)LoanStatusEnum.Cancelled;

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;
        }


        public bool LoanWorkOut(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        {
            bool output = false;
            try
            {
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();

                var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);

                ArchiveLoan(loanId, (int)OperationsEnum.FullAndFinalCompleteWriteOff, archiveBatchCode);/////loanId change this to OperationId

                loan.FULLANDFINALSTATUSID = (int)FullAndFinalStatusEnum.OnGoing;

                context.SaveChanges();

                output = true;

            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;

        }

        //public bool LoanWorkOut(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        //{
        //    bool output = false;
        //    int installmentNo = 0;
        //    try
        //    {
        //        var systemDate = generalSetup.GetApplicationDate();
        //        var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();
        //        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
        //        var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
        //        var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID);
        //        //loanInput.principalAmount = loanInput.payAmount;
        //        //var sllp = 27;////Get SLLP GL

        //        //if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.BulletPayment)
        //        //{
        //        //    installmentNo = 3;
        //        //}
        //        //else if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.BallonPayment)
        //        //{
        //        //    installmentNo = 7;
        //        //}

        //        if (LoanExist(loanId) > 0)
        //        {
        //            var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
        //            DeleteLoanExist(loanId, systemDate);
        //            ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
        //            ArchivePeriodicSchedule(loanId, archiveBatchCode);
        //            ArchiveDailySchedule(loanId, archiveBatchCode);

        //            List<IrregularLoanScheduleInputViewModel> irregularSchedule = new List<IrregularLoanScheduleInputViewModel>();
        //            {
        //                var scheduleInput = context.TBL_LOAN_REVIEW_OPRATN_IREG_SC.Where(x => x.LOANREVIEWOPERATIONID == reviewData.LOANREVIEWOPERATIONID);

        //                foreach (var model2 in scheduleInput)
        //                {
        //                    irregularSchedule.Add(new IrregularLoanScheduleInputViewModel { paymentAmount = (double)model2.PAYMENTAMOUNT, paymentDate = model2.PAYMENTDATE });
        //                }

        //                loanInput.irregularPaymentSchedule = irregularSchedule.OrderBy(x => x.paymentDate).ToList();
        //            }


        //            //---------------save irregular loan schedule input---------------------------
        //            //List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
        //            //LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;

        //            //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
        //            //{
        //            //    var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
        //            //    foreach (var item in data)
        //            //    {
        //            //        TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
        //            //        schedule.LOANREVIEWOPERATIONID = loanId;
        //            //        schedule.PAYMENTDATE = item.paymentDate;
        //            //        schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
        //            //        schedule.CREATEDBY = staffId;
        //            //        schedule.DATETIMECREATED = applicationDate;

        //            //        tblIrregularSchedule.Add(schedule);
        //            //    }

        //            //}
        //            //----------------------------------------------

        //            //----------generate and save periodic loan schedule -----------------------------------
        //            List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

        //            List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();
        //            foreach (var item in periodicScheduleTemp)
        //            {
        //                TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

        //                scheduleTemp.LOANID = loanId;
        //                scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
        //                scheduleTemp.PAYMENTDATE = item.paymentDate;
        //                scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
        //                scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
        //                scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
        //                scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                scheduleTemp.INTERESTRATE = loanInput.interestRate;
        //                scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
        //                scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
        //                scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
        //                scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
        //                scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
        //                scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                scheduleTemp.CREATEDBY = staffId;
        //                scheduleTemp.DATETIMECREATED = systemDate;

        //                tblPeriodicScheduleTemp.Add(scheduleTemp);
        //            }
        //            //-------------------------------------------------------------------------------------

        //            //----------generate and save daily loan schedule -----------------------------------
        //            List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

        //            List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

        //            foreach (var item in dailyScheduleTemp)
        //            {
        //                TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

        //                scheduleTemp.LOANID = loanId;
        //                scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
        //                scheduleTemp.DATE = item.date;
        //                scheduleTemp.PAYMENTDATE = item.paymentDate;
        //                scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
        //                scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
        //                scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
        //                scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
        //                scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
        //                scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
        //                scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
        //                scheduleTemp.INTERESTRATE = item.norminalInterestRate;
        //                scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
        //                scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
        //                scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
        //                scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
        //                scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
        //                scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
        //                scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
        //                scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
        //                scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
        //                scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
        //                scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
        //                scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
        //                scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
        //                scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
        //                scheduleTemp.CREATEDBY = staffId;
        //                scheduleTemp.DATETIMECREATED = systemDate;

        //                tblDailyScheduleTemp.Add(scheduleTemp);
        //            }
        //            //----------------------------------------------------------------


        //            //------------adding records to the database--------------------------

        //            //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
        //            //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table


        //            this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

        //            this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
        //            context.SaveChanges();

        //            MergeDailySchedule(loanId, applicationDate);
        //            MergePeriodicSchedule(loanId, applicationDate);
        //            //----------update loan details -----------------------------------
        //            //var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
        //            loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
        //            loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
        //            loan.INTERESTNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
        //            loan.PASTDUEPRINCIPAL = 0;
        //            loan.PASTDUEINTEREST = 0;
        //            loan.INTERESTONPASTDUEPRINCIPAL = 0;
        //            loan.INTERESTONPASTDUEINTEREST = 0;
        //            loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
        //            loan.INTERESTRATE = (double)reviewData.INTERATERATE;
        //            loan.INTERESTFREQUENCYTYPEID = (short)(reviewData.INTERESTFREQUENCYTYPEID == 0 ? installmentNo : reviewData.INTERESTFREQUENCYTYPEID);
        //            loan.PRINCIPALFREQUENCYTYPEID = (short)(reviewData.PRINCIPALFREQUENCYTYPEID == 0 ? installmentNo : reviewData.PRINCIPALFREQUENCYTYPEID);
        //            loan.FIRSTINTERESTPAYMENTDATE = reviewData.INTERESTFIRSTPAYMENTDATE;
        //            loan.FIRSTPRINCIPALPAYMENTDATE = reviewData.PRINCIPALFIRSTPAYMENTDATE;
        //            //-------------------------------------------------



        //            //-------------------------------------------------------
        //        }


        //        var result = context.SaveChanges() > 0;
        //        if (result)
        //        {
        //            output = true;
        //        }
        //    }
        //    catch (Exception ex)
        //    {

        //        throw ex;
        //    }
        //    return output;

        //}

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool LoanRecapitilization(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        {
            TwoFactorAutheticationViewModel twoFactorAuth = new TwoFactorAutheticationViewModel();
            twoFactorAuth.skipAuthentication = true;

            bool output = false;
            int installmentNo = 0;
            try
            {
                var systemDate = generalSetup.GetApplicationDate();
                var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();
                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
                var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID);
                loanInput.principalAmount = loanInput.payAmount;

                List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                decimal pastdueinterest = loan.PASTDUEINTEREST;
                //decimal pastdueprincipal = loan.PASTDUEPRINCIPAL;
                decimal interestOnpastdueinterest = loan.INTERESTONPASTDUEINTEREST;
                decimal interestOnpastdueprincipal = loan.INTERESTONPASTDUEPRINCIPAL;

                decimal accruedInterest = 0;
                var accrued = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                               where a.TBL_LOAN.TERMLOANID == loanId && a.DATE == applicationDate
                               select a).FirstOrDefault();

                if (accrued != null)
                {
                    accruedInterest = accrued.ACCRUEDINTEREST;
                    inputTransactions.AddRange(financeTransaction.BuildRecapitalisationAccuredInterestReceivablePosting(loanId, loanInput, accruedInterest, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest"));
                }

                if (pastdueinterest > 0)
                {
                    inputTransactions.AddRange(financeTransaction.BuildRecapitalisationAccuredInterestReceivablePosting(loanId, loanInput, pastdueinterest, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Past-Due Interest"));
                }

                if (interestOnpastdueinterest > 0)
                {
                    inputTransactions.AddRange(financeTransaction.BuildRecapitalisationAccuredInterestReceivablePosting(loanId, loanInput, interestOnpastdueinterest, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Interest On Past-Due Interest"));
                }

                if (interestOnpastdueprincipal > 0)
                {
                    inputTransactions.AddRange(financeTransaction.BuildRecapitalisationAccuredInterestReceivablePosting(loanId, loanInput, interestOnpastdueprincipal, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Interest On Past-Due Principal"));
                }

                /////split all the outstanding balance i.e pastdue interest and principal, interest on both interest and principal pastdue
                var sllp = 27;////Get SLLP GL

                if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.BulletPayment)
                {
                    installmentNo = 3;
                }
                else if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.BallonPayment)
                {
                    installmentNo = 7;
                }


                //List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                //inputTransactions.Add(financeTransaction.BuildAccuredInterestReceivablePosting(loanId, loanInput, accruedInterest, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest"));

                //inputTransactions.Add(financeTransaction.BuildTerminateAndRebookPosting(loanId, loanInput, accruedInterest, product.INTERESTRECEIVABLEPAYAB

                //inputTransactions.Add(financeTransaction.BuildTerminateAndRebookPosting(loanId, loanInput, accruedInterest, product.INTERESTRECEIVABLEPAYAB
                //inputTransactions.Add(financeTransaction.BuildTerminateAndRebookPosting(loanId, loanInput, accruedInterest, product.INTERESTRECEIVABLEPAYAB
                //inputTransactions.Add(financeTransaction.BuildTerminateAndRebookPosting(loanId, loanInput, accruedInterest, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest"));

                //posting will happen here



                if (LoanExist(loanId) > 0)
                {
                    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
                    DeleteLoanExist(loanId, systemDate);
                    ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
                    ArchivePeriodicSchedule(loanId, archiveBatchCode);
                    ArchiveDailySchedule(loanId, archiveBatchCode);

                    //---------------save irregular loan schedule input---------------------------
                    List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
                    LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
                    if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                    {
                        var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                        foreach (var item in data)
                        {
                            TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
                            schedule.LOANREVIEWOPERATIONID = loanId;
                            schedule.PAYMENTDATE = item.paymentDate;
                            schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                            schedule.CREATEDBY = staffId;
                            schedule.DATETIMECREATED = applicationDate;

                            tblIrregularSchedule.Add(schedule);
                        }

                    }
                    //----------------------------------------------

                    //----------generate and save periodic loan schedule -----------------------------------
                    List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                    List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();
                    foreach (var item in periodicScheduleTemp)
                    {
                        TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

                        scheduleTemp.LOANID = loanId;
                        scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                        scheduleTemp.PAYMENTDATE = item.paymentDate;
                        scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                        scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                        scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                        scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                        scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                        scheduleTemp.INTERESTRATE = loanInput.interestRate;
                        scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                        scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                        scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                        scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                        scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                        scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                        scheduleTemp.CREATEDBY = staffId;
                        scheduleTemp.DATETIMECREATED = systemDate;

                        tblPeriodicScheduleTemp.Add(scheduleTemp);
                    }
                    //-------------------------------------------------------------------------------------

                    //----------generate and save daily loan schedule -----------------------------------
                    List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                    List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

                    foreach (var item in dailyScheduleTemp)
                    {
                        TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

                        scheduleTemp.LOANID = loanId;
                        scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                        scheduleTemp.DATE = item.date;
                        scheduleTemp.PAYMENTDATE = item.paymentDate;
                        scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                        scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                        scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                        scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                        scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                        scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                        scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                        scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                        scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                        scheduleTemp.INTERESTRATE = item.norminalInterestRate;
                        scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                        scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                        scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                        scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                        scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                        scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                        scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                        scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                        scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                        scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                        scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                        scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                        scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                        scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
                        scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                        scheduleTemp.CREATEDBY = staffId;
                        scheduleTemp.DATETIMECREATED = systemDate;

                        tblDailyScheduleTemp.Add(scheduleTemp);
                    }
                    //----------------------------------------------------------------


                    //------------adding records to the database--------------------------

                    //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                    //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table


                    this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

                    this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
                    context.SaveChanges();

                    UpdateDailySchedule(loanId, applicationDate);
                    UpdatePeriodicSchedule(loanId, applicationDate);


                    //----------update loan details -----------------------------------
                    //var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                    loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                    loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                    loan.INTERESTNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                    loan.PASTDUEPRINCIPAL = 0;
                    loan.PASTDUEINTEREST = 0;
                    loan.INTERESTONPASTDUEPRINCIPAL = 0;
                    loan.INTERESTONPASTDUEINTEREST = 0;
                    loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
                    loan.INTERESTRATE = (double)reviewData.INTERATERATE;
                    loan.INTERESTFREQUENCYTYPEID = (short)(reviewData.INTERESTFREQUENCYTYPEID == 0 ? installmentNo : reviewData.INTERESTFREQUENCYTYPEID);
                    loan.PRINCIPALFREQUENCYTYPEID = (short)(reviewData.PRINCIPALFREQUENCYTYPEID == 0 ? installmentNo : reviewData.PRINCIPALFREQUENCYTYPEID);
                    loan.FIRSTINTERESTPAYMENTDATE = reviewData.INTERESTFIRSTPAYMENTDATE;
                    loan.FIRSTPRINCIPALPAYMENTDATE = reviewData.PRINCIPALFIRSTPAYMENTDATE;
                    loan.OUTSTANDINGPRINCIPAL = (decimal)periodicScheduleTemp.Sum(x => x.periodPrincipalAmount);
                    loan.PRINCIPALAMOUNT = loan.OUTSTANDINGPRINCIPAL; // to discuss
                    loan.OUTSTANDINGINTEREST = (decimal)periodicScheduleTemp.Sum(x => x.periodInterestAmount);
                    //-------------------------------------------------

                    //-------------------------------------------------------
                }

                if (inputTransactions.Count > 0)
                    financeTransaction.PostTransaction(inputTransactions, false, twoFactorAuth);

                context.SaveChanges();

                return true;
                //var result = context.SaveChanges() > 0;
                //if (result)
                //{
                //    output = true;
                //}
            }
            catch (Exception ex)
            {
                //output = false;
                throw ex;
            }

        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public IEnumerable<DailyInterestAccrualViewModel> InterestSuspension(int loanId, DateTime applicationDate, int staffId)
        {
            var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

            TBL_LOAN result = (from p in context.TBL_LOAN
                               where p.TERMLOANID == loanId
                               select p).SingleOrDefault();

            result.SUSPENDINTEREST = true;

            context.SaveChanges();

            var data = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                        join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                        join c in context.TBL_LOAN_SCHEDULE_PERIODIC on b.TERMLOANID equals c.LOANID
                        join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
                        where a.DATE == DbFunctions.TruncateTime(applicationDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active
                        && a.PAYMENTDATE == c.PAYMENTDATE && a.LOANID == loanId && b.SUSPENDINTEREST == true

                        select new DailyInterestAccrualViewModel()
                        {
                            referenceNumber = b.LOANREFERENCENUMBER,
                            productId = b.PRODUCTID,
                            branchId = b.BRANCHID,
                            companyId = b.COMPANYID,
                            currencyId = b.CURRENCYID,
                            exchangeRate = b.EXCHANGERATE,
                            interestRate = a.INTERESTRATE,
                            date = applicationDate,
                            dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT,
                            mainAmount = c.PERIODINTERESTAMOUNT,
                            categoryId = (short)DailyAccrualCategory.TermLoan,
                            transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                            baseReferenceNumber = null,
                            dayCountConventionId = d.DAYCOUNTCONVENTIONID,

                        });

            List<TBL_DAILY_ACCRUAL> transAccrual = new List<TBL_DAILY_ACCRUAL>();

            foreach (var item in data)
            {
                TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                dailyAccrual.PRODUCTID = item.productId;
                dailyAccrual.BRANCHID = item.branchId;
                dailyAccrual.EXCHANGERATE = item.exchangeRate;
                dailyAccrual.CURRENCYID = item.currencyId;
                dailyAccrual.INTERESTRATE = item.interestRate;
                dailyAccrual.DATE = item.date;
                dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs(item.dailyAccuralAmount);
                dailyAccrual.MAINAMOUNT = item.mainAmount;
                dailyAccrual.CATEGORYID = item.categoryId;
                dailyAccrual.COMPANYID = item.companyId;
                dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
                dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
                dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;

                transAccrual.Add(dailyAccrual);

            }
            this.context.TBL_DAILY_ACCRUAL.AddRange(transAccrual);

            context.SaveChanges();

            var model = (from a in context.TBL_DAILY_ACCRUAL
                         where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan
                         group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, a.EXCHANGERATE } into groupedQ
                         select new DailyInterestAccrualViewModel()
                         {
                             productId = groupedQ.Key.PRODUCTID,
                             branchId = groupedQ.Key.BRANCHID,
                             companyId = groupedQ.Key.COMPANYID,
                             currencyId = groupedQ.Key.CURRENCYID,
                             exchangeRate = groupedQ.Key.EXCHANGERATE,
                             dailyAccuralAmount = (double)groupedQ.Sum(i => i.DAILYACCURALAMOUNT),
                         });

            foreach (var item in model)
            {
                item.date = applicationDate;
                financeTransaction.PostDailyInterestSuspension(item, loanId, applicationDate, staffId);
            }

            return data;
        }

        public bool LoanSales(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, TwoFactorAutheticationViewModel twoFactorAuth, DateTime applicationDate, int staffId)
        {
            bool output = false;
            try
            {

                var systemDate = generalSetup.GetApplicationDate();

                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
                decimal principalOutStandingBalance = loan.OUTSTANDINGPRINCIPAL;
                var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID);
                decimal accruedInterest = 0;
                var accrued = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                               where a.TBL_LOAN.TERMLOANID == loanId && a.DATE == applicationDate
                               select a).FirstOrDefault();

                if (accrued != null)
                {
                    accruedInterest = accrued.ACCRUEDINTEREST;
                }
                else
                {
                    throw new SecureException("Application Date not found in Payment Schedule");
                }
                accruedInterest = decimal.Round(accruedInterest, 2, MidpointRounding.AwayFromZero);
                principalOutStandingBalance = decimal.Round(principalOutStandingBalance, 2, MidpointRounding.AwayFromZero);
                decimal pastDue = decimal.Round((loan.PASTDUEINTEREST + loan.INTERESTONPASTDUEINTEREST + loan.INTERESTONPASTDUEPRINCIPAL), 2, MidpointRounding.AwayFromZero);
                decimal totalamount = (accruedInterest + principalOutStandingBalance + pastDue);

                decimal writeOffAmount = totalamount - (decimal)loanInput.payAmount;

                var sllp = 11;////Get SLLP GL
                var GLAccount = this.context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanInput.loanId && x.OPERATIONTYPEID == loanInput.operationId
                && x.OPERATIONCOMPLETED == false).FirstOrDefault();

                int casaGLAccount = (int)GLAccount.CASA_ACCOUNTID;

                List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                inputTransactions.Add(financeTransaction.TerminateAndRebookPosting(loanId, loanInput, writeOffAmount, sllp, "Loan Write-Off Amount"));

                inputTransactions.Add(financeTransaction.TerminateAndRebookPosting(loanId, loanInput, (decimal)loanInput.payAmount, casaGLAccount, "Loan Sales Amount"));

                //financeTransaction.PostTransaction(inputTransactions, false, twoFactorAuth);

                // Audit Section ---------------------------            

                //var audit = new tbl_Audit
                //{
                //    AuditTypeId = (short)AuditTypeEnum.LienAdded,
                //    StaffId = (int)SystemStaff.System,
                //    BranchId = item.branchId,
                //    Detail = $"Applied for lien with reference number: {data.SourceReferenceNumber}",
                //    IPAddress = item.userIPAddress,
                //    Url = item.applicationUrl,
                //    ApplicationDate = generalSetup.GetApplicationDate(),
                //    SystemDateTime = DateTime.Now
                //};
                //this.auditTrail.AddAuditTrail(audit);

                //end of Audit section -------------------------------

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;
        }

        public bool TenorExtension(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        {

            bool output = false;
            loanInput.isExistingFacility = true;

            try
            {

                var systemDate = generalSetup.GetApplicationDate();
                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                //var penalCharge = context.TBL_CHARGE_FEE.FirstOrDefault(x => x.OPERATIONID == (int)OperationsEnum.TenorChange);
                var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();

                if (LoanExist(loanId) > 0)
                {
                    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
                    DeleteLoanExist(loanId, systemDate);
                    ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
                    ArchivePeriodicSchedule(loanId, archiveBatchCode);
                    ArchiveDailySchedule(loanId, archiveBatchCode);


                    if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                    {
                        //---------------save irregular loan schedule input---------------------------
                        List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
                        LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
                        if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        {
                            var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                            foreach (var item in data)
                            {
                                TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
                                schedule.LOANREVIEWOPERATIONID = loanId;
                                schedule.PAYMENTDATE = item.paymentDate;
                                schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                                schedule.CREATEDBY = staffId;
                                schedule.DATETIMECREATED = applicationDate;

                                tblIrregularSchedule.Add(schedule);
                            }

                        }
                        //----------------------------------------------

                        //----------generate and save periodic loan schedule -----------------------------------

                        //loanInput.principalAmount = loanInput.newAmount;

                        List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();
                        foreach (var item in periodicScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.INTERESTRATE = loanInput.interestRate;
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblPeriodicScheduleTemp.Add(scheduleTemp);
                        }
                        //-------------------------------------------------------------------------------------


                        //----------generate and save daily loan schedule -----------------------------------

                        //loanInput.principalAmount = loanInput.newAmount;
                        List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

                        foreach (var item in dailyScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.DATE = item.date;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                            scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                            scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                            scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                            scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                            scheduleTemp.INTERESTRATE = item.norminalInterestRate;
                            scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                            scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                            scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                            scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                            scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                            scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                            scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                            scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                            scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                            scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
                            scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblDailyScheduleTemp.Add(scheduleTemp);
                        }
                        //----------------------------------------------------------------


                        //------------adding records to the database--------------------------

                        //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table


                        this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

                        this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
                        context.SaveChanges();
                        MergeDailySchedule(loanId, applicationDate);
                        MergePeriodicSchedule(loanId, applicationDate);

                        //----------update loan details -----------------------------------
                        var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = loan.PRINCIPALNUMBEROFINSTALLMENT;
                        loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
                    }
                    else
                    {
                        //---------------save irregular loan schedule input---------------------------
                        List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
                        LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
                        if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        {
                            var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                            foreach (var item in data)
                            {
                                TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
                                schedule.LOANREVIEWOPERATIONID = loanId;
                                schedule.PAYMENTDATE = item.paymentDate;
                                schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                                schedule.CREATEDBY = staffId;
                                schedule.DATETIMECREATED = applicationDate;

                                tblIrregularSchedule.Add(schedule);
                            }

                        }
                        //----------------------------------------------

                        //----------generate and save periodic loan schedule -----------------------------------

                        //loanInput.principalAmount = loanInput.newAmount;

                        List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_PERIODIC> tblPeriodicSchedule = new List<TBL_LOAN_SCHEDULE_PERIODIC>();
                        foreach (var item in periodicSchedule)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC schedule = new TBL_LOAN_SCHEDULE_PERIODIC();

                            schedule.LOANID = loanId;
                            schedule.PAYMENTNUMBER = item.paymentNumber;
                            schedule.PAYMENTDATE = item.paymentDate;
                            schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            schedule.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            schedule.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            schedule.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            schedule.INTERESTRATE = loanInput.interestRate;
                            schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            schedule.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            schedule.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            schedule.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            schedule.CREATEDBY = staffId;
                            schedule.DATETIMECREATED = systemDate;

                            tblPeriodicSchedule.Add(schedule);
                        }
                        //-------------------------------------------------------------------------------------


                        //----------generate and save daily loan schedule -----------------------------------

                        List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        MergeDailyScheduleNew(loanId, applicationDate, dailySchedule);

                        var itemToRemovePeriodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                                                    where p.LOANID == loanId
                                                    select p);

                        if (itemToRemovePeriodic != null)
                        {
                            context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemovePeriodic);
                            context.SaveChanges();
                        }

                        this.context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule); ////change to Temp table
                        context.SaveChanges();

                        //loanInput.principalAmount = loanInput.newAmount;
                        //List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        //List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

                        //foreach (var item in dailyScheduleTemp)
                        //{
                        //    TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

                        //    scheduleTemp.LOANID = loanId;
                        //    scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                        //    scheduleTemp.DATE = item.date;
                        //    scheduleTemp.PAYMENTDATE = item.paymentDate;
                        //    scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                        //    scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                        //    scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                        //    scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                        //    scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                        //    scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                        //    scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                        //    scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                        //    scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                        //    scheduleTemp.INTERESTRATE = item.norminalInterestRate;
                        //    scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                        //    scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                        //    scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                        //    scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                        //    scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                        //    scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                        //    scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                        //    scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                        //    scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                        //    scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                        //    scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                        //    scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                        //    scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                        //    scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
                        //    scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                        //    scheduleTemp.CREATEDBY = staffId;
                        //    scheduleTemp.DATETIMECREATED = systemDate;

                        //    tblDailyScheduleTemp.Add(scheduleTemp);
                        //}
                        ////----------------------------------------------------------------


                        ////------------adding records to the database--------------------------

                        ////if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        ////{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table


                        //this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

                        //this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
                        //context.SaveChanges();
                        //MergeDailySchedule(loanId, applicationDate);
                        //MergePeriodicSchedule(loanId, applicationDate);

                        //----------update loan details -----------------------------------
                        var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        //loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = loan.PRINCIPALNUMBEROFINSTALLMENT;
                        loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;

                        decimal newOutstandingPrincipal = 0;

                        DateTime maturityDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID).Max(x => x.PAYMENTDATE);

                        var loanPeriodicSchedule = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID && x.PAYMENTDATE == applicationDate).FirstOrDefault();

                        if (loanPeriodicSchedule != null)
                        {
                            newOutstandingPrincipal = loanPeriodicSchedule.ENDPRINCIPALAMOUNT;
                        }
                        else
                        {
                            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loan.TERMLOANID && c.PAYMENTDATE < applicationDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();
                            newOutstandingPrincipal = previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;
                        }


                        loan.OUTSTANDINGPRINCIPAL = newOutstandingPrincipal;
                        loan.MATURITYDATE = maturityDate;



                    }


                }
                var result = context.SaveChanges() > 0;
                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;
            }



            //-------------------------------------------------------
            return output;
        }

        public bool Restructured(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId)
        {
            bool output = false;
            int installmentNo = 0;
            try
            {
                var systemDate = generalSetup.GetApplicationDate();
                decimal pastDueRate = (decimal)context.TBL_SETUP_COMPANY.Where(x => x.COMPANYID == loanInput.companyId).Select(x => x.PASTDUEINDEFAULT_INTERESTRATE).FirstOrDefault();//change to pastdueRate
                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();
                if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.BulletPayment)
                {
                    installmentNo = 3;
                }
                else if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.BallonPayment)
                {
                    installmentNo = 7;
                }
                if (LoanExist(loanId) > 0)
                {
                    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
                    DeleteLoanExist(loanId, systemDate);
                    ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
                    ArchivePeriodicSchedule(loanId, archiveBatchCode);
                    ArchiveDailySchedule(loanId, archiveBatchCode);


                    //---------------save irregular loan schedule input---------------------------
                    List<TBL_LOAN_SCHEDULE_IREGUL_INPUT> tblIrregularSchedule = new List<TBL_LOAN_SCHEDULE_IREGUL_INPUT>();
                    LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
                    if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                    {
                        var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
                        foreach (var item in data)
                        {
                            TBL_LOAN_SCHEDULE_IREGUL_INPUT schedule = new TBL_LOAN_SCHEDULE_IREGUL_INPUT();
                            schedule.LOANID = loanId;
                            schedule.PAYMENTDATE = item.paymentDate;
                            schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
                            schedule.CREATEDBY = staffId;
                            schedule.DATETIMECREATED = applicationDate;

                            tblIrregularSchedule.Add(schedule);
                        }

                    }




                    //----------------------------------------------

                    //----------generate and save periodic loan schedule -----------------------------------

                    //loanInput.principalAmount = loanInput.newAmount;

                    List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                    List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();
                    foreach (var item in periodicScheduleTemp)
                    {
                        TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

                        scheduleTemp.LOANID = loanId;
                        scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                        scheduleTemp.PAYMENTDATE = item.paymentDate;
                        scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                        scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                        scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                        scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                        scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                        scheduleTemp.INTERESTRATE = loanInput.interestRate;
                        scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                        scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                        scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                        scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                        scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                        scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                        scheduleTemp.CREATEDBY = staffId;
                        scheduleTemp.DATETIMECREATED = systemDate;

                        tblPeriodicScheduleTemp.Add(scheduleTemp);
                    }
                    //-------------------------------------------------------------------------------------



                    //----------generate and save daily loan schedule -----------------------------------

                    //loanInput.principalAmount = loanInput.newAmount;
                    List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                    List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

                    foreach (var item in dailyScheduleTemp)
                    {
                        TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

                        scheduleTemp.LOANID = loanId;
                        scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                        scheduleTemp.DATE = item.date;
                        scheduleTemp.PAYMENTDATE = item.paymentDate;
                        scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                        scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                        scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                        scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                        scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                        scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                        scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                        scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                        scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                        scheduleTemp.INTERESTRATE = item.norminalInterestRate;
                        scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                        scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                        scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                        scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                        scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                        scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                        scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                        scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                        scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                        scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                        scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                        scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                        scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                        scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
                        scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                        scheduleTemp.CREATEDBY = staffId;
                        scheduleTemp.DATETIMECREATED = systemDate;

                        tblDailyScheduleTemp.Add(scheduleTemp);
                    }
                    //----------------------------------------------------------------
                    //------------adding records to the database--------------------------

                    if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                    {
                        this.context.TBL_LOAN_SCHEDULE_IREGUL_INPUT.AddRange(tblIrregularSchedule);
                    }

                    this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table
                    this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
                    context.SaveChanges();

                    MergeDailySchedule(loanId, applicationDate);
                    MergePeriodicSchedule(loanId, applicationDate);

                    //----------update loan details -----------------------------------
                    var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                    loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                    loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                    loan.INTERESTNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                    loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
                    loan.INTERESTRATE = (double)reviewData.INTERATERATE;
                    loan.INTERESTFREQUENCYTYPEID = (short)(reviewData.INTERESTFREQUENCYTYPEID == 0 ? installmentNo : reviewData.INTERESTFREQUENCYTYPEID);
                    loan.PRINCIPALFREQUENCYTYPEID = (short)(reviewData.PRINCIPALFREQUENCYTYPEID == 0 ? installmentNo : reviewData.PRINCIPALFREQUENCYTYPEID);
                    loan.FIRSTINTERESTPAYMENTDATE = reviewData.INTERESTFIRSTPAYMENTDATE;
                    loan.FIRSTPRINCIPALPAYMENTDATE = reviewData.PRINCIPALFIRSTPAYMENTDATE;
                    //-------------------------------------------------------
                }

                var result = context.SaveChanges() > 0;

                TwoFactorAutheticationViewModel twoFactorAuth = new TwoFactorAutheticationViewModel();

                if (reviewData.EFFECTIVEDATE < applicationDate)
                {
                    result = LoanBackDateFunction(loanId, applicationDate, systemDate, loanInput);
                }

                if (result)
                {

                    output = true;

                }
            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;
        }

        public bool LoanTermination(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, TwoFactorAutheticationViewModel twoFactorAuth, DateTime applicationDate, int staffId)
        {
            bool output = false;
            try
            {

                var loanNew = context.TBL_LOAN.Where(x => x.TERMLOANID == loanId).FirstOrDefault();

                var systemDate = generalSetup.GetApplicationDate();
                loanInput.date = applicationDate;

                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
                decimal principalOutStandingBalance = loan.OUTSTANDINGPRINCIPAL;
                var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID);
                decimal accruedInterest = 0;
                var accrued = (from a in context.TBL_DAILY_ACCRUAL
                               where a.REFERENCENUMBER == loanNew.LOANREFERENCENUMBER && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan && a.REPAYMENTPOSTEDSTATUS == false
                               select a).ToList();

                if (accrued != null)
                {
                    accruedInterest = accrued.Sum(x => x.DAILYACCURALAMOUNT);
                }
                else
                {
                    //throw new SecureException("Application Date not found in Payment Schedule");
                    accruedInterest = 0;
                }

                accruedInterest = decimal.Round(accruedInterest, 2, MidpointRounding.AwayFromZero);
                principalOutStandingBalance = decimal.Round(principalOutStandingBalance + loan.PASTDUEPRINCIPAL, 2, MidpointRounding.AwayFromZero);
                decimal pastDue = decimal.Round((loan.PASTDUEINTEREST + loan.INTERESTONPASTDUEINTEREST + loan.INTERESTONPASTDUEPRINCIPAL), 2, MidpointRounding.AwayFromZero);
                decimal totalamount = (accruedInterest + principalOutStandingBalance + pastDue);

                List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                if (pastDue > 0)
                {

                    inputTransactions.AddRange(financeTransaction.BuildTerminateAndRebookPosting(loanId, loanInput, pastDue, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Past Due Interests"));

                }

                if (accruedInterest > 0)
                {

                    inputTransactions.AddRange(financeTransaction.BuildTerminateAndRebookPosting(loanId, loanInput, accruedInterest, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest"));

                }

                if (principalOutStandingBalance > 0)
                {

                    inputTransactions.AddRange(financeTransaction.BuildTerminateAndRebookPosting(loanId, loanInput, principalOutStandingBalance, product.PRINCIPALBALANCEGL.Value, "Loan Outstanding Principal Balance"));

                }


                if (product.PRODUCTCLASSID == (short)ProductClassEnum.InvoiceDiscountingFacility)
                {
                    var casaLienInfo = context.TBL_CASA_LIEN.FirstOrDefault(x => x.SOURCEREFERENCENUMBER == loan.LOANREFERENCENUMBER && x.COMPANYID == loan.COMPANYID);

                    CasaLienViewModel model = new CasaLienViewModel
                    {
                        lienReferenceNumber = casaLienInfo.LIENREFERENCENUMBER,
                        companyId = loan.COMPANYID, //currencyCode = casaLienInfo.
                        productAccountNumber = casaLienInfo.PRODUCTACCOUNTNUMBER,
                        description = casaLienInfo.DESCRIPTION,
                        branchId = loan.BRANCHID,
                        createdBy = loanInput.createdBy
                    };

                    casaLien.ReleaseLien(model, null, false);
                }


                var twoFADetails = new TwoFactorAutheticationViewModel
                {
                    skipAuthentication = true,
                };


                financeTransaction.PostTransaction(inputTransactions, false, twoFADetails);


                TBL_LOAN results = (from p in context.TBL_LOAN
                                    where p.TERMLOANID == loanId
                                    select p).SingleOrDefault();

                results.LOANSTATUSID = (short)LoanStatusEnum.Terminated;

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;
        }


        public bool LoanRecovery(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, TwoFactorAutheticationViewModel twoFactorAuth, DateTime applicationDate, int staffId)
        {

            bool output = false;
            try
            {
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
                loan.RECOVERYSTATUSID = (int)RecoveryStatusEnum.OnGoing;

                context.SaveChanges();

                output = true;

            }
            catch (Exception ex)
            {

                throw ex;
            }
            return output;

        }


        public bool LoanRecoveryPayment(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, TwoFactorAutheticationViewModel twoFactorAuth, DateTime applicationDate, int staffId)
        {
            bool output = false;

            decimal amt = 0;

            int loanReviewOperationId = 0;

            try
            {
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId && x.RECOVERYSTATUSID == (int)RecoveryStatusEnum.OnGoing).FirstOrDefault();

                if (loan != null)
                {

                    var loanPayment = context.TBL_LOAN_RECOVERY_PAYMENT.Where(x => x.LOANRECOVERYPAYMENTID == loanInput.loanRecoveryPaymentId && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing).FirstOrDefault();

                    var _otherOperationAccount = context.TBL_OTHER_OPERATION_ACCOUNT.Where(x => x.OTHEROPERATIONID == (int)OtherOperationEnum.Recovery).FirstOrDefault();

                    var otherOperationAccount = context.TBL_OTHER_OPERATION_ACCOUNT.Where(x => x.OTHEROPERATIONID == (int)OtherOperationEnum.PrincipalOffBalansheetCompleteWriteOffAccount).FirstOrDefault();

                    var sllp = _otherOperationAccount.GLACCOUNTID;

                    amt = loanPayment.PAYMENTAMOUNT;

                    if (loanPayment.PAYMENTAMOUNT > 0)
                    {
                        financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, loanPayment.PAYMENTAMOUNT, _otherOperationAccount.GLACCOUNTID, (int)_otherOperationAccount.GLACCOUNTID2, "Recovery Repayment", twoFactorAuth);

                        financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, loanPayment.PAYMENTAMOUNT, (int)otherOperationAccount.GLACCOUNTID2, otherOperationAccount.GLACCOUNTID, "Recovery Repayment", twoFactorAuth);
                    }


                    loanPayment.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                    loanReviewOperationId = loanPayment.LOANREVIEWOPERATIONID;
                    context.SaveChanges();

                    decimal loanPaymentSum = context.TBL_LOAN_RECOVERY_PAYMENT.Where(x => x.LOANREVIEWOPERATIONID == loanReviewOperationId && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved).Sum(x => x.PAYMENTAMOUNT);

                    var camsol = (from a in context.TBL_LOAN_CAMSOL
                                  join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                                  where b.RECOVERYSTATUSID == (int)RecoveryStatusEnum.OnGoing && b.LOANSTATUSID == (short)LoanStatusEnum.WriteOff
                                  select new TBL_LOAN_CAMSOL
                                  {
                                      BALANCE = a.BALANCE,
                                      LOAN_CAMSOLID = a.LOAN_CAMSOLID,
                                  }).FirstOrDefault();



                    var camsolId = context.TBL_LOAN_CAMSOL.Where(x => x.LOAN_CAMSOLID == camsol.LOAN_CAMSOLID).FirstOrDefault();

                    TBL_LOAN_CAMSOL_ARCHIVE loanCamsol = new TBL_LOAN_CAMSOL_ARCHIVE();

                    loanCamsol.LOAN_CAMSOLID = camsolId.LOAN_CAMSOLID;
                    loanCamsol.ARCHIVEDATE = System.DateTime.Now;
                    loanCamsol.COMPANYID = camsolId.COMPANYID;
                    loanCamsol.CUSTOMERCODE = camsolId.CUSTOMERCODE;
                    loanCamsol.LOANID = camsolId.LOANID;
                    loanCamsol.BALANCE = camsolId.BALANCE;
                    loanCamsol.DATE = camsolId.DATE;
                    loanCamsol.LOANSYSTEMTYPEID = camsolId.LOANSYSTEMTYPEID;
                    loanCamsol.CUSTOMERNAME = camsolId.CUSTOMERNAME;
                    loanCamsol.PRINCIPAL = camsolId.PRINCIPAL;
                    loanCamsol.INTERESTINSUSPENSE = camsolId.INTERESTINSUSPENSE;
                    loanCamsol.WRITTENOFFACCRUALAMOUNT = (decimal)camsolId.WRITTENOFFACCRUALAMOUNT;
                    loanCamsol.CAMSOLTYPEID = camsolId.CAMSOLTYPEID;
                    loanCamsol.ACCOUNTNUMBER = camsolId.ACCOUNTNUMBER;
                    loanCamsol.ACCOUNTNAME = camsolId.ACCOUNTNAME;
                    loanCamsol.REMARK = camsolId.REMARK;
                    loanCamsol.CANTAKELOAN = camsolId.CANTAKELOAN;
                    loanCamsol.CREATEDBY = camsolId.CREATEDBY;
                    loanCamsol.LASTUPDATEDBY = camsolId.LASTUPDATEDBY;
                    loanCamsol.DATETIMECREATED = camsolId.DATETIMECREATED;
                    loanCamsol.DATETIMEUPDATED = camsolId.DATETIMEUPDATED;
                    loanCamsol.DELETED = camsolId.DELETED;
                    loanCamsol.DELETEDBY = camsolId.DELETEDBY;
                    loanCamsol.DATETIMEDELETED = camsolId.DATETIMEDELETED;

                    context.TBL_LOAN_CAMSOL_ARCHIVE.Add(loanCamsol);
                    context.SaveChanges();


                    if (camsolId.BALANCE >= amt)
                    {
                        camsolId.BALANCE = camsolId.BALANCE - amt;
                        context.SaveChanges();
                    }
                    else if (camsolId.BALANCE < amt)
                    {
                        var negativeAmt = camsolId.BALANCE - amt;
                        camsolId.BALANCE = 0;
                        camsolId.WRITTENOFFACCRUALAMOUNT = camsolId.WRITTENOFFACCRUALAMOUNT - Math.Abs(negativeAmt);
                        context.SaveChanges();
                    }

                }


                output = true;

            }
            catch (Exception ex)
            {

                throw ex;
            }

            return output;

        }

        public bool LoanRecoveryCompletion(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, TwoFactorAutheticationViewModel twoFactorAuth, DateTime applicationDate, int staffId)
        {
            bool output = false;

            decimal amt = 0;

            try
            {
                var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId && x.RECOVERYSTATUSID == (int)RecoveryStatusEnum.OnGoing).FirstOrDefault();

                if (loan != null)
                {

                    var camsol = (from a in context.TBL_LOAN_CAMSOL
                                  join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                                  where b.RECOVERYSTATUSID == (int)RecoveryStatusEnum.OnGoing && b.LOANSTATUSID == (short)LoanStatusEnum.WriteOff
                                  select new TBL_LOAN_CAMSOL
                                  {
                                      BALANCE = a.BALANCE,
                                      LOAN_CAMSOLID = a.LOAN_CAMSOLID,
                                      WRITTENOFFACCRUALAMOUNT = a.WRITTENOFFACCRUALAMOUNT,
                                  }).FirstOrDefault();

                    amt = camsol.BALANCE + (decimal)camsol.WRITTENOFFACCRUALAMOUNT;

                    var otherOperationAccount = context.TBL_OTHER_OPERATION_ACCOUNT.Where(x => x.OTHEROPERATIONID == (int)OtherOperationEnum.PrincipalOffBalansheetCompleteWriteOffAccount).FirstOrDefault();

                    if (amt != 0)
                    {
                        financeTransaction.PostTerminateAndRebookDoubleEntries(loanId, loanInput, amt, (int)otherOperationAccount.GLACCOUNTID2, otherOperationAccount.GLACCOUNTID, "Loan Recovery Reversal", twoFactorAuth);
                    }

                    var camsolId = context.TBL_LOAN_CAMSOL.Where(x => x.LOAN_CAMSOLID == camsol.LOAN_CAMSOLID).FirstOrDefault();

                    TBL_LOAN_CAMSOL_ARCHIVE loanCamsol = new TBL_LOAN_CAMSOL_ARCHIVE();

                    loanCamsol.LOAN_CAMSOLID = camsolId.LOAN_CAMSOLID;
                    loanCamsol.ARCHIVEDATE = System.DateTime.Now;
                    loanCamsol.COMPANYID = camsolId.COMPANYID;
                    loanCamsol.CUSTOMERCODE = camsolId.CUSTOMERCODE;
                    loanCamsol.LOANID = camsolId.LOANID;
                    loanCamsol.BALANCE = camsolId.BALANCE;
                    loanCamsol.DATE = camsolId.DATE;
                    loanCamsol.LOANSYSTEMTYPEID = camsolId.LOANSYSTEMTYPEID;
                    loanCamsol.CUSTOMERNAME = camsolId.CUSTOMERNAME;
                    loanCamsol.PRINCIPAL = camsolId.PRINCIPAL;
                    loanCamsol.INTERESTINSUSPENSE = camsolId.INTERESTINSUSPENSE;
                    loanCamsol.WRITTENOFFACCRUALAMOUNT = (decimal)camsolId.WRITTENOFFACCRUALAMOUNT;
                    loanCamsol.CAMSOLTYPEID = camsolId.CAMSOLTYPEID;
                    loanCamsol.ACCOUNTNUMBER = camsolId.ACCOUNTNUMBER;
                    loanCamsol.ACCOUNTNAME = camsolId.ACCOUNTNAME;
                    loanCamsol.REMARK = camsolId.REMARK;
                    loanCamsol.CANTAKELOAN = camsolId.CANTAKELOAN;
                    loanCamsol.CREATEDBY = camsolId.CREATEDBY;
                    loanCamsol.LASTUPDATEDBY = camsolId.LASTUPDATEDBY;
                    loanCamsol.DATETIMECREATED = camsolId.DATETIMECREATED;
                    loanCamsol.DATETIMEUPDATED = camsolId.DATETIMEUPDATED;
                    loanCamsol.DELETED = camsolId.DELETED;
                    loanCamsol.DELETEDBY = camsolId.DELETEDBY;
                    loanCamsol.DATETIMEDELETED = camsolId.DATETIMEDELETED;

                    context.TBL_LOAN_CAMSOL_ARCHIVE.Add(loanCamsol);
                    context.SaveChanges();


                    var camsole = context.TBL_LOAN_CAMSOL.Where(x => x.LOAN_CAMSOLID == camsol.LOAN_CAMSOLID).FirstOrDefault();

                    camsole.BALANCE = 0;
                    camsole.WRITTENOFFACCRUALAMOUNT = 0;
                    camsole.PRINCIPAL = 0;
                    camsole.INTERESTINSUSPENSE = 0;
                    loan.RECOVERYSTATUSID = (int)RecoveryStatusEnum.Completed;
                    context.SaveChanges();

                }

                output = true;

            }
            catch (Exception ex)
            {

                throw ex;
            }

            return output;

        }

        //public bool LoanRecovery(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, TwoFactorAutheticationViewModel twoFactorAuth, DateTime applicationDate, int staffId)
        //{
        //    bool output = false;
        //    try
        //    {
        //        var systemDate = generalSetup.GetApplicationDate();
        //        loanInput.date = systemDate;
        //        var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();
        //        var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
        //        var loan = this.context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();
        //        decimal principalOutStandingBalance = loan.OUTSTANDINGPRINCIPAL;
        //        var casa = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loan.CASAACCOUNTID);
        //        decimal accruedInterest = 0;
        //        var accrued = (from a in context.TBL_LOAN_SCHEDULE_DAILY
        //                       where a.TBL_LOAN.TERMLOANID == loanId && a.DATE == applicationDate
        //                       select a).FirstOrDefault();

        //        if (accrued != null)
        //        {
        //            accruedInterest = accrued.ACCRUEDINTEREST;
        //        }
        //        else
        //        {
        //            throw new SecureException("Application Date not found in Payment Schedule");
        //        }
        //        accruedInterest = decimal.Round(accruedInterest, 2, MidpointRounding.AwayFromZero);
        //        principalOutStandingBalance = decimal.Round(principalOutStandingBalance, 2, MidpointRounding.AwayFromZero);
        //        decimal pastDue = decimal.Round((loan.PASTDUEINTEREST + loan.INTERESTONPASTDUEINTEREST + loan.INTERESTONPASTDUEPRINCIPAL), 2, MidpointRounding.AwayFromZero);
        //        decimal totalamount = (accruedInterest + principalOutStandingBalance + pastDue);

        //        loanInput.principalAmount = (double)totalamount - loanInput.payAmount;
        //        var sllp = 27;////Get SLLP GL

        //        List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();
        //        inputTransactions.Add(financeTransaction.BuildTerminateAndRebookPosting(loanId, loanInput, (decimal)loanInput.payAmount, sllp, "Loan Write-Off Amount"));

        //        //financeTransaction.PostTransaction(inputTransactions, false, twoFactorAuth);

        //        if (LoanExist(loanId) > 0)
        //        {
        //            var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);
        //            DeleteLoanExist(loanId, systemDate);
        //            ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode);/////loanId change this to OperationId
        //            ArchivePeriodicSchedule(loanId, archiveBatchCode);
        //            ArchiveDailySchedule(loanId, archiveBatchCode);


        //            DateTime collectionMaturityDate = DateTime.Now;

        //            //---------------save irregular loan schedule input---------------------------
        //            List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> tblIrregularSchedule = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
        //            LoanScheduleTypeEnum scheduleMethod = (LoanScheduleTypeEnum)loanInput.scheduleMethodId;
        //            if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
        //            {
        //                var data = loanInput.irregularPaymentSchedule.OrderBy(x => x.paymentDate);
        //                foreach (var item in data)
        //                {
        //                    TBL_LOAN_REVIEW_OPRATN_IREG_SC schedule = new TBL_LOAN_REVIEW_OPRATN_IREG_SC();
        //                    schedule.LOANREVIEWOPERATIONID = loanId;
        //                    schedule.PAYMENTDATE = item.paymentDate;
        //                    schedule.PAYMENTAMOUNT = Convert.ToDecimal(item.paymentAmount);
        //                    schedule.CREATEDBY = staffId;
        //                    schedule.DATETIMECREATED = applicationDate;

        //                    collectionMaturityDate = item.paymentDate;

        //                    tblIrregularSchedule.Add(schedule);
        //                }

        //            }
        //            //----------------------------------------------

        //            //----------generate and save periodic loan schedule -----------------------------------
        //            List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

        //            List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();
        //            foreach (var item in periodicScheduleTemp)
        //            {
        //                TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

        //                scheduleTemp.LOANID = loanId;
        //                scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
        //                scheduleTemp.PAYMENTDATE = item.paymentDate;
        //                scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
        //                scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
        //                scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
        //                scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                scheduleTemp.INTERESTRATE = loanInput.interestRate;
        //                scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
        //                scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
        //                scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
        //                scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
        //                scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
        //                scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                scheduleTemp.CREATEDBY = staffId;
        //                scheduleTemp.DATETIMECREATED = systemDate;

        //                tblPeriodicScheduleTemp.Add(scheduleTemp);
        //            }
        //            //-------------------------------------------------------------------------------------


        //            //----------generate and save daily loan schedule -----------------------------------
        //            List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

        //            List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

        //            foreach (var item in dailyScheduleTemp)
        //            {
        //                TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

        //                scheduleTemp.LOANID = loanId;
        //                scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
        //                scheduleTemp.DATE = item.date;
        //                scheduleTemp.PAYMENTDATE = item.paymentDate;
        //                scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
        //                scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
        //                scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
        //                scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
        //                scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
        //                scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
        //                scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
        //                scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
        //                scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
        //                scheduleTemp.INTERESTRATE = item.norminalInterestRate;
        //                scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
        //                scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
        //                scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
        //                scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
        //                scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
        //                scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
        //                scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
        //                scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
        //                scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
        //                scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
        //                scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
        //                scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
        //                scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
        //                scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
        //                scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
        //                scheduleTemp.CREATEDBY = staffId;
        //                scheduleTemp.DATETIMECREATED = systemDate;

        //                tblDailyScheduleTemp.Add(scheduleTemp);
        //            }
        //            //----------------------------------------------------------------

        //            //------------adding records to the database--------------------------

        //            //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
        //            //{ this.context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table
        //            this.context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table
        //            this.context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
        //            context.SaveChanges();

        //            MergeDailySchedule(loanId, applicationDate);
        //            MergePeriodicSchedule(loanId, applicationDate);
        //            //----------update loan details -----------------------------------
        //            //var loan = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
        //            //loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
        //            reviewData.MATURITYDATE = collectionMaturityDate;
        //            loan.MATURITYDATE = collectionMaturityDate;
        //            loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
        //            loan.INTERESTNUMBEROFINSTALLMENT = loan.PRINCIPALNUMBEROFINSTALLMENT;

        //            loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
        //            //-------------------------------------------------------
        //        }

        //        var result = context.SaveChanges() > 0;
        //        if (result)
        //        {
        //            output = true;
        //        }
        //    }
        //    catch (Exception ex)
        //    {

        //        throw ex;
        //    }

        //    return output;

        //}

        #endregion

        public LoanViewModel GetWriteOffLoans(int companyId, string refNo)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var data = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == refNo && x.COMPANYID == companyId);
            DateTime maturityDate = data.MATURITYDATE;
            DateTime effectiveDate = data.EFFECTIVEDATE;
            //decimal outStandingBalance = data.OUTSTANDINGPRINCIPAL;
            TimeSpan difference = maturityDate - applicationDate;
            int days = (int)difference.TotalDays;
            //decimal accruedInterest = 0;
            //var accInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY
            //                   where a.TBL_LOAN.TERMLOANID == data.TERMLOANID && a.DATE == applicationDate
            //                   select a).FirstOrDefault();
            //if (accInterest != null)
            //{
            //    accruedInterest = accInterest.ACCRUEDINTEREST;
            //}
            //else
            //{
            //    //throw new SecureException("Application Date not found in Payment Schedule");
            //    //accruedInterest = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == data.TERMLOANID).Select();
            //}

            //accruedInterest = decimal.Round(accruedInterest, 2, MidpointRounding.AwayFromZero);
            //DateTime nextPaymentDate = DateTime.Now;
            //var paymentDate = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
            //                   where a.TBL_LOAN.TERMLOANID == data.TERMLOANID && a.PAYMENTDATE >= applicationDate
            //                   select a).FirstOrDefault();

            //if (paymentDate != null)
            //{
            //    nextPaymentDate = paymentDate.PAYMENTDATE;
            //}
            //else
            //{
            //    throw new SecureException("Application Date not found in Payment Schedule");
            //}


            //outStandingBalance = decimal.Round(outStandingBalance, 2, MidpointRounding.AwayFromZero);

            //decimal pastDue = decimal.Round((data.PASTDUEINTEREST + data.INTERESTONPASTDUEINTEREST + data.INTERESTONPASTDUEPRINCIPAL), 2, MidpointRounding.AwayFromZero);
            //decimal pastDuePrincipal = decimal.Round((data.PASTDUEPRINCIPAL), 2, MidpointRounding.AwayFromZero);

            //decimal totalamount = (accruedInterest + outStandingBalance + pastDue + pastDuePrincipal);
            decimal balance = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == data.TERMLOANID).Select(x => x.BALANCE).FirstOrDefault();
            decimal? writtenOffAccruedAmount = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == data.TERMLOANID).Select(x => x.WRITTENOFFACCRUALAMOUNT).FirstOrDefault() ?? 0;
            decimal totalamount = balance + (decimal)writtenOffAccruedAmount;

            var runningLoan = (from l in context.TBL_LOAN
                               where l.COMPANYID == companyId && l.LOANREFERENCENUMBER == refNo //&& l.LOANSTATUSID == (short)LoanStatusEnum.Active
                               select new LoanViewModel()
                               {
                                   loanId = l.TERMLOANID,
                                   writtenOffAccruedAmount = writtenOffAccruedAmount,
                                   companyName = l.TBL_COMPANY.NAME,
                                   companyId = l.COMPANYID,
                                   customerName = l.TBL_CUSTOMER.FIRSTNAME + " " + l.TBL_CUSTOMER.MIDDLENAME + " " + l.TBL_CUSTOMER.LASTNAME,
                                   customerId = l.CUSTOMERID,
                                   approvedAmount = l.PRINCIPALAMOUNT,
                                   branchId = l.BRANCHID,
                                   branchName = l.TBL_BRANCH.BRANCHNAME,
                                   interestRate = l.INTERESTRATE,
                                   outstandingInterest = l.OUTSTANDINGINTEREST,
                                   outstandingPrincipal = l.OUTSTANDINGPRINCIPAL,
                                   principalAmount = l.PRINCIPALAMOUNT,
                                   currency = l.TBL_CURRENCY.CURRENCYNAME,
                                   loanReferenceNumber = l.LOANREFERENCENUMBER,
                                   effectiveDate = applicationDate,
                                   previousEffectiveDate = l.EFFECTIVEDATE,
                                   equityContribution = 0,
                                   maintainTenor = true,
                                   maturityDate = l.MATURITYDATE,
                                   scheduleTypeId = l.SCHEDULETYPEID,
                                   scheduleTypeCategoryId = l.TBL_LOAN_SCHEDULE_TYPE.SCHEDULECATEGORYID,
                                   writtenOffAmount = balance,
                                   teno = days,
                                   //newTenor = 0,
                                   //accrualedAmount = accruedInterest,
                                   totalAmount = totalamount,
                                   //firstPrincipalPaymentDate = nextPaymentDate,
                                   //firstInterestPaymentDate = nextPaymentDate,
                                   //principalFrequencyTypeId = l.PRINCIPALFREQUENCYTYPEID,
                                   //interestFrequencyTypeId = l.INTERESTFREQUENCYTYPEID,
                                   //pastDueTotal = pastDue,
                                   //pastDuePrincipal = pastDuePrincipal, //TODO
                                   relationshipManagerId = l.RELATIONSHIPMANAGERID,
                                   relationshipOfficerId = l.RELATIONSHIPOFFICERID,
                                   productTypeId = l.TBL_PRODUCT.PRODUCTTYPEID,
                                   systemCurrentDate = applicationDate,
                                   loanSystemTypeId = l.LOANSYSTEMTYPEID,
                               }).FirstOrDefault();

            return runningLoan;
        }
        public LoanViewModel GetRunningLoans(int companyId, string refNo)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var data = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == refNo && x.COMPANYID == companyId);
            DateTime maturityDate = data.MATURITYDATE;
            DateTime effectiveDate = data.EFFECTIVEDATE;
            //decimal outStandingBalance = data.OUTSTANDINGPRINCIPAL;
            TimeSpan difference = maturityDate - applicationDate;
            int days = (int)difference.TotalDays;
            //decimal accruedInterest = 0;
            //var accInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY
            //                   where a.TBL_LOAN.TERMLOANID == data.TERMLOANID && a.DATE == applicationDate
            //                   select a).FirstOrDefault();
            //if (accInterest != null)
            //{
            //    accruedInterest = accInterest.ACCRUEDINTEREST;
            //}
            //else
            //{
            //    //throw new SecureException("Application Date not found in Payment Schedule");
            //    //accruedInterest = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == data.TERMLOANID).Select();
            //}

            //accruedInterest = decimal.Round(accruedInterest, 2, MidpointRounding.AwayFromZero);
            //DateTime nextPaymentDate = DateTime.Now;
            //var paymentDate = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
            //                   where a.TBL_LOAN.TERMLOANID == data.TERMLOANID && a.PAYMENTDATE >= applicationDate
            //                   select a).FirstOrDefault();

            //if (paymentDate != null)
            //{
            //    nextPaymentDate = paymentDate.PAYMENTDATE;
            //}
            //else
            //{
            //    throw new SecureException("Application Date not found in Payment Schedule");
            //}


            //outStandingBalance = decimal.Round(outStandingBalance, 2, MidpointRounding.AwayFromZero);

            //decimal pastDue = decimal.Round((data.PASTDUEINTEREST + data.INTERESTONPASTDUEINTEREST + data.INTERESTONPASTDUEPRINCIPAL), 2, MidpointRounding.AwayFromZero);
            //decimal pastDuePrincipal = decimal.Round((data.PASTDUEPRINCIPAL), 2, MidpointRounding.AwayFromZero);

            //decimal totalamount = (accruedInterest + outStandingBalance + pastDue + pastDuePrincipal);
            decimal totalamount = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == data.TERMLOANID).Select(x => x.BALANCE).FirstOrDefault();
            decimal? writtenOffAccruedAmount = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == data.TERMLOANID).Select(x => x.WRITTENOFFACCRUALAMOUNT).FirstOrDefault();

            var runningLoan = (from l in context.TBL_LOAN
                               where l.COMPANYID == companyId && l.LOANREFERENCENUMBER == refNo //&& l.LOANSTATUSID == (short)LoanStatusEnum.Active
                               select new LoanViewModel()
                               {
                                   loanId = l.TERMLOANID,
                                   writtenOffAccruedAmount = writtenOffAccruedAmount,
                                   companyName = l.TBL_COMPANY.NAME,
                                   companyId = l.COMPANYID,
                                   customerName = l.TBL_CUSTOMER.FIRSTNAME + " " + l.TBL_CUSTOMER.MIDDLENAME + " " + l.TBL_CUSTOMER.LASTNAME,
                                   customerId = l.CUSTOMERID,
                                   approvedAmount = l.PRINCIPALAMOUNT,
                                   branchId = l.BRANCHID,
                                   branchName = l.TBL_BRANCH.BRANCHNAME,
                                   interestRate = l.INTERESTRATE,
                                   outstandingInterest = l.OUTSTANDINGINTEREST,
                                   outstandingPrincipal = l.OUTSTANDINGPRINCIPAL,
                                   principalAmount = l.PRINCIPALAMOUNT,
                                   currency = l.TBL_CURRENCY.CURRENCYNAME,
                                   loanReferenceNumber = l.LOANREFERENCENUMBER,
                                   effectiveDate = applicationDate,
                                   previousEffectiveDate = applicationDate, //l.EFFECTIVEDATE,
                                   equityContribution = 0,
                                   maintainTenor = true,
                                   maturityDate = l.MATURITYDATE,
                                   scheduleTypeId = l.SCHEDULETYPEID,
                                   scheduleTypeCategoryId = l.TBL_LOAN_SCHEDULE_TYPE.SCHEDULECATEGORYID,
                                   // writtenOffAmount = balance,
                                   teno = days,
                                   //newTenor = 0,
                                   accrualedAmount = (decimal)(context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == l.LOANREFERENCENUMBER && x.CATEGORYID == (int)DailyAccrualCategory.TermLoan && x.REPAYMENTPOSTEDSTATUS == false).Sum(x => x.DAILYACCURALAMOUNT)),
                                   totalAmount = totalamount,
                                   //firstPrincipalPaymentDate = nextPaymentDate,
                                   //firstInterestPaymentDate = nextPaymentDate,
                                   //principalFrequencyTypeId = l.PRINCIPALFREQUENCYTYPEID,
                                   //interestFrequencyTypeId = l.INTERESTFREQUENCYTYPEID,
                                   //pastDueTotal = pastDue,
                                   //pastDuePrincipal = pastDuePrincipal, //TODO
                                   relationshipManagerId = l.RELATIONSHIPMANAGERID,
                                   relationshipOfficerId = l.RELATIONSHIPOFFICERID,
                                   productTypeId = l.TBL_PRODUCT.PRODUCTTYPEID,
                                   systemCurrentDate = applicationDate,
                                   loanSystemTypeId = l.LOANSYSTEMTYPEID,
                                   interesrtOnPastDueInterest = l.INTERESTONPASTDUEINTEREST,
                                   interestOnPastDuePrincipal = l.INTERESTONPASTDUEPRINCIPAL,
                                   pastDuePrincipal = l.PASTDUEPRINCIPAL,
                                   pastDueInterest = l.PASTDUEINTEREST,
                               }).FirstOrDefault();


            //var validate = GetRepaymentDate(runningLoan.loanId);

            //if (validate == true)
            //{
            //    runningLoan.previousEffectiveDate = runningLoan.previousEffectiveDate.AddDays(1);
            //}

            return runningLoan;

        }
        public List<LoanPaymentSchedulePeriodicViewModel> GeneratePrepaymentSchedule(LoanPaymentScheduleInputViewModel loanInput)
        {
            var loanInfo = context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();

            var nextPeriodicPricipalPaymentDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loanInput.loanId && x.PAYMENTDATE > loanInput.effectiveDate && x.PERIODPRINCIPALAMOUNT > 0).OrderBy(x => x.PAYMENTNUMBER).Take(1).FirstOrDefault();

            loanInput.firstPaymentDate = nextPeriodicPricipalPaymentDate.PAYMENTDATE;
            loanInput.principalFirstpaymentDate = nextPeriodicPricipalPaymentDate.PAYMENTDATE;

            var nextPeriodicInterestPaymentDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loanInput.loanId && x.PAYMENTDATE > loanInput.effectiveDate && x.PERIODINTERESTAMOUNT > 0).OrderBy(x => x.PAYMENTNUMBER).Take(1).FirstOrDefault();
            loanInput.interestFirstpaymentDate = nextPeriodicInterestPaymentDate.PAYMENTDATE;

            if ((loanInput.scheduleMethodId != (short)LoanScheduleTypeEnum.BulletPayment) && (loanInput.scheduleMethodId != (short)LoanScheduleTypeEnum.IrregularSchedule))
            {
                loanInput.interestFrequencyTypeId = (int)loanInfo.INTERESTFREQUENCYTYPEID;
                loanInput.principalFrequencyTypeId = (int)loanInfo.PRINCIPALFREQUENCYTYPEID;
            }

            loanInput.maturityDate = loanInfo.MATURITYDATE;
            loanInput.interestRate = loanInfo.INTERESTRATE;

            if (loanInput.equityContribution == null)
            {
                loanInput.equityContribution = loanInput.payAmount;
            }

            loanInput.isExistingFacility = true;

            List<LoanPaymentSchedulePeriodicViewModel> scheduleInfo = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

            return scheduleInfo;
        }

        public LoanViewModel getPrincipalAndInterestDate(int companyId, string refNo, DateTime effectiveDate)
        {
            var loan = context.TBL_LOAN.Where(c => c.LOANREFERENCENUMBER == refNo && c.COMPANYID == companyId).FirstOrDefault();

            LoanViewModel loanModel = new LoanViewModel();

            if (loan.PRINCIPALFREQUENCYTYPEID == loan.INTERESTFREQUENCYTYPEID)
            {
                loanModel.firstPrincipalPaymentDate = effectiveDate;
            }
            else if ((loan.PRINCIPALFREQUENCYTYPEID == null && loan.INTERESTFREQUENCYTYPEID != null))
            {
                loanModel.firstPrincipalPaymentDate = effectiveDate;
                throw new SecureException("Payment Date Cannot Be Change For This Type Of Schedule");
            }
            else if ((loan.PRINCIPALFREQUENCYTYPEID == null && loan.INTERESTFREQUENCYTYPEID == null))
            {
                loanModel.firstPrincipalPaymentDate = effectiveDate;
                throw new SecureException("Payment Date Cannot Be Change For This Type Of Schedule");
            }
            else
            {
                loanModel.firstPrincipalPaymentDate = loanCovenant.GetFrequencyDate((int)(FrequencyTypeEnum)loan.PRINCIPALFREQUENCYTYPEID, effectiveDate.AddDays(-1));
            }



            return loanModel;
        }

        public LoanViewModel GetRunningLoanOpeningBalance(int companyId, string refNo, DateTime effectiveDate)
        {

            var newEffectiveDate = effectiveDate.AddDays(-1);

            var loan = context.TBL_LOAN.Where(x => x.LOANREFERENCENUMBER == refNo && x.COMPANYID == companyId && x.LOANSTATUSID == (short)LoanStatusEnum.Active).FirstOrDefault();

            var runningLoan = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                               where p.DATE == newEffectiveDate
                                     && p.LOANID == loan.TERMLOANID
                               select new LoanViewModel()
                               {
                                   principalAmount = p.OPENINGBALANCE,
                               }).FirstOrDefault();


            if (runningLoan == null)
            {

                runningLoan = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                               where p.DATE == effectiveDate
                                     && p.LOANID == loan.TERMLOANID
                               select new LoanViewModel()
                               {
                                   principalAmount = p.OPENINGBALANCE,
                               }).FirstOrDefault();

            }


            return runningLoan;
        }

        public LoanViewModel GetRunningFXLoans(int companyId, string refNo)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var data = context.TBL_LOAN.FirstOrDefault(x => x.LOANREFERENCENUMBER == refNo && x.COMPANYID == companyId);
            DateTime maturityDate = data.MATURITYDATE;
            DateTime effectiveDate = data.EFFECTIVEDATE;
            decimal outStandingBalance = data.OUTSTANDINGPRINCIPAL;
            TimeSpan difference = maturityDate - applicationDate;
            int days = (int)difference.TotalDays;
            var runningLoan = (from l in context.TBL_LOAN
                               where l.COMPANYID == companyId && l.LOANREFERENCENUMBER == refNo && l.LOANSTATUSID == (short)LoanStatusEnum.Active
                               select new LoanViewModel()
                               {
                                   loanId = l.TERMLOANID,
                                   companyName = l.TBL_COMPANY.NAME,
                                   companyId = l.COMPANYID,
                                   customerName = l.TBL_CUSTOMER.FIRSTNAME + " " + l.TBL_CUSTOMER.MIDDLENAME + " " + l.TBL_CUSTOMER.LASTNAME,
                                   customerId = l.CUSTOMERID,
                                   approvedAmount = l.PRINCIPALAMOUNT,
                                   branchId = l.BRANCHID,
                                   branchName = l.TBL_BRANCH.BRANCHNAME,
                                   interestRate = l.INTERESTRATE,
                                   outstandingInterest = l.OUTSTANDINGINTEREST,
                                   outstandingPrincipal = l.OUTSTANDINGPRINCIPAL,
                                   principalAmount = l.PRINCIPALAMOUNT,
                                   currency = l.TBL_CURRENCY.CURRENCYNAME,
                                   loanReferenceNumber = l.LOANREFERENCENUMBER,
                                   effectiveDate = applicationDate,
                                   previousEffectiveDate = l.EFFECTIVEDATE,
                                   equityContribution = 0,
                                   maintainTenor = true,
                                   maturityDate = l.MATURITYDATE,
                                   scheduleTypeId = l.SCHEDULETYPEID,
                                   scheduleTypeCategoryId = l.TBL_LOAN_SCHEDULE_TYPE.SCHEDULECATEGORYID,
                                   newTenor = 0,
                                   principalFrequencyTypeId = l.PRINCIPALFREQUENCYTYPEID,
                                   interestFrequencyTypeId = l.INTERESTFREQUENCYTYPEID,
                                   relationshipManagerId = l.RELATIONSHIPMANAGERID,
                                   relationshipOfficerId = l.RELATIONSHIPOFFICERID,
                                   productTypeId = l.TBL_PRODUCT.PRODUCTTYPEID,
                                   systemCurrentDate = applicationDate
                               }).FirstOrDefault();

            return runningLoan;
        }

        public IEnumerable<LoanViewModel> GetLoanRateCustomerExcemptions(int companyId)
        {
            var excemptionsList = (from l in context.TBL_LOAN
                                   join p in context.TBL_LOAN_PRICEINDEX_EXCEPTION
                                     on l.TERMLOANID equals p.LOANID
                                   where l.COMPANYID == companyId
                                   select new LoanViewModel()
                                   {
                                       companyName = l.TBL_COMPANY.NAME,
                                       companyId = l.COMPANYID,
                                       customerName = l.TBL_CUSTOMER.FIRSTNAME + " " + l.TBL_CUSTOMER.MIDDLENAME + " " + l.TBL_CUSTOMER.LASTNAME,
                                       customerId = l.CUSTOMERID,
                                       approvedAmount = l.PRINCIPALAMOUNT,
                                       branchName = l.TBL_BRANCH.BRANCHNAME,
                                       interestRate = l.INTERESTRATE,
                                       outstandingInterest = l.OUTSTANDINGINTEREST,
                                       outstandingPrincipal = l.OUTSTANDINGPRINCIPAL,
                                       principalAmount = l.PRINCIPALAMOUNT,
                                       currency = l.TBL_CURRENCY.CURRENCYCODE,
                                       loanReferenceNumber = l.LOANREFERENCENUMBER

                                   });

            return excemptionsList;
        }

        public IEnumerable<LoanBulkInterestReviewViewModel> GetNewInterestRateReviews(int companyId)
        {
            var newRates = (from l in context.TBL_LOAN_BULK_INTEREST_REVIEW
                            where l.COMPANYID == companyId && l.ISPROCESSED == false
                            select new LoanBulkInterestReviewViewModel()
                            {
                                effectiveDate = l.EFFECTIVEDATE,
                                productPriceIndexId = l.PRODUCTPRICEINDEXID,
                                productPriceIndexName = l.TBL_PRODUCT_PRICE_INDEX.PRICEINDEXNAME,
                                oldInterestRate = l.OLDINTERESTRATE,
                                newInterestRate = l.NEWINTERESTRATE,
                                isProcessed = l.ISPROCESSED,
                                createdBy = l.CREATEDBY,

                            });
            return newRates;
        }

        public bool addBulkRateLoanExcemptions(LoanViewModel model)
        {
            var data = new TBL_LOAN_PRICEINDEX_EXCEPTION
            {
                LOANID = model.loanId,
                CREATEDBY = model.createdBy,
                DATETIMECREATED = generalSetup.GetApplicationDate(),
            };

            //Audit Section ---------------------------
            var loanReferenceNumber = context.TBL_LOAN.Find(model.loanId).LOANREFERENCENUMBER;

            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.BulkRateLoanExcemption,
                STAFFID = model.createdBy,
                BRANCHID = (short)model.branchId,
                DETAIL = $"Added bulk rate review loan excemption for loan with ReferenceNumber: {loanReferenceNumber}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = model.applicationUrl,
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName()
            };
            //end of Audit section -------------------------------

            context.TBL_LOAN_PRICEINDEX_EXCEPTION.Add(data);
            context.TBL_AUDIT.Add(audit);
            return context.SaveChanges() > 0;

        }

        public bool addInterestRateChange(LoanBulkInterestReviewViewModel model)
        {
            var data = new TBL_LOAN_BULK_INTEREST_REVIEW
            {
                COMPANYID = model.companyId,
                EFFECTIVEDATE = model.effectiveDate,
                PRODUCTPRICEINDEXID = model.productPriceIndexId,
                OLDINTERESTRATE = model.oldInterestRate,
                NEWINTERESTRATE = model.newInterestRate,
                ISPROCESSED = false,
                CREATEDBY = model.createdBy,
            };

            //Audit Section -----------------------------------
            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.BulkRateLoanExcemption,
                STAFFID = model.createdBy,
                BRANCHID = (short)model.userBranchId,
                DETAIL = $"Added bulk New Interest Rate from  {model.oldInterestRate} to {model.newInterestRate}. Effective from {model.effectiveDate}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = model.applicationUrl,
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName()
            };
            //end of Audit section -------------------------------

            context.TBL_LOAN_BULK_INTEREST_REVIEW.Add(data);
            context.TBL_AUDIT.Add(audit);
            return context.SaveChanges() > 0;
        }

        public IEnumerable<LoanOperationTypeViewModel> GetOperationType(bool isFinalOperation = false)
        {
            if (isFinalOperation)
            {
                return (from data in context.TBL_OPERATIONS
                        where data.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagement
                        && data.ISDISABLED == false
                        select new LoanOperationTypeViewModel()
                        {
                            operationTypeId = data.OPERATIONID,
                            operationTypeName = data.OPERATIONNAME,
                        }).OrderBy(x=>x.operationTypeName).ToList();
            }
            return (from data in context.TBL_OPERATIONS
                    where data.OPERATIONTYPEID == (int)OperationTypeEnum.LoanReviewApplication
                    && data.ISDISABLED == false
                    select new LoanOperationTypeViewModel()
                    {
                        operationTypeId = data.OPERATIONID,
                        operationTypeName = data.OPERATIONNAME,
                    }).OrderBy(x => x.operationTypeName).ToList();
        }

        public IEnumerable<LoanOperationTypeViewModel> GetOperationTypeByOD()
        {
            var odOperations =  (from data in context.TBL_OPERATIONS
                    where data.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagementOverdraft 
                    && data.ISDISABLED == false
                    || data.OPERATIONID == (int)OperationsEnum.AnnualReview
                    || data.OPERATIONID == (int)OperationsEnum.LoanTermination
                    || data.OPERATIONID == (int)OperationsEnum.CompleteWriteOff
                    || data.OPERATIONID == (int)OperationsEnum.FullAndFinalCompleteWriteOff
                    || data.OPERATIONID == (int)OperationsEnum.LoanRecapitilization
                                 select new LoanOperationTypeViewModel()
                    {
                        operationTypeId = data.OPERATIONID,
                        operationTypeName = data.OPERATIONNAME
                    }).OrderBy(x=>x.operationTypeName).ToList();

            //var odOperations2 = (from datas in context.TBL_OPERATIONS
            //                    where datas.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagement && datas.ISDISABLED == false
            //                    select new LoanOperationTypeViewModel()
            //                    {
            //                        operationTypeId = datas.OPERATIONID,
            //                        operationTypeName = datas.OPERATIONNAME
            //                    }).OrderBy(x => x.operationTypeName).ToList();

            return odOperations.OrderBy(x=>x.operationTypeName);
        }

        public IEnumerable<LoanOperationTypeViewModel> GetRemedialOperationType()
        {

            return (from data in context.TBL_OPERATIONS
                    where data.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagement
                    select new LoanOperationTypeViewModel()
                    {
                        operationTypeId = data.OPERATIONID,
                        operationTypeName = data.OPERATIONNAME
                    });
        }

        public IEnumerable<LoanOperationTypeViewModel> GetReviewApprovalOperationTypeByLoanId(LoanProductTypeEnum productTypeId, LoanScheduleTypeEnum scheduleTypeId)
        {
            var loanOperations = (from data in context.TBL_OPERATIONS
                                  where data.OPERATIONTYPEID == (int)OperationTypeEnum.LoanReviewApplication
                                  select new LoanOperationTypeViewModel()
                                  {
                                      operationTypeId = data.OPERATIONID,
                                      operationTypeName = data.OPERATIONNAME
                                  });

            List<OperationsEnum> operationList = new List<OperationsEnum>();

            if (productTypeId == LoanProductTypeEnum.TermLoan || productTypeId == LoanProductTypeEnum.SelfLiquidating)
            {
                if ((scheduleTypeId == LoanScheduleTypeEnum.Annuity) || (scheduleTypeId == LoanScheduleTypeEnum.ConstantPrincipalAndInterest))
                {
                    operationList.Add(OperationsEnum.OverdraftTopup);
                    operationList.Add(OperationsEnum.OverdraftSubAllocation);
                    loanOperations = loanOperations.Where(x => !operationList.Contains((OperationsEnum)x.operationTypeId));
                }
                else if (scheduleTypeId == LoanScheduleTypeEnum.IrregularSchedule)
                {
                    operationList.Add(OperationsEnum.InterestandPrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.PrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.InterestFrequencyChange);
                    operationList.Add(OperationsEnum.InterestSuspension);
                    operationList.Add(OperationsEnum.TenorChange);
                    operationList.Add(OperationsEnum.OverdraftTopup);
                    operationList.Add(OperationsEnum.OverdraftSubAllocation);
                    loanOperations = loanOperations.Where(x => !operationList.Contains((OperationsEnum)x.operationTypeId));
                }
                else if (scheduleTypeId == LoanScheduleTypeEnum.BulletPayment)
                {
                    operationList.Add(OperationsEnum.InterestSuspension);
                    operationList.Add(OperationsEnum.InterestandPrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.PrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.InterestFrequencyChange);
                    operationList.Add(OperationsEnum.OverdraftTopup);
                    operationList.Add(OperationsEnum.OverdraftSubAllocation);
                    loanOperations = loanOperations.Where(x => !operationList.Contains((OperationsEnum)x.operationTypeId));
                }
                else if (scheduleTypeId == LoanScheduleTypeEnum.BallonPayment)
                {
                    operationList.Add(OperationsEnum.InterestandPrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.PrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.OverdraftTopup);
                    operationList.Add(OperationsEnum.OverdraftSubAllocation);
                    loanOperations = loanOperations.Where(x => !operationList.Contains((OperationsEnum)x.operationTypeId));
                }
            }
            else if (productTypeId == LoanProductTypeEnum.RevolvingLoan)
            {
                operationList.Add(OperationsEnum.TenorChange);
                operationList.Add(OperationsEnum.OverdraftTopup);
                operationList.Add(OperationsEnum.OverdraftSubAllocation);
                operationList.Add(OperationsEnum.TerminateAndRebook);

                loanOperations = loanOperations.Where(x => operationList.Contains((OperationsEnum)x.operationTypeId));
            }
            else if (productTypeId == LoanProductTypeEnum.ContingentLiability)
            {

            }

            return loanOperations;
        }

        public IEnumerable<LoanOperationTypeViewModel> GetOperationTypeByLoanId(LoanProductTypeEnum productTypeId, LoanScheduleTypeEnum scheduleTypeId)
        {
            var loanOperations = (from data in context.TBL_OPERATIONS
                                  where data.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagement
                                  select new LoanOperationTypeViewModel()
                                  {
                                      operationTypeId = data.OPERATIONID,
                                      operationTypeName = data.OPERATIONNAME
                                  });

            List<OperationsEnum> operationList = new List<OperationsEnum>();

            if (productTypeId == LoanProductTypeEnum.TermLoan || productTypeId == LoanProductTypeEnum.SelfLiquidating)
            {
                if ((scheduleTypeId == LoanScheduleTypeEnum.Annuity) || (scheduleTypeId == LoanScheduleTypeEnum.ConstantPrincipalAndInterest))
                {
                    operationList.Add(OperationsEnum.OverdraftTopup);
                    operationList.Add(OperationsEnum.OverdraftSubAllocation);
                    loanOperations = loanOperations.Where(x => !operationList.Contains((OperationsEnum)x.operationTypeId));
                }
                else if (scheduleTypeId == LoanScheduleTypeEnum.IrregularSchedule)
                {
                    operationList.Add(OperationsEnum.InterestandPrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.PrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.InterestFrequencyChange);
                    operationList.Add(OperationsEnum.InterestSuspension);
                    operationList.Add(OperationsEnum.TenorChange);
                    operationList.Add(OperationsEnum.OverdraftTopup);
                    operationList.Add(OperationsEnum.OverdraftSubAllocation);
                    loanOperations = loanOperations.Where(x => !operationList.Contains((OperationsEnum)x.operationTypeId));
                }
                else if (scheduleTypeId == LoanScheduleTypeEnum.BulletPayment)
                {
                    operationList.Add(OperationsEnum.InterestSuspension);
                    operationList.Add(OperationsEnum.InterestandPrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.PrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.InterestFrequencyChange);
                    operationList.Add(OperationsEnum.OverdraftTopup);
                    operationList.Add(OperationsEnum.OverdraftSubAllocation);
                    loanOperations = loanOperations.Where(x => !operationList.Contains((OperationsEnum)x.operationTypeId));
                }
                else if (scheduleTypeId == LoanScheduleTypeEnum.BallonPayment)
                {
                    operationList.Add(OperationsEnum.InterestandPrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.PrincipalFrequencyChange);
                    operationList.Add(OperationsEnum.OverdraftTopup);
                    operationList.Add(OperationsEnum.OverdraftSubAllocation);
                    loanOperations = loanOperations.Where(x => !operationList.Contains((OperationsEnum)x.operationTypeId));
                }
            }
            else if (productTypeId == LoanProductTypeEnum.RevolvingLoan)
            {
                operationList.Add(OperationsEnum.TenorChange);
                operationList.Add(OperationsEnum.OverdraftTopup);
                operationList.Add(OperationsEnum.OverdraftSubAllocation);
                operationList.Add(OperationsEnum.TerminateAndRebook);

                loanOperations = loanOperations.Where(x => operationList.Contains((OperationsEnum)x.operationTypeId));
            }
            else if (productTypeId == LoanProductTypeEnum.ContingentLiability)
            {

            }

            return loanOperations;
        }

        public bool DoesOperationExist(int loanId, int operationTypeId, int loanSystemTypeId)
        {
            //List<int> finalApprovals = new List<int> { (int)ApprovalStatusEnum.Approved, (int)ApprovalStatusEnum.Disapproved };

            var data = from a in context.TBL_LOAN_REVIEW_OPERATION

                       where a.LOANID == loanId
                       && a.OPERATIONTYPEID == operationTypeId
                       && a.LOANSYSTEMTYPEID == loanSystemTypeId
                       && a.OPERATIONCOMPLETED == false
                       && (a.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved || a.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved)
                       select a;

            if (data.Any())
            {
                return true;
            }
            return false;
        }

        public bool DoesChargeFeeExist(int loanId, int operationTypeId, int chargeFeeId)
        {
            //List<int> finalApprovals = new List<int> { (int)ApprovalStatusEnum.Approved, (int)ApprovalStatusEnum.Disapproved };

            var data = from a in context.TBL_LOAN_REVIEW_OPERATION
                       where a.LOANID == loanId && a.OPERATIONTYPEID == operationTypeId
                      && a.INTERESTFREQUENCYTYPEID == chargeFeeId && a.OPERATIONCOMPLETED == false
                       select a;

            if (data.Any())
            {
                return true;
            }
            return false;
        }

        public TBL_LOAN GetLoanInformation(int loanid)
        {
            return context.TBL_LOAN.Where(x => x.TERMLOANID == loanid).FirstOrDefault();
        }

        //public bool AddOperationReview(LoanReviewOperationViewModel model)
        //{
        //    var reviewApplicationDetail = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == model.lmsApplicationDetailId).FirstOrDefault();
        //    if (model.operationTypeId == (int)OperationsEnum.TenorChange)
        //    {
        //        var topUpData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == model.loanId && x.OPERATIONTYPEID == (short)OperationsEnum.OverdraftTopup && x.OPERATIONCOMPLETED == true);
        //        if (topUpData.Count() > 0)
        //        {
        //            throw new ConditionNotMetException("You cannot do extendon an overdraft that already has a topup.");
        //        }
        //    }

        //    if (model.operationTypeId == (int)OperationsEnum.Restructured)
        //    {
        //        if (model.interestFirstPaymentDate > model.maturityDate)
        //            throw new ConditionNotMetException("Interest First Payment Date must be less than the maturity Date");

        //        if (model.principalFirstPaymentDate > model.maturityDate)
        //            throw new ConditionNotMetException("Principal First Payment Date must be less than the maturity Date");

        //        if (model.interestFirstPaymentDate > model.principalFirstPaymentDate)
        //            throw new ConditionNotMetException("Interest First Payment Date must be less than Principal First Payment Date");

        //        if (model.maturityDate < model.proposedEffectiveDate)
        //            throw new ConditionNotMetException("Effective Date must be less than the Maturity Date");

        //        if (model.interestFirstPaymentDate < model.proposedEffectiveDate)
        //            throw new ConditionNotMetException("Interest First Payment Date must be greater than efffective date");

        //        if (model.principalFirstPaymentDate < model.proposedEffectiveDate)
        //            throw new ConditionNotMetException("Principal First Payment Date must be greater than efffective date");
        //    }
        //    if (model.operationTypeId == (short)OperationsEnum.OverdraftRenewal)
        //    {

        //        if ((model.maturityDate.Value - model.proposedEffectiveDate).Days < 30)
        //        {
        //            throw new ConditionNotMetException("The Overdraft renewal period is too short for normal OD");
        //        }

        //        var reviewDate = model.proposedEffectiveDate.AddDays(31);
        //        if (reviewDate > model.maturityDate)
        //        {
        //            throw new ConditionNotMetException("The review date must be prior to expiry date. Review date equals effective date plus one month");
        //        }
        //    }

        //    if ((int)OperationsEnum.Prepayment == model.operationTypeId)
        //    {
        //        model.approvalStatusId = (int)ApprovalStatusEnum.Processing;
        //    }
        //    else if (model.operationTypeId == (int)OperationsEnum.Fee_chargeChange)
        //    {
        //        if (DoesChargeFeeExist(model.loanId, model.operationTypeId, (int)model.interestFrequencyTypeId))
        //        {
        //            throw new ConditionNotMetException("The requested charge fee type already exist and going through approval");
        //        }
        //    }
        //    else
        //    {
        //        //if (model.principalFirstPaymentDate < model.proposedEffectiveDate)
        //        //{
        //        //    throw new ConditionNotMetException("Principal First Payment Date cannot be less than Effective date");
        //        //}

        //        //if (model.interestFirstPaymentDate < model.proposedEffectiveDate)
        //        //{
        //        //    throw new ConditionNotMetException ("Interest First Payment Date cannot be less than Effective date");
        //        //}
        //    }

        //    short loanSystemTypeId = reviewApplicationDetail != null ? (short)reviewApplicationDetail.LOANSYSTEMTYPEID : (short)model.loanSystemTypeId;
        //    if ((int)OperationsEnum.Prepayment != model.operationTypeId)
        //    {
        //        if (DoesOperationExist(model.loanId, model.operationTypeId, loanSystemTypeId))
        //        {
        //            throw new ConditionNotMetException("The requested operation already exist and going through approval");
        //        }
        //    }
        //    else
        //    {
        //        var nextPeriodicPricipalPaymentDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == model.loanId && x.PAYMENTDATE > model.proposedEffectiveDate && x.PERIODPRINCIPALAMOUNT > 0).OrderBy(x => x.PAYMENTNUMBER).Take(1).FirstOrDefault();

        //        //model.firstPaymentDate = nextPeriodicPricipalPaymentDate.PAYMENTDATE;
        //        model.principalFirstPaymentDate = nextPeriodicPricipalPaymentDate.PAYMENTDATE;

        //        var nextPeriodicInterestPaymentDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == model.loanId && x.PAYMENTDATE > model.proposedEffectiveDate && x.PERIODINTERESTAMOUNT > 0).OrderBy(x => x.PAYMENTNUMBER).Take(1).FirstOrDefault();
        //        model.interestFirstPaymentDate = nextPeriodicInterestPaymentDate.PAYMENTDATE;

        //        var loanInfo = context.TBL_LOAN.Where(x => x.TERMLOANID == model.loanId).FirstOrDefault();
        //        model.interestFrequencyTypeId = loanInfo.INTERESTFREQUENCYTYPEID;
        //        model.principalFrequencyTypeId = loanInfo.PRINCIPALFREQUENCYTYPEID;
        //        //model.maturityDate = loanInfo.MATURITYDATE;
        //        //model.interestRate = loanInfo.INTERESTRATE;

        //        if (model.prepayment >= loanInfo.OUTSTANDINGPRINCIPAL)
        //        {
        //            throw new ConditionNotMetException("Prepayment amount should not be equal or greater than the outstanding principal");
        //        }

        //        if (DoesOperationExist(model.loanId, model.operationTypeId, (short)LoanSystemTypeEnum.TermDisbursedFacility))
        //        {
        //            throw new ConditionNotMetException("The requested operation already exist and going through approval");
        //        }
        //    }

        //    int counterNew = 0;

        //    List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> irregularSchedules = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
        //    //Storing the Irregular Schedule Payment Plan

        //    if (model.reviewIrregularSchedule != null)
        //    {

        //        if (model.reviewIrregularSchedule.Count > 0)
        //        {
        //            foreach (var item in model.reviewIrregularSchedule)
        //            {

        //                counterNew = counterNew + 1;

        //                if (counterNew == 1)
        //                {
        //                    model.proposedEffectiveDate = item.PaymentDate;
        //                    model.maturityDate = item.PaymentDate;
        //                }
        //                else
        //                {
        //                    model.maturityDate = item.PaymentDate;
        //                }


        //                var irregularPlan = new TBL_LOAN_REVIEW_OPRATN_IREG_SC
        //                {
        //                    PAYMENTAMOUNT = item.PaymentAmount,
        //                    PAYMENTDATE = item.PaymentDate,
        //                    CREATEDBY = model.createdBy,
        //                    DATETIMECREATED = DateTime.Now
        //                };
        //                irregularSchedules.Add(irregularPlan);
        //            }
        //        }
        //    }



        //    int _operationTypeId = 0;
        //    if ((int)OperationsEnum.Prepayment == model.operationTypeId)
        //    {
        //        _operationTypeId = 1;
        //    }
        //    else
        //    {
        //        _operationTypeId = model.productTypeId;
        //    }

        //    _operationTypeId = 0;
        //    if ((int)OperationsEnum.Prepayment == model.operationTypeId)
        //    {
        //        _operationTypeId = 1;
        //    }
        //    else
        //    {
        //        _operationTypeId = model.productTypeId;
        //    }

        //    // if (reviewApplicationDetail == null) throw new SecureException("Review application details not found!");

        //    int? loanReviewApplicationId = null;
        //    if (reviewApplicationDetail != null)
        //    {
        //        loanReviewApplicationId = (int?)reviewApplicationDetail.LOANREVIEWAPPLICATIONID;
        //        reviewApplicationDetail.OPERATIONPERFORMED = true;
        //    }
        //    TBL_LOAN_REVIEW_OPERATION reviewOperation = new TBL_LOAN_REVIEW_OPERATION();

        //    if (model.loanReviewOperationsId == 0)
        //    {
        //        //int loanSystemTypeId = 0;
        //        if (reviewApplicationDetail == null)
        //        {
        //            loanSystemTypeId = (short)model.loanSystemTypeId;
        //        }
        //        else
        //        {
        //            loanSystemTypeId = reviewApplicationDetail.LOANSYSTEMTYPEID;
        //        }

        //        reviewOperation = context.TBL_LOAN_REVIEW_OPERATION.Add(new TBL_LOAN_REVIEW_OPERATION
        //        {
        //            LOANID = model.loanId,
        //            LOANREVIEWAPPLICATIONID = loanReviewApplicationId,
        //            LOANSYSTEMTYPEID = loanSystemTypeId,//reviewApplicationDetail.LOANSYSTEMTYPEID, // model.loanSystemTypeId,
        //            OPERATIONTYPEID = model.operationTypeId,
        //            EFFECTIVEDATE = model.proposedEffectiveDate,
        //            REVIEWDETAILS = model.reviewDetails,
        //            INTERATERATE = model.interateRate == null ? 0 : (double)model.interateRate,
        //            PREPAYMENT = model.prepayment ?? 0,
        //            PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId,
        //            INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId,
        //            PRINCIPALFIRSTPAYMENTDATE = model.principalFirstPaymentDate,
        //            INTERESTFIRSTPAYMENTDATE = model.interestFirstPaymentDate,
        //            MATURITYDATE = model.maturityDate,
        //            TENOR = model.tenor,
        //            CASA_ACCOUNTID = model.cASA_AccountId,
        //            OVERDRAFTTOPUP = model.overDraftTopup,
        //            FEE_CHARGES = model.fee_Charges,
        //            APPROVALSTATUSID = model.approvalStatusId,
        //            ISMANAGEMENTINTERESTRATE = model.isManagementRate,
        //            SCHEDULETYPEID = model.scheduleTypeId,
        //            SCHEDULEDAYINTERESTTYPEID = model.interestTypeId,
        //            SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountId,
        //            OPERATIONCOMPLETED = false,
        //            CREATEDBY = model.createdBy,
        //            DATECREATED = DateTime.Now,
        //            TBL_LOAN_REVIEW_OPRATN_IREG_SC = irregularSchedules,
        //            PREPAYMENTMETHODID = model.prepaymentMethodId,
        //            TARGETID = model.TargetId,
        //        });
        //        if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

        //        auditTrail.AddAuditTrail(new TBL_AUDIT
        //        {
        //            AUDITTYPEID = (short)AuditTypeEnum.LoanDocumentAdded,
        //            STAFFID = model.createdBy,
        //            BRANCHID = model.userBranchId,
        //            DETAIL = $"Added tbl_Loan_Review_Operation '{ reviewOperation.LOANREVIEWOPERATIONID}' ",
        //            IPADDRESS = model.userIPAddress,
        //            URL = model.applicationUrl,
        //            APPLICATIONDATE = generalSetup.GetApplicationDate(),
        //            SYSTEMDATETIME = DateTime.Now
        //        });

        //        workFlow.StaffId = model.createdBy;
        //        workFlow.CompanyId = model.companyId;
        //        workFlow.StatusId = (int)ApprovalStatusEnum.Pending;
        //        workFlow.TargetId = reviewOperation.LOANREVIEWOPERATIONID; // model.loanReviewOperationsId;
        //        workFlow.Comment = "Review operation";
        //        workFlow.OperationId = model.operationTypeId;
        //        workFlow.DeferredExecution = true; // false by default will call the internal SaveChanges()
        //        workFlow.ExternalInitialization = true;
        //        var response = workFlow.LogActivity();

        //        //LOF ACTIVITY TO END WORKFLOW

        //        if (model.operationTypeId != (int)OperationsEnum.Prepayment)
        //        {
        //            LogLMSOperationRouteWorkflow(model, (int)loanReviewApplicationId, loanSystemTypeId);
        //        }


        //        bool result = false;
        //        if (model.fees != null)
        //        {
        //            LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

        //            feeDetails.feeDetails = model.fees;
        //            feeDetails.createdBy = model.createdBy;
        //            feeDetails.userIPAddress = model.userIPAddress;
        //            feeDetails.userBranchId = model.userBranchId;
        //            feeDetails.applicationUrl = model.applicationUrl;
        //            feeDetails.companyId = model.companyId;
        //            feeDetails.loanOperationReviewId = reviewOperation.LOANREVIEWOPERATIONID;
        //            result = SubmitTakeFee(feeDetails);
        //        }
        //        else
        //        {
        //            int resultStatus = context.SaveChanges();
        //            if (resultStatus > 1)
        //            {
        //                result = true;
        //            }
        //            else
        //            {
        //                result = false;
        //            }

        //        }


        //        return result;
        //    }
        //    else
        //    {
        //        reviewOperation = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == model.loanReviewOperationsId).FirstOrDefault();
        //        reviewOperation.LOANID = model.loanId;
        //        reviewOperation.LOANREVIEWAPPLICATIONID = loanReviewApplicationId;
        //        reviewOperation.LOANSYSTEMTYPEID = reviewApplicationDetail.LOANSYSTEMTYPEID; // model.loanSystemTypeId,
        //                                                                                     // reviewOperation.OPERATIONTYPEID = model.operationTypeId;
        //        reviewOperation.EFFECTIVEDATE = model.proposedEffectiveDate;
        //        reviewOperation.REVIEWDETAILS = model.reviewDetails;
        //        reviewOperation.INTERATERATE = model.interateRate == null ? 0 : (double)model.interateRate;
        //        reviewOperation.PREPAYMENT = model.prepayment ?? 0;
        //        reviewOperation.PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId;
        //        reviewOperation.INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId;
        //        reviewOperation.PRINCIPALFIRSTPAYMENTDATE = model.principalFirstPaymentDate;
        //        reviewOperation.INTERESTFIRSTPAYMENTDATE = model.interestFirstPaymentDate;
        //        reviewOperation.MATURITYDATE = model.maturityDate;
        //        reviewOperation.TENOR = model.tenor;
        //        reviewOperation.CASA_ACCOUNTID = model.cASA_AccountId;
        //        reviewOperation.OVERDRAFTTOPUP = model.overDraftTopup;
        //        reviewOperation.FEE_CHARGES = model.fee_Charges;
        //        reviewOperation.APPROVALSTATUSID = model.approvalStatusId;
        //        reviewOperation.ISMANAGEMENTINTERESTRATE = model.isManagementRate;
        //        reviewOperation.SCHEDULETYPEID = model.scheduleTypeId;
        //        reviewOperation.SCHEDULEDAYINTERESTTYPEID = model.interestTypeId;
        //        reviewOperation.SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountId;
        //        reviewOperation.OPERATIONCOMPLETED = false;
        //        reviewOperation.CREATEDBY = model.createdBy;
        //        reviewOperation.TBL_LOAN_REVIEW_OPRATN_IREG_SC = irregularSchedules;

        //        reviewApplicationDetail.OPERATIONPERFORMED = true;

        //        auditTrail.AddAuditTrail(new TBL_AUDIT
        //        {
        //            AUDITTYPEID = (short)AuditTypeEnum.LoanDocumentAdded,
        //            STAFFID = model.createdBy,
        //            BRANCHID = model.userBranchId,
        //            DETAIL = $"Added tbl_Loan_Review_Operation '{reviewOperation.LOANREVIEWOPERATIONID}' ",
        //            IPADDRESS = model.userIPAddress,
        //            URL = model.applicationUrl,
        //            APPLICATIONDATE = generalSetup.GetApplicationDate(),
        //            SYSTEMDATETIME = DateTime.Now
        //        });


        //        bool result = false;
        //        if (model.fees != null)
        //        {
        //            LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

        //            feeDetails.feeDetails = model.fees;
        //            feeDetails.createdBy = model.createdBy;
        //            feeDetails.userIPAddress = model.userIPAddress;
        //            feeDetails.userBranchId = model.userBranchId;
        //            feeDetails.applicationUrl = model.applicationUrl;
        //            feeDetails.companyId = model.companyId;
        //            feeDetails.loanOperationReviewId = reviewOperation.LOANREVIEWOPERATIONID;
        //            result = SubmitTakeFee(feeDetails);
        //        }
        //        else
        //        {
        //            result = context.SaveChanges() > 0;
        //        }



        //        return result;

        //    }
        //}

        public bool AddOperationReview(LoanReviewOperationViewModel model)
        {
            bool result = false;

            using (TransactionScope transactionScope = new TransactionScope())
            {
                var reviewApplicationDetail = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == model.lmsApplicationDetailId).FirstOrDefault();

                if (model.operationTypeId == (int)OperationsEnum.TenorChange)
                {
                    var topUpData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == model.loanId && x.OPERATIONTYPEID == (short)OperationsEnum.OverdraftTopup && x.OPERATIONCOMPLETED == true);
                    if (topUpData.Count() > 0)
                    {
                        throw new ConditionNotMetException("You cannot do extend on an overdraft that already has a topup.");
                    }
                }

                if (model.operationTypeId == (int)OperationsEnum.Restructured)
                {
                    if (model.interestFirstPaymentDate > model.maturityDate)
                        throw new ConditionNotMetException("Interest First Payment Date must be less than the maturity Date");

                    if (model.principalFirstPaymentDate > model.maturityDate)
                        throw new ConditionNotMetException("Principal First Payment Date must be less than the maturity Date");

                    if (model.interestFirstPaymentDate > model.principalFirstPaymentDate)
                        throw new ConditionNotMetException("Interest First Payment Date must be less than Principal First Payment Date");

                    if (model.maturityDate < model.proposedEffectiveDate)
                        throw new ConditionNotMetException("Effective Date must be less than the Maturity Date");

                    if (model.interestFirstPaymentDate < model.proposedEffectiveDate)
                        throw new ConditionNotMetException("Interest First Payment Date must be greater than efffective date");

                    if (model.principalFirstPaymentDate < model.proposedEffectiveDate)
                        throw new ConditionNotMetException("Principal First Payment Date must be greater than efffective date");
                }
                if (model.operationTypeId == (short)OperationsEnum.OverdraftRenewal)
                {

                    if ((model.maturityDate.Value - model.proposedEffectiveDate).Days < 30)
                    {
                        throw new ConditionNotMetException("The Overdraft renewal period is too short for normal OD");
                    }

                    var reviewDate = model.proposedEffectiveDate.AddDays(31);
                    if (reviewDate > model.maturityDate)
                    {
                        throw new ConditionNotMetException("The review date must be prior to expiry date. Review date equals effective date plus one month");
                    }
                }

                if ((int)OperationsEnum.Prepayment == model.operationTypeId || (int)OperationsEnum.LoanTermination == model.operationTypeId)
                {
                    model.approvalStatusId = (int)ApprovalStatusEnum.Processing;
                }
                else if (model.operationTypeId == (int)OperationsEnum.Fee_chargeChange)
                {
                    if (DoesChargeFeeExist(model.loanId, model.operationTypeId, (int)model.interestFrequencyTypeId))
                    {
                        throw new ConditionNotMetException("The requested charge fee type already exist and going through approval");
                    }
                }
                else
                {
                    //if (model.principalFirstPaymentDate < model.proposedEffectiveDate)
                    //{
                    //    throw new ConditionNotMetException("Principal First Payment Date cannot be less than Effective date");
                    //}

                    //if (model.interestFirstPaymentDate < model.proposedEffectiveDate)
                    //{
                    //    throw new ConditionNotMetException ("Interest First Payment Date cannot be less than Effective date");
                    //}
                }

                short loanSystemTypeId = reviewApplicationDetail != null ? (short)reviewApplicationDetail.LOANSYSTEMTYPEID : (short)model.loanSystemTypeId;
                if ((int)OperationsEnum.Prepayment != model.operationTypeId || (int)OperationsEnum.LoanTermination == model.operationTypeId)
                {
                    if (DoesOperationExist(model.loanId, model.operationTypeId, loanSystemTypeId))
                    {
                        throw new ConditionNotMetException("The requested operation already exist and going through approval");
                    }
                }
                else
                {
                    try
                    {
                        var nextPeriodicPricipalPaymentDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == model.loanId && x.PAYMENTDATE > model.proposedEffectiveDate && x.PERIODPRINCIPALAMOUNT > 0).OrderBy(x => x.PAYMENTNUMBER).Take(1).FirstOrDefault();

                        //model.firstPaymentDate = nextPeriodicPricipalPaymentDate.PAYMENTDATE;
                        model.principalFirstPaymentDate = nextPeriodicPricipalPaymentDate.PAYMENTDATE;

                        var nextPeriodicInterestPaymentDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == model.loanId && x.PAYMENTDATE > model.proposedEffectiveDate && x.PERIODINTERESTAMOUNT > 0).OrderBy(x => x.PAYMENTNUMBER).Take(1).FirstOrDefault();
                        model.interestFirstPaymentDate = nextPeriodicInterestPaymentDate.PAYMENTDATE;

                        var loanInfo = context.TBL_LOAN.Where(x => x.TERMLOANID == model.loanId).FirstOrDefault();
                        model.interestFrequencyTypeId = loanInfo.INTERESTFREQUENCYTYPEID;
                        model.principalFrequencyTypeId = loanInfo.PRINCIPALFREQUENCYTYPEID;
                        //model.maturityDate = loanInfo.MATURITYDATE;
                        //model.interestRate = loanInfo.INTERESTRATE;

                        if (model.prepayment >= loanInfo.OUTSTANDINGPRINCIPAL)
                        {
                            throw new ConditionNotMetException("Prepayment amount should not be equal or greater than the outstanding principal");
                        }

                        if (DoesOperationExist(model.loanId, model.operationTypeId, (short)LoanSystemTypeEnum.TermDisbursedFacility))
                        {
                            throw new ConditionNotMetException("The requested operation already exist and going through approval");
                        }
                    }
                    catch (Exception ex)
                    {
                        throw new ConditionNotMetException("No matching schedule found for this loan");
                    }
                }

                int counterNew = 0;

                List<TBL_LOAN_REVIEW_OPRATN_IREG_SC> irregularSchedules = new List<TBL_LOAN_REVIEW_OPRATN_IREG_SC>();
                //Storing the Irregular Schedule Payment Plan

                if (model.reviewIrregularSchedule != null)
                {

                    if (model.reviewIrregularSchedule.Count > 0)
                    {
                        foreach (var item in model.reviewIrregularSchedule)
                        {

                            counterNew = counterNew + 1;

                            if (counterNew == 1)
                            {
                                model.proposedEffectiveDate = item.PaymentDate;
                                model.maturityDate = item.PaymentDate;
                            }
                            else
                            {
                                model.maturityDate = item.PaymentDate;
                            }


                            var irregularPlan = new TBL_LOAN_REVIEW_OPRATN_IREG_SC
                            {
                                PAYMENTAMOUNT = item.PaymentAmount,
                                PAYMENTDATE = item.PaymentDate,
                                CREATEDBY = model.createdBy,
                                DATETIMECREATED = DateTime.Now
                            };
                            irregularSchedules.Add(irregularPlan);
                        }
                    }
                }

                int _operationTypeId = 0;
                if ((int)OperationsEnum.Prepayment == model.operationTypeId || (int)OperationsEnum.LoanTermination == model.operationTypeId)
                {
                    _operationTypeId = 1;
                }
                else
                {
                    _operationTypeId = model.productTypeId;
                }

                _operationTypeId = 0;
                if ((int)OperationsEnum.Prepayment == model.operationTypeId || (int)OperationsEnum.LoanTermination == model.operationTypeId)
                {
                    _operationTypeId = 1;
                }
                else
                {
                    _operationTypeId = model.productTypeId;
                }

                if (reviewApplicationDetail == null) throw new SecureException("Review application details not found!");

                int? loanReviewApplicationId = null;
                if (reviewApplicationDetail != null)
                {
                    loanReviewApplicationId = (int?)reviewApplicationDetail.LOANREVIEWAPPLICATIONID;
                    reviewApplicationDetail.OPERATIONPERFORMED = true;
                }
                TBL_LOAN_REVIEW_OPERATION reviewOperation = new TBL_LOAN_REVIEW_OPERATION();

                if (model.loanReviewOperationsId == 0)
                {
                    //int loanSystemTypeId = 0;
                    if (reviewApplicationDetail == null)
                    {
                        loanSystemTypeId = (short)model.loanSystemTypeId;
                    }
                    else
                    {
                        loanSystemTypeId = reviewApplicationDetail.LOANSYSTEMTYPEID;
                    }

                    reviewOperation = context.TBL_LOAN_REVIEW_OPERATION.Add(new TBL_LOAN_REVIEW_OPERATION
                    {
                        LOANID = model.loanId,
                        LOANREVIEWAPPLICATIONID = loanReviewApplicationId,
                        LOANSYSTEMTYPEID = loanSystemTypeId,//reviewApplicationDetail.LOANSYSTEMTYPEID, // model.loanSystemTypeId,
                        OPERATIONTYPEID = model.operationTypeId,
                        EFFECTIVEDATE = model.proposedEffectiveDate,
                        REVIEWDETAILS = model.reviewDetails,
                        INTERATERATE = model.interateRate == null ? 0 : (double)model.interateRate,
                        PREPAYMENT = model.prepayment ?? 0,
                        PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId,
                        INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId,
                        PRINCIPALFIRSTPAYMENTDATE = model.principalFirstPaymentDate,
                        INTERESTFIRSTPAYMENTDATE = model.interestFirstPaymentDate,
                        MATURITYDATE = model.maturityDate,
                        TENOR = model.tenor,
                        CASA_ACCOUNTID = model.cASA_AccountId,
                        OVERDRAFTTOPUP = model.overDraftTopup,
                        FEE_CHARGES = model.fee_Charges,
                        APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                        ISMANAGEMENTINTERESTRATE = model.isManagementRate,
                        SCHEDULETYPEID = model.scheduleTypeId,
                        SCHEDULEDAYINTERESTTYPEID = model.interestTypeId,
                        SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountId,
                        OPERATIONCOMPLETED = false,
                        CREATEDBY = model.createdBy,
                        DATECREATED = DateTime.Now,
                        TBL_LOAN_REVIEW_OPRATN_IREG_SC = irregularSchedules,
                        PREPAYMENTMETHODID = model.prepaymentMethodId,
                        TARGETID = model.TargetId,
                        //FEETYPEID = model.feeTypeId
                    });

                    if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

                    auditTrail.AddAuditTrail(new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.LoanDocumentAdded,
                        STAFFID = model.createdBy,
                        BRANCHID = model.userBranchId,
                        DETAIL = $"Added tbl_Loan_Review_Operation '{ reviewOperation.LOANREVIEWOPERATIONID}' ",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = model.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    });

                    workFlow.StaffId = model.createdBy;
                    workFlow.CompanyId = model.companyId;
                    workFlow.StatusId = (int)ApprovalStatusEnum.Processing;
                    workFlow.TargetId = reviewOperation.LOANREVIEWOPERATIONID; // model.loanReviewOperationsId;
                    workFlow.Comment = "Review operation";
                    workFlow.OperationId = model.operationTypeId;
                    workFlow.DeferredExecution = true; // false by default will call the internal SaveChanges()
                    workFlow.ExternalInitialization = false;

                    if ((int)OperationsEnum.Prepayment == model.operationTypeId || (int)OperationsEnum.LoanTermination == model.operationTypeId)
                    {
                        var loggedInStaff = context.TBL_STAFF.FirstOrDefault(x => x.STAFFID == model.createdBy);
                        if (loggedInStaff != null)
                        {
                            workFlow.ToStaffId = loggedInStaff.SUPERVISOR_STAFFID;
                        }
                        else
                            throw new ConditionNotMetException("Supervisor is not setup for logged in staff. Kindly contact the administrator to set it up");
                    }

                    var response = workFlow.LogActivity();

                    //LOF ACTIVITY TO END WORKFLOW
                    if (model.operationTypeId != (int)OperationsEnum.Prepayment && (int)OperationsEnum.LoanTermination != model.operationTypeId)
                    {
                        //LogLMSOperationRouteWorkflow(model, (int)loanReviewApplicationId, loanSystemTypeId);
                    }

                    result = false;

                    if (model.fees != null && model.fees.Count() > 0)
                    {
                        LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                        feeDetails.feeDetails = model.fees;
                        feeDetails.createdBy = model.createdBy;
                        feeDetails.userIPAddress = model.userIPAddress;
                        feeDetails.userBranchId = model.userBranchId;
                        feeDetails.applicationUrl = model.applicationUrl;
                        feeDetails.companyId = model.companyId;
                        feeDetails.loanOperationReviewId = reviewOperation.LOANREVIEWOPERATIONID;
                        feeDetails.feeSourceModule = model.feeSourceModule;
                        result = SubmitTakeFee(feeDetails);
                    }
                    else
                    {
                        int resultStatus = context.SaveChanges();
                        if (resultStatus > 0)
                        {
                            result = true;
                        }
                        else
                        {
                            result = false;
                        }
                    }
                }
                else
                {
                    reviewOperation = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == model.loanReviewOperationsId).FirstOrDefault();
                    reviewOperation.LOANID = model.loanId;
                    reviewOperation.LOANREVIEWAPPLICATIONID = loanReviewApplicationId;
                    reviewOperation.LOANSYSTEMTYPEID = reviewApplicationDetail.LOANSYSTEMTYPEID; // model.loanSystemTypeId,
                                                                                                 // reviewOperation.OPERATIONTYPEID = model.operationTypeId;
                    reviewOperation.EFFECTIVEDATE = model.proposedEffectiveDate;
                    reviewOperation.REVIEWDETAILS = model.reviewDetails;
                    reviewOperation.INTERATERATE = model.interateRate == null ? 0 : (double)model.interateRate;
                    reviewOperation.PREPAYMENT = model.prepayment ?? 0;
                    reviewOperation.PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId;
                    reviewOperation.INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId;
                    reviewOperation.PRINCIPALFIRSTPAYMENTDATE = model.principalFirstPaymentDate;
                    reviewOperation.INTERESTFIRSTPAYMENTDATE = model.interestFirstPaymentDate;
                    reviewOperation.MATURITYDATE = model.maturityDate;
                    reviewOperation.TENOR = model.tenor;
                    reviewOperation.CASA_ACCOUNTID = model.cASA_AccountId;
                    reviewOperation.OVERDRAFTTOPUP = model.overDraftTopup;
                    reviewOperation.FEE_CHARGES = model.fee_Charges;
                    reviewOperation.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    reviewOperation.ISMANAGEMENTINTERESTRATE = model.isManagementRate;
                    reviewOperation.SCHEDULETYPEID = model.scheduleTypeId;
                    reviewOperation.SCHEDULEDAYINTERESTTYPEID = model.interestTypeId;
                    reviewOperation.SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountId;
                    reviewOperation.OPERATIONCOMPLETED = false;
                    reviewOperation.CREATEDBY = model.createdBy;
                    reviewOperation.TBL_LOAN_REVIEW_OPRATN_IREG_SC = irregularSchedules;

                    reviewApplicationDetail.OPERATIONPERFORMED = true;

                    auditTrail.AddAuditTrail(new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.LoanDocumentAdded,
                        STAFFID = model.createdBy,
                        BRANCHID = model.userBranchId,
                        DETAIL = $"Added tbl_Loan_Review_Operation '{reviewOperation.LOANREVIEWOPERATIONID}' ",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = model.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    });

                    result = false;

                    if (model.fees != null && model.fees.Count() > 0)
                    {
                        LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                        feeDetails.feeDetails = model.fees;
                        feeDetails.createdBy = model.createdBy;
                        feeDetails.userIPAddress = model.userIPAddress;
                        feeDetails.userBranchId = model.userBranchId;
                        feeDetails.applicationUrl = model.applicationUrl;
                        feeDetails.companyId = model.companyId;
                        feeDetails.loanOperationReviewId = reviewOperation.LOANREVIEWOPERATIONID;
                        feeDetails.feeSourceModule = model.feeSourceModule;
                        result = SubmitTakeFee(feeDetails);
                    }
                    else
                    {
                        result = context.SaveChanges() > 0;
                    }
                }

                transactionScope.Complete();

                transactionScope.Dispose();
                //}
                //catch (Exception ex)
                //{
                //    transactionScope.Dispose();

                //    var innerException = "";
                //    if (ex.InnerException != null)
                //    {
                //        innerException = ex.InnerException.InnerException.Message;
                //    }

                //    // stringData = $"Ref No - {loanOperation.GetTransactionReferenceNo()} Exception - {ex.Message}  - inner exception -  {innerException}";

                //    //context.SaveChanges();

                //    throw ex;
                //}
            }

            return result;
        }


        public int AddRequestUnLienODAccount(RemoveLienViewModel model, byte[] buffer)
        {
            int result = 0;
            var existing = context.TBL_LIEN_REMOVAL.Where(x => x.FILENAME == model.fileName && x.LOANREFERENCENUMBER == model.loanReferenceNumber && x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved)
             .Select(x => new RemoveLienViewModel
             {
                 unfreezeLienAccountId = x.UNFREEZELIENACCOUNTID,
                 fileData = x.FILEDATA,
                 fileExtension = x.FILEEXTENSION,
                 fileName = x.FILENAME,
                 fileSize = x.FILESIZE,
                 fileSizeUnit = x.FILESIZEUNIT,
                 casaLienAccountId = x.CASALIENACCOUNTID,
                 loanReferenceNumber = x.LOANREFERENCENUMBER,
                 createdBy = x.CREATEDBY,
                 dateTimeCreated = x.DATETIMECREATED,
                 approvalStatusId = x.APPROVALSTATUSID,
                 operationCompleted = x.OPERATIONCOMPLETED,
                 operationId = x.OPERATIONID,
                 requestDate = x.REQUESTDATE
             }).FirstOrDefault();

            if (existing != null && model.overwrite == false) return 3;

            var validate = context.TBL_LIEN_REMOVAL.Where(x => x.LOANREFERENCENUMBER == model.loanReferenceNumber
                                                          && (x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                                                          || x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing)).FirstOrDefault();
            if (validate != null)
            {
                throw new SecureException("Request already exist and under going approval");
            }

            using (TransactionScope transactionScope = new TransactionScope())
            {

                TBL_LIEN_REMOVAL removeLienOperation = new TBL_LIEN_REMOVAL();

                if (model.unfreezeLienAccountId == 0)
                {

                    removeLienOperation = context.TBL_LIEN_REMOVAL.Add(new TBL_LIEN_REMOVAL
                    {
                        CASALIENACCOUNTID = model.casaLienAccountId,
                        LOANREFERENCENUMBER = model.loanReferenceNumber,
                        FILENAME = model.fileName,
                        REQUESTDATE = model.requestDate,
                        FILEEXTENSION = model.fileExtension,
                        FILESIZE = model.fileSize,
                        FILESIZEUNIT = model.fileSizeUnit,
                        FILEDATA = buffer,
                        CREATEDBY = model.createdBy,
                        DATETIMECREATED = DateTime.Now,
                        APPROVALSTATUSID = model.approvalStatusId,
                        OPERATIONCOMPLETED = false,
                        OPERATIONID = (int)OperationsEnum.LienRemoval,
                    });

                    if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

                    auditTrail.AddAuditTrail(new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.RemoveLien,
                        STAFFID = model.createdBy,
                        BRANCHID = model.userBranchId,
                        DETAIL = $"Added TBL_LIEN_REMOVAL '{ removeLienOperation.UNFREEZELIENACCOUNTID}' ",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = model.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    });

                    workFlow.StaffId = model.createdBy;
                    workFlow.CompanyId = model.companyId;
                    workFlow.StatusId = (int)ApprovalStatusEnum.Processing;
                    workFlow.TargetId = removeLienOperation.UNFREEZELIENACCOUNTID;
                    workFlow.Comment = model.comment;
                    workFlow.OperationId = (int)OperationsEnum.LienRemoval;
                    workFlow.DeferredExecution = true;
                    workFlow.ExternalInitialization = false;

                    var response = workFlow.LogActivity();
                    int resultStatus = context.SaveChanges();
                    if (resultStatus > 0)
                    {
                        result = 2;
                    }
                }
                else
                {
                    removeLienOperation = context.TBL_LIEN_REMOVAL.Where(x => x.UNFREEZELIENACCOUNTID == model.unfreezeLienAccountId && x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved).FirstOrDefault();
                    removeLienOperation.CASALIENACCOUNTID = model.casaLienAccountId;
                    removeLienOperation.LOANREFERENCENUMBER = model.loanReferenceNumber;
                    removeLienOperation.FILENAME = model.fileName;
                    removeLienOperation.FILEEXTENSION = model.fileExtension;
                    removeLienOperation.FILESIZE = model.fileSize;
                    removeLienOperation.FILESIZEUNIT = model.fileSizeUnit;
                    removeLienOperation.FILEDATA = buffer;
                    removeLienOperation.REQUESTDATE = model.requestDate;
                    removeLienOperation.CREATEDBY = model.createdBy;
                    removeLienOperation.DATETIMECREATED = DateTime.Now;
                    removeLienOperation.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;
                    removeLienOperation.OPERATIONCOMPLETED = false;
                    removeLienOperation.OPERATIONID = (int)OperationsEnum.LienRemoval;

                    auditTrail.AddAuditTrail(new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.RemoveLien,
                        STAFFID = model.createdBy,
                        BRANCHID = model.userBranchId,
                        DETAIL = $"Added TBL_LIEN_REMOVAL '{removeLienOperation.UNFREEZELIENACCOUNTID}' ",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = model.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    });

                    if (context.SaveChanges() > 0) result = 2;
                }

                transactionScope.Complete();

                transactionScope.Dispose();

            }
            return result;
        }

        private void LogLMSOperationRouteWorkflow(LoanReviewOperationViewModel model, int loanReviewApplicationId, int loanSystemTypeId)
        {
            if (loanSystemTypeId == (short)LoanSystemTypeEnum.TermDisbursedFacility
                || loanSystemTypeId == (short)LoanSystemTypeEnum.OverdraftFacility
                || loanSystemTypeId == (short)LoanSystemTypeEnum.LineFacility)
            {
                Workflow workflowLmsOperation = new Workflow(context, generalSetup);
                workflowLmsOperation.StaffId = model.createdBy;
                workflowLmsOperation.CompanyId = model.companyId;
                workflowLmsOperation.StatusId = (short)ApprovalStatusEnum.Processing;
                workflowLmsOperation.TargetId = (int)loanReviewApplicationId;
                workflowLmsOperation.Comment = "Review Operation Initiated - pending approval";
                workflowLmsOperation.OperationId = model.operationTypeId; // (short)OperationsEnum.LmsOperations;
                workflowLmsOperation.DeferredExecution = true;
                workflowLmsOperation.ExternalInitialization = true;

                workflowLmsOperation.LogActivity();

                var trail = context.TBL_APPROVAL_TRAIL.Where(x =>
                                x.COMPANYID == model.companyId
                                && x.OPERATIONID == (short)OperationsEnum.LmsOperations
                                && x.TARGETID == loanReviewApplicationId
                                && x.RESPONSESTAFFID == null
                                && (x.APPROVALSTATEID != (int)ApprovalState.Ended && x.RESPONSEDATE == null)
                            ).ToList().FirstOrDefault();


                if (trail != null)
                {
                    trail.TOSTAFFID = null;
                    trail.TOAPPROVALLEVELID = null;
                    trail.APPROVALSTATEID = (short)ApprovalState.Ended;
                    trail.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
                }
            }
        }

        public bool SubmitTakeFee(LoanFeeChargesViewModel model)
        {
            int staffId = model.createdBy;
            var applicationDate = generalSetup.GetApplicationDate();


            List<int> customerIds = new List<int>();
            LoanViewModel loan = new LoanViewModel();
            TBL_LOAN_FEE feeCharge = new TBL_LOAN_FEE();

            foreach (var detail in model.feeDetails)
            {
                int tenor = detail.loanSystemTypeId == 4 ? loan.tenorUsed : loan.tenor;

                feeCharge = context.TBL_LOAN_FEE.Add(new TBL_LOAN_FEE
                {
                    LOANID = detail.loanId,
                    LOANSYSTEMTYPEID = detail.loanSystemTypeId,/*Term/Disbursed Facility..Overdraft Facility..Contingent Liability*/
                    CHARGEFEEID = detail.chargeFeeId, // refactor to operationId from ui!
                    ISPOSTED = false,
                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,// REMOVE DUPLICATE [STATUSID]
                    FEERATEVALUE = detail.feeRate,
                    FEEDEPENDENTAMOUNT = 0,
                    FEEAMOUNT = detail.feeAmount,
                    EARNEDFEEAMOUNT = 0,
                    TAXAMOUNT = 0,
                    EARNEDTAXAMOUNT = 0,
                    ISINTEGRALFEE = false,
                    ISRECURRING = false,
                    RECURRINGPAYMENTDAY = 0,
                    DESCRIPTION = detail.description,
                    ISMANUAL = true,
                    CREATEDBY = staffId,
                    DATETIMECREATED = applicationDate,
                    CASAACCOUNTID = detail.casaAccount,
                    LOANREVIEWOPERATIONID = model.loanOperationReviewId,
                    FEESOURCEMODULE = model.feeSourceModule,

                });
                if (context.SaveChanges() == 0) throw new SecureException("An error occured while saving the data!"); // this save is necessary to grab targetid
                auditTrail.AddAuditTrail(new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanChargeFee,
                    STAFFID = model.createdBy,
                    BRANCHID = model.userBranchId,
                    DETAIL = $"Added to tbl_Loan_Fee '{ feeCharge.LOANCHARGEFEEID}' ",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = model.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                });
                //workFlow.StaffId = model.createdBy;
                //workFlow.CompanyId = model.companyId;
                //workFlow.StatusId = (int)ApprovalStatusEnum.Pending;
                //workFlow.TargetId = feeCharge.LOANCHARGEFEEID; // model.loanReviewOperationsId;
                //workFlow.Comment = "Take Fee";
                //workFlow.OperationId = (int)OperationsEnum.ManualFeeCharge;
                //workFlow.DeferredExecution = true; // false by default will call the internal SaveChanges()
                //workFlow.ExternalInitialization = true;
                //var response = workFlow.LogActivity();
            }
            return context.SaveChanges() > 0;
        }

        public IEnumerable<LoanReviewOperationApprovalViewModel> GetLoanOperationAwaitingApproval(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();
            var staffs = generalSetup.GetStaffRlieved(staffId);

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            //var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);


            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONTYPEID == (short)OperationTypeEnum.LoanManagement).Select(c => c.OPERATIONID).ToList();
            List<int> ids = new List<int>();

            foreach (var operationId in operationIds)
            {
                ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }

            var dataLoan = (from ln in context.TBL_LOAN
                            join op in context.TBL_LOAN_REVIEW_OPERATION on ln.TERMLOANID equals op.LOANID
                            join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised)
                            && atrail.OPERATIONID != (int)OperationsEnum.GlobalInterestRateChange
                            && atrail.OPERATIONID == op.OPERATIONTYPEID
                            && ids.Contains((int)atrail.TOAPPROVALLEVELID)// == staffApprovalLevelId
                            && atrail.RESPONSESTAFFID == null && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && op.OPERATIONCOMPLETED == false   //&& mp.OPERATIONPERFORMED == true
                            && op.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility
                            && ln.LOAN_BOOKING_REQUESTID != null
                            && ((cf.CanSeeLocalCurrency && ln.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && ln.CURRENCYID != cf.DefaultCurrencyId))
                            && (staffId == (int)atrail.TOSTAFFID || atrail.TOSTAFFID == null)// currency filter
                            && (atrail.LOOPEDSTAFFID == null)

                            orderby op.DATECREATED descending

                            select new LoanReviewOperationApprovalViewModel
                            {
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),
                                mgtOperationId = op.OPERATIONTYPEID,
                                divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == ld.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                loanApplicationDetailId = ln.LOANAPPLICATIONDETAILID,
                                currApprovalStatusId = (int)ld.STATUSID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                prepaymentAmount = op.PREPAYMENT,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                  join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                  where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                  select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                contingentOutstandingPrincipal = 0,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = op.APPROVALSTATUSID,
                                approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == atrail.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                productAccountNumber = ch.ACCOUNTCODE,
                                productAccountName = ch.ACCOUNTNAME,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                operationTypeId = op.OPERATIONTYPEID,
                                operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                newEffectiveDate = op.EFFECTIVEDATE,
                                reviewDetails = op.REVIEWDETAILS,
                                prepayment = op.PREPAYMENT,
                                newInterateRate = op.INTERATERATE,
                                newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newTenor = op.TENOR,
                                cASA_AccountId = op.CASA_ACCOUNTID,
                                cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                overDraftTopup = op.OVERDRAFTTOPUP,
                                fee_Charges = op.FEE_CHARGES,
                                scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                newMaturityDate = op.MATURITYDATE,
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),

                                //lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(x => x.TBL_LMSR_APPLICATION_DETAIL.Where(a => a.LOANAPPLICATIONID == x.LOANAPPLICATIONID).Select(a => a.LOANID).FirstOrDefault() == ln.TERMLOANID).Select(x => x.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                // lmsLoanReferenceNumber = mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                dateTimeCreated = op.DATECREATED,
                                fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                {
                                    chargeFeeId = mp.CHARGEFEEID,
                                    feeAmount = mp.FEEAMOUNT,
                                    description = mp.DESCRIPTION,
                                    casaAccount = mp.CASAACCOUNTID,
                                    loanChargeFeeId = mp.LOANCHARGEFEEID,
                                    chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                    casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                }).ToList(),
                            }).Take(50).ToList();

            var dataRevolvingLoan = (from ln in context.TBL_LOAN_REVOLVING
                                     join op in context.TBL_LOAN_REVIEW_OPERATION on ln.REVOLVINGLOANID equals op.LOANID
                                     //join mp in context.TBL_LMSR_APPLICATION_DETAIL on op.LOANREVIEWAPPLICATIONID equals mp.LOANREVIEWAPPLICATIONID
                                     //join e in context.TBL_LMSR_APPLICATION on mp.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                     join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                     join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     //join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID

                                     where
                                     (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                                     || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                                     || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                                     || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                                     && atrail.OPERATIONID != (int)OperationsEnum.GlobalInterestRateChange
                                     && atrail.OPERATIONID == op.OPERATIONTYPEID
                                     && ids.Contains((int)atrail.TOAPPROVALLEVELID)// == staffApprovalLevelId
                                     && atrail.RESPONSESTAFFID == null && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                     && op.OPERATIONCOMPLETED == false
                                     && op.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.OverdraftFacility
                                     && ln.LOAN_BOOKING_REQUESTID != null
                                     && (staffId == (int)atrail.TOSTAFFID || atrail.TOSTAFFID == null)//&& mp.OPERATIONPERFORMED == true
                                     && (atrail.LOOPEDSTAFFID == null)
                                     orderby op.DATECREATED descending
                                     select new LoanReviewOperationApprovalViewModel
                                     {
                                         loanApplicationDetailId = ln.LOANAPPLICATIONDETAILID,
                                         currApprovalStatusId = (int)ld.STATUSID,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                         lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),
                                         mgtOperationId = op.OPERATIONTYPEID,
                                         loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                         appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                         customerId = ln.CUSTOMERID,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         prepaymentAmount = op.PREPAYMENT,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                           join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                           where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                           select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvalStatusId = op.APPROVALSTATUSID,
                                         approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == atrail.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         operationTypeId = op.OPERATIONTYPEID,
                                         operationTypeName = tt.OPERATIONNAME, //context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                         newEffectiveDate = op.EFFECTIVEDATE,
                                         reviewDetails = op.REVIEWDETAILS,
                                         prepayment = op.PREPAYMENT,
                                         newInterateRate = op.INTERATERATE,
                                         newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                         newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                         newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                         newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         contingentOutstandingPrincipal = 0,
                                         newTenor = op.TENOR,
                                         cASA_AccountId = op.CASA_ACCOUNTID,
                                         cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         overDraftTopup = op.OVERDRAFTTOPUP,
                                         fee_Charges = op.FEE_CHARGES,
                                         scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                         scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                         scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                         scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                         scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                         newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                         newMaturityDate = op.MATURITYDATE,
                                         //lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(x => x.TBL_LMSR_APPLICATION_DETAIL.Where(a => a.LOANAPPLICATIONID == x.LOANAPPLICATIONID).Select(a => a.LOANID).FirstOrDefault() == ln.REVOLVINGLOANID).Select(x => x.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                         dateTimeCreated = op.DATECREATED,

                                         lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,

                                         currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                         productAccountNumber = "N/A", //ch.ACCOUNTCODE,
                                         productAccountName = "N/A", // ch.ACCOUNTNAME,
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                         fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                         {
                                             chargeFeeId = mp.CHARGEFEEID,
                                             feeAmount = mp.FEEAMOUNT,
                                             description = mp.DESCRIPTION,
                                             casaAccount = mp.CASAACCOUNTID,
                                             loanChargeFeeId = mp.LOANCHARGEFEEID,
                                             chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                             casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                         }).ToList(),
                                     }).Take(50).ToList();


            var dataContingentLoan = (from ln in context.TBL_LOAN_CONTINGENT
                                      join op in context.TBL_LOAN_REVIEW_OPERATION on ln.CONTINGENTLOANID equals op.LOANID
                                      //join mp in context.TBL_LMSR_APPLICATION_DETAIL on op.LOANREVIEWAPPLICATIONID equals mp.LOANREVIEWAPPLICATIONID
                                      //join e in context.TBL_LMSR_APPLICATION on mp.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                      join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                      join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                      join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                      join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                      join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                      join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                      join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                      join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                      join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                      join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                      join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID

                                      where
                                      (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                                      || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                                      || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                                      || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                                      && atrail.OPERATIONID != (int)OperationsEnum.GlobalInterestRateChange
                                      && atrail.OPERATIONID == op.OPERATIONTYPEID
                                      && ids.Contains((int)atrail.TOAPPROVALLEVELID)// == staffApprovalLevelId
                                      && atrail.RESPONSESTAFFID == null && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                      && op.OPERATIONCOMPLETED == false
                                      && op.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.ContingentLiability
                                      && ln.LOAN_BOOKING_REQUESTID != null
                                      && (staffId == (int)atrail.TOSTAFFID || atrail.TOSTAFFID == null) //&& mp.OPERATIONPERFORMED == true
                                      && (atrail.LOOPEDSTAFFID == null)
                                      orderby op.DATECREATED descending
                                      select new LoanReviewOperationApprovalViewModel
                                      {
                                          loanApplicationDetailId = ln.LOANAPPLICATIONDETAILID,
                                          currApprovalStatusId = (int)ld.STATUSID,
                                          creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                          creditAppraisalOperationId = lp.OPERATIONID,
                                          lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                          lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                          loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                          appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                          loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                          loanId = ln.CONTINGENTLOANID,
                                          loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                          customerId = ln.CUSTOMERID,
                                          productId = ln.PRODUCTID,
                                          productTypeId = pr.PRODUCTTYPEID,
                                          productTypeName = context.TBL_PRODUCT_TYPE.Where(x => x.PRODUCTTYPEID == pr.PRODUCTTYPEID).Select(m => m.PRODUCTTYPENAME).FirstOrDefault(),
                                          casaAccountId = ln.CASAACCOUNTID,
                                          casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          branchId = ln.BRANCHID,
                                          lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                            join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                            where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                            select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                          loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                          applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                          relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                          relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                          misCode = ln.MISCODE,
                                          teamMiscode = ln.TEAMMISCODE,
                                          principalAmount = ln.CONTINGENTAMOUNT,
                                          contingentOutstandingPrincipal = op.CONTINGENTOUTSTANDINGPRINCIPAL,
                                          //interestRate = ln.INTERESTRATE,
                                          effectiveDate = ln.EFFECTIVEDATE,
                                          maturityDate = ln.MATURITYDATE,
                                          bookingDate = ln.BOOKINGDATE,
                                          approvalStatusId = op.APPROVALSTATUSID,
                                          approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == atrail.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                          approvedBy = (int)ln.APPROVEDBY,
                                          approverComment = ln.APPROVERCOMMENT,
                                          dateApproved = ln.DATEAPPROVED,
                                          loanStatusId = ln.LOANSTATUSID,
                                          isDisbursed = ln.ISDISBURSED,
                                          disburserComment = ln.DISBURSERCOMMENT,
                                          disburseDate = ln.DISBURSEDATE,
                                          customerGroupId = lp.CUSTOMERGROUPID,
                                          operationId = ln.OPERATIONID,
                                          loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                          subSectorId = ln.SUBSECTORID,
                                          subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                          sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                          dischargeLetter = ln.DISCHARGELETTER,
                                          //suspendInterest = ln.SUSPENDINTEREST,
                                          customerCode = cu.CUSTOMERCODE,
                                          loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                          customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                          currencyId = ln.CURRENCYID,
                                          currency = context.TBL_CURRENCY.Where(x => x.CURRENCYID == ln.CURRENCYID).Select(x => x.CURRENCYNAME).FirstOrDefault(),
                                          branchName = br.BRANCHNAME,
                                          relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                          relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                          productName = pr.PRODUCTNAME,
                                          comment = "",
                                          operationTypeId = op.OPERATIONTYPEID,
                                          operationTypeName = tt.OPERATIONNAME, //context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                          newEffectiveDate = op.EFFECTIVEDATE,
                                          reviewDetails = op.REVIEWDETAILS,
                                          prepayment = op.PREPAYMENT,
                                          newInterateRate = op.INTERATERATE,
                                          newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                          newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                          newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                          newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),

                                          newTenor = op.TENOR,
                                          cASA_AccountId = op.CASA_ACCOUNTID,
                                          cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          overDraftTopup = op.OVERDRAFTTOPUP,
                                          fee_Charges = op.FEE_CHARGES,
                                          scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                          scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                          scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                          scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                          scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                          newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                          newMaturityDate = op.MATURITYDATE,
                                          lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                          //lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(x => x.TBL_LMSR_APPLICATION_DETAIL.Where(a => a.LOANAPPLICATIONID == x.LOANAPPLICATIONID).Select(a => a.LOANID).FirstOrDefault() == ln.CONTINGENTLOANID).Select(x => x.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                          dateTimeCreated = op.DATECREATED,

                                          currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                          productAccountNumber = ch.ACCOUNTCODE,
                                          productAccountName = ch.ACCOUNTNAME,
                                          prepaymentAmount = op.PREPAYMENT,
                                          approvedAmount = ld.APPROVEDAMOUNT,
                                          creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                          fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                          {
                                              chargeFeeId = mp.CHARGEFEEID,
                                              feeAmount = mp.FEEAMOUNT,
                                              description = mp.DESCRIPTION,
                                              casaAccount = mp.CASAACCOUNTID,
                                              loanChargeFeeId = mp.LOANCHARGEFEEID,
                                              chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                              casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                          }).ToList(),
                                      }).Take(50).ToList();

            var thirdpartyLoan = (from ln in context.TBL_LOAN_EXTERNAL
                                  join op in context.TBL_LOAN_REVIEW_OPERATION on ln.EXTERNALLOANID equals op.LOANID
                                  join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                  join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                  join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                  join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                  join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                  join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                  join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                                  where
                                  (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                                  || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                                  || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                                  || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised)
                                  && atrail.OPERATIONID != (int)OperationsEnum.GlobalInterestRateChange
                                  && atrail.OPERATIONID == op.OPERATIONTYPEID
                                  && ids.Contains((int)atrail.TOAPPROVALLEVELID)// == staffApprovalLevelId
                                  && atrail.RESPONSESTAFFID == null && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                  && op.OPERATIONCOMPLETED == false   //&& mp.OPERATIONPERFORMED == true
                                  && op.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.ExternalFacility
                                  && ln.LOAN_BOOKING_REQUESTID == null
                                  && ((cf.CanSeeLocalCurrency && ln.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && ln.CURRENCYID != cf.DefaultCurrencyId))
                                  && (staffId == (int)atrail.TOSTAFFID || atrail.TOSTAFFID == null)// currency filter
                                  && (atrail.LOOPEDSTAFFID == null)
                                  orderby op.DATECREATED descending
                                  select new LoanReviewOperationApprovalViewModel
                                  {
                                      //creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                      //creditAppraisalOperationId = lp.OPERATIONID,
                                      loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                      appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                      lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                           (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                           (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                      lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                           (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                           (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),


                                      currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                      loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                      loanId = ln.EXTERNALLOANID,
                                      loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                      customerId = ln.CUSTOMERID,
                                      productId = ln.PRODUCTID,
                                      prepaymentAmount = op.PREPAYMENT,
                                      productTypeId = pr.PRODUCTTYPEID,
                                      casaAccountId = ln.CASAACCOUNTID,
                                      casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                      casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                      branchId = ln.BRANCHID,
                                      amount = ln.PRINCIPALAMOUNT,
                                      lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                        join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                        where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                        select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                      loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                      applicationReferenceNumber = ln.LOANREFERENCENUMBER,
                                      principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                      pricipalFrequencyTypeName = (from f in context.TBL_FREQUENCY_TYPE where f.FREQUENCYTYPEID == ln.PRINCIPALFREQUENCYTYPEID select f.MODE).FirstOrDefault(),
                                      interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                      interestFrequencyTypeName = (from f in context.TBL_FREQUENCY_TYPE where f.FREQUENCYTYPEID == ln.INTERESTFREQUENCYTYPEID select f.MODE).FirstOrDefault(),
                                      principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                      interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                      relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                      relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                      misCode = ln.MISCODE,
                                      teamMiscode = ln.TEAMMISCODE,
                                      interestRate = ln.INTERESTRATE,
                                      effectiveDate = ln.EFFECTIVEDATE,
                                      maturityDate = ln.MATURITYDATE,
                                      bookingDate = ln.BOOKINGDATE,
                                      principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                      contingentOutstandingPrincipal = 0,
                                      principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                      interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                      approvalStatusId = op.APPROVALSTATUSID,
                                      approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == atrail.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                      approvedBy = (int)ln.APPROVEDBY,
                                      approverComment = ln.APPROVERCOMMENT,
                                      dateApproved = ln.DATEAPPROVED,
                                      loanStatusId = ln.LOANSTATUSID,
                                      scheduleTypeId = ln.SCHEDULETYPEID,
                                      isDisbursed = ln.ISDISBURSED,
                                      disbursedBy = (int)ln.DISBURSEDBY,
                                      disburserComment = ln.DISBURSERCOMMENT,
                                      disburseDate = ln.DISBURSEDATE,
                                      //customerGroupId = ln.CUSTOMERGROUPID,
                                      operationId = ln.OPERATIONID,
                                      //loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                      equityContribution = ln.EQUITYCONTRIBUTION,
                                      subSectorId = ln.SUBSECTORID,
                                      subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                      sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                      firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                      firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                      outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                      principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                      principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                      fixedPrincipal = ln.FIXEDPRINCIPAL,
                                      profileLoan = ln.PROFILELOAN,
                                      dischargeLetter = ln.DISCHARGELETTER,
                                      suspendInterest = ln.SUSPENDINTEREST,
                                      scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                      isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                      scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                      scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                      customerCode = cu.CUSTOMERCODE,
                                      productAccountNumber = ch.ACCOUNTCODE,
                                      productAccountName = ch.ACCOUNTNAME,
                                      //loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                      customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                      currencyId = ln.CURRENCYID,
                                      branchName = br.BRANCHNAME,
                                      relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                      relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                      productName = pr.PRODUCTNAME,
                                      comment = "",
                                      operationTypeId = op.OPERATIONTYPEID,
                                      operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                      newEffectiveDate = op.EFFECTIVEDATE,
                                      reviewDetails = op.REVIEWDETAILS,
                                      prepayment = op.PREPAYMENT,
                                      newInterateRate = op.INTERATERATE,
                                      newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                      newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                      newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                      newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                      newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                      newTenor = op.TENOR,
                                      cASA_AccountId = op.CASA_ACCOUNTID,
                                      cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                      cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                      overDraftTopup = op.OVERDRAFTTOPUP,
                                      fee_Charges = op.FEE_CHARGES,
                                      scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                      scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                      scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                      scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                      scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                      newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                      newMaturityDate = op.MATURITYDATE,
                                      //approvedAmount = ld.APPROVEDAMOUNT,
                                      //creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                      lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                      pastDueInterest = ln.PASTDUEINTEREST,
                                      pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                      interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                      interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                      outstandingInterest = ln.OUTSTANDINGINTEREST,
                                      //accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),

                                      //lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(x => x.TBL_LMSR_APPLICATION_DETAIL.Where(a => a.LOANAPPLICATIONID == x.LOANAPPLICATIONID).Select(a => a.LOANID).FirstOrDefault() == ln.TERMLOANID).Select(x => x.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                      // lmsLoanReferenceNumber = mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                      dateTimeCreated = op.DATECREATED,
                                      fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                      {
                                          chargeFeeId = mp.CHARGEFEEID,
                                          feeAmount = mp.FEEAMOUNT,
                                          description = mp.DESCRIPTION,
                                          casaAccount = mp.CASAACCOUNTID,
                                          loanChargeFeeId = mp.LOANCHARGEFEEID,
                                          chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                          casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                      }).ToList(),
                                  }).Take(50).ToList();

            //foreach (var can in dataContingentLoan)
            //{
            //    var test = can.lmsLoanReferenceNumber;
            //}
            //foreach (var can in dataRevolvingLoan)
            //{
            //    var test = can.lmsLoanReferenceNumber;
            //}
            var termLoanData = dataLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var thirdPartyLoanData = thirdpartyLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var contingentLoanData = dataContingentLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var unionAll = termLoanData.Union(revolvingLoanData);

            var data = unionAll.Union(contingentLoanData).Union(thirdPartyLoanData);

            List<LoanReviewOperationApprovalViewModel> lcyLoans = new List<LoanReviewOperationApprovalViewModel>();
            List<LoanReviewOperationApprovalViewModel> fcyLoans = new List<LoanReviewOperationApprovalViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = data.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
            }

            if (isFCYUser == true)
            {
                fcyLoans = data.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            data = lcyLoans.Union(fcyLoans).ToList();

            return data;
        }


        public IEnumerable<LoanReviewOperationApprovalViewModel> GetLoanOperationByLoanReferenceAwaitingApproval(int staffId, int companyId, string searchString)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);
            var searchValue = searchString.Trim().ToLower();

            searchString = searchString.Trim();
            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONTYPEID == (short)OperationTypeEnum.LoanManagement).Select(c => c.OPERATIONID).ToList();
            List<int> ids = new List<int>();

            foreach (var operationId in operationIds)
            {
                ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }

            var dataLoan = (from ln in context.TBL_LOAN
                            join op in context.TBL_LOAN_REVIEW_OPERATION on ln.TERMLOANID equals op.LOANID
                            join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised)
                            && atrail.OPERATIONID != (int)OperationsEnum.GlobalInterestRateChange
                            && atrail.OPERATIONID == op.OPERATIONTYPEID
                            && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                            && atrail.RESPONSESTAFFID == null && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && (cf.CanSeeLocalCurrency && ln.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && ln.CURRENCYID != cf.DefaultCurrencyId)
                            && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)
                            && (ln.LOANREFERENCENUMBER == searchString
                            || cu.FIRSTNAME.Trim().ToLower() == searchString.ToLower()
                            || cu.LASTNAME.Trim().ToLower() == searchString.ToLower()
                            || cu.MIDDLENAME.Trim().ToLower() == searchString.ToLower()
                            || cu.CUSTOMERCODE.Trim() == searchString)

                            orderby op.DATECREATED descending

                            select new LoanReviewOperationApprovalViewModel
                            {

                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                  join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                  where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                  select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                prepaymentAmount = op.PREPAYMENT,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                operationTypeId = op.OPERATIONTYPEID,
                                operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                newEffectiveDate = op.EFFECTIVEDATE,
                                approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),
                                appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),
                                mgtOperationId = op.OPERATIONTYPEID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = op.APPROVALSTATUSID,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                productAccountNumber = ch.ACCOUNTCODE,
                                productAccountName = ch.ACCOUNTNAME,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                reviewDetails = op.REVIEWDETAILS,
                                prepayment = op.PREPAYMENT,
                                newInterateRate = op.INTERATERATE,
                                newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newTenor = op.TENOR,
                                cASA_AccountId = op.CASA_ACCOUNTID,
                                cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                overDraftTopup = op.OVERDRAFTTOPUP,
                                fee_Charges = op.FEE_CHARGES,
                                scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                newMaturityDate = op.MATURITYDATE,
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                dateTimeCreated = op.DATECREATED,
                                fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                {
                                    chargeFeeId = mp.CHARGEFEEID,
                                    feeAmount = mp.FEEAMOUNT,
                                    description = mp.DESCRIPTION,
                                    casaAccount = mp.CASAACCOUNTID,
                                    loanChargeFeeId = mp.LOANCHARGEFEEID,
                                    chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                    casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),
                                }).ToList(),

                            }).ToList();

            var dataRevolvingLoan = (from ln in context.TBL_LOAN_REVOLVING
                                     join op in context.TBL_LOAN_REVIEW_OPERATION on ln.REVOLVINGLOANID equals op.LOANID
                                     join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                     join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID

                                     where
                                     (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                                     || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                                     || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                                     || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                                     && atrail.OPERATIONID != (int)OperationsEnum.GlobalInterestRateChange
                                     && atrail.OPERATIONID == op.OPERATIONTYPEID
                                     && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                                     && atrail.RESPONSESTAFFID == null && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                     && op.OPERATIONCOMPLETED == false
                                      && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)
                                      && (ln.LOANREFERENCENUMBER == searchString
                                        || cu.FIRSTNAME.Trim().ToLower() == searchString.ToLower()
                                        || cu.LASTNAME.Trim().ToLower() == searchString.ToLower()
                                        || cu.MIDDLENAME.Trim().ToLower() == searchString.ToLower()
                                        || cu.CUSTOMERCODE.Trim() == searchString)

                                     orderby op.DATECREATED descending
                                     select new LoanReviewOperationApprovalViewModel
                                     {

                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                         lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),
                                         mgtOperationId = op.OPERATIONTYPEID,
                                         loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                         appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                         customerId = ln.CUSTOMERID,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         prepaymentAmount = op.PREPAYMENT,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                           join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                           where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                           select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvalStatusId = op.APPROVALSTATUSID,
                                         approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         operationTypeId = op.OPERATIONTYPEID,
                                         operationTypeName = tt.OPERATIONNAME,
                                         newEffectiveDate = op.EFFECTIVEDATE,
                                         reviewDetails = op.REVIEWDETAILS,
                                         prepayment = op.PREPAYMENT,
                                         newInterateRate = op.INTERATERATE,
                                         newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                         newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                         newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                         newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newTenor = op.TENOR,
                                         cASA_AccountId = op.CASA_ACCOUNTID,
                                         cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         overDraftTopup = op.OVERDRAFTTOPUP,
                                         fee_Charges = op.FEE_CHARGES,
                                         scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                         scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                         scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                         scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                         scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                         newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                         newMaturityDate = op.MATURITYDATE,
                                         dateTimeCreated = op.DATECREATED,
                                         lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                         currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                         productAccountNumber = "N/A",
                                         productAccountName = "N/A",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                         fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                         {
                                             chargeFeeId = mp.CHARGEFEEID,
                                             feeAmount = mp.FEEAMOUNT,
                                             description = mp.DESCRIPTION,
                                             casaAccount = mp.CASAACCOUNTID,
                                             loanChargeFeeId = mp.LOANCHARGEFEEID,
                                             chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                             casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                         }).ToList(),

                                     }).ToList();


            var dataContingentLoan = (from ln in context.TBL_LOAN_CONTINGENT
                                      join op in context.TBL_LOAN_REVIEW_OPERATION on ln.CONTINGENTLOANID equals op.LOANID
                                      join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                      join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                      join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                      join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                      join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                      join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                      join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                      join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                      join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                      join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                      join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID

                                      where
                                      (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                                      || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                                      || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                                      || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                                      && atrail.OPERATIONID != (int)OperationsEnum.GlobalInterestRateChange
                                      && atrail.OPERATIONID == op.OPERATIONTYPEID
                                      && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                                      && atrail.RESPONSESTAFFID == null && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                      && op.OPERATIONCOMPLETED == false
                                      && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)
                                      && (ln.LOANREFERENCENUMBER == searchString
                                        || cu.FIRSTNAME.Trim().ToLower() == searchString.ToLower()
                                        || cu.LASTNAME.Trim().ToLower() == searchString.ToLower()
                                        || cu.MIDDLENAME.Trim().ToLower() == searchString.ToLower()
                                        || cu.CUSTOMERCODE.Trim() == searchString)

                                      orderby op.DATECREATED descending
                                      select new LoanReviewOperationApprovalViewModel
                                      {
                                          creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                          creditAppraisalOperationId = lp.OPERATIONID,
                                          lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                          lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                          loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                          appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                          loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                          loanId = ln.CONTINGENTLOANID,
                                          loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                          customerId = ln.CUSTOMERID,
                                          productId = ln.PRODUCTID,
                                          productTypeId = pr.PRODUCTTYPEID,
                                          productTypeName = context.TBL_PRODUCT_TYPE.Where(x => x.PRODUCTTYPEID == pr.PRODUCTTYPEID).Select(m => m.PRODUCTTYPENAME).FirstOrDefault(),
                                          casaAccountId = ln.CASAACCOUNTID,
                                          casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          branchId = ln.BRANCHID,
                                          lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                            join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                            where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                            select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                          loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                          applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                          relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                          relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                          misCode = ln.MISCODE,
                                          teamMiscode = ln.TEAMMISCODE,
                                          principalAmount = ln.CONTINGENTAMOUNT,
                                          effectiveDate = ln.EFFECTIVEDATE,
                                          maturityDate = ln.MATURITYDATE,
                                          bookingDate = ln.BOOKINGDATE,
                                          approvalStatusId = op.APPROVALSTATUSID,
                                          approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                          approvedBy = (int)ln.APPROVEDBY,
                                          approverComment = ln.APPROVERCOMMENT,
                                          dateApproved = ln.DATEAPPROVED,
                                          loanStatusId = ln.LOANSTATUSID,
                                          isDisbursed = ln.ISDISBURSED,
                                          disburserComment = ln.DISBURSERCOMMENT,
                                          disburseDate = ln.DISBURSEDATE,
                                          customerGroupId = lp.CUSTOMERGROUPID,
                                          operationId = ln.OPERATIONID,
                                          loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                          subSectorId = ln.SUBSECTORID,
                                          subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                          sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                          dischargeLetter = ln.DISCHARGELETTER,
                                          customerCode = cu.CUSTOMERCODE,
                                          loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                          customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                          currencyId = ln.CURRENCYID,
                                          currency = context.TBL_CURRENCY.Where(x => x.CURRENCYID == ln.CURRENCYID).Select(x => x.CURRENCYNAME).FirstOrDefault(),
                                          branchName = br.BRANCHNAME,
                                          relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                          relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                          productName = pr.PRODUCTNAME,
                                          comment = "",
                                          operationTypeId = op.OPERATIONTYPEID,
                                          operationTypeName = tt.OPERATIONNAME,
                                          newEffectiveDate = op.EFFECTIVEDATE,
                                          reviewDetails = op.REVIEWDETAILS,
                                          prepayment = op.PREPAYMENT,
                                          newInterateRate = op.INTERATERATE,
                                          newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                          newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                          newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                          newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),

                                          newTenor = op.TENOR,
                                          cASA_AccountId = op.CASA_ACCOUNTID,
                                          cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          overDraftTopup = op.OVERDRAFTTOPUP,
                                          fee_Charges = op.FEE_CHARGES,
                                          scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                          scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                          scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                          scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                          scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                          newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                          newMaturityDate = op.MATURITYDATE,
                                          lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                          dateTimeCreated = op.DATECREATED,
                                          currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                          productAccountNumber = ch.ACCOUNTCODE,
                                          productAccountName = ch.ACCOUNTNAME,
                                          prepaymentAmount = op.PREPAYMENT,
                                          approvedAmount = ld.APPROVEDAMOUNT,
                                          creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                          fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                          {
                                              chargeFeeId = mp.CHARGEFEEID,
                                              feeAmount = mp.FEEAMOUNT,
                                              description = mp.DESCRIPTION,
                                              casaAccount = mp.CASAACCOUNTID,
                                              loanChargeFeeId = mp.LOANCHARGEFEEID,
                                              chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                              casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                          }).ToList(),

                                      }).ToList();

            var thirdpartyLoan = (from ln in context.TBL_LOAN_EXTERNAL
                                  join op in context.TBL_LOAN_REVIEW_OPERATION on ln.EXTERNALLOANID equals op.LOANID
                                  join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                  join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                  join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                  join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                  join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                  join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                  join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                                  where
                                  (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                                  || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                                  || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                                  || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised)
                                  && atrail.OPERATIONID != (int)OperationsEnum.GlobalInterestRateChange
                                  && atrail.OPERATIONID == op.OPERATIONTYPEID
                                  && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                                  && atrail.RESPONSESTAFFID == null && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                  && (cf.CanSeeLocalCurrency && ln.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && ln.CURRENCYID != cf.DefaultCurrencyId)
                                  && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)
                                  && (ln.LOANREFERENCENUMBER == searchString
                                    || cu.FIRSTNAME.Trim().ToLower() == searchString.ToLower()
                                    || cu.LASTNAME.Trim().ToLower() == searchString.ToLower()
                                    || cu.MIDDLENAME.Trim().ToLower() == searchString.ToLower()
                                    || cu.CUSTOMERCODE == searchString)

                                  orderby op.DATECREATED descending

                                  select new LoanReviewOperationApprovalViewModel
                                  {
                                      loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                      appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                      lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                           (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                           (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                      lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                           (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                           (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),


                                      currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                      loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                      loanId = ln.EXTERNALLOANID,
                                      loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                      customerId = ln.CUSTOMERID,
                                      productId = ln.PRODUCTID,
                                      prepaymentAmount = op.PREPAYMENT,
                                      productTypeId = pr.PRODUCTTYPEID,
                                      casaAccountId = ln.CASAACCOUNTID,
                                      casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                      casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                      branchId = ln.BRANCHID,
                                      amount = ln.PRINCIPALAMOUNT,
                                      lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                        join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                        where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                        select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                      loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                      applicationReferenceNumber = ln.LOANREFERENCENUMBER,
                                      principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                      pricipalFrequencyTypeName = (from f in context.TBL_FREQUENCY_TYPE where f.FREQUENCYTYPEID == ln.PRINCIPALFREQUENCYTYPEID select f.MODE).FirstOrDefault(),
                                      interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                      interestFrequencyTypeName = (from f in context.TBL_FREQUENCY_TYPE where f.FREQUENCYTYPEID == ln.INTERESTFREQUENCYTYPEID select f.MODE).FirstOrDefault(),
                                      principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                      interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                      relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                      relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                      misCode = ln.MISCODE,
                                      teamMiscode = ln.TEAMMISCODE,
                                      interestRate = ln.INTERESTRATE,
                                      effectiveDate = ln.EFFECTIVEDATE,
                                      maturityDate = ln.MATURITYDATE,
                                      bookingDate = ln.BOOKINGDATE,
                                      principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                      principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                      interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                      approvalStatusId = op.APPROVALSTATUSID,
                                      approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                      approvedBy = (int)ln.APPROVEDBY,
                                      approverComment = ln.APPROVERCOMMENT,
                                      dateApproved = ln.DATEAPPROVED,
                                      loanStatusId = ln.LOANSTATUSID,
                                      scheduleTypeId = ln.SCHEDULETYPEID,
                                      isDisbursed = ln.ISDISBURSED,
                                      disbursedBy = (int)ln.DISBURSEDBY,
                                      disburserComment = ln.DISBURSERCOMMENT,
                                      disburseDate = ln.DISBURSEDATE,
                                      operationId = ln.OPERATIONID,
                                      equityContribution = ln.EQUITYCONTRIBUTION,
                                      subSectorId = ln.SUBSECTORID,
                                      subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                      sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                      firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                      firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                      outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                      principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                      principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                      fixedPrincipal = ln.FIXEDPRINCIPAL,
                                      profileLoan = ln.PROFILELOAN,
                                      dischargeLetter = ln.DISCHARGELETTER,
                                      suspendInterest = ln.SUSPENDINTEREST,
                                      scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                      isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                      scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                      scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                      customerCode = cu.CUSTOMERCODE,
                                      productAccountNumber = ch.ACCOUNTCODE,
                                      productAccountName = ch.ACCOUNTNAME,
                                      customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                      currencyId = ln.CURRENCYID,
                                      branchName = br.BRANCHNAME,
                                      relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                      relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                      productName = pr.PRODUCTNAME,
                                      comment = "",
                                      operationTypeId = op.OPERATIONTYPEID,
                                      operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                      newEffectiveDate = op.EFFECTIVEDATE,
                                      reviewDetails = op.REVIEWDETAILS,
                                      prepayment = op.PREPAYMENT,
                                      newInterateRate = op.INTERATERATE,
                                      newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                      newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                      newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                      newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                      newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                      newTenor = op.TENOR,
                                      cASA_AccountId = op.CASA_ACCOUNTID,
                                      cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                      cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                      overDraftTopup = op.OVERDRAFTTOPUP,
                                      fee_Charges = op.FEE_CHARGES,
                                      scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                      scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                      scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                      scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                      scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                      newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                      newMaturityDate = op.MATURITYDATE,
                                      lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                      pastDueInterest = ln.PASTDUEINTEREST,
                                      pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                      interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                      interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                      outstandingInterest = ln.OUTSTANDINGINTEREST,
                                      dateTimeCreated = op.DATECREATED,
                                      fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                      {
                                          chargeFeeId = mp.CHARGEFEEID,
                                          feeAmount = mp.FEEAMOUNT,
                                          description = mp.DESCRIPTION,
                                          casaAccount = mp.CASAACCOUNTID,
                                          loanChargeFeeId = mp.LOANCHARGEFEEID,
                                          chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                          casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                      }).ToList(),

                                  }).ToList();


            var termLoanData = dataLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var thirdPartyLoanData = thirdpartyLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var contingentLoanData = dataContingentLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var unionAll = termLoanData.Union(revolvingLoanData);

            var data = unionAll.Union(contingentLoanData).Union(thirdPartyLoanData);

            List<LoanReviewOperationApprovalViewModel> lcyLoans = new List<LoanReviewOperationApprovalViewModel>();
            List<LoanReviewOperationApprovalViewModel> fcyLoans = new List<LoanReviewOperationApprovalViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = data.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
            }

            if (isFCYUser == true)
            {
                fcyLoans = data.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            data = lcyLoans.Union(fcyLoans).ToList();

            return data;
        }


        public IEnumerable<RemoveLienViewModel> GetLienRemovalDocuments(int lienRemovalId)
        {
            return (from x in context.TBL_LIEN_REMOVAL
                    where x.UNFREEZELIENACCOUNTID == lienRemovalId && x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved
                    select new RemoveLienViewModel
                    {
                        unfreezeLienAccountId = x.UNFREEZELIENACCOUNTID,
                        //fileData = x.FILEDATA,
                        fileName = x.FILENAME,
                        dateTimeCreated = x.DATETIMECREATED,
                        fileExtension = x.FILEEXTENSION,
                    }).ToList();
        }
        public IEnumerable<LoanReviewOperationApprovalViewModel> GetLienRemovalAwaitingApproval(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONTYPEID == (short)OperationTypeEnum.LoanReviewApplication).Select(c => c.OPERATIONID).ToList();
            List<int> ids = new List<int>();

            foreach (var operationId in operationIds)
            {
                ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }

            var dataLoan = (from ln in context.TBL_LOAN
                            join ca in context.TBL_CASA_LIEN on ln.LOANREFERENCENUMBER equals ca.SOURCEREFERENCENUMBER into cal
                            from ca in cal.DefaultIfEmpty()
                            join lr in context.TBL_LIEN_REMOVAL on ca.LIENID equals lr.CASALIENACCOUNTID
                            join atrail in context.TBL_APPROVAL_TRAIL on lr.UNFREEZELIENACCOUNTID equals atrail.TARGETID into atraila
                            from atrail in atraila.DefaultIfEmpty()
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                            && atrail.OPERATIONID == lr.OPERATIONID
                            && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                            && (ca.LIENSTATUS == (int)LienStatusEnum.Active || ca.LIENSTATUS == null)
                            && lr.OPERATIONCOMPLETED == false
                            && atrail.RESPONSESTAFFID == null && lr.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)

                            select new LoanReviewOperationApprovalViewModel
                            {
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,

                                sourceReferenceNumber = ca.SOURCEREFERENCENUMBER,
                                lienReferenceNumber = ca.LIENREFERENCENUMBER,
                                lienAmount = ca.LIENAMOUNT,
                                lienDateTimeCreated = ca.DATETIMECREATED,
                                productAccountNumber = ca.PRODUCTACCOUNTNUMBER,
                                casaLienAccountId = ca.LIENID,
                                lienRemovalId = lr.UNFREEZELIENACCOUNTID,
                                lienRemovalOperationId = lr.OPERATIONID,

                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = lr.APPROVALSTATUSID,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                            }).ToList();

            var dataRevolvingLoan = (from ln in context.TBL_LOAN_REVOLVING
                                     join ca in context.TBL_CASA_LIEN on ln.LOANREFERENCENUMBER equals ca.SOURCEREFERENCENUMBER into cal
                                     from ca in cal.DefaultIfEmpty()
                                     join lr in context.TBL_LIEN_REMOVAL on ca.LIENID equals lr.CASALIENACCOUNTID
                                     join atrail in context.TBL_APPROVAL_TRAIL on lr.UNFREEZELIENACCOUNTID equals atrail.TARGETID into atraila
                                     from atrail in atraila.DefaultIfEmpty()
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                                        || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                                        || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                                        || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                                        && atrail.OPERATIONID == lr.OPERATIONID
                                        && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                                        && (ca.LIENSTATUS == (int)LienStatusEnum.Active || ca.LIENSTATUS == null)
                                        && lr.OPERATIONCOMPLETED == false
                                        && atrail.RESPONSESTAFFID == null && lr.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                        && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)

                                     select new LoanReviewOperationApprovalViewModel
                                     {
                                         currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = ln.CUSTOMERID,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,

                                         sourceReferenceNumber = ca.SOURCEREFERENCENUMBER,
                                         lienReferenceNumber = ca.LIENREFERENCENUMBER,
                                         lienAmount = ca.LIENAMOUNT,
                                         lienDateTimeCreated = ca.DATETIMECREATED,
                                         productAccountNumber = ca.PRODUCTACCOUNTNUMBER,
                                         casaLienAccountId = ca.LIENID,
                                         lienRemovalId = lr.UNFREEZELIENACCOUNTID,
                                         lienRemovalOperationId = lr.OPERATIONID,

                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvalStatusId = lr.APPROVALSTATUSID,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         pastDueInterest = ln.PASTDUEINTEREST,
                                         pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                         interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                         interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                     }).ToList();

            var dataContingent = (from ln in context.TBL_LOAN_CONTINGENT
                                  join ca in context.TBL_CASA_LIEN on ln.LOANREFERENCENUMBER equals ca.SOURCEREFERENCENUMBER into cal
                                  from ca in cal.DefaultIfEmpty()
                                  join lr in context.TBL_LIEN_REMOVAL on ca.LIENID equals lr.CASALIENACCOUNTID
                                  join atrail in context.TBL_APPROVAL_TRAIL on lr.UNFREEZELIENACCOUNTID equals atrail.TARGETID into atraila
                                  from atrail in atraila.DefaultIfEmpty()
                                  join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                  join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                  join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                  join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                  join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                  where
                                  (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                                    || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                                    || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                                    || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                                    && atrail.OPERATIONID == lr.OPERATIONID
                                    && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                                    && (ca.LIENSTATUS == (int)LienStatusEnum.Active || ca.LIENSTATUS == null)
                                    && lr.OPERATIONCOMPLETED == false
                                    && atrail.RESPONSESTAFFID == null && lr.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                    && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)

                                  select new LoanReviewOperationApprovalViewModel
                                  {
                                      currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                      loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                      loanId = ln.CONTINGENTLOANID,
                                      customerId = ln.CUSTOMERID,
                                      productId = ln.PRODUCTID,
                                      productTypeId = pr.PRODUCTTYPEID,
                                      casaAccountId = ln.CASAACCOUNTID,
                                      casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                      casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                      branchId = ln.BRANCHID,
                                      loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                      relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                      relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                      misCode = ln.MISCODE,

                                      sourceReferenceNumber = ca.SOURCEREFERENCENUMBER,
                                      lienReferenceNumber = ca.LIENREFERENCENUMBER,
                                      lienAmount = ca.LIENAMOUNT,
                                      lienDateTimeCreated = ca.DATETIMECREATED,
                                      productAccountNumber = ca.PRODUCTACCOUNTNUMBER,
                                      casaLienAccountId = ca.LIENID,
                                      lienRemovalId = lr.UNFREEZELIENACCOUNTID,
                                      lienRemovalOperationId = lr.OPERATIONID,

                                      teamMiscode = ln.TEAMMISCODE,
                                      effectiveDate = ln.EFFECTIVEDATE,
                                      maturityDate = ln.MATURITYDATE,
                                      bookingDate = ln.BOOKINGDATE,
                                      approvalStatusId = lr.APPROVALSTATUSID,
                                      approvedBy = (int)ln.APPROVEDBY,
                                      approverComment = ln.APPROVERCOMMENT,
                                      dateApproved = ln.DATEAPPROVED,
                                      loanStatusId = ln.LOANSTATUSID,
                                      isDisbursed = ln.ISDISBURSED,
                                      disburserComment = ln.DISBURSERCOMMENT,
                                      disburseDate = ln.DISBURSEDATE,
                                      subSectorId = ln.SUBSECTORID,
                                      subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                      sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                      dischargeLetter = ln.DISCHARGELETTER,
                                      customerCode = cu.CUSTOMERCODE,
                                      customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                      currencyId = ln.CURRENCYID,
                                      branchName = br.BRANCHNAME,
                                      relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                      relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                      productName = pr.PRODUCTNAME,
                                      comment = "",
                                  }).ToList();


            var unionAll = dataLoan.Union(dataRevolvingLoan).Union(dataContingent);
            return unionAll;
        }

        public IEnumerable<LoanReviewOperationApprovalViewModel> GetLienSearchData(string searchString)
        {
            searchString = searchString.ToLower().Trim();

            var dataLoan = (from ln in context.TBL_LOAN
                            join ca in context.TBL_CASA_LIEN on ln.LOANREFERENCENUMBER equals ca.SOURCEREFERENCENUMBER into cal
                            from ca in cal.DefaultIfEmpty()
                            join lr in context.TBL_LIEN_REMOVAL on ca.LIENID equals lr.CASALIENACCOUNTID
                            join atrail in context.TBL_APPROVAL_TRAIL on lr.UNFREEZELIENACCOUNTID equals atrail.TARGETID into atraila
                            from atrail in atraila.DefaultIfEmpty()
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            (cu.FIRSTNAME.ToLower().Contains(searchString)
                            || cu.LASTNAME.ToLower().Contains(searchString)
                            || cu.MIDDLENAME.ToLower().Contains(searchString)
                            || ca.SOURCEREFERENCENUMBER == searchString
                            || ca.PRODUCTACCOUNTNUMBER == searchString
                            || st.STAFFCODE == searchString)
                            && (ca.LIENSTATUS == (int)LienStatusEnum.Active || ca.LIENSTATUS == null)

                            select new LoanReviewOperationApprovalViewModel
                            {
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                productAccountNumber = ca.PRODUCTACCOUNTNUMBER,

                                sourceReferenceNumber = ca.SOURCEREFERENCENUMBER,
                                lienReferenceNumber = ca.LIENREFERENCENUMBER,
                                lienAmount = ca.LIENAMOUNT,
                                lienDateTimeCreated = ca.DATETIMECREATED,

                                casaLienAccountId = ca.LIENID,
                                lienRemovalId = lr.UNFREEZELIENACCOUNTID,
                                lienRemovalOperationId = lr.OPERATIONID,

                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = lr.APPROVALSTATUSID,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                            }).ToList();

            var dataRevolvingLoan = (from ln in context.TBL_LOAN_REVOLVING
                                     join ca in context.TBL_CASA_LIEN on ln.LOANREFERENCENUMBER equals ca.SOURCEREFERENCENUMBER into cal
                                     from ca in cal.DefaultIfEmpty()
                                     join lr in context.TBL_LIEN_REMOVAL on ca.LIENID equals lr.CASALIENACCOUNTID
                                     join atrail in context.TBL_APPROVAL_TRAIL on lr.UNFREEZELIENACCOUNTID equals atrail.TARGETID into atraila
                                     from atrail in atraila.DefaultIfEmpty()
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     (cu.FIRSTNAME.ToLower().Contains(searchString)
                            || cu.LASTNAME.ToLower().Contains(searchString)
                            || cu.MIDDLENAME.ToLower().Contains(searchString)
                            || ca.SOURCEREFERENCENUMBER == searchString
                            || ca.PRODUCTACCOUNTNUMBER == searchString
                            || st.STAFFCODE == searchString)
                            && (ca.LIENSTATUS == (int)LienStatusEnum.Active || ca.LIENSTATUS == null)

                                     select new LoanReviewOperationApprovalViewModel
                                     {
                                         currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = ln.CUSTOMERID,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,

                                         sourceReferenceNumber = ca.SOURCEREFERENCENUMBER,
                                         lienReferenceNumber = ca.LIENREFERENCENUMBER,
                                         lienAmount = ca.LIENAMOUNT,
                                         lienDateTimeCreated = ca.DATETIMECREATED,
                                         productAccountNumber = ca.PRODUCTACCOUNTNUMBER,
                                         casaLienAccountId = ca.LIENID,
                                         lienRemovalId = lr.UNFREEZELIENACCOUNTID,
                                         lienRemovalOperationId = lr.OPERATIONID,

                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvalStatusId = lr.APPROVALSTATUSID,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         pastDueInterest = ln.PASTDUEINTEREST,
                                         pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                         interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                         interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                     }).ToList();

            var dataContingent = (from ln in context.TBL_LOAN_CONTINGENT
                                  join ca in context.TBL_CASA_LIEN on ln.LOANREFERENCENUMBER equals ca.SOURCEREFERENCENUMBER into cal
                                  from ca in cal.DefaultIfEmpty()
                                  join lr in context.TBL_LIEN_REMOVAL on ca.LIENID equals lr.CASALIENACCOUNTID
                                  join atrail in context.TBL_APPROVAL_TRAIL on lr.UNFREEZELIENACCOUNTID equals atrail.TARGETID into atraila
                                  from atrail in atraila.DefaultIfEmpty()
                                  join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                  join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                  join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                  join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                  join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                  where
                                  (cu.FIRSTNAME.ToLower().Contains(searchString)
                            || cu.LASTNAME.ToLower().Contains(searchString)
                            || cu.MIDDLENAME.ToLower().Contains(searchString)
                            || ca.SOURCEREFERENCENUMBER == searchString
                            || ca.PRODUCTACCOUNTNUMBER == searchString
                            || st.STAFFCODE == searchString)
                            && (ca.LIENSTATUS == (int)LienStatusEnum.Active || ca.LIENSTATUS == null)

                                  select new LoanReviewOperationApprovalViewModel
                                  {
                                      currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                      loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                      loanId = ln.CONTINGENTLOANID,
                                      customerId = ln.CUSTOMERID,
                                      productId = ln.PRODUCTID,
                                      productTypeId = pr.PRODUCTTYPEID,
                                      casaAccountId = ln.CASAACCOUNTID,
                                      casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                      casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                      branchId = ln.BRANCHID,
                                      loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                      relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                      relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                      misCode = ln.MISCODE,

                                      sourceReferenceNumber = ca.SOURCEREFERENCENUMBER,
                                      lienReferenceNumber = ca.LIENREFERENCENUMBER,
                                      lienAmount = ca.LIENAMOUNT,
                                      lienDateTimeCreated = ca.DATETIMECREATED,
                                      productAccountNumber = ca.PRODUCTACCOUNTNUMBER,
                                      casaLienAccountId = ca.LIENID,
                                      lienRemovalId = lr.UNFREEZELIENACCOUNTID,
                                      lienRemovalOperationId = lr.OPERATIONID,

                                      teamMiscode = ln.TEAMMISCODE,
                                      effectiveDate = ln.EFFECTIVEDATE,
                                      maturityDate = ln.MATURITYDATE,
                                      bookingDate = ln.BOOKINGDATE,
                                      approvalStatusId = lr.APPROVALSTATUSID,
                                      approvedBy = (int)ln.APPROVEDBY,
                                      approverComment = ln.APPROVERCOMMENT,
                                      dateApproved = ln.DATEAPPROVED,
                                      loanStatusId = ln.LOANSTATUSID,
                                      isDisbursed = ln.ISDISBURSED,
                                      disburserComment = ln.DISBURSERCOMMENT,
                                      disburseDate = ln.DISBURSEDATE,
                                      subSectorId = ln.SUBSECTORID,
                                      subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                      sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                      dischargeLetter = ln.DISCHARGELETTER,
                                      customerCode = cu.CUSTOMERCODE,
                                      customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                      currencyId = ln.CURRENCYID,
                                      branchName = br.BRANCHNAME,
                                      relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                      relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                      productName = pr.PRODUCTNAME,
                                      comment = "",
                                  }).ToList();


            var unionAll = dataLoan.Union(dataRevolvingLoan).Union(dataContingent);
            return unionAll;
        }

        public IEnumerable<LoanReviewOperationApprovalViewModel> GetBulkRecoveryToAgentAwaitingApproval(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONID == (short)OperationsEnum.AssignRecoveryLoansToAgent).Select(c => c.OPERATIONID).ToList();
            List<int> ids = new List<int>();

            foreach (var operationId in operationIds)
            {
                ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }

            var dataLoan = (from ln in context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                            join atrail in context.TBL_APPROVAL_TRAIL on ln.BULKRECOVERYAPPROVALID equals atrail.TARGETID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                            && atrail.OPERATIONID == ln.OPERATIONID
                            && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                            && atrail.RESPONSESTAFFID == null && ln.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)

                            select new LoanReviewOperationApprovalViewModel
                            {
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                referenceId = ln.REFERENCEBATCHID,
                                accreditedConsultant = ln.ACCREDITEDCONSULTANTID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == ln.REFERENCEBATCHID).Count(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID).FirstOrDefault().NAME,
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID).FirstOrDefault().FIRMNAME,
                                approvalStatusId = (int)ln.APPROVALSTATUSID,
                                approverComment = atrail.COMMENT,
                                requestDate = ln.REQUESTDATE,
                                bulkRecoveryApprovalId = ln.BULKRECOVERYAPPROVALID,
                                operationId = ln.OPERATIONID,
                                source = ln.SOURCE,
                                assignmentType = ln.ASSIGNMENTTYPE
                            }).ToList();

            return dataLoan;
        }

        public IEnumerable<LoanReviewOperationApprovalViewModel> GetBulkRetailRecoveryToAgentAwaitingApproval(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONID == (short)OperationsEnum.RetailRecoveryAssignmentApproval).Select(c => c.OPERATIONID).ToList();
            List<int> ids = new List<int>();

            foreach (var operationId in operationIds)
            {
                ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }

            var dataLoan = (from ln in context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                            join atrail in context.TBL_APPROVAL_TRAIL on ln.BULKRECOVERYAPPROVALID equals atrail.TARGETID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                            && atrail.OPERATIONID == ln.OPERATIONID
                            && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                            && atrail.RESPONSESTAFFID == null && ln.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)

                            select new LoanReviewOperationApprovalViewModel
                            {
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                referenceId = ln.REFERENCEBATCHID,
                                accreditedConsultant = ln.ACCREDITEDCONSULTANTID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == ln.REFERENCEBATCHID).Count(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID).FirstOrDefault().NAME,
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID).FirstOrDefault().FIRMNAME,
                                approvalStatusId = (int)ln.APPROVALSTATUSID,
                                approverComment = atrail.COMMENT,
                                requestDate = ln.REQUESTDATE,
                                bulkRecoveryApprovalId = ln.BULKRECOVERYAPPROVALID,
                                operationId = ln.OPERATIONID,
                                source = ln.SOURCE,
                                assignmentType = ln.ASSIGNMENTTYPE
                            }).ToList();

            return dataLoan;
        }

        public IEnumerable<LoanReviewOperationApprovalViewModel> GetBulkUnassignmentRecoveryFromAgentAwaitingApproval(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONID == (short)OperationsEnum.UnAssignRecoveryLoansFromAgent).Select(c => c.OPERATIONID).ToList();
            List<int> ids = new List<int>();

            foreach (var operationId in operationIds)
            {
                ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }

            var dataLoan = (from ln in context.TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL
                            join atrail in context.TBL_APPROVAL_TRAIL on ln.BULKRECOVERYUNASSIGNAPPROVALID equals atrail.TARGETID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending)
                            && atrail.OPERATIONID == ln.OPERATIONID
                            && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                            && atrail.RESPONSESTAFFID == null && ln.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)

                            select new LoanReviewOperationApprovalViewModel
                            {
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                referenceId = ln.REFERENCEBATCHID,
                                accreditedConsultant = ln.ACCREDITEDCONSULTANTID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == ln.REFERENCEBATCHID).Count(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID).FirstOrDefault().NAME,
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID).FirstOrDefault().FIRMNAME,
                                approvalStatusId = (int)ln.APPROVALSTATUSID,
                                approverComment = atrail.COMMENT,
                                requestDate = ln.REQUESTDATE,
                                bulkRecoveryApprovalId = ln.BULKRECOVERYUNASSIGNAPPROVALID,
                                operationId = ln.OPERATIONID,
                                source = ln.SOURCE,
                                loanId = (int)ln.LOANID
                            }).ToList();

            return dataLoan;
        }

        public IEnumerable<LoanReviewOperationApprovalViewModel> GetBulkUnassignmentRetailRecoveryFromAgentAwaitingApproval(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONID == (short)OperationsEnum.UnAssignRetailRecoveryLoansFromAgent).Select(c => c.OPERATIONID).ToList();
            List<int> ids = new List<int>();

            foreach (var operationId in operationIds)
            {
                ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }

            var dataLoan = (from ln in context.TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL
                            join atrail in context.TBL_APPROVAL_TRAIL on ln.BULKRECOVERYUNASSIGNAPPROVALID equals atrail.TARGETID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending)
                            && atrail.OPERATIONID == ln.OPERATIONID
                            && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                            && atrail.RESPONSESTAFFID == null && ln.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)

                            select new LoanReviewOperationApprovalViewModel
                            {
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                referenceId = ln.REFERENCEBATCHID,
                                accreditedConsultant = ln.ACCREDITEDCONSULTANTID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == ln.REFERENCEBATCHID).Count(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID).FirstOrDefault().NAME,
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID).FirstOrDefault().FIRMNAME,
                                approvalStatusId = (int)ln.APPROVALSTATUSID,
                                approverComment = atrail.COMMENT,
                                requestDate = ln.REQUESTDATE,
                                bulkRecoveryApprovalId = ln.BULKRECOVERYUNASSIGNAPPROVALID,
                                operationId = ln.OPERATIONID,
                                source = ln.SOURCE,
                                loanId = (int)ln.LOANID
                            }).ToList();

            return dataLoan;
        }

        public IEnumerable<LoanReviewOperationApprovalViewModel> GetBulkRecoveryToAgentAwaitingApprovalList(string source, int staffId, int companyId)
        {
            var dataLoan = (from ln in context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                            join atrail in context.TBL_APPROVAL_TRAIL on ln.BULKRECOVERYAPPROVALID equals atrail.TARGETID
                            where
                            atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            && atrail.OPERATIONID == ln.OPERATIONID
                            && ln.SOURCE.ToLower() == source.ToLower()

                            select new LoanReviewOperationApprovalViewModel
                            {
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                referenceId = ln.REFERENCEBATCHID,
                                accreditedConsultant = ln.ACCREDITEDCONSULTANTID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == ln.REFERENCEBATCHID && x.DELETED == false && x.ACCREDITEDCONSULTANT == ln.ACCREDITEDCONSULTANTID && (x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing || x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending)).Count(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID && x.DELETED == false).FirstOrDefault().NAME,
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID && x.DELETED == false).FirstOrDefault().FIRMNAME,
                                category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID && x.DELETED == false).FirstOrDefault().CATEGORY.ToUpper(),
                                approvalStatusId = (int)ln.APPROVALSTATUSID,
                                approverComment = atrail.COMMENT,
                                requestDate = ln.REQUESTDATE,
                                bulkRecoveryApprovalId = ln.BULKRECOVERYAPPROVALID,
                                operationId = ln.OPERATIONID,
                                source = ln.SOURCE,
                                assignmentType = ln.ASSIGNMENTTYPE
                            }).ToList();
            var LoanData = dataLoan.GroupBy(x => x.bulkRecoveryApprovalId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.bulkRecoveryApprovalId);

            return LoanData;
        }

        public IEnumerable<LoanReviewOperationApprovalViewModel> BulkRecoveryToAgentAwaitingApprovalList(string source, int staffId, int companyId)
        {
            var dataLoan = (from ln in context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                            where
                            ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                            && ln.SOURCE.ToLower() == source.ToLower()

                            select new LoanReviewOperationApprovalViewModel
                            {
                                referenceId = ln.REFERENCEBATCHID,
                                accreditedConsultant = ln.ACCREDITEDCONSULTANTID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == ln.REFERENCEBATCHID && x.ACCREDITEDCONSULTANT == ln.ACCREDITEDCONSULTANTID && x.DELETED == false && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending).Count(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID && x.DELETED == false).FirstOrDefault().NAME,
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == ln.ACCREDITEDCONSULTANTID && x.DELETED == false).FirstOrDefault().FIRMNAME,
                                approvalStatusId = (int)ln.APPROVALSTATUSID,
                                requestDate = ln.REQUESTDATE,
                                bulkRecoveryApprovalId = ln.BULKRECOVERYAPPROVALID,
                                operationId = ln.OPERATIONID,
                                source = ln.SOURCE,
                                assignmentType = ln.ASSIGNMENTTYPE
                            }).ToList();
            var LoanData = dataLoan.GroupBy(x => x.bulkRecoveryApprovalId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.bulkRecoveryApprovalId);

            return LoanData;
        }

        public IEnumerable<LoanReviewOperationApprovalViewModel> GetApprovedLoanOperationReview()
        {

            var dataLoan = (from ln in context.TBL_LOAN
                            join op in context.TBL_LOAN_REVIEW_OPERATION on ln.TERMLOANID equals op.LOANID
                            where op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && op.OPERATIONCOMPLETED == false
                            orderby op.DATECREATED descending
                            select new LoanReviewOperationApprovalViewModel
                            {
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.DESCRIPTION,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.DESCRIPTION,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = op.APPROVALSTATUSID,
                                approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = ln.TBL_CUSTOMER.CUSTOMERCODE,
                                productAccountNumber = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTCODE,
                                productAccountName = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTNAME,
                                loanTypeName = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                customerName = ln.TBL_CUSTOMER.LASTNAME + " " + ln.TBL_CUSTOMER.FIRSTNAME + " " + ln.TBL_CUSTOMER.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = ln.TBL_BRANCH.BRANCHNAME,
                                relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                                relationshipManagerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                                productName = ln.TBL_PRODUCT.PRODUCTNAME,
                                comment = "",
                                loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                operationTypeId = op.OPERATIONTYPEID,
                                operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                newEffectiveDate = op.EFFECTIVEDATE,
                                reviewDetails = op.REVIEWDETAILS,
                                prepayment = op.PREPAYMENT,
                                newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                newTenor = op.TENOR,
                                cASA_AccountId = op.CASA_ACCOUNTID,
                                overDraftTopup = op.OVERDRAFTTOPUP,
                                fee_Charges = op.FEE_CHARGES,
                                dateTimeCreated = op.DATECREATED,
                                //timeIn = 
                            }).ToList().OrderByDescending(x => x.dateTimeCreated);


            var dataRevolving = (from ln in context.TBL_LOAN_REVOLVING
                                 join op in context.TBL_LOAN_REVIEW_OPERATION on ln.REVOLVINGLOANID equals op.LOANID
                                 where op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && op.OPERATIONCOMPLETED == false
                                 orderby op.DATECREATED descending
                                 select new LoanReviewOperationApprovalViewModel
                                 {
                                     loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                     loanId = ln.REVOLVINGLOANID,
                                     customerId = ln.CUSTOMERID,
                                     productId = ln.PRODUCTID,
                                     casaAccountId = ln.CASAACCOUNTID,
                                     casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                     branchId = ln.BRANCHID,
                                     loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                     relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                     relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                     misCode = ln.MISCODE,
                                     teamMiscode = ln.TEAMMISCODE,
                                     interestRate = ln.INTERESTRATE,
                                     effectiveDate = ln.EFFECTIVEDATE,
                                     maturityDate = ln.MATURITYDATE,
                                     bookingDate = ln.BOOKINGDATE,
                                     approvalStatusId = op.APPROVALSTATUSID,
                                     approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                     approvedBy = (int)ln.APPROVEDBY,
                                     approverComment = ln.APPROVERCOMMENT,
                                     dateApproved = ln.DATEAPPROVED,
                                     isDisbursed = ln.ISDISBURSED,
                                     disburserComment = ln.DISBURSERCOMMENT,
                                     disburseDate = ln.DISBURSEDATE,
                                     customerGroupId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                     operationId = ln.OPERATIONID,
                                     loanTypeId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                     subSectorId = ln.SUBSECTORID,
                                     subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                     sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                     dischargeLetter = ln.DISCHARGELETTER,
                                     suspendInterest = ln.SUSPENDINTEREST,
                                     customerCode = ln.TBL_CUSTOMER.CUSTOMERCODE,
                                     productAccountNumber = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTCODE,
                                     productAccountName = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTNAME,
                                     loanTypeName = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                     customerName = ln.TBL_CUSTOMER.LASTNAME + " " + ln.TBL_CUSTOMER.FIRSTNAME + " " + ln.TBL_CUSTOMER.MIDDLENAME,
                                     currencyId = ln.CURRENCYID,
                                     branchName = ln.TBL_BRANCH.BRANCHNAME,
                                     relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                                     relationshipManagerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                                     productName = ln.TBL_PRODUCT.PRODUCTNAME,
                                     comment = "",
                                     loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                     operationTypeId = op.OPERATIONTYPEID,
                                     operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                     newEffectiveDate = op.EFFECTIVEDATE,
                                     reviewDetails = op.REVIEWDETAILS,
                                     prepayment = op.PREPAYMENT,
                                     newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                     newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                     newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                     newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                     newTenor = op.TENOR,

                                     cASA_AccountId = op.CASA_ACCOUNTID,
                                     overDraftTopup = op.OVERDRAFTTOPUP,
                                     fee_Charges = op.FEE_CHARGES,
                                     dateTimeCreated = op.DATECREATED
                                 }).ToList().OrderByDescending(x => x.dateTimeCreated);
            var data = dataLoan.Union(dataRevolving);
            return data;
        }

        public IEnumerable<ApprovalTrailDetailsViewModel> GetApprovalDetails(int loanId, int OperationId)
        {

            var data = (from det in context.TBL_APPROVAL_TRAIL
                        where det.TARGETID == loanId && det.OPERATIONID == OperationId
                        select new ApprovalTrailDetailsViewModel
                        {
                            comment = det.COMMENT,
                            approvalStatusName = det.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                            staffName = det.TBL_STAFF.FIRSTNAME + " " + det.TBL_STAFF.FIRSTNAME,
                            targetName = context.TBL_LOAN.FirstOrDefault(l => l.TERMLOANID == det.TARGETID).LOANREFERENCENUMBER,
                            operationName = det.TBL_OPERATIONS.OPERATIONNAME,
                            approvalLevelName = det.TBL_APPROVAL_LEVEL.LEVELNAME
                        }).ToList();
            return data;
        }
        public string GetCollateralLoanNewRefernceNumber(ApprovalViewModel model)
        {
            string refNo = "";
            var reviewRecord = (from s in context.TBL_LOAN_REVIEW_OPERATION
                                where s.LOANREVIEWOPERATIONID == model.targetId && s.OPERATIONTYPEID == model.operationId
                                select s).FirstOrDefault();

            var oldRec = context.TBL_LOAN_CONTINGENT.Where(x => x.CONTINGENTLOANID == reviewRecord.LOANID).Select(m => m.LOANREFERENCENUMBER).FirstOrDefault();


            refNo = context.TBL_LOAN_CONTINGENT.Where(x => x.RELATED_LOAN_REFERENCE_NUMBER == oldRec && x.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook).Select(m => m.LOANREFERENCENUMBER).FirstOrDefault();
            if (!string.IsNullOrEmpty(refNo))
            {
                return refNo;
            }
            else
            {
                return refNo;
            }

        }

        public WorkflowResponse GoForApproval(ApprovalViewModel entity)
        {

            entity.applicationDate = generalSetup.GetApplicationDate();

            var twoFADetails = new TwoFactorAutheticationViewModel
            {
                skipAuthentication = true,
                passcode = entity.passCode,
                username = entity.userName
            };

            if (context.TBL_SETUP_GLOBAL.FirstOrDefault().USERSPECIFIC2FA == true)
            {
                twoFADetails.username = context.TBL_STAFF.Find(entity.staffId).STAFFCODE;
            }

            using (var trans = context.Database.BeginTransaction())
            {
                var reviewRecord = (from s in context.TBL_LOAN_REVIEW_OPERATION
                                    where s.LOANREVIEWOPERATIONID == entity.targetId && s.OPERATIONTYPEID == entity.operationId
                                   && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                    && s.OPERATIONCOMPLETED == false
                                    select s).FirstOrDefault();

                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Referred)
                {

                    int staffId = entity.staffId;


                    var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();

                    var levels = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == entity.operationId)
                         .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
                         .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true),
                             mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new
                             {
                                 groupPosition = mg.m.POSITION,
                                 levelPosition = l.POSITION,
                                 levelId = l.APPROVALLEVELID,
                                 levelName = l.LEVELNAME,
                                 staffRoleId = l.STAFFROLEID,
                             })
                             .OrderBy(x => x.groupPosition)
                             .ThenBy(x => x.levelPosition)
                             .ToList();

                    var staffRoleLevels = levels.Where(x => x.staffRoleId == staff.STAFFROLEID);
                    var staffRoleLevelIds = staffRoleLevels.Select(x => x.levelId);
                    var staffRoleLevelId = staffRoleLevelIds.FirstOrDefault();

                    workFlow.StaffId = entity.createdBy;
                    workFlow.OperationId = entity.operationId;
                    workFlow.TargetId = entity.targetId;
                    workFlow.CompanyId = entity.companyId;
                    workFlow.ProductClassId = null;
                    workFlow.ProductId = null;
                    workFlow.NextLevelId = entity.approvalLevelId;
                    workFlow.ToStaffId = staffId;
                    workFlow.StatusId = (int)ApprovalStatusEnum.Referred;
                    workFlow.Comment = entity.comment;
                    workFlow.DeferredExecution = true;

                    // workFlow.LogActivity();

                    var lmsrRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == reviewRecord.LOANREVIEWAPPLICATIONID).FirstOrDefault();
                    if (lmsrRecord != null)
                    {
                        lmsrRecord.OPERATIONPERFORMED = false;
                    }

                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Referred;
                    reviewRecord.OPERATIONCOMPLETED = false;
                    context.SaveChanges();
                    trans.Commit();
                    //return 4;
                }

                workFlow.StaffId = entity.staffId;
                workFlow.CompanyId = entity.companyId;
                workFlow.StatusId = ((short)entity.approvalStatusId == (short)ApprovalStatusEnum.Approved) ? (short)ApprovalStatusEnum.Processing : (short)entity.approvalStatusId;
                workFlow.TargetId = entity.targetId;
                workFlow.Comment = entity.comment;
                workFlow.OperationId = entity.operationId;
                workFlow.DeferredExecution = true;
                workFlow.LogActivity();


                bool output = false;
                bool result = false;
                int data = 0;

                var dynamicMessage = string.Empty;
                var staffEmail = context.TBL_STAFF.Find(reviewRecord.CREATEDBY);
                var lmsApplicationDetail = context.TBL_LMSR_APPLICATION_DETAIL.Find(reviewRecord.LOANREVIEWAPPLICATIONID);
                var lmsApplication = context.TBL_LMSR_APPLICATION.Find(lmsApplicationDetail.LOANAPPLICATIONID);
                var customer = context.TBL_CUSTOMER.Find(lmsApplicationDetail.CUSTOMERID);

                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                {

                    alert.receiverEmailList.Add(staffEmail.EMAIL);
                    if (entity.operationId == (int)OperationsEnum.OverdraftInterestRate)
                    {
                        dynamicMessage = "Overdraft Interest Rate Change with review details request: " + lmsApplicationDetail.REVIEWDETAILS + " with Application reference number: " + lmsApplication.APPLICATIONREFERENCENUMBER + " concerning customer: (" + customer.CUSTOMERCODE + " " + customer.FIRSTNAME + " " + customer.LASTNAME + " " + customer.MIDDLENAME + " ) has been Disapproved";
                        LogEmailAlert(dynamicMessage, "OVERDRAFT INTEREST RATE CHANGE NOTIFICATION", alert.receiverEmailList, "10020", 10020, "OverdraftInterestRate");
                    }
                    if (entity.operationId == (int)OperationsEnum.ContractualInterestRateChange)
                    {
                        dynamicMessage = "Contractual Interest Rate Change with review details request: " + lmsApplicationDetail.REVIEWDETAILS + " with Application reference number: " + lmsApplication.APPLICATIONREFERENCENUMBER + " concerning customer: (" + customer.CUSTOMERCODE + " " + customer.FIRSTNAME + " " + customer.LASTNAME + " " + customer.MIDDLENAME + " ) has been Disapproved";
                        LogEmailAlert(dynamicMessage, "CONTRACTUAL INTEREST RATE CHANGE NOTIFICATION", alert.receiverEmailList, "10025", 10025, "ContractualInterestRateChange");
                    }

                    //VALIDATE TWOFACTOR AUTHENTICATION FOR EVERY TRANSACTION AND SKIP FOR SUBSEQUENT CHECKS
                    if (twoFADetails != null && admin.TwoFactorAuthenticationEnabled())
                    {
                        var authenticated = twoFactoeAuth.Authenticate(twoFADetails.username, twoFADetails.passcode);

                        if (authenticated.authenticated == false)
                            throw new TwoFactorAuthenticationException(authenticated.message);
                    }
                    twoFADetails.skipAuthentication = true;
                    var fees = context.TBL_LOAN_FEE.Where(a => a.LOANREVIEWOPERATIONID == reviewRecord.LOANREVIEWOPERATIONID && a.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending).ToList();

                    foreach (var a in fees)
                    {
                        a.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                    }
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                    reviewRecord.OPERATIONCOMPLETED = true;
                    context.SaveChanges();
                    trans.Commit();
                    //return 2;
                }

                if (workFlow.NewState != (int)ApprovalState.Ended)
                {
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    output = context.SaveChanges() > 0;
                    trans.Commit();
                    data = 3;
                }
                else if (workFlow.NewState == (int)ApprovalState.Ended)
                {
                    //VALIDATE TWOFACTOR AUTHENTICATION FOR EVERY TRANSACTION AND SKIP FOR SUBSEQUENT CHECKS
                    if (twoFADetails != null && admin.TwoFactorAuthenticationEnabled())
                    {
                        var authenticated = twoFactoeAuth.Authenticate(twoFADetails.username, twoFADetails.passcode);

                        if (authenticated.authenticated == false)
                            throw new TwoFactorAuthenticationException(authenticated.message);

                        twoFADetails.skipAuthentication = true;
                    }


                    var validate = context.TBL_LOAN_FEE.Where(a => a.LOANREVIEWOPERATIONID == reviewRecord.LOANREVIEWOPERATIONID && a.APPROVALSTATUSID == 0).ToList();

                    foreach (var item in validate)
                    {
                        var feePostings = BuildLoanOperationsManualChargeFeesPosting(item.LOANCHARGEFEEID);

                        if (feePostings != null && feePostings.Count() > 0)
                        {
                            //financeTransaction.PostTransaction(feePostings, false, twoFADetails);
                            //financeTransaction.PostTransaction(disbursementTransactions, false, twoFADetails);
                        }
                        item.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                    }

                    //if (validate.Count > 0)
                    //{
                    //    throw new ConditionNotMetException("Kindly Proceed to Approve Pending Fees Attached to This Operation Before Proceeding");
                    //}
                    result = LoanRephasementProcess(twoFADetails, reviewRecord.LOANREVIEWOPERATIONID, reviewRecord.LOANID, entity.staffId, (LoanSystemTypeEnum)reviewRecord.LOANSYSTEMTYPEID);
                    if (result == true)
                    {
                        alert.receiverEmailList.Add(staffEmail.EMAIL);
                        if (entity.operationId == (int)OperationsEnum.OverdraftInterestRate)
                        {
                            dynamicMessage = "Overdraft Interest Rate Change with review details request: " + lmsApplicationDetail.REVIEWDETAILS + " with Application reference number: " + lmsApplication.APPLICATIONREFERENCENUMBER + " concerning customer: (" + customer.CUSTOMERCODE + " " + customer.FIRSTNAME + " " + customer.LASTNAME + " " + customer.MIDDLENAME + " ) has been Approved";
                            LogEmailAlert(dynamicMessage, "OVERDRAFT INTEREST RATE CHANGE NOTIFICATION", alert.receiverEmailList, "10020", 10020, "OverdraftInterestRate");
                        }
                        if (entity.operationId == (int)OperationsEnum.ContractualInterestRateChange)
                        {
                            dynamicMessage = "Contractual Interest Rate Change with review details request: " + lmsApplicationDetail.REVIEWDETAILS + " with Application reference number: " + lmsApplication.APPLICATIONREFERENCENUMBER + " concerning customer: (" + customer.CUSTOMERCODE + " " + customer.FIRSTNAME + " " + customer.LASTNAME + " " + customer.MIDDLENAME + " ) has been Approved";
                            LogEmailAlert(dynamicMessage, "CONTRACTUAL INTEREST RATE CHANGE NOTIFICATION", alert.receiverEmailList, "10025", 10025, "ContractualInterestRateChange");
                        }
                        if (entity.operationId == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook)
                        {
                            reviewRecord.REBOOKDATE = DateTime.Now;
                        }
                        reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                        reviewRecord.OPERATIONCOMPLETED = true;
                        output = context.SaveChanges() > 0;
                        if (entity.operationId == (int)OperationsEnum.OverdraftTenorExtension || entity.operationId == (int)OperationsEnum.TenorChange || entity.operationId == (int)OperationsEnum.ContingentLiabilityTenorExtension)
                        {
                            var staff = context.TBL_STAFF.Find(reviewRecord.CREATEDBY);
                            var retailEmail = context.TBL_ALERT_TITLE.Where(a => a.BINDINGMETHOD == "ExtensionReport").FirstOrDefault();
                            var loanDetail = context.TBL_LMSR_APPLICATION_DETAIL.Where(p => p.LOANREVIEWAPPLICATIONID == reviewRecord.LOANREVIEWAPPLICATIONID).FirstOrDefault();
                            var facility = context.TBL_PRODUCT.Find(loanDetail.PRODUCTID);
                            var emailList = GetBusinessUsersEmailsToGroupHead(staff.MISCODE) + ";" + retailEmail?.DEFAULTEMAIL;
                            alert.receiverEmailList.Add(emailList);

                            var customer12 = context.TBL_CUSTOMER.Where(c => c.CUSTOMERID == lmsApplicationDetail.CUSTOMERID).Select(c => c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME).FirstOrDefault() == null ? context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == lmsApplicationDetail.CUSTOMERID).Select(c => c.GROUPNAME).FirstOrDefault() : context.TBL_CUSTOMER.Where(c => c.CUSTOMERID == lmsApplicationDetail.CUSTOMERID).Select(c => c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME).FirstOrDefault();
                            var alertTemplate = retailEmail?.TEMPLATE;
                            alertTemplate = alertTemplate.Replace("@{{customerName}}", customer12);
                            alertTemplate = alertTemplate.Replace("@{{facility}}", facility.PRODUCTNAME);
                            alertTemplate = alertTemplate.Replace("@{{days}}", loanDetail.APPROVEDTENOR.ToString());
                            LogEmailAlert(alertTemplate, retailEmail?.TITLE, alert.receiverEmailList, "10070", 10070, "ExtensionReport");
                        }
                    }
                    if (output == true && result == true)
                    {
                        trans.Commit();
                        data = 1;
                    }

                }
                return workFlow.Response;

            }
            // return data;
        }


        public int GoForLienRemovalApproval(ApprovalViewModel entity)
        {

            entity.applicationDate = generalSetup.GetApplicationDate();
            using (var trans = context.Database.BeginTransaction())
            {
                var reviewRecord = (from s in context.TBL_LIEN_REMOVAL
                                    where s.UNFREEZELIENACCOUNTID == entity.targetId && s.OPERATIONID == entity.operationId
                                    && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                    && s.OPERATIONCOMPLETED == false
                                    select s).FirstOrDefault();

                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Referred)
                {

                    int staffId = entity.staffId;


                    var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();

                    var levels = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == entity.operationId)
                         .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
                         .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true),
                             mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new
                             {
                                 groupPosition = mg.m.POSITION,
                                 levelPosition = l.POSITION,
                                 levelId = l.APPROVALLEVELID,
                                 levelName = l.LEVELNAME,
                                 staffRoleId = l.STAFFROLEID,
                             })
                             .OrderBy(x => x.groupPosition)
                             .ThenBy(x => x.levelPosition)
                             .ToList();

                    var staffRoleLevels = levels.Where(x => x.staffRoleId == staff.STAFFROLEID);
                    var staffRoleLevelIds = staffRoleLevels.Select(x => x.levelId);
                    var staffRoleLevelId = staffRoleLevelIds.FirstOrDefault();

                    workFlow.StaffId = entity.createdBy;
                    workFlow.OperationId = entity.operationId;
                    workFlow.TargetId = entity.targetId;
                    workFlow.CompanyId = entity.companyId;
                    workFlow.ProductClassId = null;
                    workFlow.ProductId = null;
                    workFlow.NextLevelId = entity.approvalLevelId;
                    workFlow.ToStaffId = staffId;
                    workFlow.StatusId = (int)ApprovalStatusEnum.Referred;
                    workFlow.Comment = entity.comment;
                    workFlow.DeferredExecution = true;

                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Referred;
                    reviewRecord.OPERATIONCOMPLETED = false;
                    context.SaveChanges();
                    trans.Commit();
                    return 4;
                }

                workFlow.StaffId = entity.staffId;
                workFlow.CompanyId = entity.companyId;
                workFlow.StatusId = ((short)entity.approvalStatusId == (short)ApprovalStatusEnum.Approved) ? (short)ApprovalStatusEnum.Processing : (short)entity.approvalStatusId;
                workFlow.TargetId = entity.targetId;
                workFlow.Comment = entity.comment;
                workFlow.OperationId = entity.operationId;
                workFlow.DeferredExecution = true;
                workFlow.LogActivity();


                bool output = false;
                int data = 0;

                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                {
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                    reviewRecord.OPERATIONCOMPLETED = true;
                    context.SaveChanges();
                    trans.Commit();
                    return 2;
                }

                if (workFlow.NewState != (int)ApprovalState.Ended)
                {
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    output = context.SaveChanges() > 0;
                    trans.Commit();
                    data = 3;
                }
                else if (workFlow.NewState == (int)ApprovalState.Ended)
                {
                    if (workFlow.StatusId == (int)ApprovalStatusEnum.Approved)
                    {
                        var caseLien = context.TBL_CASA_LIEN.Find(reviewRecord.CASALIENACCOUNTID);
                        caseLien.LIENSTATUS = (int)LienStatusEnum.Inactive;
                        reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                        reviewRecord.OPERATIONCOMPLETED = true;
                        caseLien.ISLIENREMOVED = true;
                        output = context.SaveChanges() > 0;
                        if (output == true)
                        {
                            if (reviewRecord.CREATEDBY != 1)
                            {
                                var customer = "";
                                var termLoan = context.TBL_LOAN.Where(t => t.LOANREFERENCENUMBER == caseLien.SOURCEREFERENCENUMBER).FirstOrDefault();
                                if (termLoan != null)
                                {
                                    customer = context.TBL_CUSTOMER.Where(c => c.CUSTOMERID == termLoan.CUSTOMERID).Select(c => c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME).FirstOrDefault();
                                }
                                var revolvingLoan = context.TBL_LOAN_REVOLVING.Where(t => t.LOANREFERENCENUMBER == caseLien.SOURCEREFERENCENUMBER).FirstOrDefault();
                                if (revolvingLoan != null)
                                {
                                    customer = context.TBL_CUSTOMER.Where(c => c.CUSTOMERID == revolvingLoan.CUSTOMERID).Select(c => c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME).FirstOrDefault();
                                }
                                var contingentLoan = context.TBL_LOAN_CONTINGENT.Where(t => t.LOANREFERENCENUMBER == caseLien.SOURCEREFERENCENUMBER).FirstOrDefault();
                                if (contingentLoan != null)
                                {
                                    customer = context.TBL_CUSTOMER.Where(c => c.CUSTOMERID == contingentLoan.CUSTOMERID).Select(c => c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME).FirstOrDefault();
                                }
                                var staff = context.TBL_STAFF.Find(reviewRecord.CREATEDBY);
                                var alertDetail = context.TBL_ALERT_TITLE.Where(x => x.BINDINGMETHOD == "LienAccountReleaseNotification").FirstOrDefault();
                                var emailList = GetBusinessUsersEmailsToGroupHead(staff.MISCODE);
                                alert.receiverEmailList.Add(emailList);
                                var alertTemplate = alertDetail.TEMPLATE;
                                var accountOfficer = staff.FIRSTNAME + " " + staff.LASTNAME + " " + staff.MIDDLENAME;
                                alertTemplate = alertTemplate.Replace("@{{accountOfficer}}", accountOfficer);
                                alertTemplate = alertTemplate.Replace("@{{customer}}", customer);
                                alertTemplate = alertTemplate.Replace("@{{accountNumber}}", caseLien.PRODUCTACCOUNTNUMBER);
                                alertTemplate = alertTemplate.Replace("@{{sourceReferenceNumber}}", caseLien.SOURCEREFERENCENUMBER);
                                LogEmailAlert(alertTemplate, alertDetail.TITLE, alert.receiverEmailList, "22023", 22023, "LienAccountReleaseNotification");
                            }
                        }
                    }
                    if (output == true)
                    {
                        trans.Commit();
                        data = 1;
                    }

                }
                return data;

            }

        }

        public WorkflowResponse GoForAssignLoansToAgentApproval(ApprovalViewModel entity)
        {
            
                List<string> receiverEmailList = new List<string>();
                AlertsViewModel alert = new AlertsViewModel();
                var dynamicMessage = string.Empty;

                entity.applicationDate = generalSetup.GetApplicationDate();
                using (var trans = context.Database.BeginTransaction())
                {
                    var reviewRecord = (from s in context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                                        where s.BULKRECOVERYAPPROVALID == entity.targetId && s.OPERATIONID == entity.operationId
                                        && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                        select s).FirstOrDefault();

                    workFlow.StaffId = entity.staffId;
                    workFlow.CompanyId = entity.companyId;
                    workFlow.StatusId = ((short)entity.approvalStatusId == (short)ApprovalStatusEnum.Approved) ? (short)ApprovalStatusEnum.Processing : (short)entity.approvalStatusId;
                    workFlow.TargetId = entity.targetId;
                    workFlow.Comment = entity.comment;
                    workFlow.OperationId = entity.operationId;
                    workFlow.DeferredExecution = true;
                    workFlow.LogActivity();

                    if (entity.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                    {

                        var loanAssigns = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == reviewRecord.REFERENCEBATCHID).ToList();
                        foreach (var loanAssign in loanAssigns)
                        {
                            var record = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(loanAssign.LOANASSIGNID);
                            record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                            record.OPERATIONCOMPLETED = false;
                        }
                        reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;

                    }

                    if (workFlow.NewState != (int)ApprovalState.Ended)
                    {
                        reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    }
                    else if (workFlow.NewState == (int)ApprovalState.Ended)
                    {
                        if (workFlow.StatusId == (int)ApprovalStatusEnum.Approved)
                        {
                            var loanAssigns = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == reviewRecord.REFERENCEBATCHID).ToList();
                            foreach (var loanAssign in loanAssigns)
                            {
                                var record = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(loanAssign.LOANASSIGNID);
                                record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                                record.OPERATIONCOMPLETED = true;
                                record.OPERATIONID = entity.operationId;
                            }
                            reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;

                            var consultant = context.TBL_ACCREDITEDCONSULTANT.Find(reviewRecord.ACCREDITEDCONSULTANTID);
                            alert.receiverEmailList.Add(consultant.EMAILADDRESS);
                            dynamicMessage = "Dear " + consultant.FIRMNAME + "<br/> Kindly be informed that you have been shortlisted as one of the Consulting firms for our Loan(s) recovery process. Contact the bank for further details";
                            LogEmailAlert(dynamicMessage, "NOTIFICATION FOR LOAN(S) RECOVERY", alert.receiverEmailList, "80760", 80760, "NotifyRecoveryAgentForAssignedLoans");

                        }
                    }
                    context.SaveChanges();
                    trans.Commit();

                }
                return workFlow.Response;
           
        }


        public WorkflowResponse GoForUnassignLoansFromAgentApproval(ApprovalViewModel entity)
        {
            List<string> receiverEmailList = new List<string>();
            AlertsViewModel alert = new AlertsViewModel();
            var dynamicMessage = string.Empty;

            entity.applicationDate = generalSetup.GetApplicationDate();
            using (var trans = context.Database.BeginTransaction())
            {
                var reviewRecord = (from s in context.TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL
                                    where s.BULKRECOVERYUNASSIGNAPPROVALID == entity.targetId && s.OPERATIONID == entity.operationId
                                    && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                    select s).FirstOrDefault();

                workFlow.StaffId = entity.staffId;
                workFlow.CompanyId = entity.companyId;
                workFlow.StatusId = ((short)entity.approvalStatusId == (short)ApprovalStatusEnum.Approved) ? (short)ApprovalStatusEnum.Processing : (short)entity.approvalStatusId;
                workFlow.TargetId = entity.targetId;
                workFlow.Comment = entity.comment;
                workFlow.OperationId = entity.operationId;
                workFlow.DeferredExecution = true;
                workFlow.LogActivity();

                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                {

                    var record = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find((int)reviewRecord.LOANID);
                    record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                    record.OPERATIONCOMPLETED = false;

                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;

                }

                if (workFlow.NewState != (int)ApprovalState.Ended)
                {
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                }
                else if (workFlow.NewState == (int)ApprovalState.Ended)
                {
                    if (workFlow.StatusId == (int)ApprovalStatusEnum.Approved)
                    {
                        var record = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find((int)reviewRecord.LOANID);
                        record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                        record.OPERATIONCOMPLETED = false;
                        record.OPERATIONID = entity.operationId;
                        record.DELETED = true;
                    }
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;

                    var consultant = context.TBL_ACCREDITEDCONSULTANT.Find(reviewRecord.ACCREDITEDCONSULTANTID);
                    alert.receiverEmailList.Add(consultant.EMAILADDRESS);
                    dynamicMessage = "Dear " + consultant.FIRMNAME + "<br/> Kindly be informed that the assigned recoveries on your queue have been un-assigned. Contact the bank for further details";
                    LogEmailAlert(dynamicMessage, "NOTIFICATION FOR LOAN(S) RECOVERY", alert.receiverEmailList, "80760", 80760, "NotifyRecoveryAgentForAssignedLoans");


                }
                context.SaveChanges();
                trans.Commit();

            }
            return workFlow.Response;
        }


        public WorkflowResponse GoForBulkAssignLoansToAgentApproval(List<BulkRecoveryApprovalViewModel> entity, UserInfo user, int approvalStatusId, string comment)
        {
            List<string> receiverEmailList = new List<string>();
            AlertsViewModel alert = new AlertsViewModel();
            var dynamicMessage = string.Empty;

            if (entity != null)
            {

                using (var trans = context.Database.BeginTransaction())
                {
                    foreach (var record in entity)
                    {
                        record.applicationDate = generalSetup.GetApplicationDate();

                        var reviewRecord = (from s in context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                                            where s.BULKRECOVERYAPPROVALID == record.bulkRecoveryApprovalId && s.OPERATIONID == record.operationId
                                            && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                            select s).FirstOrDefault();

                        var approval = new ApprovalViewModel
                        {
                            staffId = user.createdBy,
                            companyId = user.companyId,
                            approvalStatusId = ((short)approvalStatusId == (short)ApprovalStatusEnum.Approved) ? (short)ApprovalStatusEnum.Processing : (short)approvalStatusId,
                            comment = comment,
                            targetId = record.bulkRecoveryApprovalId,
                            operationId = record.operationId,
                            BranchId = user.BranchId,
                            deferredExecution = false
                        };

                        workFlow.LogForApproval(approval);

                        if (approvalStatusId == (int)ApprovalStatusEnum.Disapproved)
                        {
                            var loanAssigns = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == reviewRecord.REFERENCEBATCHID).ToList();
                            foreach (var loanAssign in loanAssigns)
                            {
                                var records = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(loanAssign.LOANASSIGNID);
                                records.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                                records.OPERATIONCOMPLETED = false;
                                records.DELETED = true;
                            }
                            reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                        }

                        if (workFlow.NewState != (int)ApprovalState.Ended)
                        {
                            reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;

                        }
                        else if (workFlow.NewState == (int)ApprovalState.Ended)
                        {
                            if (workFlow.StatusId == (int)ApprovalStatusEnum.Approved)
                            {
                                var loanAssigns = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == reviewRecord.REFERENCEBATCHID).ToList();
                                foreach (var loanAssign in loanAssigns)
                                {
                                    var records = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(loanAssign.LOANASSIGNID);
                                    records.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                                    records.OPERATIONCOMPLETED = true;
                                    records.OPERATIONID = record.operationId;
                                }
                                reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;

                                var consultant = context.TBL_ACCREDITEDCONSULTANT.Find(reviewRecord.ACCREDITEDCONSULTANTID);
                                alert.receiverEmailList.Add(consultant.EMAILADDRESS);
                                dynamicMessage = "Dear " + consultant.FIRMNAME + "<br/> Kindly be informed that you have been shortlisted as one of the Consulting firms for our Loan(s) recovery process. Contact the bank for further details";
                                LogEmailAlert(dynamicMessage, "NOTIFICATION FOR LOAN(S) RECOVERY", alert.receiverEmailList, "80760", 80760, "NotifyRecoveryAgentForAssignedLoans");

                            }

                        }

                    }
                    context.SaveChanges();
                    trans.Commit();
                }

            }
            return workFlow.Response;
        }

        public WorkflowResponse GoForBulkUnassignLoansFromAgentApproval(List<BulkRecoveryApprovalViewModel> entity, UserInfo user, int approvalStatusId, string comment)
        {
            List<string> receiverEmailList = new List<string>();
            AlertsViewModel alert = new AlertsViewModel();
            var dynamicMessage = string.Empty;

            if (entity != null)
            {

                using (var trans = context.Database.BeginTransaction())
                {
                    foreach (var record in entity)
                    {
                        record.applicationDate = generalSetup.GetApplicationDate();

                        var reviewRecord = (from s in context.TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL
                                            where s.BULKRECOVERYUNASSIGNAPPROVALID == record.bulkRecoveryApprovalId && s.OPERATIONID == record.operationId
                                            && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                            select s).FirstOrDefault();

                        var approval = new ApprovalViewModel
                        {
                            staffId = user.createdBy,
                            companyId = user.companyId,
                            approvalStatusId = ((short)approvalStatusId == (short)ApprovalStatusEnum.Approved) ? (short)ApprovalStatusEnum.Processing : (short)approvalStatusId,
                            comment = comment,
                            targetId = record.bulkRecoveryApprovalId,
                            operationId = record.operationId,
                            BranchId = user.BranchId,
                            deferredExecution = false
                        };

                        workFlow.LogForApproval(approval);

                        if (approvalStatusId == (int)ApprovalStatusEnum.Disapproved)
                        {

                            var records = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find((int)reviewRecord.LOANID);
                            records.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                            records.OPERATIONCOMPLETED = false;
                            records.DELETED = false;
                            reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                        }

                        if (workFlow.NewState != (int)ApprovalState.Ended)
                        {
                            reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;

                        }
                        else if (workFlow.NewState == (int)ApprovalState.Ended)
                        {
                            if (workFlow.StatusId == (int)ApprovalStatusEnum.Approved)
                            {
                                var records = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find((int)reviewRecord.LOANID);
                                records.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                                records.OPERATIONCOMPLETED = false;
                                records.OPERATIONID = record.operationId;
                                records.DELETED = true;

                                reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;

                                var consultant = context.TBL_ACCREDITEDCONSULTANT.Find(reviewRecord.ACCREDITEDCONSULTANTID);
                                alert.receiverEmailList.Add(consultant.EMAILADDRESS);
                                dynamicMessage = "Dear " + consultant.FIRMNAME + "<br/> Kindly be informed that the recoveries on your queue have been un-assigned. Contact the bank for further details";
                                LogEmailAlert(dynamicMessage, "NOTIFICATION FOR LOAN(S) RECOVERY", alert.receiverEmailList, "80760", 80760, "NotifyRecoveryAgentForAssignedLoans");

                            }

                        }

                    }
                    context.SaveChanges();
                    trans.Commit();
                }

            }
            return workFlow.Response;
        }

        public void LogEmailAlert(string messageBody, string alertSubject, List<string> recipients, string referenceCode, int targetId, string operationMehtod)
        {
            try
            {
                var title = alertSubject.Trim();
                if (title.Contains("&"))
                {
                    title = title.Replace("&", "AND");
                }
                if (title.Contains("."))
                {
                    title = title.Replace(".", "");
                }

                string recipient = string.Join("", recipients.ToArray());
                string messageSubject = title;
                string messageContent = messageBody;
                MessageLogViewModel messageModel = new MessageLogViewModel
                {
                    MessageSubject = messageSubject,
                    MessageBody = messageContent,
                    MessageStatusId = 1,
                    MessageTypeId = 1,
                    FromAddress = ConfigurationManager.AppSettings["SupportEmailAddr"],
                    ToAddress = $"{recipient}",
                    DateTimeReceived = DateTime.Now,
                    SendOnDateTime = DateTime.Now,
                    ReferenceCode = referenceCode,
                    targetId = targetId,
                    operationMethod = operationMehtod,
                };
                SaveMessageDetails(messageModel);
            }
            catch (Exception ex)
            {
                new SecureException(ex.ToString());
            }
        }

        private void SaveMessageDetails(MessageLogViewModel model)
        {
            var message = new TBL_MESSAGE_LOG()
            {
                //MessageId = model.MessageId,
                MESSAGESUBJECT = model.MessageSubject,
                MESSAGEBODY = model.MessageBody,
                MESSAGESTATUSID = model.MessageStatusId,
                MESSAGETYPEID = model.MessageTypeId,
                FROMADDRESS = model.FromAddress,
                TOADDRESS = model.ToAddress,
                DATETIMERECEIVED = model.DateTimeReceived,
                SENDONDATETIME = model.SendOnDateTime,
                ATTACHMENTCODE = model.ReferenceCode,
                ATTACHMENTTYPEID = (short)AttachementTypeEnum.JobRequest,
                TARGETID = (int)model.targetId,
                OPERATIONMETHOD = model.operationMethod
            };

            context.TBL_MESSAGE_LOG.Add(message);
            context.SaveChanges();

        }
        public List<FinanceTransactionViewModel> BuildLoanOperationsManualChargeFeesPosting(int loanChargeFeeId)
        {
            var loanFee = context.TBL_LOAN_FEE.Find(loanChargeFeeId);

            LoanViewModel loanDetails = new LoanViewModel();
            if (loanFee.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility)
            {
                loanDetails = (from a in context.TBL_LOAN
                               where a.TERMLOANID == loanFee.LOANID
                               select new LoanViewModel
                               {
                                   loanId = a.TERMLOANID,
                                   companyId = a.COMPANYID,
                                   currencyId = a.CURRENCYID,
                                   loanReferenceNumber = a.LOANREFERENCENUMBER,
                                   branchId = a.BRANCHID,
                                   createdBy = loanFee.CREATEDBY
                               }).FirstOrDefault();//context.TBL_LOAN.Find(loanFee.LOANID);

            }
            if (loanFee.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.ContingentLiability)
            {
                loanDetails = (from a in context.TBL_LOAN_CONTINGENT
                               where a.CONTINGENTLOANID == loanFee.LOANID
                               select new LoanViewModel
                               {
                                   loanId = a.CONTINGENTLOANID,
                                   companyId = a.COMPANYID,
                                   currencyId = a.CURRENCYID,
                                   loanReferenceNumber = a.LOANREFERENCENUMBER,
                                   branchId = a.BRANCHID,
                                   createdBy = loanFee.CREATEDBY

                               }).FirstOrDefault();//context.TBL_LOAN_CONTINGENT.Find(loanFee.LOANID);

            }
            if (loanFee.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.OverdraftFacility)
            {
                loanDetails = (from a in context.TBL_LOAN_REVOLVING
                               where a.REVOLVINGLOANID == loanFee.LOANID
                               select new LoanViewModel
                               {
                                   loanId = a.REVOLVINGLOANID,
                                   companyId = a.COMPANYID,
                                   currencyId = a.CURRENCYID,
                                   loanReferenceNumber = a.LOANREFERENCENUMBER,
                                   branchId = a.BRANCHID,
                                   createdBy = loanFee.CREATEDBY
                               }).FirstOrDefault();//context.TBL_LOAN_REVOLVING.Find(loanFee.LOANID);

            }
            if (loanFee.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility)
            {
                loanDetails = (from a in context.TBL_LOAN_APPLICATION_DETAIL
                               join b in context.TBL_LOAN_APPLICATION on a.LOANAPPLICATIONID equals b.LOANAPPLICATIONID
                               where a.LOANAPPLICATIONDETAILID == loanFee.LOANID
                               select new LoanViewModel
                               {
                                   loanId = a.LOANAPPLICATIONDETAILID,
                                   companyId = b.COMPANYID,
                                   currencyId = a.CURRENCYID,
                                   loanReferenceNumber = b.APPLICATIONREFERENCENUMBER + "-" + a.LOANAPPLICATIONDETAILID,
                                   branchId = b.BRANCHID,
                                   createdBy = loanFee.CREATEDBY
                               }).FirstOrDefault();//context.TBL_LOAN_APPLICATION_DETAIL.Find(loanFee.LOANID);

            }

            var batchCode = CommonHelpers.GenerateRandomDigitCode(10);
            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();
            TBL_LOAN loanTable = new TBL_LOAN();
            //var bookingRequestDetails = context.TBL_LOAN_BOOKING_REQUEST.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == loanDetails.loanBookingRequestId);

            var company = context.TBL_COMPANY.Find(loanDetails.companyId);
            //  foreach (var item in loanDetails.loanChargeFee)
            // {
            if (loanFee.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility)
            {
                loanTable = context.TBL_LOAN.Find(loanFee.LOANID);
            }

            if (loanFee.ISPOSTED == false && loanFee.FEEAMOUNT > 0)
            {

                var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loanFee.CASAACCOUNTID);

                var postingGroups = (from details in this.context.TBL_CHARGE_FEE_DETAIL where details.CHARGEFEEID == loanFee.CHARGEFEEID select details.POSTINGGROUP).Distinct().ToList();

                foreach (var post in postingGroups)
                {
                    var feeDetails = (from details in this.context.TBL_CHARGE_FEE_DETAIL where details.CHARGEFEEID == loanFee.CHARGEFEEID && details.POSTINGGROUP == post orderby details.POSTINGTYPEID select details).ToList();

                    foreach (var debits in feeDetails.Where(a => a.POSTINGTYPEID == (int)GLPostingTypeEnum.Debit))
                    {
                        FinanceTransactionViewModel debit = new FinanceTransactionViewModel();
                        decimal debitAmount = 0;
                        if (debits.FEETYPEID == (int)FeeTypeEnum.Rate)
                            debitAmount = (decimal)loanFee.FEEAMOUNT * (decimal)(debits.VALUE / 100.0);
                        else if (debits.FEETYPEID == (int)FeeTypeEnum.Amount)
                            debitAmount = (decimal)debits.VALUE;

                        debit.operationId = (int)OperationsEnum.ManualFeeCharge;
                        debit.description = $"Fee charge on {debits.DESCRIPTION}";
                        debit.valueDate = generalSetup.GetApplicationDate();
                        debit.transactionDate = debit.valueDate;
                        debit.currencyId = casa.CURRENCYID;
                        debit.currencyRate = financeTransaction.GetExchangeRate(debit.valueDate, debit.currencyId, loanDetails.companyId).sellingRate;
                        debit.isApproved = true;
                        debit.postedBy = loanDetails.createdBy;
                        debit.approvedBy = loanDetails.createdBy;
                        debit.approvedDate = debit.transactionDate;
                        debit.approvedDateTime = DateTime.Now;
                        debit.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
                        debit.companyId = loanDetails.companyId;


                        debit.glAccountId = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == casa.PRODUCTID).PRINCIPALBALANCEGL.Value;
                        debit.sourceReferenceNumber = loanDetails.loanReferenceNumber;
                        debit.batchCode = batchCode;
                        debit.casaAccountId = casa.CASAACCOUNTID;
                        debit.debitAmount = debitAmount;
                        debit.creditAmount = 0;
                        debit.sourceBranchId = loanDetails.branchId;
                        debit.destinationBranchId = casa.BRANCHID;

                        debit.rateCode = "TTB"; //loanDetails.nostroRateCode;
                        debit.rateUnit = string.Empty;
                        debit.currencyCrossCode = casa.TBL_CURRENCY.CURRENCYCODE;

                        inputTransactions.Add(debit);
                    }

                    foreach (var credits in feeDetails.Where(a => a.POSTINGTYPEID == (int)GLPostingTypeEnum.Credit))
                    {
                        FinanceTransactionViewModel credit = new FinanceTransactionViewModel();
                        decimal creditAmount = 0;
                        if (credits.FEETYPEID == (int)FeeTypeEnum.Rate)
                            creditAmount = (decimal)loanFee.FEEAMOUNT * (decimal)(credits.VALUE / 100.0);
                        else if (credits.FEETYPEID == (int)FeeTypeEnum.Amount)
                            creditAmount = (decimal)credits.VALUE;


                        credit.operationId = (int)OperationsEnum.ManualFeeCharge;
                        credit.description = $"Fee charge on {credits.DESCRIPTION}";
                        credit.valueDate = generalSetup.GetApplicationDate();
                        credit.transactionDate = credit.valueDate;
                        credit.currencyId = context.TBL_COMPANY.FirstOrDefault(x => x.COMPANYID == loanDetails.companyId).CURRENCYID; //(short)chartOfAccount.GetAccountDefaultCurrency((int)credits.GLACCOUNTID1, loanDetails.companyId); //casa.CURRENCYID;
                        credit.currencyRate = financeTransaction.GetExchangeRate(credit.valueDate, credit.currencyId, loanDetails.companyId).sellingRate;
                        credit.isApproved = true;
                        credit.postedBy = loanDetails.createdBy;
                        credit.approvedBy = loanDetails.createdBy;
                        credit.approvedDate = credit.transactionDate;
                        credit.approvedDateTime = DateTime.Now;
                        credit.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
                        credit.companyId = loanDetails.companyId;
                        credit.glAccountId = (int)credits.GLACCOUNTID1;
                        credit.sourceReferenceNumber = loanDetails.loanReferenceNumber;
                        credit.batchCode = batchCode;
                        credit.casaAccountId = null;
                        credit.debitAmount = 0;
                        credit.creditAmount = creditAmount;
                        credit.sourceBranchId = loanDetails.branchId;
                        credit.destinationBranchId = loanDetails.branchId;
                        credit.rateCode = "TTB"; //loanDetails.nostroRateCode;
                        credit.rateUnit = string.Empty;
                        credit.currencyCrossCode = casa.TBL_CURRENCY.CURRENCYCODE;

                        inputTransactions.Add(credit);
                    }
                }
            }

            //}
            return inputTransactions;
        }

        private int ApproveLoanReview(int loanId, ApprovalViewModel user)
        {
            using (var trans = context.Database.BeginTransaction())
            {
                try
                {
                    bool output = false;
                    bool result = false;
                    int data = 0;
                    var reviewRecord = (from s in context.TBL_LOAN_REVIEW_OPERATION
                                        where s.LOANID == loanId && s.OPERATIONTYPEID == user.operationId
                                       && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                        && s.OPERATIONCOMPLETED == false
                                        select s).FirstOrDefault();
                    if (workFlow.NewState != (int)ApprovalState.Ended)
                    {
                        reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                        output = context.SaveChanges() > 0;
                        trans.Commit();
                        data = 1;
                    }
                    else if (workFlow.NewState == (int)ApprovalState.Ended)
                    {
                        if (output == true && result == true)
                        {
                            trans.Commit();
                            data = 2;
                        }

                    }
                    return data;
                }
                catch (Exception ex)
                {
                    trans.Rollback();
                    throw ex;
                }
            }


        }

        //private int ApproveLoanReview(int loanId, ApprovalViewModel user)
        //{
        //    using (var trans = context.Database.BeginTransaction())
        //    {
        //        try
        //        {
        //            bool output = false;
        //            bool result = false;
        //            int data = 0;
        //            var reviewRecord = (from s in context.TBL_LOAN_REVIEW_OPERATION
        //                                where s.LOANID == loanId && s.OPERATIONTYPEID == user.operationId
        //                               && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
        //                                && s.OPERATIONCOMPLETED == false
        //                                select s).FirstOrDefault();
        //            if (workFlow.NewState != (int)ApprovalState.Ended)
        //            {
        //                reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
        //                output = context.SaveChanges() > 0;
        //                //if(output == true)
        //                //{
        //                    trans.Commit();
        //                    data = 1;

        //                //}
        //            }
        //            else if (workFlow.NewState == (int)ApprovalState.Ended)
        //            {
        //                 result = LoanRephasementProcess((short)reviewRecord.LOANREVIEWOPERATIONID, reviewRecord.LOANID, user.staffId);
        //                if (result == true)
        //                {
        //                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
        //                    output = context.SaveChanges() > 0;
        //                }


        //                if (output == true && result == true)
        //                {
        //                    trans.Commit();
        //                    data = 2;
        //                }

        //            }
        //            return data;
        //        }
        //        catch (Exception ex)
        //        {
        //            trans.Rollback();
        //            throw ex;
        //        }
        //    }

        //}

        //[OperationBehavior(TransactionScopeRequired = true)]
        //public bool LoanRephasementProcess(TwoFactorAutheticationViewModel twoFactorAuth, short loanReviewOperationsId, int loanId, int staffId)
        //{
        //    try
        //    {
        //        bool output = false;
        //        bool result = false;

        //        var checkForOverDraft = this.context.TBL_LOAN_REVOLVING.FirstOrDefault(x => x.REVOLVINGLOANID == loanId);
        //        if (checkForOverDraft != null)
        //        {
        //            var model = (
        //                         from a in context.TBL_LOAN_REVIEW_OPERATION
        //                         join b in context.TBL_LOAN_REVOLVING on a.LOANID equals b.REVOLVINGLOANID
        //                         where b.LOANSTATUSID == (short)LoanStatusEnum.Active && a.LOANID == loanId && a.OPERATIONCOMPLETED == false
        //                         && a.LOANREVIEWOPERATIONID == loanReviewOperationsId

        //                         select new LoanPaymentRestructureScheduleInputViewModel()
        //                         {
        //                             loanId = b.REVOLVINGLOANID,
        //                             principalAmount = (double)b.OVERDRAFTLIMIT,

        //                             interestRate = b.INTERESTRATE,
        //                             effectiveDate = a.EFFECTIVEDATE,
        //                             maturityDate = b.MATURITYDATE,
        //                             integralFeeAmount = 0,
        //                             newEffectiveDate = a.EFFECTIVEDATE,
        //                             newInterestFirstpaymentDate = (DateTime)a.INTERESTFIRSTPAYMENTDATE,
        //                             newInterest = (double)a.INTERATERATE,
        //                             newAmount = (double?)a.OVERDRAFTTOPUP ?? 0,
        //                             operationId = a.OPERATIONTYPEID,
        //                             newPrincipalFirstpaymentDate = (DateTime)a.PRINCIPALFIRSTPAYMENTDATE,
        //                             isManagementInterestRate = a.ISMANAGEMENTINTERESTRATE,
        //                             proposedTenor = a.TENOR,
        //                             newMaturityDate = a.MATURITYDATE,// change to maturity date affter scarfolding
        //                             companyId = b.COMPANYID,
        //                             staffId = staffId,
        //                             createdBy = staffId,
        //                             customerId = b.CUSTOMERID,
        //                             productId = b.PRODUCTID,

        //                         }).FirstOrDefault();
        //            string appDate = model.newEffectiveDate.ToString(@"yyyy-MM-dd");
        //            var applicationDate = Convert.ToDateTime(appDate);
        //            if ((int)OperationsEnum.OverdraftTopup == model.operationId)
        //            {

        //                result = OverdraftTopUp(twoFactorAuth, loanId, (decimal)model.newAmount);
        //                if (result == true)
        //                {
        //                    output = true;
        //                }
        //                else
        //                {
        //                    output = false;
        //                }
        //            }
        //            else if ((int)OperationsEnum.OverdraftRenewal == model.operationId)
        //            {
        //                result = OverdraftRenewal(twoFactorAuth, loanId, (decimal)model.newAmount);
        //                if (result == true)
        //                {
        //                    output = true;
        //                }
        //                else
        //                {
        //                    output = false;
        //                }
        //            }
        //            else if ((int)OperationsEnum.OverdraftTenorExtension == model.operationId)
        //            {
        //                result = OverdraftExtension(twoFactorAuth, loanId, (decimal)model.newAmount);
        //                if (result == true)
        //                {
        //                    output = true;
        //                }
        //                else
        //                {
        //                    output = false;
        //                }
        //            }

        //            else if ((int)OperationsEnum.OverdraftSubAllocation == model.operationId)
        //            {
        //                result = SubAllocation(twoFactorAuth, loanId, (decimal)model.newAmount, applicationDate, staffId);
        //                if (result == true)
        //                {
        //                    output = true;
        //                }
        //                else
        //                {
        //                    output = false;
        //                }
        //            }

        //            else if ((int)OperationsEnum.OverdraftInterestRate == model.operationId)
        //            {
        //                result = OverdraftInterestRate(twoFactorAuth, loanId);
        //                if (result == true)
        //                {
        //                    output = true;
        //                }
        //                else
        //                {
        //                    output = false;
        //                }
        //            }

        //            //}
        //        }
        //        else
        //        {
        //            var scheduleMethod = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId).SCHEDULETYPEID;
        //            var operationType = this.context.TBL_LOAN_REVIEW_OPERATION.FirstOrDefault(x => x.LOANREVIEWOPERATIONID == loanReviewOperationsId).OPERATIONTYPEID;

        //            if (scheduleMethod == (short)LoanScheduleTypeEnum.IrregularSchedule)
        //            {
        //                var model = (
        //                         from a in context.TBL_LOAN_REVIEW_OPERATION
        //                         join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
        //                         where b.LOANSTATUSID == (short)LoanStatusEnum.Active && a.LOANID == loanId && a.OPERATIONCOMPLETED == false
        //                             && a.LOANREVIEWOPERATIONID == loanReviewOperationsId

        //                         select new LoanPaymentRestructureScheduleInputViewModel()
        //                         {
        //                             loanId = b.TERMLOANID,
        //                             scheduleMethodId = b.SCHEDULETYPEID,
        //                             principalAmount = (double)b.OUTSTANDINGPRINCIPAL,
        //                             principalFrequency = b.PRINCIPALFREQUENCYTYPEID,
        //                             interestFrequency = b.INTERESTFREQUENCYTYPEID,
        //                             principalFirstpaymentDate = (DateTime)b.FIRSTPRINCIPALPAYMENTDATE,
        //                             interestFirstpaymentDate = (DateTime)b.FIRSTINTERESTPAYMENTDATE,
        //                             interestRate = b.INTERESTRATE,
        //                             effectiveDate = a.EFFECTIVEDATE,
        //                             maturityDate = b.MATURITYDATE,
        //                             accrualBasis = b.SCHEDULEDAYCOUNTCONVENTIONID,
        //                             firstDayType = b.SCHEDULEDAYINTERESTTYPEID,
        //                             integralFeeAmount = 0,
        //                             newEffectiveDate = a.EFFECTIVEDATE,
        //                             newInterestFrequency = (short?)a.INTERESTFREQUENCYTYPEID ?? (short)b.INTERESTFREQUENCYTYPEID,
        //                             newPrincipalFrequency = (short?)a.PRINCIPALFREQUENCYTYPEID ?? (short)b.PRINCIPALFREQUENCYTYPEID,
        //                             newInterestFirstpaymentDate = (DateTime)a.INTERESTFIRSTPAYMENTDATE,
        //                             newInterest = (double)a.INTERATERATE,
        //                             payAmount = (double?)a.PREPAYMENT ?? 0,
        //                             operationId = a.OPERATIONTYPEID,
        //                             newPrincipalFirstpaymentDate = (DateTime)a.PRINCIPALFIRSTPAYMENTDATE,
        //                             isManagementInterestRate = a.ISMANAGEMENTINTERESTRATE,
        //                             proposedTenor = a.TENOR,
        //                             newMaturityDate = a.MATURITYDATE,// change to maturity date affter scarfolding
        //                             companyId = b.COMPANYID,
        //                             staffId = staffId,
        //                             createdBy = staffId,
        //                             customerId = b.CUSTOMERID,
        //                             productId = b.PRODUCTID,
        //                         }).FirstOrDefault();
        //                List<IrregularLoanScheduleInputViewModel> irregularSchedule = new List<IrregularLoanScheduleInputViewModel>();
        //                {
        //                    var scheduleInput = context.TBL_LOAN_REVIEW_OPRATN_IREG_SC.Where(x => x.LOANREVIEWOPERATIONID == loanReviewOperationsId);

        //                    foreach (var model2 in scheduleInput)
        //                    {
        //                        irregularSchedule.Add(new IrregularLoanScheduleInputViewModel { paymentAmount = (double)model2.PAYMENTAMOUNT, paymentDate = model2.PAYMENTDATE });
        //                    }

        //                    model.irregularPaymentSchedule = irregularSchedule;

        //                }
        //                var unEarnedFee = from d in context.TBL_LOAN_SCHEDULE_DAILY
        //                                  where d.LOANID == model.loanId
        //                                  let sumUnEarnedFee = context.TBL_LOAN_SCHEDULE_DAILY.Where(a => a.LOANID == model.loanId
        //                                  && a.DATE >= DbFunctions.TruncateTime(model.newEffectiveDate)).Sum(a => (double?)a.UNEARNEDFEE ?? 0)
        //                                  select sumUnEarnedFee;
        //                model.integralFeeAmount = (double?)unEarnedFee.FirstOrDefault() ?? 0;
        //                string appDate = model.newEffectiveDate.ToString(@"yyyy-MM-dd");
        //                var applicationDate = Convert.ToDateTime(appDate);

        //                DateTime nextPaymentDate = DateTime.Now;
        //                var paymentDate = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
        //                                   where a.TBL_LOAN.TERMLOANID == loanId && a.PAYMENTDATE >= applicationDate
        //                                   select a).FirstOrDefault();

        //                if (paymentDate != null)
        //                {
        //                    nextPaymentDate = paymentDate.PAYMENTDATE;
        //                }
        //                else
        //                {
        //                    throw new SecureException("Application Date not found in Payment Schedule");
        //                }

        //                if ((int)OperationsEnum.ContractualInterestRateChange == model.operationId)
        //                {
        //                    model.interestRate = model.newInterest;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    model.tenor = model.newTenor;
        //                    model.principalFirstpaymentDate = nextPaymentDate;
        //                    model.interestFirstpaymentDate = nextPaymentDate;
        //                    result = InterestRateReview(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }


        //                }
        //                else if ((int)OperationsEnum.Prepayment == model.operationId)
        //                {
        //                    //decimal accruedAmount = 0;
        //                    //var accrued = (from a in context.TBL_LOAN_SCHEDULE_DAILY
        //                    //               where a.TBL_LOAN.TERMLOANID == loanId && a.DATE >= applicationDate
        //                    //               select a).FirstOrDefault();

        //                    //if (accrued != null)
        //                    //{
        //                    //    accruedAmount = accrued.ACCRUEDINTEREST;
        //                    //}
        //                    //else
        //                    //{
        //                    //    throw new SecureException("Application Date not found in Payment Schedule");
        //                    //}
        //                    //decimal accruedInterest = decimal.Round(accruedAmount, 2, MidpointRounding.AwayFromZero);
        //                    if (model.isManagementInterestRate == true)
        //                    {

        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenorPrepayment;
        //                        model.interestFirstpaymentDate = nextPaymentDate;
        //                        model.principalFirstpaymentDate = nextPaymentDate;
        //                    }
        //                    else
        //                    {
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenorPrepayment;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.interestFirstpaymentDate = nextPaymentDate;
        //                        model.principalFirstpaymentDate = nextPaymentDate;
        //                    }

        //                    result = UpdateLoanPrepaymentSchedule(twoFactorAuth, loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.PaymentDateChange == model.operationId)
        //                {
        //                    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
        //                    model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;

        //                    result = PaymentDateChange(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        updateLoanPrincipalInterestPaymentDate(model.interestFirstpaymentDate, model.principalFirstpaymentDate, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }


        //                }
        //                else if ((int)OperationsEnum.PrincipalFrequencyChange == model.operationId || (int)OperationsEnum.InterestFrequencyChange == model.operationId
        //                    || (int)OperationsEnum.InterestandPrincipalFrequencyChange == model.operationId)
        //                {
        //                    if ((int)OperationsEnum.PrincipalFrequencyChange == model.operationId)
        //                    {
        //                        model.principalFrequency = (short)model.newPrincipalFrequency;
        //                        model.interestFrequency = (short)model.interestFrequency;
        //                    }
        //                    if ((int)OperationsEnum.InterestFrequencyChange == model.operationId)
        //                    {
        //                        model.interestFrequency = (short)model.newInterestFrequency;
        //                        model.principalFrequency = (short)model.principalFrequency;
        //                    }
        //                    if ((int)OperationsEnum.InterestandPrincipalFrequencyChange == model.operationId)
        //                    {
        //                        model.interestFrequency = (short)model.newInterestFrequency;
        //                        model.principalFrequency = (short)model.newPrincipalFrequency;
        //                    }
        //                    result = PaymentFrequencyChange(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        updateLoanFrequency((short)model.principalFrequency, (short)model.interestFrequency, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.CompleteWriteOff == model.operationId)
        //                {
        //                    result = CompleteWriteOff(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.CancelUndisbursedLoan == model.operationId)
        //                {
        //                    result = LoanCancellation(loanId, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.Fee_chargeChange == model.operationId)
        //                {
        //                    result = ProcessChargeReversal(twoFactorAuth, loanId, model.operationId, staffId);
        //                    if (result == true)
        //                    {
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.TenorChange == model.operationId)
        //                {
        //                    model.maturityDate = (DateTime)model.newMaturityDate;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    model.tenor = model.newTenor; ;
        //                    model.principalFirstpaymentDate = nextPaymentDate;
        //                    model.interestFirstpaymentDate = nextPaymentDate;
        //                    result = TenorExtension(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }

        //                else if ((int)OperationsEnum.Restructured == model.operationId)
        //                {
        //                    model.interestRate = model.newInterest;
        //                    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
        //                    model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
        //                    model.maturityDate = (DateTime)model.newMaturityDate;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    model.tenor = model.newTenor;
        //                    model.interestFrequency = (short)model.newInterestFrequency;
        //                    model.principalFrequency = (short)model.newPrincipalFrequency;
        //                    result = Restructured(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.LoanSales == model.operationId)
        //                {
        //                    result = LoanSales(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.LoanWorkOut == model.operationId)
        //                {
        //                    model.interestRate = model.newInterest;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    model.scheduleMethodId = (short)LoanScheduleTypeEnum.IrregularSchedule;
        //                    result = LoanWorkOut(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }

        //                else if ((int)OperationsEnum.LoanRecapitilization == model.operationId)
        //                {
        //                    model.interestRate = model.newInterest;
        //                    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
        //                    model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
        //                    model.maturityDate = (DateTime)model.newMaturityDate;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    model.tenor = model.newTenor;
        //                    model.interestFrequency = (short)model.newInterestFrequency;
        //                    model.principalFrequency = (short)model.newPrincipalFrequency;
        //                    result = LoanRecapitilization(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }

        //                else if ((int)OperationsEnum.LoanRecovery == model.operationId)
        //                {
        //                    model.interestRate = model.newInterest;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    model.maturityDate = (DateTime)model.newMaturityDate;
        //                    model.scheduleMethodId = (short)LoanScheduleTypeEnum.IrregularSchedule;
        //                    result = LoanRecovery(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                }
        //                else if ((int)OperationsEnum.LoanTermination == model.operationId)
        //                {
        //                    model.interestRate = model.newInterest;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    model.maturityDate = (DateTime)model.newMaturityDate;
        //                    model.scheduleMethodId = (short)LoanScheduleTypeEnum.IrregularSchedule;
        //                    result = LoanTermination(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.LoanReversal == model.operationId)
        //                {
        //                    model.interestRate = model.newInterest;
        //                    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
        //                    model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
        //                    model.maturityDate = (DateTime)model.newMaturityDate;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    model.tenor = model.newTenor;
        //                    model.interestFrequency = (short)model.newInterestFrequency;
        //                    model.principalFrequency = (short)model.newPrincipalFrequency;
        //                    result = LoanReversal(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }

        //            }
        //            else
        //            {
        //                var model = (
        //                         from a in context.TBL_LOAN_REVIEW_OPERATION
        //                         join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
        //                         where b.LOANSTATUSID == (short)LoanStatusEnum.Active && a.LOANID == loanId && a.OPERATIONCOMPLETED == false
        //                         && a.LOANREVIEWOPERATIONID == loanReviewOperationsId

        //                         select new LoanPaymentRestructureScheduleInputViewModel()
        //                         {
        //                             loanId = b.TERMLOANID,
        //                             scheduleMethodId = b.SCHEDULETYPEID,
        //                             principalAmount = (double)b.OUTSTANDINGPRINCIPAL,
        //                             principalFrequency = b.PRINCIPALFREQUENCYTYPEID,
        //                             interestFrequency = b.INTERESTFREQUENCYTYPEID,
        //                             principalFirstpaymentDate = (DateTime)b.FIRSTPRINCIPALPAYMENTDATE,
        //                             interestFirstpaymentDate = (DateTime)b.FIRSTINTERESTPAYMENTDATE,
        //                             interestRate = b.INTERESTRATE,
        //                             effectiveDate = a.EFFECTIVEDATE,
        //                             maturityDate = b.MATURITYDATE,
        //                             accrualBasis = b.SCHEDULEDAYCOUNTCONVENTIONID,
        //                             firstDayType = b.SCHEDULEDAYINTERESTTYPEID,
        //                             integralFeeAmount = 0,
        //                             newEffectiveDate = a.EFFECTIVEDATE,
        //                             newInterestFrequency = (short?)a.INTERESTFREQUENCYTYPEID ?? (short)b.INTERESTFREQUENCYTYPEID,
        //                             newPrincipalFrequency = (short?)a.PRINCIPALFREQUENCYTYPEID ?? (short)b.PRINCIPALFREQUENCYTYPEID,
        //                             newInterestFirstpaymentDate = (DateTime)a.INTERESTFIRSTPAYMENTDATE,
        //                             newInterest = (double)a.INTERATERATE,
        //                             payAmount = (double?)a.PREPAYMENT ?? 0,
        //                             operationId = a.OPERATIONTYPEID,
        //                             newPrincipalFirstpaymentDate = (DateTime)a.PRINCIPALFIRSTPAYMENTDATE,
        //                             isManagementInterestRate = a.ISMANAGEMENTINTERESTRATE,
        //                             proposedTenor = a.TENOR,
        //                             newMaturityDate = a.MATURITYDATE,// change to maturity date affter scarfolding
        //                             companyId = b.COMPANYID,
        //                             staffId = staffId,
        //                             createdBy = staffId,
        //                             customerId = b.CUSTOMERID,
        //                             productId = b.PRODUCTID,
        //                             oldCasaAccountId = b.CASAACCOUNTID,
        //                             newCasaAccountId = a.CASA_ACCOUNTID,


        //                         }).FirstOrDefault();

        //                var unEarnedFee = from d in context.TBL_LOAN_SCHEDULE_DAILY
        //                                  where d.LOANID == model.loanId
        //                                  let sumUnEarnedFee = context.TBL_LOAN_SCHEDULE_DAILY.Where(a => a.LOANID == model.loanId
        //                                  && a.DATE >= DbFunctions.TruncateTime(model.newEffectiveDate)).Sum(a => (double?)a.UNEARNEDFEE ?? 0)
        //                                  select sumUnEarnedFee;
        //                model.integralFeeAmount = (double?)unEarnedFee.FirstOrDefault() ?? 0;
        //                string appDate = model.newEffectiveDate.ToString(@"yyyy-MM-dd");
        //                var applicationDate = Convert.ToDateTime(appDate);

        //                DateTime nextPaymentDate = DateTime.Now;
        //                var paymentDate = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
        //                                   where a.TBL_LOAN.TERMLOANID == loanId && a.PAYMENTDATE >= applicationDate
        //                                   select a).FirstOrDefault();

        //                if (paymentDate != null)
        //                {
        //                    nextPaymentDate = paymentDate.PAYMENTDATE;
        //                }
        //                else
        //                {
        //                    throw new SecureException("Application Date not found in Payment Schedule");
        //                }
        //                if ((int)OperationsEnum.ContractualInterestRateChange == model.operationId)
        //                {
        //                    if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                    }
        //                    else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                        model.principalFirstpaymentDate = nextPaymentDate;
        //                        model.interestFirstpaymentDate = nextPaymentDate;
        //                    }
        //                    else
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                        model.principalFirstpaymentDate = nextPaymentDate;
        //                        model.interestFirstpaymentDate = nextPaymentDate;
        //                    }

        //                    if (model.interestFirstpaymentDate <= model.effectiveDate)
        //                    {
        //                        throw new ConditionNotMetException("First Payment Date must be greater than Effective Date");
        //                    }
        //                    result = InterestRateReview(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }


        //                }
        //                else if ((int)OperationsEnum.Prepayment == model.operationId)
        //                {
        //                    if (model.isManagementInterestRate == true)
        //                    {
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenorPrepayment;
        //                        model.interestFirstpaymentDate = nextPaymentDate;
        //                        model.principalFirstpaymentDate = nextPaymentDate;
        //                    }
        //                    else
        //                    {
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenorPrepayment;
        //                        model.interestFirstpaymentDate = nextPaymentDate;
        //                        model.principalFirstpaymentDate = nextPaymentDate;
        //                    }

        //                    result = UpdateLoanPrepaymentSchedule(twoFactorAuth, loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.PaymentDateChange == model.operationId)
        //                {
        //                    if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
        //                    {
        //                        model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
        //                    }
        //                    else
        //                    {
        //                        model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
        //                        model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;
        //                    }


        //                    result = PaymentDateChange(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        updateLoanPrincipalInterestPaymentDate(model.interestFirstpaymentDate, model.principalFirstpaymentDate, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }


        //                }
        //                else if ((int)OperationsEnum.PrincipalFrequencyChange == model.operationId || (int)OperationsEnum.InterestFrequencyChange == model.operationId
        //                    || (int)OperationsEnum.InterestandPrincipalFrequencyChange == model.operationId)
        //                {
        //                    if ((int)OperationsEnum.PrincipalFrequencyChange == model.operationId)
        //                    {
        //                        if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment || scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
        //                        {
        //                            model.principalFrequency = (short)model.newPrincipalFrequency;
        //                            model.interestFrequency = (short)model.newPrincipalFrequency;
        //                        }
        //                        else
        //                        {
        //                            model.principalFrequency = (short)model.newPrincipalFrequency;
        //                            model.interestFrequency = (short)model.interestFrequency;
        //                        }

        //                    }
        //                    if ((int)OperationsEnum.InterestFrequencyChange == model.operationId)
        //                    {
        //                        if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment || scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
        //                        {
        //                            model.interestFrequency = (short)model.newInterestFrequency;
        //                            model.principalFrequency = (short)model.newInterestFrequency;
        //                        }
        //                        else
        //                        {
        //                            model.interestFrequency = (short)model.newInterestFrequency;
        //                            model.principalFrequency = (short)model.principalFrequency;
        //                        }

        //                    }
        //                    if ((int)OperationsEnum.InterestandPrincipalFrequencyChange == model.operationId)
        //                    {
        //                        model.interestFrequency = (short)model.newInterestFrequency;
        //                        model.principalFrequency = (short)model.newPrincipalFrequency;
        //                    }
        //                    result = PaymentFrequencyChange(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        updateLoanFrequency((short)model.principalFrequency, (short)model.interestFrequency, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.CompleteWriteOff == model.operationId)
        //                {
        //                    //model.interestRate = model.newInterest;
        //                    //model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
        //                    //model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
        //                    //model.maturityDate = (DateTime)model.newMaturityDate;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    //model.tenor = model.newTenor;
        //                    //model.interestFrequency = (short)model.newInterestFrequency;
        //                    //model.principalFrequency = (short)model.newPrincipalFrequency;
        //                    result = CompleteWriteOff(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.TerminateAndRebook == model.operationId)
        //                {
        //                    TerminateAndRebookLoanSchedule(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
        //                    var data = (
        //                                from b in context.TBL_LOAN
        //                                where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.RELATED_LOAN_REFERENCE_NUMBER == loan.LOANREFERENCENUMBER
        //                                select new LoanPaymentRestructureScheduleInputViewModel()
        //                                {
        //                                    loanId = b.TERMLOANID,
        //                                    scheduleMethodId = b.SCHEDULETYPEID,
        //                                    principalAmount = (double)b.OUTSTANDINGPRINCIPAL,
        //                                    principalFrequency = b.PRINCIPALFREQUENCYTYPEID,
        //                                    interestFrequency = b.INTERESTFREQUENCYTYPEID,
        //                                    principalFirstpaymentDate = (DateTime)b.FIRSTPRINCIPALPAYMENTDATE,
        //                                    interestFirstpaymentDate = (DateTime)b.FIRSTINTERESTPAYMENTDATE,
        //                                    interestRate = b.INTERESTRATE,
        //                                    effectiveDate = b.EFFECTIVEDATE,
        //                                    maturityDate = b.MATURITYDATE,
        //                                    accrualBasis = b.SCHEDULEDAYCOUNTCONVENTIONID,
        //                                    firstDayType = b.SCHEDULEDAYINTERESTTYPEID,
        //                                    integralFeeAmount = 0,
        //                                    companyId = b.COMPANYID,
        //                                    staffId = staffId,
        //                                    createdBy = staffId,
        //                                    customerId = b.CUSTOMERID,

        //                                }).FirstOrDefault();
        //                    result = RegenerateSchedule(data.loanId, data, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.Fee_chargeChange == model.operationId)
        //                {
        //                    result = ProcessChargeReversal(twoFactorAuth, loanId, model.operationId, staffId);
        //                    if (result == true)
        //                    {
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.TenorChange == model.operationId)
        //                {
        //                    if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
        //                    {
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.tenor = model.newTenor;
        //                    }
        //                    else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
        //                    {
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.tenor = model.newTenor;
        //                        model.interestFirstpaymentDate = nextPaymentDate;
        //                    }
        //                    else
        //                    {
        //                        model.maturityDate = model.maturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.tenor = model.newTenor;
        //                        model.principalFirstpaymentDate = nextPaymentDate;
        //                        model.interestFirstpaymentDate = nextPaymentDate;
        //                    }

        //                    result = TenorExtension(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }

        //                else if ((int)OperationsEnum.LoanSales == model.operationId)
        //                {
        //                    result = LoanSales(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }

        //                else if ((int)OperationsEnum.Restructured == model.operationId)
        //                {
        //                    if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                    }
        //                    else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                        model.interestFrequency = (short)model.newInterestFrequency;
        //                        model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
        //                    }
        //                    else
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
        //                        model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                        model.interestFrequency = (short)model.newInterestFrequency;
        //                        model.principalFrequency = (short)model.newPrincipalFrequency;
        //                    }
        //                    result = Restructured(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.LoanWorkOut == model.operationId)
        //                {
        //                    model.interestRate = model.newInterest;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    model.scheduleMethodId = (short)LoanScheduleTypeEnum.IrregularSchedule;
        //                    result = LoanWorkOut(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }

        //                else if ((int)OperationsEnum.LoanRecapitilization == model.operationId)
        //                {
        //                    if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                    }
        //                    else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                        model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
        //                        model.interestFrequency = (short)model.newInterestFrequency;
        //                    }
        //                    else
        //                    {

        //                        model.interestRate = model.newInterest;
        //                        model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
        //                        model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                        model.interestFrequency = (short)model.newInterestFrequency;
        //                        model.principalFrequency = (short)model.newPrincipalFrequency;
        //                        model.scheduleMethodId = model.scheduleMethodId;
        //                    }
        //                    result = LoanRecapitilization(loanId, model, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.LoanRecovery == model.operationId)
        //                {
        //                    if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                    }
        //                    else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                        model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
        //                        model.interestFrequency = (short)model.newInterestFrequency;
        //                    }
        //                    else
        //                    {
        //                        model.interestRate = model.newInterest;
        //                        model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
        //                        model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
        //                        model.maturityDate = (DateTime)model.newMaturityDate;
        //                        model.effectiveDate = model.newEffectiveDate;
        //                        model.tenor = model.newTenor;
        //                        model.interestFrequency = (short)model.newInterestFrequency;
        //                        model.principalFrequency = (short)model.newPrincipalFrequency;
        //                    }

        //                    result = LoanRecovery(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.CASAAccountChange == model.operationId)
        //                {
        //                    result = ChangeOperativeAccount(model.oldCasaAccountId, (int)model.newCasaAccountId, loanId);
        //                    if (result == true)
        //                    {
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }

        //                else if ((int)OperationsEnum.LoanTermination == model.operationId)
        //                {
        //                    //model.interestRate = model.newInterest;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    //model.maturityDate = (DateTime)model.newMaturityDate;
        //                    result = LoanTermination(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }

        //                }
        //                else if ((int)OperationsEnum.CancelUndisbursedLoan == model.operationId)
        //                {
        //                    result = LoanCancellation(loanId, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }

        //                else if ((int)OperationsEnum.LoanReversal == model.operationId)
        //                {
        //                    model.interestRate = model.newInterest;
        //                    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
        //                    model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
        //                    model.maturityDate = (DateTime)model.newMaturityDate;
        //                    model.effectiveDate = model.newEffectiveDate;
        //                    model.tenor = model.newTenor;
        //                    model.interestFrequency = (short)model.newInterestFrequency;
        //                    model.principalFrequency = (short)model.newPrincipalFrequency;
        //                    result = LoanReversal(loanId, model, twoFactorAuth, applicationDate, staffId);
        //                    if (result == true)
        //                    {
        //                        updateLoanReviewOperation(loanReviewOperationsId, loanId);
        //                        output = true;
        //                    }
        //                    else
        //                    {
        //                        output = false;
        //                    }

        //                }
        //            }

        //        }


        //        context.SaveChanges();
        //        //-------------------------------------------------------

        //        return output;
        //    }
        //    catch (ConditionNotMetException ce)
        //    {
        //        throw new ConditionNotMetException(ce.Message);
        //    }
        //    catch (BadLogicException be)
        //    {
        //        throw new BadLogicException(be.Message);
        //    }
        //    catch (APIErrorException e)
        //    {
        //        throw new APIErrorException(e.Message);
        //    }
        //    catch (Exception e)
        //    {
        //        throw new ConditionNotMetException(e.Message);
        //    }


        //}

        #region contingient liability operations
        private bool CancelContingentLiability(TwoFactorAutheticationViewModel twoFactorAuth, LoanPaymentRestructureScheduleInputViewModel model, string approvalComment, int staffId)
        {
            bool result;
            List<FinanceTransactionViewModel> transactionDetails = new List<FinanceTransactionViewModel>();

            var oldContingent = context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == model.loanId);
            oldContingent.LOANSTATUSID = (int)LoanStatusEnum.Cancelled;//.CancelContingentLiability;
            result = context.SaveChanges() > 0;

            transactionDetails.AddRange(financeTransaction.BuildLoanContingentFeesReversal(oldContingent.LOANAPPLICATIONDETAILID, staffId));

            financeTransaction.PostTransaction(transactionDetails, false, twoFactorAuth);

            if (result)
            {
                return result;
            }
            else
            {
                return result;
            }

        }

        private bool ContingentLiabilityTerminateAndRebook(TwoFactorAutheticationViewModel twoFactorAuth, LoanPaymentRestructureScheduleInputViewModel model, string approvalComment)
        {
            bool result;
            bool output;
            result = ProcessContingentLiabilityTermination2(twoFactorAuth, model, approvalComment); // because of tranch rebooking loan status still maintain active

            if (result)
            {
                output = ProcessContingentLiabilityRenewal(twoFactorAuth, model, approvalComment);
                if (output)
                {
                    return output;
                }
                else
                {
                    return output;
                }
            }
            else
            {
                return result;
            }


        }

        private bool ProcessContingentLiabilityRenewal(TwoFactorAutheticationViewModel twoFactorAuth, LoanPaymentRestructureScheduleInputViewModel model, string approvalComment)
        {

            if (model.newMaturityDate < model.newEffectiveDate)
            {
                throw new ConditionNotMetException("Maturity Date cannot be less than Effective date");
            }


            //if (DoesOperationExist(model.loanId, model.operationId, (short)model.loanSystemTypeId))
            //{
            //    throw new ConditionNotMetException("The requested operation already exist and going through approval");
            //}

            var oldContingent = context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == model.loanId);

            if (model.operationId != (int)OperationsEnum.ContingentLiabilityTerminateAndRebook)
            {
                if (oldContingent.MATURITYDATE > model.newEffectiveDate)
                {
                    throw new ConditionNotMetException("Old Maturity Date cannot be more than the New Effective Date");
                }
            }


            bool output = false;

            //var renewalCharge = context.TBL_CHARGE_FEE.FirstOrDefault(x => x.OPERATIONID == (int)OperationsEnum.ContingentLiabilityRenewal);

            //decimal chargeAmount = 0;

            //if (renewalCharge != null)
            //{
            //    chargeAmount = (decimal)model.principalAmount;
            //}



            ResponseMessageViewModel renewalResult = new ResponseMessageViewModel();

            try
            {
                //model.productTypeId = (int)LoanSystemTypeEnum.OverdraftFacility;
                //var systemDate = generalSetup.GetApplicationDate();
                var currentDate = DateTime.Now;

                var loanReferenceNumber = loanGenerate.GenerateLoanReferenceNumber(oldContingent.BRANCHID, oldContingent.PRODUCTID, (int)LoanSystemTypeEnum.ContingentLiability);

                List<FinanceTransactionViewModel> transactionDetails = new List<FinanceTransactionViewModel>();

                //if (chargeAmount > 0)
                //{
                //    chargeDetails.AddRange(financeTransaction.BuildContingentChargeFeePosting(model, loanReferenceNumber, chargeAmount, renewalCharge.CHARGEFEEID, "Bond and Guarantee Renewal Fee ", (int)OperationsEnum.ContingentLiabilityRenewal));

                //    var debitAmount = chargeDetails.Sum(x => x.debitAmount);

                //    var balance = financeTransaction.GetCASABalance(model.newCasaAccountId.Value);
                //    if (balance.availableBalance < debitAmount)
                //    {
                //        throw new ConditionNotMetException($"Account balance of {balance.availableBalance} is not sufficient for the Bond and Guarantee Renewal Fee of {debitAmount}");
                //    }
                //}

                var operationRec = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == model.loanReviewOperationsId).FirstOrDefault();


                TBL_LOAN_CONTINGENT addContingent = new TBL_LOAN_CONTINGENT
                {
                    CUSTOMERID = oldContingent.CUSTOMERID,
                    LOANSYSTEMTYPEID = oldContingent.LOANSYSTEMTYPEID,
                    PRODUCTID = oldContingent.PRODUCTID,
                    COMPANYID = oldContingent.COMPANYID,
                    CASAACCOUNTID = oldContingent.CASAACCOUNTID,
                    BRANCHID = oldContingent.BRANCHID,
                    CURRENCYID = oldContingent.CURRENCYID,
                    LOANAPPLICATIONDETAILID = oldContingent.LOANAPPLICATIONDETAILID,
                    CONTINGENTAMOUNT = oldContingent.CONTINGENTAMOUNT,
                    EXCHANGERATE = oldContingent.EXCHANGERATE,
                    LOANREFERENCENUMBER = loanReferenceNumber,
                    RELATED_LOAN_REFERENCE_NUMBER = oldContingent.LOANREFERENCENUMBER,
                    SUBSECTORID = oldContingent.SUBSECTORID,
                    RELATIONSHIPOFFICERID = oldContingent.RELATIONSHIPOFFICERID,
                    RELATIONSHIPMANAGERID = oldContingent.RELATIONSHIPMANAGERID,
                    MISCODE = oldContingent.MISCODE,
                    TEAMMISCODE = oldContingent.TEAMMISCODE,
                    //INTERESTRATE = oldContingent.INTERESTRATE,
                    EFFECTIVEDATE = operationRec.EFFECTIVEDATE,// model.effectiveDate,
                    MATURITYDATE = Convert.ToDateTime(operationRec.MATURITYDATE), // model.maturityDate,
                    BOOKINGDATE = currentDate.Date,
                    //OVERDRAFTLIMIT = oldContingent.OVERDRAFTLIMIT,
                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved,
                    APPROVEDBY = model.createdBy,
                    APPROVERCOMMENT = approvalComment,
                    DATEAPPROVED = currentDate.Date,
                    LOANSTATUSID = (short)LoanStatusEnum.Active,
                    ISDISBURSED = true,
                    DISBURSEDBY = "",
                    DISBURSERCOMMENT = approvalComment,
                    DISBURSEDATE = currentDate,
                    OPERATIONID = model.operationId,
                    CREATEDBY = model.createdBy,
                    DATETIMECREATED = currentDate,
                    DISCHARGELETTER = true,
                    FIELD1 = oldContingent.FIELD1,
                    FIELD2 = oldContingent.FIELD2,
                    FIELD3 = oldContingent.FIELD3,
                    FIELD4 = oldContingent.FIELD4,
                    FIELD5 = oldContingent.FIELD5,
                    FIELD6 = oldContingent.FIELD6,
                    FIELD7 = oldContingent.FIELD7,
                    FIELD8 = oldContingent.FIELD8,
                    FIELD9 = oldContingent.FIELD9,
                    FIELD10 = oldContingent.FIELD10,
                    LEGALCONTINGENTCODE = operationRec.LEGALCONTINGENTCODE,
                };

                int operation;
                if (model.operationId == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook)
                {
                    operation = (int)OperationsEnum.ContingentLiabilityTerminateAndRebook;
                }
                else
                {
                    operation = (int)OperationsEnum.ContingentLiabilityRenewal;

                }

                transactionDetails.AddRange(financeTransaction.BuildContingentPrincipalPosting(model, loanReferenceNumber, addContingent.CONTINGENTAMOUNT, "Contingent Liability posting", operation));
                financeTransaction.PostTransaction(transactionDetails, false, twoFactorAuth);
                this.context.TBL_LOAN_CONTINGENT.Add(addContingent);

                //addOverDraft.SERIALNUMBER = renewalResult.serialNumber;
                var result = context.SaveChanges() > 0;

                if (renewalResult != null && result)
                {
                    var tempmedia = documentContext.TBL_TEMP_MEDIA_LOAN_DOCUMENTS.Where(x => x.TEMPLOANREVIEWOPERATIONID == model.loanReviewOperationsId).FirstOrDefault();

                    if (tempmedia != null) {
                        var data = new TBL_MEDIA_LOAN_DOCUMENTS
                        {
                            FILEDATA = tempmedia.FILEDATA,
                            DOCUMENTTITLE = tempmedia.DOCUMENTTITLE,
                            FILENAME = tempmedia.FILENAME,
                            FILEEXTENSION = tempmedia.FILEEXTENSION,
                            LOANREFERENCENUMBER = tempmedia.LOANREFERENCENUMBER,
                            LOANAPPLICATIONNUMBER = tempmedia.LOANAPPLICATIONNUMBER,
                            SYSTEMDATETIME = tempmedia.SYSTEMDATETIME,
                            CREATEDBY = tempmedia.CREATEDBY,
                            ISPRIMARYDOCUMENT = tempmedia.ISPRIMARYDOCUMENT,
                            COMPANYID = tempmedia.COMPANYID,
                            LOANSYSTEMTYPEID = tempmedia.LOANSYSTEMTYPEID,
                            LOANREVIEWOPERATIONID = tempmedia.TEMPLOANREVIEWOPERATIONID,
                            PHYSICALLOCATION = tempmedia.PHYSICALLOCATION,
                            DOCUMENTTYPEID = tempmedia.DOCUMENTTYPEID,
                        };

                        documentContext.TBL_MEDIA_LOAN_DOCUMENTS.Add(data);

                        try
                        {
                            documentContext.SaveChanges();
                        }
                        catch (Exception ex) { }
                    }

                    output = true;
                }
            }
            catch (Exception ex)
            {
                throw ex;
            }

            return output;
        }

        public bool ProcessContingentLiabilityTerminationAtMaturity(DateTime applicationDate)
        {
            //DateTime date = applicationDate;
            // TwoFactorAutheticationViewModel twoFactorAuth = new TwoFactorAutheticationViewModel();

            LoanPaymentRestructureScheduleInputViewModel _model = new LoanPaymentRestructureScheduleInputViewModel();

            var model = (context.TBL_LOAN_CONTINGENT.Where(x => x.APPROVALSTATUSID == (short)LoanStatusEnum.Active && x.MATURITYDATE == applicationDate)).ToList();

            bool output = false;


            try
            {

                List<FinanceTransactionViewModel> transactions = new List<FinanceTransactionViewModel>();


                foreach (var item in model)
                {
                    _model.loanId = item.CONTINGENTLOANID;
                    _model.principalAmount = (double)item.CONTINGENTAMOUNT;
                    _model.effectiveDate = item.EFFECTIVEDATE;
                    _model.maturityDate = item.MATURITYDATE;
                    _model.integralFeeAmount = 0;
                    _model.companyId = item.COMPANYID;
                    //_model.staffId = staffId;
                    _model.customerId = item.CUSTOMERID;
                    _model.productId = item.PRODUCTID;
                    _model.newCasaAccountId = item.CASAACCOUNTID;

                    if (item.CONTINGENTAMOUNT > 0)
                    {
                        transactions.AddRange(financeTransaction.BuildContingentPrincipalPostingReversal(_model, item.LOANREFERENCENUMBER, item.CONTINGENTAMOUNT, "Contingent Liability Amount at Maturity Reversal", (int)OperationsEnum.ContingentLiabilityTermination));
                    }

                }

                if (transactions.Count > 0)
                {
                    //financeTransaction.PostTransaction(chargeDetails, false, twoFactorAuth);

                    var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                    if (setup.USE_THIRD_PARTY_INTEGRATION)
                    {
                        BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                        output = bulkPosting.WriteBulkContingentLiabilityTerminationAtMaturityToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate);

                    }
                    else
                    {
                        if (transactions.Count > 0)
                            financeTransaction.PostTransaction(transactions);
                    }
                }


                foreach (var item in model)
                {
                    item.LOANSTATUSID = (short)LoanStatusEnum.Completed;
                    item.DATETIMEUPDATED = DateTime.Now.Date;
                    item.LASTUPDATEDBY = item.CREATEDBY;
                }

                var result = context.SaveChanges() > 0;

            }
            catch (Exception ex)
            {

                throw ex;

            }

            return true;

        }

        public bool ProcessContingentLiabilityTermination(TwoFactorAutheticationViewModel twoFactorAuth, LoanPaymentRestructureScheduleInputViewModel model, string approvalComment)
        {

            var oldContingent = context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == model.loanId);

            bool output = false;

            //var penalCharge = context.TBL_CHARGE_FEE.FirstOrDefault(x => x.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTermination);


            //decimal chargeAmount = 0;

            //if (penalCharge != null)
            //{
            //    chargeAmount = (decimal)model.principalAmount;
            //}



            ResponseMessageViewModel renewalResult = new ResponseMessageViewModel();

            try
            {

                var currentDate = DateTime.Now;

                List<FinanceTransactionViewModel> transactionDetails = new List<FinanceTransactionViewModel>();

                //List<FinanceTransactionViewModel> principalDetails = new List<FinanceTransactionViewModel>();

                //if (chargeAmount > 0)
                //{
                //    chargeDetails.AddRange(financeTransaction.BuildContingentChargeFeePosting(model, oldContingent.LOANREFERENCENUMBER, chargeAmount, penalCharge.CHARGEFEEID, "Penal Charge ", (int)OperationsEnum.ContingentLiabilityRenewal));
                //}

                var loan = this.context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == model.loanId);

                if (loan.CONTINGENTAMOUNT > 0)
                {
                    transactionDetails.AddRange(financeTransaction.BuildContingentPrincipalPostingReversal(model, oldContingent.LOANREFERENCENUMBER, loan.CONTINGENTAMOUNT, "Contingent Amount ", (int)OperationsEnum.ContingentLiabilityTermination));
                }


                //var feeAmount = context.TBL_LOAN_FEE.Where(x => x.LOANID == model.loanId && x.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability).GroupBy(c => c.LOANID).Select(g => new { LOANID = g.Key, total = g.Sum(i => i.FEEAMOUNT) }).FirstOrDefault();

                //var feeDetails = context.TBL_LOAN_FEE.Where(x => x.LOANID == model.loanId && x.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability).ToList();

                //foreach (var item in feeDetails)
                //{



                //    var unEarnedFee = DailyAccruedInterest(oldContingent.EFFECTIVEDATE, oldContingent.MATURITYDATE, item.FEEAMOUNT) * DateDiff(model.effectiveDate, oldContingent.MATURITYDATE);

                //    if (unEarnedFee > 0)
                //    {
                //        chargeDetails.AddRange(financeTransaction.BuildContingentUnEarnedFeePostingReversal(model, oldContingent.LOANREFERENCENUMBER, unEarnedFee, item.CHARGEFEEID, "UnEarned Fee for Contingent Liability", (int)OperationsEnum.ContingentLiabilityTermination));
                //    }
                //}



                if (transactionDetails.Count > 0)
                {
                    //financeTransaction.PostTransaction(transactionDetails, false, twoFactorAuth);
                }


                oldContingent.LOANSTATUSID = (short)LoanStatusEnum.Terminated;
                oldContingent.DATETIMEUPDATED = DateTime.Now.Date;
                oldContingent.LASTUPDATEDBY = model.createdBy;

                var result = context.SaveChanges() > 0;

                if (renewalResult != null != false && result)
                {
                    var tempmedia = documentContext.TBL_TEMP_MEDIA_LOAN_DOCUMENTS.Where(x => x.TEMPLOANREVIEWOPERATIONID == model.loanReviewOperationsId).FirstOrDefault();
                    if (tempmedia != null)
                    {
                        var data = new TBL_MEDIA_LOAN_DOCUMENTS
                        {
                            FILEDATA = tempmedia.FILEDATA,
                            DOCUMENTTITLE = tempmedia.DOCUMENTTITLE,
                            FILENAME = tempmedia.FILENAME,
                            FILEEXTENSION = tempmedia.FILEEXTENSION,
                            LOANREFERENCENUMBER = tempmedia.LOANREFERENCENUMBER,
                            LOANAPPLICATIONNUMBER = tempmedia.LOANAPPLICATIONNUMBER,
                            SYSTEMDATETIME = tempmedia.SYSTEMDATETIME,
                            CREATEDBY = tempmedia.CREATEDBY,
                            ISPRIMARYDOCUMENT = tempmedia.ISPRIMARYDOCUMENT,
                            COMPANYID = tempmedia.COMPANYID,
                            LOANSYSTEMTYPEID = tempmedia.LOANSYSTEMTYPEID,
                            LOANREVIEWOPERATIONID = tempmedia.TEMPLOANREVIEWOPERATIONID,
                            PHYSICALLOCATION = tempmedia.PHYSICALLOCATION,
                            DOCUMENTTYPEID = tempmedia.DOCUMENTTYPEID,

                        };

                        documentContext.TBL_MEDIA_LOAN_DOCUMENTS.Add(data);
                        try
                        {
                            documentContext.SaveChanges();
                        }
                        catch (Exception ex) { }
                        var outcome = SendNotification((int)model.loanId, data.LOANREVIEWOPERATIONID);
                    }
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;

            }

            return output;
        }

        public bool ProcessContingentLiabilityTermination2(TwoFactorAutheticationViewModel twoFactorAuth, LoanPaymentRestructureScheduleInputViewModel model, string approvalComment)
        {

            var oldContingent = context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == model.loanId);
            bool output = false;

            ResponseMessageViewModel renewalResult = new ResponseMessageViewModel();

            try
            {

                var currentDate = DateTime.Now;

                List<FinanceTransactionViewModel> transactionDetails = new List<FinanceTransactionViewModel>();

                var loan = this.context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == model.loanId);

                if (loan.CONTINGENTAMOUNT > 0)
                {
                    transactionDetails.AddRange(financeTransaction.BuildContingentPrincipalPostingReversal(model, oldContingent.LOANREFERENCENUMBER, loan.CONTINGENTAMOUNT, "Contingent Amount ", (int)OperationsEnum.ContingentLiabilityTermination));
                }

                oldContingent.LOANSTATUSID = (short)LoanStatusEnum.Active;
                oldContingent.DATETIMEUPDATED = DateTime.Now.Date;
                oldContingent.LASTUPDATEDBY = model.createdBy;

                var result = context.SaveChanges() > 0;

                if (renewalResult != null != false && result)
                {
                    var tempmedia = documentContext.TBL_TEMP_MEDIA_LOAN_DOCUMENTS.Where(x => x.TEMPLOANREVIEWOPERATIONID == model.loanReviewOperationsId).FirstOrDefault();
                    if (tempmedia != null)
                    {
                        var data = new TBL_MEDIA_LOAN_DOCUMENTS
                        {
                            FILEDATA = tempmedia.FILEDATA,
                            DOCUMENTTITLE = tempmedia.DOCUMENTTITLE,
                            FILENAME = tempmedia.FILENAME,
                            FILEEXTENSION = tempmedia.FILEEXTENSION,
                            LOANREFERENCENUMBER = tempmedia.LOANREFERENCENUMBER,
                            LOANAPPLICATIONNUMBER = tempmedia.LOANAPPLICATIONNUMBER,
                            SYSTEMDATETIME = tempmedia.SYSTEMDATETIME,
                            CREATEDBY = tempmedia.CREATEDBY,
                            ISPRIMARYDOCUMENT = tempmedia.ISPRIMARYDOCUMENT,
                            COMPANYID = tempmedia.COMPANYID,
                            LOANSYSTEMTYPEID = tempmedia.LOANSYSTEMTYPEID,
                            LOANREVIEWOPERATIONID = tempmedia.TEMPLOANREVIEWOPERATIONID,
                            PHYSICALLOCATION = tempmedia.PHYSICALLOCATION,
                            DOCUMENTTYPEID = tempmedia.DOCUMENTTYPEID,

                        };

                        documentContext.TBL_MEDIA_LOAN_DOCUMENTS.Add(data);
                        try
                        {
                            documentContext.SaveChanges();
                        }
                        catch (Exception ex) { }
                        var outcome = SendNotification((int)model.loanId, data.LOANREVIEWOPERATIONID);
                    }
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;

            }

            return output;
        }

        public bool SendNotification(int loanId, int? loanOperationReviewId)
        {
            TBL_MONITORING_ALERT_SETUP alertsetupForTerminatedBG = (from x in context.TBL_MONITORING_ALERT_SETUP
                                                                    where x.MONITORING_ITEMID == (int)AlertMessageEnum.TerminatedBG
                                                                    select x).FirstOrDefault();
            List<LoanContingentViewModel> loanDetails = (from a in context.TBL_LOAN_CONTINGENT
                                                         join c in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals c.STAFFID
                                                         join d in context.TBL_STAFF on a.RELATIONSHIPOFFICERID equals d.STAFFID
                                                         where a.CONTINGENTLOANID == loanId
                                                         select new LoanContingentViewModel
                                                         {
                                                             companyId = a.COMPANYID,
                                                             contingentAmount = a.CONTINGENTAMOUNT,
                                                             effectiveDate = a.EFFECTIVEDATE,
                                                             dueDate = a.MATURITYDATE,
                                                             loanId = a.CONTINGENTLOANID,
                                                             loanRefNumber = a.LOANREFERENCENUMBER,
                                                             productName = context.TBL_PRODUCT.Where(m => m.PRODUCTID == a.PRODUCTID).Select(p => p.PRODUCTNAME).FirstOrDefault(),
                                                             relationshipManager = c.FIRSTNAME + " " + c.LASTNAME,
                                                             managerEmail = c.EMAIL,
                                                             relationshipOfficer = d.FIRSTNAME + " " + d.LASTNAME,
                                                             officerEmail = d.EMAIL,
                                                         }).ToList();
            var result = SendAlertsForTerminatedBGRM(loanDetails, alertsetupForTerminatedBG.MESSAGE_TITLE, loanOperationReviewId);
            var result2 = false;
            if (alertsetupForTerminatedBG.RECIPIENTEMAILS1.Trim() != string.Empty)
            {
                List<LoanContingentViewModel> escalationLevelOne = (from x in loanDetails
                                                                    where x.notificationDuration <= alertsetupForTerminatedBG.NOTIFICATION_PERIOD1
                                                                    select x).ToList();
                if (escalationLevelOne.Count != 0)
                {
                    result2 = SendAlertsForTerminatedBGMonitoringTeam(loanDetails, alertsetupForTerminatedBG, loanOperationReviewId);
                }
            }

            if (result == true)
            {
                return result2;
            }
            else
            {
                return result;
            }
        }


        public int SaveMessageDetails(MessageLogViewModel model, int? loanReviewOperationsId)
        {
            var message = new TBL_MESSAGE_LOG()
            {
                //MessageId = model.MessageId,
                MESSAGESUBJECT = model.MessageSubject,
                MESSAGEBODY = model.MessageBody,
                MESSAGESTATUSID = model.MessageStatusId,
                MESSAGETYPEID = model.MessageTypeId,
                FROMADDRESS = model.FromAddress,
                TOADDRESS = model.ToAddress,
                DATETIMERECEIVED = model.DateTimeReceived,
                SENDONDATETIME = model.SendOnDateTime,
                ATTACHMENTTYPEID = (int)AttachementTypeEnum.ContingentTermination,
                ATTACHMENTCODE = Convert.ToString(loanReviewOperationsId),
            };

            context.TBL_MESSAGE_LOG.Add(message);

            try
            {
                return context.SaveChanges();
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public bool SendAlertsForTerminatedBGRM(List<LoanContingentViewModel> loanDetails, string title, int? loanReviewOperationsId)
        {
            bool response = false;

            try
            {
                List<TBL_STAFF> staffList = context.TBL_STAFF.ToList();
                List<int> dataList = (from g in loanDetails
                                      select g.relationshipManagerId).ToList();

                var review = context.TBL_LOAN_REVIEW_OPERATION.Find(loanReviewOperationsId);

                var RMdetail = (from x in staffList
                                where dataList.Contains(x.STAFFID)
                                select x).ToList();

                foreach (TBL_STAFF item2 in RMdetail)
                {

                    var bankManagerID = staffList.Where(o => o.STAFFCODE == item2.STAFFCODE).FirstOrDefault().SUPERVISOR_STAFFID;
                    var bankManagerEmail = staffList.Where(o => o.STATEID == item2.STATEID).FirstOrDefault().EMAIL;

                    string recipient = item2.EMAIL.Trim() + ";" + bankManagerEmail;
                    List<LoanContingentViewModel> mailList = (from x in loanDetails
                                                              where x.relationshipManagerId == item2.STAFFID
                                                              select x).ToList();
                    string dataTable2 = "<table><tr><th>Name Of Beneficiary</th><th>Type Of Bond</th><th>Bond Amount</th><th>Date Issued</th><th>Ref. Number</th></tr>";
                    foreach (LoanContingentViewModel item3 in mailList)
                    {
                        var custname = context.TBL_LOAN_CONTINGENT.Where(a => a.CONTINGENTLOANID == item3.loanId).Select(w => w.TBL_CUSTOMER.FIRSTNAME + " " + w.TBL_CUSTOMER.MAIDENNAME + " " + w.TBL_CUSTOMER.LASTNAME).FirstOrDefault();
                        dataTable2 = dataTable2 + $"<tr><td>{custname}</td><td>APG</td><td>{String.Format("{0:#,##0.##}", item3.contingentAmount)}</td>" + $"<td>{item3.effectiveDate.ToLongDateString()}</td><td>{item3.loanRefNumber}</td></tr>";
                    }
                    dataTable2 += "</table>";
                    string messageSubject = ConfigurationManager.AppSettings["messageSubject"] + " " + title;
                    string messageContent = string.Format("Dear {0}, <br /><br />", item2.FIRSTNAME + " " + item2.LASTNAME) + "Kindly be Informed that the attached bond with the following details which was called in, has been cancelled,<br /> Reason: " + review.REVIEWDETAILS + " <br /> <br />" + $"{dataTable2}" + "<br /> <br /> The Business / Relationship Manager should therefore ensure that all parties to the bond instrument are adviced of the development.<br /> <br /> Meanwhile, Kindly acknowledge this mail. <br /> <br />";
                    string additionalRecipient = loanDetails.FirstOrDefault((LoanContingentViewModel x) => x.relationshipManagerId == item2.STAFFID).officerEmail;
                    string templateUrl = @"~/EmailTemplates/Monitoring.html";
                    string mailBody = EmailHelpers.PopulateBody(messageContent, templateUrl);
                    MessageLogViewModel messageModel = new MessageLogViewModel
                    {
                        MessageSubject = messageSubject,
                        MessageBody = mailBody,
                        MessageStatusId = 1,
                        MessageTypeId = 1,
                        FromAddress = ConfigurationManager.AppSettings["SupportEmailAddr"],
                        ToAddress = $"{recipient};{additionalRecipient}",
                        DateTimeReceived = DateTime.Now,
                        SendOnDateTime = DateTime.Now,

                    };
                    if (SaveMessageDetails(messageModel, loanReviewOperationsId) != 0)
                    {
                        return response = true;
                    }
                    else
                    {
                        return response = false;
                    }
                }
            }
            catch (Exception ex)
            {
                throw ex;
            }
            return response;
        }
        public bool SendAlertsForTerminatedBGMonitoringTeam(List<LoanContingentViewModel> loanDetails, TBL_MONITORING_ALERT_SETUP alertSetups, int? loanReviewOperationsId)
        {
            bool response = false;
            try
            {
                string recipient = alertSetups.RECIPIENTEMAILS2.Trim();
                string dataTable = "<table><tr><th>Name Of Beneficiary</th><th>Type Of Bond</th><th>Bond Amount</th><th>Date Issued</th><th>Ref. Number</th></tr>";
                foreach (LoanContingentViewModel item3 in loanDetails)
                {
                    var custname = context.TBL_LOAN_CONTINGENT.Where(a => a.CONTINGENTLOANID == item3.loanId).Select(w => w.TBL_CUSTOMER.FIRSTNAME + " " + w.TBL_CUSTOMER.MAIDENNAME + " " + w.TBL_CUSTOMER.LASTNAME).FirstOrDefault();
                    dataTable = dataTable + $"<tr><td>{custname}</td><td>APG</td><td>{String.Format("{0:#,##0.##}", item3.contingentAmount)}</td>" + $"<td>{item3.effectiveDate.ToLongDateString()}</td><td>{item3.loanRefNumber}</td></tr>";
                }
                var review = context.TBL_LOAN_REVIEW_OPERATION.Find(loanReviewOperationsId);

                dataTable += "</table>";
                string messageSubject = alertSetups.MESSAGE_TITLE;
                string messageContent = string.Format("Dear Team, <br /><br /> Kindly be Informed that the attached bond with the following details which was called in, has been cancelled, <br /> Reason: " + review.REVIEWDETAILS + " <br /> <br />" + $"{dataTable}" + "<br /> <br /> The Business / Relationship Manager should therefore ensure that all parties to the bond instrument are adviced of the development.<br /> <br /> Meanwhile, Kindly acknowledge this mail. <br /> <br />");

                string templateUrl = @"~/EmailTemplates/Monitoring.html";
                string mailBody = EmailHelpers.PopulateBody(messageContent, templateUrl);
                MessageLogViewModel messageModel = new MessageLogViewModel
                {
                    MessageSubject = messageSubject,
                    MessageBody = mailBody,
                    MessageStatusId = 1,
                    MessageTypeId = 1,
                    FromAddress = ConfigurationManager.AppSettings["SupportEmailAddr"],
                    ToAddress = $"{recipient}",
                    DateTimeReceived = DateTime.Now,
                    SendOnDateTime = DateTime.Now
                };
                if (SaveMessageDetails(messageModel, loanReviewOperationsId) != 0)
                {
                    response = true;
                }
                else
                {
                    response = false;
                }
            }
            catch (Exception ex)
            {
                throw ex;
            }
            return response;

        }

        public bool ContingentLiabilityTenorExtension(TwoFactorAutheticationViewModel twoFactorAuth, LoanPaymentRestructureScheduleInputViewModel model, string approvalComment)
        {

            //if (DoesOperationExist(model.loanId, model.operationId, (short)model.loanSystemTypeId))
            //{
            //    throw new ConditionNotMetException("The requested operation already exist and going through approval");
            //}

            var oldContingent = context.TBL_LOAN_CONTINGENT.Where(x => x.CONTINGENTLOANID == model.loanId).FirstOrDefault();
            oldContingent.MATURITYDATE = (DateTime)model.newMaturityDate;

            bool output = false;

            try
            {

                var applicationDate = generalSetup.GetApplicationDate();
                var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);

                var currentDate = DateTime.Now;

                TBL_LOAN_CONTINGENT_ARCHIVE addContingent = new TBL_LOAN_CONTINGENT_ARCHIVE
                {
                    ARCHIVEDATE = applicationDate,
                    ARCHIVEBATCHCODE = archiveBatchCode,
                    CONTINGENTLOANID = oldContingent.CONTINGENTLOANID,
                    CUSTOMERID = oldContingent.CUSTOMERID,
                    LOANSYSTEMTYPEID = oldContingent.LOANSYSTEMTYPEID,
                    PRODUCTID = oldContingent.PRODUCTID,
                    COMPANYID = oldContingent.COMPANYID,
                    CASAACCOUNTID = oldContingent.CASAACCOUNTID,
                    BRANCHID = oldContingent.BRANCHID,
                    CURRENCYID = oldContingent.CURRENCYID,
                    LOANAPPLICATIONDETAILID = oldContingent.LOANAPPLICATIONDETAILID,
                    CONTINGENTAMOUNT = oldContingent.CONTINGENTAMOUNT,
                    EXCHANGERATE = oldContingent.EXCHANGERATE,
                    LOANREFERENCENUMBER = oldContingent.LOANREFERENCENUMBER,
                    RELATED_LOAN_REFERENCE_NUMBER = oldContingent.LOANREFERENCENUMBER,
                    SUBSECTORID = oldContingent.SUBSECTORID,
                    RELATIONSHIPOFFICERID = oldContingent.RELATIONSHIPOFFICERID,
                    RELATIONSHIPMANAGERID = oldContingent.RELATIONSHIPMANAGERID,
                    MISCODE = oldContingent.MISCODE,
                    TEAMMISCODE = oldContingent.TEAMMISCODE,
                    EFFECTIVEDATE = model.effectiveDate,
                    MATURITYDATE = model.maturityDate,
                    BOOKINGDATE = currentDate.Date,
                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved,
                    APPROVEDBY = model.createdBy,
                    APPROVERCOMMENT = approvalComment,
                    DATEAPPROVED = currentDate.Date,
                    LOANSTATUSID = (short)LoanStatusEnum.Active,
                    ISDISBURSED = true,
                    DISBURSEDBY = "",
                    DISBURSERCOMMENT = approvalComment,
                    DISBURSEDATE = currentDate,
                    OPERATIONID = model.operationId,
                    CREATEDBY = model.createdBy,
                    DATETIMECREATED = currentDate,
                    DISCHARGELETTER = true,
                    FIELD1 = oldContingent.FIELD1,
                    FIELD2 = oldContingent.FIELD2,
                    FIELD3 = oldContingent.FIELD3,
                    FIELD4 = oldContingent.FIELD4,
                    FIELD5 = oldContingent.FIELD5,
                    FIELD6 = oldContingent.FIELD6,
                    FIELD7 = oldContingent.FIELD7,
                    FIELD8 = oldContingent.FIELD8,
                    FIELD9 = oldContingent.FIELD9,
                    FIELD10 = oldContingent.FIELD10,
                    LEGALCONTINGENTCODE = oldContingent.LEGALCONTINGENTCODE,

                };

                this.context.TBL_LOAN_CONTINGENT_ARCHIVE.Add(addContingent);

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;

            }

            return output;
        }

        public bool ContingentLiabilityAmountReduction(TwoFactorAutheticationViewModel twoFactorAuth, LoanPaymentRestructureScheduleInputViewModel model, string approvalComment)
        {

            //if (DoesOperationExist(model.loanId, model.operationId, (short)model.loanSystemTypeId))
            //{
            //    throw new ConditionNotMetException("The requested operation already exist and going through approval");
            //}

            var oldContingent = context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == model.loanId);
            oldContingent.CONTINGENTAMOUNT = oldContingent.CONTINGENTAMOUNT - (decimal)model.principalAmount;

            bool output = false;

            try
            {

                var applicationDate = generalSetup.GetApplicationDate();
                var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);

                var currentDate = DateTime.Now;

                List<FinanceTransactionViewModel> chargeDetails = new List<FinanceTransactionViewModel>();

                TBL_LOAN_CONTINGENT_ARCHIVE addContingent = new TBL_LOAN_CONTINGENT_ARCHIVE
                {
                    ARCHIVEDATE = applicationDate,
                    ARCHIVEBATCHCODE = archiveBatchCode,
                    CONTINGENTLOANID = oldContingent.CONTINGENTLOANID,
                    CUSTOMERID = oldContingent.CUSTOMERID,
                    LOANSYSTEMTYPEID = oldContingent.LOANSYSTEMTYPEID,
                    PRODUCTID = oldContingent.PRODUCTID,
                    COMPANYID = oldContingent.COMPANYID,
                    CASAACCOUNTID = oldContingent.CASAACCOUNTID,
                    BRANCHID = oldContingent.BRANCHID,
                    CURRENCYID = oldContingent.CURRENCYID,
                    LOANAPPLICATIONDETAILID = oldContingent.LOANAPPLICATIONDETAILID,
                    CONTINGENTAMOUNT = oldContingent.CONTINGENTAMOUNT,
                    EXCHANGERATE = oldContingent.EXCHANGERATE,
                    LOANREFERENCENUMBER = oldContingent.LOANREFERENCENUMBER,
                    RELATED_LOAN_REFERENCE_NUMBER = oldContingent.LOANREFERENCENUMBER,
                    SUBSECTORID = oldContingent.SUBSECTORID,
                    RELATIONSHIPOFFICERID = oldContingent.RELATIONSHIPOFFICERID,
                    RELATIONSHIPMANAGERID = oldContingent.RELATIONSHIPMANAGERID,
                    MISCODE = oldContingent.MISCODE,
                    TEAMMISCODE = oldContingent.TEAMMISCODE,
                    EFFECTIVEDATE = model.effectiveDate,
                    MATURITYDATE = model.maturityDate,
                    BOOKINGDATE = currentDate.Date,
                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved,
                    APPROVEDBY = model.createdBy,
                    APPROVERCOMMENT = approvalComment,
                    DATEAPPROVED = currentDate.Date,
                    LOANSTATUSID = (short)LoanStatusEnum.Active,
                    ISDISBURSED = true,
                    DISBURSEDBY = "",
                    DISBURSERCOMMENT = approvalComment,
                    DISBURSEDATE = currentDate,
                    OPERATIONID = model.operationId,
                    CREATEDBY = model.createdBy,
                    DATETIMECREATED = currentDate,
                    DISCHARGELETTER = true,
                    FIELD1 = oldContingent.FIELD1,
                    FIELD2 = oldContingent.FIELD2,
                    FIELD3 = oldContingent.FIELD3,
                    FIELD4 = oldContingent.FIELD4,
                    FIELD5 = oldContingent.FIELD5,
                    FIELD6 = oldContingent.FIELD6,
                    FIELD7 = oldContingent.FIELD7,
                    FIELD8 = oldContingent.FIELD8,
                    FIELD9 = oldContingent.FIELD9,
                    FIELD10 = oldContingent.FIELD10,

                };


                chargeDetails.AddRange(financeTransaction.BuildContingentPrincipalPostingReduction(model, oldContingent.LOANREFERENCENUMBER, (decimal)model.principalAmount, "Contingent Liability posting", (int)OperationsEnum.ContingentLiabilityAmountReduction));

                financeTransaction.PostTransaction(chargeDetails, false, twoFactorAuth);

                this.context.TBL_LOAN_CONTINGENT_ARCHIVE.Add(addContingent);

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;

            }

            return output;
        }

        public bool ContingentLiabilityAmountAddition(TwoFactorAutheticationViewModel twoFactorAuth, LoanPaymentRestructureScheduleInputViewModel model, string approvalComment)
        {

            //if (DoesOperationExist(model.loanId, model.operationId, (short)model.loanSystemTypeId))
            //{
            //    throw new ConditionNotMetException("The requested operation already exist and going through approval");
            //}

            var oldContingent = context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == model.loanId);
            oldContingent.CONTINGENTAMOUNT = oldContingent.CONTINGENTAMOUNT + (decimal)model.principalAmount;

            bool output = false;

            try
            {

                var applicationDate = generalSetup.GetApplicationDate();
                var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);

                var currentDate = DateTime.Now;

                List<FinanceTransactionViewModel> chargeDetails = new List<FinanceTransactionViewModel>();

                TBL_LOAN_CONTINGENT_ARCHIVE addContingent = new TBL_LOAN_CONTINGENT_ARCHIVE
                {
                    ARCHIVEDATE = applicationDate,
                    ARCHIVEBATCHCODE = archiveBatchCode,
                    CONTINGENTLOANID = oldContingent.CONTINGENTLOANID,
                    CUSTOMERID = oldContingent.CUSTOMERID,
                    LOANSYSTEMTYPEID = oldContingent.LOANSYSTEMTYPEID,
                    PRODUCTID = oldContingent.PRODUCTID,
                    COMPANYID = oldContingent.COMPANYID,
                    CASAACCOUNTID = oldContingent.CASAACCOUNTID,
                    BRANCHID = oldContingent.BRANCHID,
                    CURRENCYID = oldContingent.CURRENCYID,
                    LOANAPPLICATIONDETAILID = oldContingent.LOANAPPLICATIONDETAILID,
                    CONTINGENTAMOUNT = oldContingent.CONTINGENTAMOUNT,
                    EXCHANGERATE = oldContingent.EXCHANGERATE,
                    LOANREFERENCENUMBER = oldContingent.LOANREFERENCENUMBER,
                    RELATED_LOAN_REFERENCE_NUMBER = oldContingent.LOANREFERENCENUMBER,
                    SUBSECTORID = oldContingent.SUBSECTORID,
                    RELATIONSHIPOFFICERID = oldContingent.RELATIONSHIPOFFICERID,
                    RELATIONSHIPMANAGERID = oldContingent.RELATIONSHIPMANAGERID,
                    MISCODE = oldContingent.MISCODE,
                    TEAMMISCODE = oldContingent.TEAMMISCODE,
                    EFFECTIVEDATE = model.effectiveDate,
                    MATURITYDATE = model.maturityDate,
                    BOOKINGDATE = currentDate.Date,
                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved,
                    APPROVEDBY = model.createdBy,
                    APPROVERCOMMENT = approvalComment,
                    DATEAPPROVED = currentDate.Date,
                    LOANSTATUSID = (short)LoanStatusEnum.Active,
                    ISDISBURSED = true,
                    DISBURSEDBY = "",
                    DISBURSERCOMMENT = approvalComment,
                    DISBURSEDATE = currentDate,
                    OPERATIONID = model.operationId,
                    CREATEDBY = model.createdBy,
                    DATETIMECREATED = currentDate,
                    DISCHARGELETTER = true,
                    FIELD1 = oldContingent.FIELD1,
                    FIELD2 = oldContingent.FIELD2,
                    FIELD3 = oldContingent.FIELD3,
                    FIELD4 = oldContingent.FIELD4,
                    FIELD5 = oldContingent.FIELD5,
                    FIELD6 = oldContingent.FIELD6,
                    FIELD7 = oldContingent.FIELD7,
                    FIELD8 = oldContingent.FIELD8,
                    FIELD9 = oldContingent.FIELD9,
                    FIELD10 = oldContingent.FIELD10,

                };


                chargeDetails.AddRange(financeTransaction.BuildContingentPrincipalPosting(model, oldContingent.LOANREFERENCENUMBER, (decimal)model.principalAmount, "Contingent Liability posting", (int)OperationsEnum.ContingentLiabilityAmountReduction));

                financeTransaction.PostTransaction(chargeDetails, false, twoFactorAuth);

                this.context.TBL_LOAN_CONTINGENT_ARCHIVE.Add(addContingent);

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    output = true;
                }
            }
            catch (Exception ex)
            {

                throw ex;

            }

            return output;
        }

        #endregion

        //[OperationBehavior(TransactionScopeRequired = true)]
        public bool LoanRephasementProcess(TwoFactorAutheticationViewModel twoFactorAuth, int loanReviewOperationsId, int loanId, int staffId, LoanSystemTypeEnum facilityType, [Optional] string approvalComment)
        {
            try
            {
                bool output = false;
                bool result = false;
                var dynamicMessage = string.Empty;
                //if (facilityType == LoanSystemTypeEnum.OverdraftFacility)

                //var checkForOverDraft = this.context.TBL_LOAN_REVOLVING.FirstOrDefault(x => x.REVOLVINGLOANID == loanId);
                if (facilityType == LoanSystemTypeEnum.OverdraftFacility)  //if (checkForOverDraft != null && facilityType == 0)
                {
                    var model = (
                                 from a in context.TBL_LOAN_REVIEW_OPERATION
                                 join b in context.TBL_LOAN_REVOLVING on a.LOANID equals b.REVOLVINGLOANID
                                 where b.LOANSTATUSID == (short)LoanStatusEnum.Active && a.LOANID == loanId && a.OPERATIONCOMPLETED == false
                                 && a.LOANREVIEWOPERATIONID == loanReviewOperationsId

                                 select new LoanPaymentRestructureScheduleInputViewModel()
                                 {
                                     loanId = b.REVOLVINGLOANID,
                                     loanReviewApplicationId = a.LOANREVIEWAPPLICATIONID,
                                     principalAmount = (double)b.OVERDRAFTLIMIT,
                                     interestRate = b.INTERESTRATE,
                                     effectiveDate = a.EFFECTIVEDATE,
                                     maturityDate = b.MATURITYDATE,
                                     integralFeeAmount = 0,
                                     newEffectiveDate = a.EFFECTIVEDATE,
                                     newInterestFirstpaymentDate = (DateTime)a.INTERESTFIRSTPAYMENTDATE,
                                     newInterest = (double)a.INTERATERATE,
                                     newAmount = (double?)a.OVERDRAFTTOPUP ?? 0,
                                     operationId = a.OPERATIONTYPEID,
                                     newPrincipalFirstpaymentDate = (DateTime)a.PRINCIPALFIRSTPAYMENTDATE,
                                     isManagementInterestRate = a.ISMANAGEMENTINTERESTRATE,
                                     proposedTenor = a.TENOR,
                                     newMaturityDate = a.MATURITYDATE,// change to maturity date affter scarfolding
                                     companyId = b.COMPANYID,
                                     staffId = staffId,
                                     createdBy = staffId,
                                     customerId = b.CUSTOMERID,
                                     productId = b.PRODUCTID,
                                 }).FirstOrDefault();
                    string appDate = model.newEffectiveDate.ToString(@"yyyy-MM-dd");
                    var applicationDate = Convert.ToDateTime(appDate);
                    if ((int)OperationsEnum.OverdraftTopup == model.operationId)
                    {

                        result = OverdraftTopUp(twoFactorAuth, loanId, (decimal)model.newAmount);

                        //EarnUnEarnedFee(loanId, (short)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }
                    }
                    else if ((int)OperationsEnum.OverdraftRenewal == model.operationId)
                    {
                        result = OverdraftRenewal(twoFactorAuth, loanReviewOperationsId, loanId, (decimal)model.newAmount);

                        //EarnUnEarnedFee(loanId, (short)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }
                    }
                    else if ((int)OperationsEnum.OverdraftTenorExtension == model.operationId)
                    {
                        result = OverdraftExtension(twoFactorAuth, loanId, (decimal)model.newAmount);

                        //EarnUnEarnedFee(loanId, (short)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }
                    }
                    else if ((int)OperationsEnum.OverdraftSubAllocation == model.operationId)
                    {
                        result = SubAllocation(twoFactorAuth, loanId, (decimal)model.newAmount, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (short)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }
                    }
                    else if ((int)OperationsEnum.OverdraftInterestRate == model.operationId)
                    {
                        result = OverdraftInterestRate(twoFactorAuth, loanId);

                        //EarnUnEarnedFee(loanId, (short)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }
                    }

                    //}
                }
                //else if (facilityType == LoanSystemTypeEnum.TermDisbursedFacility)

                else if (facilityType == LoanSystemTypeEnum.TermDisbursedFacility)  //(checkForOverDraft == null && facilityType == 0)
                {
                    var scheduleMethod = this.context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId).SCHEDULETYPEID;
                    var record = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == loanReviewOperationsId).FirstOrDefault();
                    var operationType = record.OPERATIONTYPEID;

                    var model = (
                             from a in context.TBL_LOAN_REVIEW_OPERATION
                             join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                             where
                             //b.LOANSTATUSID == (short)LoanStatusEnum.Active && 
                             a.LOANID == loanId && a.OPERATIONCOMPLETED == false
                             && a.LOANREVIEWOPERATIONID == loanReviewOperationsId
                             select new LoanPaymentRestructureScheduleInputViewModel()
                             {
                                 loanId = b.TERMLOANID,
                                 loanReviewApplicationId = a.LOANREVIEWAPPLICATIONID,
                                 scheduleMethodId = (short)b.SCHEDULETYPEID,
                                 principalAmount = (double)b.OUTSTANDINGPRINCIPAL,
                                 principalFrequency = b.PRINCIPALFREQUENCYTYPEID,
                                 interestFrequency = b.INTERESTFREQUENCYTYPEID,
                                 principalFirstpaymentDate = (DateTime)b.FIRSTPRINCIPALPAYMENTDATE,
                                 interestFirstpaymentDate = (DateTime)b.FIRSTINTERESTPAYMENTDATE,
                                 principalFrequencyTypeId = b.PRINCIPALFREQUENCYTYPEID,
                                 interestFrequencyTypeId = b.INTERESTFREQUENCYTYPEID,
                                 interestRate = b.INTERESTRATE,
                                 currencyId = b.CURRENCYID,
                                 effectiveDate = b.EFFECTIVEDATE,
                                 maturityDate = b.MATURITYDATE,
                                 accrualBasis = b.SCHEDULEDAYCOUNTCONVENTIONID,
                                 firstDayType = b.SCHEDULEDAYINTERESTTYPEID,
                                 integralFeeAmount = 0,
                                 newEffectiveDate = a.EFFECTIVEDATE,
                                 newMaturityDate = a.MATURITYDATE,// change to maturity date affter scarfolding
                                 newInterestFrequency = (short?)a.INTERESTFREQUENCYTYPEID ?? (short)b.INTERESTFREQUENCYTYPEID,
                                 newPrincipalFrequency = (short?)a.PRINCIPALFREQUENCYTYPEID ?? (short)b.PRINCIPALFREQUENCYTYPEID,
                                 newInterestFirstpaymentDate = (DateTime)a.INTERESTFIRSTPAYMENTDATE,
                                 newInterest = (double)a.INTERATERATE,
                                 payAmount = (double?)a.PREPAYMENT ?? 0,
                                 operationId = a.OPERATIONTYPEID,
                                 operationTypeId = a.OPERATIONTYPEID,
                                 newPrincipalFirstpaymentDate = (DateTime)a.PRINCIPALFIRSTPAYMENTDATE,
                                 isManagementInterestRate = a.ISMANAGEMENTINTERESTRATE,
                                 proposedTenor = a.TENOR,
                                 companyId = b.COMPANYID,
                                 staffId = staffId,
                                 createdBy = staffId,
                                 customerId = b.CUSTOMERID,
                                 productId = b.PRODUCTID,
                                 oldCasaAccountId = b.CASAACCOUNTID,
                                 newCasaAccountId = a.CASA_ACCOUNTID,
                                 prepaymentMethodId = a.PREPAYMENTMETHODID,

                             }).FirstOrDefault();


                    if (scheduleMethod == (short)LoanScheduleTypeEnum.IrregularSchedule)
                    {
                        List<IrregularLoanScheduleInputViewModel> irregularSchedule = new List<IrregularLoanScheduleInputViewModel>();
                        {
                            var scheduleInput = context.TBL_LOAN_REVIEW_OPRATN_IREG_SC.Where(x => x.LOANREVIEWOPERATIONID == loanReviewOperationsId);

                            foreach (var model2 in scheduleInput)
                            {
                                irregularSchedule.Add(new IrregularLoanScheduleInputViewModel { paymentAmount = (double)model2.PAYMENTAMOUNT, paymentDate = model2.PAYMENTDATE });
                            }

                            model.irregularPaymentSchedule = irregularSchedule;
                        }
                    }

                    var unEarnedFees = (from d in context.TBL_LOAN_SCHEDULE_DAILY
                                        where d.LOANID == model.loanId
                                        //let sumUnEarnedFee = context.TBL_LOAN_SCHEDULE_DAILY.Where(a => a.LOANID == model.loanId
                                        && d.DATE >= DbFunctions.TruncateTime(model.newEffectiveDate) // .Sum(a => (double?)a.UNEARNEDFEE ?? 0)
                                        select d.UNEARNEDFEE).ToList();

                    //var unEarnedFee = from d in context.TBL_LOAN_SCHEDULE_DAILY
                    //                  where d.LOANID == model.loanId
                    //                  let sumUnEarnedFee = context.TBL_LOAN_SCHEDULE_DAILY.Where(a => a.LOANID == model.loanId
                    //                  && a.DATE >= DbFunctions.TruncateTime(model.newEffectiveDate)).Sum(a => (double?)a.UNEARNEDFEE ?? 0)
                    //                  select sumUnEarnedFee;

                    model.integralFeeAmount = 0;
                    if (unEarnedFees.Count > 0)
                        model.integralFeeAmount = (double)unEarnedFees.Sum();

                    //model.integralFeeAmount = (double?)unEarnedFee.FirstOrDefault() ?? 0;

                    string appDate = model.newEffectiveDate.ToString(@"yyyy-MM-dd");
                    var applicationDate = Convert.ToDateTime(appDate);

                    DateTime nextPaymentDate = DateTime.Now.Date;

                    if (model.maturityDate > model.newEffectiveDate)
                    {
                        var paymentDate = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
                                           where a.LOANID == loanId && a.PAYMENTDATE >= applicationDate
                                           select a).FirstOrDefault();

                        if (paymentDate != null)
                        {
                            nextPaymentDate = paymentDate.PAYMENTDATE;
                        }
                        else
                        {
                            throw new SecureException("Application Date not found in Payment Schedule");
                        }
                    }

                    if ((int)OperationsEnum.ContractualInterestRateChange == model.operationId)
                    {
                        if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
                        {
                            model.interestRate = model.newInterest;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenor;
                        }
                        else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
                        {
                            model.interestRate = model.newInterest;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenor;
                            model.principalFirstpaymentDate = nextPaymentDate;
                            model.interestFirstpaymentDate = nextPaymentDate;
                        }
                        else
                        {
                            model.interestRate = model.newInterest;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenor;
                            model.principalFirstpaymentDate = nextPaymentDate;
                            model.interestFirstpaymentDate = nextPaymentDate;
                        }

                        //if (model.interestFirstpaymentDate <= model.effectiveDate)
                        //{
                        //    throw new ConditionNotMetException("First Payment Date must be greater than Effective Date");
                        //}

                        var loanData = context.TBL_LOAN.Where(c => c.TERMLOANID == loanId).FirstOrDefault();

                        model.maturityDate = loanData.MATURITYDATE;

                        model.isExistingFacility = true;

                        result = InterestRateReview(loanId, model, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }


                    }
                    else if ((int)OperationsEnum.Prepayment == model.operationId)
                    {
                        if (model.isManagementInterestRate == true)
                        {
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenorPrepayment;
                            model.interestFirstpaymentDate = nextPaymentDate;
                            model.principalFirstpaymentDate = nextPaymentDate;
                        }
                        else
                        {
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenorPrepayment;
                            model.interestFirstpaymentDate = nextPaymentDate;
                            model.principalFirstpaymentDate = nextPaymentDate;
                        }

                        result = ProcessLoanPrepayment(twoFactorAuth, loanId, model, applicationDate, staffId, loanReviewOperationsId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.PaymentDateChange == model.operationId)
                    {
                        if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
                        {
                            model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
                        }
                        else
                        {
                            model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
                            model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;
                        }


                        result = PaymentDateChange(loanId, model, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            updateLoanPrincipalInterestPaymentDate(model.interestFirstpaymentDate, model.principalFirstpaymentDate, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }


                    }
                    else if ((int)OperationsEnum.PrincipalFrequencyChange == model.operationId || (int)OperationsEnum.InterestFrequencyChange == model.operationId
                        || (int)OperationsEnum.InterestandPrincipalFrequencyChange == model.operationId)
                    {
                        if ((int)OperationsEnum.PrincipalFrequencyChange == model.operationId)
                        {
                            if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment || scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
                            {
                                model.principalFrequency = (short)model.newPrincipalFrequency;
                                model.interestFrequency = (short)model.newPrincipalFrequency;
                            }
                            else
                            {
                                model.principalFrequency = (short)model.newPrincipalFrequency;
                                model.interestFrequency = (short)model.interestFrequency;
                            }

                        }
                        if ((int)OperationsEnum.InterestFrequencyChange == model.operationId)
                        {
                            if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment || scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
                            {
                                model.interestFrequency = (short)model.newInterestFrequency;
                                model.principalFrequency = (short)model.newInterestFrequency;
                            }
                            else
                            {
                                model.interestFrequency = (short)model.newInterestFrequency;
                                model.principalFrequency = (short)model.principalFrequency;
                            }

                        }
                        if ((int)OperationsEnum.InterestandPrincipalFrequencyChange == model.operationId)
                        {
                            model.interestFrequency = (short)model.newInterestFrequency;
                            model.principalFrequency = (short)model.newPrincipalFrequency;
                        }

                        var loanData = context.TBL_LOAN.Where(x => x.TERMLOANID == loanId).FirstOrDefault();

                        model.maturityDate = loanData.MATURITYDATE;

                        model.isExistingFacility = true;

                        result = PaymentFrequencyChange(loanId, model, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            updateLoanFrequency((short)model.principalFrequency, (short)model.interestFrequency, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.CompleteWriteOff == model.operationId)
                    {
                        //model.interestRate = model.newInterest;
                        //model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
                        //model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
                        //model.maturityDate = (DateTime)model.newMaturityDate;
                        model.effectiveDate = model.newEffectiveDate;
                        //model.tenor = model.newTenor;
                        //model.interestFrequency = (short)model.newInterestFrequency;
                        //model.principalFrequency = (short)model.newPrincipalFrequency;

                        result = CompleteWriteOff(loanId, model, twoFactorAuth, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.FullAndFinalCompleteWriteOff == model.operationId)
                    {
                        //model.interestRate = model.newInterest;
                        //model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
                        //model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
                        //model.maturityDate = (DateTime)model.newMaturityDate;
                        model.effectiveDate = model.newEffectiveDate;
                        //model.tenor = model.newTenor;
                        //model.interestFrequency = (short)model.newInterestFrequency;
                        //model.principalFrequency = (short)model.newPrincipalFrequency;

                        result = FullAndFinalCompleteWriteOff(loanId, model, twoFactorAuth, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.TerminateAndRebook == model.operationId)
                    {
                        TerminateAndRebookLoanSchedule(loanId, model, twoFactorAuth, applicationDate, staffId);
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        var data = (
                                    from b in context.TBL_LOAN
                                    where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.RELATED_LOAN_REFERENCE_NUMBER == loan.LOANREFERENCENUMBER
                                    select new LoanPaymentRestructureScheduleInputViewModel()
                                    {
                                        loanId = b.TERMLOANID,
                                        scheduleMethodId = b.SCHEDULETYPEID,
                                        principalAmount = (double)b.OUTSTANDINGPRINCIPAL,
                                        principalFrequency = b.PRINCIPALFREQUENCYTYPEID,
                                        interestFrequency = b.INTERESTFREQUENCYTYPEID,
                                        principalFirstpaymentDate = (DateTime)b.FIRSTPRINCIPALPAYMENTDATE,
                                        interestFirstpaymentDate = (DateTime)b.FIRSTINTERESTPAYMENTDATE,
                                        interestRate = b.INTERESTRATE,
                                        effectiveDate = b.EFFECTIVEDATE,
                                        maturityDate = b.MATURITYDATE,
                                        accrualBasis = b.SCHEDULEDAYCOUNTCONVENTIONID,
                                        firstDayType = b.SCHEDULEDAYINTERESTTYPEID,
                                        integralFeeAmount = 0,
                                        companyId = b.COMPANYID,
                                        staffId = staffId,
                                        createdBy = staffId,
                                        customerId = b.CUSTOMERID,

                                    }).FirstOrDefault();

                        result = RegenerateSchedule((int)data.loanId, data, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.GlobalInterestRateChange == model.operationId)
                    {
                        var product = context.TBL_PRODUCT.Where(p => p.PRODUCTID == model.productId)?.FirstOrDefault();
                        result = ProcessGlobalInterestRepricing(model.newEffectiveDate, (int)product.PRODUCTPRICEINDEXID, (short)model.staffId);

                        if (result == true)
                        {
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.Fee_chargeChange == model.operationId)
                    {
                        result = ProcessChargeReversal(twoFactorAuth, loanId, model.operationId, staffId, loanReviewOperationsId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.TenorChange == model.operationId)
                    {
                        if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
                        {
                            model.effectiveDate = model.newEffectiveDate;
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.tenor = model.newTenor;
                        }
                        else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
                        {
                            model.effectiveDate = model.newEffectiveDate;
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.tenor = model.newTenor;
                            model.interestFirstpaymentDate = nextPaymentDate;
                        }
                        else
                        {
                            model.maturityDate = model.maturityDate;
                            model.effectiveDate = model.newEffectiveDate;
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.tenor = model.newTenor;
                            model.principalFirstpaymentDate = nextPaymentDate;
                            model.interestFirstpaymentDate = nextPaymentDate;
                        }

                        result = TenorExtension(loanId, model, applicationDate, staffId);

                        // EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.LoanSales == model.operationId)
                    {
                        result = LoanSales(loanId, model, twoFactorAuth, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.Restructured == model.operationId)
                    {
                        if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
                        {
                            model.interestRate = model.newInterest;
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenor;
                        }
                        else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
                        {
                            model.interestRate = model.newInterest;
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenor;
                            model.interestFrequency = (short)model.newInterestFrequency;
                            model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
                        }
                        else
                        {
                            var refNo = context.TBL_LOAN.Where(x => x.TERMLOANID == model.loanId).FirstOrDefault();

                            model.principalAmount = (double)GetRunningLoanOpeningBalance(model.companyId, refNo.LOANREFERENCENUMBER, model.newEffectiveDate).principalAmount;
                            model.interestRate = model.newInterest;
                            model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
                            model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenor;
                            model.interestFrequency = (short)model.newInterestFrequency;
                            model.principalFrequency = (short)model.newPrincipalFrequency;
                        }



                        result = Restructured(loanId, model, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.LoanWorkOut == model.operationId)
                    {
                        model.interestRate = model.newInterest;
                        model.effectiveDate = model.newEffectiveDate;
                        model.scheduleMethodId = (short)LoanScheduleTypeEnum.IrregularSchedule;

                        result = LoanWorkOut(loanId, model, applicationDate, staffId);

                        // EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.LoanRecapitilization == model.operationId)
                    {
                        if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
                        {
                            model.interestRate = model.newInterest;
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenor;
                        }
                        else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
                        {
                            model.interestRate = model.newInterest;
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenor;
                            model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
                            model.interestFrequency = (short)model.newInterestFrequency;
                            model.interestFrequencyTypeId = (short)model.newInterestFrequency;
                        }
                        else
                        {

                            model.interestRate = model.newInterest;
                            model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
                            model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
                            model.maturityDate = (DateTime)model.newMaturityDate;
                            model.effectiveDate = model.newEffectiveDate;
                            model.tenor = model.newTenor;
                            model.interestFrequency = (short)model.newInterestFrequency;
                            model.principalFrequency = (short)model.newPrincipalFrequency;
                            model.interestFrequencyTypeId = (short)model.newInterestFrequency;
                            model.principalFrequencyTypeId = (short)model.newPrincipalFrequency;
                            model.scheduleMethodId = model.scheduleMethodId;
                        }


                        model.interestRate = model.newInterest;
                        model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
                        model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
                        model.maturityDate = (DateTime)model.newMaturityDate;
                        model.effectiveDate = model.newEffectiveDate;
                        model.tenor = model.newTenor;

                        model.interestFrequency = (short)model.newInterestFrequency;
                        model.principalFrequency = (short)model.newPrincipalFrequency;
                        model.interestFrequencyTypeId = (short)model.newInterestFrequency;
                        model.principalFrequencyTypeId = (short)model.newPrincipalFrequency;

                        result = LoanRecapitilization(loanId, model, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.LoanRecovery == model.operationId)
                    {
                        //if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
                        //{
                        //    model.interestRate = model.newInterest;
                        //    model.maturityDate = (DateTime)model.newMaturityDate;
                        //    model.effectiveDate = model.newEffectiveDate;
                        //    model.tenor = model.newTenor;
                        //}
                        //else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
                        //{
                        //    model.interestRate = model.newInterest;
                        //    model.maturityDate = (DateTime)model.newMaturityDate;
                        //    model.effectiveDate = model.newEffectiveDate;
                        //    model.tenor = model.newTenor;
                        //    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
                        //    model.interestFrequency = (short)model.newInterestFrequency;
                        //}
                        //else
                        //{
                        //    model.interestRate = model.newInterest;
                        //    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
                        //    model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
                        //    model.maturityDate = (DateTime)model.newMaturityDate;
                        //    model.effectiveDate = model.newEffectiveDate;
                        //    model.tenor = model.newTenor;
                        //    model.interestFrequency = (short)model.newInterestFrequency;
                        //    model.principalFrequency = (short)model.newPrincipalFrequency;
                        //}

                        result = LoanRecovery(loanId, model, twoFactorAuth, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.LoanRecoveryPayment == model.operationId)
                    {
                        //if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
                        //{
                        //    model.interestRate = model.newInterest;
                        //    model.maturityDate = (DateTime)model.newMaturityDate;
                        //    model.effectiveDate = model.newEffectiveDate;
                        //    model.tenor = model.newTenor;
                        //}
                        //else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
                        //{
                        //    model.interestRate = model.newInterest;
                        //    model.maturityDate = (DateTime)model.newMaturityDate;
                        //    model.effectiveDate = model.newEffectiveDate;
                        //    model.tenor = model.newTenor;
                        //    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
                        //    model.interestFrequency = (short)model.newInterestFrequency;
                        //}
                        //else
                        //{
                        //    model.interestRate = model.newInterest;
                        //    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
                        //    model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
                        //    model.maturityDate = (DateTime)model.newMaturityDate;
                        //    model.effectiveDate = model.newEffectiveDate;
                        //    model.tenor = model.newTenor;
                        //    model.interestFrequency = (short)model.newInterestFrequency;
                        //    model.principalFrequency = (short)model.newPrincipalFrequency;
                        //}

                        result = LoanRecoveryPayment(loanId, model, twoFactorAuth, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.LoanRecoveryCompletion == model.operationId)
                    {
                        //if (scheduleMethod == (short)LoanScheduleTypeEnum.BallonPayment)
                        //{
                        //    model.interestRate = model.newInterest;
                        //    model.maturityDate = (DateTime)model.newMaturityDate;
                        //    model.effectiveDate = model.newEffectiveDate;
                        //    model.tenor = model.newTenor;
                        //}
                        //else if (scheduleMethod == (short)LoanScheduleTypeEnum.BulletPayment)
                        //{
                        //    model.interestRate = model.newInterest;
                        //    model.maturityDate = (DateTime)model.newMaturityDate;
                        //    model.effectiveDate = model.newEffectiveDate;
                        //    model.tenor = model.newTenor;
                        //    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;
                        //    model.interestFrequency = (short)model.newInterestFrequency;
                        //}
                        //else
                        //{
                        //    model.interestRate = model.newInterest;
                        //    model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
                        //    model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
                        //    model.maturityDate = (DateTime)model.newMaturityDate;
                        //    model.effectiveDate = model.newEffectiveDate;
                        //    model.tenor = model.newTenor;
                        //    model.interestFrequency = (short)model.newInterestFrequency;
                        //    model.principalFrequency = (short)model.newPrincipalFrequency;
                        //}

                        result = LoanRecoveryCompletion(loanId, model, twoFactorAuth, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.CASAAccountChange == model.operationId)
                    {
                        result = ChangeOperativeAccount(model.oldCasaAccountId, (int)model.newCasaAccountId, loanId, facilityType);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    //else if ((int)OperationsEnum.CASAAccountChange == model.operationId)
                    //{
                    //    result = ChangeOperativeAccount(model.oldCasaAccountId, (int)model.newCasaAccountId, loanId, facilityType);

                    //    //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                    //    if (result == true)
                    //    {
                    //        output = true;
                    //    }
                    //    else
                    //    {
                    //        output = false;
                    //    }

                    //}
                    else if ((int)OperationsEnum.LoanTermination == model.operationId)
                    {
                        //model.interestRate = model.newInterest;
                        model.effectiveDate = model.newEffectiveDate;
                        //model.maturityDate = (DateTime)model.newMaturityDate;
                        result = LoanTermination(loanId, model, twoFactorAuth, applicationDate, staffId);

                        EarnUnEarnedFee(loanId, (short)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }

                    }
                    else if ((int)OperationsEnum.CancelUndisbursedLoan == model.operationId)
                    {
                        result = LoanCancellation(loanId, applicationDate, staffId);

                        // EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.LoanReversal == model.operationId)
                    {
                        model.interestRate = model.newInterest;
                        model.interestFirstpaymentDate = (DateTime)model.newInterestFirstpaymentDate;//nextPaymentDate;
                        model.principalFirstpaymentDate = (DateTime)model.newPrincipalFirstpaymentDate;//nextPaymentDate;
                        model.maturityDate = (DateTime)model.newMaturityDate;
                        model.effectiveDate = model.newEffectiveDate;
                        model.tenor = model.newTenor;
                        model.interestFrequency = (short)model.newInterestFrequency;
                        model.principalFrequency = (short)model.newPrincipalFrequency;

                        result = LoanReversal(loanId, model, twoFactorAuth, applicationDate, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            updateLoanReviewOperation(loanReviewOperationsId, loanId);
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }


                }

                else if (facilityType == LoanSystemTypeEnum.ContingentLiability)
                {

                    var model = (
                                from a in context.TBL_LOAN_REVIEW_OPERATION
                                join b in context.TBL_LOAN_CONTINGENT on a.LOANID equals b.CONTINGENTLOANID
                                where
                                //b.LOANSTATUSID == (short)LoanStatusEnum.Active && 
                                a.LOANID == loanId && a.OPERATIONCOMPLETED == false
                                && a.LOANREVIEWOPERATIONID == loanReviewOperationsId

                                select new LoanPaymentRestructureScheduleInputViewModel()
                                {
                                    loanReviewOperationsId = a.LOANREVIEWOPERATIONID,
                                    loanReviewApplicationId = a.LOANREVIEWAPPLICATIONID,
                                    loanId = b.CONTINGENTLOANID,
                                    principalAmount = (double)a.PREPAYMENT,
                                    loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                    //interestRate = b.INTERESTRATE,
                                    effectiveDate = b.EFFECTIVEDATE,
                                    maturityDate = b.MATURITYDATE,
                                    integralFeeAmount = 0,
                                    newEffectiveDate = a.EFFECTIVEDATE,
                                    newInterestFirstpaymentDate = (DateTime)a.INTERESTFIRSTPAYMENTDATE,
                                    newInterest = (double)a.INTERATERATE,
                                    newAmount = (double?)a.OVERDRAFTTOPUP ?? 0,
                                    operationId = a.OPERATIONTYPEID,
                                    newPrincipalFirstpaymentDate = (DateTime)a.PRINCIPALFIRSTPAYMENTDATE,
                                    isManagementInterestRate = a.ISMANAGEMENTINTERESTRATE,
                                    proposedTenor = a.TENOR,
                                    newMaturityDate = a.MATURITYDATE,// change to maturity date affter scarfolding
                                    companyId = b.COMPANYID,
                                    staffId = staffId,
                                    createdBy = staffId,
                                    customerId = b.CUSTOMERID,
                                    productId = b.PRODUCTID,
                                    newCasaAccountId = b.CASAACCOUNTID
                                }).FirstOrDefault();

                    string appDate = model.newEffectiveDate.ToString(@"yyyy-MM-dd");
                    var applicationDate = Convert.ToDateTime(appDate);

                    //var contingent = context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == loanId);

                    if ((int)OperationsEnum.ContingentLiabilityRenewal == model.operationId)
                    {
                        result = ProcessContingentLiabilityRenewal(twoFactorAuth, model, approvalComment);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }
                    }
                    else if ((int)OperationsEnum.ContingentLiabilityTermination == model.operationId)
                    {

                        result = ProcessContingentLiabilityTermination(twoFactorAuth, model, approvalComment);

                        //EarnUnEarnedFee(loanId, (short)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.ContingentLiabilityTenorExtension == model.operationId)
                    {

                        result = ContingentLiabilityTenorExtension(twoFactorAuth, model, approvalComment);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.ContingentLiabilityAmountReduction == model.operationId)
                    {

                        result = ContingentLiabilityAmountReduction(twoFactorAuth, model, approvalComment);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.ContingentLiabilityAmountAddition == model.operationId)
                    {

                        result = ContingentLiabilityAmountAddition(twoFactorAuth, model, approvalComment);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.ContingentLiabilityTerminateAndRebook == model.operationId)
                    {

                        result = ContingentLiabilityTerminateAndRebook(twoFactorAuth, model, approvalComment);

                        //EarnUnEarnedFee(loanId, (int)facilityType, applicationDate, loanReviewOperationsId);

                        if (result == true)
                        {
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }
                    else if ((int)OperationsEnum.CancelContingentLiability == model.operationId)
                    {
                        var inactiveBG = (from a in context.TBL_LOAN_REVIEW_OPERATION
                                          join b in context.TBL_LOAN_CONTINGENT on a.LOANID equals b.CONTINGENTLOANID
                                          where a.LOANID == loanId && a.OPERATIONCOMPLETED == false
                                          && a.LOANREVIEWOPERATIONID == loanReviewOperationsId

                                          select new LoanPaymentRestructureScheduleInputViewModel()
                                          {
                                              loanId = b.CONTINGENTLOANID,
                                              principalAmount = (double)a.PREPAYMENT,
                                              loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                              //interestRate = b.INTERESTRATE,
                                              effectiveDate = b.EFFECTIVEDATE,
                                              maturityDate = b.MATURITYDATE,
                                              integralFeeAmount = 0,
                                              newEffectiveDate = a.EFFECTIVEDATE,
                                              newInterestFirstpaymentDate = (DateTime)a.INTERESTFIRSTPAYMENTDATE,
                                              newInterest = (double)a.INTERATERATE,
                                              newAmount = (double?)a.OVERDRAFTTOPUP ?? 0,
                                              operationId = a.OPERATIONTYPEID,
                                              newPrincipalFirstpaymentDate = (DateTime)a.PRINCIPALFIRSTPAYMENTDATE,
                                              isManagementInterestRate = a.ISMANAGEMENTINTERESTRATE,
                                              proposedTenor = a.TENOR,
                                              newMaturityDate = a.MATURITYDATE,// change to maturity date affter scarfolding
                                              companyId = b.COMPANYID,
                                              staffId = staffId,
                                              createdBy = staffId,
                                              customerId = b.CUSTOMERID,
                                              productId = b.PRODUCTID,
                                              newCasaAccountId = b.CASAACCOUNTID
                                          }).FirstOrDefault();

                        string _appDate = inactiveBG.newEffectiveDate.ToString(@"yyyy-MM-dd");
                        var _applicationDate = Convert.ToDateTime(appDate);


                        result = CancelContingentLiability(twoFactorAuth, inactiveBG, approvalComment, staffId);

                        //EarnUnEarnedFee(loanId, (int)facilityType, _applicationDate, loanReviewOperationsId);

                        if (result)
                        {
                            output = true;
                        }
                        else
                        {
                            output = false;
                        }

                    }

                }

                context.SaveChanges();
                //-------------------------------------------------------

                return true;
                //return output;
            }
            catch (ConditionNotMetException ce)
            {
                throw new ConditionNotMetException(ce.Message);
            }
            catch (BadLogicException be)
            {
                throw new BadLogicException(be.Message);
            }
            catch (APIErrorException e)
            {
                throw new APIErrorException(e.Message);
            }
            catch (Exception e)
            {
                throw new ConditionNotMetException(e.Message);
            }


        }


        private string GetBusinessUsersEmailsToGroupHead(string accountOfficerMIsCode)
        {
            string emailList = "";

            var accountOfficer = context.TBL_STAFF.Where(x => x.MISCODE.ToLower() == accountOfficerMIsCode.ToLower()).FirstOrDefault();
            if (accountOfficer != null)
            {
                emailList = accountOfficer.EMAIL;
                if (accountOfficer.SUPERVISOR_STAFFID != null)
                {
                    var relationshipManager = context.TBL_STAFF.Where(x => x.STAFFID == accountOfficer.SUPERVISOR_STAFFID).FirstOrDefault();
                    if (relationshipManager != null)
                    {
                        emailList = emailList + ";" + relationshipManager.EMAIL;
                        if (relationshipManager.SUPERVISOR_STAFFID != null)
                        {
                            var zonalHead = context.TBL_STAFF.Where(x => x.STAFFID == relationshipManager.SUPERVISOR_STAFFID).FirstOrDefault();
                            if (zonalHead != null)
                            {
                                emailList = emailList + ";" + zonalHead.EMAIL;

                                var groupHead = context.TBL_STAFF.Where(x => x.STAFFID == zonalHead.SUPERVISOR_STAFFID).FirstOrDefault();

                                if (groupHead != null)
                                {
                                    emailList = emailList + ";" + groupHead.EMAIL;
                                }
                            }
                        }
                    }
                }

            }

            return emailList;
        }

        public bool DocumentDeferral(int loanId)
        {
            bool output = false;
            var systemDate = generalSetup.GetApplicationDate();

            var data = (from a in context.TBL_LOAN
                        join b in context.TBL_CHECKLIST_DETAIL on a.LOANAPPLICATIONDETAILID equals b.TARGETID
                        where b.TARGETTYPEID == (short)CheckListTargetTypeEnum.LoanApplicationProductChecklist && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                        && b.CHECKLISTSTATUSID == (short)CheckListStatusEnum.Deferred && DbFunctions.TruncateTime(b.DEFEREDDATE) >= DbFunctions.TruncateTime(systemDate)
                        select new LoanRepaymentViewModel()
                        {
                            loanId = a.TERMLOANID,
                            checklistId = (int)b.CHECKLISTID,
                            loanRefNo = a.LOANREFERENCENUMBER,
                            loanApplicationNumberId = a.LOANAPPLICATIONDETAILID,
                            periodPrincipalAmount = a.OUTSTANDINGPRINCIPAL,
                            periodInterestAmount = a.OUTSTANDINGINTEREST,
                            productId = a.PRODUCTID,
                            casaAccountId = a.CASAACCOUNTID,
                            branchId = a.BRANCHID,
                            companyId = a.COMPANYID,
                            currencyId = a.CURRENCYID,
                            exchangeRate = a.EXCHANGERATE,
                            createdBy = a.CREATEDBY,
                            dateTimeCreated = a.DATETIMECREATED,

                        }).ToList();

            foreach (var item in data)
            {
                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == item.productId);
                var forceDebitCode = CommonHelpers.GenerateRandomDigitCode(10);

                List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

                inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodInterestAmount, product.INTERESTRECEIVABLEPAYABLEGL.Value, "interest repayment Debt as a result of Defer Document", (int)OperationsEnum.InterestLoanRepayment));

                inputTransactions.Add(financeTransaction.PostBuildLoanRepaymentPosting(item, item.periodPrincipalAmount, product.PRINCIPALBALANCEGL.Value, "principal repayment Debt as a result of Defer Document", (int)OperationsEnum.PrincipalLoanRepayment));

                //financeTransaction.PostTransaction(inputTransactions);

            }

            context.SaveChanges();

            output = true;

            return output;
        }

        public bool SinkingFund(int loanId)
        {
            bool output = false;
            var systemDate = generalSetup.GetApplicationDate();

            var covenant = from a in context.TBL_LOAN
                           join b in context.TBL_LOAN_COVENANT_DETAIL on a.TERMLOANID equals b.LOANID
                           where a.TERMLOANID == loanId
                           let percentage = b.ISPERCENTAGE
                           select percentage;
            if (covenant.FirstOrDefault() == false)
            {
                var covenantAmount = from a in context.TBL_LOAN
                                     join b in context.TBL_LOAN_COVENANT_DETAIL on a.TERMLOANID equals b.LOANID
                                     join c in context.TBL_LOAN_COVENANT_TYPE on b.COVENANTTYPEID equals c.COVENANTTYPEID
                                     where b.COVENANTTYPEID == c.COVENANTTYPEID && a.TERMLOANID == b.LOANID
                                     && c.COVENANTTYPEID == (short)LoanCovenantTypeEnum.SinkingFund && a.TERMLOANID == loanId
                                     && b.NEXTCOVENANTDATE == DbFunctions.TruncateTime(systemDate)
                                     select b.COVENANTAMOUNT;
            }
            else
            {
                var covenantRate = from a in context.TBL_LOAN
                                   join b in context.TBL_LOAN_COVENANT_DETAIL on a.TERMLOANID equals b.LOANID
                                   join c in context.TBL_LOAN_COVENANT_TYPE on b.COVENANTTYPEID equals c.COVENANTTYPEID
                                   where b.COVENANTTYPEID == c.COVENANTTYPEID && a.TERMLOANID == b.LOANID
                                   && c.COVENANTTYPEID == (short)LoanCovenantTypeEnum.SinkingFund && a.TERMLOANID == loanId
                                   && b.NEXTCOVENANTDATE == DbFunctions.TruncateTime(systemDate)
                                   select b.COVENANTAMOUNT;
            }

            context.SaveChanges();

            output = true;

            return output;


        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool AutomaticInterestRepricing(DateTime applicationDate)
        {
            bool output = false;
            var systemDate = generalSetup.GetApplicationDate();


            //var dailyRepricing = (from d in context.TBL_PRODUCT_PRICE_INDEX_DAILY
            //                      join e in context.TBL_PRODUCT_PRICE_INDEX on d.PRICEINDEXRATE equals e.PRICEINDEXRATE
            //                      join f in context.TBL_LOAN on e.PRODUCTPRICEINDEXID equals f.PRODUCTPRICEINDEXID
            //                      where f.NEXT_INTEREST_REPRICINGDATE  == DbFunctions.TruncateTime(applicationDate)
            //                      //where d.DATE >= DbFunctions.TruncateTime(applicationDate.AddDays(-(e.DURATION))) && d.DATE <= DbFunctions.TruncateTime(applicationDate)
            //                      select new
            //                      {
            //                          d.PRICEINDEXRATE,
            //                          d.DATE,
            //                          e.DURATION
            //                      }).ToList();
            //var sumdailyRepricing = dailyRepricing.Select(c => c.PRICEINDEXRATE).Sum();
            //var sumdailyRepricing = dailyRepricing.Where(x => x.DATE >= DbFunctions.TruncateTime(applicationDate.AddDays(-(x.DURATION))) && x.DATE <= DbFunctions.TruncateTime(applicationDate));


            /// update the price index rate
            //context.SaveChanges();

            output = true;

            return output;

        }

        public IEnumerable<LoanFeeOperationViewModel> GetLoanChargeFeeByLoanId(int loanId)
        {
            var chargeFee = (from a in context.TBL_LOAN_FEE
                             where a.LOANID == loanId
                             select new LoanFeeOperationViewModel()
                             {
                                 loanId = a.LOANID,
                                 loanFeeId = a.LOANCHARGEFEEID,
                                 chargeFeeId = a.CHARGEFEEID,
                                 chargeFeeName = a.TBL_CHARGE_FEE.CHARGEFEENAME,
                                 feeAmount = a.FEEAMOUNT,
                                 feeRateValue = a.FEERATEVALUE,
                                 feeEarnedAmount = a.EARNEDFEEAMOUNT,
                                 feeUnearnedAmount = (a.FEEAMOUNT - a.EARNEDFEEAMOUNT)
                             }).ToList();
            return chargeFee;
        }

        public bool WriteBulkPostingToStaging(DateTime applicationDate, string TransactionType, string batchCode)
        {
            bool output = false;
            var data = (from a in context.TBL_CUSTOM_TRANSACTION_BULK
                        where a.VALUEDATE == DbFunctions.TruncateTime(applicationDate) && a.BATCHID == batchCode
                        select new FinanceTransactionStagingViewModel()
                        {
                            batchId = a.BATCHID,
                            batchRefId = a.BATCHREFID,
                            transType = a.TRANSACTIONTYPE,
                            flowType = a.FLOWTYPE,
                            amount = a.AMOUNT,
                            debitGlAccount = a.DEBITACCOUNT,
                            creditGlAccount = a.CREDITACCOUNT,
                            currencyCode = a.CURRENCYCODE,
                            currencyRate = a.CURRENCYRATE,
                            currencyRateCode = a.CURRENCYRATECODE,
                            description = a.DESCRIPTION,
                            amountCollected = 0,
                            bankId = a.BANKID,
                            branchId = (short)a.DESTINATIONBRANCHID,
                            sourceReferenceNumber = a.SOURCEREFERENCENUMBER,
                        }).ToList();

            List<FINTRAK_TRAN_PROC_DETAILS> staging = new List<FINTRAK_TRAN_PROC_DETAILS>();


            foreach (var item in data)
            {
                FINTRAK_TRAN_PROC_DETAILS addStaging = new FINTRAK_TRAN_PROC_DETAILS();

                addStaging.BATCH_ID = item.batchId;
                addStaging.BATCH_REF_ID = item.batchRefId;
                addStaging.TRAN_TYPE = item.transType;
                addStaging.FLOW_TYPE = item.flowType;
                addStaging.AMT = item.amount;
                addStaging.CR_ACCT = item.creditGlAccount;
                addStaging.DR_ACCT = item.debitGlAccount;
                addStaging.RATE_CODE = item.currencyRateCode;
                addStaging.REF_CRNCY_CODE = item.currencyCode;
                addStaging.RATE = (decimal)item.currencyRate;
                addStaging.NARRATION = item.description;
                addStaging.AMT_COLLECTED = item.amountCollected;
                addStaging.BANK_ID = item.bankId;
                addStaging.TOD_FLG = "N";
                addStaging.LOAN_ACCT = item.sourceReferenceNumber;
                addStaging.STATUS = "NEW";
                addStaging.RCRE_DATE = applicationDate;
                addStaging.PSTD_FLG = "N";
                addStaging.PSTD_DATE = applicationDate;
                addStaging.DEL_FLG = "N";
                addStaging.FAIL_FLG = "N";
                addStaging.FINTRAK_FLG = "N";

                staging.Add(addStaging);

            }
            this.stagingContext.FINTRAK_TRAN_PROC_DETAILS.AddRange(staging);
            stagingContext.SaveChanges();

            //var audit = new TBL_AUDIT
            //{
            //    AUDITTYPEID = (short)AuditTypeEnum.WriteToStagingTable,
            //    STAFFID = (int)SystemStaff.System,//model.createdBy,
            //    BRANCHID = data.FirstOrDefault().branchId,
            //    DETAIL = $"Write to Staging: {data.FirstOrDefault().sourceReferenceNumber}",
            //    IPADDRESS = data.FirstOrDefault().userIPAddress,
            //    URL = data.FirstOrDefault().applicationUrl,
            //    APPLICATIONDATE = applicationDate,//generalSetup.GetApplicationDate(),
            //    SYSTEMDATETIME = DateTime.Now
            //};

            //this.auditTrail.AddAuditTrail(audit);


            var model = (from a in context.TBL_CUSTOM_TRANSACTION_BULK
                         where a.VALUEDATE == DbFunctions.TruncateTime(applicationDate) && a.BATCHID == batchCode
                         group a by new { a.BATCHID } into groupedQ
                         select new FinanceTransactionStagingViewModel()
                         {
                             batchId = groupedQ.Key.BATCHID,
                             amount = groupedQ.Sum(i => i.AMOUNT),
                         }).ToList();

            List<FINTRAK_TRAN_PROC_MAIN> main = new List<FINTRAK_TRAN_PROC_MAIN>();
            var recordCount = this.context.TBL_CUSTOM_TRANSACTION_BULK.Where(x => x.VALUEDATE == DbFunctions.TruncateTime(applicationDate) && x.BATCHID == batchCode).Count();
            foreach (var item in model)
            {
                FINTRAK_TRAN_PROC_MAIN addMain = new FINTRAK_TRAN_PROC_MAIN();

                addMain.BATCH_ID = item.batchId;
                addMain.RCRE_DATE = applicationDate;
                addMain.TRAN_TYPE = TransactionType;
                addMain.RCRE_USER = "SYSTEM";
                addMain.TOTAL_AMT = item.amount;
                addMain.STATUS = "NEW";
                addMain.REC_COUNT = recordCount;
                addMain.BANK_ID = "01";
                addMain.IS_SELECTED = "N";
                addMain.PSTD_DATE = applicationDate;
                addMain.PSTD_FLG = "N";
                addMain.DEL_FLG = "N";

                main.Add(addMain);

            }
            this.stagingContext.FINTRAK_TRAN_PROC_MAIN.AddRange(main);

            var result = stagingContext.SaveChanges() > 0;
            if (result)
            {
                output = true;
            }
            return output;
        }

        #region Commercial Paper  Operation
        [OperationBehavior(TransactionScopeRequired = true)]
        public bool SubAllocateCommercialLoanPrincipal(subAllocationViewModel model)
        {
            var application = generalSetup.GetApplicationDate();
            var destinationLoanRecord = context.TBL_LOAN.Find(model.toLoanId);
            var sourceLoanRecord = context.TBL_LOAN.Find(model.fromLoanId);

            if (destinationLoanRecord.OPERATIONID != (short)OperationsEnum.CommercialLoanBooking)
                throw new ConditionNotMetException("The destination tranche facility is not a type of commercial Loan");

            if (sourceLoanRecord.OPERATIONID != (short)OperationsEnum.CommercialLoanBooking)
                throw new ConditionNotMetException("The source tranche facility is not a type of commercial Loan");

            var batchCode = CommonHelpers.GenerateRandomDigitCode(5);

            using (var trans = context.Database.BeginTransaction())
            {
                ArchiveLoan(sourceLoanRecord.TERMLOANID, (int)sourceLoanRecord.OPERATIONID, batchCode, "Sub Allocation");
                ArchiveLoan(destinationLoanRecord.TERMLOANID, (int)destinationLoanRecord.OPERATIONID, batchCode, "Sub Allocation");

                sourceLoanRecord.PRINCIPALAMOUNT = sourceLoanRecord.PRINCIPALAMOUNT - model.amountDifference;
                sourceLoanRecord.OUTSTANDINGPRINCIPAL = sourceLoanRecord.PRINCIPALAMOUNT - model.amountDifference;
                sourceLoanRecord.LASTRESTRUCTUREDATE = application;

                destinationLoanRecord.PRINCIPALAMOUNT = destinationLoanRecord.PRINCIPALAMOUNT + model.amountDifference;
                destinationLoanRecord.OUTSTANDINGPRINCIPAL = destinationLoanRecord.PRINCIPALAMOUNT + model.amountDifference;
                destinationLoanRecord.LASTRESTRUCTUREDATE = application;

                var result = context.SaveChanges() > 0;

                if (result)
                {
                    trans.Commit();
                }
                else { trans.Rollback(); }

                return result;
            }

        }

        public void ArchiveLoanApplicationDetails(int loanApplicationDetailId)
        {
            var batchCode = CommonHelpers.GenerateRandomDigitCode(5);
            var detailRow = context.TBL_LOAN_APPLICATION_DETAIL.Find(loanApplicationDetailId);
            if (detailRow != null)
            {
                List<TBL_LOAN_APPLICATION_DETL_ARCH> LoanApplicationDetailsArchive = new List<TBL_LOAN_APPLICATION_DETL_ARCH>();
                TBL_LOAN_APPLICATION_DETL_ARCH addLoanApplDetailsArchive = new TBL_LOAN_APPLICATION_DETL_ARCH();

                addLoanApplDetailsArchive.ARCHIVEDATE = DateTime.Today;
                addLoanApplDetailsArchive.LOANAPPLICATIONDETAILID = detailRow.LOANAPPLICATIONDETAILID;
                addLoanApplDetailsArchive.LOANAPPLICATIONID = detailRow.LOANAPPLICATIONID;
                addLoanApplDetailsArchive.CUSTOMERID = detailRow.CUSTOMERID;
                addLoanApplDetailsArchive.PROPOSEDPRODUCTID = detailRow.PROPOSEDPRODUCTID;
                addLoanApplDetailsArchive.PROPOSEDTENOR = detailRow.PROPOSEDTENOR;
                addLoanApplDetailsArchive.PROPOSEDINTERESTRATE = detailRow.PROPOSEDINTERESTRATE;
                addLoanApplDetailsArchive.PROPOSEDAMOUNT = detailRow.PROPOSEDAMOUNT;
                addLoanApplDetailsArchive.APPROVEDPRODUCTID = detailRow.APPROVEDPRODUCTID;
                addLoanApplDetailsArchive.APPROVEDTENOR = detailRow.APPROVEDTENOR;
                addLoanApplDetailsArchive.APPROVEDINTERESTRATE = detailRow.APPROVEDINTERESTRATE;
                addLoanApplDetailsArchive.APPROVEDAMOUNT = detailRow.APPROVEDAMOUNT;
                addLoanApplDetailsArchive.CURRENCYID = detailRow.CURRENCYID;
                addLoanApplDetailsArchive.EXCHANGERATE = detailRow.EXCHANGERATE;
                addLoanApplDetailsArchive.SUBSECTORID = detailRow.SUBSECTORID;
                addLoanApplDetailsArchive.STATUSID = detailRow.STATUSID;
                addLoanApplDetailsArchive.LOANPURPOSE = detailRow.LOANPURPOSE;
                addLoanApplDetailsArchive.CREATEDBY = detailRow.CREATEDBY;
                addLoanApplDetailsArchive.DATETIMECREATED = detailRow.DATETIMECREATED;
                addLoanApplDetailsArchive.LASTUPDATEDBY = detailRow.LASTUPDATEDBY;
                addLoanApplDetailsArchive.DATETIMEUPDATED = detailRow.DATETIMEUPDATED;
                addLoanApplDetailsArchive.DELETED = detailRow.DELETED;
                addLoanApplDetailsArchive.DELETEDBY = detailRow.DELETEDBY;
                addLoanApplDetailsArchive.DATETIMEDELETED = detailRow.DATETIMEDELETED;
                addLoanApplDetailsArchive.EQUITYAMOUNT = detailRow.EQUITYAMOUNT;
                addLoanApplDetailsArchive.HASDONECHECKLIST = detailRow.HASDONECHECKLIST;
                addLoanApplDetailsArchive.EQUITYCASAACCOUNTID = detailRow.EQUITYCASAACCOUNTID;
                addLoanApplDetailsArchive.CONSESSIONAPPROVALSTATUSID = detailRow.CONSESSIONAPPROVALSTATUSID;
                addLoanApplDetailsArchive.CONSESSIONREASON = detailRow.CONSESSIONREASON;
                addLoanApplDetailsArchive.ISPOLITICALLYEXPOSED = detailRow.ISPOLITICALLYEXPOSED;
                addLoanApplDetailsArchive.REPAYMENTTERMS = detailRow.REPAYMENTTERMS;
                addLoanApplDetailsArchive.REPAYMENTSCHEDULEID = detailRow.REPAYMENTSCHEDULEID;
                addLoanApplDetailsArchive.EFFECTIVEDATE = detailRow.EFFECTIVEDATE;
                addLoanApplDetailsArchive.ISTAKEOVERAPPLICATION = detailRow.ISTAKEOVERAPPLICATION;
                addLoanApplDetailsArchive.EXPIRYDATE = detailRow.EXPIRYDATE;
                addLoanApplDetailsArchive.CASAACCOUNTID = detailRow.CASAACCOUNTID;
                addLoanApplDetailsArchive.OPERATINGCASAACCOUNTID = detailRow.OPERATINGCASAACCOUNTID;
                addLoanApplDetailsArchive.SECUREDBYCOLLATERAL = detailRow.SECUREDBYCOLLATERAL;
                addLoanApplDetailsArchive.CRMSCOLLATERALTYPEID = detailRow.CRMSCOLLATERALTYPEID;
                addLoanApplDetailsArchive.MORATORIUMDURATION = detailRow.MORATORIUMDURATION;
                addLoanApplDetailsArchive.CRMSFUNDINGSOURCEID = detailRow.CRMSFUNDINGSOURCEID;
                addLoanApplDetailsArchive.CRMSREPAYMENTSOURCEID = detailRow.CRMSREPAYMENTSOURCEID;
                addLoanApplDetailsArchive.CRMSFUNDINGSOURCECATEGORY = detailRow.CRMSFUNDINGSOURCECATEGORY;
                addLoanApplDetailsArchive.CRMS_ECCI_NUMBER = detailRow.CRMS_ECCI_NUMBER;
                addLoanApplDetailsArchive.CRMSCODE = detailRow.CRMSCODE;
                addLoanApplDetailsArchive.CRMSREPAYMENTAGREEMENTID = detailRow.CRMSREPAYMENTAGREEMENTID;
                addLoanApplDetailsArchive.CRMSVALIDATED = detailRow.CRMSVALIDATED;
                addLoanApplDetailsArchive.CRMSDATE = detailRow.CRMSDATE;
                addLoanApplDetailsArchive.TRANSACTIONDYNAMICS = detailRow.TRANSACTIONDYNAMICS;
                addLoanApplDetailsArchive.CONDITIONPRECIDENT = detailRow.CONDITIONPRECIDENT;
                addLoanApplDetailsArchive.CONDITIONSUBSEQUENT = detailRow.CONDITIONSUBSEQUENT;
                addLoanApplDetailsArchive.FIELD1 = detailRow.FIELD1;
                addLoanApplDetailsArchive.PRODUCTPRICEINDEXRATE = detailRow.PRODUCTPRICEINDEXRATE;
                addLoanApplDetailsArchive.PRODUCTPRICEINDEXID = detailRow.PRODUCTPRICEINDEXID;
                addLoanApplDetailsArchive.FIELD2 = detailRow.FIELD2;
                addLoanApplDetailsArchive.FIELD3 = detailRow.FIELD3;
                addLoanApplDetailsArchive.ISSPECIALISED = detailRow.ISSPECIALISED;
                addLoanApplDetailsArchive.TENORFREQUENCYTYPEID = detailRow.TENORFREQUENCYTYPEID;

                this.context.TBL_LOAN_APPLICATION_DETL_ARCH.Add(addLoanApplDetailsArchive);

                context.SaveChanges();
            }
        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool AproveApplicationLineRateChangeRequest(LoanReviewViewModel userModel)
        {
            var systemDate = generalSetup.GetApplicationDate();
            if (userModel.valueDate > systemDate)
                throw new ConditionNotMetException("post dated interest rate change not allowed.");


            var validate = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == userModel.loanApplicationDetailId && x.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing
               && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).FirstOrDefault();


            if (validate != null)
            {
                //return false;
                throw new ConditionNotMetException("The requested operation already exist and going through approval");
            }

            TBL_LOAN_REVIEW_OPERATION op = new TBL_LOAN_REVIEW_OPERATION();
            bool output = false;

            var lmsApprovalRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == userModel.loanApplicationDetailId && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).FirstOrDefault();

            if (userModel.loanReviewOperationsId == 0)
            {
                op.LOANID = lmsApprovalRecord.LOANID;
                op.LOANSYSTEMTYPEID = lmsApprovalRecord.LOANSYSTEMTYPEID;
                op.OPERATIONTYPEID = userModel.operationId;
                op.REVIEWDETAILS = "InterestRateChange";
                op.INTERATERATE = userModel.newRate;
                op.EFFECTIVEDATE = generalSetup.GetApplicationDate(); // userModel.valueDate;
                op.LOANREVIEWAPPLICATIONID = lmsApprovalRecord.LOANREVIEWAPPLICATIONID;
                op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;
                op.ISMANAGEMENTINTERESTRATE = false;
                op.OPERATIONCOMPLETED = false;
                op.CREATEDBY = userModel.staffId;
                op.DATECREATED = DateTime.Now;

                context.TBL_LOAN_REVIEW_OPERATION.Add(op);

                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanInterestRateChange,
                    STAFFID = userModel.createdBy,
                    BRANCHID = (short)userModel.userBranchId,
                    DETAIL = $"Line Operation with LoanReviewApplicationId '{lmsApprovalRecord.LOANREVIEWAPPLICATIONID}'",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = userModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };


                using (var trans = context.Database.BeginTransaction())
                {
                    try
                    {
                        context.TBL_AUDIT.Add(audit);

                        output = context.SaveChanges() > 0;

                        //productBehaviour.TEMP_PRODUCTID = product.TEMP_PRODUCTID;


                        var entity = new ApprovalViewModel
                        {
                            staffId = userModel.createdBy,
                            companyId = userModel.companyId,
                            approvalStatusId = (int)ApprovalStatusEnum.Pending,
                            comment = "Please approve this Line Operation",
                            targetId = op.LOANREVIEWOPERATIONID,
                            operationId = userModel.operationId,
                            BranchId = userModel.userBranchId,
                            externalInitialization = true
                        };
                        var response = workFlow.LogForApproval(entity);

                        if (response)
                        {
                            if (userModel.fees != null)
                            {
                                LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                                feeDetails.feeDetails = userModel.fees;
                                feeDetails.createdBy = userModel.createdBy;
                                feeDetails.userIPAddress = userModel.userIPAddress;
                                feeDetails.userBranchId = userModel.userBranchId;
                                feeDetails.applicationUrl = userModel.applicationUrl;
                                feeDetails.companyId = userModel.companyId;
                                feeDetails.loanOperationReviewId = op.LOANREVIEWOPERATIONID;
                                feeDetails.feeSourceModule = userModel.feeSourceModule;
                                output = SubmitTakeFee(feeDetails);
                            }
                            else
                            {
                                // output = context.SaveChanges() > 0;
                            }
                            trans.Commit();
                            return output;
                        }
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw ex;
                    }
                }
                return output;
            }
            else
            {
                op = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == userModel.loanReviewOperationsId).FirstOrDefault();
                op.LOANID = lmsApprovalRecord.LOANID;
                op.LOANSYSTEMTYPEID = lmsApprovalRecord.LOANSYSTEMTYPEID;
                //op.OPERATIONTYPEID = userModel.operationId;
                op.REVIEWDETAILS = "InterestRateChange";
                op.INTERATERATE = userModel.newRate;
                op.EFFECTIVEDATE = generalSetup.GetApplicationDate(); // userModel.valueDate;
                op.LOANREVIEWAPPLICATIONID = lmsApprovalRecord.LOANREVIEWAPPLICATIONID;
                op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;
                op.ISMANAGEMENTINTERESTRATE = false;
                op.OPERATIONCOMPLETED = false;
                op.CREATEDBY = userModel.staffId;

                lmsApprovalRecord.OPERATIONPERFORMED = true;

                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanInterestRateChange,
                    STAFFID = userModel.createdBy,
                    BRANCHID = (short)userModel.userBranchId,
                    DETAIL = $"Line Operation with LoanReviewApplicationId '{lmsApprovalRecord.LOANREVIEWAPPLICATIONID}'",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = userModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };

                context.TBL_AUDIT.Add(audit);

                //output = context.SaveChanges() > 0;
                if (userModel.fees != null)
                {
                    LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                    feeDetails.feeDetails = userModel.fees;
                    feeDetails.createdBy = userModel.createdBy;
                    feeDetails.userIPAddress = userModel.userIPAddress;
                    feeDetails.userBranchId = userModel.userBranchId;
                    feeDetails.applicationUrl = userModel.applicationUrl;
                    feeDetails.companyId = userModel.companyId;
                    feeDetails.loanOperationReviewId = op.LOANREVIEWOPERATIONID;
                    feeDetails.feeSourceModule = userModel.feeSourceModule;
                    output = SubmitTakeFee(feeDetails);
                }
                else
                {
                    // output = context.SaveChanges() > 0;
                }


                return output;
            }
        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool ReviewApplicationLineRate(LoanReviewViewModel userModel)
        {
            var systemDate = generalSetup.GetApplicationDate();
            if (userModel.loanApplicationDetailId != 0)
            {
                if (userModel.valueDate > systemDate)
                    throw new ConditionNotMetException("post dated interest rate change not allowed.");

                var result = context.TBL_LOAN_APPLICATION_DETAIL.Find(userModel.loanApplicationDetailId);

                ArchiveLoanApplicationDetails(result.LOANAPPLICATIONDETAILID);
                result.APPROVEDINTERESTRATE = userModel.newRate;

                var loans = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == result.LOANAPPLICATIONDETAILID).ToList();
                foreach (var loan in loans)
                {
                    userModel.loanId = loan.TERMLOANID;
                    ReviewNonTermLoanLoanRate(userModel);
                };

                var lmsApprovalRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == userModel.loanApplicationDetailId && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).FirstOrDefault();
                lmsApprovalRecord.OPERATIONPERFORMED = true;

                //Audit Section ---------------------------
                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanInterestRateChange,
                    STAFFID = userModel.createdBy,
                    BRANCHID = (short)userModel.userBranchId,
                    DETAIL = $"Interest rate changed on line with application reference number: '{result.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER}' and detail Id '{result.LOANAPPLICATIONDETAILID}' to new rate {userModel.newRate}",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = userModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };

                context.TBL_AUDIT.Add(audit);
                //end of Audit section -------------------------------
            }
            else
            {
                return false;
            }

            return context.SaveChanges() > 0;
        }

        private LoanPaymentRestructureScheduleInputViewModel BuildLoanPaymentResturctureScheduleModel(int loanId)
        {
            var loan = context.TBL_LOAN.Find(loanId);
            var appDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(loan.LOANAPPLICATIONDETAILID);
            var model = new LoanPaymentRestructureScheduleInputViewModel
            {
                proposedTenor = appDetail.PROPOSEDTENOR,
                loanChangeType = 0,
                loanId = loan.TERMLOANID,
                payAmount = 0,
                newAmount = 0,
                productId = loan.PRODUCTID,
                newPrincipalFrequency = loan.PRINCIPALFREQUENCYTYPEID,
                newInterestFrequency = loan.INTERESTFREQUENCYTYPEID,
                newPrincipalFirstpaymentDate = loan.FIRSTPRINCIPALPAYMENTDATE,
                newInterestFirstpaymentDate = loan.FIRSTINTERESTPAYMENTDATE,
                payInterest = loan.INTERESTRATE,
                newInterest = 0,
                //newTenor = 0,
                newEffectiveDate = loan.EFFECTIVEDATE,
                prepayment = 0,
                operationId = loan.OPERATIONID ?? 0,
                isManagementInterestRate = false,
                newMaturityDate = DateTime.Now,
                //newTenorPrepayment = "",
                customerId = loan.CUSTOMERID,
                date = DateTime.Now,
                feeRate = 0,
                feeAmount = 0,
                earnedFeeAmount = 0,
                chargeFeeId = 0,
                chargeFeeTypeId = 0,
                feeAmountDiff = 0,
                oldCasaAccountId = 0,
                newCasaAccountId = 0,
            };

            return model;
        }

        public bool ApproveNonTermLoanLoanRateChangeRequest(LoanReviewViewModel userModel)
        {
            TBL_LOAN_REVIEW_OPERATION op = new TBL_LOAN_REVIEW_OPERATION();
            var systemDate = generalSetup.GetApplicationDate();
            bool output = false;

            if (userModel.loanId != 0)
            {
                TBL_LOAN loanRecord = context.TBL_LOAN.Find(userModel.loanId);
                //TBL_LMSR_APPLICATION_DETAIL reviewRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == userModel.loanId);

                if (loanRecord == null)
                    throw new BadLogicException("Loan Information not found.");
                if (userModel.valueDate < loanRecord.EFFECTIVEDATE)
                    throw new ConditionNotMetException("Effective date cannot be lesser than the loan start date.");

                var validate = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == userModel.loanId && x.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing).FirstOrDefault();

                if (validate != null)
                {
                    throw new ConditionNotMetException("This Record is Undergoing Approval");
                }
                var lmsApprovalRefRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == loanRecord.TERMLOANID).FirstOrDefault();
                op.LOANID = lmsApprovalRefRecord.LOANID;
                op.LOANSYSTEMTYPEID = lmsApprovalRefRecord.LOANSYSTEMTYPEID;
                op.OPERATIONTYPEID = lmsApprovalRefRecord.OPERATIONID;
                op.REVIEWDETAILS = "InterestRateChange";
                op.TENOR = userModel.newTenor;
                op.LOANREVIEWAPPLICATIONID = lmsApprovalRefRecord.LOANREVIEWAPPLICATIONID;
                op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;
                op.ISMANAGEMENTINTERESTRATE = false;
                op.OPERATIONCOMPLETED = false;
                op.CREATEDBY = userModel.staffId;
                op.DATECREATED = DateTime.Now;
                op.EFFECTIVEDATE = userModel.valueDate;

                context.TBL_LOAN_REVIEW_OPERATION.Add(op);

                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanInterestRateChange,
                    STAFFID = userModel.createdBy,
                    BRANCHID = (short)userModel.userBranchId,
                    DETAIL = $"Extended loan Interest with reference number: {loanRecord.LOANREFERENCENUMBER} with {userModel.newTenor} extra",
                    IPADDRESS = userModel.userIPAddress,
                    URL = CommonHelpers.GetLocalIpAddress(),// groupModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };


                using (var trans = context.Database.BeginTransaction())
                {
                    try
                    {
                        context.TBL_AUDIT.Add(audit);

                        output = context.SaveChanges() > 0;

                        //productBehaviour.TEMP_PRODUCTID = product.TEMP_PRODUCTID;


                        var entity = new ApprovalViewModel
                        {
                            staffId = userModel.createdBy,
                            companyId = userModel.companyId,
                            approvalStatusId = (int)ApprovalStatusEnum.Pending,
                            comment = "Please approve this CX/FX Operation",
                            targetId = op.LOANREVIEWOPERATIONID,
                            operationId = (int)OperationsEnum.ContractualInterestRateChange,
                            BranchId = userModel.userBranchId,
                            externalInitialization = true
                        };
                        var response = workFlow.LogForApproval(entity);

                        if (response)
                        {
                            trans.Commit();
                            return output;
                        }
                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw ex;
                    }
                }
                return output;
            }
            return output;
        }

        public bool ReviewNonTermLoanLoanRate(LoanReviewViewModel userModel)
        {
            var systemDate = generalSetup.GetApplicationDate();
            if (userModel.loanId != 0)
            {
                TBL_LOAN loanRecord = context.TBL_LOAN.Find(userModel.loanId);
                //TBL_LMSR_APPLICATION_DETAIL reviewRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == userModel.loanId);

                //if (loanRecord == null)
                //    throw new BadLogicException("Loan Information not found.");
                //if (userModel.valueDate < loanRecord.EFFECTIVEDATE)
                //    throw new ConditionNotMetException("Effective date cannot be lesser than the loan start date.");

                if (userModel.valueDate < systemDate)
                {
                    List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();
                    LoanPaymentRestructureScheduleInputViewModel loanInput = new LoanPaymentRestructureScheduleInputViewModel()
                    {
                        loanId = loanRecord.TERMLOANID,
                        scheduleMethodId = loanRecord.SCHEDULETYPEID,
                        principalAmount = (double)loanRecord.OUTSTANDINGPRINCIPAL,
                        principalFrequency = loanRecord.PRINCIPALFREQUENCYTYPEID,
                        interestFrequency = loanRecord.INTERESTFREQUENCYTYPEID,
                        principalFirstpaymentDate = (DateTime)loanRecord.FIRSTPRINCIPALPAYMENTDATE,
                        interestFirstpaymentDate = (DateTime)loanRecord.FIRSTINTERESTPAYMENTDATE,
                        interestRate = loanRecord.INTERESTRATE,
                        effectiveDate = loanRecord.EFFECTIVEDATE,
                        maturityDate = loanRecord.MATURITYDATE,
                        accrualBasis = loanRecord.SCHEDULEDAYCOUNTCONVENTIONID,
                        firstDayType = loanRecord.SCHEDULEDAYINTERESTTYPEID,
                        integralFeeAmount = 0,
                        companyId = loanRecord.COMPANYID,
                        staffId = userModel.createdBy,
                        createdBy = userModel.createdBy,
                        customerId = loanRecord.CUSTOMERID,
                    };


                    if (loanRecord.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan)
                    {
                        int daysDiff = (userModel.valueDate - systemDate).Days;

                        double previousAmount = (((loanRecord.INTERESTRATE / 100) * (double)loanRecord.PRINCIPALAMOUNT * 1 / (loanRecord.EFFECTIVEDATE - loanRecord.MATURITYDATE).Days) * daysDiff);
                        double currentAmount = (((userModel.newRate / 100) * (double)loanRecord.PRINCIPALAMOUNT * 1 / (loanRecord.EFFECTIVEDATE - loanRecord.MATURITYDATE).Days) * daysDiff);
                        double diff = previousAmount - currentAmount;

                        if (diff > 0)
                        {
                            inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, (decimal)Math.Abs(diff), loanRecord.TBL_PRODUCT.PRINCIPALBALANCEGL.Value, "Interest Reversal", (short)OperationsEnum.ContractualInterestRateChange));
                        }
                        else
                        {
                            inputTransactions.Add(financeTransaction.PostBuildLoanNegativeReversalPosting(loanInput, (decimal)Math.Abs(diff), loanRecord.TBL_PRODUCT.PRINCIPALBALANCEGL.Value, "Interest Reversal", (short)OperationsEnum.ContractualInterestRateChange));
                        }
                    }

                    if (loanRecord.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving)
                    {
                        int daysDiff = (userModel.valueDate - systemDate).Days;

                        double previousAmount = (((loanRecord.INTERESTRATE / 100) * (double)loanRecord.PRINCIPALAMOUNT * 1 / (loanRecord.EFFECTIVEDATE - loanRecord.MATURITYDATE).Days) * daysDiff);
                        double currentAmount = (((userModel.newRate / 100) * (double)loanRecord.PRINCIPALAMOUNT * 1 / (loanRecord.EFFECTIVEDATE - loanRecord.MATURITYDATE).Days) * daysDiff);
                        double diff = previousAmount - currentAmount;
                        if (diff > 0)
                        {
                            inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, (decimal)Math.Abs(diff), loanRecord.TBL_PRODUCT.PRINCIPALBALANCEGL.Value, "Interest Reversal", (short)OperationsEnum.ContractualInterestRateChange));
                        }
                        else
                        {
                            inputTransactions.Add(financeTransaction.PostBuildLoanNegativeReversalPosting(loanInput, (decimal)Math.Abs(diff), loanRecord.TBL_PRODUCT.PRINCIPALBALANCEGL.Value, "Interest Reversal", (short)OperationsEnum.ContractualInterestRateChange));
                        }
                    }

                }
                else
                {
                    if (userModel.valueDate > systemDate) { throw new ConditionNotMetException("post dated interest rate change not allowed."); }
                    loanRecord.INTERESTRATE = userModel.newRate;
                }

                //Audit Section ---------------------------
                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanInterestRateChange,
                    STAFFID = userModel.createdBy,
                    BRANCHID = (short)userModel.userBranchId,
                    DETAIL = $"Interest rate changed on loan with reference number '{loanRecord.LOANREFERENCENUMBER}' to new rate '{userModel.newRate}'",
                    IPADDRESS = userModel.userIPAddress,
                    URL = CommonHelpers.GetLocalIpAddress(),// groupModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };
                context.TBL_AUDIT.Add(audit);
                //end of Audit section -------------------------------
            }
            return context.SaveChanges() > 0;
        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool ApproveNonTermLoanTenorReviewRequest(LoanReviewViewModel userModel)
        {
            TBL_LOAN_REVIEW_OPERATION op = new TBL_LOAN_REVIEW_OPERATION();
            TBL_LOAN loan = new TBL_LOAN();
            TBL_LOAN_APPLICATION_DETAIL loanApp = new TBL_LOAN_APPLICATION_DETAIL();

            if (userModel.newTenor == 0)
                throw new BadLogicException("You cannot extend tenor with a zero value");

            loan = context.TBL_LOAN.Find(userModel.loanId);
            loanApp = context.TBL_LOAN_APPLICATION_DETAIL.Find(loan.LOANAPPLICATIONDETAILID);

            if (loan.OPERATIONID == (short)OperationsEnum.CommercialLoanBooking && userModel.newTenor > loanApp.APPROVEDTENOR)
            {
                throw new ConditionNotMetException("The new loan tenor exceeded the line tenor for this facility.");
            }

            if (loanApp.EFFECTIVEDATE == null)
            {
                throw new ConditionNotMetException("Loan Application Effective Date Can Not Be Null");
            }
            if (loan.OPERATIONID == (short)OperationsEnum.CommercialLoanBooking && loanApp.EXPIRYDATE != null)
            {
                if (loanApp.EXPIRYDATE < loan.MATURITYDATE.AddDays(userModel.newTenor))

                    throw new ConditionNotMetException("the resulting maturity date exceeded the line expiry date.");
            }
            else
            {
                if (loanApp.EFFECTIVEDATE.Value.AddDays(loanApp.APPROVEDTENOR) < loan.EFFECTIVEDATE.AddDays(userModel.newTenor))
                    //throw new SecureException("the resulting maturity date exceeded the line expiry date.");

                    throw new ConditionNotMetException("the resulting maturity date exceeded the line expiry date.");
            }


            var validate = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == userModel.loanId && (x.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing || x.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending)).FirstOrDefault();

            if (validate != null)
            {
                throw new ConditionNotMetException("This Record is Undergoing Approval");
            }

            if (loan.MATURITYDATE <= loan.MATURITYDATE.AddDays(userModel.newTenor))
            {
                bool output = false;
                if (userModel.loanReviewOperationsId == 0)
                {
                    var lmsApprovalRefRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == loan.TERMLOANID).FirstOrDefault();
                    lmsApprovalRefRecord.OPERATIONPERFORMED = true;

                    op.LOANID = lmsApprovalRefRecord.LOANID;
                    op.LOANSYSTEMTYPEID = lmsApprovalRefRecord.LOANSYSTEMTYPEID;
                    op.OPERATIONTYPEID = (int)OperationsEnum.TenorChange; // userModel.operationId;
                    op.REVIEWDETAILS = "TenorChange";
                    op.TENOR = userModel.newTenor;
                    op.LOANREVIEWAPPLICATIONID = lmsApprovalRefRecord.LOANREVIEWAPPLICATIONID;
                    op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;
                    op.ISMANAGEMENTINTERESTRATE = false;
                    op.OPERATIONCOMPLETED = false;
                    op.CREATEDBY = userModel.createdBy;
                    op.DATECREATED = DateTime.Now;


                    context.TBL_LOAN_REVIEW_OPERATION.Add(op);
                    var audit = new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.LoanTenorExtended,
                        STAFFID = userModel.createdBy,
                        BRANCHID = (short)userModel.userBranchId,
                        DETAIL = $"Extended loan tenor with reference number: {loan.LOANREFERENCENUMBER} with {userModel.newTenor} extra",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = userModel.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    };

                    using (var trans = context.Database.BeginTransaction())
                    {
                        try
                        {
                            context.TBL_AUDIT.Add(audit);

                            output = context.SaveChanges() > 0;

                            //productBehaviour.TEMP_PRODUCTID = product.TEMP_PRODUCTID;


                            var entity = new ApprovalViewModel
                            {
                                staffId = userModel.createdBy,
                                companyId = userModel.companyId,
                                approvalStatusId = (int)ApprovalStatusEnum.Pending,
                                comment = "Please approve this CX/FX Operation",
                                targetId = op.LOANREVIEWOPERATIONID,
                                operationId = (int)OperationsEnum.TenorChange, //userModel.operationId,
                                BranchId = userModel.userBranchId,
                                externalInitialization = true
                            };
                            var response = workFlow.LogForApproval(entity);

                            if (response)
                            {
                                if (userModel.fees != null)
                                {
                                    LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                                    feeDetails.feeDetails = userModel.fees;
                                    feeDetails.createdBy = userModel.createdBy;
                                    feeDetails.userIPAddress = userModel.userIPAddress;
                                    feeDetails.userBranchId = userModel.userBranchId;
                                    feeDetails.applicationUrl = userModel.applicationUrl;
                                    feeDetails.companyId = userModel.companyId;
                                    feeDetails.loanOperationReviewId = op.LOANREVIEWOPERATIONID;
                                    feeDetails.feeSourceModule = userModel.feeSourceModule;
                                    output = SubmitTakeFee(feeDetails);
                                }
                                else
                                {
                                    output = context.SaveChanges() > 0;
                                }

                                trans.Commit();
                                return output;
                            }
                        }
                        catch (Exception ex)
                        {
                            trans.Rollback();
                            throw ex;
                        }
                    }
                    return output;
                }
                else
                {
                    var lmsApprovalRefRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == loan.TERMLOANID).FirstOrDefault();
                    lmsApprovalRefRecord.OPERATIONPERFORMED = true;

                    var reviewOperation = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == userModel.loanReviewOperationsId).FirstOrDefault();

                    reviewOperation.TENOR = userModel.newTenor;
                    reviewOperation.OPERATIONCOMPLETED = false;

                    var audit = new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.LoanTenorExtended,
                        STAFFID = userModel.createdBy,
                        BRANCHID = (short)userModel.userBranchId,
                        DETAIL = $"Extended loan tenor with reference number: {loan.LOANREFERENCENUMBER} with {userModel.newTenor} extra",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = userModel.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    };

                    context.TBL_AUDIT.Add(audit);

                    if (userModel.fees != null)
                    {
                        LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                        feeDetails.feeDetails = userModel.fees;
                        feeDetails.createdBy = userModel.createdBy;
                        feeDetails.userIPAddress = userModel.userIPAddress;
                        feeDetails.userBranchId = userModel.userBranchId;
                        feeDetails.applicationUrl = userModel.applicationUrl;
                        feeDetails.companyId = userModel.companyId;
                        feeDetails.loanOperationReviewId = reviewOperation.LOANREVIEWOPERATIONID;
                        feeDetails.feeSourceModule = userModel.feeSourceModule;
                        output = SubmitTakeFee(feeDetails);
                    }
                    else
                    {
                        output = context.SaveChanges() > 0;
                    }
                    return output;

                }
            }
            else
            {
                throw new ConditionNotMetException("New tenor has no positive value");
            }
        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool ReviewNonTermLoanTenor(LoanReviewViewModel userModel)
        {
            var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);

            TBL_LOAN loan = new TBL_LOAN();
            TBL_LOAN_APPLICATION_DETAIL loanApp = new TBL_LOAN_APPLICATION_DETAIL();

            if (userModel.newTenor == 0)
                throw new BadLogicException("You cannot extend tenor with a zero value");

            loan = context.TBL_LOAN.Find(userModel.loanId);
            loanApp = context.TBL_LOAN_APPLICATION_DETAIL.Find(loan.LOANAPPLICATIONDETAILID);

            if (loan.OPERATIONID == (short)OperationsEnum.CommercialLoanBooking && userModel.newTenor > loanApp.APPROVEDTENOR)
            {
                throw new ConditionNotMetException("The new loan tenor exceeded the line tenor for this facility.");
            }

            if (loan.OPERATIONID == (short)OperationsEnum.CommercialLoanBooking && loanApp.EXPIRYDATE != null)
            {
                if (loanApp.EXPIRYDATE < loan.MATURITYDATE.AddDays(userModel.newTenor))
                    throw new ConditionNotMetException("the resulting maturity date exceeded the line expiry date.");
            }
            else
            {
                if (loanApp.EFFECTIVEDATE.Value.AddDays(loanApp.APPROVEDTENOR) < loan.EFFECTIVEDATE.AddDays(userModel.newTenor))
                    throw new ConditionNotMetException("the resulting maturity date exceeded the line expiry date.");
            }

            if (loan.MATURITYDATE <= loan.MATURITYDATE.AddDays(userModel.newTenor))
            {
                ArchiveLoan(loan.TERMLOANID, (int)loan.OPERATIONID, archiveBatchCode);
                loan.MATURITYDATE = loan.MATURITYDATE.AddDays(userModel.newTenor);

                var lmsApprovalRefRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == loan.TERMLOANID).FirstOrDefault();
                lmsApprovalRefRecord.OPERATIONPERFORMED = true;

                //Audit Section ---------------------------
                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanTenorExtended,
                    STAFFID = userModel.createdBy,
                    BRANCHID = (short)userModel.userBranchId,
                    DETAIL = $"Extended loan tenor with reference number: {loan.LOANREFERENCENUMBER} with {userModel.newTenor} extra",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = userModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };

                context.TBL_AUDIT.Add(audit);
                //end of Audit section -------------------------------

                return context.SaveChanges() > 0;
            }
            else
            {
                throw new ConditionNotMetException("New tenor has no positive value");
            }
        }

        public bool ApproveApplicationLineAmountChangeRequest(LoanReviewViewModel userModel)
        {
            var result = context.TBL_LOAN_APPLICATION_DETAIL.Find(userModel.loanApplicationDetailId);
            var requests = context.TBL_LOAN_BOOKING_REQUEST.Where(r => r.LOANAPPLICATIONDETAILID == userModel.loanApplicationDetailId);
            decimal allRequestAmount = 0;
            if (requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                allRequestAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED);

            if (allRequestAmount > userModel.newAmount)
                throw new ConditionNotMetException("Input amount cannot be less than the active total loan request amount running");

            var validate = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == userModel.loanApplicationDetailId && x.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing
                    && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).FirstOrDefault();

            if (validate != null)
            {
                throw new ConditionNotMetException("This Record is Undergoing Approval");

                //return false;
            }

            TBL_LOAN_REVIEW_OPERATION op = new TBL_LOAN_REVIEW_OPERATION();
            bool output = false;

            var lmsApprovalRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == userModel.loanApplicationDetailId && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).FirstOrDefault();
            lmsApprovalRecord.OPERATIONPERFORMED = true;

            if (userModel.loanReviewOperationsId == 0)
            {
                op.LOANID = lmsApprovalRecord.LOANID;
                op.LOANSYSTEMTYPEID = lmsApprovalRecord.LOANSYSTEMTYPEID;
                op.OPERATIONTYPEID = userModel.operationId;
                op.REVIEWDETAILS = "AmountChange";
                op.INTERATERATE = userModel.newRate;
                op.PREPAYMENT = userModel.newAmount;
                op.EFFECTIVEDATE = generalSetup.GetApplicationDate(); // userModel.valueDate;
                op.LOANREVIEWAPPLICATIONID = lmsApprovalRecord.LOANREVIEWAPPLICATIONID;
                op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;
                op.ISMANAGEMENTINTERESTRATE = false;
                op.OPERATIONCOMPLETED = false;
                op.CREATEDBY = userModel.staffId;
                op.DATECREATED = DateTime.Now;

                context.TBL_LOAN_REVIEW_OPERATION.Add(op);

                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.lineAmountChange,
                    STAFFID = userModel.createdBy,
                    BRANCHID = (short)userModel.userBranchId,
                    DETAIL = $"Line Operation with LoanReviewApplicationId '{lmsApprovalRecord.LOANREVIEWAPPLICATIONID}'",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = userModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };


                using (var trans = context.Database.BeginTransaction())
                {
                    context.TBL_AUDIT.Add(audit);

                    output = context.SaveChanges() > 0;

                    //productBehaviour.TEMP_PRODUCTID = product.TEMP_PRODUCTID;


                    var entity = new ApprovalViewModel
                    {
                        staffId = userModel.createdBy,
                        companyId = userModel.companyId,
                        approvalStatusId = (int)ApprovalStatusEnum.Pending,
                        comment = "Please approve this Line Operation",
                        targetId = op.LOANREVIEWOPERATIONID,
                        operationId = userModel.operationId,
                        BranchId = userModel.userBranchId,
                        externalInitialization = true
                    };

                    var response = workFlow.LogForApproval(entity);

                    if (response)
                    {
                        if (userModel.fees.Count() > 0)
                        {
                            LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                            feeDetails.feeDetails = userModel.fees;
                            feeDetails.createdBy = userModel.createdBy;
                            feeDetails.userIPAddress = userModel.userIPAddress;
                            feeDetails.userBranchId = userModel.userBranchId;
                            feeDetails.applicationUrl = userModel.applicationUrl;
                            feeDetails.companyId = userModel.companyId;
                            feeDetails.loanOperationReviewId = op.LOANREVIEWOPERATIONID;
                            output = SubmitTakeFee(feeDetails);
                        }
                        else
                        {
                            //output = context.SaveChanges() > 0;
                        }
                        trans.Commit();
                        return output;
                    }
                }
                return output;
            }
            else
            {
                op = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == userModel.loanReviewOperationsId).FirstOrDefault();
                op.LOANID = lmsApprovalRecord.LOANID;
                op.LOANSYSTEMTYPEID = lmsApprovalRecord.LOANSYSTEMTYPEID;
                //op.OPERATIONTYPEID = userModel.operationId;
                op.REVIEWDETAILS = "AmountChange";
                op.INTERATERATE = userModel.newRate;
                op.PREPAYMENT = userModel.newAmount;
                op.EFFECTIVEDATE = generalSetup.GetApplicationDate(); // userModel.valueDate;
                op.LOANREVIEWAPPLICATIONID = lmsApprovalRecord.LOANREVIEWAPPLICATIONID;
                op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;
                op.ISMANAGEMENTINTERESTRATE = false;
                op.OPERATIONCOMPLETED = false;
                op.CREATEDBY = userModel.staffId;

                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.lineAmountChange,
                    STAFFID = userModel.createdBy,
                    BRANCHID = (short)userModel.userBranchId,
                    DETAIL = $"Line Operation with LoanReviewApplicationId '{lmsApprovalRecord.LOANREVIEWAPPLICATIONID}'",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = userModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };
                context.TBL_AUDIT.Add(audit);

                //output = context.SaveChanges() > 0;
                if (userModel.fees != null)
                {
                    LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                    feeDetails.feeDetails = userModel.fees;
                    feeDetails.createdBy = userModel.createdBy;
                    feeDetails.userIPAddress = userModel.userIPAddress;
                    feeDetails.userBranchId = userModel.userBranchId;
                    feeDetails.applicationUrl = userModel.applicationUrl;
                    feeDetails.companyId = userModel.companyId;
                    feeDetails.loanOperationReviewId = op.LOANREVIEWOPERATIONID;
                    output = SubmitTakeFee(feeDetails);
                }
                else
                {
                    //output = context.SaveChanges() > 0;
                }
                return output;
            }

        }

        public bool changeApplicationLineAmount(LoanReviewViewModel userModel)
        {
            var result = context.TBL_LOAN_APPLICATION_DETAIL.Find(userModel.loanApplicationDetailId);
            var requests = context.TBL_LOAN_BOOKING_REQUEST.Where(r => r.LOANAPPLICATIONDETAILID == userModel.loanApplicationDetailId);
            decimal allRequestAmount = 0;
            if (requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                allRequestAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED);

            if (allRequestAmount > userModel.newAmount)
                throw new ConditionNotMetException("Input amount cannot be less than the active total loan request amount running");

            ArchiveLoanApplicationDetails(result.LOANAPPLICATIONDETAILID);
            result.APPROVEDAMOUNT = userModel.newAmount;

            var lmsApprovalRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == userModel.loanApplicationDetailId && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).FirstOrDefault();
            //lmsApprovalRecord.OPERATIONPERFORMED = true;

            //Audit Section ---------------------------
            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.LoanRolledOver,
                STAFFID = userModel.createdBy,
                BRANCHID = (short)userModel.userBranchId,
                DETAIL = $"Line facility amount with product code {result.TBL_PRODUCT.PRODUCTCODE} for customer code {result.TBL_CUSTOMER.CUSTOMERCODE} was changed to '{userModel.newAmount}'",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = userModel.applicationUrl,
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName()
            };
            context.TBL_AUDIT.Add(audit);
            //end of Audit section -------------------------------

            return context.SaveChanges() > 0;
        }

        public IEnumerable<CamProcessedLoanViewModel> GetApplicationLineTenorChangeAwaitingApproval(int staffId, int companyId)
        {
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            //var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            var ids = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.OfferLetterApproval).ToList();

            var data = (from d in context.TBL_LOAN_APPLICATION_DETAIL
                        join l in context.TBL_LMSR_APPLICATION_DETAIL on d.LOANAPPLICATIONDETAILID equals l.LOANID
                        join e in context.TBL_LMSR_APPLICATION on l.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                        join ln in context.TBL_LOAN_REVIEW_OPERATION on l.LOANREVIEWAPPLICATIONID equals ln.LOANREVIEWAPPLICATIONID
                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                        join atrail in context.TBL_APPROVAL_TRAIL on ln.LOANREVIEWOPERATIONID equals atrail.TARGETID
                        join c in context.TBL_CUSTOMER on d.CUSTOMERID equals c.CUSTOMERID
                        where l.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility
                        && (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                        || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                        || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                        || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised)
                         && atrail.OPERATIONID == ln.OPERATIONTYPEID
                        && ids.Contains((int)atrail.TOAPPROVALLEVELID)// == staffApprovalLevelId
                        && atrail.RESPONSESTAFFID == null && ln.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                        //&& l.OPERATIONPERFORMED == true
                        select new CamProcessedLoanViewModel
                        {
                            divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == c.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                            divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                            lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                            lmsOperationId = atrail.OPERATIONID,
                            lmsOperationName = atrail.TBL_OPERATIONS.OPERATIONNAME,
                            loanReviewApplicationId = e.LOANAPPLICATIONID,
                            tenor = ln.TENOR ?? 0,
                            reviewDetails = ln.REVIEWDETAILS,
                            newinterestRate = ln.INTERATERATE,
                            newLineAmount = ln.PREPAYMENT,
                            loanReviewOperationId = ln.LOANREVIEWOPERATIONID,
                            approvalStatusId = (short)m.APPROVALSTATUSID,
                            loanApplicationId = m.LOANAPPLICATIONID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                            applicationStatusId = m.APPLICATIONSTATUSID,
                            customerId = m.CUSTOMERID ?? 0,
                            customerCode = c.CUSTOMERCODE,

                            customerName = d.TBL_CUSTOMER.FIRSTNAME + " " + d.TBL_CUSTOMER.MIDDLENAME + " " + d.TBL_CUSTOMER.LASTNAME,
                            customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                            customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                            customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                            isRelatedParty = m.ISRELATEDPARTY,
                            customerSensitivityLevelId = d.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                            customerOccupation = d.TBL_CUSTOMER.OCCUPATION,
                            customerType = d.TBL_CUSTOMER.TBL_CUSTOMER_TYPE.NAME,

                            isPoliticallyExposed = d.TBL_CUSTOMER.ISPOLITICALLYEXPOSED,
                            isInvestmentGrade = m.ISINVESTMENTGRADE,
                            operationId = l.OPERATIONID,
                            operationName = m.TBL_OPERATIONS.OPERATIONNAME,

                            companyId = m.COMPANYID,
                            branchId = m.BRANCHID,
                            branchName = m.TBL_BRANCH.BRANCHNAME,
                            subSectorId = d.SUBSECTORID,
                            subSectorName = d.TBL_SUB_SECTOR.NAME,
                            sectorName = d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            applicationTenor = m.APPLICATIONTENOR,
                            effectiveDate = (DateTime)d.EFFECTIVEDATE,
                            expiryDate = d.EXPIRYDATE,

                            relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                            relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                            relationshipManagerId = m.RELATIONSHIPMANAGERID,
                            relationshipManagerName = m.TBL_STAFF1.FIRSTNAME + " " + m.TBL_STAFF1.MIDDLENAME + " " + m.TBL_STAFF1.LASTNAME,

                            currencyId = d.CURRENCYID,
                            currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                            exchangeRate = d.EXCHANGERATE,
                            loanTypeId = m.LOANAPPLICATIONTYPEID,
                            loanTypeName = m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                            productId = d.APPROVEDPRODUCTID,
                            productTypeId = d.TBL_PRODUCT.PRODUCTTYPEID,
                            productTypeName = d.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            productName = d.TBL_PRODUCT.PRODUCTNAME,
                            productClassProcessId = m.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                            misCode = m.MISCODE,
                            teamMisCode = m.TEAMMISCODE,

                            interestRate = d.APPROVEDINTERESTRATE,
                            submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                            approvedAmount = d.APPROVEDAMOUNT,
                            approvedDate = m.APPROVEDDATE,
                            groupApprovedAmount = m.APPROVEDAMOUNT,
                            approvedTenor = d.APPROVEDTENOR,
                            createdBy = m.OWNEDBY,
                            newApplicationDate = m.APPLICATIONDATE,
                            dateTimeCreated = d.DATETIMECREATED,
                            // systemCurrentDate = systemDate,
                            loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,
                            fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == ln.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                            {
                                chargeFeeId = mp.CHARGEFEEID,
                                feeAmount = mp.FEEAMOUNT,
                                description = mp.DESCRIPTION,
                                casaAccount = mp.CASAACCOUNTID,
                                loanChargeFeeId = mp.LOANCHARGEFEEID,
                                chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                            }).ToList(),

                        }).ToList();

            List<CamProcessedLoanViewModel> lcyLoans = new List<CamProcessedLoanViewModel>();
            List<CamProcessedLoanViewModel> fcyLoans = new List<CamProcessedLoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = data.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
            }

            if (isFCYUser == true)
            {
                fcyLoans = data.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            data = lcyLoans.Union(fcyLoans).ToList();

            return data;
        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public int addApplicationGoForApproval(ApprovalViewModel userModel)
        {
            using (var trans = context.Database.BeginTransaction())
            {
                try
                {
                    var reviewRecord = (from s in context.TBL_LOAN_REVIEW_OPERATION
                                        where s.LOANREVIEWOPERATIONID == userModel.targetId && s.OPERATIONTYPEID == userModel.operationId
                                       && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                        && s.OPERATIONCOMPLETED == false
                                        select s).FirstOrDefault();

                    if (userModel.approvalStatusId == (short)ApprovalStatusEnum.Referred)
                    {

                        int staffId = userModel.staffId;


                        var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();

                        var levels = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == userModel.operationId)
                             .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
                             .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true),
                                 mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new
                                 {
                                     groupPosition = mg.m.POSITION,
                                     levelPosition = l.POSITION,
                                     levelId = l.APPROVALLEVELID,
                                     levelName = l.LEVELNAME,
                                     staffRoleId = l.STAFFROLEID,
                                 })
                                 .OrderBy(x => x.groupPosition)
                                 .ThenBy(x => x.levelPosition)
                                 .ToList();

                        var staffRoleLevels = levels.Where(x => x.staffRoleId == staff.STAFFROLEID);
                        var staffRoleLevelIds = staffRoleLevels.Select(x => x.levelId);
                        var staffRoleLevelId = staffRoleLevelIds.FirstOrDefault();

                        workFlow.StaffId = userModel.createdBy;
                        workFlow.OperationId = userModel.operationId;
                        workFlow.TargetId = userModel.targetId;
                        workFlow.CompanyId = userModel.companyId;
                        workFlow.ProductClassId = null;
                        workFlow.ProductId = null;
                        workFlow.NextLevelId = userModel.approvalLevelId;
                        workFlow.ToStaffId = staffId;
                        workFlow.StatusId = (int)ApprovalStatusEnum.Referred;
                        workFlow.Comment = userModel.comment;
                        workFlow.DeferredExecution = true;

                        workFlow.LogActivity();

                        var lmsrRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == reviewRecord.LOANREVIEWAPPLICATIONID).FirstOrDefault();
                        lmsrRecord.OPERATIONPERFORMED = false;


                        reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Referred;
                        reviewRecord.OPERATIONCOMPLETED = false;
                        context.SaveChanges();
                        trans.Commit();
                        return 4;
                    }

                    workFlow.StaffId = userModel.staffId;
                    workFlow.CompanyId = userModel.companyId;
                    workFlow.StatusId = ((int)userModel.approvalStatusId == (int)ApprovalStatusEnum.Approved) ? (int)ApprovalStatusEnum.Processing : (int)userModel.approvalStatusId;
                    workFlow.TargetId = userModel.targetId;
                    workFlow.Comment = userModel.comment;
                    workFlow.OperationId = userModel.operationId;
                    workFlow.DeferredExecution = true;
                    workFlow.ExternalInitialization = false;

                    workFlow.LogActivity();

                    if (userModel.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                    {
                        var reviewOperations = context.TBL_LOAN_REVIEW_OPERATION.Find(userModel.targetId);
                        reviewOperations.APPROVALSTATUSID = (short)ApprovalStatusEnum.Disapproved;
                        context.SaveChanges();
                        trans.Commit();
                        return 2;
                    }
                    bool response = false;

                    if (workFlow.NewState == (int)ApprovalState.Ended)
                    {
                        TBL_LOAN_REVIEW_OPERATION op = new TBL_LOAN_REVIEW_OPERATION();

                        op = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == userModel.targetId).FirstOrDefault();
                        LoanReviewViewModel loanView = new LoanReviewViewModel();
                        MaturityIntructionViewModel maturView = new MaturityIntructionViewModel();
                        maturView.userBranchId = (short)userModel.BranchId;
                        maturView.applicationUrl = userModel.applicationUrl;
                        maturView.createdBy = userModel.staffId;
                        maturView.companyId = userModel.companyId;
                        maturView.staffId = userModel.staffId;


                        loanView.userBranchId = (short)userModel.BranchId;
                        loanView.applicationUrl = userModel.applicationUrl;
                        loanView.createdBy = userModel.staffId;
                        loanView.companyId = userModel.companyId;
                        loanView.staffId = userModel.staffId;
                        if (userModel.operationId == (int)OperationsEnum.TenorChange)
                        {

                            loanView.newTenor = (int)op.TENOR;
                            loanView.loanId = op.LOANID;
                            response = ReviewNonTermLoanTenor(loanView);
                        }
                        else if (userModel.operationId == (int)OperationsEnum.ContractualInterestRateChange)
                        {
                            loanView.newRate = (double)op.INTERATERATE;
                            loanView.loanId = op.LOANID;
                            loanView.valueDate = (DateTime)op.EFFECTIVEDATE;
                            response = ReviewNonTermLoanLoanRate(loanView);
                        }
                        else if (userModel.operationId == (int)OperationsEnum.CommercialLoanRollOver)
                        {
                            maturView.instructionTypeId = (short)op.MATURITYINSTRUCTIONTYPEID;
                            maturView.loanId = op.LOANID;
                            maturView.tenor = (int)op.TENOR;
                            if (userModel.rollOverType == "autoRollover")
                            {
                                response = addMaturityInstruction(maturView);
                            }
                            else
                            {
                                response = RolloverCommercialLoanByManualProcess(maturView, null);
                            }
                        }


                        if (response)
                        {
                            try
                            {
                                op.OPERATIONCOMPLETED = true;
                                context.SaveChanges();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                var EXE = ex;
                            }
                        }
                        else throw new ConditionNotMetException("One or more errors occured on commit.");
                        return 1;
                    }
                    else
                    {
                        trans.Commit();
                    }

                    return 0;
                }
                catch (Exception ex)
                {
                    trans.Rollback();
                    throw ex;
                }
            }

        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool AproveApplicationLineTenorChangeRequest(LoanReviewViewModel userModel)
        {
            var validate = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == userModel.loanApplicationDetailId && x.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing
                      && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).FirstOrDefault();

            if (validate != null)
            {
                //return false;
                throw new ConditionNotMetException("The requested operation already exist and going through approval");
            }

            TBL_LOAN_REVIEW_OPERATION op = new TBL_LOAN_REVIEW_OPERATION();
            bool output = false;

            var lmsApprovalRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == userModel.loanApplicationDetailId && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).FirstOrDefault();

            if (userModel.loanReviewOperationsId == 0)
            {
                op.LOANID = lmsApprovalRecord.LOANID;
                op.LOANSYSTEMTYPEID = lmsApprovalRecord.LOANSYSTEMTYPEID;
                op.OPERATIONTYPEID = userModel.operationId;
                op.REVIEWDETAILS = "TenorChange";
                op.TENOR = userModel.newTenor;
                op.LOANREVIEWAPPLICATIONID = lmsApprovalRecord.LOANREVIEWAPPLICATIONID;
                op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                op.ISMANAGEMENTINTERESTRATE = false;
                op.OPERATIONCOMPLETED = false;
                op.CREATEDBY = userModel.staffId;
                op.DATECREATED = DateTime.Now;
                op.EFFECTIVEDATE = DateTime.Now;

                context.TBL_LOAN_REVIEW_OPERATION.Add(op);

                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanTenorExtended,
                    STAFFID = userModel.createdBy,
                    BRANCHID = (short)userModel.userBranchId,
                    DETAIL = $"Line Operation with LoanId '{lmsApprovalRecord.LOANID}'",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = userModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };


                using (var trans = context.Database.BeginTransaction())
                {
                    try
                    {
                        context.TBL_AUDIT.Add(audit);

                        output = context.SaveChanges() > 0;

                        //productBehaviour.TEMP_PRODUCTID = product.TEMP_PRODUCTID;


                        var entity = new ApprovalViewModel
                        {
                            staffId = userModel.createdBy,
                            companyId = userModel.companyId,
                            approvalStatusId = (int)ApprovalStatusEnum.Pending,
                            comment = "Please approve this Line Operation",
                            targetId = op.LOANREVIEWOPERATIONID,
                            operationId = userModel.operationId,
                            BranchId = userModel.userBranchId,
                            externalInitialization = true,
                            deferredExecution = true
                        };
                        var response = workFlow.LogForApproval(entity);

                        if (response)
                        {

                            if (userModel.fees.Count() > 0)
                            {
                                LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                                feeDetails.feeDetails = userModel.fees;
                                feeDetails.createdBy = userModel.createdBy;
                                feeDetails.userIPAddress = userModel.userIPAddress;
                                feeDetails.userBranchId = userModel.userBranchId;
                                feeDetails.applicationUrl = userModel.applicationUrl;
                                feeDetails.companyId = userModel.companyId;
                                feeDetails.loanOperationReviewId = op.LOANREVIEWOPERATIONID;
                                output = SubmitTakeFee(feeDetails);
                            }
                            else
                            {
                                output = context.SaveChanges() > 0;
                            }

                            trans.Commit();
                            return output;
                        }

                    }
                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw ex;
                    }
                }
                return output;
            }
            else
            {
                op = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == userModel.loanReviewOperationsId).FirstOrDefault();
                op.LOANID = lmsApprovalRecord.LOANID;
                op.LOANSYSTEMTYPEID = lmsApprovalRecord.LOANSYSTEMTYPEID;
                //op.OPERATIONTYPEID = userModel.operationId;
                op.REVIEWDETAILS = "TenorChange";
                op.TENOR = userModel.newTenor;
                op.LOANREVIEWAPPLICATIONID = lmsApprovalRecord.LOANREVIEWAPPLICATIONID;
                op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                op.ISMANAGEMENTINTERESTRATE = false;
                op.OPERATIONCOMPLETED = false;
                op.CREATEDBY = userModel.staffId;
                lmsApprovalRecord.OPERATIONPERFORMED = true;

                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanTenorExtended,
                    STAFFID = userModel.createdBy,
                    BRANCHID = (short)userModel.userBranchId,
                    DETAIL = $"Line Operation with LoanId '{lmsApprovalRecord.LOANID}'",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = userModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };
                context.TBL_AUDIT.Add(audit);

                //output = context.SaveChanges() > 0;
                if (userModel.fees != null)
                {
                    LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                    feeDetails.feeDetails = userModel.fees;
                    feeDetails.createdBy = userModel.createdBy;
                    feeDetails.userIPAddress = userModel.userIPAddress;
                    feeDetails.userBranchId = userModel.userBranchId;
                    feeDetails.applicationUrl = userModel.applicationUrl;
                    feeDetails.companyId = userModel.companyId;
                    feeDetails.loanOperationReviewId = op.LOANREVIEWOPERATIONID;
                    output = SubmitTakeFee(feeDetails);
                }
                else
                {
                    output = context.SaveChanges() > 0;
                }
                return output;

            }
        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public int LineOperationGoForApproval(ApprovalViewModel userModel)
        {
            var twoFADetails = new TwoFactorAutheticationViewModel
            {
                passcode = userModel.passCode,
                username = userModel.userName
            };
            using (var trans = context.Database.BeginTransaction())
            {
                try
                {

                    workFlow.StaffId = userModel.staffId;
                    workFlow.CompanyId = userModel.companyId;
                    workFlow.StatusId = ((int)userModel.approvalStatusId == (int)ApprovalStatusEnum.Approved) ? (int)ApprovalStatusEnum.Processing : (int)userModel.approvalStatusId;
                    workFlow.TargetId = userModel.targetId;
                    workFlow.Comment = userModel.comment;
                    workFlow.OperationId = userModel.operationId;
                    //workFlow.OperationId = (int)OperationsEnum.TenorChange;
                    workFlow.DeferredExecution = true;
                    workFlow.ExternalInitialization = false;

                    workFlow.LogActivity();


                    if (userModel.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                    {

                        var reviewLine = context.TBL_LOAN_REVIEW_OPERATION.Find(userModel.targetId);
                        var fees = context.TBL_LOAN_FEE.Where(a => a.LOANREVIEWOPERATIONID == reviewLine.LOANREVIEWOPERATIONID && a.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending).ToList();

                        foreach (var a in fees)
                        {
                            a.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                        }
                        reviewLine.APPROVALSTATUSID = (short)ApprovalStatusEnum.Disapproved;
                        context.SaveChanges();
                        trans.Commit();
                        return 2;
                    }
                    bool response = false;

                    if (workFlow.NewState == (int)ApprovalState.Ended)
                    {
                        if (twoFADetails != null && admin.TwoFactorAuthenticationEnabled())
                        {
                            var authenticated = twoFactoeAuth.Authenticate(twoFADetails.username, twoFADetails.passcode);

                            if (authenticated.authenticated == false)
                                throw new TwoFactorAuthenticationException(authenticated.message);
                        }
                        twoFADetails.skipAuthentication = true;


                        TBL_LOAN_REVIEW_OPERATION op = new TBL_LOAN_REVIEW_OPERATION();
                        op = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == userModel.targetId).FirstOrDefault();
                        LoanReviewViewModel loanView = new LoanReviewViewModel();
                        loanView.userBranchId = (short)userModel.BranchId;
                        loanView.applicationUrl = userModel.applicationUrl;
                        loanView.createdBy = userModel.staffId;
                        loanView.companyId = userModel.companyId;
                        loanView.staffId = userModel.staffId;

                        var fees = context.TBL_LOAN_FEE.Where(a => a.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID && a.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending).ToList();

                        foreach (var item in fees)
                        {
                            var feePostings = BuildLoanOperationsManualChargeFeesPosting(item.LOANCHARGEFEEID);

                            if (feePostings != null)
                            {
                                twoFADetails.skipAuthentication = true;
                                financeTransaction.PostTransaction(feePostings, false, twoFADetails);
                            }
                            item.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                        }

                        if (userModel.operationId == (int)OperationsEnum.TenorChange)
                        {
                            var result = context.TBL_LOAN_APPLICATION_DETAIL.Find(op.LOANID);

                            result.APPROVEDTENOR = result.APPROVEDTENOR + (int)op.TENOR;
                            if (result.EXPIRYDATE != null)
                            {
                                var expiryDate = (DateTime)result.EXPIRYDATE;
                                result.EXPIRYDATE = expiryDate.AddDays((int)op.TENOR);
                            }
                            else if (result.EFFECTIVEDATE != null)
                            {
                                result.EXPIRYDATE = result.EFFECTIVEDATE.Value.AddDays(result.APPROVEDTENOR);
                            }
                            ArchiveLoanApplicationDetails(result.LOANAPPLICATIONDETAILID);
                            var lmsApprovalRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == op.LOANID && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).FirstOrDefault();

                            op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                            response = context.SaveChanges() > 0;
                        }
                        else if (userModel.operationId == (int)OperationsEnum.FacilityLineAmountChange)
                        {
                            loanView.newAmount = (decimal)op.PREPAYMENT;
                            loanView.loanApplicationDetailId = op.LOANID;
                            response = changeApplicationLineAmount(loanView);
                        }
                        else if (userModel.operationId == (int)OperationsEnum.ContractualInterestRateChange)
                        {
                            loanView.newRate = (double)op.INTERATERATE;
                            loanView.loanApplicationDetailId = op.LOANID;
                            response = ReviewApplicationLineRate(loanView);
                        }


                        if (response)
                        {
                            try
                            {
                                op.OPERATIONCOMPLETED = true;
                                context.SaveChanges();
                                trans.Commit();
                            }
                            catch (Exception ex)
                            {
                                var EXE = ex;
                            }
                        }
                        else throw new ConditionNotMetException("One or more errors occured on commit.");
                        return 1;
                    }
                    else
                    {
                        trans.Commit();
                    }

                    return 0;
                }
                catch (Exception ex)
                {
                    trans.Rollback();
                    throw ex;
                }
            }

        }

        public bool addMaturityInstruction(MaturityIntructionViewModel model)
        {
            var systemDate = generalSetup.GetApplicationDate();

            if (context.TBL_LOAN_MATURITY_INSTRUCTION.Where(x => x.LOANID == model.loanId && x.ISUSED == false).Any())
                throw new BadImageFormatException("There is already an an active maturity instruction on this loan");

            TBL_LOAN_MATURITY_INSTRUCTION maturity = new TBL_LOAN_MATURITY_INSTRUCTION();

            maturity.LOANID = model.loanId;
            maturity.LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.TermDisbursedFacility;
            maturity.INSTRUCTIONTYPEID = model.instructionTypeId;
            maturity.TENOR = model.tenor;
            maturity.CREATEDBY = model.createdBy;
            maturity.DATETIMECREATED = DateTime.Now;
            maturity.ISUSED = false;
            this.context.TBL_LOAN_MATURITY_INSTRUCTION.Add(maturity);

            return context.SaveChanges() > 0;
        }

        public bool ApproveMaturityInstructionRequest(MaturityIntructionViewModel model)
        {
            var systemDate = generalSetup.GetApplicationDate();

            if (context.TBL_LOAN_MATURITY_INSTRUCTION.Where(x => x.LOANID == model.loanId && x.ISUSED == false).Any())
                throw new ConditionNotMetException("There is already an an active maturity instruction on this loan");

            //var validate = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == model.loanId && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility && x.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing).FirstOrDefault();

            //if (validate != null)
            //{
            //    return false;
            //}


            TBL_LOAN_REVIEW_OPERATION op = new TBL_LOAN_REVIEW_OPERATION();
            bool output = false;

            if (model.loanReviewOperationsId == 0)
            {
                var lmsApprovalRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == model.loanId && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility).FirstOrDefault();
                lmsApprovalRecord.OPERATIONPERFORMED = true;


                op.LOANID = lmsApprovalRecord.LOANID;
                op.LOANSYSTEMTYPEID = lmsApprovalRecord.LOANSYSTEMTYPEID;
                op.OPERATIONTYPEID = (short)OperationsEnum.CommercialLoanRollOver;//(int)model.operationId;
                op.REVIEWDETAILS = "RollOver";
                op.TENOR = model.newTenor;
                op.MATURITYINSTRUCTIONTYPEID = (short)model.maturityInstructionId;
                op.LOANREVIEWAPPLICATIONID = lmsApprovalRecord.LOANREVIEWAPPLICATIONID;
                op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;
                op.ISMANAGEMENTINTERESTRATE = false;
                op.OPERATIONCOMPLETED = false;
                op.CREATEDBY = model.createdBy;
                op.DATECREATED = DateTime.Now;

                context.TBL_LOAN_REVIEW_OPERATION.Add(op);

                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.maturityInstruction,
                    STAFFID = model.createdBy,
                    BRANCHID = (short)model.userBranchId,
                    DETAIL = $"Rolled over loan with loanid '{lmsApprovalRecord.LOANID}'",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = model.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };

                using (var trans = context.Database.BeginTransaction())
                {
                    context.TBL_AUDIT.Add(audit);

                    output = context.SaveChanges() > 0;

                    //productBehaviour.TEMP_PRODUCTID = product.TEMP_PRODUCTID;


                    var entity = new ApprovalViewModel
                    {
                        staffId = model.createdBy,
                        companyId = model.companyId,
                        approvalStatusId = (int)ApprovalStatusEnum.Pending,
                        comment = "Please approve this Roll-Over Operation",
                        targetId = op.LOANREVIEWOPERATIONID,
                        operationId = (short)OperationsEnum.CommercialLoanRollOver,
                        BranchId = model.userBranchId,
                        externalInitialization = true
                    };
                    var response = workFlow.LogForApproval(entity);

                    if (response)
                    {
                        if (model.fees != null)
                        {
                            LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                            feeDetails.feeDetails = model.fees;
                            feeDetails.createdBy = model.createdBy;
                            feeDetails.userIPAddress = model.userIPAddress;
                            feeDetails.userBranchId = model.userBranchId;
                            feeDetails.applicationUrl = model.applicationUrl;
                            feeDetails.companyId = model.companyId;
                            feeDetails.loanOperationReviewId = op.LOANREVIEWOPERATIONID;
                            output = SubmitTakeFee(feeDetails);
                        }
                        else
                        {
                            output = context.SaveChanges() > 0;
                        }


                        trans.Commit();
                        return output;
                    }
                    else { trans.Rollback(); }
                }
                return output;
            }
            else
            {
                var lmsApprovalRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == model.loanId && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility).FirstOrDefault();
                lmsApprovalRecord.OPERATIONPERFORMED = true;

                var reviewOperation = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == model.loanReviewOperationsId).FirstOrDefault();




                reviewOperation.REVIEWDETAILS = "RollOver";
                reviewOperation.TENOR = model.newTenor;
                reviewOperation.OPERATIONCOMPLETED = false;
                reviewOperation.MATURITYINSTRUCTIONTYPEID = (short)model.maturityInstructionId;


                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.maturityInstruction,
                    STAFFID = model.createdBy,
                    BRANCHID = (short)model.userBranchId,
                    DETAIL = $"Rolled over loan with loanid '{lmsApprovalRecord.LOANID}'",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = model.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };

                context.TBL_AUDIT.Add(audit);

                if (model.fees != null)
                {
                    LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                    feeDetails.feeDetails = model.fees;
                    feeDetails.createdBy = model.createdBy;
                    feeDetails.userIPAddress = model.userIPAddress;
                    feeDetails.userBranchId = model.userBranchId;
                    feeDetails.applicationUrl = model.applicationUrl;
                    feeDetails.companyId = model.companyId;
                    feeDetails.loanOperationReviewId = reviewOperation.LOANREVIEWOPERATIONID;
                    output = SubmitTakeFee(feeDetails);
                }
                else
                {
                    output = context.SaveChanges() > 0;
                }


                return output;

            }
        }

        public bool ProcessGlobalInterestRepricing(DateTime effectiveDate, int productPriceIndexID, short staffId)
        {

            var loans = from a in context.TBL_LOAN
                        where a.MATURITYDATE >= effectiveDate && a.LOANSTATUSID == (short)LoanStatusEnum.Active && a.PRODUCTPRICEINDEXID == productPriceIndexID
                        select a;

            LoanPaymentRestructureScheduleInputViewModel loanInput = new LoanPaymentRestructureScheduleInputViewModel();

            foreach (var item in loans)
            {
                var priceIndex = context.TBL_PRODUCT_PRICE_INDEX.FirstOrDefault(x => x.PRODUCTPRICEINDEXID == item.PRODUCTPRICEINDEXID);
                if (priceIndex != null)
                {
                    var customerRate = item.INTERESTRATE - item.PRODUCTPRICEINDEXRATE;
                    var newInterestRate = priceIndex.PRICEINDEXRATE + customerRate;

                    loanInput.operationId = (int)OperationsEnum.InterestRepricing; // item.OPERATIONID;
                    loanInput.loanId = item.TERMLOANID;
                    loanInput.interestRate = newInterestRate;
                    //loanInput.

                    TBL_LOAN_REVIEW_OPERATION reviewOperation = new TBL_LOAN_REVIEW_OPERATION();

                    context.TBL_LOAN_REVIEW_OPERATION.Add(new TBL_LOAN_REVIEW_OPERATION
                    {
                        LOANID = item.TERMLOANID,
                        LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.TermDisbursedFacility,//reviewApplicationDetail.LOANSYSTEMTYPEID, // model.loanSystemTypeId,
                        OPERATIONTYPEID = (int)OperationsEnum.GlobalInterestRateChange,
                        EFFECTIVEDATE = effectiveDate,
                        //REVIEWDETAILS = model.reviewDetails,
                        INTERATERATE = newInterestRate,
                        PREPAYMENT = item.OUTSTANDINGPRINCIPAL,
                        PRINCIPALFREQUENCYTYPEID = item.PRINCIPALFREQUENCYTYPEID,
                        INTERESTFREQUENCYTYPEID = item.INTERESTFREQUENCYTYPEID,
                        PRINCIPALFIRSTPAYMENTDATE = item.FIRSTPRINCIPALPAYMENTDATE,
                        INTERESTFIRSTPAYMENTDATE = item.FIRSTINTERESTPAYMENTDATE,
                        MATURITYDATE = item.MATURITYDATE,
                        //TENOR = item.,
                        //CASA_ACCOUNTID = model.cASA_AccountId,
                        //OVERDRAFTTOPUP = model.overDraftTopup,
                        //FEE_CHARGES = model.fee_Charges,
                        APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved,
                        ISMANAGEMENTINTERESTRATE = false,
                        SCHEDULETYPEID = item.SCHEDULETYPEID,
                        SCHEDULEDAYINTERESTTYPEID = item.SCHEDULEDAYINTERESTTYPEID,
                        SCHEDULEDAYCOUNTCONVENTIONID = item.SCHEDULEDAYCOUNTCONVENTIONID,
                        OPERATIONCOMPLETED = false,
                        CREATEDBY = staffId,
                        DATECREATED = DateTime.Now,
                    });

                    context.SaveChanges();

                    InterestRateReview((int)loanInput.loanId, loanInput, effectiveDate, staffId);

                    item.PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE;
                    return true;

                }
            }

            //if (loans.Count() > 0)
            //{
            //    context.SaveChanges();
            //    return true;
            //}

            return false;
        }

        public void ProcessGlobalInterestRepricing(DateTime effectiveDate, int productPriceIndexID, short staffId, bool isMarketInduced, int productPriceIndexGlobalId)
        {
            using (var context = new FinTrakBankingContext())
            {
                var loans = (from a in context.TBL_LOAN
                             where a.MATURITYDATE >= effectiveDate && a.LOANSTATUSID == (short)LoanStatusEnum.Active && a.PRODUCTPRICEINDEXID == productPriceIndexID
                             select a).ToList();

                LoanPaymentRestructureScheduleInputViewModel loanInput = new LoanPaymentRestructureScheduleInputViewModel();

                foreach (var item in loans)
                {

                    //if (item.TERMLOANID == 7967)
                    //{
                    //    int me = 0;
                    //}

                    var priceIndex = context.TBL_PRODUCT_PRICE_INDEX.FirstOrDefault(x => x.PRODUCTPRICEINDEXID == item.PRODUCTPRICEINDEXID);
                    if (priceIndex != null)
                    {
                        var customerRate = item.INTERESTRATE - item.PRODUCTPRICEINDEXRATE;
                        var newInterestRate = priceIndex.PRICEINDEXRATE + customerRate;

                        loanInput.operationId = (int)OperationsEnum.InterestRepricing; // item.OPERATIONID;
                        loanInput.loanId = item.TERMLOANID;
                        loanInput.interestRate = newInterestRate;
                        loanInput.interestFrequencyTypeId = item.INTERESTFREQUENCYTYPEID;
                        loanInput.principalFrequencyTypeId = item.PRINCIPALFREQUENCYTYPEID;
                        loanInput.principalAmount = (double)item.OUTSTANDINGPRINCIPAL;
                        loanInput.scheduleMethodId = item.SCHEDULETYPEID;
                        loanInput.maturityDate = item.MATURITYDATE;
                        loanInput.interestFirstpaymentDate = (DateTime)item.FIRSTINTERESTPAYMENTDATE;
                        loanInput.principalFirstpaymentDate = (DateTime)item.FIRSTPRINCIPALPAYMENTDATE;

                        if (effectiveDate > item.EFFECTIVEDATE)
                        {
                            loanInput.effectiveDate = effectiveDate;
                            loanInput.isExistingFacility = true;
                        }
                        else
                        {
                            loanInput.effectiveDate = item.EFFECTIVEDATE;
                            loanInput.isExistingFacility = false;
                        }

                        //loanInput.

                        TBL_LOAN_REVIEW_OPERATION reviewOperation = new TBL_LOAN_REVIEW_OPERATION();

                        try
                        {
                            reviewOperation = new TBL_LOAN_REVIEW_OPERATION
                            {
                                LOANID = item.TERMLOANID,
                                LOANSYSTEMTYPEID = (int)LoanSystemTypeEnum.TermDisbursedFacility,//reviewApplicationDetail.LOANSYSTEMTYPEID, // model.loanSystemTypeId,
                                OPERATIONTYPEID = (int)OperationsEnum.InterestRepricing,
                                EFFECTIVEDATE = effectiveDate,
                                REVIEWDETAILS = "Global Interest Rate Change",
                                INTERATERATE = newInterestRate,
                                PREPAYMENT = item.OUTSTANDINGPRINCIPAL,
                                PRINCIPALFREQUENCYTYPEID = item.PRINCIPALFREQUENCYTYPEID,
                                INTERESTFREQUENCYTYPEID = item.INTERESTFREQUENCYTYPEID,
                                PRINCIPALFIRSTPAYMENTDATE = item.FIRSTPRINCIPALPAYMENTDATE,
                                INTERESTFIRSTPAYMENTDATE = item.FIRSTINTERESTPAYMENTDATE,
                                MATURITYDATE = item.MATURITYDATE,
                                //TENOR = item.,
                                //CASA_ACCOUNTID = model.cASA_AccountId,
                                //OVERDRAFTTOPUP = model.overDraftTopup,
                                //FEE_CHARGES = model.fee_Charges,
                                APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved,
                                ISMANAGEMENTINTERESTRATE = false,
                                SCHEDULETYPEID = item.SCHEDULETYPEID,
                                SCHEDULEDAYINTERESTTYPEID = item.SCHEDULEDAYINTERESTTYPEID,
                                SCHEDULEDAYCOUNTCONVENTIONID = item.SCHEDULEDAYCOUNTCONVENTIONID,
                                OPERATIONCOMPLETED = false,
                                CREATEDBY = staffId,
                                DATECREATED = DateTime.Now,
                                ISMARKETINDUCED = isMarketInduced,
                                PRODUCTPRICEINDEXGLOBALID = productPriceIndexGlobalId,
                            };

                            context.TBL_LOAN_REVIEW_OPERATION.Add(reviewOperation);
                        }
                        catch (Exception ex)
                        {

                            throw ex;
                        }


                        try
                        {
                            context.SaveChanges();
                        }
                        catch (Exception ex)
                        {
                            throw ex;
                        }

                        loanInput.loanReviewOperationsId = reviewOperation.LOANREVIEWOPERATIONID;

                        try
                        {
                            InterestRateReview((int)loanInput.loanId, loanInput, effectiveDate, staffId, context);
                        }
                        catch (Exception ex)
                        {

                            throw ex;
                        }



                        item.PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE;
                        item.INTERESTRATE = newInterestRate;

                    }
                }

                if (loans.Count() > 0)
                    context.SaveChanges();
            }
        }

        //public void ProcessGlobalInterestRepricing(DateTime effectiveDate, int productPriceIndexID, short staffId, bool isMarketInduced, int productPriceIndexGlobalId)
        //{
        //    var loans = (from a in context.TBL_LOAN
        //                 where a.MATURITYDATE >= effectiveDate && a.LOANSTATUSID == (short)LoanStatusEnum.Active && a.PRODUCTPRICEINDEXID == productPriceIndexID
        //                 select a).ToList();

        //    LoanPaymentRestructureScheduleInputViewModel loanInput = new LoanPaymentRestructureScheduleInputViewModel();

        //    foreach (var item in loans)
        //    {

        //        //if (item.TERMLOANID == 7967)
        //        //{
        //        //    int me = 0;
        //        //}

        //        var priceIndex = context.TBL_PRODUCT_PRICE_INDEX.FirstOrDefault(x => x.PRODUCTPRICEINDEXID == item.PRODUCTPRICEINDEXID);
        //        if (priceIndex != null)
        //        {
        //            var customerRate = item.INTERESTRATE - item.PRODUCTPRICEINDEXRATE;
        //            var newInterestRate = priceIndex.PRICEINDEXRATE + customerRate;

        //            loanInput.operationId = (int)OperationsEnum.InterestRepricing; // item.OPERATIONID;
        //            loanInput.loanId = item.TERMLOANID;
        //            loanInput.interestRate = newInterestRate;
        //            loanInput.interestFrequencyTypeId = item.INTERESTFREQUENCYTYPEID;
        //            loanInput.principalFrequencyTypeId = item.PRINCIPALFREQUENCYTYPEID;
        //            loanInput.principalAmount = (double)item.OUTSTANDINGPRINCIPAL;
        //            loanInput.scheduleMethodId = item.SCHEDULETYPEID;
        //            loanInput.maturityDate = item.MATURITYDATE;
        //            loanInput.interestFirstpaymentDate = (DateTime)item.FIRSTINTERESTPAYMENTDATE;
        //            loanInput.principalFirstpaymentDate = (DateTime)item.FIRSTPRINCIPALPAYMENTDATE;

        //            if (effectiveDate > item.EFFECTIVEDATE)
        //            {
        //                loanInput.effectiveDate = effectiveDate;
        //                loanInput.isExistingFacility = true;
        //            }
        //            else
        //            {
        //                loanInput.effectiveDate = item.EFFECTIVEDATE;
        //                loanInput.isExistingFacility = false;
        //            }

        //            //loanInput.

        //            TBL_LOAN_REVIEW_OPERATION reviewOperation = new TBL_LOAN_REVIEW_OPERATION();

        //            try
        //            {
        //                reviewOperation = new TBL_LOAN_REVIEW_OPERATION
        //                {
        //                    LOANID = item.TERMLOANID,
        //                    LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.TermDisbursedFacility,//reviewApplicationDetail.LOANSYSTEMTYPEID, // model.loanSystemTypeId,
        //                    OPERATIONTYPEID = (int)OperationsEnum.InterestRepricing,
        //                    EFFECTIVEDATE = effectiveDate,
        //                    REVIEWDETAILS = "Global Interest Rate Change",
        //                    INTERATERATE = newInterestRate,
        //                    PREPAYMENT = item.OUTSTANDINGPRINCIPAL,
        //                    PRINCIPALFREQUENCYTYPEID = item.PRINCIPALFREQUENCYTYPEID,
        //                    INTERESTFREQUENCYTYPEID = item.INTERESTFREQUENCYTYPEID,
        //                    PRINCIPALFIRSTPAYMENTDATE = item.FIRSTPRINCIPALPAYMENTDATE,
        //                    INTERESTFIRSTPAYMENTDATE = item.FIRSTINTERESTPAYMENTDATE,
        //                    MATURITYDATE = item.MATURITYDATE,
        //                    //TENOR = item.,
        //                    //CASA_ACCOUNTID = model.cASA_AccountId,
        //                    //OVERDRAFTTOPUP = model.overDraftTopup,
        //                    //FEE_CHARGES = model.fee_Charges,
        //                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved,
        //                    ISMANAGEMENTINTERESTRATE = false,
        //                    SCHEDULETYPEID = item.SCHEDULETYPEID,
        //                    SCHEDULEDAYINTERESTTYPEID = item.SCHEDULEDAYINTERESTTYPEID,
        //                    SCHEDULEDAYCOUNTCONVENTIONID = item.SCHEDULEDAYCOUNTCONVENTIONID,
        //                    OPERATIONCOMPLETED = false,
        //                    CREATEDBY = staffId,
        //                    DATECREATED = DateTime.Now,
        //                    ISMARKETINDUCED = isMarketInduced,
        //                    PRODUCTPRICEINDEXGLOBALID = productPriceIndexGlobalId,
        //                };

        //                context.TBL_LOAN_REVIEW_OPERATION.Add(reviewOperation);
        //            }
        //            catch (Exception ex)
        //            {

        //                throw ex;
        //            }


        //            try
        //            {
        //                context.SaveChanges();
        //            }
        //            catch (Exception ex)
        //            {
        //                throw ex;
        //            }

        //            loanInput.loanReviewOperationsId = reviewOperation.LOANREVIEWOPERATIONID;

        //            try
        //            {
        //                InterestRateReview((int)loanInput.loanId, loanInput, effectiveDate, staffId);
        //            }
        //            catch (Exception ex)
        //            {

        //                throw ex;
        //            }


        //            item.PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE;


        //        }
        //    }

        //    if (loans.Count() > 0)
        //        context.SaveChanges();
        //}

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool ApproveCommercialPaperManualRollOverRequest(MaturityIntructionViewModel userModel, string refNo)
        {
            //var validate = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == userModel.loanId && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility && (x.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing || x.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending)).FirstOrDefault();

            //if (validate != null)
            //{
            //    return false;
            //}

            TBL_LOAN_REVIEW_OPERATION op = new TBL_LOAN_REVIEW_OPERATION();

            var lmsApprovalRecord = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANID == userModel.loanId && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility).FirstOrDefault();

            var rec = context.TBL_LOAN.Where(x => x.TERMLOANID == userModel.loanId).FirstOrDefault();

            lmsApprovalRecord.OPERATIONPERFORMED = true;


            op.LOANID = lmsApprovalRecord.LOANID;
            op.LOANSYSTEMTYPEID = lmsApprovalRecord.LOANSYSTEMTYPEID;
            op.OPERATIONTYPEID = (short)OperationsEnum.CommercialLoanRollOver;
            op.REVIEWDETAILS = "RollOver";
            op.EFFECTIVEDATE = rec.EFFECTIVEDATE;
            op.MATURITYDATE = rec.EFFECTIVEDATE.AddDays(userModel.newTenor);
            op.TENOR = userModel.newTenor;
            op.MATURITYINSTRUCTIONTYPEID = (short)userModel.maturityInstructionId;
            op.LOANREVIEWAPPLICATIONID = lmsApprovalRecord.LOANREVIEWAPPLICATIONID;
            op.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;
            op.ISMANAGEMENTINTERESTRATE = false;
            op.OPERATIONCOMPLETED = false;
            op.CREATEDBY = userModel.staffId;
            op.DATECREATED = DateTime.Now;

            context.TBL_LOAN_REVIEW_OPERATION.Add(op);

            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.LoanRolledOver,
                STAFFID = userModel.createdBy,
                BRANCHID = (short)userModel.userBranchId,
                DETAIL = $"Rolled over loan with loanid '{lmsApprovalRecord.LOANID}'",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = userModel.applicationUrl,
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName()
            };

            bool output = false;

            using (var trans = context.Database.BeginTransaction())
            {
                try
                {
                    context.TBL_AUDIT.Add(audit);

                    output = context.SaveChanges() > 0;

                    var entity = new ApprovalViewModel
                    {
                        staffId = userModel.createdBy,
                        companyId = userModel.companyId,
                        approvalStatusId = (int)ApprovalStatusEnum.Pending,
                        comment = "Please approve this Roll-Over Operation",
                        targetId = op.LOANREVIEWOPERATIONID,
                        operationId = (short)OperationsEnum.CommercialLoanRollOver,
                        BranchId = userModel.userBranchId,
                        externalInitialization = true
                    };
                    var response = workFlow.LogForApproval(entity);

                    if (response)
                    {
                        trans.Commit();
                        return output;
                    }
                }
                catch (Exception ex)
                {
                    trans.Rollback();
                    throw ex;
                }
            }
            return output;

        }

        public bool RolloverCommercialLoanByManualProcess(MaturityIntructionViewModel model, string refNo)
        {
            var systemDate = generalSetup.GetApplicationDate();
            TBL_LOAN result;

            if (model.loanReferenceNumber != null)
                result = (from p in context.TBL_LOAN where p.LOANREFERENCENUMBER == refNo select p).FirstOrDefault();
            else
                result = context.TBL_LOAN.Find(model.loanId);

            if (result == null)
                throw new ConditionNotMetException("No loan was selected.");

            if (model.valueDate < result.MATURITYDATE)
                throw new ConditionNotMetException("The value date cannot be less than the parent loan maturity date");

            if (model.valueDate == null) model.valueDate = result.MATURITYDATE;

            var loanReferenceNumber = loanGenerate.GenerateLoanReferenceNumber(result.BRANCHID, result.PRODUCTID, result.LOANSYSTEMTYPEID);

            if (model.valueDate == null) model.valueDate = result.MATURITYDATE;

            var newMaturityDate = model.valueDate?.AddDays(model.tenor);

            var newInterest = loanGenerate.getTotalInterest(result.PRINCIPALAMOUNT, result.INTERESTRATE, (newMaturityDate.Value - model.valueDate.Value).Days, DayCountConventionEnum.Actual_Actual);

            result.LOANSTATUSID = (short)LoanStatusEnum.Completed;

            TBL_LOAN newCommercialLoanLineEntry = new TBL_LOAN();
            newCommercialLoanLineEntry = FetchCommercialLoanTableRecords(result);
            newCommercialLoanLineEntry.LOANREFERENCENUMBER = loanReferenceNumber;
            newCommercialLoanLineEntry.OUTSTANDINGINTEREST = newInterest;
            newCommercialLoanLineEntry.EFFECTIVEDATE = model.valueDate.Value;
            newCommercialLoanLineEntry.MATURITYDATE = newMaturityDate.Value;
            newCommercialLoanLineEntry.FIRSTINTERESTPAYMENTDATE = newMaturityDate.Value;
            newCommercialLoanLineEntry.FIRSTPRINCIPALPAYMENTDATE = newMaturityDate.Value;
            newCommercialLoanLineEntry.CREATEDBY = model.staffId;

            var newLoanId = ReBookLoan(newCommercialLoanLineEntry);
            if (newLoanId > 0)
            {
                var xloan = context.TBL_LOAN.Find(newLoanId);
                var loanModel = GetCommercialLoanViewModel(newCommercialLoanLineEntry);
                loanModel.loanId = xloan.TERMLOANID;
                loanModel.loanReferenceNumber = xloan.LOANREFERENCENUMBER;
                loanModel.relatedloanReferenceNumber = xloan.RELATED_LOAN_REFERENCE_NUMBER;

                // *** Post Product Fee charges *** //
                //application.
                //if (loanModel.loanChargeFee != null)loanGenerate.PostLoanFees(loanModel);

                //*** Disburse new loan ***/
                var loanScheduleModel = loanGenerate.BuildScheduleModel(xloan.TERMLOANID, model.createdBy);
                var loanDisbursementModel = loanGenerate.BuildDisbursementModel(xloan.TERMLOANID, loanScheduleModel, model.createdBy);

                var twoFactorAuthentication = new TwoFactorAutheticationViewModel();
                twoFactorAuthentication.username = model.username;
                twoFactorAuthentication.passcode = model.passCode;
                twoFactorAuthentication.skipAuthentication = true; //Temporary measure held until two factor is implemented at the front end.
                if (context.TBL_SETUP_GLOBAL.FirstOrDefault().USERSPECIFIC2FA == true)
                {
                    twoFactorAuthentication.username = context.TBL_STAFF.Find(model.staffId).STAFFCODE;
                }

                loanGenerate.DisburseLoan(loanDisbursementModel, twoFactorAuthentication);

                //Audit Section ---------------------------
                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanRolledOver,
                    STAFFID = model.createdBy,
                    BRANCHID = (short)model.userBranchId,
                    DETAIL = $"Rolled over loan with reference number '{result.LOANREFERENCENUMBER}'. New reference number is '{loanReferenceNumber}'",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = model.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };
                context.TBL_AUDIT.Add(audit);
                //end of Audit section -------------------------------

                //trans.Commit();
                return context.SaveChanges() > 0;
            }
            else
            {
                //trans.Rollback();
                throw new ConditionNotMetException("Commercial Loan rollover transaction unable to complete.");
            }
        }

        private LoanViewModel GetCommercialLoanViewModel(TBL_LOAN newCommercialLoanLineEntry)
        {
            var loanModel = new LoanViewModel
            {
                productPriceIndexRate = newCommercialLoanLineEntry.PRODUCTPRICEINDEXRATE,
                customerId = newCommercialLoanLineEntry.CUSTOMERID,
                productId = newCommercialLoanLineEntry.PRODUCTID,
                operationId = newCommercialLoanLineEntry.OPERATIONID,
                companyId = newCommercialLoanLineEntry.COMPANYID,
                loanApplicationDetailId = newCommercialLoanLineEntry.LOANAPPLICATIONDETAILID,
                casaAccountId = newCommercialLoanLineEntry.CASAACCOUNTID,
                casaAccountId2 = newCommercialLoanLineEntry.CASAACCOUNTID2,
                loanSystemTypeId = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                branchId = newCommercialLoanLineEntry.BRANCHID,
                subSectorId = newCommercialLoanLineEntry.SUBSECTORID,
                currencyId = newCommercialLoanLineEntry.CURRENCYID,
                exchangeRate = newCommercialLoanLineEntry.EXCHANGERATE,
                loanReferenceNumber = newCommercialLoanLineEntry.LOANREFERENCENUMBER,
                relatedloanReferenceNumber = newCommercialLoanLineEntry.RELATED_LOAN_REFERENCE_NUMBER,
                principalNumberOfInstallment = newCommercialLoanLineEntry.PRINCIPALNUMBEROFINSTALLMENT,
                interestNumberOfInstallment = newCommercialLoanLineEntry.INTERESTINSTALLMENTLEFT,
                interestRate = newCommercialLoanLineEntry.INTERESTRATE,
                effectiveDate = newCommercialLoanLineEntry.EFFECTIVEDATE,
                maturityDate = newCommercialLoanLineEntry.MATURITYDATE,
                bookingDate = newCommercialLoanLineEntry.BOOKINGDATE,
                principalAmount = newCommercialLoanLineEntry.PRINCIPALAMOUNT,
                loanBookingRequestId = (int)newCommercialLoanLineEntry.LOAN_BOOKING_REQUESTID,
                principalInstallmentLeft = newCommercialLoanLineEntry.PRINCIPALINSTALLMENTLEFT,
                interestInstallmentLeft = newCommercialLoanLineEntry.INTERESTINSTALLMENTLEFT,
                scheduleTypeId = newCommercialLoanLineEntry.SCHEDULETYPEID,
                firstInterestPaymentDate = newCommercialLoanLineEntry.FIRSTINTERESTPAYMENTDATE,
                firstPrincipalPaymentDate = newCommercialLoanLineEntry.FIRSTPRINCIPALPAYMENTDATE,
                allowForceDebitRepayment = true,
                externalPrudentialGuidelineStatusId = (short)LoanPrudentialStatusEnum.Performing,
                internalPrudentialGuidelineStatusId = (short)LoanPrudentialStatusEnum.Performing,
                userPrudentialGuidelineStatusId = (short)LoanPrudentialStatusEnum.Performing,
                outstandingPrincipal = newCommercialLoanLineEntry.OUTSTANDINGPRINCIPAL,
                outstandingInterest = newCommercialLoanLineEntry.OUTSTANDINGINTEREST,
                createdBy = newCommercialLoanLineEntry.CREATEDBY,
                dateTimeCreated = newCommercialLoanLineEntry.DATETIMECREATED,
                customerRiskRatingId = newCommercialLoanLineEntry.CUSTOMERRISKRATINGID,
                nplDate = newCommercialLoanLineEntry.NPLDATE,
                loanStatusId = (short)LoanStatusEnum.Active,
                //teamMiscode = newCommercialLoanLineEntry.TEAMMISCODE,

            };



            //newCommercialLoanLineEntry.BOOKINGDATE = systemDate;
            //newCommercialLoanLineEntry.PRINCIPALINSTALLMENTLEFT = 0;
            //newCommercialLoanLineEntry.INTERESTINSTALLMENTLEFT = 0;
            //newCommercialLoanLineEntry.LOANSTATUSID = (short)LoanStatusEnum.Active;
            //newCommercialLoanLineEntry.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
            //newCommercialLoanLineEntry.SHOULD_DISBURSE = true;
            //newCommercialLoanLineEntry.ISDISBURSED = true;
            //newCommercialLoanLineEntry.DATETIMECREATED = DateTime.Now;
            //newCommercialLoanLineEntry.BRANCHID = loanRecord.BRANCHID;
            //newCommercialLoanLineEntry.SUBSECTORID = loanRecord.SUBSECTORID;

            //newCommercialLoanLineEntry.PRINCIPALNUMBEROFINSTALLMENT = loanRecord.PRINCIPALNUMBEROFINSTALLMENT;
            //newCommercialLoanLineEntry.INTERESTNUMBEROFINSTALLMENT = loanRecord.INTERESTINSTALLMENTLEFT;
            //newCommercialLoanLineEntry.RELATIONSHIPOFFICERID = loanRecord.RELATIONSHIPOFFICERID;
            //newCommercialLoanLineEntry.RELATIONSHIPMANAGERID = loanRecord.RELATIONSHIPMANAGERID;
            //newCommercialLoanLineEntry.MISCODE = loanRecord.MISCODE;
            //newCommercialLoanLineEntry.TEAMMISCODE = loanRecord.TEAMMISCODE;
            //newCommercialLoanLineEntry.INTERESTRATE = loanRecord.INTERESTRATE;
            //newCommercialLoanLineEntry.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
            //newCommercialLoanLineEntry.APPROVERCOMMENT = loanRecord.APPROVERCOMMENT;
            //newCommercialLoanLineEntry.SCHEDULETYPEID = loanRecord.SCHEDULETYPEID;
            //newCommercialLoanLineEntry.SCHEDULEDAYCOUNTCONVENTIONID = loanRecord.SCHEDULEDAYCOUNTCONVENTIONID;
            //newCommercialLoanLineEntry.SCHEDULEDAYINTERESTTYPEID = loanRecord.SCHEDULEDAYINTERESTTYPEID;
            //newCommercialLoanLineEntry.EQUITYCONTRIBUTION = loanRecord.EQUITYCONTRIBUTION;
            //newCommercialLoanLineEntry.PASTDUEPRINCIPAL = loanRecord.PASTDUEPRINCIPAL;
            //newCommercialLoanLineEntry.PASTDUEINTEREST = loanRecord.PASTDUEINTEREST;
            //newCommercialLoanLineEntry.INTERESTONPASTDUEPRINCIPAL = loanRecord.INTERESTONPASTDUEPRINCIPAL;
            //newCommercialLoanLineEntry.INTERESTONPASTDUEINTEREST = loanRecord.INTERESTONPASTDUEINTEREST;
            //newCommercialLoanLineEntry.PENALCHARGEAMOUNT = loanRecord.PENALCHARGEAMOUNT;
            //newCommercialLoanLineEntry.FIXEDPRINCIPAL = loanRecord.FIXEDPRINCIPAL;
            //newCommercialLoanLineEntry.PROFILELOAN = loanRecord.PROFILELOAN;
            //newCommercialLoanLineEntry.DISCHARGELETTER = loanRecord.DISCHARGELETTER;
            //newCommercialLoanLineEntry.SUSPENDINTEREST = loanRecord.SUSPENDINTEREST;
            //newCommercialLoanLineEntry.ALLOWFORCEDEBITREPAYMENT = loanRecord.ALLOWFORCEDEBITREPAYMENT;


            return loanModel;
        }

        private TBL_LOAN FetchCommercialLoanTableRecords(TBL_LOAN loanRecord)
        {
            var systemDate = generalSetup.GetApplicationDate();
            TBL_LOAN newCommercialLoanLineEntry = new TBL_LOAN();
            newCommercialLoanLineEntry.PRINCIPALAMOUNT = loanRecord.PRINCIPALAMOUNT;
            newCommercialLoanLineEntry.OUTSTANDINGPRINCIPAL = loanRecord.OUTSTANDINGPRINCIPAL;
            newCommercialLoanLineEntry.OUTSTANDINGINTEREST = loanRecord.OUTSTANDINGINTEREST;
            newCommercialLoanLineEntry.EFFECTIVEDATE = loanRecord.MATURITYDATE;
            newCommercialLoanLineEntry.MATURITYDATE = loanRecord.MATURITYDATE;
            newCommercialLoanLineEntry.OPERATIONID = loanRecord.OPERATIONID;
            newCommercialLoanLineEntry.RELATED_LOAN_REFERENCE_NUMBER = loanRecord.LOANREFERENCENUMBER;
            newCommercialLoanLineEntry.LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.TermDisbursedFacility;
            newCommercialLoanLineEntry.BOOKINGDATE = systemDate;
            newCommercialLoanLineEntry.PRINCIPALINSTALLMENTLEFT = 0;
            newCommercialLoanLineEntry.INTERESTINSTALLMENTLEFT = 0;
            newCommercialLoanLineEntry.LOANSTATUSID = (short)LoanStatusEnum.Active;
            newCommercialLoanLineEntry.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
            newCommercialLoanLineEntry.SCHEDULETYPEID = loanRecord.SCHEDULETYPEID;
            newCommercialLoanLineEntry.SHOULD_DISBURSE = true;
            newCommercialLoanLineEntry.ISDISBURSED = true;
            newCommercialLoanLineEntry.INT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing;
            newCommercialLoanLineEntry.EXT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing;
            newCommercialLoanLineEntry.USER_PRUDENTIAL_GUIDE_STATUSID = (short)LoanPrudentialStatusEnum.Performing;
            newCommercialLoanLineEntry.CREATEDBY = loanRecord.CREATEDBY;
            newCommercialLoanLineEntry.DATETIMECREATED = DateTime.Now;
            newCommercialLoanLineEntry.LOAN_BOOKING_REQUESTID = loanRecord.LOAN_BOOKING_REQUESTID;
            newCommercialLoanLineEntry.PRODUCTPRICEINDEXRATE = loanRecord.PRODUCTPRICEINDEXRATE;
            newCommercialLoanLineEntry.CUSTOMERRISKRATINGID = loanRecord.CUSTOMERRISKRATINGID;
            newCommercialLoanLineEntry.CUSTOMERID = loanRecord.CUSTOMERID;
            newCommercialLoanLineEntry.PRODUCTID = loanRecord.PRODUCTID;
            newCommercialLoanLineEntry.COMPANYID = loanRecord.COMPANYID;
            newCommercialLoanLineEntry.LOANAPPLICATIONDETAILID = loanRecord.LOANAPPLICATIONDETAILID;
            newCommercialLoanLineEntry.CASAACCOUNTID = loanRecord.CASAACCOUNTID;
            newCommercialLoanLineEntry.CASAACCOUNTID2 = loanRecord.CASAACCOUNTID2;
            newCommercialLoanLineEntry.BRANCHID = loanRecord.BRANCHID;
            newCommercialLoanLineEntry.SUBSECTORID = loanRecord.SUBSECTORID;
            newCommercialLoanLineEntry.CURRENCYID = loanRecord.CURRENCYID;
            newCommercialLoanLineEntry.EXCHANGERATE = loanRecord.EXCHANGERATE;
            newCommercialLoanLineEntry.PRINCIPALNUMBEROFINSTALLMENT = loanRecord.PRINCIPALNUMBEROFINSTALLMENT;
            newCommercialLoanLineEntry.INTERESTNUMBEROFINSTALLMENT = loanRecord.INTERESTINSTALLMENTLEFT;
            newCommercialLoanLineEntry.RELATIONSHIPOFFICERID = loanRecord.RELATIONSHIPOFFICERID;
            newCommercialLoanLineEntry.RELATIONSHIPMANAGERID = loanRecord.RELATIONSHIPMANAGERID;
            newCommercialLoanLineEntry.MISCODE = loanRecord.MISCODE;
            newCommercialLoanLineEntry.TEAMMISCODE = loanRecord.TEAMMISCODE;
            newCommercialLoanLineEntry.INTERESTRATE = loanRecord.INTERESTRATE;
            newCommercialLoanLineEntry.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
            newCommercialLoanLineEntry.APPROVERCOMMENT = loanRecord.APPROVERCOMMENT;
            newCommercialLoanLineEntry.SCHEDULETYPEID = loanRecord.SCHEDULETYPEID;
            newCommercialLoanLineEntry.SCHEDULEDAYCOUNTCONVENTIONID = loanRecord.SCHEDULEDAYCOUNTCONVENTIONID;
            newCommercialLoanLineEntry.SCHEDULEDAYINTERESTTYPEID = loanRecord.SCHEDULEDAYINTERESTTYPEID;
            newCommercialLoanLineEntry.EQUITYCONTRIBUTION = loanRecord.EQUITYCONTRIBUTION;
            newCommercialLoanLineEntry.PASTDUEPRINCIPAL = loanRecord.PASTDUEPRINCIPAL;
            newCommercialLoanLineEntry.PASTDUEINTEREST = loanRecord.PASTDUEINTEREST;
            newCommercialLoanLineEntry.INTERESTONPASTDUEPRINCIPAL = loanRecord.INTERESTONPASTDUEPRINCIPAL;
            newCommercialLoanLineEntry.INTERESTONPASTDUEINTEREST = loanRecord.INTERESTONPASTDUEINTEREST;
            newCommercialLoanLineEntry.PENALCHARGEAMOUNT = loanRecord.PENALCHARGEAMOUNT;
            newCommercialLoanLineEntry.FIXEDPRINCIPAL = loanRecord.FIXEDPRINCIPAL;
            newCommercialLoanLineEntry.PROFILELOAN = loanRecord.PROFILELOAN;
            newCommercialLoanLineEntry.DISCHARGELETTER = loanRecord.DISCHARGELETTER;
            newCommercialLoanLineEntry.SUSPENDINTEREST = loanRecord.SUSPENDINTEREST;
            newCommercialLoanLineEntry.ALLOWFORCEDEBITREPAYMENT = loanRecord.ALLOWFORCEDEBITREPAYMENT;
            newCommercialLoanLineEntry.FIRSTINTERESTPAYMENTDATE = loanRecord.MATURITYDATE;
            newCommercialLoanLineEntry.FIRSTPRINCIPALPAYMENTDATE = loanRecord.MATURITYDATE;
            newCommercialLoanLineEntry.NPLDATE = loanRecord.NPLDATE;

            return newCommercialLoanLineEntry;
        }

        private void RolloverCommercialLoanByAutomaticProcess(TBL_LOAN loanRecord)
        {
            var systemDate = generalSetup.GetApplicationDate();
            loanRecord.LOANSTATUSID = (short)LoanStatusEnum.Completed;
            var loanReferenceNumber = loanGenerate.GenerateLoanReferenceNumber(loanRecord.BRANCHID, loanRecord.PRODUCTID, loanRecord.LOANSYSTEMTYPEID);

            TBL_LOAN newCommercialLoanLineEntry = new TBL_LOAN();

            newCommercialLoanLineEntry = FetchCommercialLoanTableRecords(loanRecord);
            newCommercialLoanLineEntry.LOANREFERENCENUMBER = loanReferenceNumber;

            var newLoanId = ReBookLoan(newCommercialLoanLineEntry);
            //var loanModel = GetCommercialLoanViewModel(newCommercialLoanLineEntry);

            //loanModel.loanId = newLoanId;

            // *** Post Product Fee charges *** //
            // loanGenerate.PostLoanFees(loanModel);

            context.SaveChanges();

        }


        public bool InterestRateReview(int loanId, LoanPaymentRestructureScheduleInputViewModel loanInput, DateTime applicationDate, int staffId, FinTrakBankingContext context)
        {
            bool output = false;

            try
            {
                var systemDate = generalSetup.GetApplicationDate();
                loanInput.date = systemDate;
                var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
                var reviewData = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == loanId && x.OPERATIONTYPEID == loanInput.operationId && x.OPERATIONCOMPLETED == false).FirstOrDefault();

                if (LoanExist(loanId) > 0)
                {

                    var archiveBatchCode = CommonHelpers.GenerateRandomDigitCode(10);

                    DeleteLoanExist(loanId, systemDate, context);
                    ArchiveLoan(loanId, loanInput.operationId, archiveBatchCode, context);/////loanId change this to OperationId
                    ArchivePeriodicSchedule(loanId, archiveBatchCode, context);
                    ArchiveDailySchedule(loanId, archiveBatchCode, context);


                    if (loanInput.scheduleMethodId == (short)LoanScheduleTypeEnum.ConstantPrincipalAndInterest)
                    {

                        //----------generate and save periodic loan schedule -----------------------------------
                        List<LoanPaymentSchedulePeriodicViewModel> periodicScheduleTemp = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_PERIODIC_TMP> tblPeriodicScheduleTemp = new List<TBL_LOAN_SCHEDULE_PERIODIC_TMP>();

                        foreach (var item in periodicScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC_TMP scheduleTemp = new TBL_LOAN_SCHEDULE_PERIODIC_TMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            scheduleTemp.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            scheduleTemp.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.INTERESTRATE = loanInput.interestRate;
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            scheduleTemp.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            scheduleTemp.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            scheduleTemp.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblPeriodicScheduleTemp.Add(scheduleTemp);
                        }
                        //-------------------------------------------------------------------------------------


                        //----------generate and save daily loan schedule -----------------------------------
                        List<LoanPaymentScheduleDailyViewModel> dailyScheduleTemp = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_DAILY_TEMP> tblDailyScheduleTemp = new List<TBL_LOAN_SCHEDULE_DAILY_TEMP>();

                        foreach (var item in dailyScheduleTemp)
                        {
                            TBL_LOAN_SCHEDULE_DAILY_TEMP scheduleTemp = new TBL_LOAN_SCHEDULE_DAILY_TEMP();

                            scheduleTemp.LOANID = loanId;
                            scheduleTemp.PAYMENTNUMBER = item.paymentNumber;
                            scheduleTemp.DATE = item.date;
                            scheduleTemp.PAYMENTDATE = item.paymentDate;
                            scheduleTemp.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                            scheduleTemp.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            scheduleTemp.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                            scheduleTemp.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                            scheduleTemp.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                            scheduleTemp.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                            scheduleTemp.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            scheduleTemp.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                            scheduleTemp.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                            scheduleTemp.INTERESTRATE = item.norminalInterestRate;
                            scheduleTemp.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                            scheduleTemp.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                            scheduleTemp.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                            scheduleTemp.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                            scheduleTemp.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                            scheduleTemp.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                            scheduleTemp.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                            scheduleTemp.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                            scheduleTemp.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                            scheduleTemp.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                            scheduleTemp.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                            scheduleTemp.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                            scheduleTemp.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            scheduleTemp.NUMBEROFPERIODS = item.numberOfPeriods;
                            scheduleTemp.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                            scheduleTemp.CREATEDBY = staffId;
                            scheduleTemp.DATETIMECREATED = systemDate;

                            tblDailyScheduleTemp.Add(scheduleTemp);
                        }
                        //----------------------------------------------------------------


                        //------------adding records to the database--------------------------

                        //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        //{ context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table


                        context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.AddRange(tblPeriodicScheduleTemp);////change to Temp table

                        context.TBL_LOAN_SCHEDULE_DAILY_TEMP.AddRange(tblDailyScheduleTemp); ////change to Temp table
                        context.SaveChanges();

                        MergeDailySchedule(loanId, applicationDate);
                        MergePeriodicSchedule(loanId, applicationDate);

                        //----------update loan details -----------------------------------
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = periodicScheduleTemp.Count() - 1;


                        decimal newOutstandingPrincipal = 0;

                        var loanPeriodicSchedule = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID && x.PAYMENTDATE == applicationDate).FirstOrDefault();

                        if (loanPeriodicSchedule != null)
                        {
                            newOutstandingPrincipal = loanPeriodicSchedule.ENDPRINCIPALAMOUNT;
                        }
                        else
                        {
                            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loan.TERMLOANID && c.PAYMENTDATE < applicationDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();
                            newOutstandingPrincipal = previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;
                        }



                        //loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
                        loan.INTERESTRATE = (double)reviewData.INTERATERATE;
                        loan.OUTSTANDINGPRINCIPAL = newOutstandingPrincipal;
                        //context.SaveChanges();
                        //-------------------------------------------------
                    }
                    else
                    {

                        //----------generate and save periodic loan schedule -----------------------------------
                        List<LoanPaymentSchedulePeriodicViewModel> periodicSchedule = loanSchedule.GeneratePeriodicLoanSchedule(loanInput);

                        List<TBL_LOAN_SCHEDULE_PERIODIC> tblPeriodicSchedule = new List<TBL_LOAN_SCHEDULE_PERIODIC>();

                        foreach (var item in periodicSchedule)
                        {
                            TBL_LOAN_SCHEDULE_PERIODIC schedule = new TBL_LOAN_SCHEDULE_PERIODIC();

                            schedule.LOANID = loanId;
                            schedule.PAYMENTNUMBER = item.paymentNumber;
                            schedule.PAYMENTDATE = item.paymentDate;
                            schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                            schedule.PERIODPAYMENTAMOUNT = Convert.ToDecimal(item.periodPaymentAmount);
                            schedule.PERIODINTERESTAMOUNT = Convert.ToDecimal(item.periodInterestAmount);
                            schedule.PERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.periodPrincipalAmount);
                            schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                            schedule.INTERESTRATE = loanInput.interestRate;
                            schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedStartPrincipalAmount);
                            schedule.AMORTISEDPERIODPAYMENTAMOUNT = Convert.ToDecimal(item.amortisedPeriodPaymentAmount);
                            schedule.AMORTISEDPERIODINTERESTAMOUNT = Convert.ToDecimal(item.amortisedPeriodInterestAmount);
                            schedule.AMORTISEDPERIODPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedPeriodPrincipalAmount);
                            schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amortisedEndPrincipalAmount);
                            schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                            schedule.CREATEDBY = staffId;
                            schedule.DATETIMECREATED = systemDate;

                            tblPeriodicSchedule.Add(schedule);
                        }
                        //-------------------------------------------------------------------------------------


                        List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        MergeDailyScheduleNew(loanId, applicationDate, dailySchedule, context);

                        var itemToRemovePeriodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                                                    where p.LOANID == loanId
                                                    select p);

                        if (itemToRemovePeriodic != null)
                        {
                            context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemovePeriodic);
                            context.SaveChanges();
                        }

                        context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule); ////change to Temp table
                        context.SaveChanges();

                        //////----------generate and save daily loan schedule -----------------------------------
                        ////List<LoanPaymentScheduleDailyViewModel> dailySchedule = loanSchedule.GenerateDailyLoanSchedule(loanInput);

                        ////List<TBL_LOAN_SCHEDULE_DAILY> tblDailySchedule = new List<TBL_LOAN_SCHEDULE_DAILY>();

                        ////foreach (var item in dailySchedule)
                        ////{
                        ////    TBL_LOAN_SCHEDULE_DAILY schedule = new TBL_LOAN_SCHEDULE_DAILY();

                        ////    schedule.LOANID = loanId;
                        ////    schedule.PAYMENTNUMBER = item.paymentNumber;
                        ////    schedule.DATE = item.date;
                        ////    schedule.PAYMENTDATE = item.paymentDate;
                        ////    schedule.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                        ////    schedule.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                        ////    schedule.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                        ////    schedule.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                        ////    schedule.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                        ////    schedule.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                        ////    schedule.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                        ////    schedule.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                        ////    schedule.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                        ////    schedule.INTERESTRATE = item.norminalInterestRate;
                        ////    schedule.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                        ////    schedule.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                        ////    schedule.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                        ////    schedule.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                        ////    schedule.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                        ////    schedule.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                        ////    schedule.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                        ////    schedule.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                        ////    schedule.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                        ////    schedule.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                        ////    schedule.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                        ////    schedule.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                        ////    schedule.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                        ////    schedule.NUMBEROFPERIODS = item.numberOfPeriods;
                        ////    schedule.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                        ////    schedule.CREATEDBY = staffId;
                        ////    schedule.DATETIMECREATED = systemDate;

                        ////    tblDailySchedule.Add(schedule);
                        ////}
                        //////----------------------------------------------------------------


                        //------------adding records to the database--------------------------

                        //if (scheduleMethod == LoanScheduleTypeEnum.IrregularSchedule)
                        //{ context.tbl_Loan_Schedule_Irregular_Input.AddRange(tblIrregularSchedule); }////change to Temp table


                        //var itemToRemovePeriodic = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC
                        //                            where p.LOANID == loanId
                        //                            select p);

                        //if (itemToRemovePeriodic != null)
                        //{
                        //    context.TBL_LOAN_SCHEDULE_PERIODIC.RemoveRange(itemToRemovePeriodic);
                        //    context.SaveChanges();
                        //}


                        //var itemToRemoveDaily = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                        //                         where p.LOANID == loanId
                        //                         select p);

                        //if (itemToRemoveDaily != null)
                        //{
                        //    context.TBL_LOAN_SCHEDULE_DAILY.RemoveRange(itemToRemoveDaily);
                        //    context.SaveChanges();
                        //}

                        //context.TBL_LOAN_SCHEDULE_PERIODIC.AddRange(tblPeriodicSchedule);////change to Temp table

                        ////context.TBL_LOAN_SCHEDULE_DAILY.AddRange(tblDailySchedule); ////change to Temp table
                        //context.SaveChanges();

                        //MergeDailySchedule(loanId, applicationDate);
                        //MergePeriodicSchedule(loanId, applicationDate);

                        //----------update loan details -----------------------------------
                        var loan = context.TBL_LOAN.FirstOrDefault(x => x.TERMLOANID == loanId);
                        loan.MATURITYDATE = (DateTime)reviewData.MATURITYDATE;
                        loan.PRINCIPALNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;
                        loan.INTERESTNUMBEROFINSTALLMENT = periodicSchedule.Count() - 1;


                        decimal newOutstandingPrincipal = 0;

                        var loanPeriodicSchedule = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loan.TERMLOANID && x.PAYMENTDATE == applicationDate).FirstOrDefault();

                        if (loanPeriodicSchedule != null)
                        {
                            newOutstandingPrincipal = loanPeriodicSchedule.ENDPRINCIPALAMOUNT;
                        }
                        else
                        {
                            var previousPeriodicRepaymentData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(c => c.LOANID == loan.TERMLOANID && c.PAYMENTDATE < applicationDate).OrderByDescending(c => c.PAYMENTDATE).Take(1).FirstOrDefault();
                            newOutstandingPrincipal = previousPeriodicRepaymentData.ENDPRINCIPALAMOUNT;
                        }


                        //loan.EFFECTIVEDATE = reviewData.EFFECTIVEDATE;
                        loan.INTERESTRATE = (double)reviewData.INTERATERATE;
                        loan.OUTSTANDINGPRINCIPAL = newOutstandingPrincipal;
                        //context.SaveChanges();
                        //-------------------------------------------------

                    }

                    var result = false;

                    result = context.SaveChanges() > 0;

                    if (reviewData.EFFECTIVEDATE < systemDate)
                    {
                        //result = LoanBackDateFunction(loanId, applicationDate, systemDate, (decimal)product.PENALCHARGERATE, loanInput);
                        result = LoanBackDateFunction(loanId, applicationDate, systemDate, loanInput, context);
                    }

                    if (result)
                    {
                        output = true;
                    }
                }
            }
            catch (Exception ex)
            {

                throw ex;

            }
            return output;
        }

        public bool LoanBackDateFunction(int loanId, DateTime effectiveDate, DateTime currentDate, LoanPaymentRestructureScheduleInputViewModel loanInput, FinTrakBankingContext context)
        {
            bool output = false;
            var result = "";
            var product = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanInput.productId);
            var loan = context.TBL_LOAN.Where(x => x.TERMLOANID == loanInput.loanId).FirstOrDefault();

            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

            int counter = 0;

            var loanSchePeriodicData = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.TBL_LOAN.TERMLOANID == loanId
                 && x.PAYMENTDATE >= effectiveDate && x.PAYMENTDATE <= currentDate && x.PAYMENTNUMBER != 0).OrderByDescending(x => x.PERIODICSCHEDULEID);

            decimal loanSchePeriodicPrincipal = 0;

            try
            {
                loanSchePeriodicPrincipal = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.TBL_LOAN.TERMLOANID == loanId
               && x.PAYMENTDATE >= effectiveDate && x.PAYMENTDATE <= currentDate && x.PAYMENTNUMBER != 0).Sum(x => x.PERIODPRINCIPALAMOUNT);
            }
            catch (Exception)
            {
                loanSchePeriodicPrincipal = 0;
            }


            var loanSchePeriodicDate = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.TBL_LOAN.TERMLOANID == loanId
                && x.PAYMENTDATE >= effectiveDate && x.PAYMENTDATE <= currentDate && x.PAYMENTNUMBER != 0).OrderByDescending(x => x.PAYMENTDATE).Take(1).FirstOrDefault();


            int dateDiff = DateDiff(effectiveDate, currentDate);

            List<TBL_DAILY_ACCRUAL_TEMP> tblDailyAccrualTempList = new List<TBL_DAILY_ACCRUAL_TEMP>();

            for (int i = 0; i < dateDiff; i++)
            {

                TBL_DAILY_ACCRUAL_TEMP tblDailyAccrualTemp = new TBL_DAILY_ACCRUAL_TEMP();

                DateTime dateAdd = effectiveDate.AddDays(i);

                if (dateAdd == currentDate)
                {
                    break;
                }

                tblDailyAccrualTemp.REFERENCENUMBER = loan.LOANREFERENCENUMBER;
                tblDailyAccrualTemp.CATEGORYID = (short)DailyAccrualCategory.TermLoan;
                tblDailyAccrualTemp.TRANSACTIONTYPEID = (byte)LoanTransactionTypeEnum.Interest;
                tblDailyAccrualTemp.PRODUCTID = loan.PRODUCTID;
                tblDailyAccrualTemp.COMPANYID = loan.COMPANYID;
                tblDailyAccrualTemp.BRANCHID = loan.BRANCHID;
                tblDailyAccrualTemp.CURRENCYID = loan.CURRENCYID;
                tblDailyAccrualTemp.EXCHANGERATE = loan.EXCHANGERATE;
                tblDailyAccrualTemp.MAINAMOUNT = GetRepaymentStartAmount(loanId, dateAdd);
                tblDailyAccrualTemp.INTERESTRATE = loanInput.interestRate;
                tblDailyAccrualTemp.DAYCOUNTCONVENTIONID = loan.SCHEDULEDAYCOUNTCONVENTIONID;
                tblDailyAccrualTemp.DAILYACCURALAMOUNT = (decimal)((loanInput.interestRate / 100) * (double)GetRepaymentStartAmount(loanId, dateAdd) * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID)));
                tblDailyAccrualTemp.REPAYMENTPOSTEDSTATUS = false;
                tblDailyAccrualTemp.SYSTEMDATETIME = 0;
                tblDailyAccrualTemp.CHARGEFEEID = (int)ChargeFeeDetailTypeEnum.Primary;
                tblDailyAccrualTemp.DATE = dateAdd;
                tblDailyAccrualTemp.DAILYACCURALAMOUNT2 = 0;


                tblDailyAccrualTempList.Add(tblDailyAccrualTemp);

            }

            var deleteDailyAccrcual = new List<TBL_DAILY_ACCRUAL_TEMP>();

            try
            {
                deleteDailyAccrcual = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER).ToList();
            }
            catch (Exception)
            {

                deleteDailyAccrcual = null;
            }


            if (deleteDailyAccrcual != null)
            {
                context.TBL_DAILY_ACCRUAL_TEMP.RemoveRange(deleteDailyAccrcual);
                context.SaveChanges();
            }

            if (tblDailyAccrualTempList.Count() != 0)
            {
                context.TBL_DAILY_ACCRUAL_TEMP.AddRange(tblDailyAccrualTempList);
                context.SaveChanges();
            }


            counter = loanSchePeriodicData.Count();

            DateTime newCurrentDate = currentDate.AddDays(-1);

            if (counter == 0)
            {
                decimal previousDailyInterest = 0;

                try
                {
                    previousDailyInterest = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newCurrentDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan).Sum(x => x.DAILYACCURALAMOUNT);
                }
                catch (Exception)
                {

                    previousDailyInterest = 0;
                }

                decimal currentDailyInterest = 0;

                try
                {
                    currentDailyInterest = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newCurrentDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan).Sum(x => x.DAILYACCURALAMOUNT);

                }
                catch (Exception)
                {

                    currentDailyInterest = 0;
                }


                decimal previousAccruedDailyInterest = (decimal?)previousDailyInterest ?? 0;
                decimal.Round(previousAccruedDailyInterest, 2, MidpointRounding.AwayFromZero);

                double dailyAccuralAmount = ((loanInput.interestRate / 100) * (double)loan.OUTSTANDINGPRINCIPAL * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID)));

                decimal currentAccruedDailyInterest = (decimal?)currentDailyInterest ?? 0;
                decimal.Round(currentAccruedDailyInterest, 2, MidpointRounding.AwayFromZero);

                decimal accruedDailyInterestDiff = previousAccruedDailyInterest - currentAccruedDailyInterest;

                if (accruedDailyInterestDiff != 0)
                {
                    inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, (decimal)accruedDailyInterestDiff, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest Reversal", loanInput.operationId));

                    output = true;

                }


            }
            else
            {

                DateTime newDate = loanSchePeriodicDate.PAYMENTDATE.AddDays(-1);
                var dailyAccrualRecord = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= newCurrentDate && x.DATE <= loanSchePeriodicDate.PAYMENTDATE && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan);


                decimal previousDailyInterest = dailyAccrualRecord.Any() ? dailyAccrualRecord.Sum(x => x.DAILYACCURALAMOUNT) : 0;
                var currentDailyInterestRecord = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= newCurrentDate && x.DATE <= loanSchePeriodicDate.PAYMENTDATE && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan);
                decimal currentDailyInterest = currentDailyInterestRecord.Any() ? currentDailyInterestRecord.Sum(x => x.DAILYACCURALAMOUNT) : 0;

                decimal previousAccruedDailyInterest = (decimal?)previousDailyInterest ?? 0;

                decimal.Round(previousAccruedDailyInterest, 2, MidpointRounding.AwayFromZero);

                double dailyAccuralAmount = ((loanInput.interestRate / 100) * (double)loan.OUTSTANDINGPRINCIPAL * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)loan.SCHEDULEDAYCOUNTCONVENTIONID)));

                decimal currentAccruedDailyInterest = (decimal?)currentDailyInterest ?? 0;
                decimal.Round(currentAccruedDailyInterest, 2, MidpointRounding.AwayFromZero);

                decimal accruedDailyInterestDiff = previousAccruedDailyInterest - currentAccruedDailyInterest;

                if (accruedDailyInterestDiff != 0)
                {
                    inputTransactions.Add(financeTransaction.PostLoanPositiveReversalEntries(loanInput, (decimal)accruedDailyInterestDiff, product.INTERESTRECEIVABLEPAYABLEGL.Value, "Accrued Interest Reversal", loanInput.operationId));

                    output = true;

                }

                var previousPeriodicForPrincipal = from d in context.TBL_LOAN_SCHEDULE_PERIODIC_ARC
                                                   where d.LOANID == loanId
                                                   let periodicPrincipal = context.TBL_LOAN_SCHEDULE_PERIODIC_ARC.Where(a => a.LOANID == loanId
                                                   && a.PAYMENTDATE >= DbFunctions.TruncateTime(effectiveDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(currentDate)
                                                   ).Sum(a => (double?)a.PERIODPRINCIPALAMOUNT ?? 0)
                                                   select periodicPrincipal;

                var currentPeriodicForPrincipal = from d in context.TBL_LOAN_SCHEDULE_PERIODIC
                                                  where d.LOANID == loanId
                                                  let periodicPrincipal = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(a => a.LOANID == loanId
                                                  && a.PAYMENTDATE >= DbFunctions.TruncateTime(effectiveDate) && a.PAYMENTDATE <= DbFunctions.TruncateTime(currentDate)
                                                  ).Sum(a => (double?)a.PERIODPRINCIPALAMOUNT ?? 0)
                                                  select periodicPrincipal;


                decimal previousPeriodicPrincipal = (decimal?)previousPeriodicForPrincipal.FirstOrDefault() ?? 0;
                decimal.Round(previousPeriodicPrincipal, 2, MidpointRounding.AwayFromZero);

                decimal currentPeriodicPrincipal = (decimal?)currentPeriodicForPrincipal.FirstOrDefault() ?? 0;
                decimal.Round(currentPeriodicPrincipal, 2, MidpointRounding.AwayFromZero);

                decimal periodicPrincipalDiff = previousPeriodicPrincipal - currentPeriodicPrincipal;

                if (periodicPrincipalDiff != 0)
                {
                    inputTransactions.Add(financeTransaction.PostLoanPositiveReversalCasaEntries(loanInput, periodicPrincipalDiff, product.PRINCIPALBALANCEGL.Value, "Principal Reversal", loanInput.operationId));

                    output = true;
                }

                var previousPeriodicRecord = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan).ToList();
                decimal previousPeriodic = 0;
                decimal currentPeriodic = 0;
                if (previousPeriodicRecord.Count() > 0)
                {
                    previousPeriodic = previousPeriodicRecord.Sum(x => x.DAILYACCURALAMOUNT);
                }

                //decimal previousPeriodic = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan).Sum(x => x.DAILYACCURALAMOUNT);

                var currentPeriodicRecord = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan);
                if (currentPeriodicRecord.Count() > 0)
                {
                    currentPeriodic = currentPeriodicRecord.Sum(x => x.DAILYACCURALAMOUNT);
                }

                // currentPeriodic = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= newDate && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan).Sum(x => x.DAILYACCURALAMOUNT);

                decimal previousPeriodicInterest = (decimal?)previousPeriodic ?? 0;
                decimal.Round(previousPeriodicInterest, 2, MidpointRounding.AwayFromZero);

                decimal currentPeriodicInterest = (decimal?)currentPeriodic ?? 0;
                decimal.Round(currentPeriodicInterest, 2, MidpointRounding.AwayFromZero);

                decimal periodicInterestDiff = previousPeriodicInterest - currentPeriodicInterest;


                if (periodicInterestDiff != 0)
                {
                    inputTransactions.Add(financeTransaction.PostLoanPositiveReversalCasaEntries(loanInput, periodicInterestDiff, product.PRINCIPALBALANCEGL.Value, "Interest Reversal", loanInput.operationId));

                    output = true;

                }


            }


            var tblDailyAccrualTempNew = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= currentDate).ToList().OrderBy(x => x.DATE);

            List<TBL_DAILY_ACCRUAL_ARCHIVE> tblDailyAccrualListNew = new List<TBL_DAILY_ACCRUAL_ARCHIVE>();

            foreach (TBL_DAILY_ACCRUAL tblDailyAccrual in tblDailyAccrualTempNew)
            {
                TBL_DAILY_ACCRUAL_ARCHIVE tblDailyAccrualNew = new TBL_DAILY_ACCRUAL_ARCHIVE();

                tblDailyAccrualNew.REFERENCENUMBER = tblDailyAccrual.REFERENCENUMBER;
                tblDailyAccrualNew.CATEGORYID = tblDailyAccrual.CATEGORYID;
                tblDailyAccrualNew.TRANSACTIONTYPEID = tblDailyAccrual.TRANSACTIONTYPEID;
                tblDailyAccrualNew.PRODUCTID = tblDailyAccrual.PRODUCTID;
                tblDailyAccrualNew.COMPANYID = tblDailyAccrual.COMPANYID;
                tblDailyAccrualNew.BRANCHID = tblDailyAccrual.BRANCHID;
                tblDailyAccrualNew.CURRENCYID = tblDailyAccrual.CURRENCYID;
                tblDailyAccrualNew.EXCHANGERATE = tblDailyAccrual.EXCHANGERATE;
                tblDailyAccrualNew.MAINAMOUNT = tblDailyAccrual.MAINAMOUNT;
                tblDailyAccrualNew.INTERESTRATE = tblDailyAccrual.INTERESTRATE;
                tblDailyAccrualNew.DAYCOUNTCONVENTIONID = tblDailyAccrual.DAYCOUNTCONVENTIONID;
                tblDailyAccrualNew.DAILYACCURALAMOUNT = tblDailyAccrual.DAILYACCURALAMOUNT;
                tblDailyAccrualNew.REPAYMENTPOSTEDSTATUS = tblDailyAccrual.REPAYMENTPOSTEDSTATUS;
                tblDailyAccrualNew.SYSTEMDATETIME = tblDailyAccrual.SYSTEMDATETIME;
                tblDailyAccrualNew.DATE = tblDailyAccrual.DATE;
                tblDailyAccrualNew.DAILYACCURALAMOUNT2 = tblDailyAccrual.DAILYACCURALAMOUNT2;
                tblDailyAccrualNew.CHARGEFEEID = (int)ChargeFeeDetailTypeEnum.Primary;
                tblDailyAccrualNew.ARCHIVEBATCHCODE = CommonHelpers.GenerateRandomDigitCode(10);
                tblDailyAccrualNew.ARCHIVEDATE = currentDate;
                tblDailyAccrualNew.DAILYACCURALID = tblDailyAccrual.DAILYACCURALID;


                tblDailyAccrualListNew.Add(tblDailyAccrualNew);
            }


            if (tblDailyAccrualListNew.Count() != 0)
            {
                context.TBL_DAILY_ACCRUAL_ARCHIVE.AddRange(tblDailyAccrualListNew);
                context.SaveChanges();
            }

            var deleteDailyAccrualNew = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= currentDate).ToList();

            if (deleteDailyAccrualNew != null)
            {
                context.TBL_DAILY_ACCRUAL.RemoveRange(deleteDailyAccrualNew);
                context.SaveChanges();
            }

            var dailyAccrualNew = context.TBL_DAILY_ACCRUAL_TEMP.Where(x => x.REFERENCENUMBER == loan.LOANREFERENCENUMBER && x.DATE >= effectiveDate && x.DATE <= currentDate).ToList();

            List<TBL_DAILY_ACCRUAL> tblDailyAccrualList = new List<TBL_DAILY_ACCRUAL>();

            foreach (TBL_DAILY_ACCRUAL_TEMP tblDailyAccrual in dailyAccrualNew)
            {
                TBL_DAILY_ACCRUAL tblDailyAccruallNew = new TBL_DAILY_ACCRUAL();

                tblDailyAccruallNew.REFERENCENUMBER = tblDailyAccrual.REFERENCENUMBER;
                tblDailyAccruallNew.CATEGORYID = tblDailyAccrual.CATEGORYID;
                tblDailyAccruallNew.TRANSACTIONTYPEID = tblDailyAccrual.TRANSACTIONTYPEID;
                tblDailyAccruallNew.PRODUCTID = tblDailyAccrual.PRODUCTID;
                tblDailyAccruallNew.COMPANYID = tblDailyAccrual.COMPANYID;
                tblDailyAccruallNew.BRANCHID = tblDailyAccrual.BRANCHID;
                tblDailyAccruallNew.CURRENCYID = tblDailyAccrual.CURRENCYID;
                tblDailyAccruallNew.EXCHANGERATE = tblDailyAccrual.EXCHANGERATE;
                tblDailyAccruallNew.MAINAMOUNT = tblDailyAccrual.MAINAMOUNT;
                tblDailyAccruallNew.INTERESTRATE = tblDailyAccrual.INTERESTRATE;
                tblDailyAccruallNew.DAYCOUNTCONVENTIONID = tblDailyAccrual.DAYCOUNTCONVENTIONID;
                tblDailyAccruallNew.DAILYACCURALAMOUNT = tblDailyAccrual.DAILYACCURALAMOUNT;
                tblDailyAccruallNew.REPAYMENTPOSTEDSTATUS = tblDailyAccrual.REPAYMENTPOSTEDSTATUS;
                tblDailyAccruallNew.SYSTEMDATETIME = tblDailyAccrual.SYSTEMDATETIME;
                tblDailyAccruallNew.DATE = tblDailyAccrual.DATE;
                tblDailyAccruallNew.DAILYACCURALAMOUNT2 = tblDailyAccrual.DAILYACCURALAMOUNT2;
                //tblDailyAccruallNew.CHARGEFEEID = (int)ChargeFeeDetailTypeEnum.Primary;


                tblDailyAccrualList.Add(tblDailyAccruallNew);
            }


            if (tblDailyAccrualList.Count() != 0)
            {
                context.TBL_DAILY_ACCRUAL.AddRange(tblDailyAccrualList);
                context.SaveChanges();
            }


            return output;
        }

        public void ProcessAutomaticCommercialLoanRollover(DateTime applicationDate, int companyId, int staffId)
        {


            var currencyRate = (from b in context.TBL_LOAN
                                where b.MATURITYDATE == DbFunctions.TruncateTime(applicationDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active
                                && b.ALLOWFORCEDEBITREPAYMENT == true && b.ISDISBURSED == true && b.COMPANYID == companyId
                                select new CurrencyExchangeRateViewModel()
                                {
                                    currencyId = b.CURRENCYID,
                                    companyId = b.COMPANYID,
                                }).ToList().Distinct().Select(x =>
                                {
                                    x.sellingRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, (int)x.companyId).sellingRate;
                                    return x;
                                }).ToList();



            DateTime dateChange = applicationDate;

            dateChange = dateChange.AddDays(-1);

            var model = (from a in context.TBL_LOAN_MATURITY_INSTRUCTION
                         join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                         where b.MATURITYDATE == DbFunctions.TruncateTime(applicationDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active
                         && b.ALLOWFORCEDEBITREPAYMENT == true && a.ISUSED == false && b.ISDISBURSED == true
                         select new LoanRepaymentViewModel()
                         {
                             productId = b.PRODUCTID,
                             branchId = b.BRANCHID,
                             companyId = b.COMPANYID,
                             currencyId = b.CURRENCYID,
                             //exchangeRate = b.EXCHANGERATE,
                             periodInterestAmount = b.OUTSTANDINGINTEREST,
                             periodPrincipalAmount = b.OUTSTANDINGPRINCIPAL,
                             interestRate = b.INTERESTRATE,
                             paymentDate = applicationDate,
                             loanId = b.TERMLOANID,
                             totalAmount = 0,
                             casaAccountId = b.CASAACCOUNTID,
                             loanRefNo = b.LOANREFERENCENUMBER,
                             maturityInstructionTypeId = a.INSTRUCTIONTYPEID
                         }).ToList().Select(x =>
                         {
                             //x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
                             x.exchangeRate = currencyRate.Where(m => m.currencyId == x.currencyId).Select(m => m.sellingRate).FirstOrDefault();
                             return x;
                         }).ToList();


            //var eod_Operation_Log = context.TBL_EOD_OPERATION_LOG.Where(c => c.EODDATE == applicationDate).FirstOrDefault();


            //List<TBL_EOD_OPERATION_LOG_DETAIL> eod_operation_Detail_List = new List<TBL_EOD_OPERATION_LOG_DETAIL>();

            //if (model == null)
            //{
            //    var eodOperations = context.TBL_EOD_OPERATION.OrderBy(x => x.POSITION).ToList();

            //    foreach (LoanRepaymentViewModel loan in model)
            //    {

            //        TBL_EOD_OPERATION_LOG_DETAIL eod_operation_Detail = new TBL_EOD_OPERATION_LOG_DETAIL();

            //        var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFRENCENUMBER == loan.loanRefNo && c.EODDATE == applicationDate).FirstOrDefault();

            //        if (checkExistence == null)
            //        {
            //            eod_operation_Detail.EODOPERATIONLOGID = eod_Operation_Log.EODOPERATIONLOGID;
            //            eod_operation_Detail.EODSTATUSID = (int)EodOperationStatusEnum.Processing;
            //            eod_operation_Detail.REFRENCENUMBER = loan.loanRefNo;
            //            eod_operation_Detail.EODDATE = applicationDate;
            //            eod_operation_Detail_List.Add(eod_operation_Detail);

            //        }

            //    }

            //    context.TBL_EOD_OPERATION_LOG_DETAIL.AddRange(eod_operation_Detail_List);

            //    context.SaveChanges();

            //}



            foreach (var item in model)
            {

                //var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFRENCENUMBER == item.loanRefNo && c.EODDATE == applicationDate && c.EODSTATUSID != (int)EodOperationStatusEnum.Completed).FirstOrDefault();

                //if (checkExistence != null)
                //{

                //    var eod_Operation_Log_Detail_Set_Value = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFRENCENUMBER == item.loanRefNo && c.EODDATE == applicationDate).FirstOrDefault();

                //    eod_Operation_Log_Detail_Set_Value.STARTDATETIME = DateTime.Now;

                //    context.SaveChanges();

                //    try
                //    {

                var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.EODDATE == dateChange && c.EODOPERATIONID == (int)EodOperationEnum.ProcessAutomaticCommercialLoanRollover).FirstOrDefault();

                if (checkExistence == null)
                {

                    TBL_LOAN loanRecord = context.TBL_LOAN.Find(item.loanId);
                    if (loanRecord.MATURITYDATE == applicationDate)
                    {
                        _transactionReferenceNo = item.loanRefNo + " - rollover";
                        RolloverCommercialLoanByAutomaticProcess(loanRecord);
                    }

                }




                //    }
                //    catch (Exception ex)
                //    {

                //        eod_Operation_Log_Detail_Set_Value.EODDATE = DateTime.Now;
                //        eod_Operation_Log_Detail_Set_Value.EODSTATUSID = (int)EodOperationStatusEnum.Error;
                //        eod_Operation_Log_Detail_Set_Value.ERRORINFORMATION = $"Ref No - {item.loanRefNo} Exception - {ex.Message}  - inner exception -  {ex.InnerException}";
                //        context.SaveChanges();
                //    }
                //    eod_Operation_Log_Detail_Set_Value.EODDATE = DateTime.Now;
                //    eod_Operation_Log_Detail_Set_Value.EODSTATUSID = (int)EodOperationStatusEnum.Completed;
                //    eod_Operation_Log_Detail_Set_Value.ERRORINFORMATION = "No Error";
                //    context.SaveChanges();



                //}





            }

            context.SaveChanges();

            var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
            if (setup.USE_THIRD_PARTY_INTEGRATION)
            {
                BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                bulkPosting.WriteBulkProcessLoanDisbursmentRollOverToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate, companyId, staffId, out _transactionReferenceNo);
            }
        }

        public int ReBookLoan(TBL_LOAN newLoan)
        {
            var loanReferenceNumber = loanGenerate.GenerateLoanReferenceNumber(newLoan.BRANCHID, newLoan.PRODUCTID, newLoan.LOANSYSTEMTYPEID);

            TBL_LOAN newLoanEntry = new TBL_LOAN();
            newLoanEntry.PRODUCTPRICEINDEXRATE = newLoan.PRODUCTPRICEINDEXRATE;
            newLoanEntry.CUSTOMERRISKRATINGID = newLoan.CUSTOMERRISKRATINGID;
            newLoanEntry.LOANSYSTEMTYPEID = newLoan.LOANSYSTEMTYPEID;
            newLoanEntry.CUSTOMERID = newLoan.CUSTOMERID;
            newLoanEntry.PRODUCTID = newLoan.PRODUCTID;
            newLoanEntry.COMPANYID = newLoan.COMPANYID;
            newLoanEntry.LOAN_BOOKING_REQUESTID = newLoan.LOAN_BOOKING_REQUESTID;
            newLoanEntry.LOANAPPLICATIONDETAILID = newLoan.LOANAPPLICATIONDETAILID;
            newLoanEntry.CASAACCOUNTID = newLoan.CASAACCOUNTID;
            newLoanEntry.CASAACCOUNTID2 = newLoan.CASAACCOUNTID2;
            newLoanEntry.LOANSYSTEMTYPEID = newLoan.LOANSYSTEMTYPEID;
            newLoanEntry.BRANCHID = newLoan.BRANCHID;
            newLoanEntry.OPERATIONID = newLoan.OPERATIONID;
            newLoanEntry.SUBSECTORID = newLoan.SUBSECTORID;
            newLoanEntry.CURRENCYID = newLoan.CURRENCYID;
            newLoanEntry.EXCHANGERATE = newLoan.EXCHANGERATE;
            newLoanEntry.LOANREFERENCENUMBER = loanReferenceNumber;
            newLoanEntry.RELATED_LOAN_REFERENCE_NUMBER = newLoan.LOANREFERENCENUMBER;
            newLoanEntry.PRINCIPALNUMBEROFINSTALLMENT = newLoan.PRINCIPALNUMBEROFINSTALLMENT;
            newLoanEntry.INTERESTNUMBEROFINSTALLMENT = newLoan.INTERESTINSTALLMENTLEFT;
            newLoanEntry.RELATIONSHIPOFFICERID = newLoan.RELATIONSHIPOFFICERID;
            newLoanEntry.RELATIONSHIPMANAGERID = newLoan.RELATIONSHIPMANAGERID;
            newLoanEntry.MISCODE = newLoan.MISCODE;
            newLoanEntry.TEAMMISCODE = newLoan.TEAMMISCODE;
            newLoanEntry.INTERESTRATE = newLoan.INTERESTRATE;
            newLoanEntry.EFFECTIVEDATE = newLoan.MATURITYDATE;
            newLoanEntry.MATURITYDATE = newLoan.MATURITYDATE;
            newLoanEntry.BOOKINGDATE = newLoan.BOOKINGDATE;
            newLoanEntry.PRINCIPALINSTALLMENTLEFT = newLoan.PRINCIPALINSTALLMENTLEFT;
            newLoanEntry.INTERESTINSTALLMENTLEFT = newLoan.INTERESTINSTALLMENTLEFT;
            newLoanEntry.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
            newLoanEntry.APPROVERCOMMENT = newLoan.APPROVERCOMMENT;
            newLoanEntry.LOANSTATUSID = (short)LoanStatusEnum.Active;
            newLoanEntry.SCHEDULETYPEID = newLoan.SCHEDULETYPEID;
            newLoanEntry.SCHEDULEDAYCOUNTCONVENTIONID = newLoan.SCHEDULEDAYCOUNTCONVENTIONID;
            newLoanEntry.SCHEDULEDAYINTERESTTYPEID = newLoan.SCHEDULEDAYINTERESTTYPEID;
            newLoanEntry.SHOULD_DISBURSE = newLoan.SHOULD_DISBURSE;
            newLoanEntry.ISDISBURSED = newLoan.ISDISBURSED;
            newLoanEntry.EQUITYCONTRIBUTION = newLoan.EQUITYCONTRIBUTION;
            newLoanEntry.PASTDUEPRINCIPAL = newLoan.PASTDUEPRINCIPAL;
            newLoanEntry.PASTDUEINTEREST = newLoan.PASTDUEINTEREST;
            newLoanEntry.INTERESTONPASTDUEPRINCIPAL = newLoan.INTERESTONPASTDUEPRINCIPAL;
            newLoanEntry.INTERESTONPASTDUEINTEREST = newLoan.INTERESTONPASTDUEINTEREST;
            newLoanEntry.PENALCHARGEAMOUNT = newLoan.PENALCHARGEAMOUNT;
            newLoanEntry.FIXEDPRINCIPAL = newLoan.FIXEDPRINCIPAL;
            newLoanEntry.PROFILELOAN = newLoan.PROFILELOAN;
            newLoanEntry.DISCHARGELETTER = newLoan.DISCHARGELETTER;
            newLoanEntry.SUSPENDINTEREST = newLoan.SUSPENDINTEREST;
            newLoanEntry.ALLOWFORCEDEBITREPAYMENT = newLoan.ALLOWFORCEDEBITREPAYMENT;
            newLoanEntry.FIRSTPRINCIPALPAYMENTDATE = newLoan.FIRSTPRINCIPALPAYMENTDATE;
            newLoanEntry.FIRSTINTERESTPAYMENTDATE = newLoan.FIRSTINTERESTPAYMENTDATE;

            newLoanEntry.INT_PRUDENT_GUIDELINE_STATUSID = newLoan.INT_PRUDENT_GUIDELINE_STATUSID;
            newLoanEntry.EXT_PRUDENT_GUIDELINE_STATUSID = newLoan.EXT_PRUDENT_GUIDELINE_STATUSID;
            newLoanEntry.USER_PRUDENTIAL_GUIDE_STATUSID = newLoan.USER_PRUDENTIAL_GUIDE_STATUSID;
            newLoanEntry.NPLDATE = newLoan.NPLDATE;
            newLoanEntry.CREATEDBY = newLoan.CREATEDBY;
            newLoanEntry.DATETIMECREATED = DateTime.Now;

            newLoanEntry.PRINCIPALAMOUNT = newLoan.PRINCIPALAMOUNT;
            newLoanEntry.OUTSTANDINGPRINCIPAL = newLoan.OUTSTANDINGPRINCIPAL;
            newLoanEntry.OUTSTANDINGINTEREST = newLoan.OUTSTANDINGINTEREST;

            context.TBL_LOAN.Add(newLoanEntry);

            if (context.SaveChanges() > 0)
            {
                return newLoanEntry.TERMLOANID;
            }
            else
            {
                return 0;
            }
        }

        public bool DeleteLoanExist(int loanId, DateTime applicationDate, FinTrakBankingContext context)
        {
            bool output = false;

            var removeLoan_Archive = (from p in context.TBL_LOAN_ARCHIVE
                                      where p.LOANID == loanId && p.CHANGEEFFECTIVEDATE == applicationDate
                                      select p);
            var removeLoan_Schedule_Periodic_Archive = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC_ARC
                                                        where p.LOANID == loanId && p.ARCHIVEDATE == applicationDate
                                                        select p);
            var removeLoan_Schedule_Daily_Archive = (from p in context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV
                                                     where p.LOANID == loanId && p.ARCHIVEDATE == applicationDate
                                                     select p);
            var removeLoan_Schedule_Daily_Temp = (from p in context.TBL_LOAN_SCHEDULE_DAILY_TEMP
                                                  where p.LOANID == loanId
                                                  select p);
            var removeLoan_Schedule_Periodic_Temp = (from p in context.TBL_LOAN_SCHEDULE_PERIODIC_TMP
                                                     where p.LOANID == loanId
                                                     select p);

            var removeOD_Archive = (from p in context.TBL_LOAN_REVOLVING_ARCHIVE
                                    where p.REVOLVINGLOANID == loanId && p.ARCHIVEDATE == applicationDate
                                    select p);

            var removeLoan_IrregularSchedule = (from p in context.TBL_LOAN_SCHEDULE_IREGUL_INPUT
                                                where p.LOANID == loanId
                                                select p);

            if (removeLoan_Archive != null)
            {
                context.TBL_LOAN_ARCHIVE.RemoveRange(removeLoan_Archive);
            }
            if (removeLoan_Schedule_Periodic_Archive != null)
            {
                context.TBL_LOAN_SCHEDULE_PERIODIC_ARC.RemoveRange(removeLoan_Schedule_Periodic_Archive);

            }
            if (removeLoan_Schedule_Daily_Archive != null)
            {
                context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV.RemoveRange(removeLoan_Schedule_Daily_Archive);

            }
            if (removeLoan_Schedule_Daily_Temp != null)
            {
                context.TBL_LOAN_SCHEDULE_DAILY_TEMP.RemoveRange(removeLoan_Schedule_Daily_Temp);

            }
            if (removeLoan_Schedule_Periodic_Temp != null)
            {
                context.TBL_LOAN_SCHEDULE_PERIODIC_TMP.RemoveRange(removeLoan_Schedule_Periodic_Temp);

            }
            if (removeOD_Archive != null)
            {
                context.TBL_LOAN_REVOLVING_ARCHIVE.RemoveRange(removeOD_Archive);

            }

            if (removeLoan_IrregularSchedule != null)
            {
                context.TBL_LOAN_SCHEDULE_IREGUL_INPUT.RemoveRange(removeLoan_IrregularSchedule);

            }

            try
            {
                context.SaveChanges();
            }
            catch (System.Data.Entity.Validation.DbEntityValidationException ex)
            {
                string errorMessages = string.Join("; ", ex.EntityValidationErrors.SelectMany(x => x.ValidationErrors).Select(x => x.ErrorMessage));
                throw new System.Data.Entity.Validation.DbEntityValidationException(errorMessages);
            }
            output = true;

            return output;
        }

        public List<LoanPaymentScheduleDailyViewModel> MergeDailyScheduleNew(int loanId, DateTime applicationDate, List<LoanPaymentScheduleDailyViewModel> dailySchedule, FinTrakBankingContext context)
        {
            var systemDate = generalSetup.GetApplicationDate();
            int no = 0;//number.Count() - 1;

            List<LoanPaymentScheduleDailyViewModel> model1 = new List<LoanPaymentScheduleDailyViewModel>();
            List<LoanPaymentScheduleDailyViewModel> model2 = new List<LoanPaymentScheduleDailyViewModel>();
            List<LoanPaymentScheduleDailyViewModel> model = new List<LoanPaymentScheduleDailyViewModel>();

            int counter = 0;

            try
            {
                model1 = (from a in context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV
                          where a.LOANID == loanId && a.ARCHIVEDATE == DbFunctions.TruncateTime(systemDate)
                          && a.DATE < DbFunctions.TruncateTime(applicationDate)
                          orderby a.PAYMENTNUMBER ascending
                          select new LoanPaymentScheduleDailyViewModel()
                          {
                              loanId = a.LOANID,
                              paymentNumber = a.PAYMENTNUMBER,
                              date = a.DATE,
                              paymentDate = a.PAYMENTDATE,
                              openingBalance = (double)a.OPENINGBALANCE,
                              startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                              dailyPaymentAmount = (double)a.DAILYPAYMENTAMOUNT,
                              dailyInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                              dailyPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                              closingBalance = (double)a.CLOSINGBALANCE,
                              endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                              amortisedCost = (double)a.AMORTISEDCOST,
                              accruedInterest = (double)a.ACCRUEDINTEREST,
                              norminalInterestRate = a.INTERESTRATE,

                              amOpeningBalance = (double)a.AMORTISEDOPENINGBALANCE,
                              amStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                              amDailyPaymentAmount = (double)a.AMORTISEDDAILYPAYMENTAMOUNT,
                              amDailyInterestAmount = (double)a.AMORTISEDDAILYINTERESTAMOUNT,
                              amDailyPrincipalAmount = (double)a.AMORTISEDDAILYPRINCIPALAMOUNT,
                              amClosingBalance = (double)a.AMORTISEDCLOSINGBALANCE,
                              amEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                              amAccruedInterest = (double)a.AMORTISEDACCRUEDINTEREST,
                              amAmortisedCost = (double)a.AMORTISED_AMORTISEDCOST,
                              discountPremium = (double)a.DISCOUNTPREMIUM,
                              unEarnedFee = (double)a.UNEARNEDFEE,
                              earnedFee = (double)a.EARNEDFEE,
                              effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                              numberOfPeriods = a.NUMBEROFPERIODS,
                              ballonAmount = (double)a.BALLONAMOUNT,
                              createdBy = a.CREATEDBY,
                              dateTimeCreated = a.DATETIMECREATED,
                          }).ToList();

                //.Concat

                counter = model1.Count();


                //model2 = dailySchedule.Where(a => a.loanId == loanId && a.date >= DbFunctions.TruncateTime(applicationDate)).OrderBy(a => a.paymentDate).ToList();

                model2 = dailySchedule.OrderBy(a => a.paymentDate).ToList();

                List<LoanPaymentScheduleDailyViewModel> LoanPaymentScheduleDaily = new List<LoanPaymentScheduleDailyViewModel>();

                foreach (LoanPaymentScheduleDailyViewModel _model in model2)
                {

                    if (_model.date >= applicationDate)
                    {
                        LoanPaymentScheduleDailyViewModel _LoanPaymentScheduleDaily = new LoanPaymentScheduleDailyViewModel();

                        counter = counter + 1;

                        _LoanPaymentScheduleDaily.loanId = _model.loanId;
                        _LoanPaymentScheduleDaily.paymentNumber = counter;
                        _LoanPaymentScheduleDaily.date = _model.date;
                        _LoanPaymentScheduleDaily.paymentDate = _model.paymentDate;
                        _LoanPaymentScheduleDaily.openingBalance = (double)_model.openingBalance;
                        _LoanPaymentScheduleDaily.startPrincipalAmount = (double)_model.startPrincipalAmount;
                        _LoanPaymentScheduleDaily.dailyPaymentAmount = (double)_model.dailyPaymentAmount;
                        _LoanPaymentScheduleDaily.dailyInterestAmount = (double)_model.dailyInterestAmount;
                        _LoanPaymentScheduleDaily.dailyPrincipalAmount = (double)_model.dailyPrincipalAmount;
                        _LoanPaymentScheduleDaily.closingBalance = (double)_model.closingBalance;
                        _LoanPaymentScheduleDaily.endPrincipalAmount = (double)_model.endPrincipalAmount;
                        _LoanPaymentScheduleDaily.amortisedCost = (double)_model.amortisedCost;
                        _LoanPaymentScheduleDaily.accruedInterest = (double)_model.accruedInterest;
                        _LoanPaymentScheduleDaily.norminalInterestRate = _model.norminalInterestRate;
                        _LoanPaymentScheduleDaily.amOpeningBalance = (double)_model.amOpeningBalance;
                        _LoanPaymentScheduleDaily.amStartPrincipalAmount = (double)_model.amStartPrincipalAmount;
                        _LoanPaymentScheduleDaily.amDailyPaymentAmount = (double)_model.amDailyPaymentAmount;
                        _LoanPaymentScheduleDaily.amDailyInterestAmount = (double)_model.amDailyInterestAmount;
                        _LoanPaymentScheduleDaily.amDailyPrincipalAmount = (double)_model.amDailyPrincipalAmount;
                        _LoanPaymentScheduleDaily.amClosingBalance = (double)_model.amClosingBalance;
                        _LoanPaymentScheduleDaily.amEndPrincipalAmount = (double)_model.amEndPrincipalAmount;
                        _LoanPaymentScheduleDaily.amAccruedInterest = (double)_model.amAccruedInterest;
                        _LoanPaymentScheduleDaily.amAmortisedCost = (double)_model.amAmortisedCost;
                        _LoanPaymentScheduleDaily.discountPremium = (double)_model.discountPremium;
                        _LoanPaymentScheduleDaily.unEarnedFee = (double)_model.unEarnedFee;
                        _LoanPaymentScheduleDaily.earnedFee = (double)_model.earnedFee;
                        _LoanPaymentScheduleDaily.effectiveInterestRate = _model.effectiveInterestRate;
                        _LoanPaymentScheduleDaily.numberOfPeriods = _model.numberOfPeriods;
                        _LoanPaymentScheduleDaily.ballonAmount = (double)_model.ballonAmount;
                        _LoanPaymentScheduleDaily.createdBy = _model.createdBy;
                        _LoanPaymentScheduleDaily.dateTimeCreated = _model.dateTimeCreated;

                        LoanPaymentScheduleDaily.Add(_LoanPaymentScheduleDaily);
                    }


                }

                //model2 = (from a in dailySchedule.Where(a => a.loanId == loanId && a.date >= (applicationDate)).OrderBy(a => a.paymentDate).ToList()
                //orderby a.paymentDate ascending

                //model2 = (from a in dailySchedule
                //          join b in context.TBL_LOAN on a.loanId equals b.TERMLOANID
                //          select new LoanPaymentScheduleDailyViewModel()
                //          {
                //              loanId = a.loanId,
                //              paymentNumber = a.paymentNumber,
                //              date = a.date,
                //              paymentDate = a.paymentDate,
                //              openingBalance = (double)a.openingBalance,
                //              startPrincipalAmount = (double)a.startPrincipalAmount,
                //              dailyPaymentAmount = (double)a.dailyPaymentAmount,
                //              dailyInterestAmount = (double)a.dailyInterestAmount,
                //              dailyPrincipalAmount = (double)a.dailyPrincipalAmount,
                //              closingBalance = (double)a.closingBalance,
                //              endPrincipalAmount = (double)a.endPrincipalAmount,
                //              amortisedCost = (double)a.amortisedCost,
                //              accruedInterest = (double)a.accruedInterest,
                //              norminalInterestRate = a.norminalInterestRate,
                //              amOpeningBalance = (double)a.amOpeningBalance,
                //              amStartPrincipalAmount = (double)a.amStartPrincipalAmount,
                //              amDailyPaymentAmount = (double)a.amDailyPaymentAmount,
                //              amDailyInterestAmount = (double)a.amDailyInterestAmount,
                //              amDailyPrincipalAmount = (double)a.amDailyPrincipalAmount,
                //              amClosingBalance = (double)a.amClosingBalance,
                //              amEndPrincipalAmount = (double)a.amEndPrincipalAmount,
                //              amAccruedInterest = (double)a.amAccruedInterest,
                //              amAmortisedCost = (double)a.amAmortisedCost,
                //              discountPremium = (double)a.discountPremium,
                //              unEarnedFee = (double)a.unEarnedFee,
                //              earnedFee = (double)a.earnedFee,
                //              effectiveInterestRate = a.effectiveInterestRate,
                //              numberOfPeriods = a.numberOfPeriods,
                //              ballonAmount = (double)a.ballonAmount,
                //              createdBy = a.createdBy,
                //              dateTimeCreated = a.dateTimeCreated,
                //          }).ToList();


                model = model1.Union(model2).OrderBy(x => x.paymentNumber).ToList();

                List<TBL_LOAN_SCHEDULE_DAILY> loanScheduleDaily = new List<TBL_LOAN_SCHEDULE_DAILY>();


                foreach (var item in model)
                {
                    TBL_LOAN_SCHEDULE_DAILY addLoanScheduleDaily = new TBL_LOAN_SCHEDULE_DAILY();

                    addLoanScheduleDaily.LOANID = loanId;
                    addLoanScheduleDaily.PAYMENTNUMBER = ++no - 1;
                    addLoanScheduleDaily.DATE = item.date;
                    addLoanScheduleDaily.PAYMENTDATE = item.paymentDate;
                    addLoanScheduleDaily.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                    addLoanScheduleDaily.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                    addLoanScheduleDaily.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                    addLoanScheduleDaily.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                    addLoanScheduleDaily.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                    addLoanScheduleDaily.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                    addLoanScheduleDaily.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                    addLoanScheduleDaily.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                    addLoanScheduleDaily.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                    addLoanScheduleDaily.INTERESTRATE = item.norminalInterestRate;
                    addLoanScheduleDaily.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                    addLoanScheduleDaily.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                    addLoanScheduleDaily.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                    addLoanScheduleDaily.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                    addLoanScheduleDaily.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                    addLoanScheduleDaily.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                    addLoanScheduleDaily.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                    addLoanScheduleDaily.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                    addLoanScheduleDaily.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                    addLoanScheduleDaily.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                    addLoanScheduleDaily.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                    addLoanScheduleDaily.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                    addLoanScheduleDaily.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                    addLoanScheduleDaily.NUMBEROFPERIODS = item.numberOfPeriods;
                    addLoanScheduleDaily.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                    addLoanScheduleDaily.CREATEDBY = item.createdBy;
                    addLoanScheduleDaily.DATETIMECREATED = item.dateTimeCreated;

                    loanScheduleDaily.Add(addLoanScheduleDaily);

                }

                var itemToRemove = (from p in context.TBL_LOAN_SCHEDULE_DAILY
                                    where p.LOANID == loanId
                                    select p);

                if (itemToRemove != null)
                {
                    context.TBL_LOAN_SCHEDULE_DAILY.RemoveRange(itemToRemove);
                    context.SaveChanges();
                }

                context.TBL_LOAN_SCHEDULE_DAILY.AddRange(loanScheduleDaily);

            }


            catch (Exception ex)
            {

                throw ex;
            }


            context.SaveChanges();
            return model;

        }


        public List<LoanPaymentSchedulePeriodicViewModel> ArchivePeriodicSchedule(int loanId, string archiveBatchCode, FinTrakBankingContext context)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var model = (from a in context.TBL_LOAN_SCHEDULE_PERIODIC
                         where a.LOANID == loanId
                         select new LoanPaymentSchedulePeriodicViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             paymentDate = a.PAYMENTDATE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             periodPaymentAmount = (double)a.PERIODPAYMENTAMOUNT,
                             periodInterestAmount = (double)a.PERIODINTERESTAMOUNT,
                             periodPrincipalAmount = (double)a.PERIODPRINCIPALAMOUNT,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             interestRate = a.INTERESTRATE,
                             amortisedStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amortisedPeriodPaymentAmount = (double)a.AMORTISEDPERIODPAYMENTAMOUNT,
                             amortisedPeriodInterestAmount = (double)a.AMORTISEDPERIODINTERESTAMOUNT,
                             amortisedPeriodPrincipalAmount = (double)a.AMORTISEDPERIODPRINCIPALAMOUNT,
                             amortisedEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,

                         }).ToList();

            List<TBL_LOAN_SCHEDULE_PERIODIC_ARC> loanSchedulePeriodicArchive = new List<TBL_LOAN_SCHEDULE_PERIODIC_ARC>();



            foreach (var item in model)
            {

                TBL_LOAN_SCHEDULE_PERIODIC_ARC addLoanSchedulePeriodicArchive = new TBL_LOAN_SCHEDULE_PERIODIC_ARC();


                addLoanSchedulePeriodicArchive.LOANID = item.loanId;
                addLoanSchedulePeriodicArchive.ARCHIVEDATE = systemDate;
                addLoanSchedulePeriodicArchive.PAYMENTNUMBER = item.paymentNumber;
                addLoanSchedulePeriodicArchive.PAYMENTDATE = item.paymentDate;
                addLoanSchedulePeriodicArchive.STARTPRINCIPALAMOUNT = (decimal)item.startPrincipalAmount;
                addLoanSchedulePeriodicArchive.PERIODPAYMENTAMOUNT = (decimal)item.periodPaymentAmount;
                addLoanSchedulePeriodicArchive.PERIODINTERESTAMOUNT = (decimal)item.periodInterestAmount;
                addLoanSchedulePeriodicArchive.PERIODPRINCIPALAMOUNT = (decimal)item.periodPrincipalAmount;
                addLoanSchedulePeriodicArchive.ENDPRINCIPALAMOUNT = (decimal)item.endPrincipalAmount;
                addLoanSchedulePeriodicArchive.INTERESTRATE = item.interestRate;
                addLoanSchedulePeriodicArchive.AMORTISEDSTARTPRINCIPALAMOUNT = (decimal)item.amortisedStartPrincipalAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDPERIODPAYMENTAMOUNT = (decimal)item.amortisedPeriodPaymentAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDPERIODINTERESTAMOUNT = (decimal)item.amortisedPeriodInterestAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDPERIODPRINCIPALAMOUNT = (decimal)item.amortisedPeriodPrincipalAmount;
                addLoanSchedulePeriodicArchive.AMORTISEDENDPRINCIPALAMOUNT = (decimal)item.amortisedEndPrincipalAmount;
                addLoanSchedulePeriodicArchive.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanSchedulePeriodicArchive.CREATEDBY = item.createdBy;
                addLoanSchedulePeriodicArchive.DATETIMECREATED = item.dateTimeCreated;
                addLoanSchedulePeriodicArchive.ARCHIVEBATCHCODE = archiveBatchCode;

                loanSchedulePeriodicArchive.Add(addLoanSchedulePeriodicArchive);

            }

            context.TBL_LOAN_SCHEDULE_PERIODIC_ARC.AddRange(loanSchedulePeriodicArchive);

            context.SaveChanges();
            return model;

        }

        public List<LoanPaymentScheduleDailyViewModel> ArchiveDailySchedule(int loanId, string archiveBatchCode, FinTrakBankingContext context)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var model = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                         where a.LOANID == loanId
                         select new LoanPaymentScheduleDailyViewModel()
                         {
                             loanId = a.LOANID,
                             paymentNumber = a.PAYMENTNUMBER,
                             date = a.DATE,
                             paymentDate = a.PAYMENTDATE,
                             openingBalance = (double)a.OPENINGBALANCE,
                             startPrincipalAmount = (double)a.STARTPRINCIPALAMOUNT,
                             dailyPaymentAmount = (double)a.DAILYPAYMENTAMOUNT,
                             dailyInterestAmount = (double)a.DAILYINTERESTAMOUNT,
                             dailyPrincipalAmount = (double)a.DAILYPRINCIPALAMOUNT,
                             closingBalance = (double)a.CLOSINGBALANCE,
                             endPrincipalAmount = (double)a.ENDPRINCIPALAMOUNT,
                             amortisedCost = (double)a.AMORTISEDCOST,
                             accruedInterest = (double)a.ACCRUEDINTEREST,
                             norminalInterestRate = a.INTERESTRATE,
                             amOpeningBalance = (double)a.AMORTISEDOPENINGBALANCE,
                             amStartPrincipalAmount = (double)a.AMORTISEDSTARTPRINCIPALAMOUNT,
                             amDailyPaymentAmount = (double)a.AMORTISEDDAILYPAYMENTAMOUNT,
                             amDailyInterestAmount = (double)a.AMORTISEDDAILYINTERESTAMOUNT,
                             amDailyPrincipalAmount = (double)a.AMORTISEDDAILYPRINCIPALAMOUNT,
                             amClosingBalance = (double)a.AMORTISEDCLOSINGBALANCE,
                             amEndPrincipalAmount = (double)a.AMORTISEDENDPRINCIPALAMOUNT,
                             amAccruedInterest = (double)a.AMORTISEDACCRUEDINTEREST,
                             amAmortisedCost = (double)a.AMORTISED_AMORTISEDCOST,
                             discountPremium = (double)a.DISCOUNTPREMIUM,
                             unEarnedFee = (double)a.UNEARNEDFEE,
                             earnedFee = (double)a.EARNEDFEE,
                             effectiveInterestRate = a.EFFECTIVEINTERESTRATE,
                             numberOfPeriods = a.NUMBEROFPERIODS,
                             ballonAmount = (double)a.BALLONAMOUNT,
                             createdBy = a.CREATEDBY,
                             dateTimeCreated = a.DATETIMECREATED,

                         }).ToList();

            List<TBL_LOAN_SCHEDULE_DAILY_ARCHIV> loanScheduleDailyArchive = new List<TBL_LOAN_SCHEDULE_DAILY_ARCHIV>();

            foreach (var item in model)
            {
                TBL_LOAN_SCHEDULE_DAILY_ARCHIV addLoanScheduleDailyArchive = new TBL_LOAN_SCHEDULE_DAILY_ARCHIV();

                addLoanScheduleDailyArchive.LOANID = loanId;
                addLoanScheduleDailyArchive.ARCHIVEDATE = systemDate;
                addLoanScheduleDailyArchive.PAYMENTNUMBER = item.paymentNumber;
                addLoanScheduleDailyArchive.DATE = item.date;
                addLoanScheduleDailyArchive.PAYMENTDATE = item.paymentDate;
                addLoanScheduleDailyArchive.OPENINGBALANCE = Convert.ToDecimal(item.openingBalance);
                addLoanScheduleDailyArchive.STARTPRINCIPALAMOUNT = Convert.ToDecimal(item.startPrincipalAmount);
                addLoanScheduleDailyArchive.DAILYPAYMENTAMOUNT = Convert.ToDecimal(item.dailyPaymentAmount);
                addLoanScheduleDailyArchive.DAILYINTERESTAMOUNT = Convert.ToDecimal(item.dailyInterestAmount);
                addLoanScheduleDailyArchive.DAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.dailyPrincipalAmount);
                addLoanScheduleDailyArchive.CLOSINGBALANCE = Convert.ToDecimal(item.closingBalance);
                addLoanScheduleDailyArchive.ENDPRINCIPALAMOUNT = Convert.ToDecimal(item.endPrincipalAmount);
                addLoanScheduleDailyArchive.ACCRUEDINTEREST = Convert.ToDecimal(item.accruedInterest);
                addLoanScheduleDailyArchive.AMORTISEDCOST = Convert.ToDecimal(item.amortisedCost);
                addLoanScheduleDailyArchive.INTERESTRATE = item.norminalInterestRate;
                addLoanScheduleDailyArchive.AMORTISEDOPENINGBALANCE = Convert.ToDecimal(item.amOpeningBalance);
                addLoanScheduleDailyArchive.AMORTISEDSTARTPRINCIPALAMOUNT = Convert.ToDecimal(item.amStartPrincipalAmount);
                addLoanScheduleDailyArchive.AMORTISEDDAILYPAYMENTAMOUNT = Convert.ToDecimal(item.amDailyPaymentAmount);
                addLoanScheduleDailyArchive.AMORTISEDDAILYINTERESTAMOUNT = Convert.ToDecimal(item.amDailyInterestAmount);
                addLoanScheduleDailyArchive.AMORTISEDDAILYPRINCIPALAMOUNT = Convert.ToDecimal(item.amDailyPrincipalAmount);
                addLoanScheduleDailyArchive.AMORTISEDCLOSINGBALANCE = Convert.ToDecimal(item.amClosingBalance);
                addLoanScheduleDailyArchive.AMORTISEDENDPRINCIPALAMOUNT = Convert.ToDecimal(item.amEndPrincipalAmount);
                addLoanScheduleDailyArchive.AMORTISEDACCRUEDINTEREST = Convert.ToDecimal(item.amAccruedInterest);
                addLoanScheduleDailyArchive.AMORTISED_AMORTISEDCOST = Convert.ToDecimal(item.amAmortisedCost);
                addLoanScheduleDailyArchive.DISCOUNTPREMIUM = Convert.ToDecimal(item.discountPremium);
                addLoanScheduleDailyArchive.UNEARNEDFEE = Convert.ToDecimal(item.unEarnedFee);
                addLoanScheduleDailyArchive.EARNEDFEE = Convert.ToDecimal(item.earnedFee);
                addLoanScheduleDailyArchive.EFFECTIVEINTERESTRATE = item.effectiveInterestRate;
                addLoanScheduleDailyArchive.NUMBEROFPERIODS = item.numberOfPeriods;
                addLoanScheduleDailyArchive.BALLONAMOUNT = Convert.ToDecimal(item.balloonAmt);
                addLoanScheduleDailyArchive.CREATEDBY = item.createdBy;
                addLoanScheduleDailyArchive.DATETIMECREATED = item.dateTimeCreated;
                addLoanScheduleDailyArchive.ARCHIVEDATE = generalSetup.GetApplicationDate();
                addLoanScheduleDailyArchive.ARCHIVEBATCHCODE = archiveBatchCode;

                loanScheduleDailyArchive.Add(addLoanScheduleDailyArchive);

            }

            context.TBL_LOAN_SCHEDULE_DAILY_ARCHIV.AddRange(loanScheduleDailyArchive);

            context.SaveChanges();
            return model;
        }



        public void CommercialPaperChangeOperativeAccount(int casaPayAccountId, int newCasaPayAccountId)
        { //TODO rework
            TBL_LOAN_REVOLVING result = (from p in context.TBL_LOAN_REVOLVING
                                         where //p.CASAACCOUNTID2 == casaPayAccountId &&
                                 p.LOANSTATUSID == (short)LoanStatusEnum.Active
                                         select p).SingleOrDefault();
            var casa = this.context.TBL_CASA.Where(x => x.CASAACCOUNTID == newCasaPayAccountId && x.ACCOUNTSTATUSID == (short)CASAAccountStatusEnum.Active).FirstOrDefault().CASAACCOUNTID;

            // result.CASAACCOUNTID2 = casa;
            context.SaveChanges();
        }

        public IEnumerable<LoanReviewOperationApprovalViewModel> GetRunningCommercialLoans(int companyId, string loanReferenceNumber)
        {
            var data = (from ln in context.TBL_LOAN
                        where ln.MATURITYDATE > DateTime.Now
                        && ln.LOANSTATUSID == (short)LoanStatusEnum.Active
                        && ln.OPERATIONID == (int)OperationsEnum.CommercialLoanBooking
                        && ln.COMPANYID == companyId
                        orderby ln.MATURITYDATE descending
                        select new LoanReviewOperationApprovalViewModel
                        {
                            loanId = ln.TERMLOANID,
                            customerId = ln.CUSTOMERID,
                            productId = ln.PRODUCTID,
                            casaAccountId = ln.CASAACCOUNTID,
                            branchId = ln.BRANCHID,
                            loanReferenceNumber = ln.LOANREFERENCENUMBER,
                            loanApplicationDetailId = ln.LOANAPPLICATIONDETAILID,
                            companyId = ln.COMPANYID,
                            exchangeRate = ln.EXCHANGERATE,
                            principalAmount = ln.PRINCIPALAMOUNT,
                            interestRate = ln.INTERESTRATE,
                            outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                            outstandingInterest = ln.OUTSTANDINGINTEREST,
                            maturityAmount = ln.OUTSTANDINGPRINCIPAL + ln.OUTSTANDINGINTEREST,
                            dateTimeCreated = ln.DATETIMECREATED,
                            createdByName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.LASTNAME,
                            dischargeLetter = ln.DISCHARGELETTER,

                            relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                            relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                            misCode = ln.MISCODE,
                            teamMiscode = ln.TEAMMISCODE,
                            effectiveDate = ln.EFFECTIVEDATE,
                            maturityDate = ln.MATURITYDATE,
                            bookingDate = ln.BOOKINGDATE,

                            approverComment = ln.APPROVERCOMMENT,
                            dateApproved = ln.DATEAPPROVED,

                            isDisbursed = ln.ISDISBURSED,
                            disburserComment = ln.DISBURSERCOMMENT,
                            disburseDate = ln.DISBURSEDATE,
                            newTenor = DbFunctions.DiffDays(ln.MATURITYDATE, ln.EFFECTIVEDATE).Value,
                            customerGroupId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                            operationId = ln.OPERATIONID,
                            loanTypeId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                            subSectorId = ln.SUBSECTORID,
                            subSectorName = ln.TBL_SUB_SECTOR.NAME,
                            sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,

                            customerCode = ln.TBL_CUSTOMER.CUSTOMERCODE,
                            productAccountNumber = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTCODE,
                            productAccountName = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTNAME,
                            loanTypeName = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            customerName = ln.TBL_CUSTOMER.LASTNAME + " " + ln.TBL_CUSTOMER.FIRSTNAME + " " + ln.TBL_CUSTOMER.MIDDLENAME,
                            currencyId = ln.CURRENCYID,
                            currencyCode = ln.TBL_CURRENCY.CURRENCYCODE,
                            branchName = ln.TBL_BRANCH.BRANCHNAME,
                            relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                            relationshipManagerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                            productName = ln.TBL_PRODUCT.PRODUCTNAME,
                            loanStatusId = ln.LOANSTATUSID,
                            comment = "",
                        }).ToList();
            return data;
        }

        public IEnumerable<MaturityIntructionViewModel> GetLoanMaturityInstructions()
        {
            var data = (from a in context.TBL_LOAN_MATURITY_INSTRUCTION
                        where a.ISUSED == false
                        select new MaturityIntructionViewModel
                        {
                            instructionTypeId = a.INSTRUCTIONTYPEID,
                            instructionTypeName = a.TBL_LOAN_MATURITY_INSTRU_TYPE.INSTRUCTIONTYPENAME,
                            newTenor = a.TENOR,
                            loanId = a.LOANID,
                            maturityInstructionId = a.MATURITYINSTRUCTIONID,
                            loanSystemTypeId = a.LOANSYSTEMTYPEID,
                            loanReferenceNumber = context.TBL_LOAN.Where(x => x.TERMLOANID == a.LOANID).FirstOrDefault().LOANREFERENCENUMBER,
                            oldTenor = context.TBL_LOAN_APPLICATION_DETAIL.Where(c => c.LOANAPPLICATIONDETAILID == context.TBL_LOAN.Where(n => n.LOANAPPLICATIONDETAILID == c.LOANAPPLICATIONDETAILID).FirstOrDefault().LOANAPPLICATIONDETAILID).FirstOrDefault().APPROVEDTENOR,

                            dateTimeCreated = a.DATETIMECREATED,
                            createdBy = a.CREATEDBY,
                        }).ToList();
            foreach (var i in data)
            {
                var outstandingPrincipal = (decimal)context.TBL_LOAN.Where(x => x.TERMLOANID == i.loanId).FirstOrDefault().OUTSTANDINGPRINCIPAL;
                var outstandingInterest = (decimal)context.TBL_LOAN.Where(x => x.TERMLOANID == i.loanId).FirstOrDefault().OUTSTANDINGINTEREST;
                var interestRate = (double)context.TBL_LOAN.Where(x => x.TERMLOANID == i.loanId).FirstOrDefault().INTERESTRATE;
                var customer = (from b in context.TBL_CUSTOMER join k in context.TBL_LOAN on b.CUSTOMERID equals k.CUSTOMERID where k.TERMLOANID == i.loanId select b).FirstOrDefault();

                i.outstandingPrincipal = outstandingPrincipal;
                i.outstandingInterest = outstandingInterest;
                i.interestRate = interestRate;

                i.customerName = customer.FIRSTNAME + " " + customer.MIDDLENAME + " " + customer.LASTNAME;

            }
            var g = data.ToList();
            return data;
        }

        public List<LoanReviewOperationParentChildViewModel> GetRunningCommercialLoanLines(int companyId)
        {
            var data = from a in context.TBL_LOAN_APPLICATION_DETAIL
                       join ln in context.TBL_LOAN on a.LOANAPPLICATIONDETAILID equals ln.LOANAPPLICATIONDETAILID
                       join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                       where ln.LOANSTATUSID == (short)LoanStatusEnum.Active
                       // && ln.OPERATIONID == (int)OperationsEnum.CommercialPaperLoanBooking
                       && ln.COMPANYID == companyId
                       orderby ln.MATURITYDATE descending
                       select new LoanReviewOperationParentChildViewModel
                       {
                           applicationReferenceNumber = a.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER,
                           loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                           firstName = a.TBL_CUSTOMER.FIRSTNAME,
                           middleName = a.TBL_CUSTOMER.MIDDLENAME,
                           lastName = a.TBL_CUSTOMER.LASTNAME,
                           approvedAmount = a.APPROVEDAMOUNT,
                           approvedInterestRate = a.APPROVEDINTERESTRATE,
                           approvedProductName = a.TBL_PRODUCT.PRODUCTNAME,
                           customerName = c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME,
                           customerCode = c.CUSTOMERCODE,
                           approvedTenor = a.APPROVEDTENOR,
                           //lineEffectiveDate =  (DateTime)a.EXPIRYDATE.Value.AddDays(- (int)a.APPROVEDTENOR) ,
                           expiryDate = (DateTime)a.EXPIRYDATE,
                           //tenorLeft = a.APPROVEDTENOR - (int)a.EXPIRYDATE.Value.AddDays(-(int)a.APPROVEDTENOR).Day

                       };
            var v = data;
            return data.ToList();
        }

        public IEnumerable<MaturityIntructionViewModel> GetMaturityInstructionType()
        {
            var data = from a in context.TBL_LOAN_MATURITY_INSTRU_TYPE
                       select new MaturityIntructionViewModel
                       {
                           instructionTypeId = a.INSTRUCTIONTYPEID,
                           instructionTypeName = a.INSTRUCTIONTYPENAME,
                       };

            return data.ToList();
        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool CommercialPaperDetailsCancellation(string refNo, DateTime applicationDate, int staffId)
        {
            bool output = false;
            var systemDate = generalSetup.GetApplicationDate();

            TBL_LOAN_REVOLVING result = (from p in context.TBL_LOAN_REVOLVING
                                         where p.LOANREFERENCENUMBER == refNo
                                         select p).SingleOrDefault();

            result.LOANSTATUSID = (short)LoanStatusEnum.Cancelled;

            context.SaveChanges();

            output = true;

            return output;

        }

        [OperationBehavior(TransactionScopeRequired = true)]
        public bool CommercialPaperCancellation(int aplicationId, DateTime applicationDate, int staffId)
        {
            bool output = false;
            var systemDate = generalSetup.GetApplicationDate();

            TBL_LOAN_APPLICATION result = (from p in context.TBL_LOAN_APPLICATION
                                           where p.LOANAPPLICATIONID == aplicationId
                                           select p).SingleOrDefault();

            result.APPLICATIONSTATUSID = (short)LoanStatusEnum.Cancelled;

            context.SaveChanges();

            output = true;

            return output;

        }

        public List<LoanReviewOperationParentChildViewModel> GetCommercialLoansLines(int companyId)
        {
            var data = from a in context.TBL_LOAN_APPLICATION_DETAIL
                       join ln in context.TBL_LOAN on a.LOANAPPLICATIONDETAILID equals ln.LOANAPPLICATIONDETAILID
                       where //ln.MATURITYDATE < DateTime.Now
                             //ln.LOANSTATUSID == (short)LoanStatusEnum.Completed || ln.LOANSTATUSID == (short)LoanStatusEnum.Active
                        ln.OPERATIONID == (int)OperationsEnum.CommercialLoanBooking
                       && ln.COMPANYID == companyId
                       orderby ln.MATURITYDATE descending
                       select new LoanReviewOperationParentChildViewModel
                       {
                           applicationReferenceNumber = a.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER,
                           loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                           firstName = a.TBL_CUSTOMER.FIRSTNAME,
                           middleName = a.TBL_CUSTOMER.MIDDLENAME,
                           lastName = a.TBL_CUSTOMER.LASTNAME,
                           approvedAmount = a.APPROVEDAMOUNT,
                           approvedInterestRate = a.APPROVEDINTERESTRATE,
                           approvedProductName = a.TBL_PRODUCT.PRODUCTNAME,
                       };
            var c = data.ToList();
            //foreach(var i in data)
            //{
            //    var startDate = i.effectiveDate;
            //    var endDate = i.expiryDate;
            //    if(i.expiryDate != null && i.effectiveDate != null)
            //    {
            //        i.interestAtMuturity = loan.getTotalInterest((decimal)i.approvedAmount, (double)i.approvedInterestRate, loan.getDaysInLoanPeriod(startDate,endDate.Value));
            //    }

            //}

            return data.ToList();
        }

        public List<LoanReviewOperationApprovalViewModel> GetDueCommercialLoansByApplicationDetailId(int companyId, int loanApplicationDetailID)
        {
            var data = (from ln in context.TBL_LOAN
                        where ln.LOANAPPLICATIONDETAILID == loanApplicationDetailID
                        ////&& ln.MATURITYDATE < DateTime.Now
                        ////&& ln.LOANSTATUSID == (short)LoanStatusEnum.Active || ln.LOANSTATUSID == (short)LoanStatusEnum.Completed
                        && ln.OPERATIONID == (int)OperationsEnum.CommercialLoanBooking
                        && ln.COMPANYID == companyId
                        orderby ln.MATURITYDATE descending
                        select new LoanReviewOperationApprovalViewModel
                        {
                            loanId = ln.TERMLOANID,
                            customerId = ln.CUSTOMERID,
                            productId = ln.PRODUCTID,
                            casaAccountId = ln.CASAACCOUNTID,
                            branchId = ln.BRANCHID,
                            loanReferenceNumber = ln.LOANREFERENCENUMBER,
                            relatedReferenceNumber = ln.RELATED_LOAN_REFERENCE_NUMBER,
                            loanApplicationDetailId = ln.LOANAPPLICATIONDETAILID,
                            companyId = ln.COMPANYID,
                            exchangeRate = ln.EXCHANGERATE,

                            principalAmount = ln.PRINCIPALAMOUNT,
                            interestRate = ln.INTERESTRATE,
                            interestAmount = ln.OUTSTANDINGINTEREST,
                            outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                            outstandingInterest = ln.OUTSTANDINGINTEREST,

                            maturityAmount = ln.OUTSTANDINGPRINCIPAL + ln.OUTSTANDINGINTEREST,
                            dateTimeCreated = ln.DATETIMECREATED,
                            createdByName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.LASTNAME,
                            dischargeLetter = ln.DISCHARGELETTER,

                            relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                            relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                            misCode = ln.MISCODE,
                            teamMiscode = ln.TEAMMISCODE,
                            effectiveDate = ln.EFFECTIVEDATE,
                            maturityDate = ln.MATURITYDATE,
                            bookingDate = ln.BOOKINGDATE,

                            approverComment = ln.APPROVERCOMMENT,
                            dateApproved = ln.DATEAPPROVED,

                            isDisbursed = ln.ISDISBURSED,
                            disburserComment = ln.DISBURSERCOMMENT,
                            disburseDate = ln.DISBURSEDATE,
                            customerGroupId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                            operationId = ln.OPERATIONID,
                            loanTypeId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                            subSectorId = ln.SUBSECTORID,
                            subSectorName = ln.TBL_SUB_SECTOR.NAME,
                            sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,

                            customerCode = ln.TBL_CUSTOMER.CUSTOMERCODE,
                            productAccountNumber = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTCODE,
                            productAccountName = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTNAME,
                            loanTypeName = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            customerName = ln.TBL_CUSTOMER.LASTNAME + " " + ln.TBL_CUSTOMER.FIRSTNAME + " " + ln.TBL_CUSTOMER.MIDDLENAME,
                            currencyId = ln.CURRENCYID,
                            currencyCode = ln.TBL_CURRENCY.CURRENCYCODE,
                            branchName = ln.TBL_BRANCH.BRANCHNAME,
                            relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                            relationshipManagerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                            productName = ln.TBL_PRODUCT.PRODUCTNAME,
                            loanStatusId = ln.LOANSTATUSID,
                            comment = "",
                        });
            return data.ToList();
        }

        public List<LoanReviewOperationApprovalViewModel> GetDueCommercialLoans(int companyId)
        {
            var date = DateTime.Now.Date;
            var data = (from ln in context.TBL_LOAN
                        where //ln.MATURITYDATE < DateTime.Now &&
                         ln.OPERATIONID == (int)OperationsEnum.CommercialLoanBooking
                        && ln.COMPANYID == companyId
                        orderby ln.MATURITYDATE descending
                        select new LoanReviewOperationApprovalViewModel
                        {
                            loanId = ln.TERMLOANID,
                            customerId = ln.CUSTOMERID,
                            productId = ln.PRODUCTID,
                            casaAccountId = ln.CASAACCOUNTID,
                            branchId = ln.BRANCHID,
                            loanReferenceNumber = ln.LOANREFERENCENUMBER,
                            relatedReferenceNumber = ln.RELATED_LOAN_REFERENCE_NUMBER,
                            loanApplicationDetailId = ln.LOANAPPLICATIONDETAILID,
                            companyId = ln.COMPANYID,
                            exchangeRate = ln.EXCHANGERATE,

                            principalAmount = ln.PRINCIPALAMOUNT,
                            interestRate = ln.INTERESTRATE,
                            interestAmount = ln.OUTSTANDINGINTEREST,
                            outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                            outstandingInterest = ln.OUTSTANDINGINTEREST,

                            maturityAmount = ln.OUTSTANDINGPRINCIPAL + ln.OUTSTANDINGINTEREST,
                            dateTimeCreated = ln.DATETIMECREATED,
                            createdByName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.LASTNAME,
                            dischargeLetter = ln.DISCHARGELETTER,

                            relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                            relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                            misCode = ln.MISCODE,
                            teamMiscode = ln.TEAMMISCODE,
                            effectiveDate = ln.EFFECTIVEDATE,
                            maturityDate = ln.MATURITYDATE,
                            bookingDate = ln.BOOKINGDATE,

                            approverComment = ln.APPROVERCOMMENT,
                            dateApproved = ln.DATEAPPROVED,

                            isDisbursed = ln.ISDISBURSED,
                            disburserComment = ln.DISBURSERCOMMENT,
                            disburseDate = ln.DISBURSEDATE,
                            customerGroupId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                            operationId = ln.OPERATIONID,
                            loanTypeId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                            subSectorId = ln.SUBSECTORID,
                            subSectorName = ln.TBL_SUB_SECTOR.NAME,
                            sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,

                            customerCode = ln.TBL_CUSTOMER.CUSTOMERCODE,
                            productAccountNumber = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTCODE,
                            productAccountName = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTNAME,
                            loanTypeName = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            customerName = ln.TBL_CUSTOMER.LASTNAME + " " + ln.TBL_CUSTOMER.FIRSTNAME + " " + ln.TBL_CUSTOMER.MIDDLENAME,
                            currencyId = ln.CURRENCYID,
                            currencyCode = ln.TBL_CURRENCY.CURRENCYCODE,
                            branchName = ln.TBL_BRANCH.BRANCHNAME,
                            relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                            relationshipManagerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                            productName = ln.TBL_PRODUCT.PRODUCTNAME,
                            loanStatusId = ln.LOANSTATUSID,
                            comment = "",
                        });
            return data.ToList();
        }

        public LoanViewModel GetContingentByLoanId(int contingentLoanId)
        {
            //decimal overDraftLimit = 0;
            decimal availableBalance = 0;
            //var odDetail = context.TBL_LOAN_REVOLVING.FirstOrDefault(x => x.REVOLVINGLOANID == revolvingLoanId);
            var odDetail = context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == contingentLoanId);
            if (odDetail != null)
            {
                //overDraftLimit = odDetail.OVERDRAFTLIMIT;
                availableBalance = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == odDetail.CASAACCOUNTID).AVAILABLEBALANCE;
            }
            //var overDraftDetail = (from a in context.TBL_LOAN_REVOLVING
            //                       join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
            //                       join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
            //                       where a.REVOLVINGLOANID == revolvingLoanId
            //                       select new LoanViewModel
            //                       {
            //                           loanId = a.REVOLVINGLOANID,
            //                           customerId = a.CUSTOMERID,
            //                           customerName = b.FIRSTNAME + " " + b.LASTNAME,
            //                           customerCode = b.CUSTOMERCODE,
            //                           productId = a.PRODUCTID,
            //                           companyId = a.COMPANYID,
            //                           casaAccountId = a.CASAACCOUNTID,
            //                           branchId = a.BRANCHID,
            //                           branchName = a.TBL_BRANCH.BRANCHNAME,
            //                           loanReferenceNumber = a.LOANREFERENCENUMBER,
            //                           //applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
            //                           //loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
            //                           //productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
            //                           //productName = a.TBL_PRODUCT.PRODUCTNAME,
            //                           //productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
            //                           //relationshipOfficerId = a.RELATIONSHIPOFFICERID,
            //                           //relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
            //                           //relationshipManagerId = a.RELATIONSHIPMANAGERID,
            //                           //relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
            //                           //misCode = a.MISCODE,
            //                           //teamMiscode = a.TEAMMISCODE,
            //                           //interestRate = a.INTERESTRATE,
            //                           //effectiveDate = a.EFFECTIVEDATE,
            //                           //maturityDate = a.MATURITYDATE,
            //                           //bookingDate = a.BOOKINGDATE,
            //                           //principalAmount = a.OVERDRAFTLIMIT,
            //                           //approvalStatusId = a.APPROVALSTATUSID,
            //                           //approverComment = a.APPROVERCOMMENT,
            //                           //dateApproved = a.DATEAPPROVED,
            //                           //loanStatusId = a.LOANSTATUSID,
            //                           //isDisbursed = a.ISDISBURSED,
            //                           //disburserComment = a.DISBURSERCOMMENT,
            //                           //disburseDate = a.DISBURSEDATE,
            //                           //operationId = a.OPERATIONID,
            //                           //operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
            //                           //subSectorName = a.TBL_SUB_SECTOR.NAME,
            //                           //sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
            //                           //casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
            //                           //productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
            //                           //customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
            //                           //loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
            //                           //loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
            //                           outstandingPrincipal = availableBalance,
            //                           dischargeLetter = a.DISCHARGELETTER,
            //                           suspendInterest = a.SUSPENDINTEREST,
            //                           customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
            //                           createdBy = a.CREATEDBY,
            //                           dateTimeCreated = a.DATETIMECREATED,
            //                           exchangeRate = a.EXCHANGERATE,
            //                           currencyId = a.CURRENCYID,
            //                           currency = a.TBL_CURRENCY.CURRENCYNAME,
            //                       }).FirstOrDefault();

            var overDraftDetail = (from a in context.TBL_LOAN_CONTINGENT
                                   join tt in context.TBL_OPERATIONS on a.OPERATIONID equals tt.OPERATIONID
                                   join br in context.TBL_BRANCH on a.BRANCHID equals br.BRANCHID
                                   join ld in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                   join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                   join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   join pr in context.TBL_PRODUCT on a.PRODUCTID equals pr.PRODUCTID
                                   join st in context.TBL_STAFF on a.RELATIONSHIPOFFICERID equals st.STAFFID
                                   join stm in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals stm.STAFFID
                                   where a.CONTINGENTLOANID == contingentLoanId
                                   select new LoanViewModel
                                   {
                                       loanId = a.CONTINGENTLOANID,
                                       customerId = a.CUSTOMERID,
                                       customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                       customerCode = b.CUSTOMERCODE,
                                       productId = a.PRODUCTID,
                                       companyId = a.COMPANYID,
                                       casaAccountId = a.CASAACCOUNTID,
                                       branchId = a.BRANCHID,
                                       branchName = br.BRANCHNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = lp.LOANAPPLICATIONID,
                                       productTypeId = pr.PRODUCTTYPEID,
                                       productName = pr.PRODUCTNAME,
                                       productTypeName = pr.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                       relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                       relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                       relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                       relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                       misCode = a.MISCODE,
                                       teamMiscode = a.TEAMMISCODE,
                                       //interestRate = a.INTERESTRATE,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       bookingDate = a.BOOKINGDATE,
                                       principalAmount = a.CONTINGENTAMOUNT,
                                       approvalStatusId = a.APPROVALSTATUSID,
                                       approverComment = a.APPROVERCOMMENT,
                                       dateApproved = a.DATEAPPROVED,
                                       loanStatusId = a.LOANSTATUSID,
                                       isDisbursed = a.ISDISBURSED,
                                       disburserComment = a.DISBURSERCOMMENT,
                                       disburseDate = a.DISBURSEDATE,
                                       operationId = a.OPERATIONID,
                                       operationName = tt.OPERATIONNAME,
                                       subSectorName = a.TBL_SUB_SECTOR.NAME,
                                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                       casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                       productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                       customerGroupId = lp.CUSTOMERGROUPID,
                                       loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                       loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                       outstandingPrincipal = availableBalance,
                                       dischargeLetter = a.DISCHARGELETTER,
                                       //suspendInterest = a.SUSPENDINTEREST,
                                       customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                       createdBy = a.CREATEDBY,
                                       dateTimeCreated = a.DATETIMECREATED,
                                       exchangeRate = a.EXCHANGERATE,
                                       currencyId = a.CURRENCYID,
                                       currency = a.TBL_CURRENCY.CURRENCYNAME,
                                   }).FirstOrDefault();
            //if (availableBalance > 0)
            //{
            //    contingentDetail.overDraft = overDraftLimit;
            //}
            //else
            //{
            //    overDraftDetail.overDraft = overDraftLimit - Math.Abs(availableBalance);
            //}
            return overDraftDetail;

        }

        public bool SaveDocument(LoanReviewOperationViewModel model, byte[] file)
        {
            var review = context.TBL_LOAN_REVIEW_OPERATION.Where(a => a.LOANID == model.loanId && a.OPERATIONCOMPLETED == false && a.LOANSYSTEMTYPEID == model.loanSystemTypeId).FirstOrDefault();



            var rec = context.TBL_LOAN_CONTINGENT.Where(x => x.CONTINGENTLOANID == model.loanId).FirstOrDefault();

            var data = new TBL_TEMP_MEDIA_LOAN_DOCUMENTS
            {
                FILEDATA = file,
                DOCUMENTTITLE = model.documentTitle,
                FILENAME = model.fileName,
                FILEEXTENSION = model.fileExtension,
                LOANREFERENCENUMBER = rec.LOANREFERENCENUMBER,
                LOANAPPLICATIONNUMBER = rec.LOANREFERENCENUMBER,
                SYSTEMDATETIME = DateTime.Now,
                CREATEDBY = (int)model.createdBy,
                ISPRIMARYDOCUMENT = true,
                COMPANYID = model.companyId,
                LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.ContingentLiability,
                TEMPLOANREVIEWOPERATIONID = review.LOANREVIEWOPERATIONID,
                PHYSICALLOCATION = "N/A",
                DOCUMENTTYPEID = 4,

            };

            documentContext.TBL_TEMP_MEDIA_LOAN_DOCUMENTS.Add(data);
            try
            {
                return documentContext.SaveChanges() != 0;
            }
            catch (Exception ex) { }

            return documentContext.SaveChanges() != 0;
        }


        public bool SaveMainDocument(LoanReviewOperationViewModel model, int loanId, byte[] file, int loanreviewoperationId)
        {
            var rec = context.TBL_LOAN_CONTINGENT.Where(x => x.CONTINGENTLOANID == loanId).FirstOrDefault();

            var data = new TBL_TEMP_MEDIA_LOAN_DOCUMENTS
            {
                FILEDATA = file,
                DOCUMENTTITLE = model.documentTitle,
                FILENAME = model.fileName,
                FILEEXTENSION = model.fileExtension,
                LOANREFERENCENUMBER = rec.LOANREFERENCENUMBER,
                LOANAPPLICATIONNUMBER = rec.LOANREFERENCENUMBER,
                SYSTEMDATETIME = DateTime.Now,
                CREATEDBY = (int)model.createdBy,
                ISPRIMARYDOCUMENT = true,
                COMPANYID = model.companyId,
                LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.ContingentLiability,
                TEMPLOANREVIEWOPERATIONID = loanreviewoperationId,
                PHYSICALLOCATION = "N/A",
                DOCUMENTTYPEID = 4,

            };

            documentContext.TBL_TEMP_MEDIA_LOAN_DOCUMENTS.Add(data);
            try
            {
                return documentContext.SaveChanges() != 0;
            }
            catch (Exception ex) { }

            return documentContext.SaveChanges() != 0;
        }

        public bool VerifyLegalContingentCode(string legalContingentCode)
        {
            bool result = false;
            var record = (from a in context.TBL_LOAN_CONTINGENT
                          join b in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals b.LOANAPPLICATIONDETAILID
                          where a.LEGALCONTINGENTCODE == legalContingentCode
                          select a.LEGALCONTINGENTCODE
                          ).FirstOrDefault();
            if (string.IsNullOrEmpty(record))
            {
                result = false;
            }
            else
            {
                result = true;
            }
            return result;
        }


        //public bool AddOperationReviewContingentWithImage(LoanReviewOperationViewModel model)
        public bool AddOperationReviewContingentWithImage(LoanReviewOperationViewModel model, byte[] buffer)
        {
            var record = context.TBL_LOAN_CONTINGENT.Where(x => x.CONTINGENTLOANID == model.loanId).FirstOrDefault();
            //bool validatelegalContingentCode =false;
            if ((int)OperationsEnum.ContingentLiabilityRenewal == model.operationTypeId)
            {
                bool validatelegalContingentCode = VerifyLegalContingentCode(model.legalContingentCode);
                if (validatelegalContingentCode)
                {
                    throw new ConditionNotMetException("Legal Contingent Code Provided Has Been Used Before..");
                }
            }



            bool output = false;
            var reviewApplicationDetail = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == model.lmsApplicationDetailId).FirstOrDefault();

            if (model.loanReviewOperationsId == 0)
            {
                var data = new TBL_LOAN_REVIEW_OPERATION
                {
                    LOANID = model.loanId,
                    //LOANSYSTEMTYPEID = model.productTypeId,
                    LOANSYSTEMTYPEID = model.loanSystemTypeId,
                    OPERATIONTYPEID = model.operationTypeId,
                    EFFECTIVEDATE = model.proposedEffectiveDate,
                    REVIEWDETAILS = model.reviewDetails,
                    INTERATERATE = model.interateRate == null ? 0 : (double)model.interateRate,
                    PREPAYMENT = model.prepayment ?? 0,
                    PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId,
                    INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId,
                    PRINCIPALFIRSTPAYMENTDATE = model.principalFirstPaymentDate,
                    INTERESTFIRSTPAYMENTDATE = model.interestFirstPaymentDate,
                    MATURITYDATE = model.maturityDate,
                    TENOR = model.tenor,
                    CASA_ACCOUNTID = model.cASA_AccountId,
                    OVERDRAFTTOPUP = model.overDraftTopup,
                    FEE_CHARGES = model.fee_Charges,
                    APPROVALSTATUSID = model.approvalStatusId,
                    ISMANAGEMENTINTERESTRATE = model.isManagementRate,
                    SCHEDULETYPEID = model.scheduleTypeId,
                    SCHEDULEDAYINTERESTTYPEID = model.interestTypeId,
                    SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountId,
                    OPERATIONCOMPLETED = false,
                    CREATEDBY = model.createdBy,
                    DATECREATED = DateTime.Now,
                    LOANREVIEWAPPLICATIONID = model.lmsApplicationDetailId == 0 ? null : model.lmsApplicationDetailId,
                    LEGALCONTINGENTCODE = model.legalContingentCode,
                    //TBL_LOAN_REVIEW_OPRATN_IREG_SC = irregularSchedules
                };
                // Audit Section ---------------------------

                var referenceNo = context.TBL_LOAN_CONTINGENT.Where(x => x.CONTINGENTLOANID == data.LOANID).FirstOrDefault().LOANREFERENCENUMBER;

                var operationPerformed = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == model.lmsApplicationDetailId).FirstOrDefault();
                if (operationPerformed != null)
                {
                    operationPerformed.OPERATIONPERFORMED = true;
                }

                //ContingentLiabilityTermination = 86,
                //ContingentLiabilityRenewal = 85

                short _AUDITTYPEID = 0;
                string DETAIL = string.Empty;

                if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityRenewal)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityRenewal;
                    DETAIL = $"Contingent Liability Renewal Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTermination)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityTermination;
                    DETAIL = $"Contingent Liability Termination Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTenorExtension)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityTenorExtension;
                    DETAIL = $"Contingent Liability Tenor Extension Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityAmountReduction)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityAmountReduction;
                    DETAIL = $"Contingent Liability Amount Reduction Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityAmountAddition)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityAmountAddition;
                    DETAIL = $"Contingent Liability Amount Addition Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityRebook;
                    DETAIL = $"Contingent Liability Rebook Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.CancelContingentLiability)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.CancelContingentLiability;
                    DETAIL = $"Cancel Contingent Liability Approval in process for contingent: '{ referenceNo}' ";
                }
                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = _AUDITTYPEID,
                    DETAIL = DETAIL,
                    STAFFID = model.createdBy,
                    BRANCHID = model.userBranchId,
                    IPADDRESS = model.userIPAddress,
                    URL = CommonHelpers.GetLocalIpAddress(),// groupModel.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };

                //end of Audit section -----------------------
                using (var trans = context.Database.BeginTransaction())
                {
                    try
                    {
                        context.TBL_LOAN_REVIEW_OPERATION.Add(data);
                        auditTrail.AddAuditTrail(audit);
                        int status = 0;
                        try
                        {
                            output = context.SaveChanges() > 0;
                        }
                        catch (DbEntityValidationException ex)
                        {

                            string errorMessages = string.Join("; ", ex.EntityValidationErrors.SelectMany(x => x.ValidationErrors).Select(x => x.ErrorMessage));
                            throw new DbEntityValidationException(errorMessages);
                        }


                        status = (int)ApprovalStatusEnum.Pending;

                        workFlow.StaffId = model.createdBy;
                        workFlow.CompanyId = model.companyId;
                        workFlow.StatusId = status;//(int)ApprovalStatusEnum.Pending;
                        workFlow.TargetId = data.LOANREVIEWOPERATIONID;
                        workFlow.Comment = "Initiation";
                        workFlow.OperationId = model.operationTypeId;
                        workFlow.DeferredExecution = true; // false by default will call the internal SaveChanges()
                        workFlow.ExternalInitialization = true;
                        //if ((int)OperationsEnum.Prepayment != model.operationTypeId)
                        //{
                        var response = workFlow.LogActivity();
                        //}

                        //output = context.SaveChanges() > 0;


                        if (model.fees != null)
                        {
                            LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                            feeDetails.feeDetails = model.fees;
                            feeDetails.createdBy = model.createdBy;
                            feeDetails.userIPAddress = model.userIPAddress;
                            feeDetails.userBranchId = model.userBranchId;
                            feeDetails.applicationUrl = model.applicationUrl;
                            feeDetails.companyId = model.companyId;
                            feeDetails.loanOperationReviewId = data.LOANREVIEWOPERATIONID;
                            output = SubmitTakeFee(feeDetails);
                        }
                        else
                        {
                            output = context.SaveChanges() > 0;
                        }

                        if (buffer != null) { SaveMainDocument(model, data.LOANID, buffer, data.LOANREVIEWOPERATIONID); }
                        trans.Commit();


                        //if ((int)OperationsEnum.Prepayment == model.operationTypeId)
                        //{
                        //    int loanReviewOperationsId = this.context.TBL_LOAN_REVIEW_OPERATION.FirstOrDefault(x => x.LOANID == model.loanId).LOANREVIEWOPERATIONID;
                        //    LoanRephasementProcess((short)loanReviewOperationsId, model.loanId, model.createdBy);
                        //}

                        return output;


                    }

                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw ex;
                    }
                }
            }
            else
            {
                var reviewOperation = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == model.loanReviewOperationsId).FirstOrDefault();

                reviewOperation.LOANID = model.loanId;
                reviewOperation.LOANSYSTEMTYPEID = model.loanSystemTypeId;
                reviewOperation.OPERATIONTYPEID = model.operationTypeId;
                reviewOperation.EFFECTIVEDATE = model.proposedEffectiveDate;
                reviewOperation.REVIEWDETAILS = model.reviewDetails;
                reviewOperation.INTERATERATE = model.interateRate == null ? 0 : (double)model.interateRate;
                reviewOperation.PREPAYMENT = model.prepayment ?? 0;
                reviewOperation.PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId;
                reviewOperation.INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId;
                reviewOperation.PRINCIPALFIRSTPAYMENTDATE = model.principalFirstPaymentDate;
                reviewOperation.INTERESTFIRSTPAYMENTDATE = model.interestFirstPaymentDate;
                reviewOperation.MATURITYDATE = model.maturityDate;
                reviewOperation.TENOR = model.tenor;
                reviewOperation.CASA_ACCOUNTID = model.cASA_AccountId;
                reviewOperation.OVERDRAFTTOPUP = model.overDraftTopup;
                reviewOperation.FEE_CHARGES = model.fee_Charges;
                reviewOperation.APPROVALSTATUSID = model.approvalStatusId;
                reviewOperation.ISMANAGEMENTINTERESTRATE = model.isManagementRate;
                reviewOperation.SCHEDULETYPEID = model.scheduleTypeId;
                reviewOperation.SCHEDULEDAYINTERESTTYPEID = model.interestTypeId;
                reviewOperation.SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountId;
                reviewOperation.OPERATIONCOMPLETED = false;
                reviewOperation.CREATEDBY = model.createdBy;
                reviewOperation.DATECREATED = DateTime.Now;
                reviewOperation.LEGALCONTINGENTCODE = model.legalContingentCode;
                //TBL_LOAN_REVIEW_OPRATN_IREG_SC = irregularSchedules

                reviewApplicationDetail.OPERATIONPERFORMED = true;

                var referenceNo = context.TBL_LOAN_CONTINGENT.Where(x => x.CONTINGENTLOANID == reviewOperation.LOANID).FirstOrDefault().LOANREFERENCENUMBER;

                short _AUDITTYPEID = 0;
                string DETAIL = string.Empty;

                if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityRenewal)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityRenewal;
                    DETAIL = $"Contingent Liability Renewal Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTermination)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityTermination;
                    DETAIL = $"Contingent Liability Termination Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTenorExtension)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityTenorExtension;
                    DETAIL = $"Contingent Liability Tenor Extension Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityAmountReduction)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityAmountReduction;
                    DETAIL = $"Contingent Liability Amount Reduction Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityAmountAddition)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityAmountAddition;
                    DETAIL = $"Contingent Liability Amount Addition Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityRebook;
                    DETAIL = $"Contingent Liability Rebook Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.CancelContingentLiability)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.CancelContingentLiability;
                    DETAIL = $"Cancel Contingent Liability Approval in process for contingent: '{ referenceNo}' ";
                }

                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = _AUDITTYPEID,
                    DETAIL = DETAIL,
                    STAFFID = model.createdBy,
                    BRANCHID = model.userBranchId,
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = model.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };
                auditTrail.AddAuditTrail(audit);

                if (model.fees != null)
                {
                    LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                    feeDetails.feeDetails = model.fees;
                    feeDetails.createdBy = model.createdBy;
                    feeDetails.userIPAddress = model.userIPAddress;
                    feeDetails.userBranchId = model.userBranchId;
                    feeDetails.applicationUrl = model.applicationUrl;
                    feeDetails.companyId = model.companyId;
                    feeDetails.loanOperationReviewId = reviewOperation.LOANREVIEWOPERATIONID;
                    output = SubmitTakeFee(feeDetails);
                }
                else
                {
                    output = context.SaveChanges() > 0;
                }
                //output = context.SaveChanges() > 0;
                if (buffer != null) { SaveMainDocument(model, reviewOperation.LOANID, buffer, reviewOperation.LOANREVIEWOPERATIONID); }

                return output;
            }

        }

        public bool AddOperationReviewContingent(LoanReviewOperationViewModel model)
        {
            bool output = false;
            var reviewApplicationDetail = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == model.lmsApplicationDetailId).FirstOrDefault();

            if (model.proposedEffectiveDate.ToString("dd/MM/yyyy") == "01/01/0001")
            {
                model.proposedEffectiveDate = DateTime.Now;
            }
            if (model.loanReviewOperationsId == 0)
            {

                var data = new TBL_LOAN_REVIEW_OPERATION
                {
                    LOANID = model.loanId,
                    //LOANSYSTEMTYPEID = model.productTypeId,
                    LOANSYSTEMTYPEID = model.loanSystemTypeId,
                    OPERATIONTYPEID = model.operationTypeId,
                    EFFECTIVEDATE = model.proposedEffectiveDate, //generalSetup.GetApplicationDate(),
                    REVIEWDETAILS = model.reviewDetails,
                    INTERATERATE = model.interateRate == null ? 0 : (double)model.interateRate,
                    PREPAYMENT = model.prepayment ?? 0,
                    PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId,
                    INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId,
                    PRINCIPALFIRSTPAYMENTDATE = model.principalFirstPaymentDate,
                    INTERESTFIRSTPAYMENTDATE = model.interestFirstPaymentDate,
                    MATURITYDATE = model.maturityDate,
                    TENOR = model.tenor,
                    CASA_ACCOUNTID = model.cASA_AccountId,
                    OVERDRAFTTOPUP = model.overDraftTopup,
                    FEE_CHARGES = model.fee_Charges,
                    APPROVALSTATUSID = model.approvalStatusId,
                    ISMANAGEMENTINTERESTRATE = model.isManagementRate,
                    SCHEDULETYPEID = model.scheduleTypeId,
                    SCHEDULEDAYINTERESTTYPEID = model.interestTypeId,
                    SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountId,
                    OPERATIONCOMPLETED = false,
                    CREATEDBY = model.createdBy,
                    DATECREATED = DateTime.Now,
                    LOANREVIEWAPPLICATIONID = model.lmsApplicationDetailId == 0 ? null : model.lmsApplicationDetailId,
                    LEGALCONTINGENTCODE = model.legalContingentCode,
                    CONTINGENTOUTSTANDINGPRINCIPAL = model.rebookAmount,
                    //TBL_LOAN_REVIEW_OPRATN_IREG_SC = irregularSchedules
                };
                // Audit Section ---------------------------

                var referenceNo = context.TBL_LOAN_CONTINGENT.Where(x => x.CONTINGENTLOANID == data.LOANID).FirstOrDefault().LOANREFERENCENUMBER;

                var operationPerformed = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == model.lmsApplicationDetailId).FirstOrDefault();
                if (operationPerformed != null)
                {
                    operationPerformed.OPERATIONPERFORMED = true;
                }

                //ContingentLiabilityTermination = 86,
                //ContingentLiabilityRenewal = 85

                short _AUDITTYPEID = 0;
                string DETAIL = string.Empty;

                if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityRenewal)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityRenewal;
                    DETAIL = $"Contingent Liability Renewal Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTermination)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityTermination;
                    DETAIL = $"Contingent Liability Termination Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTenorExtension)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityTenorExtension;
                    DETAIL = $"Contingent Liability Tenor Extension Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityAmountReduction)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityAmountReduction;
                    DETAIL = $"Contingent Liability Amount Reduction Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityAmountAddition)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityAmountAddition;
                    DETAIL = $"Contingent Liability Amount Addition Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityRebook;
                    DETAIL = $"Contingent Liability Rebook Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.CancelContingentLiability)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.CancelContingentLiability;
                    DETAIL = $"Cancel Contingent Liability Approval in process for contingent: '{ referenceNo}' ";
                }
                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = _AUDITTYPEID,
                    DETAIL = DETAIL,
                    STAFFID = model.createdBy,
                    BRANCHID = model.userBranchId,
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = model.applicationUrl,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName(),
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now
                };

                //end of Audit section -----------------------
                using (var trans = context.Database.BeginTransaction())
                {
                    try
                    {
                        context.TBL_LOAN_REVIEW_OPERATION.Add(data);
                        auditTrail.AddAuditTrail(audit);
                        int status = 0;
                        try
                        {
                            output = context.SaveChanges() > 0;
                        }
                        catch (DbEntityValidationException ex)
                        {

                            string errorMessages = string.Join("; ", ex.EntityValidationErrors.SelectMany(x => x.ValidationErrors).Select(x => x.ErrorMessage));
                            throw new DbEntityValidationException(errorMessages);
                        }


                        status = (int)ApprovalStatusEnum.Pending;

                        workFlow.StaffId = model.createdBy;
                        workFlow.CompanyId = model.companyId;
                        workFlow.StatusId = status;//(int)ApprovalStatusEnum.Pending;
                        workFlow.TargetId = data.LOANREVIEWOPERATIONID;
                        workFlow.Comment = "Initiation";
                        workFlow.OperationId = model.operationTypeId;
                        workFlow.DeferredExecution = true; // false by default will call the internal SaveChanges()
                        workFlow.ExternalInitialization = true;
                        //if ((int)OperationsEnum.Prepayment != model.operationTypeId)
                        //{
                        var response = workFlow.LogActivity();
                        //}

                        //output = context.SaveChanges() > 0;


                        if (model.fees != null)
                        {
                            LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                            feeDetails.feeDetails = model.fees;
                            feeDetails.createdBy = model.createdBy;
                            feeDetails.userIPAddress = model.userIPAddress;
                            feeDetails.userBranchId = model.userBranchId;
                            feeDetails.applicationUrl = model.applicationUrl;
                            feeDetails.companyId = model.companyId;
                            feeDetails.loanOperationReviewId = data.LOANREVIEWOPERATIONID;
                            output = SubmitTakeFee(feeDetails);
                        }
                        else
                        {
                            output = context.SaveChanges() > 0;
                        }


                        trans.Commit();


                        //if ((int)OperationsEnum.Prepayment == model.operationTypeId)
                        //{
                        //    int loanReviewOperationsId = this.context.TBL_LOAN_REVIEW_OPERATION.FirstOrDefault(x => x.LOANID == model.loanId).LOANREVIEWOPERATIONID;
                        //    LoanRephasementProcess((short)loanReviewOperationsId, model.loanId, model.createdBy);
                        //}

                        return output;


                    }

                    catch (Exception ex)
                    {
                        trans.Rollback();
                        throw ex;
                    }
                }
            }
            else
            {
                var reviewOperation = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANREVIEWOPERATIONID == model.loanReviewOperationsId).FirstOrDefault();

                reviewOperation.LOANID = model.loanId;
                reviewOperation.LOANSYSTEMTYPEID = model.loanSystemTypeId;
                reviewOperation.OPERATIONTYPEID = model.operationTypeId;
                reviewOperation.EFFECTIVEDATE = model.proposedEffectiveDate;
                reviewOperation.REVIEWDETAILS = model.reviewDetails;
                reviewOperation.INTERATERATE = model.interateRate == null ? 0 : (double)model.interateRate;
                reviewOperation.PREPAYMENT = model.prepayment ?? 0;
                reviewOperation.PRINCIPALFREQUENCYTYPEID = model.principalFrequencyTypeId;
                reviewOperation.INTERESTFREQUENCYTYPEID = model.interestFrequencyTypeId;
                reviewOperation.PRINCIPALFIRSTPAYMENTDATE = model.principalFirstPaymentDate;
                reviewOperation.INTERESTFIRSTPAYMENTDATE = model.interestFirstPaymentDate;
                reviewOperation.MATURITYDATE = model.maturityDate;
                reviewOperation.TENOR = model.tenor;
                reviewOperation.CASA_ACCOUNTID = model.cASA_AccountId;
                reviewOperation.OVERDRAFTTOPUP = model.overDraftTopup;
                reviewOperation.FEE_CHARGES = model.fee_Charges;
                reviewOperation.APPROVALSTATUSID = model.approvalStatusId;
                reviewOperation.ISMANAGEMENTINTERESTRATE = model.isManagementRate;
                reviewOperation.SCHEDULETYPEID = model.scheduleTypeId;
                reviewOperation.SCHEDULEDAYINTERESTTYPEID = model.interestTypeId;
                reviewOperation.SCHEDULEDAYCOUNTCONVENTIONID = model.scheduleDayCountId;
                reviewOperation.OPERATIONCOMPLETED = false;
                reviewOperation.CREATEDBY = model.createdBy;
                reviewOperation.DATECREATED = DateTime.Now;
                reviewOperation.LEGALCONTINGENTCODE = model.legalContingentCode;
                reviewOperation.CONTINGENTOUTSTANDINGPRINCIPAL = model.rebookAmount;
                //TBL_LOAN_REVIEW_OPRATN_IREG_SC = irregularSchedules

                reviewApplicationDetail.OPERATIONPERFORMED = true;

                var referenceNo = context.TBL_LOAN_CONTINGENT.Where(x => x.CONTINGENTLOANID == reviewOperation.LOANID).FirstOrDefault().LOANREFERENCENUMBER;

                short _AUDITTYPEID = 0;
                string DETAIL = string.Empty;

                if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityRenewal)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityRenewal;
                    DETAIL = $"Contingent Liability Renewal Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTermination)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityTermination;
                    DETAIL = $"Contingent Liability Termination Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTenorExtension)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityTenorExtension;
                    DETAIL = $"Contingent Liability Tenor Extension Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityAmountReduction)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityAmountReduction;
                    DETAIL = $"Contingent Liability Amount Reduction Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityAmountAddition)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityAmountAddition;
                    DETAIL = $"Contingent Liability Amount Addition Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.ContingentLiabilityRebook;
                    DETAIL = $"Contingent Liability Rebook Approval in process for contingent: '{ referenceNo}' ";
                }
                else if (model.operationTypeId == (int)OperationsEnum.CancelContingentLiability)
                {
                    _AUDITTYPEID = (short)AuditTypeEnum.CancelContingentLiability;
                    DETAIL = $"Cancel Contingent Liability Approval in process for contingent: '{ referenceNo}' ";
                }

                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = _AUDITTYPEID,
                    DETAIL = DETAIL,
                    STAFFID = model.createdBy,
                    BRANCHID = model.userBranchId,
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = model.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                };
                auditTrail.AddAuditTrail(audit);

                if (model.fees != null)
                {
                    LoanFeeChargesViewModel feeDetails = new LoanFeeChargesViewModel();

                    feeDetails.feeDetails = model.fees;
                    feeDetails.createdBy = model.createdBy;
                    feeDetails.userIPAddress = model.userIPAddress;
                    feeDetails.userBranchId = model.userBranchId;
                    feeDetails.applicationUrl = model.applicationUrl;
                    feeDetails.companyId = model.companyId;
                    feeDetails.loanOperationReviewId = reviewOperation.LOANREVIEWOPERATIONID;
                    output = SubmitTakeFee(feeDetails);
                }
                else
                {
                    output = context.SaveChanges() > 0;
                }
                //output = context.SaveChanges() > 0;

                return output;
            }

        }



        #endregion END OF COMMERCIAL PAPER

        #region Flow Type For Custom Facility Repayment Report
        public List<ItemValue> FlowTypes()
        {
            BulkTransactionPosting flow = new BulkTransactionPosting();
            return flow.GetFlowTypes();
        }

        #endregion

        public bool SendEmailToRecoveryAgent(int companyId, int staffId, short branchId, int accreditedConsultantId)
        {
            var messageBody = "A recovery email";
            var subject = "RECOVERY EMAIL";
            if (accreditedConsultantId == 0) return false;

            var data = consultant.GetAccreditedConsultants(companyId, accreditedConsultantId);
            if (data == null) return false;

            var email = (from m in context.TBL_ACCREDITEDCONSULTANT
                         where m.COMPANYID == companyId && m.ACCREDITEDCONSULTANTID == accreditedConsultantId
                         select new { m.EMAILADDRESS }).FirstOrDefault();

            var emailLog = new TBL_MESSAGE_LOG
            {
                DATETIMERECEIVED = DateTime.Now,
                FROMADDRESS = email.EMAILADDRESS,
                TOADDRESS = email.EMAILADDRESS,
                MESSAGEBODY = messageBody,
                MESSAGESUBJECT = subject,
                MESSAGESTATUSID = 1,
                MESSAGETYPEID = 1,
                OPERATIONID = (int)OperationsEnum.LoanRecovery,
                SENDONDATETIME = DateTime.Now,

            };

            context.TBL_MESSAGE_LOG.Add(emailLog);


            auditTrail.AddAuditTrail(new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.LoanDocumentAdded,
                STAFFID = staffId,
                BRANCHID = branchId,
                DETAIL = $"A recovery Email has been sent to accredited consultant with consultantId  '{ accreditedConsultantId}' ",
                // IPADDRESS = model.userIPAddress,
                //URL = model.applicationUrl,
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName()
            });

            if (context.SaveChanges() > 0) return true;

            return false;
        }

        public IEnumerable<LoanReviewIrregularScheduleViewModel> GetLoanReviewOperationIrregularSchedule(int loanReviewOperationId)
        {
            return context.TBL_LOAN_REVIEW_OPRATN_IREG_SC.Where(x => x.LOANREVIEWOPERATIONID == loanReviewOperationId)
                .Select(c => new LoanReviewIrregularScheduleViewModel
                {
                    PaymentDate = c.PAYMENTDATE,
                    PaymentAmount = c.PAYMENTAMOUNT
                })
                .ToList();
        }

        private UserCurrencyViewFilter GetUserCurrencyViewFilter(int companyId, int userId)
        {
            UserCurrencyViewFilter result = new UserCurrencyViewFilter();
            result.DefaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == userId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            //var activities = admin.GetUserActivitiesByUser(userId);
            result.CanSeeLocalCurrency = activities.Contains("lcy-user");
            result.CanSeeForeignCurrency = activities.Contains("fcy-user");
            return result;
        }

        public bool UpdateLoanClassification(DateTime applicationDate, int companyId, int staffId)
        {

            bool result = false;

            try
            {
                var loans = context.TBL_LOAN.Where(x => x.PASTDUEDATE != null && x.LOANSTATUSID == (short)LoanStatusEnum.Active && x.COMPANYID == companyId).ToList();


                var eod_Operation_Log = context.TBL_EOD_OPERATION_LOG.Where(c => c.EODDATE == applicationDate && c.EODOPERATIONID == (int)EodOperationEnum.UpdateLoanClassification && c.COMPANYID == companyId).FirstOrDefault();


                List<TBL_EOD_OPERATION_LOG_DETAIL> eod_operation_Detail_List = new List<TBL_EOD_OPERATION_LOG_DETAIL>();

                if (loans.Count() != 0)
                {
                    var eodOperations = context.TBL_EOD_OPERATION.OrderBy(x => x.POSITION).ToList();

                    foreach (TBL_LOAN loan in loans)
                    {

                        TBL_EOD_OPERATION_LOG_DETAIL eod_operation_Detail = new TBL_EOD_OPERATION_LOG_DETAIL();

                        var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFERENCENUMBER == loan.LOANREFERENCENUMBER && c.EODDATE == applicationDate && c.EODOPERATIONID == (int)EodOperationEnum.UpdateLoanClassification).FirstOrDefault();

                        if (checkExistence == null)
                        {
                            eod_operation_Detail.EODOPERATIONLOGID = eod_Operation_Log.EODOPERATIONLOGID;
                            eod_operation_Detail.EODSTATUSID = (int)EodOperationStatusEnum.Processing;
                            eod_operation_Detail.EODOPERATIONID = (int)EodOperationEnum.UpdateLoanClassification;
                            eod_operation_Detail.REFERENCENUMBER = loan.LOANREFERENCENUMBER;
                            eod_operation_Detail.EODDATE = applicationDate;
                            eod_operation_Detail.EODUSERID = staffId;
                            eod_operation_Detail_List.Add(eod_operation_Detail);

                        }

                    }

                    context.TBL_EOD_OPERATION_LOG_DETAIL.AddRange(eod_operation_Detail_List);

                    context.SaveChanges();

                }



                int dateDiff = 0;

                foreach (TBL_LOAN table in loans)
                {


                    var checkExistence = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFERENCENUMBER == table.LOANREFERENCENUMBER && c.EODDATE == applicationDate && c.EODSTATUSID != (int)EodOperationStatusEnum.Completed && c.EODOPERATIONID == (int)EodOperationEnum.UpdateLoanClassification).FirstOrDefault();

                    if (checkExistence != null)
                    {

                        var eod_Operation_Log_Detail_Set_Value = context.TBL_EOD_OPERATION_LOG_DETAIL.Where(c => c.REFERENCENUMBER == table.LOANREFERENCENUMBER && c.EODDATE == applicationDate && c.EODOPERATIONID == (int)EodOperationEnum.UpdateLoanClassification).FirstOrDefault();

                        eod_Operation_Log_Detail_Set_Value.STARTDATETIME = DateTime.Now;
                        eod_Operation_Log_Detail_Set_Value.EODUSERID = staffId;

                        context.SaveChanges();

                        try
                        {


                            _transactionReferenceNo = table.LOANREFERENCENUMBER;

                            dateDiff = (applicationDate - (DateTime)table.PASTDUEDATE).Days;

                            var prudExternal = context.TBL_LOAN_PRUDENTIALGUIDELINE.Where(x => dateDiff >= x.EXTERNALMINIMUM && dateDiff <= x.EXTERNALMAXIMUM).FirstOrDefault();

                            if (prudExternal != null)
                            {
                                table.EXT_PRUDENT_GUIDELINE_STATUSID = prudExternal.PRUDENTIALGUIDELINESTATUSID;
                            }

                            var prudInternal = context.TBL_LOAN_PRUDENTIALGUIDELINE.Where(x => dateDiff >= x.INTERNALMINIMUM && dateDiff <= x.INTERNALMAXIMUM).FirstOrDefault();

                            if (prudInternal != null)
                            {
                                table.INT_PRUDENT_GUIDELINE_STATUSID = prudInternal.PRUDENTIALGUIDELINESTATUSID;
                            }

                            eod_Operation_Log_Detail_Set_Value.ENDDATETIME = DateTime.Now;
                            eod_Operation_Log_Detail_Set_Value.EODSTATUSID = (int)EodOperationStatusEnum.Completed;
                            eod_Operation_Log_Detail_Set_Value.EODUSERID = staffId;
                            eod_Operation_Log_Detail_Set_Value.ERRORINFORMATION = "No Error";
                            context.SaveChanges();

                        }
                        catch (Exception ex)
                        {

                            eod_Operation_Log_Detail_Set_Value.ENDDATETIME = DateTime.Now;
                            eod_Operation_Log_Detail_Set_Value.EODSTATUSID = (int)EodOperationStatusEnum.Error;
                            eod_Operation_Log_Detail_Set_Value.EODUSERID = staffId;
                            eod_Operation_Log_Detail_Set_Value.ERRORINFORMATION = $"Ref No - {table.LOANREFERENCENUMBER} Exception - {ex.Message}  - inner exception -  {ex.InnerException}";
                            context.SaveChanges();
                        }


                    }


                }

                context.SaveChanges();

                result = true;

            }
            catch (Exception ex)
            {

                result = false;
                throw ex;

            }


            return result;
        }

        public bool UpdateLoanClassification(DateTime applicationDate, int companyId)
        {

            bool result = false;

            try
            {
                var loans = context.TBL_LOAN.Where(x => x.PASTDUEDATE != null && x.LOANSTATUSID == (short)LoanStatusEnum.Active && x.COMPANYID == companyId).ToList();

                int dateDiff = 0;

                foreach (TBL_LOAN table in loans)
                {



                    _transactionReferenceNo = table.LOANREFERENCENUMBER;

                    dateDiff = (applicationDate - (DateTime)table.PASTDUEDATE).Days;

                    var prudExternal = context.TBL_LOAN_PRUDENTIALGUIDELINE.Where(x => dateDiff >= x.EXTERNALMINIMUM && dateDiff <= x.EXTERNALMAXIMUM).FirstOrDefault();

                    if (prudExternal != null)
                    {
                        table.EXT_PRUDENT_GUIDELINE_STATUSID = prudExternal.PRUDENTIALGUIDELINESTATUSID;
                    }

                    var prudInternal = context.TBL_LOAN_PRUDENTIALGUIDELINE.Where(x => dateDiff >= x.INTERNALMINIMUM && dateDiff <= x.INTERNALMAXIMUM).FirstOrDefault();

                    if (prudInternal != null)
                    {
                        table.INT_PRUDENT_GUIDELINE_STATUSID = prudInternal.PRUDENTIALGUIDELINESTATUSID;
                    }


                }

                context.SaveChanges();

                result = true;

            }
            catch (Exception ex)
            {

                result = false;
                throw ex;

            }


            return result;
        }

        public bool DailyWrittenOffFacilityAccrual(DateTime applicationDate, int companyId, int staffId)
        {

            try
            {
                bool result = false;


                var currencyRate = (from a in context.TBL_LOAN
                                    where a.LOANSTATUSID == (short)LoanStatusEnum.WriteOff && a.COMPANYID == companyId
                                    select new CurrencyExchangeRateViewModel()
                                    {
                                        currencyId = a.CURRENCYID,
                                        companyId = a.COMPANYID,
                                    }).ToList().Distinct().Select(x =>
                                    {
                                        x.sellingRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, (int)x.companyId).sellingRate;
                                        return x;
                                    }).ToList();


                var scheduledLoan = (from b in context.TBL_LOAN
                                     join e in context.TBL_PRODUCT on b.PRODUCTID equals e.PRODUCTID
                                     join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
                                     join g in context.TBL_LOAN_CAMSOL on b.TERMLOANID equals g.LOANID
                                     where b.LOANSTATUSID == (short)LoanStatusEnum.WriteOff && g.CAMSOLTYPEID == (int)CamsolTypeEnum.Camsol && b.COMPANYID == companyId
                                     select new DailyInterestAccrualViewModel()
                                     {
                                         loanId = b.TERMLOANID,
                                         referenceNumber = b.LOANREFERENCENUMBER,
                                         productId = b.PRODUCTID,
                                         branchId = b.BRANCHID,
                                         companyId = b.COMPANYID,
                                         currencyId = b.CURRENCYID,
                                         interestRate = (double)e.WRITEOFFRATE,
                                         date = applicationDate,
                                         mainAmount = g.BALANCE, //a.STARTPRINCIPALAMOUNT,
                                         categoryId = (short)DailyAccrualCategory.WrittenOffTermLoanInterestAccural,
                                         transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                                         baseReferenceNumber = null,
                                         dayCountConventionId = b.SCHEDULEDAYCOUNTCONVENTIONID,

                                     }).ToList().Select(x =>
                                     {
                                         //x.exchangeRate = financeTransaction.GetExchangeRate(applicationDate, x.currencyId, x.companyId).sellingRate;
                                         x.exchangeRate = currencyRate.Where(m => m.currencyId == x.currencyId).Select(m => m.sellingRate).FirstOrDefault();
                                         x.dailyAccuralAmount = ((x.interestRate / 100) * (double)x.mainAmount * (1 / (double)loanSchedule.GetDaysInAYear((DayCountConventionEnum)x.dayCountConventionId)));
                                         return x;
                                     });


                var allLoans = scheduledLoan.ToList().Where(x => x.dailyAccuralAmount > 0);

                List<TBL_DAILY_ACCRUAL> allAccrual = new List<TBL_DAILY_ACCRUAL>();


                foreach (var item in allLoans)
                {
                    _transactionReferenceNo = item.referenceNumber;

                    TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                    dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                    dailyAccrual.PRODUCTID = item.productId;
                    dailyAccrual.BRANCHID = item.branchId;
                    dailyAccrual.EXCHANGERATE = item.exchangeRate;
                    dailyAccrual.CURRENCYID = item.currencyId;
                    dailyAccrual.INTERESTRATE = item.interestRate;
                    dailyAccrual.DATE = item.date;
                    dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs(item.dailyAccuralAmount);
                    dailyAccrual.MAINAMOUNT = item.mainAmount;
                    dailyAccrual.CATEGORYID = item.categoryId;
                    dailyAccrual.COMPANYID = item.companyId;
                    dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
                    dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
                    dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;


                    allAccrual.Add(dailyAccrual);

                    var camsol = context.TBL_LOAN_CAMSOL.Where(c => c.LOANID == item.loanId && c.COMPANYID == companyId).FirstOrDefault();
                    camsol.WRITTENOFFACCRUALAMOUNT = camsol.WRITTENOFFACCRUALAMOUNT + (decimal)item.dailyAccuralAmount;
                    context.SaveChanges();

                }
                this.context.TBL_DAILY_ACCRUAL.AddRange(allAccrual);
                context.SaveChanges();


                var model = (from a in context.TBL_DAILY_ACCRUAL
                             join b in context.TBL_PRODUCT on a.PRODUCTID equals b.PRODUCTID
                             join c in context.TBL_BRANCH on a.BRANCHID equals c.BRANCHID
                             join d in context.TBL_CURRENCY on a.CURRENCYID equals d.CURRENCYID
                             where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.WrittenOffTermLoanInterestAccural && a.COMPANYID == companyId
                             group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, b.PRODUCTCODE, c.BRANCHCODE, d.CURRENCYCODE, a.CATEGORYID, a.EXCHANGERATE, a.REFERENCENUMBER } into groupedQ
                             select new DailyInterestAccrualViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 categoryId = groupedQ.Key.CATEGORYID,
                                 productCode = groupedQ.Key.PRODUCTCODE,
                                 currencyCode = groupedQ.Key.CURRENCYCODE,
                                 branchCode = groupedQ.Key.BRANCHCODE,
                                 exchangeRate = groupedQ.Key.EXCHANGERATE,
                                 referenceNumber = groupedQ.Key.REFERENCENUMBER,

                                 dailyAccuralAmount = (double)groupedQ.Sum(i => (double)i.DAILYACCURALAMOUNT * i.EXCHANGERATE),

                             }).ToList();
                //.Select(x =>
                //{
                //    x.referenceNumber = x.productCode + '/' + x.currencyCode + '/' + x.branchCode + '/' + x.companyId.ToString() + '/' + x.categoryId.ToString();
                //    return x;
                //}).ToList();

                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                if (setup.USE_THIRD_PARTY_INTEGRATION)
                {
                    BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                    result = bulkPosting.WriteBulkDailyWrittenOffFacilityAccrualToStaging(model, context, stagingContext, finacle, financeTransaction, applicationDate, companyId, staffId, out _transactionReferenceNo);

                }
                else
                {
                    foreach (var item in model)
                    {
                        item.date = applicationDate;

                        result = financeTransaction.PostDailyWriteoffLoansInterestAccrual(item);
                    }
                }

                if (result)
                {
                    return result;
                }
                return false;

                //result = true;

                //return result;
            }
            catch (Exception ex)
            {

                throw ex;

            }

        }

        public bool GetRepaymentDate(int loanId)
        {

            var applicationDate = generalSetup.GetApplicationDate();

            var repamentPeriod = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.PAYMENTDATE == applicationDate && x.LOANID == loanId).FirstOrDefault();

            if (repamentPeriod != null)
            {
                return true;
            }

            return false;
        }


        public IEnumerable<LoanReviewOperationApprovalViewModel> GetLoanOperationDocumentation(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);

            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONTYPEID == (short)OperationTypeEnum.LoanManagement).Select(c => c.OPERATIONID).ToList();
            List<int> levelIds = new List<int>();

            foreach (var operationId in operationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }


            var company = context.TBL_COMPANY.Find(companyId);

            var dataLoan = (from ln in context.TBL_LOAN
                            join op in context.TBL_LOAN_REVIEW_OPERATION on ln.TERMLOANID equals op.LOANID
                            join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            lp.COMPANYID == companyId
                            && lp.DELETED == false
                            && ln.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                            && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && op.ISPRINTED == false
                            && op.OPERATIONCOMPLETED == true
                            && (ln.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                            && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && atrail.APPROVALSTATUSID != (short)ApprovalStatusEnum.Finishing && !levelIds.Contains((int)atrail.TOAPPROVALLEVELID)
                            || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing && levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && operationIds.Contains(atrail.OPERATIONID)))

                            orderby op.DATECREATED descending
                            select new LoanReviewOperationApprovalViewModel
                            {
                                arrivalDate = atrail.SYSTEMARRIVALDATETIME,
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                prepaymentAmount = op.PREPAYMENT,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                amount = ld.APPROVEDAMOUNT,
                                lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                  join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                  where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                  select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = op.APPROVALSTATUSID,
                                approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == ln.TERMLOANID && d.MODULE.ToLower() == "lms").Select(d => d.LOANID).FirstOrDefault(),
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                productAccountNumber = ch.ACCOUNTCODE,
                                productAccountName = ch.ACCOUNTNAME,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                operationTypeId = op.OPERATIONTYPEID,
                                operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                newEffectiveDate = op.EFFECTIVEDATE,
                                reviewDetails = op.REVIEWDETAILS,
                                prepayment = op.PREPAYMENT,
                                newInterateRate = op.INTERATERATE,
                                newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newTenor = op.TENOR,
                                cASA_AccountId = op.CASA_ACCOUNTID,
                                cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                overDraftTopup = op.OVERDRAFTTOPUP,
                                fee_Charges = op.FEE_CHARGES,
                                scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                newMaturityDate = op.MATURITYDATE,
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                dateTimeCreated = op.DATECREATED,
                                fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                {
                                    chargeFeeId = mp.CHARGEFEEID,
                                    feeAmount = mp.FEEAMOUNT,
                                    description = mp.DESCRIPTION,
                                    casaAccount = mp.CASAACCOUNTID,
                                    loanChargeFeeId = mp.LOANCHARGEFEEID,
                                    chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                    casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                }).ToList(),
                            }).ToList().Take(50);

            var dataRevolvingLoan = (from ln in context.TBL_LOAN_REVOLVING
                                     join op in context.TBL_LOAN_REVIEW_OPERATION on ln.REVOLVINGLOANID equals op.LOANID
                                     join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                     join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where lp.COMPANYID == companyId
                                        && lp.DELETED == false
                                        && ln.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                        && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                        && op.ISPRINTED == false
                                        && op.OPERATIONCOMPLETED == true
                                        && (ln.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                        && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && atrail.APPROVALSTATUSID != (short)ApprovalStatusEnum.Finishing && !levelIds.Contains((int)atrail.TOAPPROVALLEVELID)
                                        || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing && levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && operationIds.Contains(atrail.OPERATIONID)))


                                     orderby op.DATECREATED descending
                                     select new LoanReviewOperationApprovalViewModel
                                     {
                                         arrivalDate = atrail.SYSTEMARRIVALDATETIME,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                         lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                         loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                         appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                         customerId = ln.CUSTOMERID,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         prepaymentAmount = op.PREPAYMENT,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                           join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                           where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                           select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                         divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == ln.REVOLVINGLOANID && d.MODULE.ToLower() == "lms").Select(d => d.LOANID).FirstOrDefault(),
                                         approvalStatusId = op.APPROVALSTATUSID,
                                         approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         operationTypeId = op.OPERATIONTYPEID,
                                         operationTypeName = tt.OPERATIONNAME,
                                         newEffectiveDate = op.EFFECTIVEDATE,
                                         reviewDetails = op.REVIEWDETAILS,
                                         prepayment = op.PREPAYMENT,
                                         newInterateRate = op.INTERATERATE,
                                         newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                         newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                         newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                         newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newTenor = op.TENOR,
                                         cASA_AccountId = op.CASA_ACCOUNTID,
                                         cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         overDraftTopup = op.OVERDRAFTTOPUP,
                                         fee_Charges = op.FEE_CHARGES,
                                         scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                         scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                         scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                         scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                         scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                         newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                         newMaturityDate = op.MATURITYDATE,
                                         dateTimeCreated = op.DATECREATED,
                                         lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                         currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                         productAccountNumber = "N/A",
                                         productAccountName = "N/A",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                         fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                         {
                                             chargeFeeId = mp.CHARGEFEEID,
                                             feeAmount = mp.FEEAMOUNT,
                                             description = mp.DESCRIPTION,
                                             casaAccount = mp.CASAACCOUNTID,
                                             loanChargeFeeId = mp.LOANCHARGEFEEID,
                                             chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                             casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                         }).ToList(),
                                     }).ToList().Take(50);


            var dataContingentLoan = (from ln in context.TBL_LOAN_CONTINGENT
                                      join op in context.TBL_LOAN_REVIEW_OPERATION on ln.CONTINGENTLOANID equals op.LOANID
                                      join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                      join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                      join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                      join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                      join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                      join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                      join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                      join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                      join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                      join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                      join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                                      where lp.COMPANYID == companyId
                                        && lp.DELETED == false
                                        && ln.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                        && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                        && op.ISPRINTED == false
                                        && op.OPERATIONCOMPLETED == true
                                        && (ln.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                        && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && atrail.APPROVALSTATUSID != (short)ApprovalStatusEnum.Finishing && !levelIds.Contains((int)atrail.TOAPPROVALLEVELID)
                                        || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing && levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && operationIds.Contains(atrail.OPERATIONID)))

                                      orderby op.DATECREATED descending
                                      select new LoanReviewOperationApprovalViewModel
                                      {
                                          arrivalDate = atrail.SYSTEMARRIVALDATETIME,
                                          creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                          creditAppraisalOperationId = lp.OPERATIONID,
                                          lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                          lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                          loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                          appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                          loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                          loanId = ln.CONTINGENTLOANID,
                                          loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                          customerId = ln.CUSTOMERID,
                                          productId = ln.PRODUCTID,
                                          productTypeId = pr.PRODUCTTYPEID,
                                          productTypeName = context.TBL_PRODUCT_TYPE.Where(x => x.PRODUCTTYPEID == pr.PRODUCTTYPEID).Select(m => m.PRODUCTTYPENAME).FirstOrDefault(),
                                          casaAccountId = ln.CASAACCOUNTID,
                                          casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          branchId = ln.BRANCHID,
                                          lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                            join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                            where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                            select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                          loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                          applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                          relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                          relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                          misCode = ln.MISCODE,
                                          teamMiscode = ln.TEAMMISCODE,
                                          principalAmount = ln.CONTINGENTAMOUNT,
                                          //interestRate = ln.INTERESTRATE,
                                          flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == ln.CONTINGENTLOANID && d.MODULE.ToLower() == "lms").Select(d => d.LOANID).FirstOrDefault(),
                                          effectiveDate = ln.EFFECTIVEDATE,
                                          maturityDate = ln.MATURITYDATE,
                                          bookingDate = ln.BOOKINGDATE,
                                          approvalStatusId = op.APPROVALSTATUSID,
                                          approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                          approvedBy = (int)ln.APPROVEDBY,
                                          approverComment = ln.APPROVERCOMMENT,
                                          dateApproved = ln.DATEAPPROVED,
                                          loanStatusId = ln.LOANSTATUSID,
                                          divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                          divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                          isDisbursed = ln.ISDISBURSED,
                                          disburserComment = ln.DISBURSERCOMMENT,
                                          disburseDate = ln.DISBURSEDATE,
                                          customerGroupId = lp.CUSTOMERGROUPID,
                                          operationId = ln.OPERATIONID,
                                          loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                          subSectorId = ln.SUBSECTORID,
                                          subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                          sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                          dischargeLetter = ln.DISCHARGELETTER,
                                          //suspendInterest = ln.SUSPENDINTEREST,
                                          customerCode = cu.CUSTOMERCODE,
                                          loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                          customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                          currencyId = ln.CURRENCYID,
                                          currency = context.TBL_CURRENCY.Where(x => x.CURRENCYID == ln.CURRENCYID).Select(x => x.CURRENCYNAME).FirstOrDefault(),
                                          branchName = br.BRANCHNAME,
                                          relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                          relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                          productName = pr.PRODUCTNAME,
                                          comment = "",
                                          operationTypeId = op.OPERATIONTYPEID,
                                          operationTypeName = tt.OPERATIONNAME,
                                          newEffectiveDate = op.EFFECTIVEDATE,
                                          reviewDetails = op.REVIEWDETAILS,
                                          prepayment = op.PREPAYMENT,
                                          newInterateRate = op.INTERATERATE,
                                          newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                          newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                          newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                          newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newTenor = op.TENOR,
                                          cASA_AccountId = op.CASA_ACCOUNTID,
                                          cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          overDraftTopup = op.OVERDRAFTTOPUP,
                                          fee_Charges = op.FEE_CHARGES,
                                          scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                          scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                          scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                          scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                          scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                          newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                          newMaturityDate = op.MATURITYDATE,
                                          lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                          dateTimeCreated = op.DATECREATED,
                                          currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                          productAccountNumber = ch.ACCOUNTCODE,
                                          productAccountName = ch.ACCOUNTNAME,
                                          prepaymentAmount = op.PREPAYMENT,
                                          approvedAmount = ld.APPROVEDAMOUNT,
                                          creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                          fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                          {
                                              chargeFeeId = mp.CHARGEFEEID,
                                              feeAmount = mp.FEEAMOUNT,
                                              description = mp.DESCRIPTION,
                                              casaAccount = mp.CASAACCOUNTID,
                                              loanChargeFeeId = mp.LOANCHARGEFEEID,
                                              chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                              casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                          }).ToList(),
                                      }).ToList().Take(50);

            var termLoanData = dataLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var contingentLoanData = dataContingentLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var unionAll = termLoanData.Union(revolvingLoanData);

            var data = unionAll.Union(contingentLoanData);


            return data;
        }


        public IEnumerable<LoanReviewOperationApprovalViewModel> GetLoanOperationDocumentationSearch(int staffId, int companyId, string searchString)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);

            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONTYPEID == (short)OperationTypeEnum.LoanManagement).Select(c => c.OPERATIONID).ToList();
            List<int> levelIds = new List<int>();

            foreach (var operationId in operationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }


            var company = context.TBL_COMPANY.Find(companyId);

            var dataLoan = (from ln in context.TBL_LOAN
                            join op in context.TBL_LOAN_REVIEW_OPERATION on ln.TERMLOANID equals op.LOANID
                            join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            lp.COMPANYID == companyId
                            && (cu.FIRSTNAME.ToLower() == searchString.Trim().ToLower()
                            || cu.MIDDLENAME.ToLower() == searchString.Trim().ToLower()
                            || cu.LASTNAME.ToLower() == searchString.Trim().ToLower()
                            || st.STAFFCODE == searchString.Trim())
                            && lp.DELETED == false
                            && ln.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                            && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && op.ISPRINTED == false
                            && op.OPERATIONCOMPLETED == true
                            && (ln.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                            && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && atrail.APPROVALSTATUSID != (short)ApprovalStatusEnum.Finishing && !levelIds.Contains((int)atrail.TOAPPROVALLEVELID)
                            || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing && levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && operationIds.Contains(atrail.OPERATIONID)))

                            orderby op.DATECREATED descending
                            select new LoanReviewOperationApprovalViewModel
                            {
                                arrivalDate = atrail.SYSTEMARRIVALDATETIME,
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                prepaymentAmount = op.PREPAYMENT,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                amount = ld.APPROVEDAMOUNT,
                                lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                  join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                  where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                  select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = op.APPROVALSTATUSID,
                                approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == ln.TERMLOANID && d.MODULE.ToLower() == "lms").Select(d => d.LOANID).FirstOrDefault(),
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                productAccountNumber = ch.ACCOUNTCODE,
                                productAccountName = ch.ACCOUNTNAME,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                operationTypeId = op.OPERATIONTYPEID,
                                operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                newEffectiveDate = op.EFFECTIVEDATE,
                                reviewDetails = op.REVIEWDETAILS,
                                prepayment = op.PREPAYMENT,
                                newInterateRate = op.INTERATERATE,
                                newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newTenor = op.TENOR,
                                cASA_AccountId = op.CASA_ACCOUNTID,
                                cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                overDraftTopup = op.OVERDRAFTTOPUP,
                                fee_Charges = op.FEE_CHARGES,
                                scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                newMaturityDate = op.MATURITYDATE,
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                dateTimeCreated = op.DATECREATED,
                                fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                {
                                    chargeFeeId = mp.CHARGEFEEID,
                                    feeAmount = mp.FEEAMOUNT,
                                    description = mp.DESCRIPTION,
                                    casaAccount = mp.CASAACCOUNTID,
                                    loanChargeFeeId = mp.LOANCHARGEFEEID,
                                    chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                    casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                }).ToList(),
                            }).ToList().Take(50);

            var dataRevolvingLoan = (from ln in context.TBL_LOAN_REVOLVING
                                     join op in context.TBL_LOAN_REVIEW_OPERATION on ln.REVOLVINGLOANID equals op.LOANID
                                     join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                     join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where lp.COMPANYID == companyId
                                     && (cu.FIRSTNAME.ToLower() == searchString.Trim().ToLower()
                                    || cu.MIDDLENAME.ToLower() == searchString.Trim().ToLower()
                                    || cu.LASTNAME.ToLower() == searchString.Trim().ToLower()
                                    || st.STAFFCODE == searchString.Trim())
                                        && lp.DELETED == false
                                        && ln.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                        && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                        && op.ISPRINTED == false
                                        && op.OPERATIONCOMPLETED == true
                                        && (ln.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                        && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && atrail.APPROVALSTATUSID != (short)ApprovalStatusEnum.Finishing && !levelIds.Contains((int)atrail.TOAPPROVALLEVELID)
                                        || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing && levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && operationIds.Contains(atrail.OPERATIONID)))


                                     orderby op.DATECREATED descending
                                     select new LoanReviewOperationApprovalViewModel
                                     {
                                         arrivalDate = atrail.SYSTEMARRIVALDATETIME,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                         lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                         loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                         appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                         customerId = ln.CUSTOMERID,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         prepaymentAmount = op.PREPAYMENT,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                           join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                           where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                           select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                         divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == ln.REVOLVINGLOANID && d.MODULE.ToLower() == "lms").Select(d => d.LOANID).FirstOrDefault(),
                                         approvalStatusId = op.APPROVALSTATUSID,
                                         approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         operationTypeId = op.OPERATIONTYPEID,
                                         operationTypeName = tt.OPERATIONNAME,
                                         newEffectiveDate = op.EFFECTIVEDATE,
                                         reviewDetails = op.REVIEWDETAILS,
                                         prepayment = op.PREPAYMENT,
                                         newInterateRate = op.INTERATERATE,
                                         newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                         newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                         newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                         newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newTenor = op.TENOR,
                                         cASA_AccountId = op.CASA_ACCOUNTID,
                                         cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         overDraftTopup = op.OVERDRAFTTOPUP,
                                         fee_Charges = op.FEE_CHARGES,
                                         scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                         scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                         scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                         scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                         scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                         newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                         newMaturityDate = op.MATURITYDATE,
                                         dateTimeCreated = op.DATECREATED,
                                         lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                         currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                         productAccountNumber = "N/A",
                                         productAccountName = "N/A",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                         fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                         {
                                             chargeFeeId = mp.CHARGEFEEID,
                                             feeAmount = mp.FEEAMOUNT,
                                             description = mp.DESCRIPTION,
                                             casaAccount = mp.CASAACCOUNTID,
                                             loanChargeFeeId = mp.LOANCHARGEFEEID,
                                             chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                             casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                         }).ToList(),
                                     }).ToList().Take(50);


            var dataContingentLoan = (from ln in context.TBL_LOAN_CONTINGENT
                                      join op in context.TBL_LOAN_REVIEW_OPERATION on ln.CONTINGENTLOANID equals op.LOANID
                                      join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                      join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                      join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                      join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                      join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                      join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                      join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                      join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                      join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                      join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                      join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                                      where lp.COMPANYID == companyId
                                      && (cu.FIRSTNAME.ToLower() == searchString.Trim().ToLower()
                                        || cu.MIDDLENAME.ToLower() == searchString.Trim().ToLower()
                                        || cu.LASTNAME.ToLower() == searchString.Trim().ToLower()
                                        || st.STAFFCODE == searchString.Trim())
                                        && lp.DELETED == false
                                        && ln.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                        && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                        && op.ISPRINTED == false
                                        && op.OPERATIONCOMPLETED == true
                                        && (ln.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                        && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && atrail.APPROVALSTATUSID != (short)ApprovalStatusEnum.Finishing && !levelIds.Contains((int)atrail.TOAPPROVALLEVELID)
                                        || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing && levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && operationIds.Contains(atrail.OPERATIONID)))

                                      orderby op.DATECREATED descending
                                      select new LoanReviewOperationApprovalViewModel
                                      {
                                          arrivalDate = atrail.SYSTEMARRIVALDATETIME,
                                          creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                          creditAppraisalOperationId = lp.OPERATIONID,
                                          lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                          lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                          loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                          appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                          loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                          loanId = ln.CONTINGENTLOANID,
                                          loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                          customerId = ln.CUSTOMERID,
                                          productId = ln.PRODUCTID,
                                          productTypeId = pr.PRODUCTTYPEID,
                                          productTypeName = context.TBL_PRODUCT_TYPE.Where(x => x.PRODUCTTYPEID == pr.PRODUCTTYPEID).Select(m => m.PRODUCTTYPENAME).FirstOrDefault(),
                                          casaAccountId = ln.CASAACCOUNTID,
                                          casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          branchId = ln.BRANCHID,
                                          lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                            join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                            where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                            select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                          loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                          applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                          relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                          relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                          misCode = ln.MISCODE,
                                          teamMiscode = ln.TEAMMISCODE,
                                          principalAmount = ln.CONTINGENTAMOUNT,
                                          //interestRate = ln.INTERESTRATE,
                                          flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == ln.CONTINGENTLOANID && d.MODULE.ToLower() == "lms").Select(d => d.LOANID).FirstOrDefault(),
                                          effectiveDate = ln.EFFECTIVEDATE,
                                          maturityDate = ln.MATURITYDATE,
                                          bookingDate = ln.BOOKINGDATE,
                                          approvalStatusId = op.APPROVALSTATUSID,
                                          approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                          approvedBy = (int)ln.APPROVEDBY,
                                          approverComment = ln.APPROVERCOMMENT,
                                          dateApproved = ln.DATEAPPROVED,
                                          loanStatusId = ln.LOANSTATUSID,
                                          divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                          divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                          isDisbursed = ln.ISDISBURSED,
                                          disburserComment = ln.DISBURSERCOMMENT,
                                          disburseDate = ln.DISBURSEDATE,
                                          customerGroupId = lp.CUSTOMERGROUPID,
                                          operationId = ln.OPERATIONID,
                                          loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                          subSectorId = ln.SUBSECTORID,
                                          subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                          sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                          dischargeLetter = ln.DISCHARGELETTER,
                                          //suspendInterest = ln.SUSPENDINTEREST,
                                          customerCode = cu.CUSTOMERCODE,
                                          loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                          customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                          currencyId = ln.CURRENCYID,
                                          currency = context.TBL_CURRENCY.Where(x => x.CURRENCYID == ln.CURRENCYID).Select(x => x.CURRENCYNAME).FirstOrDefault(),
                                          branchName = br.BRANCHNAME,
                                          relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                          relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                          productName = pr.PRODUCTNAME,
                                          comment = "",
                                          operationTypeId = op.OPERATIONTYPEID,
                                          operationTypeName = tt.OPERATIONNAME,
                                          newEffectiveDate = op.EFFECTIVEDATE,
                                          reviewDetails = op.REVIEWDETAILS,
                                          prepayment = op.PREPAYMENT,
                                          newInterateRate = op.INTERATERATE,
                                          newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                          newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                          newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                          newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newTenor = op.TENOR,
                                          cASA_AccountId = op.CASA_ACCOUNTID,
                                          cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          overDraftTopup = op.OVERDRAFTTOPUP,
                                          fee_Charges = op.FEE_CHARGES,
                                          scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                          scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                          scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                          scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                          scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                          newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                          newMaturityDate = op.MATURITYDATE,
                                          lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                          dateTimeCreated = op.DATECREATED,
                                          currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                          productAccountNumber = ch.ACCOUNTCODE,
                                          productAccountName = ch.ACCOUNTNAME,
                                          prepaymentAmount = op.PREPAYMENT,
                                          approvedAmount = ld.APPROVEDAMOUNT,
                                          creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                          fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                          {
                                              chargeFeeId = mp.CHARGEFEEID,
                                              feeAmount = mp.FEEAMOUNT,
                                              description = mp.DESCRIPTION,
                                              casaAccount = mp.CASAACCOUNTID,
                                              loanChargeFeeId = mp.LOANCHARGEFEEID,
                                              chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                              casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                          }).ToList(),
                                      }).ToList().Take(50);

            var termLoanData = dataLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var contingentLoanData = dataContingentLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var unionAll = termLoanData.Union(revolvingLoanData);

            var data = unionAll.Union(contingentLoanData);


            return data;
        }


        public IEnumerable<LoanReviewOperationApprovalViewModel> GetCompletedLoanOperationDocumentation(int staffId, int companyId, DateTime startDate, DateTime endDate)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);

            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONTYPEID == (short)OperationTypeEnum.LoanManagement).Select(c => c.OPERATIONID).ToList();
            List<int> levelIds = new List<int>();

            foreach (var operationId in operationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }


            var company = context.TBL_COMPANY.Find(companyId);

            var dataLoan = (from ln in context.TBL_LOAN
                            join cd in context.TBL_DOCUMENTATION_FILLING_APPROVAL on ln.TERMLOANID equals cd.LOANID
                            join op in context.TBL_LOAN_REVIEW_OPERATION on ln.TERMLOANID equals op.LOANID
                            join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            lp.COMPANYID == companyId
                            && lp.DELETED == false
                            && ln.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                            && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && op.ISPRINTED == true
                            && cd.MODULE == "LMS"
                            && cd.LOANREFERENCE == ln.LOANREFERENCENUMBER
                            && op.OPERATIONCOMPLETED == true
                            && (ln.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                            && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && atrail.APPROVALSTATUSID != (short)ApprovalStatusEnum.Finishing && !levelIds.Contains((int)atrail.TOAPPROVALLEVELID)
                            || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing && levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && operationIds.Contains(atrail.OPERATIONID)))
                            && (DbFunctions.TruncateTime(cd.DATETIMECREATED) >= DbFunctions.TruncateTime(startDate) && DbFunctions.TruncateTime(cd.DATETIMECREATED) <= DbFunctions.TruncateTime(endDate))
                            && cd.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                            orderby op.DATECREATED descending
                            select new LoanReviewOperationApprovalViewModel
                            {
                                arrivalDate = atrail.SYSTEMARRIVALDATETIME,
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                prepaymentAmount = op.PREPAYMENT,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                amount = ld.APPROVEDAMOUNT,
                                lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                  join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                  where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                  select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = op.APPROVALSTATUSID,
                                approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == ln.TERMLOANID && d.MODULE.ToLower() == "lms").Select(d => d.LOANID).FirstOrDefault(),
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                productAccountNumber = ch.ACCOUNTCODE,
                                productAccountName = ch.ACCOUNTNAME,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                operationTypeId = op.OPERATIONTYPEID,
                                operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                newEffectiveDate = op.EFFECTIVEDATE,
                                reviewDetails = op.REVIEWDETAILS,
                                prepayment = op.PREPAYMENT,
                                newInterateRate = op.INTERATERATE,
                                newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newTenor = op.TENOR,
                                cASA_AccountId = op.CASA_ACCOUNTID,
                                cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                overDraftTopup = op.OVERDRAFTTOPUP,
                                fee_Charges = op.FEE_CHARGES,
                                scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                newMaturityDate = op.MATURITYDATE,
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                dateTimeCreated = op.DATECREATED,
                                fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                {
                                    chargeFeeId = mp.CHARGEFEEID,
                                    feeAmount = mp.FEEAMOUNT,
                                    description = mp.DESCRIPTION,
                                    casaAccount = mp.CASAACCOUNTID,
                                    loanChargeFeeId = mp.LOANCHARGEFEEID,
                                    chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                    casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                }).ToList(),
                            }).ToList();

            var dataRevolvingLoan = (from ln in context.TBL_LOAN_REVOLVING
                                     join cd in context.TBL_DOCUMENTATION_FILLING_APPROVAL on ln.REVOLVINGLOANID equals cd.LOANID
                                     join op in context.TBL_LOAN_REVIEW_OPERATION on ln.REVOLVINGLOANID equals op.LOANID
                                     join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                     join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where lp.COMPANYID == companyId
                                        && lp.DELETED == false
                                        && ln.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                        && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                        && op.ISPRINTED == true
                                        && cd.MODULE == "LMS"
                                        && cd.LOANREFERENCE == ln.LOANREFERENCENUMBER
                                        && op.OPERATIONCOMPLETED == true
                                        && (ln.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                        && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && atrail.APPROVALSTATUSID != (short)ApprovalStatusEnum.Finishing && !levelIds.Contains((int)atrail.TOAPPROVALLEVELID)
                                        || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing && levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && operationIds.Contains(atrail.OPERATIONID)))
                                        && (DbFunctions.TruncateTime(cd.DATETIMECREATED) >= DbFunctions.TruncateTime(startDate) && DbFunctions.TruncateTime(cd.DATETIMECREATED) <= DbFunctions.TruncateTime(endDate))
                                        && cd.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                                     orderby op.DATECREATED descending
                                     select new LoanReviewOperationApprovalViewModel
                                     {
                                         arrivalDate = atrail.SYSTEMARRIVALDATETIME,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                         lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                         loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                         appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                         customerId = ln.CUSTOMERID,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         prepaymentAmount = op.PREPAYMENT,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                           join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                           where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                           select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                         divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == ln.REVOLVINGLOANID && d.MODULE.ToLower() == "lms").Select(d => d.LOANID).FirstOrDefault(),
                                         approvalStatusId = op.APPROVALSTATUSID,
                                         approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         operationTypeId = op.OPERATIONTYPEID,
                                         operationTypeName = tt.OPERATIONNAME,
                                         newEffectiveDate = op.EFFECTIVEDATE,
                                         reviewDetails = op.REVIEWDETAILS,
                                         prepayment = op.PREPAYMENT,
                                         newInterateRate = op.INTERATERATE,
                                         newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                         newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                         newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                         newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newTenor = op.TENOR,
                                         cASA_AccountId = op.CASA_ACCOUNTID,
                                         cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         overDraftTopup = op.OVERDRAFTTOPUP,
                                         fee_Charges = op.FEE_CHARGES,
                                         scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                         scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                         scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                         scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                         scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                         newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                         newMaturityDate = op.MATURITYDATE,
                                         dateTimeCreated = op.DATECREATED,
                                         lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                         currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                         productAccountNumber = "N/A",
                                         productAccountName = "N/A",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                         fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                         {
                                             chargeFeeId = mp.CHARGEFEEID,
                                             feeAmount = mp.FEEAMOUNT,
                                             description = mp.DESCRIPTION,
                                             casaAccount = mp.CASAACCOUNTID,
                                             loanChargeFeeId = mp.LOANCHARGEFEEID,
                                             chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                             casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                         }).ToList(),
                                     }).ToList();


            var dataContingentLoan = (from ln in context.TBL_LOAN_CONTINGENT
                                      join cd in context.TBL_DOCUMENTATION_FILLING_APPROVAL on ln.CONTINGENTLOANID equals cd.LOANID
                                      join op in context.TBL_LOAN_REVIEW_OPERATION on ln.CONTINGENTLOANID equals op.LOANID
                                      join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                      join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                      join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                      join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                      join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                      join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                      join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                      join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                      join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                      join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                      join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                                      where lp.COMPANYID == companyId
                                        && lp.DELETED == false
                                        && ln.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                        && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                        && op.ISPRINTED == true
                                        && cd.MODULE == "LMS"
                                        && cd.LOANREFERENCE == ln.LOANREFERENCENUMBER
                                        && op.OPERATIONCOMPLETED == true
                                        && (ln.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                        && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && atrail.APPROVALSTATUSID != (short)ApprovalStatusEnum.Finishing && !levelIds.Contains((int)atrail.TOAPPROVALLEVELID)
                                        || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing && levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && operationIds.Contains(atrail.OPERATIONID)))
                                        && (DbFunctions.TruncateTime(cd.DATETIMECREATED) >= DbFunctions.TruncateTime(startDate) && DbFunctions.TruncateTime(cd.DATETIMECREATED) <= DbFunctions.TruncateTime(endDate))
                                        && cd.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                                      orderby op.DATECREATED descending
                                      select new LoanReviewOperationApprovalViewModel
                                      {
                                          arrivalDate = atrail.SYSTEMARRIVALDATETIME,
                                          creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                          creditAppraisalOperationId = lp.OPERATIONID,
                                          lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                          lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                          loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                          appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                          loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                          loanId = ln.CONTINGENTLOANID,
                                          loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                          customerId = ln.CUSTOMERID,
                                          productId = ln.PRODUCTID,
                                          productTypeId = pr.PRODUCTTYPEID,
                                          productTypeName = context.TBL_PRODUCT_TYPE.Where(x => x.PRODUCTTYPEID == pr.PRODUCTTYPEID).Select(m => m.PRODUCTTYPENAME).FirstOrDefault(),
                                          casaAccountId = ln.CASAACCOUNTID,
                                          casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          branchId = ln.BRANCHID,
                                          lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                            join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                            where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                            select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                          loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                          applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                          relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                          relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                          misCode = ln.MISCODE,
                                          teamMiscode = ln.TEAMMISCODE,
                                          principalAmount = ln.CONTINGENTAMOUNT,
                                          //interestRate = ln.INTERESTRATE,
                                          flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == ln.CONTINGENTLOANID && d.MODULE.ToLower() == "lms").Select(d => d.LOANID).FirstOrDefault(),
                                          effectiveDate = ln.EFFECTIVEDATE,
                                          maturityDate = ln.MATURITYDATE,
                                          bookingDate = ln.BOOKINGDATE,
                                          approvalStatusId = op.APPROVALSTATUSID,
                                          approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                          approvedBy = (int)ln.APPROVEDBY,
                                          approverComment = ln.APPROVERCOMMENT,
                                          dateApproved = ln.DATEAPPROVED,
                                          loanStatusId = ln.LOANSTATUSID,
                                          divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                          divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                          isDisbursed = ln.ISDISBURSED,
                                          disburserComment = ln.DISBURSERCOMMENT,
                                          disburseDate = ln.DISBURSEDATE,
                                          customerGroupId = lp.CUSTOMERGROUPID,
                                          operationId = ln.OPERATIONID,
                                          loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                          subSectorId = ln.SUBSECTORID,
                                          subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                          sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                          dischargeLetter = ln.DISCHARGELETTER,
                                          //suspendInterest = ln.SUSPENDINTEREST,
                                          customerCode = cu.CUSTOMERCODE,
                                          loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                          customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                          currencyId = ln.CURRENCYID,
                                          currency = context.TBL_CURRENCY.Where(x => x.CURRENCYID == ln.CURRENCYID).Select(x => x.CURRENCYNAME).FirstOrDefault(),
                                          branchName = br.BRANCHNAME,
                                          relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                          relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                          productName = pr.PRODUCTNAME,
                                          comment = "",
                                          operationTypeId = op.OPERATIONTYPEID,
                                          operationTypeName = tt.OPERATIONNAME,
                                          newEffectiveDate = op.EFFECTIVEDATE,
                                          reviewDetails = op.REVIEWDETAILS,
                                          prepayment = op.PREPAYMENT,
                                          newInterateRate = op.INTERATERATE,
                                          newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                          newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                          newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                          newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newTenor = op.TENOR,
                                          cASA_AccountId = op.CASA_ACCOUNTID,
                                          cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          overDraftTopup = op.OVERDRAFTTOPUP,
                                          fee_Charges = op.FEE_CHARGES,
                                          scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                          scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                          scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                          scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                          scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                          newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                          newMaturityDate = op.MATURITYDATE,
                                          lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                          dateTimeCreated = op.DATECREATED,
                                          currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                          productAccountNumber = ch.ACCOUNTCODE,
                                          productAccountName = ch.ACCOUNTNAME,
                                          prepaymentAmount = op.PREPAYMENT,
                                          approvedAmount = ld.APPROVEDAMOUNT,
                                          creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                          fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                          {
                                              chargeFeeId = mp.CHARGEFEEID,
                                              feeAmount = mp.FEEAMOUNT,
                                              description = mp.DESCRIPTION,
                                              casaAccount = mp.CASAACCOUNTID,
                                              loanChargeFeeId = mp.LOANCHARGEFEEID,
                                              chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                              casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                          }).ToList(),
                                      }).ToList();

            var termLoanData = dataLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var contingentLoanData = dataContingentLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var unionAll = termLoanData.Union(revolvingLoanData);

            var data = unionAll.Union(contingentLoanData);


            return data;
        }

        public IEnumerable<CamProcessedLoanViewModel> GetLoanOperationDocumentationLos(int staffId, int companyId)
        {
            var staff = context.TBL_STAFF.Find(staffId);
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();
            //var activities = admin.GetUserActivitiesByUser(staffRec.USERID);

            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            List<int> loanOperationIds = new List<int>();
            List<int> contingentOperationIds = new List<int>();
            List<int> RevolvingOperationIds = new List<int>();

            loanOperationIds.Add((int)OperationsEnum.TermLoanBooking);
            loanOperationIds.Add((int)OperationsEnum.CommercialLoanBooking);
            loanOperationIds.Add((int)OperationsEnum.ForeignExchangeLoanBooking);
            contingentOperationIds.Add((int)OperationsEnum.ContigentLoanBooking);
            RevolvingOperationIds.Add((int)OperationsEnum.RevolvingLoanBooking);


            var staffs = generalSetup.GetStaffRlieved(staffId);

            List<int> levelIds = new List<int>();
            foreach (var i in loanOperationIds) 
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList());
            }
            foreach (var i in contingentOperationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList());
            }
            foreach (var i in RevolvingOperationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList());
            }

            //var company = context.TBL_COMPANY.Find(companyId);
            IEnumerable<CamProcessedLoanViewModel> allLoans = null;

            var dataTermLoans = (from a in context.TBL_LOAN
                                join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals s.LOAN_BOOKING_REQUESTID
                                join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                where m.COMPANYID == companyId
                                && s.DELETED == false
                                && a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                && a.ISPRINTED == false
                                && a.ISDISBURSED == true
                                && loanOperationIds.Contains(atrail.OPERATIONID)
                                && (a.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                 && ((!levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                 || (levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing)))
                                 orderby a.DATEAPPROVED descending
                                 select new CamProcessedLoanViewModel()
                                   {
                                       bookingAmountRequested = s.AMOUNT_REQUESTED,
                                       loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                       amountDisbursed = a.PRINCIPALAMOUNT,
                                       bookingRequestStatusId = s.APPROVALSTATUSID,
                                       isLineFacility = d.ISLINEFACILITY,
                                       loanId = a.TERMLOANID,
                                       approvalDate = a.DATEAPPROVED,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                       isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                       requestDate = s.DATETIMECREATED,
                                       requestedBy = "",
                                       systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                       operationId = s.OPERATIONID,
                                       appraisalOperationId = m.OPERATIONID,
                                       crmsCode = s.CRMSCODE,
                                       requestedAmount = s.AMOUNT_REQUESTED,
                                       requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                       approvalStatusId = atrail.APPROVALSTATUSID,
                                       approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                       loanApplicationId = m.LOANAPPLICATIONID,
                                       flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == a.TERMLOANID && d.MODULE.ToLower() == "los").Select(d => d.LOANID).FirstOrDefault(),

                                       loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                       applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                       applicationStatusId = m.APPLICATIONSTATUSID,
                                       divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                       customerId = d.CUSTOMERID,
                                       customerCode = cust.CUSTOMERCODE,
                                       customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                       customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                       customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                       customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                       customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                       applicationTenor = m.APPLICATIONTENOR,
                                       effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                       expiryDate = (DateTime)d.EXPIRYDATE,
                                       currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                       currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                       exchangeRate = d.EXCHANGERATE,
                                       loanTypeId = m.LOANAPPLICATIONTYPEID,
                                       loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productId = s.PRODUCTID,
                                       productTypeId = p.PRODUCTTYPEID,
                                       productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                       productTypeName = pt.PRODUCTTYPENAME,
                                       productName = p.PRODUCTNAME,
                                       casaAccountId = s.CASAACCOUNTID,
                                       casaAccountId2 = s.CASAACCOUNTID2,
                                       productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                       divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                       interestRate = d.APPROVEDINTERESTRATE,
                                       approvedInterestRate = d.APPROVEDINTERESTRATE,
                                       approvedAmount = d.APPROVEDAMOUNT,
                                       groupApprovedAmount = m.APPROVEDAMOUNT,
                                       availmentDate = m.AVAILMENTDATE,
                                       approvedTenor = d.APPROVEDTENOR,
                                       toStaffId = atrail.TOSTAFFID,
                                       requestStaffId = atrail.REQUESTSTAFFID,
                                       isInEditMode = s.ISUSED ?? false,
                                       isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                       approvalTrailId = atrail.APPROVALTRAILID,
                                       responseStaffId = atrail.RESPONSESTAFFID
                                   }).GroupBy(l => l.loanId).Select(s => s.OrderByDescending(o => o.approvalTrailId).FirstOrDefault()).ToList();

            var dataRevolvingLoans = (from a in context.TBL_LOAN_REVOLVING
                                        join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals s.LOAN_BOOKING_REQUESTID
                                        join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                        join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                        join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                        join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                        join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                        where m.COMPANYID == companyId
                                        && s.DELETED == false
                                        && (a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                                        && a.ISPRINTED == false
                                        && RevolvingOperationIds.Contains(atrail.OPERATIONID)
                                        && (a.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                        && a.ISDISBURSED == true
                                        && ((!levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                        || (levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing)))


                                      orderby a.DATEAPPROVED descending
                                         select new CamProcessedLoanViewModel()
                                         {
                                             bookingAmountRequested = s.AMOUNT_REQUESTED,
                                             loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                             amountDisbursed = a.OVERDRAFTLIMIT,
                                             bookingRequestStatusId = s.APPROVALSTATUSID,
                                             isLineFacility = d.ISLINEFACILITY,
                                             loanReferenceNumber = a.LOANREFERENCENUMBER,
                                             isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                             isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                             requestDate = s.DATETIMECREATED,
                                             requestedBy = "",
                                             loanId = a.REVOLVINGLOANID,
                                             approvalDate = a.DATEAPPROVED,
                                             systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                             operationId = s.OPERATIONID,
                                             appraisalOperationId = m.OPERATIONID,
                                             crmsCode = s.CRMSCODE,
                                             requestedAmount = s.AMOUNT_REQUESTED,
                                             requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                             approvalStatusId = atrail.APPROVALSTATUSID,
                                             approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                             loanApplicationId = m.LOANAPPLICATIONID,

                                             loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                             applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                             applicationStatusId = m.APPLICATIONSTATUSID,
                                             divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                             customerId = d.CUSTOMERID,
                                             customerCode = cust.CUSTOMERCODE,
                                             customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                             customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                             customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                             customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                             customerType = cust.TBL_CUSTOMER_TYPE.NAME,
                                             flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == a.REVOLVINGLOANID && d.MODULE.ToLower() == "los").Select(d => d.LOANID).FirstOrDefault(),

                                             applicationTenor = m.APPLICATIONTENOR,
                                             effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                             expiryDate = (DateTime)d.EXPIRYDATE,
                                             currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                             currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                             exchangeRate = d.EXCHANGERATE,
                                             loanTypeId = m.LOANAPPLICATIONTYPEID,
                                             loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                             productId = s.PRODUCTID,
                                             productTypeId = p.PRODUCTTYPEID,
                                             productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                             productTypeName = pt.PRODUCTTYPENAME,
                                             productName = p.PRODUCTNAME,
                                             casaAccountId = s.CASAACCOUNTID,
                                             casaAccountId2 = s.CASAACCOUNTID2,
                                             productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                             divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                             interestRate = d.APPROVEDINTERESTRATE,
                                             approvedInterestRate = d.APPROVEDINTERESTRATE,
                                             approvedAmount = d.APPROVEDAMOUNT,
                                             groupApprovedAmount = m.APPROVEDAMOUNT,
                                             availmentDate = m.AVAILMENTDATE,
                                             approvedTenor = d.APPROVEDTENOR,
                                             toStaffId = atrail.TOSTAFFID,
                                             requestStaffId = atrail.REQUESTSTAFFID,
                                             isInEditMode = s.ISUSED ?? false,
                                             isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                             approvalTrailId = atrail.APPROVALTRAILID,
                                             responseStaffId = atrail.RESPONSESTAFFID
                                         }).GroupBy(l => l.loanId).Select(s => s.OrderByDescending(o => o.approvalTrailId).FirstOrDefault()).ToList();

        var dataContingentLoans = (from a in context.TBL_LOAN_CONTINGENT
                                    join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals s.LOAN_BOOKING_REQUESTID
                                    join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                    join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                    join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                    join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                    join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                    join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                    where m.COMPANYID == companyId
                                    && s.DELETED == false
                                    && (a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                                    && a.ISPRINTED == false
                                    && contingentOperationIds.Contains(atrail.OPERATIONID)
                                    && (a.LOANSTATUSID != (int)LoanStatusEnum.Inactive )
                                    && a.ISDISBURSED == true
                                    && ((!levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                    || (levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing)))

                                   orderby a.DATEAPPROVED descending
                                         select new CamProcessedLoanViewModel()
                                         {
                                             bookingAmountRequested = s.AMOUNT_REQUESTED,
                                             loanReferenceNumber = a.LOANREFERENCENUMBER,
                                             loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                             amountDisbursed = a.CONTINGENTAMOUNT,
                                             bookingRequestStatusId = s.APPROVALSTATUSID,
                                             isLineFacility = d.ISLINEFACILITY,
                                             isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                             isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                             requestDate = s.DATETIMECREATED,
                                             requestedBy = "",
                                             systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                             operationId = s.OPERATIONID,
                                             appraisalOperationId = m.OPERATIONID,
                                             crmsCode = s.CRMSCODE,
                                             loanId = a.CONTINGENTLOANID,
                                             approvalDate = a.DATEAPPROVED,
                                             requestedAmount = s.AMOUNT_REQUESTED,
                                             requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                             approvalStatusId = atrail.APPROVALSTATUSID,
                                             approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                             loanApplicationId = m.LOANAPPLICATIONID,
                                             flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == a.CONTINGENTLOANID && d.MODULE.ToLower() == "los").Select(d => d.LOANID).FirstOrDefault(),

                                             loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                             applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                             applicationStatusId = m.APPLICATIONSTATUSID,
                                             divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                             customerId = d.CUSTOMERID,
                                             customerCode = cust.CUSTOMERCODE,
                                             customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                             customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                             customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                             customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                             customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                             applicationTenor = m.APPLICATIONTENOR,
                                             effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                             expiryDate = (DateTime)d.EXPIRYDATE,
                                             currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                             currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                             exchangeRate = d.EXCHANGERATE,
                                             loanTypeId = m.LOANAPPLICATIONTYPEID,
                                             loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                             productId = s.PRODUCTID,
                                             productTypeId = p.PRODUCTTYPEID,
                                             productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                             productTypeName = pt.PRODUCTTYPENAME,
                                             productName = p.PRODUCTNAME,
                                             casaAccountId = s.CASAACCOUNTID,
                                             casaAccountId2 = s.CASAACCOUNTID2,
                                             productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                             divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                             interestRate = d.APPROVEDINTERESTRATE,
                                             approvedInterestRate = d.APPROVEDINTERESTRATE,
                                             approvedAmount = d.APPROVEDAMOUNT,
                                             groupApprovedAmount = m.APPROVEDAMOUNT,
                                             availmentDate = m.AVAILMENTDATE,
                                             approvedTenor = d.APPROVEDTENOR,
                                             toStaffId = atrail.TOSTAFFID,
                                             requestStaffId = atrail.REQUESTSTAFFID,
                                             isInEditMode = s.ISUSED ?? false,
                                             isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                             approvalTrailId = atrail.APPROVALTRAILID,
                                             responseStaffId = atrail.RESPONSESTAFFID
                                         }).GroupBy(l => l.loanId).Select(s => s.OrderByDescending(o => o.approvalTrailId).FirstOrDefault()).ToList();


            var termLoanData = dataTermLoans.OrderByDescending(x => x.approvalDate).Take(50);
            var revolvingLoanData = dataRevolvingLoans.OrderByDescending(x => x.approvalDate).Take(50);
            var contingentLoanData = dataContingentLoans.OrderByDescending(x => x.approvalDate).Take(50);
            var unionAll = termLoanData.Union(revolvingLoanData);

            var data = unionAll.Union(contingentLoanData);

            allLoans = data.OrderByDescending(x => x.approvalDate).ToList();
            return allLoans;
            
        }

        public IEnumerable<CamProcessedLoanViewModel> GetLoanOperationDocumentationLosSearch(int staffId, int companyId, string searchString)
        {
            var staff = context.TBL_STAFF.Find(staffId);
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();
            //var activities = admin.GetUserActivitiesByUser(staffRec.USERID);

            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            List<int> loanOperationIds = new List<int>();
            List<int> contingentOperationIds = new List<int>();
            List<int> RevolvingOperationIds = new List<int>();

            loanOperationIds.Add((int)OperationsEnum.TermLoanBooking);
            loanOperationIds.Add((int)OperationsEnum.CommercialLoanBooking);
            loanOperationIds.Add((int)OperationsEnum.ForeignExchangeLoanBooking);
            contingentOperationIds.Add((int)OperationsEnum.ContigentLoanBooking);
            RevolvingOperationIds.Add((int)OperationsEnum.RevolvingLoanBooking);


            var staffs = generalSetup.GetStaffRlieved(staffId);

            List<int> levelIds = new List<int>();
            foreach (var i in loanOperationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList());
            }
            foreach (var i in contingentOperationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList());
            }
            foreach (var i in RevolvingOperationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList());
            }

            //var company = context.TBL_COMPANY.Find(companyId);
            IEnumerable<CamProcessedLoanViewModel> allLoans = null;

            var dataTermLoans = (from a in context.TBL_LOAN
                                 join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals s.LOAN_BOOKING_REQUESTID
                                 join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                 join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                 join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                 join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                 join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                 join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                 where m.COMPANYID == companyId
                                 && (cust.FIRSTNAME.ToLower() == searchString.Trim().ToLower() 
                                 || cust.MIDDLENAME.ToLower() == searchString.Trim().ToLower() 
                                 || cust.LASTNAME.ToLower() == searchString.Trim().ToLower()
                                 || m.APPLICATIONREFERENCENUMBER == searchString.Trim())
                                 && s.DELETED == false
                                 && a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                 && a.ISPRINTED == false
                                 && a.ISDISBURSED == true
                                 && loanOperationIds.Contains(atrail.OPERATIONID)
                                 && (a.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                  && ((!levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                  || (levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing)))
                                 orderby a.DATEAPPROVED descending
                                 select new CamProcessedLoanViewModel()
                                 {
                                     bookingAmountRequested = s.AMOUNT_REQUESTED,
                                     loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                     amountDisbursed = a.PRINCIPALAMOUNT,
                                     bookingRequestStatusId = s.APPROVALSTATUSID,
                                     isLineFacility = d.ISLINEFACILITY,
                                     loanId = a.TERMLOANID,
                                     approvalDate = a.DATEAPPROVED,
                                     loanReferenceNumber = a.LOANREFERENCENUMBER,
                                     isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                     isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                     requestDate = s.DATETIMECREATED,
                                     requestedBy = "",
                                     systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                     operationId = s.OPERATIONID,
                                     appraisalOperationId = m.OPERATIONID,
                                     crmsCode = s.CRMSCODE,
                                     requestedAmount = s.AMOUNT_REQUESTED,
                                     requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                     approvalStatusId = atrail.APPROVALSTATUSID,
                                     approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                     loanApplicationId = m.LOANAPPLICATIONID,
                                     flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == a.TERMLOANID && d.MODULE.ToLower() == "los").Select(d => d.LOANID).FirstOrDefault(),

                                     loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                     applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                     applicationStatusId = m.APPLICATIONSTATUSID,
                                     divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                     customerId = d.CUSTOMERID,
                                     customerCode = cust.CUSTOMERCODE,
                                     customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                     customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                     customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                     customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                     customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                     applicationTenor = m.APPLICATIONTENOR,
                                     effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                     expiryDate = (DateTime)d.EXPIRYDATE,
                                     currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                     currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                     exchangeRate = d.EXCHANGERATE,
                                     loanTypeId = m.LOANAPPLICATIONTYPEID,
                                     loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                     productId = s.PRODUCTID,
                                     productTypeId = p.PRODUCTTYPEID,
                                     productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                     productTypeName = pt.PRODUCTTYPENAME,
                                     productName = p.PRODUCTNAME,
                                     casaAccountId = s.CASAACCOUNTID,
                                     casaAccountId2 = s.CASAACCOUNTID2,
                                     productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                     divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                     interestRate = d.APPROVEDINTERESTRATE,
                                     approvedInterestRate = d.APPROVEDINTERESTRATE,
                                     approvedAmount = d.APPROVEDAMOUNT,
                                     groupApprovedAmount = m.APPROVEDAMOUNT,
                                     availmentDate = m.AVAILMENTDATE,
                                     approvedTenor = d.APPROVEDTENOR,
                                     toStaffId = atrail.TOSTAFFID,
                                     requestStaffId = atrail.REQUESTSTAFFID,
                                     isInEditMode = s.ISUSED ?? false,
                                     isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                     approvalTrailId = atrail.APPROVALTRAILID,
                                     responseStaffId = atrail.RESPONSESTAFFID
                                 }).GroupBy(l => l.loanId).Select(s => s.OrderByDescending(o => o.approvalTrailId).FirstOrDefault()).ToList();

            var dataRevolvingLoans = (from a in context.TBL_LOAN_REVOLVING
                                      join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals s.LOAN_BOOKING_REQUESTID
                                      join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                      join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                      join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                      join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                      join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                      join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                      where m.COMPANYID == companyId
                                      && (cust.FIRSTNAME.ToLower() == searchString.Trim().ToLower()
                                     || cust.MIDDLENAME.ToLower() == searchString.Trim().ToLower()
                                     || cust.LASTNAME.ToLower() == searchString.Trim().ToLower()
                                     || m.APPLICATIONREFERENCENUMBER == searchString.Trim())
                                      && s.DELETED == false
                                      && (a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                                      && a.ISPRINTED == false
                                      && RevolvingOperationIds.Contains(atrail.OPERATIONID)
                                      && (a.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                      && a.ISDISBURSED == true
                                      && ((!levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                      || (levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing)))


                                      orderby a.DATEAPPROVED descending
                                      select new CamProcessedLoanViewModel()
                                      {
                                          bookingAmountRequested = s.AMOUNT_REQUESTED,
                                          loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                          amountDisbursed = a.OVERDRAFTLIMIT,
                                          bookingRequestStatusId = s.APPROVALSTATUSID,
                                          isLineFacility = d.ISLINEFACILITY,
                                          loanReferenceNumber = a.LOANREFERENCENUMBER,
                                          isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                          isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                          requestDate = s.DATETIMECREATED,
                                          requestedBy = "",
                                          loanId = a.REVOLVINGLOANID,
                                          approvalDate = a.DATEAPPROVED,
                                          systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                          operationId = s.OPERATIONID,
                                          appraisalOperationId = m.OPERATIONID,
                                          crmsCode = s.CRMSCODE,
                                          requestedAmount = s.AMOUNT_REQUESTED,
                                          requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                          approvalStatusId = atrail.APPROVALSTATUSID,
                                          approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                          loanApplicationId = m.LOANAPPLICATIONID,

                                          loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                          applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                          applicationStatusId = m.APPLICATIONSTATUSID,
                                          divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                          customerId = d.CUSTOMERID,
                                          customerCode = cust.CUSTOMERCODE,
                                          customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                          customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                          customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                          customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                          customerType = cust.TBL_CUSTOMER_TYPE.NAME,
                                          flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == a.REVOLVINGLOANID && d.MODULE.ToLower() == "los").Select(d => d.LOANID).FirstOrDefault(),

                                          applicationTenor = m.APPLICATIONTENOR,
                                          effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                          expiryDate = (DateTime)d.EXPIRYDATE,
                                          currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                          currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                          exchangeRate = d.EXCHANGERATE,
                                          loanTypeId = m.LOANAPPLICATIONTYPEID,
                                          loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                          productId = s.PRODUCTID,
                                          productTypeId = p.PRODUCTTYPEID,
                                          productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                          productTypeName = pt.PRODUCTTYPENAME,
                                          productName = p.PRODUCTNAME,
                                          casaAccountId = s.CASAACCOUNTID,
                                          casaAccountId2 = s.CASAACCOUNTID2,
                                          productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                          divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                          interestRate = d.APPROVEDINTERESTRATE,
                                          approvedInterestRate = d.APPROVEDINTERESTRATE,
                                          approvedAmount = d.APPROVEDAMOUNT,
                                          groupApprovedAmount = m.APPROVEDAMOUNT,
                                          availmentDate = m.AVAILMENTDATE,
                                          approvedTenor = d.APPROVEDTENOR,
                                          toStaffId = atrail.TOSTAFFID,
                                          requestStaffId = atrail.REQUESTSTAFFID,
                                          isInEditMode = s.ISUSED ?? false,
                                          isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                          approvalTrailId = atrail.APPROVALTRAILID,
                                          responseStaffId = atrail.RESPONSESTAFFID
                                      }).GroupBy(l => l.loanId).Select(s => s.OrderByDescending(o => o.approvalTrailId).FirstOrDefault()).ToList();

            var dataContingentLoans = (from a in context.TBL_LOAN_CONTINGENT
                                       join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals s.LOAN_BOOKING_REQUESTID
                                       join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                       join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                       join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                       join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                       join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                       join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                       where m.COMPANYID == companyId
                                       && (cust.FIRSTNAME.ToLower() == searchString.Trim().ToLower()
                                     || cust.MIDDLENAME.ToLower() == searchString.Trim().ToLower()
                                     || cust.LASTNAME.ToLower() == searchString.Trim().ToLower()
                                     || m.APPLICATIONREFERENCENUMBER == searchString.Trim())
                                       && s.DELETED == false
                                       && (a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                                       && a.ISPRINTED == false
                                       && contingentOperationIds.Contains(atrail.OPERATIONID)
                                       && (a.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                       && a.ISDISBURSED == true
                                       && ((!levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                       || (levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing)))

                                       orderby a.DATEAPPROVED descending
                                       select new CamProcessedLoanViewModel()
                                       {
                                           bookingAmountRequested = s.AMOUNT_REQUESTED,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                           amountDisbursed = a.CONTINGENTAMOUNT,
                                           bookingRequestStatusId = s.APPROVALSTATUSID,
                                           isLineFacility = d.ISLINEFACILITY,
                                           isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                           isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                           requestDate = s.DATETIMECREATED,
                                           requestedBy = "",
                                           systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                           operationId = s.OPERATIONID,
                                           appraisalOperationId = m.OPERATIONID,
                                           crmsCode = s.CRMSCODE,
                                           loanId = a.CONTINGENTLOANID,
                                           approvalDate = a.DATEAPPROVED,
                                           requestedAmount = s.AMOUNT_REQUESTED,
                                           requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                           approvalStatusId = atrail.APPROVALSTATUSID,
                                           approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                           loanApplicationId = m.LOANAPPLICATIONID,
                                           flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == a.CONTINGENTLOANID && d.MODULE.ToLower() == "los").Select(d => d.LOANID).FirstOrDefault(),

                                           loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                           applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                           applicationStatusId = m.APPLICATIONSTATUSID,
                                           divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                           customerId = d.CUSTOMERID,
                                           customerCode = cust.CUSTOMERCODE,
                                           customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                           customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                           customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                           customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                           customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                           applicationTenor = m.APPLICATIONTENOR,
                                           effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                           expiryDate = (DateTime)d.EXPIRYDATE,
                                           currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                           currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                           exchangeRate = d.EXCHANGERATE,
                                           loanTypeId = m.LOANAPPLICATIONTYPEID,
                                           loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                           productId = s.PRODUCTID,
                                           productTypeId = p.PRODUCTTYPEID,
                                           productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                           productTypeName = pt.PRODUCTTYPENAME,
                                           productName = p.PRODUCTNAME,
                                           casaAccountId = s.CASAACCOUNTID,
                                           casaAccountId2 = s.CASAACCOUNTID2,
                                           productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                           divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                           interestRate = d.APPROVEDINTERESTRATE,
                                           approvedInterestRate = d.APPROVEDINTERESTRATE,
                                           approvedAmount = d.APPROVEDAMOUNT,
                                           groupApprovedAmount = m.APPROVEDAMOUNT,
                                           availmentDate = m.AVAILMENTDATE,
                                           approvedTenor = d.APPROVEDTENOR,
                                           toStaffId = atrail.TOSTAFFID,
                                           requestStaffId = atrail.REQUESTSTAFFID,
                                           isInEditMode = s.ISUSED ?? false,
                                           isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                           approvalTrailId = atrail.APPROVALTRAILID,
                                           responseStaffId = atrail.RESPONSESTAFFID
                                       }).GroupBy(l => l.loanId).Select(s => s.OrderByDescending(o => o.approvalTrailId).FirstOrDefault()).ToList();


            var termLoanData = dataTermLoans.OrderByDescending(x => x.approvalDate).Take(50);
            var revolvingLoanData = dataRevolvingLoans.OrderByDescending(x => x.approvalDate).Take(50);
            var contingentLoanData = dataContingentLoans.OrderByDescending(x => x.approvalDate).Take(50);
            var unionAll = termLoanData.Union(revolvingLoanData);

            var data = unionAll.Union(contingentLoanData);

            allLoans = data.OrderByDescending(x => x.approvalDate).ToList();
            return allLoans;

        }


        public IEnumerable<CamProcessedLoanViewModel> GetAllCompletedLoanOperationDocumentationLos(int staffId, int companyId, DateTime startDate, DateTime endDate)
        {
            var staff = context.TBL_STAFF.Find(staffId);
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();
            //var activities = admin.GetUserActivitiesByUser(staffRec.USERID);

            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            List<int> loanOperationIds = new List<int>();
            List<int> contingentOperationIds = new List<int>();
            List<int> RevolvingOperationIds = new List<int>();

            loanOperationIds.Add((int)OperationsEnum.TermLoanBooking);
            loanOperationIds.Add((int)OperationsEnum.CommercialLoanBooking);
            loanOperationIds.Add((int)OperationsEnum.ForeignExchangeLoanBooking);
            contingentOperationIds.Add((int)OperationsEnum.ContigentLoanBooking);
            RevolvingOperationIds.Add((int)OperationsEnum.RevolvingLoanBooking);


            var staffs = generalSetup.GetStaffRlieved(staffId);

            List<int> levelIds = new List<int>();
            foreach (var i in loanOperationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList());
            }
            foreach (var i in contingentOperationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList());
            }
            foreach (var i in RevolvingOperationIds)
            {
                levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList());
            }

            //var company = context.TBL_COMPANY.Find(companyId);
            IEnumerable<CamProcessedLoanViewModel> allLoans = null;

            var dataTermLoans = (from a in context.TBL_LOAN
                                 join cd in context.TBL_DOCUMENTATION_FILLING_APPROVAL on a.TERMLOANID equals cd.LOANID
                                 join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals s.LOAN_BOOKING_REQUESTID
                                 join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                 join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                 join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                 join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                 join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                 join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                 where m.COMPANYID == companyId
                                 && s.DELETED == false
                                 && a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                 && a.ISPRINTED == true
                                 && a.ISDISBURSED == true
                                 && loanOperationIds.Contains(atrail.OPERATIONID)
                                 && (a.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                  && ((!levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                  || (levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing)))
                                  && cd.MODULE == "LOS"
                                && cd.LOANREFERENCE == a.LOANREFERENCENUMBER
                                && (DbFunctions.TruncateTime(cd.DATETIMECREATED) >= DbFunctions.TruncateTime(startDate) && DbFunctions.TruncateTime(cd.DATETIMECREATED) <= DbFunctions.TruncateTime(endDate))
                                && cd.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                                 orderby a.DATEAPPROVED descending
                                 select new CamProcessedLoanViewModel()
                                 {
                                     bookingAmountRequested = s.AMOUNT_REQUESTED,
                                     loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                     amountDisbursed = a.PRINCIPALAMOUNT,
                                     bookingRequestStatusId = s.APPROVALSTATUSID,
                                     isLineFacility = d.ISLINEFACILITY,
                                     loanId = a.TERMLOANID,
                                     approvalDate = a.DATEAPPROVED,
                                     loanReferenceNumber = a.LOANREFERENCENUMBER,
                                     isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                     isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                     requestDate = s.DATETIMECREATED,
                                     requestedBy = "",
                                     systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                     operationId = s.OPERATIONID,
                                     appraisalOperationId = m.OPERATIONID,
                                     crmsCode = s.CRMSCODE,
                                     requestedAmount = s.AMOUNT_REQUESTED,
                                     requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                     approvalStatusId = atrail.APPROVALSTATUSID,
                                     approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                     loanApplicationId = m.LOANAPPLICATIONID,
                                     flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == a.TERMLOANID && d.MODULE.ToLower() == "los").Select(d => d.LOANID).FirstOrDefault(),

                                     loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                     applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                     applicationStatusId = m.APPLICATIONSTATUSID,
                                     divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                     customerId = d.CUSTOMERID,
                                     customerCode = cust.CUSTOMERCODE,
                                     customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                     customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                     customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                     customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                     customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                     applicationTenor = m.APPLICATIONTENOR,
                                     effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                     expiryDate = (DateTime)d.EXPIRYDATE,
                                     currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                     currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                     exchangeRate = d.EXCHANGERATE,
                                     loanTypeId = m.LOANAPPLICATIONTYPEID,
                                     loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                     productId = s.PRODUCTID,
                                     productTypeId = p.PRODUCTTYPEID,
                                     productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                     productTypeName = pt.PRODUCTTYPENAME,
                                     productName = p.PRODUCTNAME,
                                     casaAccountId = s.CASAACCOUNTID,
                                     casaAccountId2 = s.CASAACCOUNTID2,
                                     productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                     divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                     interestRate = d.APPROVEDINTERESTRATE,
                                     approvedInterestRate = d.APPROVEDINTERESTRATE,
                                     approvedAmount = d.APPROVEDAMOUNT,
                                     groupApprovedAmount = m.APPROVEDAMOUNT,
                                     availmentDate = m.AVAILMENTDATE,
                                     approvedTenor = d.APPROVEDTENOR,
                                     toStaffId = atrail.TOSTAFFID,
                                     requestStaffId = atrail.REQUESTSTAFFID,
                                     isInEditMode = s.ISUSED ?? false,
                                     isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                     approvalTrailId = atrail.APPROVALTRAILID,
                                     responseStaffId = atrail.RESPONSESTAFFID
                                 }).GroupBy(l => l.loanId).Select(s => s.OrderByDescending(o => o.approvalTrailId).FirstOrDefault()).ToList();

            var dataRevolvingLoans = (from a in context.TBL_LOAN_REVOLVING
                                      join cd in context.TBL_DOCUMENTATION_FILLING_APPROVAL on a.REVOLVINGLOANID equals cd.LOANID
                                      join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals s.LOAN_BOOKING_REQUESTID
                                      join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                      join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                      join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                      join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                      join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                      join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                      where m.COMPANYID == companyId
                                      && s.DELETED == false
                                      && (a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                                      && a.ISPRINTED == true
                                      && RevolvingOperationIds.Contains(atrail.OPERATIONID)
                                      && (a.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                      && a.ISDISBURSED == true
                                      && ((!levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                      || (levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing)))
                                      && cd.MODULE == "LOS"
                                    && cd.LOANREFERENCE == a.LOANREFERENCENUMBER
                                    && (DbFunctions.TruncateTime(cd.DATETIMECREATED) >= DbFunctions.TruncateTime(startDate) && DbFunctions.TruncateTime(cd.DATETIMECREATED) <= DbFunctions.TruncateTime(endDate))
                                    && cd.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                                      orderby a.DATEAPPROVED descending
                                      select new CamProcessedLoanViewModel()
                                      {
                                          bookingAmountRequested = s.AMOUNT_REQUESTED,
                                          loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                          amountDisbursed = a.OVERDRAFTLIMIT,
                                          bookingRequestStatusId = s.APPROVALSTATUSID,
                                          isLineFacility = d.ISLINEFACILITY,
                                          loanReferenceNumber = a.LOANREFERENCENUMBER,
                                          isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                          isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                          requestDate = s.DATETIMECREATED,
                                          requestedBy = "",
                                          loanId = a.REVOLVINGLOANID,
                                          approvalDate = a.DATEAPPROVED,
                                          systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                          operationId = s.OPERATIONID,
                                          appraisalOperationId = m.OPERATIONID,
                                          crmsCode = s.CRMSCODE,
                                          requestedAmount = s.AMOUNT_REQUESTED,
                                          requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                          approvalStatusId = atrail.APPROVALSTATUSID,
                                          approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                          loanApplicationId = m.LOANAPPLICATIONID,

                                          loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                          applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                          applicationStatusId = m.APPLICATIONSTATUSID,
                                          divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                          customerId = d.CUSTOMERID,
                                          customerCode = cust.CUSTOMERCODE,
                                          customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                          customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                          customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                          customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                          customerType = cust.TBL_CUSTOMER_TYPE.NAME,
                                          flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == a.REVOLVINGLOANID && d.MODULE.ToLower() == "los").Select(d => d.LOANID).FirstOrDefault(),

                                          applicationTenor = m.APPLICATIONTENOR,
                                          effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                          expiryDate = (DateTime)d.EXPIRYDATE,
                                          currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                          currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                          exchangeRate = d.EXCHANGERATE,
                                          loanTypeId = m.LOANAPPLICATIONTYPEID,
                                          loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                          productId = s.PRODUCTID,
                                          productTypeId = p.PRODUCTTYPEID,
                                          productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                          productTypeName = pt.PRODUCTTYPENAME,
                                          productName = p.PRODUCTNAME,
                                          casaAccountId = s.CASAACCOUNTID,
                                          casaAccountId2 = s.CASAACCOUNTID2,
                                          productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                          divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                          interestRate = d.APPROVEDINTERESTRATE,
                                          approvedInterestRate = d.APPROVEDINTERESTRATE,
                                          approvedAmount = d.APPROVEDAMOUNT,
                                          groupApprovedAmount = m.APPROVEDAMOUNT,
                                          availmentDate = m.AVAILMENTDATE,
                                          approvedTenor = d.APPROVEDTENOR,
                                          toStaffId = atrail.TOSTAFFID,
                                          requestStaffId = atrail.REQUESTSTAFFID,
                                          isInEditMode = s.ISUSED ?? false,
                                          isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                          approvalTrailId = atrail.APPROVALTRAILID,
                                          responseStaffId = atrail.RESPONSESTAFFID
                                      }).GroupBy(l => l.loanId).Select(s => s.OrderByDescending(o => o.approvalTrailId).FirstOrDefault()).ToList();

            var dataContingentLoans = (from a in context.TBL_LOAN_CONTINGENT
                                       join cd in context.TBL_DOCUMENTATION_FILLING_APPROVAL on a.CONTINGENTLOANID equals cd.LOANID
                                       join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals s.LOAN_BOOKING_REQUESTID
                                       join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                       join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                       join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                       join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                       join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                       join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                       where m.COMPANYID == companyId
                                       && s.DELETED == false
                                       && (a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                                       && a.ISPRINTED == true
                                       && contingentOperationIds.Contains(atrail.OPERATIONID)
                                       && (a.LOANSTATUSID != (int)LoanStatusEnum.Inactive)
                                       && a.ISDISBURSED == true
                                       && ((!levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                       || (levelIds.Contains((int)atrail.TOAPPROVALLEVELID) && (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing)))
                                       && cd.MODULE == "LOS"
                                        && cd.LOANREFERENCE == a.LOANREFERENCENUMBER
                                        && (DbFunctions.TruncateTime(cd.DATETIMECREATED) >= DbFunctions.TruncateTime(startDate) && DbFunctions.TruncateTime(cd.DATETIMECREATED) <= DbFunctions.TruncateTime(endDate))
                                        && cd.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                                       orderby a.DATEAPPROVED descending
                                       select new CamProcessedLoanViewModel()
                                       {
                                           bookingAmountRequested = s.AMOUNT_REQUESTED,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                           amountDisbursed = a.CONTINGENTAMOUNT,
                                           bookingRequestStatusId = s.APPROVALSTATUSID,
                                           isLineFacility = d.ISLINEFACILITY,
                                           isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                           isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                           requestDate = s.DATETIMECREATED,
                                           requestedBy = "",
                                           systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                           operationId = s.OPERATIONID,
                                           appraisalOperationId = m.OPERATIONID,
                                           crmsCode = s.CRMSCODE,
                                           loanId = a.CONTINGENTLOANID,
                                           approvalDate = a.DATEAPPROVED,
                                           requestedAmount = s.AMOUNT_REQUESTED,
                                           requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                           approvalStatusId = atrail.APPROVALSTATUSID,
                                           approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                           loanApplicationId = m.LOANAPPLICATIONID,
                                           flagStatus = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(d => d.LOANID == a.CONTINGENTLOANID && d.MODULE.ToLower() == "los").Select(d => d.LOANID).FirstOrDefault(),

                                           loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                           applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                           applicationStatusId = m.APPLICATIONSTATUSID,
                                           divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                           customerId = d.CUSTOMERID,
                                           customerCode = cust.CUSTOMERCODE,
                                           customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                           customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                           customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                           customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                           customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                           applicationTenor = m.APPLICATIONTENOR,
                                           effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                           expiryDate = (DateTime)d.EXPIRYDATE,
                                           currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                           currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                           exchangeRate = d.EXCHANGERATE,
                                           loanTypeId = m.LOANAPPLICATIONTYPEID,
                                           loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                           productId = s.PRODUCTID,
                                           productTypeId = p.PRODUCTTYPEID,
                                           productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                           productTypeName = pt.PRODUCTTYPENAME,
                                           productName = p.PRODUCTNAME,
                                           casaAccountId = s.CASAACCOUNTID,
                                           casaAccountId2 = s.CASAACCOUNTID2,
                                           productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                           divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                           interestRate = d.APPROVEDINTERESTRATE,
                                           approvedInterestRate = d.APPROVEDINTERESTRATE,
                                           approvedAmount = d.APPROVEDAMOUNT,
                                           groupApprovedAmount = m.APPROVEDAMOUNT,
                                           availmentDate = m.AVAILMENTDATE,
                                           approvedTenor = d.APPROVEDTENOR,
                                           toStaffId = atrail.TOSTAFFID,
                                           requestStaffId = atrail.REQUESTSTAFFID,
                                           isInEditMode = s.ISUSED ?? false,
                                           isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                           approvalTrailId = atrail.APPROVALTRAILID,
                                           responseStaffId = atrail.RESPONSESTAFFID
                                       }).GroupBy(l => l.loanId).Select(s => s.OrderByDescending(o => o.approvalTrailId).FirstOrDefault()).ToList();


            var termLoanData = dataTermLoans.OrderByDescending(x => x.approvalDate);
            var revolvingLoanData = dataRevolvingLoans.OrderByDescending(x => x.approvalDate);
            var contingentLoanData = dataContingentLoans.OrderByDescending(x => x.approvalDate);
            var unionAll = termLoanData.Union(revolvingLoanData);

            var data = unionAll.Union(contingentLoanData);

            allLoans = data.OrderByDescending(x => x.approvalDate).ToList();
            return allLoans;

        }


        public IEnumerable<CamProcessedLoanViewModel> GetLoanOperationDocumentationLosApproval(int staffId, int companyId)
        {
            
            IEnumerable<CamProcessedLoanViewModel> allLoans = null;

            var dataTermLoans = (from b in context.TBL_DOCUMENTATION_FILLING_APPROVAL
                                 join a in context.TBL_LOAN on b.LOANREFERENCE equals a.LOANREFERENCENUMBER
                                 join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOANAPPLICATIONDETAILID equals s.LOANAPPLICATIONDETAILID
                                 join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                 join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                 join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                 join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                 join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                 join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                 where 
                                 b.APPROVALSTATUSID != (short)ApprovalStatusEnum.Approved
                                 && a.ISPRINTED == false
                                 
                                 orderby a.DATEAPPROVED descending
                                 select new CamProcessedLoanViewModel()
                                 {
                                     module = b.MODULE,
                                     loanReferenceNumber = a.LOANREFERENCENUMBER,
                                     fillingRequestDate = b.DATETIMECREATED,
                                     documentationFillingId = b.DOCUMENTATIONFILLINGID,
                                     bookingAmountRequested = s.AMOUNT_REQUESTED,
                                     loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                     bookingRequestStatusId = s.APPROVALSTATUSID,
                                     isLineFacility = d.ISLINEFACILITY,
                                     loanId = a.TERMLOANID,
                                     isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                     isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                     requestDate = s.DATETIMECREATED,
                                     requestedBy = "",
                                     systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                     operationId = s.OPERATIONID,
                                     appraisalOperationId = m.OPERATIONID,
                                     crmsCode = s.CRMSCODE,
                                     requestedAmount = s.AMOUNT_REQUESTED,
                                     requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                     approvalStatusId = atrail.APPROVALSTATUSID,
                                     approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),
                                     loanApplicationId = m.LOANAPPLICATIONID,

                                     loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                     applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                     applicationStatusId = m.APPLICATIONSTATUSID,
                                     divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                     divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                     customerId = d.CUSTOMERID,
                                     customerCode = cust.CUSTOMERCODE,
                                     customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                     customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                     customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                     customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                     customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                     applicationTenor = m.APPLICATIONTENOR,
                                     effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                     expiryDate = (DateTime)d.EXPIRYDATE,
                                     currencyId = d.CURRENCYID, 
                                     currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                     exchangeRate = d.EXCHANGERATE,
                                     loanTypeId = m.LOANAPPLICATIONTYPEID,
                                     loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                     productId = s.PRODUCTID,
                                     productTypeId = p.PRODUCTTYPEID,
                                     productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                     productTypeName = pt.PRODUCTTYPENAME,
                                     productName = p.PRODUCTNAME,
                                     casaAccountId = s.CASAACCOUNTID,
                                     casaAccountId2 = s.CASAACCOUNTID2,
                                     productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                     interestRate = d.APPROVEDINTERESTRATE,
                                     approvedInterestRate = d.APPROVEDINTERESTRATE,
                                     approvedAmount = d.APPROVEDAMOUNT,
                                     groupApprovedAmount = m.APPROVEDAMOUNT,
                                     availmentDate = m.AVAILMENTDATE,
                                     approvedTenor = d.APPROVEDTENOR,
                                     toStaffId = atrail.TOSTAFFID,
                                     requestStaffId = atrail.REQUESTSTAFFID,
                                     isInEditMode = s.ISUSED ?? false,
                                     approvalTrailId = atrail.APPROVALTRAILID,
                                     responseStaffId = atrail.RESPONSESTAFFID
                                 }).ToList().Take(50);

            var dataRevolvingLoans = (from b in context.TBL_DOCUMENTATION_FILLING_APPROVAL
                                      join a in context.TBL_LOAN_REVOLVING on b.LOANREFERENCE equals a.LOANREFERENCENUMBER
                                      join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOANAPPLICATIONDETAILID equals s.LOANAPPLICATIONDETAILID
                                      join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                      join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                      join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                      join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                      join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                      join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                      where 
                                      b.APPROVALSTATUSID != (short)ApprovalStatusEnum.Approved
                                      && a.ISPRINTED == false
                                      

                                      orderby a.DATEAPPROVED descending
                                      select new CamProcessedLoanViewModel()
                                      {
                                          fillingRequestDate = b.DATETIMECREATED,
                                          module = b.MODULE,
                                          loanReferenceNumber = a.LOANREFERENCENUMBER,
                                          documentationFillingId = b.DOCUMENTATIONFILLINGID,
                                          bookingAmountRequested = s.AMOUNT_REQUESTED,
                                          loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                          bookingRequestStatusId = s.APPROVALSTATUSID,
                                          isLineFacility = d.ISLINEFACILITY,
                                          isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                          isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                          requestDate = s.DATETIMECREATED,
                                          requestedBy = "",
                                          loanId = a.REVOLVINGLOANID,
                                          systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                          operationId = s.OPERATIONID,
                                          appraisalOperationId = m.OPERATIONID,
                                          crmsCode = s.CRMSCODE,
                                          requestedAmount = s.AMOUNT_REQUESTED,
                                          requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                          approvalStatusId = atrail.APPROVALSTATUSID,
                                          approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                          loanApplicationId = m.LOANAPPLICATIONID,

                                          loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                          applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                          applicationStatusId = m.APPLICATIONSTATUSID,
                                          divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                          customerId = d.CUSTOMERID,
                                          customerCode = cust.CUSTOMERCODE,
                                          customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                          customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                          customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                          customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                          customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                          applicationTenor = m.APPLICATIONTENOR,
                                          effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                          expiryDate = (DateTime)d.EXPIRYDATE,
                                          currencyId = d.CURRENCYID, 
                                          currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                          exchangeRate = d.EXCHANGERATE,
                                          loanTypeId = m.LOANAPPLICATIONTYPEID,
                                          loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                          productId = s.PRODUCTID,
                                          productTypeId = p.PRODUCTTYPEID,
                                          productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                          productTypeName = pt.PRODUCTTYPENAME,
                                          productName = p.PRODUCTNAME,
                                          casaAccountId = s.CASAACCOUNTID,
                                          casaAccountId2 = s.CASAACCOUNTID2,
                                          productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                          divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                          interestRate = d.APPROVEDINTERESTRATE,
                                          approvedInterestRate = d.APPROVEDINTERESTRATE,
                                          approvedAmount = d.APPROVEDAMOUNT,
                                          groupApprovedAmount = m.APPROVEDAMOUNT,
                                          availmentDate = m.AVAILMENTDATE,
                                          approvedTenor = d.APPROVEDTENOR,
                                          toStaffId = atrail.TOSTAFFID,
                                          requestStaffId = atrail.REQUESTSTAFFID,
                                          isInEditMode = s.ISUSED ?? false,
                                          
                                          approvalTrailId = atrail.APPROVALTRAILID,
                                          responseStaffId = atrail.RESPONSESTAFFID
                                      }).ToList().Take(50);

            var dataContingentLoans = (from b in context.TBL_DOCUMENTATION_FILLING_APPROVAL
                                       join a in context.TBL_LOAN_CONTINGENT on b.LOANREFERENCE equals a.LOANREFERENCENUMBER
                                       join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOANAPPLICATIONDETAILID equals s.LOANAPPLICATIONDETAILID
                                       join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                       join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                       join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                       join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                       join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                       join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                       where 
                                       b.APPROVALSTATUSID != (short)ApprovalStatusEnum.Approved
                                       && a.ISPRINTED == false


                                       orderby a.DATEAPPROVED descending
                                       select new CamProcessedLoanViewModel()
                                       {
                                           module = b.MODULE,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           fillingRequestDate = b.DATETIMECREATED,
                                           documentationFillingId = b.DOCUMENTATIONFILLINGID,
                                           bookingAmountRequested = s.AMOUNT_REQUESTED,
                                           loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                           bookingRequestStatusId = s.APPROVALSTATUSID,
                                           isLineFacility = d.ISLINEFACILITY,
                                           isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                           isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                           requestDate = s.DATETIMECREATED,
                                           requestedBy = "",
                                           systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                           operationId = s.OPERATIONID,
                                           appraisalOperationId = m.OPERATIONID,
                                           crmsCode = s.CRMSCODE,
                                           loanId = a.CONTINGENTLOANID,
                                           requestedAmount = s.AMOUNT_REQUESTED,
                                           requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                           approvalStatusId = atrail.APPROVALSTATUSID,
                                           approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                           loanApplicationId = m.LOANAPPLICATIONID,

                                           loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                           applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                           applicationStatusId = m.APPLICATIONSTATUSID,
                                           divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                           customerId = d.CUSTOMERID,
                                           customerCode = cust.CUSTOMERCODE,
                                           customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                           customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                           customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                           customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                           customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                           applicationTenor = m.APPLICATIONTENOR,
                                           effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                           expiryDate = (DateTime)d.EXPIRYDATE,
                                           currencyId = d.CURRENCYID, 
                                           currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                           exchangeRate = d.EXCHANGERATE,
                                           loanTypeId = m.LOANAPPLICATIONTYPEID,
                                           loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                           productId = s.PRODUCTID,
                                           productTypeId = p.PRODUCTTYPEID,
                                           productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                           productTypeName = pt.PRODUCTTYPENAME,
                                           productName = p.PRODUCTNAME,
                                           casaAccountId = s.CASAACCOUNTID,
                                           casaAccountId2 = s.CASAACCOUNTID2,
                                           productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                           divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                           interestRate = d.APPROVEDINTERESTRATE,
                                           approvedInterestRate = d.APPROVEDINTERESTRATE,
                                           approvedAmount = d.APPROVEDAMOUNT,
                                           groupApprovedAmount = m.APPROVEDAMOUNT,
                                           availmentDate = m.AVAILMENTDATE,
                                           approvedTenor = d.APPROVEDTENOR,
                                           toStaffId = atrail.TOSTAFFID,
                                           requestStaffId = atrail.REQUESTSTAFFID,
                                           isInEditMode = s.ISUSED ?? false,
                                           approvalTrailId = atrail.APPROVALTRAILID,
                                           responseStaffId = atrail.RESPONSESTAFFID
                                       }).ToList().Take(50);


            var termLoanData = dataTermLoans.GroupBy(x => x.applicationReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.approvalDate);
            var revolvingLoanData = dataRevolvingLoans.GroupBy(x => x.applicationReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.approvalDate);
            var contingentLoanData = dataContingentLoans.GroupBy(x => x.applicationReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.approvalDate);
            var unionAll = termLoanData.Union(revolvingLoanData);

            var data = unionAll.Union(contingentLoanData);
            allLoans = data.ToList();
            return allLoans;

        }


        public IEnumerable<MultipleInsuranceOutputApprovalViewModel> GetBulkInsuranceUploadAwaitingApproval(int staffId, int companyId)
        {

            IEnumerable<MultipleInsuranceOutputApprovalViewModel> allRecords = null;

            var records = (from b in context.TBL_BULK_INSURANCE_UPLOAD_APPROVAL
                                 join a in context.TEMP_COLLATERAL_INSURANCE_TRACKING on b.BATCHCODE equals a.BATCHCODE
                                 join atrail in context.TBL_APPROVAL_TRAIL on b.BULKINSURANCEUPLOADAPPROVALID equals atrail.TARGETID
                                 where
                                 b.APPROVALSTATUSID != (short)ApprovalStatusEnum.Approved
                                 && b.APPROVALSTATUSID != (short)ApprovalStatusEnum.Disapproved
                                 //&& a.ISCOLLATERAL == false
                                 && a.VALIDITYSTATUS == true

                                 orderby b.REQUESTDATE descending
                                 select new MultipleInsuranceOutputApprovalViewModel()
                                 {
                                     targetId = atrail.TARGETID,
                                     collateralInsuranceTrackingId = a.COLLATERALINSURANCETRACKINGID,
                                     customerCode = a.CUSTOMERCODE,
                                     collateralCode = a.COLLATERALCODE,
                                     customerId = a.CUSTOMERCODE,
                                     isCollaterals = a.ISCOLLATERAL,
                                     collateralDescription = a.COLLATERALDESCRIPTION,
                                     bulkInsuranceUploadApprovalId = b.BULKINSURANCEUPLOADAPPROVALID,
                                     systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                     operationId = b.OPERATIONID,
                                     insuranceCompanyId = a.INSURANCECOMPANYID,
                                     companyAddress = a.ISURANCECOMPANYADDRESS,
                                     referenceNumber = a.POLICYNUMBER,
                                     startDate = a.INSURANCESTARTDATE,
                                     expiryDate = a.INSURANCEENDDATE,
                                     sumInsured = a.SUMINSURED,
                                     premiumAmount = a.PREMIUMPAID,
                                     insuranceStatus = (int)a.INSURANCESTATUSID,
                                     collateralCustomerId = a.COLLATERALCUSTOMERID,
                                     loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                     valuationStartDate = a.VALUATIONSTARTDATE,
                                     valuationEndDate = a.VALUATIONENDDATE,
                                     openMarketValue = a.OMV,
                                     forcedSaleValue = a.FSV,
                                     valuerId = a.VALUERID,
                                     collateralDetails = a.COLLATERALDETAILS,
                                     insurancePolicyTypeId = a.INSURANCEPOLICYTYPEID,
                                     otherValuer = a.OTHERVALUER,
                                     otherInsuranceCompany = a.OTHERINSURANCECOMPANY,
                                     otherInsurancePolicyType = a.OTHERINSURANCEPOLICYTYPE,
                                     collateralTypeId = a.COLLATERALTYPE,
                                     collateralSubTypeId = a.COLLATERALSUBTYPE,
                                     gpsCoordinates = a.GPSCOORDINATES,
                                     firstLossPayee = a.FIRSTLOSSPAYEE,
                                     comment = a.COMMENT,
                                     dateTimeCreated = (DateTime)a.DATETIMECREATED,
                                     createdBy = (int)a.CREATEDBY,
                                     batchCode = a.BATCHCODE,
                                     toStaffId = atrail.TOSTAFFID,
                                     requestStaffId = atrail.REQUESTSTAFFID,
                                     approvalTrailId = atrail.APPROVALTRAILID,
                                     responseStaffId = atrail.RESPONSESTAFFID,
                                     requestOperationId = (int)OperationsEnum.InsuranceBulkUploadApproval,
                                     approvalStatusId = atrail.APPROVALSTATUSID,
                                     approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == b.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),

                                 }).ToList();
            foreach(var i in records)
            {
                if (i.isCollaterals == false)
                {
                    i.insuranceCompany = i.insuranceCompanyId > 0 ? context.TBL_INSURANCE_COMPANY.Where(x => x.INSURANCECOMPANYID == i.insuranceCompanyId).Select(x => x.COMPANYNAME).FirstOrDefault() : i.otherInsuranceCompany;
                    i.policyType = i.insurancePolicyTypeId > 0 ? context.TBL_INSURANCE_POLICY_TYPE.Where(x => x.POLICYTYPEID == i.insurancePolicyTypeId).Select(x => x.DESCRIPTION).FirstOrDefault() : i.otherInsurancePolicyType;
                    i.iCustomerId = context.TBL_COLLATERAL_CUSTOMER.Where(x => x.COLLATERALCUSTOMERID == i.collateralCustomerId).Select(x => x.CUSTOMERID).FirstOrDefault();
                }
                else
                {
                    i.insuranceCompany = i.insuranceCompanyId > 0 ? context.TBL_INSURANCE_COMPANY.Where(x => x.INSURANCECOMPANYID == i.insuranceCompanyId).Select(x => x.COMPANYNAME).FirstOrDefault() : i.otherInsuranceCompany;
                    i.policyType = i.insurancePolicyTypeId > 0 ? context.TBL_INSURANCE_POLICY_TYPE.Where(x => x.POLICYTYPEID == i.insurancePolicyTypeId).Select(x => x.DESCRIPTION).FirstOrDefault() : i.otherInsurancePolicyType;
                    i.iCustomerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == i.customerCode).Select(x => x.CUSTOMERID).FirstOrDefault();
                }
            }

            var data = records.GroupBy(x => x.referenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.systemArrivalDateTime);

            allRecords = data.ToList();
            return allRecords;

        }

        public IEnumerable<MultipleInsuranceOutputApprovalViewModel> GetBulkInsuranceUploadRejectedApproval(int staffId, int companyId)
        {

            IEnumerable<MultipleInsuranceOutputApprovalViewModel> allRecords = null;

            var records = (from b in context.TBL_BULK_INSURANCE_UPLOAD_APPROVAL
                           join a in context.TEMP_COLLATERAL_INSURANCE_TRACKING on b.BATCHCODE equals a.BATCHCODE
                           join atrail in context.TBL_APPROVAL_TRAIL on b.BULKINSURANCEUPLOADAPPROVALID equals atrail.TARGETID
                           where
                           b.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved
                           || a.ISCOLLATERAL == true

                           orderby b.REQUESTDATE descending
                           select new MultipleInsuranceOutputApprovalViewModel()
                           {
                               bulkInsuranceUploadApprovalId = b.BULKINSURANCEUPLOADAPPROVALID,
                               systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                               operationId = b.OPERATIONID,
                               insuranceCompanyId = a.INSURANCECOMPANYID,
                               companyAddress = a.ISURANCECOMPANYADDRESS,
                               referenceNumber = a.POLICYNUMBER,
                               startDate = a.INSURANCESTARTDATE,
                               expiryDate = a.INSURANCEENDDATE,
                               sumInsured = a.SUMINSURED,
                               premiumAmount = a.PREMIUMPAID,
                               insuranceStatus = (int)a.INSURANCESTATUSID,
                               collateralCustomerId = a.COLLATERALCUSTOMERID,
                               loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                               valuationStartDate = a.VALUATIONSTARTDATE,
                               valuationEndDate = a.VALUATIONENDDATE,
                               openMarketValue = a.OMV,
                               forcedSaleValue = a.FSV,
                               valuerId = a.VALUERID,
                               collateralDetails = a.COLLATERALDETAILS,
                               insurancePolicyTypeId = a.INSURANCEPOLICYTYPEID,
                               otherValuer = a.OTHERVALUER,
                               otherInsuranceCompany = a.OTHERINSURANCECOMPANY,
                               otherInsurancePolicyType = a.OTHERINSURANCEPOLICYTYPE,
                               collateralTypeId = a.COLLATERALTYPE,
                               collateralSubTypeId = a.COLLATERALSUBTYPE,
                               gpsCoordinates = a.GPSCOORDINATES,
                               firstLossPayee = a.FIRSTLOSSPAYEE,
                               comment = a.COMMENT,
                               dateTimeCreated = (DateTime)a.DATETIMECREATED,
                               createdBy = (int)a.CREATEDBY,
                               batchCode = a.BATCHCODE,
                               toStaffId = atrail.TOSTAFFID,
                               requestStaffId = atrail.REQUESTSTAFFID,
                               approvalTrailId = atrail.APPROVALTRAILID,
                               responseStaffId = atrail.RESPONSESTAFFID,
                               requestOperationId = (int)OperationsEnum.InsuranceBulkUploadApproval,
                               approvalStatusId = atrail.APPROVALSTATUSID,
                               approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == b.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),
                               isCollateral = a.ISCOLLATERAL == true ? "Yes" : "No",
                               validityStatus = a.VALIDITYSTATUS == true ? "passed" : "failed"
                           }).ToList();
            foreach (var i in records)
            {
                i.insuranceCompany = i.insuranceCompanyId > 0 ? context.TBL_INSURANCE_COMPANY.Where(x => x.INSURANCECOMPANYID == i.insuranceCompanyId).Select(x => x.COMPANYNAME).FirstOrDefault() : i.otherInsuranceCompany;
                i.policyType = i.insurancePolicyTypeId > 0 ? context.TBL_INSURANCE_POLICY_TYPE.Where(x => x.POLICYTYPEID == i.insurancePolicyTypeId).Select(x => x.DESCRIPTION).FirstOrDefault() : i.otherInsurancePolicyType;
                i.collateralCode = context.TBL_COLLATERAL_CUSTOMER.Where(x => x.COLLATERALCUSTOMERID == i.collateralCustomerId).Select(x => x.COLLATERALCODE).FirstOrDefault();
                i.iCustomerId = context.TBL_COLLATERAL_CUSTOMER.Where(x => x.COLLATERALCUSTOMERID == i.collateralCustomerId).Select(x => x.CUSTOMERID).FirstOrDefault();
                i.customerId = context.TBL_COLLATERAL_CUSTOMER.Where(x => x.COLLATERALCUSTOMERID == i.collateralCustomerId).Select(x => x.CUSTOMERCODE).FirstOrDefault();
            }

            var data = records.GroupBy(x => x.referenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.systemArrivalDateTime);

            allRecords = data.ToList();
            return allRecords;

        }


        public IEnumerable<LoanReviewOperationApprovalViewModel> GetAllLoansOperationWriteOffAnalysis(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var dataLoan = (from ln in context.TBL_LOAN
                            join op in context.TBL_LOAN_REVIEW_OPERATION on ln.TERMLOANID equals op.LOANID
                            join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            ln.LOANSTATUSID == (int)LoanStatusEnum.WriteOff

                            orderby op.DATECREATED descending
                            select new LoanReviewOperationApprovalViewModel
                            {
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),
                                loanApplicationDetailId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANREVIEWAPPLICATIONID).FirstOrDefault(),
                                appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                prepaymentAmount = op.PREPAYMENT,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                  join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                  where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                  select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL, 
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = op.APPROVALSTATUSID,
                                approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                productAccountNumber = ch.ACCOUNTCODE,
                                productAccountName = ch.ACCOUNTNAME,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                operationTypeId = op.OPERATIONTYPEID,
                                operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                newEffectiveDate = op.EFFECTIVEDATE,
                                reviewDetails = op.REVIEWDETAILS,
                                prepayment = op.PREPAYMENT,
                                newInterateRate = op.INTERATERATE,
                                newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                newTenor = op.TENOR,
                                cASA_AccountId = op.CASA_ACCOUNTID,
                                cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                overDraftTopup = op.OVERDRAFTTOPUP,
                                fee_Charges = op.FEE_CHARGES,
                                scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                newMaturityDate = op.MATURITYDATE,
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                dateTimeCreated = op.DATECREATED,
                                fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                {
                                    chargeFeeId = mp.CHARGEFEEID,
                                    feeAmount = mp.FEEAMOUNT,
                                    description = mp.DESCRIPTION,
                                    casaAccount = mp.CASAACCOUNTID,
                                    loanChargeFeeId = mp.LOANCHARGEFEEID,
                                    chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                    casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                }).ToList(),
                            }).ToList();

            var dataRevolvingLoan = (from ln in context.TBL_LOAN_REVOLVING
                                     join op in context.TBL_LOAN_REVIEW_OPERATION on ln.REVOLVINGLOANID equals op.LOANID
                                     join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                     join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     ln.LOANSTATUSID == (int)LoanStatusEnum.WriteOff

                                     orderby op.DATECREATED descending
                                     select new LoanReviewOperationApprovalViewModel
                                     {
                                         loanApplicationDetailId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANREVIEWAPPLICATIONID).FirstOrDefault(),
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                         lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                         loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                         appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                         customerId = ln.CUSTOMERID,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         prepaymentAmount = op.PREPAYMENT,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                           join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                           where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                           select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvalStatusId = op.APPROVALSTATUSID,
                                         approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         operationTypeId = op.OPERATIONTYPEID,
                                         operationTypeName = tt.OPERATIONNAME,
                                         newEffectiveDate = op.EFFECTIVEDATE,
                                         reviewDetails = op.REVIEWDETAILS,
                                         prepayment = op.PREPAYMENT,
                                         newInterateRate = op.INTERATERATE,
                                         newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                         newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                         newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                         newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newTenor = op.TENOR,
                                         cASA_AccountId = op.CASA_ACCOUNTID,
                                         cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         overDraftTopup = op.OVERDRAFTTOPUP,
                                         fee_Charges = op.FEE_CHARGES,
                                         scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                         scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                         scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                         scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                         scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                         newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                         newMaturityDate = op.MATURITYDATE,
                                         dateTimeCreated = op.DATECREATED,
                                         lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                         currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                         productAccountNumber = "N/A",
                                         productAccountName = "N/A",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                         fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                         {
                                             chargeFeeId = mp.CHARGEFEEID,
                                             feeAmount = mp.FEEAMOUNT,
                                             description = mp.DESCRIPTION,
                                             casaAccount = mp.CASAACCOUNTID,
                                             loanChargeFeeId = mp.LOANCHARGEFEEID,
                                             chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                             casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                         }).ToList(),
                                     }).ToList();


            var dataContingentLoan = (from ln in context.TBL_LOAN_CONTINGENT
                                      join op in context.TBL_LOAN_REVIEW_OPERATION on ln.CONTINGENTLOANID equals op.LOANID
                                      join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                      join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                      join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                      join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                      join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                      join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                      join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                      join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                      join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                      join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                      join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                                      where
                                      ln.LOANSTATUSID == (int)LoanStatusEnum.WriteOff

                                      orderby op.DATECREATED descending
                                      select new LoanReviewOperationApprovalViewModel
                                      {
                                          loanApplicationDetailId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANREVIEWAPPLICATIONID).FirstOrDefault(),
                                          creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                          creditAppraisalOperationId = lp.OPERATIONID,
                                          lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                          lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),

                                          loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                          appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                          loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                          loanId = ln.CONTINGENTLOANID,
                                          loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                          customerId = ln.CUSTOMERID,
                                          productId = ln.PRODUCTID,
                                          productTypeId = pr.PRODUCTTYPEID,
                                          productTypeName = context.TBL_PRODUCT_TYPE.Where(x => x.PRODUCTTYPEID == pr.PRODUCTTYPEID).Select(m => m.PRODUCTTYPENAME).FirstOrDefault(),
                                          casaAccountId = ln.CASAACCOUNTID,
                                          casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          branchId = ln.BRANCHID,
                                          lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                            join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                            where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                            select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),

                                          loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                          applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                          relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                          relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                          misCode = ln.MISCODE,
                                          teamMiscode = ln.TEAMMISCODE,
                                          principalAmount = ln.CONTINGENTAMOUNT,
                                          //interestRate = ln.INTERESTRATE,
                                          effectiveDate = ln.EFFECTIVEDATE,
                                          maturityDate = ln.MATURITYDATE,
                                          bookingDate = ln.BOOKINGDATE,
                                          approvalStatusId = op.APPROVALSTATUSID,
                                          approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                          approvedBy = (int)ln.APPROVEDBY,
                                          approverComment = ln.APPROVERCOMMENT,
                                          dateApproved = ln.DATEAPPROVED,
                                          loanStatusId = ln.LOANSTATUSID,
                                          isDisbursed = ln.ISDISBURSED,
                                          disburserComment = ln.DISBURSERCOMMENT,
                                          disburseDate = ln.DISBURSEDATE,
                                          customerGroupId = lp.CUSTOMERGROUPID,
                                          operationId = ln.OPERATIONID,
                                          loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                          subSectorId = ln.SUBSECTORID,
                                          subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                          sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                          dischargeLetter = ln.DISCHARGELETTER,
                                          //suspendInterest = ln.SUSPENDINTEREST,
                                          customerCode = cu.CUSTOMERCODE,
                                          loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                          customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                          currencyId = ln.CURRENCYID,
                                          currency = context.TBL_CURRENCY.Where(x => x.CURRENCYID == ln.CURRENCYID).Select(x => x.CURRENCYNAME).FirstOrDefault(),
                                          branchName = br.BRANCHNAME,
                                          relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                          relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                          productName = pr.PRODUCTNAME,
                                          comment = "",
                                          operationTypeId = op.OPERATIONTYPEID,
                                          operationTypeName = tt.OPERATIONNAME,
                                          newEffectiveDate = op.EFFECTIVEDATE,
                                          reviewDetails = op.REVIEWDETAILS,
                                          prepayment = op.PREPAYMENT,
                                          newInterateRate = op.INTERATERATE,
                                          newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                          newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                          newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                          newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newTenor = op.TENOR,
                                          cASA_AccountId = op.CASA_ACCOUNTID,
                                          cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                          cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          overDraftTopup = op.OVERDRAFTTOPUP,
                                          fee_Charges = op.FEE_CHARGES,
                                          scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                          scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                          scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                          scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                          scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                          newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                          newMaturityDate = op.MATURITYDATE,
                                          lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                          dateTimeCreated = op.DATECREATED,
                                          currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                          productAccountNumber = ch.ACCOUNTCODE,
                                          productAccountName = ch.ACCOUNTNAME,
                                          prepaymentAmount = op.PREPAYMENT,
                                          approvedAmount = ld.APPROVEDAMOUNT,
                                          creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                          fees = context.TBL_LOAN_FEE.Where(lop => lop.LOANREVIEWOPERATIONID == op.LOANREVIEWOPERATIONID).Select(mp => new feeDetails
                                          {
                                              chargeFeeId = mp.CHARGEFEEID,
                                              feeAmount = mp.FEEAMOUNT,
                                              description = mp.DESCRIPTION,
                                              casaAccount = mp.CASAACCOUNTID,
                                              loanChargeFeeId = mp.LOANCHARGEFEEID,
                                              chargeFeeName = mp.CHARGEFEEID < 0 ? "n/a" : context.TBL_CHARGE_FEE.Where(ch => ch.CHARGEFEEID == mp.CHARGEFEEID).Select(rc => rc.CHARGEFEENAME).FirstOrDefault(),
                                              casaAccountName = mp.CASAACCOUNTID < 0 ? "n/a" : context.TBL_CASA.Where(x => x.CASAACCOUNTID == mp.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER + "(" + x.PRODUCTACCOUNTNAME + "-" + x.TBL_CURRENCY.CURRENCYNAME + ")").FirstOrDefault(),

                                          }).ToList(),
                                      }).ToList();

            var termLoanData = dataLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var contingentLoanData = dataContingentLoan.GroupBy(x => x.loanReviewOperationsId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.dateTimeCreated);
            var unionAll = termLoanData.Union(revolvingLoanData);

            var data = unionAll.Union(contingentLoanData);

            return data;
        }


        public IEnumerable<GlobalExposureApplicationViewModel> GetLoanOperationRecoveryAnalysis(int staffId, int companyId)
        {
            
                var applicationDate = generalSetup.GetApplicationDate();
                var loansId = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.DELETED == false).Select(x => x.LOANREFERENCE).ToList();

                var exposureData = (from ln in context.TBL_GLOBAL_EXPOSURE
                                    where
                                    !loansId.Contains(ln.REFERENCENUMBER)
                                    && 
                                    ((ln.UNPODAYSOVERDUE > 30
                                    && (ln.TOTALUNSETTLEDAMOUNT > 0 && ln.TOTALUNSETTLEDAMOUNT <= 50000000))
                                    ||
                                    (ln.ADJFACILITYTYPE.Contains("OVERDRAFT")
                                    && (ln.TOTALEXPOSURE > 0 && ln.TOTALEXPOSURE <= 50000000)
                                    && DbFunctions.DiffDays(ln.MATURITYDATE, ln.DATE) > 30))

                                    orderby ln.ID descending
                                    select new GlobalExposureApplicationViewModel
                                    {
                                        loanId = ln.ID,
                                        customerCode = ln.CUSTOMERID,
                                        productCode = ln.PRODUCTID,
                                        facilityType = ln.ADJFACILITYTYPE,
                                        applicationReferenceNumber = ln.REFERENCENUMBER,
                                        loanReferenceNumber = ln.REFERENCENUMBER,
                                        customerName = ln.CUSTOMERNAME,
                                        productName = ln.PRODUCTNAME,
                                        relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                        exposureType = ln.EXPOSURETYPE,
                                        expiryBand = ln.EXPIRINGBAND,
                                        divisionName = ln.DIVISIONNAME,
                                        totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                        //totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                        totalUnsettledAmount = ln.ADJFACILITYTYPE == "OVERDRAFT" ? ln.TOTALEXPOSURE : ln.TOTALUNSETTLEDAMOUNT,
                                        //dpdExposure = ln.UNPODAYSOVERDUE,
                                        dpdExposure = ln.ADJFACILITYTYPE == "OVERDRAFT" ? (DbFunctions.DiffDays(ln.MATURITYDATE, ln.DATE)) : ln.UNPODAYSOVERDUE,
                                        loanCategory = ln.CBNCLASSIFICATION,
                                        casaAccount = ln.ACCOUNTNUMBER,
                                        branchName = ln.BRANCHNAME,
                                        divisionCode = ln.DIVISIONCODE,
                                        region = ln.REGIONCODE + " " + ln.REGIONNAME,
                                        phoneNo = ln.PHONENO,
                                        valueDate = ln.VALUEDATE,
                                        maturityRevDate = ln.MATURITYDATE,
                                        overduePrincipalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        overdueInterestAmount = (decimal)ln.INTERESTRECIEVABLETCY,
                                        isDigital = false
                                    }).Take(100).ToList();

                foreach (var xx in exposureData)
                {
                    xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                    xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                    xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                    xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
                }

                var exposureDigitalData = (from ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN
                                           where
                                           !loansId.Contains(ln.REFERENCENUMBER)
                                           && ln.UNPODAYSOVERDUE > 30
                                           && ln.TOTALUNSETTLEDAMOUNT > 0
                                           && !ln.PRODUCTNAME.Contains("INSTANT BUSINESS LOAN")

                                           orderby ln.ID descending
                                           select new GlobalExposureApplicationViewModel
                                           {
                                               loanId = ln.ID,
                                               customerCode = ln.CUSTOMERID,
                                               productCode = ln.PRODUCTID,
                                               facilityType = ln.ADJFACILITYTYPE == "N/A" ? "DIGITAL" : "DIGITAL - " + ln.ADJFACILITYTYPE,
                                               applicationReferenceNumber = ln.REFERENCENUMBER,
                                               loanReferenceNumber = ln.REFERENCENUMBER,
                                               customerName = ln.CUSTOMERNAME,
                                               productName = ln.PRODUCTNAME,
                                               relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                               exposureType = ln.EXPOSURETYPE,
                                               expiryBand = ln.EXPIRINGBAND,
                                               divisionName = ln.DIVISIONNAME,
                                               totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                               totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                               dpdExposure = ln.UNPODAYSOVERDUE,
                                               loanCategory = ln.CBNCLASSIFICATION,
                                               casaAccount = ln.ACCOUNTNUMBER,
                                               branchName = ln.BRANCHNAME,
                                               divisionCode = ln.DIVISIONCODE,
                                               region = ln.REGIONCODE + " " + ln.REGIONNAME,
                                               phoneNo = ln.PHONENO,
                                               
                                               valueDate = ln.VALUEDATE,
                                               maturityRevDate = ln.MATURITYDATE,
                                               overduePrincipalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                               overdueInterestAmount = (decimal)ln.INTERESTRECIEVABLETCY,
                                               isDigital = true
                                           }).Take(100).ToList();

                foreach (var xx in exposureDigitalData)
                {
                    xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                    xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                    xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                    xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
                }

                var exposureDigitalData2 = (from ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN
                                           where
                                           !loansId.Contains(ln.REFERENCENUMBER)
                                           && ln.UNPODAYSOVERDUE > 30
                                           && ln.TOTALUNSETTLEDAMOUNT > 0
                                           && ln.PRODUCTNAME.Contains("INSTANT BUSINESS LOAN")

                                            orderby ln.ID descending
                                           select new GlobalExposureApplicationViewModel
                                           {
                                               loanId = ln.ID,
                                               customerCode = ln.CUSTOMERID,
                                               productCode = ln.PRODUCTID,
                                               facilityType = ln.ADJFACILITYTYPE == "N/A" ? "DIGITAL" : "DIGITAL - " + ln.ADJFACILITYTYPE,
                                               applicationReferenceNumber = ln.REFERENCENUMBER,
                                               loanReferenceNumber = ln.REFERENCENUMBER,
                                               customerName = ln.CUSTOMERNAME,
                                               productName = ln.PRODUCTNAME,
                                               relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                               exposureType = ln.EXPOSURETYPE,
                                               expiryBand = ln.EXPIRINGBAND,
                                               divisionName = ln.DIVISIONNAME,
                                               totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                               totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                               dpdExposure = ln.UNPODAYSOVERDUE,
                                               loanCategory = ln.CBNCLASSIFICATION,
                                               casaAccount = ln.ACCOUNTNUMBER,
                                               branchName = ln.BRANCHNAME,
                                               divisionCode = ln.DIVISIONCODE,
                                               region = ln.REGIONCODE + " " + ln.REGIONNAME,
                                               phoneNo = ln.PHONENO,

                                               valueDate = ln.VALUEDATE,
                                               maturityRevDate = ln.MATURITYDATE,
                                               overduePrincipalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                               overdueInterestAmount = (decimal)ln.INTERESTRECIEVABLETCY,
                                               isDigital = true
                                           }).Take(100).ToList();

                foreach (var xx in exposureDigitalData2)
                {
                    xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                    xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                    xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                    xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
                }
                #region
            /*var dataLoan = (from ln in context.TBL_LOAN
                            join op in context.TBL_LOAN_REVIEW_OPERATION on ln.TERMLOANID equals op.LOANID
                            join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                            join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID into atraila
                            from atrail in atraila.DefaultIfEmpty()
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            !loansId.Contains(ln.LOANREFERENCENUMBER)
                            && pr.EXCLUDEFROMLITIGATION == false
                            && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && op.OPERATIONTYPEID == (int)OperationsEnum.CompleteWriteOff
                            && ln.USER_PRUDENTIAL_GUIDE_STATUSID == (int)LoanPrudentialStatusEnum.Performing

                            orderby op.DATECREATED descending
                            select new GlobalExposureApplicationViewModel
                            {
                                
                                    //creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                    //creditAppraisalOperationId = lp.OPERATIONID,
                                    //loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                    //appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                    //lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                    //                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                    //                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                    //lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                    //                     (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                    //                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),
                                    phoneNo = "",
                                    valueDate = ln.BOOKINGDATE,
                                    maturityRevDate = ln.MATURITYDATE,
                                    overduePrincipalAmount = ln.OUTSTANDINGPRINCIPAL,
                                    overdueInterestAmount = ln.INTERESTONPASTDUEPRINCIPAL,


                                    loanApplicationDetailId = ld.LOANAPPLICATIONDETAILID,
                                    currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                    loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                    loanId = ln.TERMLOANID,
                                    loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                    customerId = cu.CUSTOMERCODE,
                                    productId = ln.PRODUCTID,
                                    productClassId = (int)pr.PRODUCTCLASSID,
                                    prepaymentAmount = op.PREPAYMENT,
                                    productTypeId = pr.PRODUCTTYPEID,
                                    casaAccountId = ln.CASAACCOUNTID,
                                    loanCategory = "Written Off",
                                    divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                    casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                    casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                    branchId = ln.BRANCHID,
                                    amount = ld.APPROVEDAMOUNT,
                                    lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                      join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                      where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                      select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                    loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                    applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                    principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                    pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                    interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                    interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                    principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                    interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                    relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                    relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                    misCode = ln.MISCODE,
                                    teamMiscode = ln.TEAMMISCODE,
                                    interestRate = ln.INTERESTRATE,
                                    effectiveDate = ln.EFFECTIVEDATE,
                                    maturityDate = ln.MATURITYDATE,
                                    bookingDate = ln.BOOKINGDATE,
                                    totalUnsettledAmount = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL) + (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                    totalAmountRecovery = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL) + (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                    principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                    principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                    interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                    approvalStatusId = op.APPROVALSTATUSID,
                                    approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                    approvedBy = (int)ln.APPROVEDBY,
                                    approverComment = ln.APPROVERCOMMENT,
                                    dateApproved = ln.DATEAPPROVED,
                                    loanStatusId = ln.LOANSTATUSID,
                                    scheduleTypeId = ln.SCHEDULETYPEID,
                                    isDisbursed = ln.ISDISBURSED,
                                    disbursedBy = (int)ln.DISBURSEDBY,
                                    disburserComment = ln.DISBURSERCOMMENT,
                                    disburseDate = ln.DISBURSEDATE,
                                    customerGroupId = lp.CUSTOMERGROUPID,
                                    operationId = ln.OPERATIONID,
                                    loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                    equityContribution = ln.EQUITYCONTRIBUTION,
                                    subSectorId = ln.SUBSECTORID,
                                    subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                    sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                    firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                    firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                    outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                    principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                    principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                    fixedPrincipal = ln.FIXEDPRINCIPAL,
                                    profileLoan = ln.PROFILELOAN,
                                    dischargeLetter = ln.DISCHARGELETTER,
                                    suspendInterest = ln.SUSPENDINTEREST,
                                    scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                    isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                    scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                    scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                    customerCode = cu.CUSTOMERCODE,
                                    productAccountNumber = ch.ACCOUNTCODE,
                                    productAccountName = ch.ACCOUNTNAME,
                                    loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                    customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                    currencyId = ln.CURRENCYID,
                                    branchName = br.BRANCHNAME,
                                    relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                    relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                    productName = pr.PRODUCTNAME,
                                    comment = "",
                                    region = "",
                                    operationTypeId = op.OPERATIONTYPEID,
                                    operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                    newEffectiveDate = op.EFFECTIVEDATE,
                                    reviewDetails = op.REVIEWDETAILS,
                                    prepayment = op.PREPAYMENT,
                                    newInterateRate = op.INTERATERATE,
                                    newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                    newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                    newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                    newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newTenor = op.TENOR,
                                    cASA_AccountId = op.CASA_ACCOUNTID,
                                    cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                    cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                    overDraftTopup = op.OVERDRAFTTOPUP,
                                    fee_Charges = op.FEE_CHARGES,
                                    scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                    scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                    scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                    scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                    scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                    newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                    newMaturityDate = op.MATURITYDATE,
                                    approvedAmount = ld.APPROVEDAMOUNT,
                                    creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                    lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                    pastDueInterest = ln.PASTDUEINTEREST,
                                    pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                    interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                    interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                    outstandingInterest = ln.OUTSTANDINGINTEREST,
                                    accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                    dateTimeCreated = op.DATECREATED,

                                    exposureType = "",
                                    expiryBand = "",

                                }).ToList();

            foreach(var x in dataLoan)
            {
                x.dpdExposure = DateDiff(DateTime.Now, x.maturityDate);
            }

                var dataRevolvingLoan = (from ln in context.TBL_LOAN_REVOLVING
                                         join op in context.TBL_LOAN_REVIEW_OPERATION on ln.REVOLVINGLOANID equals op.LOANID
                                         join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                         join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                         join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                         join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                         join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                         join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                         join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                         join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                         join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                         join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                         where
                                         !loansId.Contains(ln.LOANREFERENCENUMBER)
                                         && pr.EXCLUDEFROMLITIGATION == false
                                         && op.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                         && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                         && op.OPERATIONTYPEID == (int)OperationsEnum.CompleteWriteOff
                                         && ln.USER_PRUDENTIAL_GUIDE_STATUSID == (int)LoanPrudentialStatusEnum.Performing

                                         orderby op.DATECREATED descending
                                         select new GlobalExposureApplicationViewModel
                                         {
                                             
                                             //loanApplicationDetailId = ld.LOANAPPLICATIONDETAILID,
                                             //creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                             //creditAppraisalOperationId = lp.OPERATIONID,
                                             //lmsLoanApplicationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                             //            (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault() :
                                             //            (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.LOANAPPLICATIONID).FirstOrDefault(),
                                             //lmsOperationId = (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                             //            (ln.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault() :
                                             //            (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),
                                             phoneNo = "",
                                             alueDate = ln.BOOKINGDATE,
                                             maturityRevDate = ln.MATURITYDATE,
                                             overduePrincipalAmount = ln.OVERDRAFTLIMIT,
                                             overdueInterestAmount = ln.INTERESTONPASTDUEPRINCIPAL,

                                             loanReviewApplicationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault(),//e.LOANAPPLICATIONID,
                                             appraisalOperationId = context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.OPERATIONID).FirstOrDefault(),
                                             loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                             loanId = ln.REVOLVINGLOANID,
                                             loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                             customerId = cu.CUSTOMERCODE,
                                             productId = ln.PRODUCTID,
                                             productClassId = (int)pr.PRODUCTCLASSID,
                                             productTypeId = pr.PRODUCTTYPEID,
                                             prepaymentAmount = op.PREPAYMENT,
                                             casaAccountId = ln.CASAACCOUNTID,
                                             region = "",
                                             divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                             casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                             casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                             branchId = ln.BRANCHID,
                                             lmsrApplicationReferenceNumber = (from c in context.TBL_LMSR_APPLICATION_DETAIL
                                                                               join l in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                                                                               where c.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID
                                                                               select l.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                                             totalAmountRecovery = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                             totalUnsettledAmount = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                             loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                             applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                             relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                             relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                             misCode = ln.MISCODE,
                                             teamMiscode = ln.TEAMMISCODE,
                                             interestRate = ln.INTERESTRATE,
                                             effectiveDate = ln.EFFECTIVEDATE,
                                             maturityDate = ln.MATURITYDATE,
                                             bookingDate = ln.BOOKINGDATE,
                                             loanCategory = op.OPERATIONTYPEID == (int)OperationsEnum.CompleteWriteOff ? "Written Off" : "Non Performing",
                                             approvalStatusId = op.APPROVALSTATUSID,
                                             approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == op.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                             approvedBy = (int)ln.APPROVEDBY,
                                             approverComment = ln.APPROVERCOMMENT,
                                             dateApproved = ln.DATEAPPROVED,
                                             loanStatusId = ln.LOANSTATUSID,
                                             isDisbursed = ln.ISDISBURSED,
                                             disburserComment = ln.DISBURSERCOMMENT,
                                             disburseDate = ln.DISBURSEDATE,
                                             customerGroupId = lp.CUSTOMERGROUPID,
                                             operationId = ln.OPERATIONID,
                                             loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                             subSectorId = ln.SUBSECTORID,
                                             subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                             sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                             dischargeLetter = ln.DISCHARGELETTER,
                                             suspendInterest = ln.SUSPENDINTEREST,
                                             customerCode = cu.CUSTOMERCODE,
                                             loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                             customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                             currencyId = ln.CURRENCYID,
                                             branchName = br.BRANCHNAME,
                                             relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                             relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                             productName = pr.PRODUCTNAME,
                                             comment = "",
                                             operationTypeId = op.OPERATIONTYPEID,
                                             operationTypeName = tt.OPERATIONNAME,
                                             newEffectiveDate = op.EFFECTIVEDATE,
                                             reviewDetails = op.REVIEWDETAILS,
                                             prepayment = op.PREPAYMENT,
                                             newInterateRate = op.INTERATERATE,
                                             newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                             newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                             newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                             newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                             newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                             newTenor = op.TENOR,
                                             cASA_AccountId = op.CASA_ACCOUNTID,
                                             cASA_Account = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                             cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                             overDraftTopup = op.OVERDRAFTTOPUP,
                                             fee_Charges = op.FEE_CHARGES,
                                             scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                             scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                             scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                             scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                             scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                             newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                             newMaturityDate = op.MATURITYDATE,
                                             dateTimeCreated = op.DATECREATED,
                                             lmsLoanReferenceNumber = context.TBL_LMSR_APPLICATION.Where(h => h.LOANAPPLICATIONID == context.TBL_LMSR_APPLICATION_DETAIL.Where(x => x.LOANREVIEWAPPLICATIONID == op.LOANREVIEWAPPLICATIONID).Select(l => l.LOANAPPLICATIONID).FirstOrDefault()).Select(c => c.APPLICATIONREFERENCENUMBER).FirstOrDefault(), //mp.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                             currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                             productAccountNumber = "N/A",
                                             productAccountName = "N/A",
                                             approvedAmount = ld.APPROVEDAMOUNT,
                                             creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                         }).ToList();

            foreach (var x in dataRevolvingLoan)
            {
                x.dpdExposure = DateDiff(DateTime.Now, x.maturityDate);
            }


            var dataLoanNonPerforming = (from ln in context.TBL_LOAN
                                             join tt in context.TBL_OPERATIONS on ln.OPERATIONID equals tt.OPERATIONID
                                             join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                             join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                             join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                             join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                             join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                             join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                             join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                             join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                             join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                                             where
                                             !loansId.Contains(ln.LOANREFERENCENUMBER)
                                             && pr.EXCLUDEFROMLITIGATION == false
                                             && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                             && ln.USER_PRUDENTIAL_GUIDE_STATUSID != (int)LoanPrudentialStatusEnum.Performing
                                             && DbFunctions.DiffDays(DateTime.UtcNow, ln.MATURITYDATE).Value >= 30

                                             orderby ln.DATETIMECREATED descending
                                             select new GlobalExposureApplicationViewModel
                                             {
                                                 phoneNo = "",
                                                 alueDate = ln.BOOKINGDATE,
                                                 maturityRevDate = ln.MATURITYDATE,
                                                 overduePrincipalAmount = ln.OUTSTANDINGPRINCIPAL,
                                                 overdueInterestAmount = ln.INTERESTONPASTDUEPRINCIPAL,

                                                 creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                                 creditAppraisalOperationId = lp.OPERATIONID,
                                                 loanApplicationDetailId = ld.LOANAPPLICATIONDETAILID,
                                                 loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                                 loanId = ln.TERMLOANID,
                                                 customerId = cu.CUSTOMERCODE,
                                                 productId = ln.PRODUCTID,
                                                 productClassId = (int)pr.PRODUCTCLASSID,
                                                 productTypeId = pr.PRODUCTTYPEID,
                                                 casaAccountId = ln.CASAACCOUNTID,
                                                 loanCategory = "Non Performing",
                                                 region = "",
                                                 casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                                 casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                                 branchId = ln.BRANCHID,
                                                 amount = ld.APPROVEDAMOUNT,
                                                 operationTypeName = tt.OPERATIONNAME,
                                                 loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                                 applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                                 principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                                 pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                                 interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                                 interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                                 principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                                 interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                                 relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                                 relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                                 misCode = ln.MISCODE,
                                                 teamMiscode = ln.TEAMMISCODE,
                                                 interestRate = ln.INTERESTRATE,
                                                 effectiveDate = ln.EFFECTIVEDATE,
                                                 maturityDate = ln.MATURITYDATE,
                                                 bookingDate = ln.BOOKINGDATE,
                                                 totalUnsettledAmount = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL) + (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                                 totalAmountRecovery = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL) + (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                                 principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                                 principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                                 interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                                 approvedBy = (int)ln.APPROVEDBY,
                                                 approverComment = ln.APPROVERCOMMENT,
                                                 dateApproved = ln.DATEAPPROVED,
                                                 loanStatusId = ln.LOANSTATUSID,
                                                 scheduleTypeId = ln.SCHEDULETYPEID,
                                                 isDisbursed = ln.ISDISBURSED,
                                                 disbursedBy = (int)ln.DISBURSEDBY,
                                                 disburserComment = ln.DISBURSERCOMMENT,
                                                 disburseDate = ln.DISBURSEDATE,
                                                 customerGroupId = lp.CUSTOMERGROUPID,
                                                 operationId = ln.OPERATIONID,
                                                 loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                                 equityContribution = ln.EQUITYCONTRIBUTION,
                                                 subSectorId = ln.SUBSECTORID,
                                                 subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                                 sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                                 firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                                 firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                                 outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                                 principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                                 principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                                 fixedPrincipal = ln.FIXEDPRINCIPAL,
                                                 profileLoan = ln.PROFILELOAN,
                                                 dischargeLetter = ln.DISCHARGELETTER,
                                                 suspendInterest = ln.SUSPENDINTEREST,
                                                 scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                                 isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                                 scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                                 scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                                 customerCode = cu.CUSTOMERCODE,
                                                 productAccountNumber = ch.ACCOUNTCODE,
                                                 productAccountName = ch.ACCOUNTNAME,
                                                 loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                                 customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                                 currencyId = ln.CURRENCYID,
                                                 branchName = br.BRANCHNAME,
                                                 relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                                 relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                                 productName = pr.PRODUCTNAME,
                                                 comment = "",
                                                 approvedAmount = ld.APPROVEDAMOUNT,
                                                 creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                                 pastDueInterest = ln.PASTDUEINTEREST,
                                                 pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                                 interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                                 interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                                 outstandingInterest = ln.OUTSTANDINGINTEREST,
                                                 accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                                 dateTimeCreated = ln.DATETIMECREATED,
                                             }).ToList();

            foreach (var x in dataLoanNonPerforming)
            {
                x.dpdExposure = DateDiff(DateTime.Now, x.maturityDate);
            }

            var dataRevolvingNonPerforming = (from ln in context.TBL_LOAN_REVOLVING
                                                  join tt in context.TBL_OPERATIONS on ln.OPERATIONID equals tt.OPERATIONID
                                                  join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                                  join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                                  join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                                  join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                                  join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                                  join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                                  join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                                  join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                                  where
                                                  !loansId.Contains(ln.LOANREFERENCENUMBER)
                                                  && pr.EXCLUDEFROMLITIGATION == false
                                                  && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                                  && ln.USER_PRUDENTIAL_GUIDE_STATUSID != (int)LoanPrudentialStatusEnum.Performing
                                                  && DbFunctions.DiffDays(DateTime.UtcNow, ln.MATURITYDATE).Value >= 30

                                                  orderby ln.DATETIMECREATED descending
                                                  select new GlobalExposureApplicationViewModel
                                                  {
                                                     
                                                      loanApplicationDetailId = ld.LOANAPPLICATIONDETAILID,
                                                      creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                                      creditAppraisalOperationId = lp.OPERATIONID,
                                                      loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                                      loanId = ln.REVOLVINGLOANID,
                                                      customerId = cu.CUSTOMERCODE,
                                                      productId = ln.PRODUCTID,
                                                      productClassId = (int)pr.PRODUCTCLASSID,
                                                      productTypeId = pr.PRODUCTTYPEID,
                                                      casaAccountId = ln.CASAACCOUNTID,
                                                      region = "",
                                                      divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                                      casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                                      casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                                      branchId = ln.BRANCHID,
                                                      totalUnsettledAmount = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                                      totalAmountRecovery = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                                      loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                                      applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                                      relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                                      relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                                      misCode = ln.MISCODE,
                                                      teamMiscode = ln.TEAMMISCODE,
                                                      interestRate = ln.INTERESTRATE,
                                                      effectiveDate = ln.EFFECTIVEDATE,
                                                      maturityDate = ln.MATURITYDATE,
                                                      bookingDate = ln.BOOKINGDATE,
                                                      loanCategory = "Non Performing",
                                                      operationTypeName = tt.OPERATIONNAME,
                                                      approvalStatusName = context.TBL_APPROVAL_STATUS.FirstOrDefault(f => f.APPROVALSTATUSID == ln.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                                      approvedBy = (int)ln.APPROVEDBY,
                                                      approverComment = ln.APPROVERCOMMENT,
                                                      dateApproved = ln.DATEAPPROVED,
                                                      loanStatusId = ln.LOANSTATUSID,
                                                      isDisbursed = ln.ISDISBURSED,
                                                      disburserComment = ln.DISBURSERCOMMENT,
                                                      disburseDate = ln.DISBURSEDATE,
                                                      customerGroupId = lp.CUSTOMERGROUPID,
                                                      operationId = ln.OPERATIONID,
                                                      loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                                      subSectorId = ln.SUBSECTORID,
                                                      subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                                      sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                                      dischargeLetter = ln.DISCHARGELETTER,
                                                      suspendInterest = ln.SUSPENDINTEREST,
                                                      customerCode = cu.CUSTOMERCODE,
                                                      loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                                      customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                                      currencyId = ln.CURRENCYID,
                                                      branchName = br.BRANCHNAME,
                                                      relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                                      relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                                      productName = pr.PRODUCTNAME,
                                                      comment = "",
                                                      productAccountNumber = "N/A",
                                                      productAccountName = "N/A",
                                                      approvedAmount = ld.APPROVEDAMOUNT,
                                                      creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                                      phoneNo = "",
                                                      alueDate = ln.BOOKINGDATE,
                                                      maturityRevDate = ln.MATURITYDATE,
                                                      overduePrincipalAmount = ln.OVERDRAFTLIMIT,
                                                      overdueInterestAmount = ln.INTERESTONPASTDUEPRINCIPAL,

                                                  }).ToList();

            foreach (var x in dataRevolvingNonPerforming)
            {
                x.dpdExposure = DateDiff(DateTime.Now, x.maturityDate);
            }

            var termLoanData = dataLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber).ToList();
                var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber).ToList();
                var termLoanDataNon = dataLoanNonPerforming.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber).ToList();
                var revolvingLoanDataNon = dataRevolvingNonPerforming.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber).ToList();

                var unionAll = termLoanData.Union(revolvingLoanData);
                var unionAll2 = termLoanDataNon.Union(revolvingLoanDataNon);
                var allData = unionAll.Union(unionAll2).Union(exposureData).Union(exposureDigitalData);*/

            #endregion
                var allData = exposureData.Union(exposureDigitalData).Union(exposureDigitalData2);
                var data = allData.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber).ToList();

                return data;
            
        }

        public IEnumerable<GlobalExposureApplicationViewModel> GetDelinquentAccounts(int staffId, int companyId)
        {

            var applicationDate = generalSetup.GetApplicationDate();
            var loansId = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.DELETED == false).Select(x => x.LOANREFERENCE).ToList();

            var exposureData = (from ln in context.TBL_GLOBAL_EXPOSURE
                                where
                                //!loansId.Contains(ln.REFERENCENUMBER)
                                ((ln.UNPODAYSOVERDUE > 30
                                && (ln.TOTALUNSETTLEDAMOUNT > 0 && ln.TOTALUNSETTLEDAMOUNT <= 50000000))
                                ||
                                (ln.ADJFACILITYTYPE.Contains("OVERDRAFT")
                                && (ln.TOTALEXPOSURE > 0 && ln.TOTALEXPOSURE <= 50000000)
                                && DbFunctions.DiffDays(ln.MATURITYDATE, ln.DATE) > 30))

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    facilityType = ln.ADJFACILITYTYPE,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    //totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                    totalUnsettledAmount = ln.ADJFACILITYTYPE == "OVERDRAFT" ? ln.TOTALEXPOSURE : ln.TOTALUNSETTLEDAMOUNT,
                                    //dpdExposure = ln.UNPODAYSOVERDUE,
                                    dpdExposure = ln.ADJFACILITYTYPE == "OVERDRAFT" ? (DbFunctions.DiffDays(ln.MATURITYDATE, ln.DATE)) : ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE + " " + ln.REGIONNAME,
                                    phoneNo = ln.PHONENO,
                                    valueDate = ln.VALUEDATE,
                                    maturityRevDate = ln.MATURITYDATE,
                                    overduePrincipalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                    overdueInterestAmount = (decimal)ln.INTERESTRECIEVABLETCY
                                }).Take(100).ToList();

            foreach (var xx in exposureData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var allData = exposureData;
            var data = allData.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber).ToList();

            return data;

        }

        public IEnumerable<GlobalExposureApplicationViewModel> GetDelinquentDigitalAccounts(int staffId, int companyId)
        {

            var applicationDate = generalSetup.GetApplicationDate();
            var loansId = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.DELETED == false).Select(x => x.LOANREFERENCE).ToList();
       
            var exposureDigitalData = (from ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN
                                       where
                                       //!loansId.Contains(ln.REFERENCENUMBER)
                                       ln.UNPODAYSOVERDUE > 30
                                       && ln.TOTALUNSETTLEDAMOUNT > 0

                                       orderby ln.ID descending
                                       select new GlobalExposureApplicationViewModel
                                       {
                                           loanId = ln.ID,
                                           customerCode = ln.CUSTOMERID,
                                           productCode = ln.PRODUCTID,
                                           facilityType = ln.ADJFACILITYTYPE == "N/A" ? "DIGITAL" : "DIGITAL - " + ln.ADJFACILITYTYPE,
                                           applicationReferenceNumber = ln.REFERENCENUMBER,
                                           loanReferenceNumber = ln.REFERENCENUMBER,
                                           customerName = ln.CUSTOMERNAME,
                                           productName = ln.PRODUCTNAME,
                                           relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                           exposureType = ln.EXPOSURETYPE,
                                           expiryBand = ln.EXPIRINGBAND,
                                           divisionName = ln.DIVISIONNAME,
                                           totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                           totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                           dpdExposure = ln.UNPODAYSOVERDUE,
                                           loanCategory = ln.CBNCLASSIFICATION,
                                           casaAccount = ln.ACCOUNTNUMBER,
                                           branchName = ln.BRANCHNAME,
                                           divisionCode = ln.DIVISIONCODE,
                                           region = ln.REGIONCODE + " " + ln.REGIONNAME,
                                           phoneNo = ln.PHONENO,

                                           valueDate = ln.VALUEDATE,
                                           maturityRevDate = ln.MATURITYDATE,
                                           overduePrincipalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                           overdueInterestAmount = (decimal)ln.INTERESTRECIEVABLETCY
                                       }).Take(100).ToList();

            foreach (var xx in exposureDigitalData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var allData = exposureDigitalData;
            var data = allData.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber).ToList();

            return data;

        }


        public IEnumerable<GlobalExposureApplicationViewModel> getAllLoansOperationRecoveryAnalysisByAgent(string source, int staffId, int companyId, DateTime month)
            {
                var applicationDate = generalSetup.GetApplicationDate();
            var monthInWord = "";
            if (month.Month == 1)
            {
                monthInWord = "January, " + month.Year;
            }
            if (month.Month == 2)
            {
                monthInWord = "February, " + month.Year;
            }
            if (month.Month == 3)
            {
                monthInWord = "March, " + month.Year;
            }
            if (month.Month == 4)
            {
                monthInWord = "April, " + month.Year;
            }
            if (month.Month == 5)
            {
                monthInWord = "May, " + month.Year;
            }
            if (month.Month == 6)
            {
                monthInWord = "June, " + month.Year;
            }
            if (month.Month == 7)
            {
                monthInWord = "July, " + month.Year;
            }
            if (month.Month == 8)
            {
                monthInWord = "August, " + month.Year;
            }
            if (month.Month == 9)
            {
                monthInWord = "September, " + month.Year;
            }
            if (month.Month == 10)
            {
                monthInWord = "October, " + month.Year;
            }
            if (month.Month == 11)
            {
                monthInWord = "November, " + month.Year;
            }
            if (month.Month == 12)
            {
                monthInWord = "December, " + month.Year;
            }



            DateTime collectionDate = DateTime.ParseExact(monthInWord, "MMMM, yyyy", CultureInfo.InvariantCulture);

            var exposureData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                    join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                    where
                                    lr.ISFULLYRECOVERED == false
                                    && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                    && lr.SOURCE.ToLower() == source.ToLower()
                                    && lr.DELETED == false
                                    && lr.DATEASSIGNED.Month == collectionDate.Month

                                    && lr.DATEASSIGNED.Year == collectionDate.Year
                                    orderby lr.DATEASSIGNED ascending

                                
                                    select new GlobalExposureApplicationViewModel
                                    {
                                        loanId = ln.ID,
                                        customerCode = ln.CUSTOMERID,
                                        productCode = ln.PRODUCTID,
                                        applicationReferenceNumber = ln.REFERENCENUMBER,
                                        loanReferenceNumber = ln.REFERENCENUMBER,
                                        customerName = ln.CUSTOMERNAME,
                                        productName = ln.PRODUCTNAME,
                                        relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                        exposureType = ln.EXPOSURETYPE,
                                        expiryBand = ln.EXPIRINGBAND,
                                        divisionName = ln.DIVISIONNAME,
                                        totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                        dpdExposure = ln.UNPODAYSOVERDUE,
                                        loanCategory = ln.CBNCLASSIFICATION,
                                        casaAccount = ln.ACCOUNTNUMBER,
                                        branchName = ln.BRANCHNAME,
                                        divisionCode = ln.DIVISIONCODE,
                                        region = ln.REGIONCODE,
                                        relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                        bulkRecoveryApprovalId = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Where(x => x.REFERENCEBATCHID == lr.REFERENCEID).Select(x => x.BULKRECOVERYAPPROVALID).FirstOrDefault(),
                                        operationId = lr.OPERATIONID,
                                        accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                        referenceId = lr.REFERENCEID,
                                        assignedBy = context.TBL_STAFF.Where(s => s.STAFFID == lr.CREATEDBY).Select(s => s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME).FirstOrDefault(),
                                        assignmentType = lr.ASSIGNMENTTYPE,
                                        agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                        accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                        accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                        category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                        accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                        assignedDate = lr.DATEASSIGNED,
                                        expCompletionDate = lr.EXPCOMPLETIONDATE,
                                        loanAssignId = lr.LOANASSIGNID,
                                    }).ToList();

                foreach (var xx in exposureData)
                {
                    xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                    xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                    xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                    xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
                }

                var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                           join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                           where
                                           lr.ISFULLYRECOVERED == false
                                           && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                           && lr.SOURCE.ToLower() == source.ToLower()
                                           && lr.DELETED == false
                                           && lr.DATEASSIGNED.Month == collectionDate.Month
                                           && lr.DATEASSIGNED.Year == collectionDate.Year

                                           orderby lr.DATEASSIGNED ascending

                                          
                                           select new GlobalExposureApplicationViewModel
                                           {
                                               loanId = ln.ID,
                                               customerCode = ln.CUSTOMERID,
                                               productCode = ln.PRODUCTID,
                                               applicationReferenceNumber = ln.REFERENCENUMBER,
                                               loanReferenceNumber = ln.REFERENCENUMBER,
                                               customerName = ln.CUSTOMERNAME,
                                               productName = ln.PRODUCTNAME,
                                               relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                               exposureType = ln.EXPOSURETYPE,
                                               expiryBand = ln.EXPIRINGBAND,
                                               divisionName = ln.DIVISIONNAME,
                                               totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                               dpdExposure = ln.UNPODAYSOVERDUE,
                                               loanCategory = ln.CBNCLASSIFICATION,
                                               casaAccount = ln.ACCOUNTNUMBER,
                                               branchName = ln.BRANCHNAME,
                                               divisionCode = ln.DIVISIONCODE,
                                               region = ln.REGIONCODE,
                                               bulkRecoveryApprovalId = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Where(x => x.REFERENCEBATCHID == lr.REFERENCEID).Select(x => x.BULKRECOVERYAPPROVALID).FirstOrDefault(),
                                               operationId = lr.OPERATIONID,
                                               accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                               referenceId = lr.REFERENCEID,
                                               assignedBy = context.TBL_STAFF.Where(s => s.STAFFID == lr.CREATEDBY).Select(s => s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME).FirstOrDefault(),
                                               assignmentType = lr.ASSIGNMENTTYPE,
                                               agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                               accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                               accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                               category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                               accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                               expCompletionDate = lr.EXPCOMPLETIONDATE,
                                               assignedDate = lr.DATEASSIGNED,
                                               loanAssignId = lr.LOANASSIGNID,
                                               relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                           }).ToList();

                foreach (var xx in exposureDigitalData)
                {
                    xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                    xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                    xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                    xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
                }

            #region
            /*var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            lr.ISFULLYRECOVERED == false
                            && pr.EXCLUDEFROMLITIGATION == false
                            && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && lr.SOURCE.ToLower() == source.ToLower()
                            && lr.DELETED == false

                            select new GlobalExposureApplicationViewModel
                            {
                                bulkRecoveryApprovalId = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Where(x => x.REFERENCEBATCHID == lr.REFERENCEID).Select(x => x.BULKRECOVERYAPPROVALID).FirstOrDefault(),
                                operationId = lr.OPERATIONID,
                                accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                referenceId = lr.REFERENCEID,
                                divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                region = "",
                                assignedBy = context.TBL_STAFF.Where(s => s.STAFFID == lr.CREATEDBY).Select(s => s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME).FirstOrDefault(),
                                assignmentType = lr.ASSIGNMENTTYPE,
                                loanApplicationId = lp.LOANAPPLICATIONID,
                                currencyId = ld.CURRENCYID,
                                agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                expCompletionDate = lr.EXPCOMPLETIONDATE,
                                loanAssignId = lr.LOANASSIGNID,
                                agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productClassId = pr.PRODUCTCLASSID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                //totalAmountRecovery = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL),
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,

                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     lr.ISFULLYRECOVERED == false
                                     && pr.EXCLUDEFROMLITIGATION == false
                                     && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                     && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                     && lr.SOURCE.ToLower() == source.ToLower()
                                     && lr.DELETED == false

                                     select new GlobalExposureApplicationViewModel
                                     {
                                         bulkRecoveryApprovalId = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Where(x => x.REFERENCEBATCHID == lr.REFERENCEID).Select(x => x.BULKRECOVERYAPPROVALID).FirstOrDefault(),
                                         operationId = lr.OPERATIONID,
                                         accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                         referenceId = lr.REFERENCEID,
                                         divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                         region = "",
                                         assignedBy = context.TBL_STAFF.Where(s => s.STAFFID == lr.CREATEDBY).Select(s => s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME).FirstOrDefault(),
                                         assignmentType = lr.ASSIGNMENTTYPE,
                                         //totalAmountRecovery = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                         loanApplicationId = lp.LOANAPPLICATIONID,
                                         category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                         totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                         currencyId = ld.CURRENCYID,
                                         agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                         agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                         accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                         accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                         expCompletionDate = lr.EXPCOMPLETIONDATE,
                                         loanAssignId = lr.LOANASSIGNID,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productClassId = pr.PRODUCTCLASSID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         productAccountNumber = "N/A",
                                         productAccountName = "N/A",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                     }).ToList();

            var termLoanData = dataLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
            var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);*/
            #endregion
            var unionAll = exposureData.Union(exposureDigitalData);

                var data = unionAll;

                return data;
            
        }



        public CollectionsRetailComputationVariableSetupViewModel getAllRecoveryComputationVariables(int staffId, int companyId)
        {
            var data = (from x in context.TBL_COLLECTION_COMPUTATION_VARIABLES_SETUP
                                where
                                x.DELETED == false

                                select new CollectionsRetailComputationVariableSetupViewModel
                                {
                                    computationVariableId = x.COMPUTATIONVARIABLEID,
                                    vat = x.VAT,
                                    wht = x.WHT,
                                    commissionPayable = x.COMMISSIONPAYABLE,
                                    commissionPayableLimit = x.COMMISSIONPAYABLELIMIT,
                                    commissionRateExternal = x.COMMISSIONRATEEXTERNAL,
                                    createdBy = x.CREATEDBY,
                                    dateTimeCreated = x.DATETIMECREATED,
                                    recoveredAmountAbove = x.RECOVEREDAMOUNTABOVE,
                                    recoveredAmountBelow = x.RECOVEREDAMOUNTBELOW,
                                    commissionRateExternal2 = x.COMMISSIONRATEEXTERNALTWO,
                                    recoveredAmountExternalAbove = x.RECOVEREDAMOUNTEXTERNALABOVE,
                                    recoveredAmountExternalBelow = x.RECOVEREDAMOUNTEXTERNALBELOW,
                                    deleted = x.DELETED
                                }).FirstOrDefault();

            return data;

        }

        public IEnumerable<GlobalExposureApplicationViewModel> getAllUnassignedRecoveryOperationByAgent(string source, int staffId, int companyId)
            {
                var applicationDate = generalSetup.GetApplicationDate();

                var exposureData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                    join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                    where
                                    lr.DELETED == false
                                    && (lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending || lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing)
                                    && lr.OPERATIONID == (int)OperationsEnum.UnAssignRecoveryLoansFromAgent

                                    orderby ln.ID descending
                                    select new GlobalExposureApplicationViewModel
                                    {
                                        loanId = ln.ID,
                                        customerCode = ln.CUSTOMERID,
                                        productCode = ln.PRODUCTID,
                                        applicationReferenceNumber = ln.REFERENCENUMBER,
                                        loanReferenceNumber = ln.REFERENCENUMBER,
                                        customerName = ln.CUSTOMERNAME,
                                        productName = ln.PRODUCTNAME,
                                        relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                        exposureType = ln.EXPOSURETYPE,
                                        expiryBand = ln.EXPIRINGBAND,
                                        divisionName = ln.DIVISIONNAME,
                                        totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                        dpdExposure = ln.UNPODAYSOVERDUE,
                                        loanCategory = ln.CBNCLASSIFICATION,
                                        casaAccount = ln.ACCOUNTNUMBER,
                                        branchName = ln.BRANCHNAME,
                                        divisionCode = ln.DIVISIONCODE,
                                        region = ln.REGIONCODE,
                                        relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                        bulkRecoveryApprovalId = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Where(x => x.REFERENCEBATCHID == lr.REFERENCEID).Select(x => x.BULKRECOVERYAPPROVALID).FirstOrDefault(),
                                        operationId = lr.OPERATIONID,
                                        accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                        referenceId = lr.REFERENCEID,
                                        assignedBy = context.TBL_STAFF.Where(s => s.STAFFID == lr.CREATEDBY).Select(s => s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME).FirstOrDefault(),
                                        assignmentType = lr.ASSIGNMENTTYPE,
                                        agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                        accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                        accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                        category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                        accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                        expCompletionDate = lr.EXPCOMPLETIONDATE,
                                        loanAssignId = lr.LOANASSIGNID,
                                        agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),

                                    }).ToList();

                foreach (var xx in exposureData)
                {
                    xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                    xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                    xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                    xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
                }

                var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                           join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                           where
                                           lr.DELETED == false
                                           && (lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending || lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing)
                                           && lr.OPERATIONID == (int)OperationsEnum.UnAssignRecoveryLoansFromAgent

                                           orderby ln.ID descending
                                           select new GlobalExposureApplicationViewModel
                                           {
                                               loanId = ln.ID,
                                               customerCode = ln.CUSTOMERID,
                                               productCode = ln.PRODUCTID,
                                               applicationReferenceNumber = ln.REFERENCENUMBER,
                                               loanReferenceNumber = ln.REFERENCENUMBER,
                                               customerName = ln.CUSTOMERNAME,
                                               productName = ln.PRODUCTNAME,
                                               relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                               exposureType = ln.EXPOSURETYPE,
                                               expiryBand = ln.EXPIRINGBAND,
                                               divisionName = ln.DIVISIONNAME,
                                               totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                               dpdExposure = ln.UNPODAYSOVERDUE,
                                               loanCategory = ln.CBNCLASSIFICATION,
                                               casaAccount = ln.ACCOUNTNUMBER,
                                               branchName = ln.BRANCHNAME,
                                               divisionCode = ln.DIVISIONCODE,
                                               region = ln.REGIONCODE,
                                               relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                               bulkRecoveryApprovalId = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Where(x => x.REFERENCEBATCHID == lr.REFERENCEID).Select(x => x.BULKRECOVERYAPPROVALID).FirstOrDefault(),
                                               operationId = lr.OPERATIONID,
                                               accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                               referenceId = lr.REFERENCEID,
                                               assignedBy = context.TBL_STAFF.Where(s => s.STAFFID == lr.CREATEDBY).Select(s => s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME).FirstOrDefault(),
                                               assignmentType = lr.ASSIGNMENTTYPE,
                                               agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                               accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                               accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                               category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                               accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                               expCompletionDate = lr.EXPCOMPLETIONDATE,
                                               loanAssignId = lr.LOANASSIGNID,
                                               agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),

                                           }).ToList();

                foreach (var xx in exposureDigitalData)
                {
                    xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                    xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                    xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                    xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
                }

                var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                where
                                lr.DELETED == false
                                && (lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending || lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing)
                                && lr.OPERATIONID == (int)OperationsEnum.UnAssignRecoveryLoansFromAgent

                                select new GlobalExposureApplicationViewModel
                                {
                                    bulkRecoveryApprovalId = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Where(x => x.REFERENCEBATCHID == lr.REFERENCEID).Select(x => x.BULKRECOVERYAPPROVALID).FirstOrDefault(),
                                    operationId = lr.OPERATIONID,
                                    accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                    referenceId = lr.REFERENCEID,
                                    divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                    region = "",
                                    assignedBy = context.TBL_STAFF.Where(s => s.STAFFID == lr.CREATEDBY).Select(s => s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME).FirstOrDefault(),
                                    assignmentType = lr.ASSIGNMENTTYPE,
                                    loanApplicationId = lp.LOANAPPLICATIONID,
                                    currencyId = ld.CURRENCYID,
                                    agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                    accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                    accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                    category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                    accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanAssignId = lr.LOANASSIGNID,
                                    agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                    creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                    creditAppraisalOperationId = lp.OPERATIONID,
                                    loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                    loanId = ln.TERMLOANID,
                                    customerId = cu.CUSTOMERCODE,
                                    productId = ln.PRODUCTID,
                                    productClassId = pr.PRODUCTCLASSID,
                                    productTypeId = pr.PRODUCTTYPEID,
                                    casaAccountId = ln.CASAACCOUNTID,
                                    casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                    casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                    branchId = ln.BRANCHID,
                                    amount = ld.APPROVEDAMOUNT,
                                    totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                    //totalAmountRecovery = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL),
                                    loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                    applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                    principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                    pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                    interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                    interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                    principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                    interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                    relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                    relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                    misCode = ln.MISCODE,
                                    teamMiscode = ln.TEAMMISCODE,
                                    interestRate = ln.INTERESTRATE,
                                    effectiveDate = ln.EFFECTIVEDATE,
                                    maturityDate = ln.MATURITYDATE,
                                    bookingDate = ln.BOOKINGDATE,
                                    principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                    principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                    interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                    approvedBy = (int)ln.APPROVEDBY,
                                    approverComment = ln.APPROVERCOMMENT,
                                    dateApproved = ln.DATEAPPROVED,
                                    loanStatusId = ln.LOANSTATUSID,
                                    scheduleTypeId = ln.SCHEDULETYPEID,
                                    isDisbursed = ln.ISDISBURSED,
                                    disbursedBy = (int)ln.DISBURSEDBY,
                                    disburserComment = ln.DISBURSERCOMMENT,
                                    disburseDate = ln.DISBURSEDATE,
                                    customerGroupId = lp.CUSTOMERGROUPID,

                                    loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                    equityContribution = ln.EQUITYCONTRIBUTION,
                                    subSectorId = ln.SUBSECTORID,
                                    subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                    sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                    firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                    firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                    outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                    principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                    principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                    fixedPrincipal = ln.FIXEDPRINCIPAL,
                                    profileLoan = ln.PROFILELOAN,
                                    dischargeLetter = ln.DISCHARGELETTER,
                                    suspendInterest = ln.SUSPENDINTEREST,
                                    scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                    isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                    scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                    scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                    customerCode = cu.CUSTOMERCODE,
                                    loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                    customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                    branchName = br.BRANCHNAME,
                                    relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                    relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                    productName = pr.PRODUCTNAME,
                                    comment = "",
                                    approvedAmount = ld.APPROVEDAMOUNT,
                                    creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                    pastDueInterest = ln.PASTDUEINTEREST,
                                    pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                    interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                    interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                    outstandingInterest = ln.OUTSTANDINGINTEREST,
                                    accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                                }).ToList();

                var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                         join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                         join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                         join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                         join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                         join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                         join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                         join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                         join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                         join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                         where
                                         lr.DELETED == false
                                         && (lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending || lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing)
                                         && lr.OPERATIONID == (int)OperationsEnum.UnAssignRecoveryLoansFromAgent

                                         select new GlobalExposureApplicationViewModel
                                         {
                                             bulkRecoveryApprovalId = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Where(x => x.REFERENCEBATCHID == lr.REFERENCEID).Select(x => x.BULKRECOVERYAPPROVALID).FirstOrDefault(),
                                             operationId = lr.OPERATIONID,
                                             accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                             referenceId = lr.REFERENCEID,
                                             divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cu.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                             region = "",
                                             assignedBy = context.TBL_STAFF.Where(s => s.STAFFID == lr.CREATEDBY).Select(s => s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME).FirstOrDefault(),
                                             assignmentType = lr.ASSIGNMENTTYPE,
                                             //totalAmountRecovery = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                             loanApplicationId = lp.LOANAPPLICATIONID,
                                             category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                             totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                             currencyId = ld.CURRENCYID,
                                             agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                             agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                             accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                             accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                             accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                             expCompletionDate = lr.EXPCOMPLETIONDATE,
                                             loanAssignId = lr.LOANASSIGNID,
                                             creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                             creditAppraisalOperationId = lp.OPERATIONID,
                                             loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                             loanId = ln.REVOLVINGLOANID,
                                             customerId = cu.CUSTOMERCODE,
                                             productId = ln.PRODUCTID,
                                             productClassId = pr.PRODUCTCLASSID,
                                             productTypeId = pr.PRODUCTTYPEID,
                                             casaAccountId = ln.CASAACCOUNTID,
                                             casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                             casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                             branchId = ln.BRANCHID,
                                             loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                             applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                             relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                             relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                             misCode = ln.MISCODE,
                                             teamMiscode = ln.TEAMMISCODE,
                                             interestRate = ln.INTERESTRATE,
                                             effectiveDate = ln.EFFECTIVEDATE,
                                             maturityDate = ln.MATURITYDATE,
                                             bookingDate = ln.BOOKINGDATE,
                                             approvedBy = (int)ln.APPROVEDBY,
                                             approverComment = ln.APPROVERCOMMENT,
                                             dateApproved = ln.DATEAPPROVED,
                                             loanStatusId = ln.LOANSTATUSID,
                                             isDisbursed = ln.ISDISBURSED,
                                             disburserComment = ln.DISBURSERCOMMENT,
                                             disburseDate = ln.DISBURSEDATE,
                                             customerGroupId = lp.CUSTOMERGROUPID,
                                             loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                             subSectorId = ln.SUBSECTORID,
                                             subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                             sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                             dischargeLetter = ln.DISCHARGELETTER,
                                             suspendInterest = ln.SUSPENDINTEREST,
                                             customerCode = cu.CUSTOMERCODE,
                                             loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                             customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                             branchName = br.BRANCHNAME,
                                             relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                             relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                             productName = pr.PRODUCTNAME,
                                             comment = "",
                                             productAccountNumber = "N/A",
                                             productAccountName = "N/A",
                                             approvedAmount = ld.APPROVEDAMOUNT,
                                             creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                         }).ToList();


                var termLoanData = dataLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
                var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
                var unionAll = termLoanData.Union(revolvingLoanData).Union(exposureData).Union(exposureDigitalData);

                var data = unionAll;

                return data;
            
        }



        public IEnumerable<GlobalExposureApplicationViewModel> getAllLoansForRecoveryAnalysisByAgent(string source, int staffId, int companyId, DateTime month)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var monthInWord = "";
            if (month.Month == 1)
            {
                monthInWord = "January, " + month.Year;
            }
            if (month.Month == 2)
            {
                monthInWord = "February, " + month.Year;
            }
            if (month.Month == 3)
            {
                monthInWord = "March, " + month.Year;
            }
            if (month.Month == 4)
            {
                monthInWord = "April, " + month.Year;
            }
            if (month.Month == 5)
            {
                monthInWord = "May, " + month.Year;
            }
            if (month.Month == 6)
            {
                monthInWord = "June, " + month.Year;
            }
            if (month.Month == 7)
            {
                monthInWord = "July, " + month.Year;
            }
            if (month.Month == 8)
            {
                monthInWord = "August, " + month.Year;
            }
            if (month.Month == 9)
            {
                monthInWord = "September, " + month.Year;
            }
            if (month.Month == 10)
            {
                monthInWord = "October, " + month.Year;
            }
            if (month.Month == 11)
            {
                monthInWord = "November, " + month.Year;
            }
            if (month.Month == 12)
            {
                monthInWord = "December, " + month.Year;
            }

            DateTime collectionDate = DateTime.ParseExact(monthInWord, "MMMM, yyyy", CultureInfo.InvariantCulture);

            var exposureData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID
                                join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                
                                where
                                lr.ISFULLYRECOVERED == false
                                && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && lr.SOURCE.ToLower() == source.ToLower()
                                && c.CATEGORY.ToLower() == "internal"
                                && lr.DELETED == false
                                && lr.DATEASSIGNED.Month == collectionDate.Month
                                && lr.DATEASSIGNED.Year == collectionDate.Year

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                    totalUnsettledAmount = lr.TOTALAMOUNTRECOVERY,
                                    dpdExposure = ln.ADJFACILITYTYPE == "OVERDRAFT" ? (DbFunctions.DiffDays(ln.MATURITYDATE, ln.DATE)) : ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                    accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                    accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                    category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                    accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                    assignedDate = lr.DATEASSIGNED,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanAssignId = lr.LOANASSIGNID,
                                    agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                }).ToList();

            foreach (var xx in exposureData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                       join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID
                                       join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                
                                where
                                lr.ISFULLYRECOVERED == false
                                && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && lr.SOURCE.ToLower() == source.ToLower()
                                && c.CATEGORY.ToLower() == "internal"
                                && lr.DELETED == false
                                && lr.DATEASSIGNED.Month == collectionDate.Month
                                && lr.DATEASSIGNED.Year == collectionDate.Year

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                    totalUnsettledAmount = lr.TOTALAMOUNTRECOVERY, //ln.TOTALUNSETTLEDAMOUNT,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                    accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                    accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                    category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                    accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                    assignedDate = lr.DATEASSIGNED,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanAssignId = lr.LOANASSIGNID,
                                    agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                }).ToList();

            foreach (var xx in exposureDigitalData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }
            #region
            /*var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                            join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            lr.ISFULLYRECOVERED == false
                            && pr.EXCLUDEFROMLITIGATION == false
                            && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && lr.SOURCE.ToLower() == source.ToLower()
                            && c.CATEGORY.ToLower() == "internal"
                            && lr.DELETED == false

                            select new GlobalExposureApplicationViewModel
                            {
                                assignmentType = lr.ASSIGNMENTTYPE,
                                loanApplicationId = lp.LOANAPPLICATIONID,
                                currencyId = ld.CURRENCYID,
                                agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                expCompletionDate = lr.EXPCOMPLETIONDATE,
                                loanAssignId = lr.LOANASSIGNID,
                                agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productClassId = pr.PRODUCTCLASSID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                totalUnsettledAmount = lr.TOTALAMOUNTRECOVERY,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                     join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     lr.ISFULLYRECOVERED == false
                                     && pr.EXCLUDEFROMLITIGATION == false
                                     && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                     && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                     && lr.SOURCE.ToLower() == source.ToLower()
                                     && c.CATEGORY.ToLower() == "internal"
                                     && lr.DELETED == false

                                     select new GlobalExposureApplicationViewModel
                                     {
                                         assignmentType = lr.ASSIGNMENTTYPE,
                                         loanApplicationId = lp.LOANAPPLICATIONID,
                                         category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                         totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                         totalUnsettledAmount = lr.TOTALAMOUNTRECOVERY,
                                         currencyId = ld.CURRENCYID,
                                         agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                         agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                         accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                         accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                         expCompletionDate = lr.EXPCOMPLETIONDATE,
                                         loanAssignId = lr.LOANASSIGNID,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productClassId = pr.PRODUCTCLASSID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         productAccountNumber = "N/A",
                                         productAccountName = "N/A",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                     }).ToList();


            var termLoanData = dataLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
            var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
            var unionAll = termLoanData.Union(revolvingLoanData).Union(exposureData).Union(exposureDigitalData);*/
            #endregion
            var unionAll = exposureData.Union(exposureDigitalData);

            var data = unionAll;

            return data;
        }



        public IEnumerable<GlobalExposureApplicationViewModel> getAllLoansForRecoveryAnalysisBySingleAgent(string source, int staffId, int companyId)
        {
            var staff = context.TBL_STAFF.Find(staffId);
            var agentId = context.TBL_ACCREDITEDCONSULTANT.Where(s => s.STAFFCODE == staff.STAFFCODE).Select(s => s.ACCREDITEDCONSULTANTID).FirstOrDefault();
            var applicationDate = generalSetup.GetApplicationDate();

            var exposureData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID

                                where
                                lr.ACCREDITEDCONSULTANT == agentId
                                && lr.ISFULLYRECOVERED == false
                                && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && lr.SOURCE.ToLower() == source.ToLower()
                                && c.CATEGORY.ToLower() == "internal"
                                && lr.DELETED == false

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                    accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                    accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                    category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                    accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanAssignId = lr.LOANASSIGNID,
                                    agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                    telephoneNumber = ln.PHONENO,
                                    email = ln.EMAIL
                                }).ToList();

            foreach (var xx in exposureData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID

                                where
                                lr.ACCREDITEDCONSULTANT == agentId
                                && lr.ISFULLYRECOVERED == false
                                && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && lr.SOURCE.ToLower() == source.ToLower()
                                && c.CATEGORY.ToLower() == "internal"
                                && lr.DELETED == false

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                    accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                    accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                    category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                    accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanAssignId = lr.LOANASSIGNID,
                                    agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                }).ToList();

            foreach (var xx in exposureDigitalData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }


            /*var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                            join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            lr.ACCREDITEDCONSULTANT == agentId
                            && lr.ISFULLYRECOVERED == false
                            && pr.EXCLUDEFROMLITIGATION == false
                            && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && lr.SOURCE.ToLower() == source.ToLower()
                            && c.CATEGORY.ToLower() == "internal"
                            && lr.DELETED == false

                            select new GlobalExposureApplicationViewModel
                            {
                                assignmentType = lr.ASSIGNMENTTYPE,
                                loanApplicationId = lp.LOANAPPLICATIONID,
                                currencyId = ld.CURRENCYID,
                                agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                expCompletionDate = lr.EXPCOMPLETIONDATE,
                                loanAssignId = lr.LOANASSIGNID,
                                agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productClassId = pr.PRODUCTCLASSID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                     join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     lr.ACCREDITEDCONSULTANT == agentId
                                     && lr.ISFULLYRECOVERED == false
                                     && pr.EXCLUDEFROMLITIGATION == false
                                     && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                     && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                     && lr.SOURCE.ToLower() == source.ToLower()
                                     && c.CATEGORY.ToLower() == "internal"
                                     && lr.DELETED == false

                                     select new GlobalExposureApplicationViewModel
                                     {
                                         assignmentType = lr.ASSIGNMENTTYPE,
                                         loanApplicationId = lp.LOANAPPLICATIONID,
                                         category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                         totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                         currencyId = ld.CURRENCYID,
                                         agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                         agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                         accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                         accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                         expCompletionDate = lr.EXPCOMPLETIONDATE,
                                         loanAssignId = lr.LOANASSIGNID,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productClassId = pr.PRODUCTCLASSID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         productAccountNumber = "N/A",
                                         productAccountName = "N/A",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                     }).ToList();


            var termLoanData = dataLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
            var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
            var unionAll = termLoanData.Union(revolvingLoanData).Union(exposureData).Union(exposureDigitalData);*/
            var unionAll = exposureData.Union(exposureDigitalData);

            var data = unionAll;

            return data;
        }



        public IEnumerable<GlobalExposureApplicationViewModel> getAllLoansForExternalRecoveryAnalysisByAgent(string source, int staffId, int companyId, DateTime month)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var monthInWord = "";
            if (month.Month == 1)
            {
                monthInWord = "January, " + month.Year;
            }
            if (month.Month == 2)
            {
                monthInWord = "February, " + month.Year;
            }
            if (month.Month == 3)
            {
                monthInWord = "March, " + month.Year;
            }
            if (month.Month == 4)
            {
                monthInWord = "April, " + month.Year;
            }
            if (month.Month == 5)
            {
                monthInWord = "May, " + month.Year;
            }
            if (month.Month == 6)
            {
                monthInWord = "June, " + month.Year;
            }
            if (month.Month == 7)
            {
                monthInWord = "July, " + month.Year;
            }
            if (month.Month == 8)
            {
                monthInWord = "August, " + month.Year;
            }
            if (month.Month == 9)
            {
                monthInWord = "September, " + month.Year;
            }
            if (month.Month == 10)
            {
                monthInWord = "October, " + month.Year;
            }
            if (month.Month == 11)
            {
                monthInWord = "November, " + month.Year;
            }
            if (month.Month == 12)
            {
                monthInWord = "December, " + month.Year;
            }

            DateTime collectionDate = DateTime.ParseExact(monthInWord, "MMMM, yyyy", CultureInfo.InvariantCulture);

            var exposureData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID

                                where
                                lr.ISFULLYRECOVERED == false
                                && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && lr.SOURCE.ToLower() == source.ToLower()
                                && c.CATEGORY.ToLower() == "external"
                                && lr.DELETED == false
                                && lr.DATEASSIGNED.Month == collectionDate.Month
                                && lr.DATEASSIGNED.Year == collectionDate.Year

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                    accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                    accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                    category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                    accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                    assignedDate = lr.DATEASSIGNED,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanAssignId = lr.LOANASSIGNID,
                                    agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                }).ToList();

            foreach (var xx in exposureData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID

                                where
                                lr.ISFULLYRECOVERED == false
                                && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && lr.SOURCE.ToLower() == source.ToLower()
                                && c.CATEGORY.ToLower() == "external"
                                && lr.DELETED == false
                                && lr.DATEASSIGNED.Month == collectionDate.Month
                                && lr.DATEASSIGNED.Year == collectionDate.Year

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                    accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                    accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                    category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                    accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanAssignId = lr.LOANASSIGNID,
                                    agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                }).ToList();

            foreach (var xx in exposureDigitalData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            #region
            /*var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                            join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            lr.ISFULLYRECOVERED == false
                            && pr.EXCLUDEFROMLITIGATION == false
                            && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && lr.SOURCE.ToLower() == source.ToLower()
                            && c.CATEGORY.ToLower() == "external"
                            && lr.DELETED == false

                            select new GlobalExposureApplicationViewModel
                            {
                                assignmentType = lr.ASSIGNMENTTYPE,
                                loanApplicationId = lp.LOANAPPLICATIONID,
                                currencyId = ld.CURRENCYID,
                                agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                expCompletionDate = lr.EXPCOMPLETIONDATE,
                                loanAssignId = lr.LOANASSIGNID,
                                agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productClassId = pr.PRODUCTCLASSID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                     join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     lr.ISFULLYRECOVERED == false
                                     && pr.EXCLUDEFROMLITIGATION == false
                                     && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                     && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                     && lr.SOURCE.ToLower() == source.ToLower()
                                     && c.CATEGORY.ToLower() == "external"
                                     && lr.DELETED == false

                                     select new GlobalExposureApplicationViewModel
                                     {
                                         assignmentType = lr.ASSIGNMENTTYPE,
                                         loanApplicationId = lp.LOANAPPLICATIONID,
                                         category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                         totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                         currencyId = ld.CURRENCYID,
                                         agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                         agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                         accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                         accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                         expCompletionDate = lr.EXPCOMPLETIONDATE,
                                         loanAssignId = lr.LOANASSIGNID,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productClassId = pr.PRODUCTCLASSID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         productAccountNumber = "N/A",
                                         productAccountName = "N/A",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                     }).ToList();


            var termLoanData = dataLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
            var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);*/
            #endregion
            var unionAll = exposureData.Union(exposureDigitalData);

            var data = unionAll;

            return data;
        }

        public bool generateRecoveryMailToAgents(string source, int staffId, int companyId)
        {
            
                var recoveryAgents = (from c in context.TBL_ACCREDITEDCONSULTANT 
                                      join d in context.TBL_LOAN_RECOVERY_ASSIGNMENT on c.ACCREDITEDCONSULTANTID equals d.ACCREDITEDCONSULTANT
                                      where
                                      c.ACCREDITEDCONSULTANTTYPEID == (int)AccreditedConsultantTypeEnum.RecoveryAgent 
                                      && c.DELETED == false select c).ToList();

                if (recoveryAgents.Count() > 0)
                {
                    foreach (var recoveryAgent in recoveryAgents)
                    {
                        var tempResult = string.Empty;
                        var result = string.Empty;
                        AlertsViewModel alert = new AlertsViewModel();
                        List<AlertsViewModel> alerts = new List<AlertsViewModel>();
                        string emailList = "";

                        var exposureData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                            join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                            join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID

                                            where
                                            lr.ACCREDITEDCONSULTANT == recoveryAgent.ACCREDITEDCONSULTANTID
                                            && lr.ISMAILSENT == false
                                            && lr.DELETED == false
                                            && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                            && lr.SOURCE.ToLower() == source.ToLower()

                                            orderby ln.ID descending
                                            select new GlobalExposureApplicationViewModel
                                            {
                                                phoneNo = ln.PHONENO,
                                                email = ln.EMAIL,
                                                loanId = ln.ID,
                                                customerCode = ln.CUSTOMERID,
                                                productCode = ln.PRODUCTID,
                                                applicationReferenceNumber = "",
                                                loanReferenceNumber = ln.REFERENCENUMBER,
                                                customerName = ln.CUSTOMERNAME,
                                                productName = ln.PRODUCTNAME,
                                                relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                                relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                                exposureType = ln.EXPOSURETYPE,
                                                expiryBand = ln.EXPIRINGBAND,
                                                divisionName = ln.DIVISIONNAME,
                                                totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                                dpdExposure = ln.UNPODAYSOVERDUE,
                                                loanCategory = ln.CBNCLASSIFICATION,
                                                casaAccount = ln.ACCOUNTNUMBER,
                                                branchName = ln.BRANCHNAME,
                                                divisionCode = ln.DIVISIONCODE,
                                                region = ln.REGIONCODE,
                                                agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                                category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                                expCompletionDate = lr.EXPCOMPLETIONDATE,
                                                loanAssignId = lr.LOANASSIGNID,
                                                agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                            }).ToList();

                        foreach (var xx in exposureData)
                        {
                            xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                            xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                            xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                            xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
                        }

                        var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                                   join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                                   join c in context.TBL_ACCREDITEDCONSULTANT on lr.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID

                                                   where
                                                   lr.ACCREDITEDCONSULTANT == recoveryAgent.ACCREDITEDCONSULTANTID
                                                   && lr.ISMAILSENT == false
                                                   && lr.DELETED == false
                                                   && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                                   && lr.SOURCE.ToLower() == source.ToLower()

                                                   orderby ln.ID descending
                                                   select new GlobalExposureApplicationViewModel
                                                   {
                                                       phoneNo = ln.PHONENO,
                                                       email = ln.EMAIL,
                                                       loanId = ln.ID,
                                                       customerCode = ln.CUSTOMERID,
                                                       productCode = ln.PRODUCTID,
                                                       applicationReferenceNumber = "",
                                                       loanReferenceNumber = ln.REFERENCENUMBER,
                                                       customerName = ln.CUSTOMERNAME,
                                                       productName = ln.PRODUCTNAME,
                                                       relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                                       relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                                       exposureType = ln.EXPOSURETYPE,
                                                       expiryBand = ln.EXPIRINGBAND,
                                                       divisionName = ln.DIVISIONNAME,
                                                       totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                                       dpdExposure = ln.UNPODAYSOVERDUE,
                                                       loanCategory = ln.CBNCLASSIFICATION,
                                                       casaAccount = ln.ACCOUNTNUMBER,
                                                       branchName = ln.BRANCHNAME,
                                                       divisionCode = ln.DIVISIONCODE,
                                                       region = ln.REGIONCODE,
                                                       agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                                       accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                                       accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                                       category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                                       accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                                       expCompletionDate = lr.EXPCOMPLETIONDATE,
                                                       loanAssignId = lr.LOANASSIGNID,
                                                       agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                                   }).ToList();

                        foreach (var xx in exposureDigitalData)
                        {
                            xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                            xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                            xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                            xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
                        }


                        var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                        join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                        join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                        join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                        join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                        join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                        join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                        join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                        join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                        join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                        where
                                        lr.ACCREDITEDCONSULTANT == recoveryAgent.ACCREDITEDCONSULTANTID
                                        && lr.ISMAILSENT == false
                                        && lr.DELETED == false
                                        && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                        && lr.SOURCE.ToLower() == source.ToLower()

                                        select new GlobalExposureApplicationViewModel
                                        {
                                            loanAssignId = lr.LOANASSIGNID,
                                            totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                            agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                            agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                            accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                            accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                            expCompletionDate = lr.EXPCOMPLETIONDATE,
                                            productName = pr.PRODUCTNAME,
                                            casaAccountId = ln.CASAACCOUNTID,
                                            casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                            casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                            branchId = ln.BRANCHID,
                                            loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                            customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                            branchName = br.BRANCHNAME,
                                            relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                            email = cu.EMAILADDRESS,
                                            phoneNumber = cu.PHONENUMBEROFSIGNATORY,
                                            phoneNo = cu.PHONENUMBEROFSIGNATORY
                                        }).ToList();

                        var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                                 join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                                 join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                                 join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                                 join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                                 join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                                 join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                                 join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                                 join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                                 join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                                 where
                                                 lr.ACCREDITEDCONSULTANT == recoveryAgent.ACCREDITEDCONSULTANTID
                                                 && lr.ISMAILSENT == false
                                                 && lr.DELETED == false
                                                 && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                                 && lr.SOURCE.ToLower() == source.ToLower()

                                                 select new GlobalExposureApplicationViewModel
                                                 {
                                                     loanAssignId = lr.LOANASSIGNID,
                                                     totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                                     agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                                     agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                                     accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                                     accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                                     expCompletionDate = lr.EXPCOMPLETIONDATE,
                                                     productName = pr.PRODUCTNAME,
                                                     casaAccountId = ln.CASAACCOUNTID,
                                                     casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                                     casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                                     branchId = ln.BRANCHID,
                                                     loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                                     customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                                     branchName = br.BRANCHNAME,
                                                     relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                                     email = cu.EMAILADDRESS,
                                                     phoneNumber = cu.PHONENUMBEROFSIGNATORY,
                                                     phoneNo = cu.PHONENUMBEROFSIGNATORY
                                                 }).ToList();


                        var termLoanData = dataLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
                        var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
                        var exposureData2 = exposureData.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
                        var exposureDigitalData2 = exposureDigitalData.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);


                        var unionAll = termLoanData.Union(revolvingLoanData).Union(exposureData2).Union(exposureDigitalData2);

                        var n = 0;
                        var alertTemplate = context.TBL_ALERT_TITLE.Where(x => x.BINDINGMETHOD == "RecoveryAssignmentNotification").Select(x => x).FirstOrDefault();
                    if(alertTemplate == null)
                    {
                        throw new SecureException("Alert template not set");
                    }
                    tempResult = $@"
                             <h3><b>LIST OF RECOVERIES ASSIGNED TO {recoveryAgent.FIRMNAME.ToUpper()}</b></h3>
                             <table cellpadding='0' cellspacing='0' border='1' width='800px'>
                                <tr>
                                    <td><b>S/N</b></td>
                                    <td><b>Customer Name</b></td>
                                    <td><b>Reference Number</b></td>
                                    <td><b>Product Name</b></td>
                                    <td><b>Recovery Account</b></td>
                                    <td><b>Total Recovery Amount</b></td>
                                    <td><b>Relationship Manager</b></td>
                                    <td><b>Expected Completion Date</b></td>
                                    <td><b>Email/Phone Number</b></td>
                                </tr>
                             ";

                        if (unionAll.Count() > 0)
                        {
                            foreach (var single in unionAll)
                            {
                                n++;

                                var amount = string.Format("{0:#,##.00}", Convert.ToDecimal(single.totalAmountRecovery));
                                var expCompletionDate = single.expCompletionDate?.ToString("dd-MM-yyyy");

                                tempResult = tempResult + $@"
                                <tr>
                                    <td>{n}</td>
                                    <td>{single.customerName}</td>
                                    <td>{single.loanReferenceNumber}</td>
                                    <td>{single.productName}</td>
                                    <td>{single.casaAccount}</td>
                                    <td>{$"{amount}"}</td>
                                    <td>{single.relationshipOfficerName}</td>
                                    <td>{expCompletionDate}</td>
                                   <td>{single.email} {single.phoneNo}</td>
                                </tr>
                                ";
                                UpdateMailSent(single.loanAssignId);
                            }

                            tempResult = tempResult + $"</table><br/>";
                            result = tempResult;

                        
                            var template = alertTemplate.TEMPLATE;
                            var title = alertTemplate.TITLE;
                            if (result.Count() > 0 && template.Replace("@{{accountList}}", result).Count() > 0)
                            {
                                template = template.Replace("@{{accountList}}", result.ToString());
                                emailList = recoveryAgent.EMAILADDRESS;
                                alert.receiverEmailList.Add(emailList);
                                alert.template = template;
                                alert.alertTitle = title;
                                alert.canFire = true;
                                alert.operationMethod = alertTemplate.BINDINGMETHOD;
                                alerts.Add(alert);
                            }

                            if (alerts.Count() > 0)
                            {
                                SendAlertNotification(alerts);
                            }
                        
                        }
                    }
                }
                return true;
            
        }


        public IEnumerable<LoanReviewOperationApprovalViewModel> getAllPendingEmailAlert(string source, int staffId, int companyId)
        {
            
                    var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                    where
                                    lr.DELETED == false
                                    && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                    && lr.SOURCE.ToLower() == source.ToLower()
                                    && lr.ISMAILSENT == false

                                    select new LoanReviewOperationApprovalViewModel
                                    {
                                        loanAssignId = lr.LOANASSIGNID,
                                        totalAmountRecovery = (decimal?)lr.TOTALAMOUNTRECOVERY ?? 0,
                                        agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                        agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                        accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                        accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                        expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    }).ToList();

            var unionAll = dataLoan;
                   
            return unionAll;
        }


        private void SendAlertNotification(List<AlertsViewModel> alerts)
        {

            foreach (var alert in alerts)
            {
                if (alert.canFire) LogEmailAlert(alert.template, alert.alertTitle, alert.receiverEmailList, "100442", 0, alert.operationMethod);
            }

        }

        private void UpdateMailSent(int loanAssignId)
        {
            var record = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(loanAssignId);
            record.ISMAILSENT = true;
            context.SaveChanges();
        }

        public IEnumerable<RetailLoanRecoveryCommissionViewModel> getAllRecoveryCommissonByAgents(int staffId, int companyId, DateTime month)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var monthInWord = "";
            if (month.Month == 1)
            {
                monthInWord = "January, " + month.Year;
            }
            if (month.Month == 2)
            {
                monthInWord = "February, " + month.Year;
            }
            if (month.Month == 3)
            {
                monthInWord = "March, " + month.Year;
            }
            if (month.Month == 4)
            {
                monthInWord = "April, " + month.Year;
            }
            if (month.Month == 5)
            {
                monthInWord = "May, " + month.Year;
            }
            if (month.Month == 6)
            {
                monthInWord = "June, " + month.Year;
            }
            if (month.Month == 7)
            {
                monthInWord = "July, " + month.Year;
            }
            if (month.Month == 8)
            {
                monthInWord = "August, " + month.Year;
            }
            if (month.Month == 9)
            {
                monthInWord = "September, " + month.Year;
            }
            if (month.Month == 10)
            {
                monthInWord = "October, " + month.Year;
            }
            if (month.Month == 11)
            {
                monthInWord = "November, " + month.Year;
            }
            if (month.Month == 12)
            {
                monthInWord = "December, " + month.Year;
            }

            DateTime collectionDate = DateTime.ParseExact(monthInWord, "MMMM, yyyy", CultureInfo.InvariantCulture);

            var exposureData = (from lr in context.TBL_LOAN_RECOVERY_COMMISSION_RETAIL
                                join l in context.TBL_LOAN_RECOVERY_ASSIGNMENT on lr.LOANASSIGNID equals l.LOANASSIGNID
                                join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                where
                                l.SOURCE.ToLower() == "retail"
                                && l.DELETED == false
                                && l.DATEASSIGNED.Month == collectionDate.Month
                                && l.DATEASSIGNED.Year == collectionDate.Year

                                orderby ln.ID descending
                                select new RetailLoanRecoveryCommissionViewModel
                                {
                                    agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                    accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                    accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                    accreditedConsultantId = (int)lr.ACCREDITEDCONSULTANT,
                                    loanAssignId = (int)lr.LOANASSIGNID,
                                    agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                    loanId = ln.ID,
                                    expCompletionDate = l.EXPCOMPLETIONDATE,
                                    commissionRate = lr.COMMISSIONRATE,
                                    commissionPayable = lr.COMMISSIONPAYABLE,
                                    modeOfCollection = lr.MODEOFCOLLECTION,
                                    collectionDate = lr.COLLECTIONDATE,
                                    amountRecovered = lr.AMOUNTRECOVERED,
                                    totalRecoveryAmount = (decimal?)lr.TOTALRECOVERYAMOUNT ?? 0,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    productId = (short)l.PRODUCTID,
                                    productClassId = l.PRODUCTCLASSID,
                                    customerId = l.CUSTOMERID,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    comment = "",
                                    creatorName = ln.ACCOUNTOFFICERNAME,
                                    customerCode = ln.CUSTOMERID,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    branchCode = ln.BRANCHCODE,
                                    region = ln.REGIONCODE,
                                    category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                }).ToList();

            var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_COMMISSION_RETAIL
                                join l in context.TBL_LOAN_RECOVERY_ASSIGNMENT on lr.LOANASSIGNID equals l.LOANASSIGNID
                                join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                where
                                l.SOURCE.ToLower() == "retail"
                                && l.DELETED == false
                                && l.DATEASSIGNED.Month == collectionDate.Month
                                && l.DATEASSIGNED.Year == collectionDate.Year

                                orderby ln.ID descending
                                select new RetailLoanRecoveryCommissionViewModel
                                {
                                    agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                    accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                    accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                    accreditedConsultantId = (int)lr.ACCREDITEDCONSULTANT,
                                    loanAssignId = (int)lr.LOANASSIGNID,
                                    agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                    loanId = ln.ID,
                                    expCompletionDate = l.EXPCOMPLETIONDATE,
                                    commissionRate = lr.COMMISSIONRATE,
                                    commissionPayable = lr.COMMISSIONPAYABLE,
                                    modeOfCollection = lr.MODEOFCOLLECTION,
                                    collectionDate = lr.COLLECTIONDATE,
                                    amountRecovered = lr.AMOUNTRECOVERED,
                                    totalRecoveryAmount = (decimal?)lr.TOTALRECOVERYAMOUNT ?? 0,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    productId = (short)l.PRODUCTID,
                                    productClassId = l.PRODUCTCLASSID,
                                    customerId = l.CUSTOMERID,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    comment = "",
                                    creatorName = ln.ACCOUNTOFFICERNAME,
                                    customerCode = ln.CUSTOMERID,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                    
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    branchCode = ln.BRANCHCODE,
                                    region = ln.REGIONCODE,
                                    category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                }).ToList();
            #region
            /*var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_COMMISSION_RETAIL
                            join l in context.TBL_LOAN_RECOVERY_ASSIGNMENT on lr.LOANASSIGNID equals l.LOANASSIGNID
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            where
                            l.SOURCE.ToLower() == "retail"

                            select new RetailLoanRecoveryCommissionViewModel
                            {
                                loanApplicationId = lp.LOANAPPLICATIONID,
                                currencyId = ld.CURRENCYID,
                                agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                accreditedConsultantId = (int)lr.ACCREDITEDCONSULTANT,
                                loanAssignId = (int)lr.LOANASSIGNID,
                                agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                expCompletionDate = l.EXPCOMPLETIONDATE,
                                productId = ln.PRODUCTID,
                                commissionRate = lr.COMMISSIONRATE,
                                commissionPayable = lr.COMMISSIONPAYABLE,
                                modeOfCollection = lr.MODEOFCOLLECTION,
                                collectionDate = lr.COLLECTIONDATE,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                amountRecovered = lr.AMOUNTRECOVERED,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                totalRecoveryAmount = (decimal?)lr.TOTALRECOVERYAMOUNT ?? 0,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_COMMISSION_RETAIL
                                     join l in context.TBL_LOAN_RECOVERY_ASSIGNMENT on lr.LOANASSIGNID equals l.LOANASSIGNID
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     where
                                     l.SOURCE.ToLower() == "retail"

                                     select new RetailLoanRecoveryCommissionViewModel
                                     {
                                         loanApplicationId = lp.LOANAPPLICATIONID,
                                         currencyId = ld.CURRENCYID,
                                         agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                         accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                         accreditedConsultantId = (int)lr.ACCREDITEDCONSULTANT,
                                         loanAssignId = (int)lr.LOANASSIGNID,
                                         agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         expCompletionDate = l.EXPCOMPLETIONDATE,
                                         commissionRate = lr.COMMISSIONRATE,
                                         commissionPayable = lr.COMMISSIONPAYABLE,
                                         modeOfCollection = lr.MODEOFCOLLECTION,
                                         collectionDate = lr.COLLECTIONDATE,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         amountRecovered = lr.AMOUNTRECOVERED,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         totalRecoveryAmount = (decimal?)lr.TOTALRECOVERYAMOUNT ?? 0,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                     }).ToList();


            var termLoanData = dataLoan.OrderByDescending(x => x.accreditedConsultantName);
            var revolvingLoanData = dataRevolvingLoan.OrderByDescending(x => x.accreditedConsultantName);*/
            #endregion
            var unionAll = exposureData.Union(exposureDigitalData);

            var data = unionAll;

            return data;
        }



        public IEnumerable<RetailLoanRecoveryCommissionViewModel> getAllInternalRecoveryCommissonByAgents(int staffId, int companyId, DateTime month)
        {
            var monthInWord = "";
            if (month.Month == 1)
            {
                monthInWord = "January, " + month.Year;
            }
            if (month.Month == 2)
            {
                monthInWord = "February, " + month.Year;
            }
            if (month.Month == 3)
            {
                monthInWord = "March, " + month.Year;
            }
            if (month.Month == 4)
            {
                monthInWord = "April, " + month.Year;
            }
            if (month.Month == 5)
            {
                monthInWord = "May, " + month.Year;
            }
            if (month.Month == 6)
            {
                monthInWord = "June, " + month.Year;
            }
            if (month.Month == 7)
            {
                monthInWord = "July, " + month.Year;
            }
            if (month.Month == 8)
            {
                monthInWord = "August, " + month.Year;
            }
            if (month.Month == 9)
            {
                monthInWord = "September, " + month.Year;
            }
            if (month.Month == 10)
            {
                monthInWord = "October, " + month.Year;
            }
            if (month.Month == 11)
            {
                monthInWord = "November, " + month.Year;
            }
            if (month.Month == 12)
            {
                monthInWord = "December, " + month.Year;
            }

            DateTime collectionDate = DateTime.ParseExact(monthInWord, "MMMM, yyyy", CultureInfo.InvariantCulture);

            var data = (from lr in context.TBL_LOAN_RECOVERY_COMMISSION_INTERNAL
                        where 
                        lr.AMOUNTRECOVERED > 0
                        && lr.VALIDATERECOVERYMONTH.Value.Month == collectionDate.Month
                        && lr.VALIDATERECOVERYMONTH.Value.Year == collectionDate.Year

                        select new RetailLoanRecoveryCommissionViewModel
                            {
                                loanRecoveryCommissionId = lr.LOANRECOVERYCOMMISSIONID,
                                agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                accreditedConsultantId = (int)lr.ACCREDITEDCONSULTANT,
                                agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                commissionRate = lr.COMMISSIONRATE,
                                commissionPayable = lr.COMMISSIONPAYABLE,
                                amountRecovered = lr.AMOUNTRECOVERED,
                                totalRecoveryAmount = (decimal?)lr.TOTALRECOVERYAMOUNT ?? 0,
                                comment = lr.COMMENT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == lr.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                            }).ToList();

            var record = data.GroupBy(x => x.accreditedConsultantId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.accreditedConsultantId);

            return record;
        }


        public IEnumerable<RetailLoanRecoveryCommissionViewModel> getAllRecoveryReportCollectionByAgents(int staffId, int companyId, DateTime month)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var monthInWord = "";
            if (month.Month == 1)
            {
                monthInWord = "January, " + month.Year;
            }
            if (month.Month == 2)
            {
                monthInWord = "February, " + month.Year;
            }
            if (month.Month == 3)
            {
                monthInWord = "March, " + month.Year;
            }
            if (month.Month == 4)
            {
                monthInWord = "April, " + month.Year;
            }
            if (month.Month == 5)
            {
                monthInWord = "May, " + month.Year;
            }
            if (month.Month == 6)
            {
                monthInWord = "June, " + month.Year;
            }
            if (month.Month == 7)
            {
                monthInWord = "July, " + month.Year;
            }
            if (month.Month == 8)
            {
                monthInWord = "August, " + month.Year;
            }
            if (month.Month == 9)
            {
                monthInWord = "September, " + month.Year;
            }
            if (month.Month == 10)
            {
                monthInWord = "October, " + month.Year;
            }
            if (month.Month == 11)
            {
                monthInWord = "November, " + month.Year;
            }
            if (month.Month == 12)
            {
                monthInWord = "December, " + month.Year;
            }

            DateTime collectionDate = DateTime.ParseExact(monthInWord, "MMMM, yyyy", CultureInfo.InvariantCulture);

            var exposureData = (from lr in context.TBL_LOAN_RECOVERY_REPORT_COLLECTION
                                join l in context.TBL_LOAN_RECOVERY_ASSIGNMENT on lr.LOANASSIGNID equals l.LOANASSIGNID
                                join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                where
                                l.SOURCE.ToLower() == "retail"
                                && l.DELETED == false
                                && l.DATEASSIGNED.Month == collectionDate.Month
                                && l.DATEASSIGNED.Year == collectionDate.Year

                                orderby ln.ID descending
                                select new RetailLoanRecoveryCommissionViewModel
                                {
                                    agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                    accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                    accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                    accreditedConsultantId = (int)lr.ACCREDITEDCONSULTANT,
                                    loanAssignId = (int)lr.LOANASSIGNID,
                                    agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                    loanId = ln.ID,
                                    expCompletionDate = l.EXPCOMPLETIONDATE,
                                    modeOfCollection = lr.MODEOFCOLLECTION,
                                    collectionDate = lr.COLLECTIONDATE,
                                    amountRecovered = lr.AMOUNTRECOVERED,
                                    totalRecoveryAmount = (decimal?)lr.TOTALRECOVERYAMOUNT ?? 0,
                                    totalUnsettledAmount = l.TOTALAMOUNTRECOVERY,//ln.TOTALUNSETTLEDAMOUNT,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    productId = (short)l.PRODUCTID,
                                    productClassId = l.PRODUCTCLASSID,
                                    customerId = l.CUSTOMERID,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    comment = "",
                                    creatorName = ln.ACCOUNTOFFICERNAME,
                                    customerCode = ln.CUSTOMERID,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.ADJFACILITYTYPE == "OVERDRAFT" ? (DbFunctions.DiffDays(ln.MATURITYDATE, ln.DATE)) : ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    branchCode = ln.BRANCHCODE,
                                    region = ln.REGIONCODE,
                                    category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                }).ToList();

            var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_REPORT_COLLECTION
                                       join l in context.TBL_LOAN_RECOVERY_ASSIGNMENT on lr.LOANASSIGNID equals l.LOANASSIGNID
                                       join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                       where
                                       l.SOURCE.ToLower() == "retail"
                                       && l.DELETED == false
                                       && l.DATEASSIGNED.Month == collectionDate.Month
                                       && l.DATEASSIGNED.Year == collectionDate.Year

                                       orderby ln.ID descending
                                        select new RetailLoanRecoveryCommissionViewModel
                                        {
                                            agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                            accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                            accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                            accreditedConsultantId = (int)lr.ACCREDITEDCONSULTANT,
                                            loanAssignId = (int)lr.LOANASSIGNID,
                                            agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                            loanId = ln.ID,
                                            expCompletionDate = l.EXPCOMPLETIONDATE,
                                            modeOfCollection = lr.MODEOFCOLLECTION,
                                            collectionDate = lr.COLLECTIONDATE,
                                            amountRecovered = lr.AMOUNTRECOVERED,
                                            totalRecoveryAmount = (decimal?)lr.TOTALRECOVERYAMOUNT ?? 0,
                                            totalUnsettledAmount = l.TOTALAMOUNTRECOVERY, //ln.TOTALUNSETTLEDAMOUNT,
                                            loanReferenceNumber = ln.REFERENCENUMBER,
                                            productId = (short)l.PRODUCTID,
                                            productClassId = l.PRODUCTCLASSID,
                                            customerId = l.CUSTOMERID,
                                            applicationReferenceNumber = ln.REFERENCENUMBER,
                                            comment = "",
                                            creatorName = ln.ACCOUNTOFFICERNAME,
                                            customerCode = ln.CUSTOMERID,
                                            customerName = ln.CUSTOMERNAME,
                                            productName = ln.PRODUCTNAME,
                                            relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                            relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                            totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                            dpdExposure = ln.UNPODAYSOVERDUE,
                                            loanCategory = ln.CBNCLASSIFICATION,
                                            casaAccount = ln.ACCOUNTNUMBER,
                                            branchName = ln.BRANCHNAME,
                                            branchCode = ln.BRANCHCODE,
                                            region = ln.REGIONCODE,
                                            category = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                        }).ToList();
            #region
            /*var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_REPORT_COLLECTION
                            join l in context.TBL_LOAN_RECOVERY_ASSIGNMENT on lr.LOANASSIGNID equals l.LOANASSIGNID
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            where
                            l.SOURCE.ToLower() == "retail"
                            && l.DELETED == false

                            select new RetailLoanRecoveryCommissionViewModel
                            {
                                loanApplicationId = lp.LOANAPPLICATIONID,
                                currencyId = ld.CURRENCYID,
                                agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                accreditedConsultantId = (int)lr.ACCREDITEDCONSULTANT,
                                totalUnsettledAmount = lr.TOTALRECOVERYAMOUNT,
                                loanAssignId = (int)lr.LOANASSIGNID,
                                agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY.ToUpper()).FirstOrDefault(),
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                expCompletionDate = l.EXPCOMPLETIONDATE,
                                productId = ln.PRODUCTID,
                                modeOfCollection = lr.MODEOFCOLLECTION,
                                collectionDate = lr.COLLECTIONDATE,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                amountRecovered = lr.AMOUNTRECOVERED,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                totalRecoveryAmount = (decimal?)lr.TOTALRECOVERYAMOUNT ?? 0,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_REPORT_COLLECTION
                                     join l in context.TBL_LOAN_RECOVERY_ASSIGNMENT on lr.LOANASSIGNID equals l.LOANASSIGNID
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     where
                                     l.SOURCE.ToLower() == "retail"
                                     && l.DELETED == false

                                     select new RetailLoanRecoveryCommissionViewModel
                                     {
                                         loanApplicationId = lp.LOANAPPLICATIONID,
                                         currencyId = ld.CURRENCYID,
                                         agentAccountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.ACCOUNTNUMBER).FirstOrDefault(),
                                         accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                         accreditedConsultantId = (int)lr.ACCREDITEDCONSULTANT,
                                         totalUnsettledAmount = lr.TOTALRECOVERYAMOUNT,
                                         loanAssignId = (int)lr.LOANASSIGNID,
                                         agentCategory = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.CATEGORY).FirstOrDefault(),
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         expCompletionDate = l.EXPCOMPLETIONDATE,
                                         modeOfCollection = lr.MODEOFCOLLECTION,
                                         collectionDate = lr.COLLECTIONDATE,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         amountRecovered = lr.AMOUNTRECOVERED,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         totalRecoveryAmount = (decimal?)lr.TOTALRECOVERYAMOUNT ?? 0,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                     }).ToList();*/

            //var termLoanData = dataLoan.OrderByDescending(x => x.accreditedConsultantName);
            //var revolvingLoanData = dataRevolvingLoan.OrderByDescending(x => x.accreditedConsultantName);
            //var unionAll = termLoanData.Union(revolvingLoanData).Union(exposureData).Union(exposureDigitalData);
            #endregion
            var unionAll = exposureData.Union(exposureDigitalData);

            var data = unionAll;

            return data;
        }

        public IEnumerable<GlobalExposureApplicationViewModel> getAllLoansRecoveryAnalysisByAgent(int staffId, int companyId, int accreditedConsultantId, string referenceId)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var exposureData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                where
                                lr.DELETED == false
                                && lr.ISFULLYRECOVERED == false
                                && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                && lr.REFERENCEID == referenceId

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = "",
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE
                                }).ToList();

            foreach (var xx in exposureData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                where
                                lr.DELETED == false
                                && lr.ISFULLYRECOVERED == false
                                && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                && lr.REFERENCEID == referenceId

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = "",
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                }).ToList();

            foreach (var xx in exposureDigitalData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            /*var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            lr.DELETED == false
                            && lr.ISFULLYRECOVERED == false
                                && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                && pr.EXCLUDEFROMLITIGATION == false
                                && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && lr.REFERENCEID == referenceId

                            select new GlobalExposureApplicationViewModel
                            {
                                assignmentType = lr.ASSIGNMENTTYPE,
                                expCompletionDate = lr.EXPCOMPLETIONDATE,
                                loanAssignId = lr.LOANASSIGNID,
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL, 
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                totalAmountRecovery = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL),
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = ""
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     lr.DELETED == false
                                       && lr.ISFULLYRECOVERED == false
                                        && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                        && pr.EXCLUDEFROMLITIGATION == false
                                        && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                        && lr.REFERENCEID == referenceId

                                     select new GlobalExposureApplicationViewModel
                                     {
                                         assignmentType = lr.ASSIGNMENTTYPE,
                                         totalAmountRecovery = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                         expCompletionDate = lr.EXPCOMPLETIONDATE,
                                         loanAssignId = lr.LOANASSIGNID,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                     }).ToList();


            var data = dataLoan.Union(dataRevolvingLoan).Union(exposureData).Union(exposureDigitalData);*/
            var data = exposureData.Union(exposureDigitalData);

            return data;
        }


        public IEnumerable<GlobalExposureApplicationViewModel> getAllUnassignLoansRecoveryAnalysisByAgent(int staffId, int companyId, int accreditedConsultantId, int referenceId)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var exposureData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                where
                                lr.DELETED == false
                                && lr.ISFULLYRECOVERED == false
                                && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                && lr.LOANASSIGNID == referenceId

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = "",
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                }).ToList();

            foreach (var xx in exposureData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                where
                                lr.DELETED == false
                                && lr.ISFULLYRECOVERED == false
                                && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                && lr.LOANASSIGNID == referenceId

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = ln.REFERENCENUMBER,
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                }).ToList();

            foreach (var xx in exposureDigitalData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            /*var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            lr.DELETED == false
                            && lr.ISFULLYRECOVERED == false
                                && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                && pr.EXCLUDEFROMLITIGATION == false
                                && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && lr.LOANASSIGNID == referenceId

                            select new GlobalExposureApplicationViewModel
                            {
                                assignmentType = lr.ASSIGNMENTTYPE,
                                expCompletionDate = lr.EXPCOMPLETIONDATE,
                                loanAssignId = lr.LOANASSIGNID,
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                totalAmountRecovery = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL),
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = ""
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     lr.DELETED == false
                                       && lr.ISFULLYRECOVERED == false
                                        && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                        && pr.EXCLUDEFROMLITIGATION == false
                                        && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                        && lr.LOANASSIGNID == referenceId

                                     select new GlobalExposureApplicationViewModel
                                     {
                                         assignmentType = lr.ASSIGNMENTTYPE,
                                         totalAmountRecovery = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                         expCompletionDate = lr.EXPCOMPLETIONDATE,
                                         loanAssignId = lr.LOANASSIGNID,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                     }).ToList();


            var data = dataLoan.Union(dataRevolvingLoan).Union(exposureData).Union(exposureDigitalData);*/
            var data = exposureData.Union(exposureDigitalData);

            return data; 
        }

        public IEnumerable<GlobalExposureApplicationViewModel> getAllLoansRecoveryAnalysisByAgentRemedial(int staffId, int companyId, int accreditedConsultantId, string referenceId)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var exposureData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                where
                                lr.ISFULLYRECOVERED == false
                                && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && lr.DELETED == false
                                && lr.REFERENCEID == referenceId

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = "",
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    assignmentType = lr.ASSIGNMENTTYPE,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanAssignId = lr.LOANASSIGNID,
                                    totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                }).ToList();

            foreach (var xx in exposureData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var exposureDigitalData = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                where
                                lr.ISFULLYRECOVERED == false
                                && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && lr.DELETED == false
                                && lr.REFERENCEID == referenceId

                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = "",
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    assignmentType = lr.ASSIGNMENTTYPE,
                                    expCompletionDate = lr.EXPCOMPLETIONDATE,
                                    loanAssignId = lr.LOANASSIGNID,
                                    totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                }).ToList();

            foreach (var xx in exposureDigitalData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            /*var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            lr.ISFULLYRECOVERED == false
                            && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                            && pr.EXCLUDEFROMLITIGATION == false
                            && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && lr.DELETED == false
                            && lr.REFERENCEID == referenceId

                            select new GlobalExposureApplicationViewModel
                            {
                                assignmentType = lr.ASSIGNMENTTYPE,
                                expCompletionDate = lr.EXPCOMPLETIONDATE,
                                loanAssignId = lr.LOANASSIGNID,
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                totalAmountRecovery = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL),
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = ""
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_ASSIGNMENT
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     lr.ISFULLYRECOVERED == false
                                     && lr.ACCREDITEDCONSULTANT == accreditedConsultantId
                                     && pr.EXCLUDEFROMLITIGATION == false
                                     && lr.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                     && lr.DELETED == false
                                     && lr.REFERENCEID == referenceId

                                     select new GlobalExposureApplicationViewModel
                                     {
                                         assignmentType = lr.ASSIGNMENTTYPE,
                                         totalAmountRecovery = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                         expCompletionDate = lr.EXPCOMPLETIONDATE,
                                         loanAssignId = lr.LOANASSIGNID,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                     }).ToList();

            var data = dataLoan.Union(dataRevolvingLoan).Union(exposureData).Union(exposureDigitalData);*/
            var data = exposureData.Union(exposureDigitalData);

            return data; 
        }

        public IEnumerable<GlobalExposureApplicationViewModel> GetAllLoansRecoveredByAgent(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var exposureData = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                                join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = "",
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                }).ToList();

            foreach (var xx in exposureData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var exposureDigitalData = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                                join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                orderby ln.ID descending
                                select new GlobalExposureApplicationViewModel
                                {
                                    loanId = ln.ID,
                                    customerCode = ln.CUSTOMERID,
                                    productCode = ln.PRODUCTID,
                                    applicationReferenceNumber = "",
                                    loanReferenceNumber = ln.REFERENCENUMBER,
                                    customerName = ln.CUSTOMERNAME,
                                    productName = ln.PRODUCTNAME,
                                    relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                    exposureType = ln.EXPOSURETYPE,
                                    expiryBand = ln.EXPIRINGBAND,
                                    divisionName = ln.DIVISIONNAME,
                                    totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                    dpdExposure = ln.UNPODAYSOVERDUE,
                                    loanCategory = ln.CBNCLASSIFICATION,
                                    casaAccount = ln.ACCOUNTNUMBER,
                                    branchName = ln.BRANCHNAME,
                                    divisionCode = ln.DIVISIONCODE,
                                    region = ln.REGIONCODE,
                                    totalUnsettledAmount = ln.TOTALUNSETTLEDAMOUNT,
                                }).ToList();

            foreach (var xx in exposureDigitalData)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            /*var dataLoan = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                            join ln in context.TBL_LOAN on lr.LOANID equals ln.TERMLOANID
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            //join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            pr.EXCLUDEFROMLITIGATION == false
                            && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                            select new GlobalExposureApplicationViewModel
                            {
                                loanApplicationId = lp.LOANAPPLICATIONID,
                                currencyId = ld.CURRENCYID,
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                agentCommission = lr.RECOVEREDAMOUNT*(lr.PERCENTAGECOMMISSION/100),
                                percentageCommission = lr.PERCENTAGECOMMISSION,

                                collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                isFullyRecovered = lr.ISFULLYRECOVERED,
                                fileName = lr.FILENAME,
                                fileExtension = lr.FILEEXTENSION,
                                fileSize = lr.FILESIZE,
                                fileSizeUnit = lr.FILESIZEUNIT,
                                receiptDate = lr.RECEIPTDATE,
                                totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                recoveredAmount = lr.RECOVEREDAMOUNT,
                                outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                collateralCode = lr.COLLATERALCODE,
                                collectionMode = lr.COLLECTIONMODE,
                                createdBy = lr.CREATEDBY,
                                //dateTimeCreated = lr.DATETIMECREATED,

                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANID equals ln.REVOLVINGLOANID
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     pr.EXCLUDEFROMLITIGATION == false
                                     && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                                     select new GlobalExposureApplicationViewModel
                                     {
                                         loanApplicationId = lp.LOANAPPLICATIONID,
                                         currencyId = ld.CURRENCYID,
                                         accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                         accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                         agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                         percentageCommission = lr.PERCENTAGECOMMISSION,

                                         collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                         accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                         isFullyRecovered = lr.ISFULLYRECOVERED,
                                         fileName = lr.FILENAME,
                                         fileExtension = lr.FILEEXTENSION,
                                         fileSize = lr.FILESIZE,
                                         fileSizeUnit = lr.FILESIZEUNIT,
                                         receiptDate = lr.RECEIPTDATE,
                                         totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                         recoveredAmount = lr.RECOVEREDAMOUNT,
                                         outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                         collateralCode = lr.COLLATERALCODE,
                                         collectionMode = lr.COLLECTIONMODE,
                                         createdBy = lr.CREATEDBY,
                                         //dateTimeCreated = lr.DATETIMECREATED,

                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                     }).ToList();


           // var termLoanData = dataLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
            //var revolvingLoanData = dataRevolvingLoan.GroupBy(x => x.loanReferenceNumber).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanReferenceNumber);
            var unionAll = dataLoan.Union(dataRevolvingLoan).Union(exposureDigitalData);
            */

            var data = exposureData.Union(exposureDigitalData);

            return data;
        }

        public bool CreditDocumentationFilling(CreditDocumentationViewModel model)
        {
            if (model == null)
            {
                throw new ConditionNotMetException("Error loan id requred");
            }

            var validate = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(x => x.REQUESTID == model.requestId
                                                          && (x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Pending
                                                          || x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved)).FirstOrDefault();
            if (validate != null)
            {
                throw new SecureException("Request already exist and undergoing approval");
            }

            if (validate == null)
            {
                TBL_DOCUMENTATION_FILLING_APPROVAL _FILLING_APPROVAL = new TBL_DOCUMENTATION_FILLING_APPROVAL();
                _FILLING_APPROVAL.LOANID = model.loanId;
                _FILLING_APPROVAL.CREATEDBY = model.createdBy;
                _FILLING_APPROVAL.LOANREFERENCE = model.loanReferenceNumber;
                _FILLING_APPROVAL.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                _FILLING_APPROVAL.COMMENT = "Kindly help approve approve the printed document for filling";
                _FILLING_APPROVAL.DATETIMECREATED = DateTime.Now;
                _FILLING_APPROVAL.MODULE = "LMS";
                _FILLING_APPROVAL.REQUESTID = model.requestId;
                context.TBL_DOCUMENTATION_FILLING_APPROVAL.Add(_FILLING_APPROVAL);
            }
            return context.SaveChanges() > 0;
        }

        public bool CreditDocumentationFillingLos(CreditDocumentationViewModel model)
        {
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);
            if (model == null)
            {
                throw new ConditionNotMetException("Error loan id requred");
            }

            var validate = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Where(x => x.LOANREFERENCE == model.loanReferenceNumber
                                                          && (x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                                          || x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved)).FirstOrDefault();
            if (validate != null)
            {
                throw new SecureException("Request already exist and undergoing approval");
            }

                if (validate == null)
                {
                    TBL_DOCUMENTATION_FILLING_APPROVAL _FILLING_APPROVAL = new TBL_DOCUMENTATION_FILLING_APPROVAL();
                    _FILLING_APPROVAL.LOANID = model.loanId;
                    _FILLING_APPROVAL.CREATEDBY = model.createdBy;
                    _FILLING_APPROVAL.LOANREFERENCE = model.loanReferenceNumber;
                    _FILLING_APPROVAL.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    _FILLING_APPROVAL.COMMENT = "Kindly help approve approve the printed document for filling";
                    _FILLING_APPROVAL.DATETIMECREATED = DateTime.Now;
                    _FILLING_APPROVAL.MODULE = "LOS";
                    context.TBL_DOCUMENTATION_FILLING_APPROVAL.Add(_FILLING_APPROVAL);
            }
            return context.SaveChanges() >0;
        }

        // ================== recovery commission

        public IEnumerable<GlobalExposureApplicationViewModel> getAllPaymentRecoveredCommissionByAgent(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var loansId = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.DELETED == false).Select(x => x.LOANRECOVERYREPORTBATCHID).ToList();

            var dataLoanExposure = (from l in context.TBL_LOAN_RECOVERY_REPORTING_BATCH
                            join lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY on l.COLLATERALLIQUIDATIONRECOVERYID equals lr.COLLATERALLIQUIDATIONRECOVERYID
                            join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                            where
                            l.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && !loansId.Contains(l.LOANRECOVERYREPORTBATCHID)

                            select new GlobalExposureApplicationViewModel
                            {
                                loanRecoveryReportBatchId = l.LOANRECOVERYREPORTBATCHID,
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                percentageCommission = lr.PERCENTAGECOMMISSION,
                                loanCategory = ln.CBNCLASSIFICATION,
                                collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                isFullyRecovered = lr.ISFULLYRECOVERED,
                                fileName = lr.FILENAME,
                                fileExtension = lr.FILEEXTENSION,
                                fileSize = lr.FILESIZE,
                                fileSizeUnit = lr.FILESIZEUNIT,
                                receiptDate = lr.RECEIPTDATE,
                                totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                recoveredAmount = lr.RECOVEREDAMOUNT,
                                outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                collateralCode = lr.COLLATERALCODE,
                                collectionMode = lr.COLLECTIONMODE,
                                createdBy = lr.CREATEDBY,
                                loanId = ln.ID,
                                casaAccount = ln.ACCOUNTNUMBER,
                                amount = (decimal)ln.TOTALEXPOSURE,
                                loanReferenceNumber = ln.REFERENCENUMBER,
                                applicationReferenceNumber = ln.REFERENCENUMBER,
                                misCode = ln.ACCOUNTOFFICERCODE,
                                recoveryMisCode = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Where(x => x.REFERENCEID == l.REFERENCEID).Select(x => x.MISCODE).FirstOrDefault(),
                                recoveryRegion = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Where(x => x.REFERENCEID == l.REFERENCEID).Select(x => x.REGION).FirstOrDefault(),
                                teamMiscode = ln.TEAMCODE,
                                principalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                sectorName = ln.CBNSECTOR,
                                outstandingPrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                customerCode = ln.CUSTOMERID,
                                customerName = ln.CUSTOMERNAME,
                                branchName = ln.BRANCHNAME,
                                relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                productName = ln.PRODUCTNAME,
                                comment = "",
                                approvedAmount = ln.LOANAMOUNYLCY,
                                creatorName = ln.ACCOUNTOFFICERNAME,
                                pastDueInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                pastDuePrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                interestOnPastDueInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                interestOnPastDuePrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                outstandingInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                            }).ToList();

            foreach (var xx in dataLoanExposure)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var dataDigitalLoanExposure = (from l in context.TBL_LOAN_RECOVERY_REPORTING_BATCH
                                    join lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY on l.COLLATERALLIQUIDATIONRECOVERYID equals lr.COLLATERALLIQUIDATIONRECOVERYID
                                    join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                    where
                                    l.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                    && !loansId.Contains(l.LOANRECOVERYREPORTBATCHID)

                                    select new GlobalExposureApplicationViewModel
                                    {
                                        loanRecoveryReportBatchId = l.LOANRECOVERYREPORTBATCHID,
                                        accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                        accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                        accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                        agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                        percentageCommission = lr.PERCENTAGECOMMISSION,
                                        loanCategory = ln.CBNCLASSIFICATION,
                                        collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                        accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                        isFullyRecovered = lr.ISFULLYRECOVERED,
                                        fileName = lr.FILENAME,
                                        fileExtension = lr.FILEEXTENSION,
                                        fileSize = lr.FILESIZE,
                                        fileSizeUnit = lr.FILESIZEUNIT,
                                        receiptDate = lr.RECEIPTDATE,
                                        totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                        recoveredAmount = lr.RECOVEREDAMOUNT,
                                        outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                        collateralCode = lr.COLLATERALCODE,
                                        collectionMode = lr.COLLECTIONMODE,
                                        createdBy = lr.CREATEDBY,
                                        loanId = ln.ID,
                                        casaAccount = ln.ACCOUNTNUMBER,
                                        amount = (decimal)ln.TOTALEXPOSURE,
                                        loanReferenceNumber = ln.REFERENCENUMBER,
                                        applicationReferenceNumber = ln.REFERENCENUMBER,
                                        misCode = ln.ACCOUNTOFFICERCODE,
                                        recoveryMisCode = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Where(x => x.REFERENCEID == l.REFERENCEID).Select(x => x.MISCODE).FirstOrDefault(),
                                        recoveryRegion = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Where(x => x.REFERENCEID == l.REFERENCEID).Select(x => x.REGION).FirstOrDefault(),
                                        teamMiscode = ln.TEAMCODE,
                                        principalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        sectorName = ln.CBNSECTOR,
                                        outstandingPrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        customerCode = ln.CUSTOMERID,
                                        customerName = ln.CUSTOMERNAME,
                                        branchName = ln.BRANCHNAME,
                                        relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                        relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                        productName = ln.PRODUCTNAME,
                                        comment = "",
                                        approvedAmount = ln.LOANAMOUNYLCY,
                                        creatorName = ln.ACCOUNTOFFICERNAME,
                                        pastDueInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                        pastDuePrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        interestOnPastDueInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                        interestOnPastDuePrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        outstandingInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                    }).ToList();

            foreach (var xx in dataDigitalLoanExposure)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var dataLoan = (from l in context.TBL_LOAN_RECOVERY_REPORTING_BATCH
                            join lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY on l.COLLATERALLIQUIDATIONRECOVERYID equals lr.COLLATERALLIQUIDATIONRECOVERYID
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            l.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && !loansId.Contains(l.LOANRECOVERYREPORTBATCHID)

                            select new GlobalExposureApplicationViewModel
                            {
                                loanApplicationId = lp.LOANAPPLICATIONID,
                                currencyId = ld.CURRENCYID,
                                loanRecoveryReportBatchId = l.LOANRECOVERYREPORTBATCHID,
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                percentageCommission = lr.PERCENTAGECOMMISSION,
                                loanCategory = context.TBL_LOAN_REVIEW_OPERATION.Where(l => l.LOANID == ln.TERMLOANID).Select(l => l.OPERATIONTYPEID).FirstOrDefault() == (int)OperationsEnum.CompleteWriteOff ? "Written Off" : "Non Performing",
                                collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                isFullyRecovered = lr.ISFULLYRECOVERED,
                                fileName = lr.FILENAME,
                                fileExtension = lr.FILEEXTENSION,
                                fileSize = lr.FILESIZE,
                                fileSizeUnit = lr.FILESIZEUNIT,
                                receiptDate = lr.RECEIPTDATE,
                                totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                recoveredAmount = lr.RECOVEREDAMOUNT,
                                outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                collateralCode = lr.COLLATERALCODE,
                                collectionMode = lr.COLLECTIONMODE,
                                createdBy = lr.CREATEDBY,
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                recoveryMisCode = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Where(x => x.REFERENCEID == l.REFERENCEID).Select(x => x.MISCODE).FirstOrDefault(),
                                recoveryRegion = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Where(x => x.REFERENCEID == l.REFERENCEID).Select(x => x.REGION).FirstOrDefault(),
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                            }).ToList();

            var dataRevolvingLoan = (from l in context.TBL_LOAN_RECOVERY_REPORTING_BATCH
                                     join lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY on l.COLLATERALLIQUIDATIONRECOVERYID equals lr.COLLATERALLIQUIDATIONRECOVERYID
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     l.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                     && !loansId.Contains(l.LOANRECOVERYREPORTBATCHID)
                                     
                                     select new GlobalExposureApplicationViewModel
                                     {
                                         loanApplicationId = lp.LOANAPPLICATIONID,
                                         loanRecoveryReportBatchId = l.LOANRECOVERYREPORTBATCHID,
                                         currencyId = ld.CURRENCYID,
                                         accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                         accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                         agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                         percentageCommission = lr.PERCENTAGECOMMISSION,
                                         loanCategory = context.TBL_LOAN_REVIEW_OPERATION.Where(l => l.LOANID == ln.REVOLVINGLOANID).Select(l => l.OPERATIONTYPEID).FirstOrDefault() == (int)OperationsEnum.CompleteWriteOff ? "Written Off" : "Non Performing",
                                         collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                         accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                         isFullyRecovered = lr.ISFULLYRECOVERED,
                                         fileName = lr.FILENAME,
                                         fileExtension = lr.FILEEXTENSION,
                                         fileSize = lr.FILESIZE,
                                         fileSizeUnit = lr.FILESIZEUNIT,
                                         receiptDate = lr.RECEIPTDATE,
                                         totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                         recoveredAmount = lr.RECOVEREDAMOUNT,
                                         outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                         collateralCode = lr.COLLATERALCODE,
                                         collectionMode = lr.COLLECTIONMODE,
                                         createdBy = lr.CREATEDBY,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         recoveryMisCode = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Where(x => x.REFERENCEID == l.REFERENCEID).Select(x => x.MISCODE).FirstOrDefault(),
                                         recoveryRegion = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Where(x => x.REFERENCEID == l.REFERENCEID).Select(x => x.REGION).FirstOrDefault(),
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                     }).ToList();


            var unionAll = dataLoan.Union(dataRevolvingLoan).Union(dataLoanExposure).Union(dataDigitalLoanExposure);

            var data = unionAll;

            return data;
        }

        public IEnumerable<LoanRecoveryCommissionApprovalViewModel> BulkRecoveryCommissionApplicationList(int staffId, int companyId)
        {
            var dataLoan = (from ln in context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL
                            where
                            ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending

                            select new LoanRecoveryCommissionApprovalViewModel
                            {
                                referenceId = ln.REFERENCEID,
                                loanRecoveryCommissionApprovalId = ln.LOANRECOVERYCOMMISSIONAPPROVALID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Count(),
                                approvalStatusId = (int)ln.APPROVALSTATUSID,
                                dateTimeCreated = ln.DATETIMECREATED,
                                operationId = ln.OPERATIONID,
                                misCode = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.MISCODE).FirstOrDefault(),
                                region = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.REGION).FirstOrDefault(),
                                agentAccountNumber = (from a in context.TBL_LOAN_RECOVERY_COMMISSION_BATCH join c in context.TBL_ACCREDITEDCONSULTANT on a.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID select c.ACCOUNTNUMBER).FirstOrDefault(),
                                dateOfEngagement = (from a in context.TBL_LOAN_RECOVERY_COMMISSION_BATCH join c in context.TBL_ACCREDITEDCONSULTANT on a.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID select c.DATEOFENGAGEMENT).FirstOrDefault(),
                            }).ToList();
            var LoanData = dataLoan.GroupBy(x => x.loanRecoveryCommissionApprovalId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanRecoveryCommissionApprovalId);
            foreach(var i in LoanData)
            {
                 var recoveryCommission = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(s => s.REFERENCEID == i.referenceId).Select(s => s).FirstOrDefault();
                i.amountRecovered = recoveryCommission.AMOUNTRECOVERED;
                var recoveryReport = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Where(s => s.LOANRECOVERYREPORTBATCHID == (int)recoveryCommission.LOANRECOVERYREPORTBATCHID).Select(s => s).FirstOrDefault();
                var captureRecovery = context.TBL_COLLATERAL_LIQUIDATION_RECOVERY.Where(s => s.COLLATERALLIQUIDATIONRECOVERYID == (int)recoveryReport.COLLATERALLIQUIDATIONRECOVERYID).Select(s => s).FirstOrDefault();
                i.commissionRate = captureRecovery.PERCENTAGECOMMISSION;
            }
            return LoanData;
        }

        public IEnumerable<LoanRecoveryCommissionApprovalViewModel> GetBulkRecoveryCommissionAwaitingApprovalList(int staffId, int companyId)
        {
            var dataLoan = (from ln in context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL
                            join atrail in context.TBL_APPROVAL_TRAIL on ln.LOANRECOVERYCOMMISSIONAPPROVALID equals atrail.TARGETID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Disapproved)
                            && atrail.OPERATIONID == ln.OPERATIONID

                            select new LoanRecoveryCommissionApprovalViewModel
                            {
                                currentApprovalLevelId = atrail.TOAPPROVALLEVELID,
                                referenceId = ln.REFERENCEID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Count(),
                                approvalStatusId = ln.APPROVALSTATUSID,
                                approverComment = atrail.COMMENT,
                                dateTimeCreated = ln.DATETIMECREATED,
                                loanRecoveryCommissionApprovalId = ln.LOANRECOVERYCOMMISSIONAPPROVALID,
                                operationId = ln.OPERATIONID,
                                misCode = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.MISCODE).FirstOrDefault(),
                                region = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.REGION).FirstOrDefault(),
                                agentAccountNumber = (from a in context.TBL_LOAN_RECOVERY_COMMISSION_BATCH join c in context.TBL_ACCREDITEDCONSULTANT on a.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID select c.ACCOUNTNUMBER).FirstOrDefault(),
                                dateOfEngagement = (from a in context.TBL_LOAN_RECOVERY_COMMISSION_BATCH join c in context.TBL_ACCREDITEDCONSULTANT on a.ACCREDITEDCONSULTANT equals c.ACCREDITEDCONSULTANTID select c.DATEOFENGAGEMENT).FirstOrDefault(),
                            }).ToList();
            var LoanData = dataLoan.GroupBy(x => x.loanRecoveryCommissionApprovalId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanRecoveryCommissionApprovalId);

            return LoanData;
        }


        public IEnumerable<GlobalExposureApplicationViewModel> getAllLoansRecoveryCommissionByReference(int staffId, int companyId, string referenceId)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var dataLoanExposure = (from lr in context.TBL_LOAN_RECOVERY_COMMISSION_BATCH
                                    join c in context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL on lr.REFERENCEID equals c.REFERENCEID
                                    join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCENUMBER equals ln.REFERENCENUMBER
                                    where
                                    lr.REFERENCEID == referenceId
                                    && lr.LOANREFERENCENUMBER == ln.REFERENCENUMBER
                                    select new GlobalExposureApplicationViewModel
                                    {
                                        loanRecoveryCommissionBatchId = lr.LOANRECOVERYCOMMISSIONBATCHID,
                                        recoveryMisCode = lr.MISCODE,
                                        region = lr.REGION,
                                        creditToAgent = lr.COMMISSIONAMOUNTLESSWHT,
                                        amountToDebit = lr.COMMISSIONAMOUNTLESSWHT,
                                        amountToCredit = lr.COMMISSIONAMOUNTLESSWHT,
                                        dateOfEngagement = context.TBL_ACCREDITEDCONSULTANT.Where(a => a.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(a => a.DATEOFENGAGEMENT).FirstOrDefault(),
                                        accountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(a => a.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(a => a.ACCOUNTNUMBER).FirstOrDefault(),
                                        loanId = ln.ID,
                                        totalAllrecoveryAmount = lr.TOTALAMOUNTRECOVERY,
                                        outstandingAmount = (lr.TOTALAMOUNTRECOVERY - lr.AMOUNTRECOVERED),
                                        accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(d => d.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(d => d.FIRMNAME).FirstOrDefault(),
                                        amountRecovered = (decimal)lr.AMOUNTRECOVERED,
                                        casaAccount = ln.ACCOUNTNUMBER,
                                        casaAccountName = "CURRENT ACCOUNT",
                                        accountBalance = 0,
                                        amount = (decimal)ln.LOANAMOUNYLCY,
                                        loanReferenceNumber = ln.REFERENCENUMBER,
                                        applicationReferenceNumber = ln.REFERENCENUMBER,
                                        misCode = ln.ACCOUNTOFFICERCODE,
                                        teamMiscode = ln.TEAMCODE,
                                        principalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        sectorName = ln.CBNSECTOR,
                                        outstandingPrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                        customerCode = ln.CUSTOMERID,
                                        customerName = ln.CUSTOMERNAME,
                                        branchCode = ln.BRANCHCODE,
                                        branchName = ln.BRANCHNAME,
                                        relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                        relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                        productName = ln.PRODUCTNAME,
                                        comment = "",
                                        commissionAmountLessWht = lr.COMMISSIONAMOUNTLESSWHT,
                                        whtAmount = lr.WHTAMOUNT,
                                        whtRate = lr.WHTRATE,
                                        commissionAmount = lr.COMMISSIONAMOUNT,
                                    }).ToList();

            foreach (var xx in dataLoanExposure)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }


            var dataDigitalLoanExposure = (from lr in context.TBL_LOAN_RECOVERY_COMMISSION_BATCH
                                    join c in context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL on lr.REFERENCEID equals c.REFERENCEID
                                    join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCENUMBER equals ln.REFERENCENUMBER
                                    where
                                    lr.REFERENCEID == referenceId
                                    && lr.LOANREFERENCENUMBER == ln.REFERENCENUMBER
                                    select new GlobalExposureApplicationViewModel
                                    {
                                        loanRecoveryCommissionBatchId = lr.LOANRECOVERYCOMMISSIONBATCHID,
                                        recoveryMisCode = lr.MISCODE,
                                        region = lr.REGION,
                                        creditToAgent = lr.COMMISSIONAMOUNTLESSWHT,
                                        amountToDebit = lr.COMMISSIONAMOUNTLESSWHT,
                                        amountToCredit = lr.COMMISSIONAMOUNTLESSWHT,
                                        dateOfEngagement = context.TBL_ACCREDITEDCONSULTANT.Where(a => a.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(a => a.DATEOFENGAGEMENT).FirstOrDefault(),
                                        accountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(a => a.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(a => a.ACCOUNTNUMBER).FirstOrDefault(),
                                        loanId = ln.ID,
                                        totalAllrecoveryAmount = lr.TOTALAMOUNTRECOVERY,
                                        outstandingAmount = (lr.TOTALAMOUNTRECOVERY - lr.AMOUNTRECOVERED),
                                        accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(d => d.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(d => d.FIRMNAME).FirstOrDefault(),
                                        amountRecovered = (decimal)lr.AMOUNTRECOVERED,
                                        casaAccount = ln.ACCOUNTNUMBER,
                                        casaAccountName = "CURRENT ACCOUNT",
                                        accountBalance = 0,
                                        amount = (decimal)ln.LOANAMOUNYLCY,
                                        loanReferenceNumber = ln.REFERENCENUMBER,
                                        applicationReferenceNumber = ln.REFERENCENUMBER,
                                        misCode = ln.ACCOUNTOFFICERCODE,
                                        teamMiscode = ln.TEAMCODE,
                                        principalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        sectorName = ln.CBNSECTOR,
                                        outstandingPrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                        customerCode = ln.CUSTOMERID,
                                        customerName = ln.CUSTOMERNAME,
                                        branchCode = ln.BRANCHCODE,
                                        branchName = ln.BRANCHNAME,
                                        relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                        relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                        productName = ln.PRODUCTNAME,
                                        comment = "",
                                        commissionAmountLessWht = lr.COMMISSIONAMOUNTLESSWHT,
                                        whtAmount = lr.WHTAMOUNT,
                                        whtRate = lr.WHTRATE,
                                        commissionAmount = lr.COMMISSIONAMOUNT,
                                    }).ToList();

            foreach (var xx in dataDigitalLoanExposure)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }



            var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_COMMISSION_BATCH
                            join c in context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL on lr.REFERENCEID equals c.REFERENCEID
                            join ln in context.TBL_LOAN on lr.LOANREFERENCENUMBER equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            lr.REFERENCEID == referenceId
                            && lr.LOANREFERENCENUMBER == ln.LOANREFERENCENUMBER
                            select new GlobalExposureApplicationViewModel
                            {
                                loanRecoveryCommissionBatchId = lr.LOANRECOVERYCOMMISSIONBATCHID,
                                recoveryMisCode = lr.MISCODE,
                                region = lr.REGION,
                                creditToAgent = lr.COMMISSIONAMOUNTLESSWHT, 
                                amountToDebit = lr.COMMISSIONAMOUNTLESSWHT, 
                                amountToCredit = lr.COMMISSIONAMOUNTLESSWHT, 
                                dateOfEngagement = context.TBL_ACCREDITEDCONSULTANT.Where(a => a.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(a => a.DATEOFENGAGEMENT).FirstOrDefault(),
                                accountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(a => a.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(a => a.ACCOUNTNUMBER).FirstOrDefault(),
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                totalAllrecoveryAmount = lr.TOTALAMOUNTRECOVERY,
                                outstandingAmount = (lr.TOTALAMOUNTRECOVERY - lr.AMOUNTRECOVERED),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(d => d.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(d => d.FIRMNAME).FirstOrDefault(),
                                amountRecovered = (decimal)lr.AMOUNTRECOVERED,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                accountBalance = (double)context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.LEDGERBALANCE).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                totalAmountRecovery = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL),
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                commissionAmountLessWht = lr.COMMISSIONAMOUNTLESSWHT,
                                whtAmount = lr.WHTAMOUNT,
                                whtRate = lr.WHTRATE,
                                commissionAmount = lr.COMMISSIONAMOUNT,
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_COMMISSION_BATCH
                                     join c in context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL on lr.REFERENCEID equals c.REFERENCEID
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCENUMBER equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     lr.REFERENCEID == referenceId
                                     && lr.LOANREFERENCENUMBER == ln.LOANREFERENCENUMBER
                                     select new GlobalExposureApplicationViewModel
                                     {
                                         recoveryMisCode = lr.MISCODE,
                                         region = lr.REGION,
                                         loanRecoveryCommissionBatchId = lr.LOANRECOVERYCOMMISSIONBATCHID,
                                         creditToAgent = lr.COMMISSIONAMOUNTLESSWHT, 
                                         amountToDebit = lr.COMMISSIONAMOUNTLESSWHT, 
                                         amountToCredit = lr.COMMISSIONAMOUNTLESSWHT, 
                                         dateOfEngagement = context.TBL_ACCREDITEDCONSULTANT.Where(a => a.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(a => a.DATEOFENGAGEMENT).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(a => a.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(a => a.FIRMNAME).FirstOrDefault(),
                                         accountNumber = context.TBL_ACCREDITEDCONSULTANT.Where(a => a.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(a => a.ACCOUNTNUMBER).FirstOrDefault(),
                                         totalAmountRecovery = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         totalAllrecoveryAmount = lr.TOTALAMOUNTRECOVERY,
                                         outstandingAmount = (lr.TOTALAMOUNTRECOVERY - lr.AMOUNTRECOVERED),
                                         casaAccountId = ln.CASAACCOUNTID,
                                         amountRecovered = (decimal)lr.AMOUNTRECOVERED,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",

                                         commissionAmountLessWht = lr.COMMISSIONAMOUNTLESSWHT,
                                         whtAmount = lr.WHTAMOUNT,
                                         whtRate = lr.WHTRATE,
                                         commissionAmount = lr.COMMISSIONAMOUNT,
                                         
                                     }).ToList();


            var data = dataLoan.Union(dataRevolvingLoan).Union(dataLoanExposure).Union(dataDigitalLoanExposure);

            return data;
        }

        public IEnumerable<LoanRecoveryCommissionApprovalViewModel> GetBulkRecoveryCommissionAwaitingApproval(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONTYPEID == (short)OperationTypeEnum.LoanManagement).Select(c => c.OPERATIONID).ToList();
            List<int> ids = new List<int>();

            foreach (var operationId in operationIds)
            {
                ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }

            var dataLoan = (from ln in context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL
                            join atrail in context.TBL_APPROVAL_TRAIL on ln.LOANRECOVERYCOMMISSIONAPPROVALID equals atrail.TARGETID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                            && atrail.OPERATIONID == ln.OPERATIONID
                            && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                            && atrail.RESPONSESTAFFID == null && ln.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)

                            select new LoanRecoveryCommissionApprovalViewModel
                            {
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                referenceId = ln.REFERENCEID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Count(),
                                approvalStatusId = ln.APPROVALSTATUSID,
                                approverComment = atrail.COMMENT,
                                dateTimeCreated = ln.DATETIMECREATED,
                                loanRecoveryCommissionApprovalId = ln.LOANRECOVERYCOMMISSIONAPPROVALID,
                                operationId = ln.OPERATIONID,
                                misCode = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.MISCODE).FirstOrDefault(),
                                region = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.REGION).FirstOrDefault(),
                                agentAccountNumber = ln.AGENTACCOUNTNUMBER,
                                dateOfEngagement = ln.DATEOFENGAGEMENT,

                                commissionAmountLessWht = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.COMMISSIONAMOUNTLESSWHT).FirstOrDefault(),
                                whtAmount = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.WHTAMOUNT).FirstOrDefault(),
                                whtRate = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.WHTRATE).FirstOrDefault(),
                                commissionAmount = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.COMMISSIONAMOUNT).FirstOrDefault(),
                                amountRecovered = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Select(x => x.AMOUNTRECOVERED).FirstOrDefault(),
                            }).ToList();

            return dataLoan;
        }


        public WorkflowResponse GoForRecoveryCommissionApproval(ApprovalViewModel entity)
        {
            List<string> receiverEmailList = new List<string>();
            AlertsViewModel alert = new AlertsViewModel();
            var dynamicMessage = string.Empty;

            entity.applicationDate = generalSetup.GetApplicationDate();
            using (var trans = context.Database.BeginTransaction())
            {
                var reviewRecord = (from s in context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL
                                    where s.LOANRECOVERYCOMMISSIONAPPROVALID == entity.targetId && s.OPERATIONID == entity.operationId
                                    && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                    select s).FirstOrDefault();

                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Referred)
                {

                    int staffId = entity.staffId;
                    var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();

                    var levels = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == entity.operationId)
                         .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
                         .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true),
                             mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new
                             {
                                 groupPosition = mg.m.POSITION,
                                 levelPosition = l.POSITION,
                                 levelId = l.APPROVALLEVELID,
                                 levelName = l.LEVELNAME,
                                 staffRoleId = l.STAFFROLEID,
                             })
                             .OrderBy(x => x.groupPosition)
                             .ThenBy(x => x.levelPosition)
                             .ToList();

                    var staffRoleLevels = levels.Where(x => x.staffRoleId == staff.STAFFROLEID);
                    var staffRoleLevelIds = staffRoleLevels.Select(x => x.levelId);
                    var staffRoleLevelId = staffRoleLevelIds.FirstOrDefault();

                    workFlow.StaffId = entity.createdBy;
                    workFlow.OperationId = entity.operationId;
                    workFlow.TargetId = entity.targetId;
                    workFlow.CompanyId = entity.companyId;
                    workFlow.ProductClassId = null;
                    workFlow.ProductId = null;
                    workFlow.NextLevelId = entity.approvalLevelId;
                    workFlow.ToStaffId = staffId;
                    workFlow.StatusId = (int)ApprovalStatusEnum.Referred;
                    workFlow.Comment = entity.comment;
                    workFlow.DeferredExecution = true;


                    var loanAssigns = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == reviewRecord.REFERENCEID).ToList();
                    foreach (var loanAssign in loanAssigns)
                    {
                        var record = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Find(loanAssign.LOANRECOVERYCOMMISSIONBATCHID);
                        record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Referred;
                        record.OPERATIONCOMPLETED = false;
                        context.SaveChanges();
                    }
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Referred;
                    context.SaveChanges();
                    trans.Commit();
                    return workFlow.Response;
                }

                workFlow.StaffId = entity.staffId;
                workFlow.CompanyId = entity.companyId;
                workFlow.StatusId = ((short)entity.approvalStatusId == (short)ApprovalStatusEnum.Approved) ? (short)ApprovalStatusEnum.Processing : (short)entity.approvalStatusId;
                workFlow.TargetId = entity.targetId;
                workFlow.Comment = entity.comment;
                workFlow.OperationId = entity.operationId;
                workFlow.DeferredExecution = true;
                workFlow.LogActivity();


                bool output = false;
                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                {

                    var loanAssigns = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == reviewRecord.REFERENCEID).ToList();
                    foreach (var loanAssign in loanAssigns)
                    {
                        var record = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Find(loanAssign.LOANRECOVERYCOMMISSIONBATCHID);
                        record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                        record.OPERATIONCOMPLETED = false;
                        context.SaveChanges();
                    }
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                    context.SaveChanges();
                    trans.Commit();
                    return workFlow.Response;
                }

                if (workFlow.NewState != (int)ApprovalState.Ended)
                {
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    output = context.SaveChanges() > 0;
                    trans.Commit();
                    return workFlow.Response;
                }
                else if (workFlow.NewState == (int)ApprovalState.Ended)
                {
                    if (workFlow.StatusId == (int)ApprovalStatusEnum.Approved)
                    {
                        var loanAssigns = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == reviewRecord.REFERENCEID).ToList();
                        foreach (var loanAssign in loanAssigns)
                        {
                            var record = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Find(loanAssign.LOANRECOVERYCOMMISSIONBATCHID);
                            record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                            record.OPERATIONCOMPLETED = true;
                            record.OPERATIONID = entity.operationId;
                            output = context.SaveChanges() > 0;
                        }
                        reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                        output = context.SaveChanges() > 0;
                    }
                    if (output == true)
                    {
                        trans.Commit();

                    }

                }
                return workFlow.Response;

            }

        }

        public int GoForDocumentationFillingApproval(ApprovalViewModel entity)
        {
            var dataTermLoans = (from b in context.TBL_DOCUMENTATION_FILLING_APPROVAL
                                 join a in context.TBL_LOAN on b.LOANID equals a.TERMLOANID
                                 join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOANAPPLICATIONDETAILID equals s.LOANAPPLICATIONDETAILID
                                 join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                 join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                 join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                 join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                 join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                 join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                 where b.DOCUMENTATIONFILLINGID == entity.targetId

                                 orderby a.DATEAPPROVED descending
                                 select new CamProcessedLoanViewModel()
                                 {
                                     module = b.MODULE,
                                     requestId = b.REQUESTID,
                                     documentationFillingId = b.DOCUMENTATIONFILLINGID,
                                     bookingAmountRequested = s.AMOUNT_REQUESTED,
                                     loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                     bookingRequestStatusId = s.APPROVALSTATUSID,
                                     isLineFacility = d.ISLINEFACILITY,
                                     loanId = a.TERMLOANID,
                                     isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                     isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                     requestDate = s.DATETIMECREATED,
                                     requestedBy = "",
                                     systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                     operationId = s.OPERATIONID,
                                     appraisalOperationId = m.OPERATIONID,
                                     crmsCode = s.CRMSCODE,
                                     requestedAmount = s.AMOUNT_REQUESTED,
                                     requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                     approvalStatusId = atrail.APPROVALSTATUSID,
                                     approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),
                                     loanApplicationId = m.LOANAPPLICATIONID,

                                     loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                     applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                     applicationStatusId = m.APPLICATIONSTATUSID,
                                     divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                     customerId = d.CUSTOMERID,
                                     customerCode = cust.CUSTOMERCODE,
                                     customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                     customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                     customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                     customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                     customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                     applicationTenor = m.APPLICATIONTENOR,
                                     effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                     expiryDate = (DateTime)d.EXPIRYDATE,
                                     currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                     currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                     exchangeRate = d.EXCHANGERATE,
                                     loanTypeId = m.LOANAPPLICATIONTYPEID,
                                     loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                     productId = s.PRODUCTID,
                                     productTypeId = p.PRODUCTTYPEID,
                                     productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                     productTypeName = pt.PRODUCTTYPENAME,
                                     productName = p.PRODUCTNAME,
                                     casaAccountId = s.CASAACCOUNTID,
                                     casaAccountId2 = s.CASAACCOUNTID2,
                                     productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                     divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                     interestRate = d.APPROVEDINTERESTRATE,
                                     approvedInterestRate = d.APPROVEDINTERESTRATE,
                                     approvedAmount = d.APPROVEDAMOUNT,
                                     groupApprovedAmount = m.APPROVEDAMOUNT,
                                     availmentDate = m.AVAILMENTDATE,
                                     approvedTenor = d.APPROVEDTENOR,
                                     toStaffId = atrail.TOSTAFFID,
                                     requestStaffId = atrail.REQUESTSTAFFID,
                                     isInEditMode = s.ISUSED ?? false,
                                     approvalTrailId = atrail.APPROVALTRAILID,
                                     responseStaffId = atrail.RESPONSESTAFFID
                                 }).FirstOrDefault();

            var dataRevolvingLoans = (from b in context.TBL_DOCUMENTATION_FILLING_APPROVAL
                                      join a in context.TBL_LOAN_REVOLVING on b.LOANID equals a.REVOLVINGLOANID
                                      join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOANAPPLICATIONDETAILID equals s.LOANAPPLICATIONDETAILID
                                      join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                      join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                      join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                      join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                      join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                      join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                      where b.DOCUMENTATIONFILLINGID == entity.targetId

                                      orderby a.DATEAPPROVED descending
                                      select new CamProcessedLoanViewModel()
                                      {
                                          module = b.MODULE,
                                          requestId = b.REQUESTID,
                                          documentationFillingId = b.DOCUMENTATIONFILLINGID,
                                          bookingAmountRequested = s.AMOUNT_REQUESTED,
                                          loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                          bookingRequestStatusId = s.APPROVALSTATUSID,
                                          isLineFacility = d.ISLINEFACILITY,
                                          isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                          isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                          requestDate = s.DATETIMECREATED,
                                          requestedBy = "",
                                          loanId = a.REVOLVINGLOANID,
                                          systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                          operationId = s.OPERATIONID,
                                          appraisalOperationId = m.OPERATIONID,
                                          crmsCode = s.CRMSCODE,
                                          requestedAmount = s.AMOUNT_REQUESTED,
                                          requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                          approvalStatusId = atrail.APPROVALSTATUSID,
                                          approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                          loanApplicationId = m.LOANAPPLICATIONID,

                                          loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                          applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                          applicationStatusId = m.APPLICATIONSTATUSID,
                                          divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                          customerId = d.CUSTOMERID,
                                          customerCode = cust.CUSTOMERCODE,
                                          customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                          customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                          customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                          customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                          customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                          applicationTenor = m.APPLICATIONTENOR,
                                          effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                          expiryDate = (DateTime)d.EXPIRYDATE,
                                          currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                          currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                          exchangeRate = d.EXCHANGERATE,
                                          loanTypeId = m.LOANAPPLICATIONTYPEID,
                                          loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                          productId = s.PRODUCTID,
                                          productTypeId = p.PRODUCTTYPEID,
                                          productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                          productTypeName = pt.PRODUCTTYPENAME,
                                          productName = p.PRODUCTNAME,
                                          casaAccountId = s.CASAACCOUNTID,
                                          casaAccountId2 = s.CASAACCOUNTID2,
                                          productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                          divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                          interestRate = d.APPROVEDINTERESTRATE,
                                          approvedInterestRate = d.APPROVEDINTERESTRATE,
                                          approvedAmount = d.APPROVEDAMOUNT,
                                          groupApprovedAmount = m.APPROVEDAMOUNT,
                                          availmentDate = m.AVAILMENTDATE,
                                          approvedTenor = d.APPROVEDTENOR,
                                          toStaffId = atrail.TOSTAFFID,
                                          requestStaffId = atrail.REQUESTSTAFFID,
                                          isInEditMode = s.ISUSED ?? false,
                                          approvalTrailId = atrail.APPROVALTRAILID,
                                          responseStaffId = atrail.RESPONSESTAFFID
                                      }).FirstOrDefault();

            var dataContingentLoans = (from b in context.TBL_DOCUMENTATION_FILLING_APPROVAL
                                       join a in context.TBL_LOAN_CONTINGENT on b.LOANID equals a.CONTINGENTLOANID
                                       join s in context.TBL_LOAN_BOOKING_REQUEST on a.LOANAPPLICATIONDETAILID equals s.LOANAPPLICATIONDETAILID
                                       join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                       join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                       join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                       join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                       join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                       join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                       where b.DOCUMENTATIONFILLINGID == entity.targetId

                                       orderby a.DATEAPPROVED descending
                                       select new CamProcessedLoanViewModel()
                                       {
                                           module = b.MODULE,
                                           requestId = b.REQUESTID,
                                           documentationFillingId = b.DOCUMENTATIONFILLINGID,
                                           bookingAmountRequested = s.AMOUNT_REQUESTED,
                                           loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                           bookingRequestStatusId = s.APPROVALSTATUSID,
                                           isLineFacility = d.ISLINEFACILITY,
                                           isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                           isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                           requestDate = s.DATETIMECREATED,
                                           requestedBy = "",
                                           systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                           operationId = s.OPERATIONID,
                                           appraisalOperationId = m.OPERATIONID,
                                           crmsCode = s.CRMSCODE,
                                           loanId = a.CONTINGENTLOANID,
                                           requestedAmount = s.AMOUNT_REQUESTED,
                                           requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                           approvalStatusId = atrail.APPROVALSTATUSID,
                                           approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                           loanApplicationId = m.LOANAPPLICATIONID,

                                           loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                           applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                           applicationStatusId = m.APPLICATIONSTATUSID,
                                           divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                           customerId = d.CUSTOMERID,
                                           customerCode = cust.CUSTOMERCODE,
                                           customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                           customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                           customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                           customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                           customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                           applicationTenor = m.APPLICATIONTENOR,
                                           effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                           expiryDate = (DateTime)d.EXPIRYDATE,
                                           currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                           currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                           exchangeRate = d.EXCHANGERATE,
                                           loanTypeId = m.LOANAPPLICATIONTYPEID,
                                           loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                           productId = s.PRODUCTID,
                                           productTypeId = p.PRODUCTTYPEID,
                                           productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                           productTypeName = pt.PRODUCTTYPENAME,
                                           productName = p.PRODUCTNAME,
                                           casaAccountId = s.CASAACCOUNTID,
                                           casaAccountId2 = s.CASAACCOUNTID2,
                                           productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                           divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                           interestRate = d.APPROVEDINTERESTRATE,
                                           approvedInterestRate = d.APPROVEDINTERESTRATE,
                                           approvedAmount = d.APPROVEDAMOUNT,
                                           groupApprovedAmount = m.APPROVEDAMOUNT,
                                           availmentDate = m.AVAILMENTDATE,
                                           approvedTenor = d.APPROVEDTENOR,
                                           toStaffId = atrail.TOSTAFFID,
                                           requestStaffId = atrail.REQUESTSTAFFID,
                                           isInEditMode = s.ISUSED ?? false,
                                           approvalTrailId = atrail.APPROVALTRAILID,
                                           responseStaffId = atrail.RESPONSESTAFFID
                                       }).FirstOrDefault();

            CamProcessedLoanViewModel model = new CamProcessedLoanViewModel();
            var creditDocumentationDetail = "";
            if (dataTermLoans != null)
            {
                model = dataTermLoans; 
            }
            if (dataRevolvingLoans != null)
            {
                model = dataRevolvingLoans;
            }
            if (dataContingentLoans != null)
            {
                model = dataContingentLoans;
            }

            if (model.module.ToLower() == "los")
            {
                 creditDocumentationDetail = "Documentation for loan ID: " + model?.loanId + " with Reference number: " + model?.applicationReferenceNumber + " " +
                                              "Product Name: " + model?.productName + ", Customer Name: " + model?.customerName + "(" + model?.customerCode + ")";

                var requestApproval = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Find(entity.targetId);
                var termLoan = this.context.TBL_LOAN.Find(model.loanId);
                if (termLoan != null)
                {
                    if (entity.approvalStatusId == (short)ApprovalStatusEnum.Approved)
                    {
                        termLoan.ISPRINTED = true;
                        requestApproval.APPROVALSTATUSID = (int)entity.approvalStatusId;
                    }
                    else
                    {
                        context.TBL_DOCUMENTATION_FILLING_APPROVAL.Remove(requestApproval);
                    }
                }
                var contingentLoan = this.context.TBL_LOAN_CONTINGENT.Find(model.loanId);
                if (contingentLoan != null)
                {
                    if (entity.approvalStatusId == (short)ApprovalStatusEnum.Approved)
                    {
                        contingentLoan.ISPRINTED = true;
                        requestApproval.APPROVALSTATUSID = (int)entity.approvalStatusId;
                    }
                    else
                    {
                        context.TBL_DOCUMENTATION_FILLING_APPROVAL.Remove(requestApproval);
                    }
                }
                var revolvingLoan = this.context.TBL_LOAN_REVOLVING.Find(model.loanId);
                if (revolvingLoan != null)
                {
                    if (entity.approvalStatusId == (short)ApprovalStatusEnum.Approved)
                    {
                        revolvingLoan.ISPRINTED = true;
                        requestApproval.APPROVALSTATUSID = (int)entity.approvalStatusId;
                    }
                    else
                    {
                        context.TBL_DOCUMENTATION_FILLING_APPROVAL.Remove(requestApproval);
                    }
                }
            }
            else
            {
                var requestApproval = context.TBL_DOCUMENTATION_FILLING_APPROVAL.Find(entity.targetId);
                var reviewOperation = context.TBL_LOAN_REVIEW_OPERATION.Find(requestApproval.REQUESTID);
                 creditDocumentationDetail = "Documentation for loan ID: " + model?.loanId + " with Reference number: " + model?.applicationReferenceNumber + " " +
                                                              "Product Name: " + model?.productName + ", Customer Name: " + model?.customerName + "(" + model?.customerCode + ")";

                
                var termLoan = this.context.TBL_LOAN.Find(model.loanId);
                if (termLoan != null)
                {
                    if (entity.approvalStatusId == (short)ApprovalStatusEnum.Approved)
                    {
                        reviewOperation.ISPRINTED = true;
                        requestApproval.APPROVALSTATUSID = (int)entity.approvalStatusId;
                    }
                    else
                    {
                        context.TBL_DOCUMENTATION_FILLING_APPROVAL.Remove(requestApproval);
                    }
                }
                var contingentLoan = this.context.TBL_LOAN_CONTINGENT.Find(model.loanId);
                if (contingentLoan != null)
                {
                    if (entity.approvalStatusId == (short)ApprovalStatusEnum.Approved)
                    {
                        reviewOperation.ISPRINTED = true;
                        requestApproval.APPROVALSTATUSID = (int)entity.approvalStatusId;
                    }
                    else
                    {
                        context.TBL_DOCUMENTATION_FILLING_APPROVAL.Remove(requestApproval);
                    }
                }
                var revolvingLoan = this.context.TBL_LOAN_REVOLVING.Find(model.loanId);
                if (revolvingLoan != null)
                {
                    if (entity.approvalStatusId == (short)ApprovalStatusEnum.Approved)
                    {
                        reviewOperation.ISPRINTED = true;
                        requestApproval.APPROVALSTATUSID = (int)entity.approvalStatusId;
                    }
                    else
                    {
                        context.TBL_DOCUMENTATION_FILLING_APPROVAL.Remove(requestApproval);
                    }
                }
            }
            var auditStaff = context.TBL_STAFF.Where(x => x.STAFFID == entity.createdBy).Select(x => x.STAFFCODE).FirstOrDefault();
            // Audit Section ---------------------------
            this.auditTrail.AddAuditTrail(new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.CreditDocumentationPrinted,
                STAFFID = entity.createdBy,
                BRANCHID = (short)entity.BranchId,
                DETAIL = $"CREDIT DOCUMENTATION '{creditDocumentationDetail}' created by {auditStaff}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = entity.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            });
            // Audit Section end ------------------------
            //if (await context.SaveChangesAsync() > 0) return true;
            if (context.SaveChanges() > 0)
            {
                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Approved) return 1;
                else if (entity.approvalStatusId == (short)ApprovalStatusEnum.Disapproved) return 2;
            }
            return 3;
            //return false;

        }

        public WorkflowResponse GoForBulkInsuranceUploadApproval(ApprovalViewModel entity)
        {

            entity.applicationDate = generalSetup.GetApplicationDate();
            using (var trans = context.Database.BeginTransaction())
            {
                var reviewRecord = (from s in context.TBL_BULK_INSURANCE_UPLOAD_APPROVAL
                                    where s.BULKINSURANCEUPLOADAPPROVALID == entity.targetId && s.OPERATIONID == entity.operationId
                                    && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                    select s).FirstOrDefault();

                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Referred)
                {

                    int staffId = entity.staffId;
                    var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();

                    var levels = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == entity.operationId)
                         .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
                         .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true),
                             mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new
                             {
                                 groupPosition = mg.m.POSITION,
                                 levelPosition = l.POSITION,
                                 levelId = l.APPROVALLEVELID,
                                 levelName = l.LEVELNAME,
                                 staffRoleId = l.STAFFROLEID,
                             })
                             .OrderBy(x => x.groupPosition)
                             .ThenBy(x => x.levelPosition)
                             .ToList();

                    var staffRoleLevels = levels.Where(x => x.staffRoleId == staff.STAFFROLEID);
                    var staffRoleLevelIds = staffRoleLevels.Select(x => x.levelId);
                    var staffRoleLevelId = staffRoleLevelIds.FirstOrDefault();

                    workFlow.StaffId = entity.createdBy;
                    workFlow.OperationId = entity.operationId;
                    workFlow.TargetId = entity.targetId;
                    workFlow.CompanyId = entity.companyId;
                    workFlow.ProductClassId = null;
                    workFlow.ProductId = null;
                    workFlow.NextLevelId = entity.approvalLevelId;
                    workFlow.ToStaffId = staffId;
                    workFlow.StatusId = (int)ApprovalStatusEnum.Referred;
                    workFlow.Comment = entity.comment;
                    workFlow.DeferredExecution = true;


                    var loanAssigns = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Where(x => x.BATCHCODE == reviewRecord.BATCHCODE).ToList();
                    foreach (var loanAssign in loanAssigns)
                    {
                        var record = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Find(loanAssign.COLLATERALINSURANCETRACKINGID);
                        record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Referred;
                        context.SaveChanges();
                    }
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Referred;
                    context.SaveChanges();
                    trans.Commit();
                    return workFlow.Response;
                }

                workFlow.StaffId = entity.staffId;
                workFlow.CompanyId = entity.companyId;
                workFlow.StatusId = ((short)entity.approvalStatusId == (short)ApprovalStatusEnum.Approved) ? (short)ApprovalStatusEnum.Processing : (short)entity.approvalStatusId;
                workFlow.TargetId = entity.targetId;
                workFlow.Comment = entity.comment;
                workFlow.OperationId = entity.operationId;
                workFlow.DeferredExecution = true;
                workFlow.LogActivity();


                bool output = false;
                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                {

                    var loanAssigns = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Where(x => x.BATCHCODE == reviewRecord.BATCHCODE).ToList();
                    foreach (var loanAssign in loanAssigns)
                    {
                        var record = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Find(loanAssign.COLLATERALINSURANCETRACKINGID);
                        record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                        context.SaveChanges();
                    }
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                    context.SaveChanges();
                    trans.Commit();
                    return workFlow.Response;
                }

                if (workFlow.NewState != (int)ApprovalState.Ended)
                {
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    output = context.SaveChanges() > 0;
                    trans.Commit();
                    return workFlow.Response;
                }
                else if (workFlow.NewState == (int)ApprovalState.Ended)
                {
                    if (workFlow.StatusId == (int)ApprovalStatusEnum.Approved)
                    {
                        var policyRecords = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Where(x => x.BATCHCODE == reviewRecord.BATCHCODE && x.ISCOLLATERAL == false && x.VALIDITYSTATUS == true).ToList();
                        foreach (var policyRecord in policyRecords)
                        {
                            if (policyRecord.ISCOLLATERAL == false)
                            {
                                var doseRecordExist = context.TBL_COLLATERAL_INSURANCE_TRACKING.Where(x => x.COLLATERALCUSTOMERID == policyRecord.COLLATERALCUSTOMERID).FirstOrDefault();
                                if (doseRecordExist == null)
                                {
                                    var record = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Find(policyRecord.COLLATERALINSURANCETRACKINGID);
                                    bulkInsuranceUploads(record);
                                    record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                                    context.TEMP_COLLATERAL_INSURANCE_TRACKING.Remove(record);
                                    output = context.SaveChanges() > 0;
                                }
                            }
                            else
                            {
                                var doseRecordExist = context.TBL_COLLATERAL_POLICY.Where(x => x.COLLATERALCUSTOMERID == policyRecord.COLLATERALCUSTOMERID).FirstOrDefault();
                                if (doseRecordExist == null)
                                {
                                    var insurnceName = "";
                                    var model = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Find(policyRecord.COLLATERALINSURANCETRACKINGID);
                                    var verifyCollateral = context.TBL_COLLATERAL_CUSTOMER.Where(x=>x.CUSTOMERCODE == policyRecord.CUSTOMERCODE).FirstOrDefault();
                                    if (verifyCollateral != null)
                                    {
                                        
                                        var collateral = context.TBL_COLLATERAL_CUSTOMER.Add(new TBL_COLLATERAL_CUSTOMER
                                        {
                                            COLLATERALTYPEID = model.COLLATERALTYPE ?? 0,
                                            COLLATERALSUBTYPEID = 0,
                                            COLLATERALCODE = model.COLLATERALCODE,
                                            COLLATERALVALUE = (decimal)0m,
                                            COMPANYID = 1,
                                            ALLOWSHARING = true,
                                            ISLOCATIONBASED = true,
                                            VALUATIONCYCLE = null,
                                            HAIRCUT = 0,
                                            CURRENCYID = 0,
                                            EXCHANGERATE = 0,
                                            CUSTOMERID = verifyCollateral.CUSTOMERID,
                                            CAMREFNUMBER = null,
                                            CREATEDBY = model.CREATEDBY,
                                            DATETIMECREATED = DateTime.Now,
                                            ACTEDONBY = null,
                                            RELATEDCOLLATERALCODE = null,
                                            LOANAPPLICATIONID = null,
                                            COLLATERALSUMMARY = model.COLLATERALDESCRIPTION,
                                            COLLATERALUSAGESTATUSID = (int)CollateralUsageStatusEnum.InUse,
                                            VALIDTILL = null,
                                        });

                                        context.SaveChanges();

                                        if(model.INSURANCECOMPANYID != null)
                                        {
                                             insurnceName = context.TBL_INSURANCE_COMPANY.Where(x => x.INSURANCECOMPANYID == model.INSURANCECOMPANYID).Select(x=>x.COMPANYNAME).FirstOrDefault();
                                        }
                                        else
                                        {
                                            insurnceName = model.OTHERINSURANCECOMPANY;
                                        }

                                        var insuranceTracking = context.TBL_COLLATERAL_POLICY.Add(new TBL_COLLATERAL_POLICY
                                        {
                                            COLLATERALCUSTOMERID = collateral.COLLATERALCUSTOMERID,
                                            ISOWNEDBYCUSTOMER = true,
                                            PREMIUMAMOUNT = (decimal)model.PREMIUMPAID,
                                            POLICYAMOUNT = (decimal)model.INSURABLEVALUE,
                                            INSURANCECOMPANYNAME = insurnceName,
                                            INSURANCETYPE = null,
                                            INSURERADDRESS = model.ISURANCECOMPANYADDRESS,
                                            POLICYSTARTDATE = (DateTime)model.INSURANCESTARTDATE,
                                            ASSIGNDATE = (DateTime)model.INSURANCESTARTDATE,
                                            RENEWALFREQUENCYTYPEID = 0,
                                            INSURERDETAILS = model.COLLATERALDESCRIPTION,
                                            INSURANCEPOLICYNUMBER = model.POLICYNUMBER,
                                            POLICYRENEWALDATE = (DateTime)model.INSURANCEENDDATE,
                                            REMARK = null,
                                            INSURANCETYPEID = (int)model.INSURANCEPOLICYTYPEID,
                                        });

                                        model.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                                        context.TEMP_COLLATERAL_INSURANCE_TRACKING.Remove(model);
                                        output = context.SaveChanges() > 0;
                                    }
                                }
                            }
                        }
                        reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                        output = context.SaveChanges() > 0;
                    }
                    if (output == true)
                    {
                        trans.Commit();

                    }

                }
                return workFlow.Response;

            }
        }


        public WorkflowResponse GoForMultipleBulkInsuranceUploadApproval(List<MultipleInsuranceOutputViewModel> entity, UserInfo user, int approvalStatusId, string comment)
        {

            if (entity != null)
            {

                using (var trans = context.Database.BeginTransaction())
                {
                    var batchCode = entity[0].batchCode;
                        var reviewRecord = (from s in context.TBL_BULK_INSURANCE_UPLOAD_APPROVAL
                                            where s.BATCHCODE == batchCode
                                            && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                            select s).FirstOrDefault();

                        var approval = new ApprovalViewModel
                        {
                            staffId = user.createdBy,
                            companyId = user.companyId,
                            approvalStatusId = ((short)approvalStatusId == (short)ApprovalStatusEnum.Approved) ? (short)ApprovalStatusEnum.Processing : (short)approvalStatusId,
                            comment = comment,
                            targetId = reviewRecord.BULKINSURANCEUPLOADAPPROVALID,
                            operationId = reviewRecord.OPERATIONID,
                            BranchId = user.BranchId,
                            deferredExecution = false
                        };

                        workFlow.LogForApproval(approval);

                        if (approvalStatusId == (int)ApprovalStatusEnum.Disapproved)
                        {
                            var loanAssigns = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Where(x => x.BATCHCODE == reviewRecord.BATCHCODE).ToList();
                            foreach (var loanAssign in loanAssigns)
                            {
                                var records = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Find(loanAssign.COLLATERALINSURANCETRACKINGID);
                                records.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                                context.SaveChanges();
                            }
                            reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                            context.SaveChanges();
                            trans.Commit();
                            return workFlow.Response;
                        }

                        if (workFlow.NewState != (int)ApprovalState.Ended)
                        {
                            reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;

                        }
                        else if (workFlow.NewState == (int)ApprovalState.Ended)
                        {
                            if (workFlow.StatusId == (int)ApprovalStatusEnum.Approved)
                            {
                                var validRecords = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Where(x => x.BATCHCODE == reviewRecord.BATCHCODE && x.VALIDITYSTATUS == true).ToList();
                                foreach (var validRecord in validRecords)
                                {
                                    if (validRecord.ISCOLLATERAL == false)
                                    {
                                        if (validRecord.COLLATERALCUSTOMERID != null)
                                        {
                                            var doseRecordExist = context.TBL_COLLATERAL_INSURANCE_TRACKING.Where(x => x.COLLATERALCUSTOMERID == validRecord.COLLATERALCUSTOMERID).FirstOrDefault();
                                            if (doseRecordExist == null)
                                            {
                                                var rec = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Find(validRecord.COLLATERALINSURANCETRACKINGID);
                                                bulkInsuranceUploads(rec);
                                                context.SaveChanges();
                                                
                                            }
                                        }
                                        else
                                        {
                                            var rec = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Find(validRecord.COLLATERALINSURANCETRACKINGID);
                                            bulkInsuranceUploads(rec);
                                            context.SaveChanges();
                                            
                                        }
                                    }
                                    else
                                    {
                                        var doseRecordExist = context.TBL_COLLATERAL_POLICY.Where(x => x.COLLATERALCUSTOMERID == validRecord.COLLATERALCUSTOMERID).FirstOrDefault();
                                        if (doseRecordExist == null)
                                        {
                                            var insurnceName = "";
                                            var model = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Find(validRecord.COLLATERALINSURANCETRACKINGID);
                                            var verifyCollateral = context.TBL_COLLATERAL_CUSTOMER.Where(x => x.COLLATERALCODE == validRecord.COLLATERALCODE).FirstOrDefault();
                                            var customer = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == validRecord.CUSTOMERCODE).FirstOrDefault();
                                            var collateralType = context.TBL_COLLATERAL_TYPE.Where(x => x.COLLATERALTYPENAME.Contains("Insurance")).FirstOrDefault();
                                            
                                            if (verifyCollateral == null && collateralType != null)
                                            {
                                                var collateralTypeSub = context.TBL_COLLATERAL_TYPE_SUB.Where(x => x.COLLATERALTYPEID == collateralType.COLLATERALTYPEID).FirstOrDefault();
                                                var collateral = context.TBL_COLLATERAL_CUSTOMER.Add(new TBL_COLLATERAL_CUSTOMER
                                                {
                                                    COLLATERALTYPEID = model.COLLATERALTYPE ?? collateralType.COLLATERALTYPEID,
                                                    COLLATERALSUBTYPEID = collateralTypeSub.COLLATERALSUBTYPEID,
                                                    COLLATERALCODE = model.COLLATERALCODE,
                                                    CUSTOMERCODE = model.CUSTOMERCODE,
                                                    COLLATERALVALUE = (decimal)0m,
                                                    COMPANYID = 1,
                                                    ALLOWSHARING = true,
                                                    ISLOCATIONBASED = true,
                                                    VALUATIONCYCLE = null,
                                                    HAIRCUT = 0,
                                                    CURRENCYID = 1,
                                                    EXCHANGERATE = 0,
                                                    CUSTOMERID = customer.CUSTOMERID,
                                                    CAMREFNUMBER = null,
                                                    CREATEDBY = model.CREATEDBY,
                                                    DATETIMECREATED = DateTime.Now,
                                                    ACTEDONBY = null,
                                                    RELATEDCOLLATERALCODE = null,
                                                    LOANAPPLICATIONID = null,
                                                    COLLATERALSUMMARY = model.COLLATERALDESCRIPTION,
                                                    COLLATERALUSAGESTATUSID = (int)CollateralUsageStatusEnum.InUse,
                                                    VALIDTILL = null,
                                                });

                                                context.SaveChanges();

                                                if (model.INSURANCECOMPANYID != null)
                                                {
                                                    insurnceName = context.TBL_INSURANCE_COMPANY.Where(x => x.INSURANCECOMPANYID == model.INSURANCECOMPANYID).Select(x => x.COMPANYNAME).FirstOrDefault();
                                                }
                                                else
                                                {
                                                    insurnceName = model.OTHERINSURANCECOMPANY;
                                                }

                                                var insuranceTracking = context.TBL_COLLATERAL_POLICY.Add(new TBL_COLLATERAL_POLICY
                                                {
                                                    COLLATERALCUSTOMERID = collateral.COLLATERALCUSTOMERID,
                                                    ISOWNEDBYCUSTOMER = true,
                                                    PREMIUMAMOUNT = (decimal)model.PREMIUMPAID,
                                                    POLICYAMOUNT = (decimal)model.INSURABLEVALUE,
                                                    INSURANCECOMPANYNAME = insurnceName,
                                                    INSURANCETYPE = null,
                                                    INSURERADDRESS = model.ISURANCECOMPANYADDRESS,
                                                    POLICYSTARTDATE = (DateTime)model.INSURANCESTARTDATE,
                                                    ASSIGNDATE = (DateTime)model.INSURANCESTARTDATE,
                                                    RENEWALFREQUENCYTYPEID = 1,
                                                    INSURERDETAILS = model.COLLATERALDESCRIPTION,
                                                    INSURANCEPOLICYNUMBER = model.POLICYNUMBER,
                                                    POLICYRENEWALDATE = (DateTime)model.INSURANCEENDDATE,
                                                    REMARK = null,
                                                    INSURANCETYPEID = (int)model.INSURANCEPOLICYTYPEID,
                                                });

                                                context.SaveChanges();
                                                
                                            }
                                        }
                                    }
                                       context.TEMP_COLLATERAL_INSURANCE_TRACKING.Remove(validRecord);
                                }
                                reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                            }
                        
                        }
                    context.SaveChanges();
                    trans.Commit();
                }

            }
            return workFlow.Response;
        }


        private void bulkInsuranceUploads(TEMP_COLLATERAL_INSURANCE_TRACKING insurancePolicy)
        {
            var insuranceTracking = context.TBL_COLLATERAL_INSURANCE_TRACKING.Add(new TBL_COLLATERAL_INSURANCE_TRACKING
            {
                INSURANCECOMPANYID = insurancePolicy.INSURANCECOMPANYID,
                ISURANCECOMPANYADDRESS = insurancePolicy.ISURANCECOMPANYADDRESS,
                POLICYNUMBER = insurancePolicy.POLICYNUMBER,
                INSURANCESTARTDATE = insurancePolicy.INSURANCESTARTDATE,
                INSURANCEENDDATE = insurancePolicy.INSURANCEENDDATE,
                SUMINSURED = insurancePolicy.SUMINSURED,
                PREMIUMPAID = insurancePolicy.PREMIUMPAID,
                INSURANCESTATUSID = insurancePolicy.COLLATERALCUSTOMERID,
                COLLATERALCUSTOMERID = insurancePolicy.COLLATERALCUSTOMERID,
                LOANAPPLICATIONDETAILID = insurancePolicy.LOANAPPLICATIONDETAILID,
                VALUATIONSTARTDATE = insurancePolicy.VALUATIONSTARTDATE,
                VALUATIONENDDATE = insurancePolicy.VALUATIONENDDATE,
                OMV = insurancePolicy.OMV,
                FSV = insurancePolicy.FSV,
                VALUERID = insurancePolicy.VALUERID,
                COLLATERALDETAILS = insurancePolicy.COLLATERALDETAILS,
                INSURANCEPOLICYTYPEID = insurancePolicy.INSURANCEPOLICYTYPEID,
                OTHERVALUER = insurancePolicy.OTHERVALUER,
                OTHERINSURANCECOMPANY = insurancePolicy.OTHERINSURANCECOMPANY,
                OTHERINSURANCEPOLICYTYPE = insurancePolicy.OTHERINSURANCEPOLICYTYPE,
                COLLATERALTYPE = insurancePolicy.COLLATERALTYPE,
                COLLATERALSUBTYPE = insurancePolicy.COLLATERALSUBTYPE,
                GPSCOORDINATES = insurancePolicy.GPSCOORDINATES,
                FIRSTLOSSPAYEE = insurancePolicy.FIRSTLOSSPAYEE,
                INSURABLEVALUE = insurancePolicy.INSURABLEVALUE,
                COMMENT = insurancePolicy.COMMENT,
                DATETIMECREATED = DateTime.Now,
                CREATEDBY = insurancePolicy.CREATEDBY,
                COLLATERALDESCRIPTION = insurancePolicy.COLLATERALDESCRIPTION
            });
        }

        private void bulkInsuranceCollateralUploads(TBL_COLLATERAL_POLICY collateralPolicy)
        {
            var insuranceTracking = context.TBL_COLLATERAL_POLICY.Add(new TBL_COLLATERAL_POLICY
            {
                COLLATERALCUSTOMERID = collateralPolicy.COLLATERALCUSTOMERID,
                ISOWNEDBYCUSTOMER = collateralPolicy.ISOWNEDBYCUSTOMER,
                PREMIUMAMOUNT = collateralPolicy.PREMIUMAMOUNT,
                POLICYAMOUNT = collateralPolicy.POLICYAMOUNT,
                INSURANCECOMPANYNAME = collateralPolicy.INSURANCECOMPANYNAME,
                INSURANCETYPE = collateralPolicy.INSURANCETYPE,
                INSURERADDRESS = collateralPolicy.INSURERADDRESS,
                POLICYSTARTDATE = collateralPolicy.POLICYSTARTDATE,
                ASSIGNDATE = collateralPolicy.ASSIGNDATE,
                RENEWALFREQUENCYTYPEID = collateralPolicy.RENEWALFREQUENCYTYPEID,
                INSURERDETAILS = collateralPolicy.INSURERDETAILS,
                INSURANCEPOLICYNUMBER = collateralPolicy.INSURANCEPOLICYNUMBER,
                POLICYRENEWALDATE = collateralPolicy.POLICYRENEWALDATE,
                REMARK = collateralPolicy.REMARK,
                INSURANCETYPEID = collateralPolicy.INSURANCETYPEID,
            });
        }

        public IEnumerable<LoanRecoveryReportApprovalViewModel> GetBulkRecoveryReportingAwaitingApproval(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONTYPEID == (short)OperationTypeEnum.LoanReviewApplication).Select(c => c.OPERATIONID).ToList();
            List<int> ids = new List<int>();

            foreach (var operationId in operationIds)
            {
                ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            }

            var dataLoan = (from ln in context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL
                            join atrail in context.TBL_APPROVAL_TRAIL on ln.LOANRECOVERYREPORTAPPROVALID equals atrail.TARGETID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                            && atrail.OPERATIONID == ln.OPERATIONID
                            && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                            && atrail.RESPONSESTAFFID == null && ln.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && (atrail.TOSTAFFID == staffId || atrail.TOSTAFFID == null)

                            select new LoanRecoveryReportApprovalViewModel
                            {
                                currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                referenceId = ln.REFERENCEID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Count(),
                                approvalStatusId = ln.APPROVALSTATUSID,
                                approverComment = atrail.COMMENT,
                                dateTimeCreated = ln.DATETIMECREATED,
                                loanRecoveryReportApprovalId = ln.LOANRECOVERYREPORTAPPROVALID,
                                operationId = ln.OPERATIONID,
                                misCode = ln.MISCODE,
                                region = ln.REGION
                            }).ToList();

            return dataLoan;
        }


        public IEnumerable<LoanRecoveryReportApprovalViewModel> GetBulkRecoveryReportingAwaitingApprovalList(int staffId, int companyId)
        {
            var dataLoan = (from ln in context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL
                            join atrail in context.TBL_APPROVAL_TRAIL on ln.LOANRECOVERYREPORTAPPROVALID equals atrail.TARGETID
                            where
                            (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Authorised
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Disapproved)
                            && atrail.OPERATIONID == ln.OPERATIONID

                            select new LoanRecoveryReportApprovalViewModel
                            {
                                currentApprovalLevelId = atrail.TOAPPROVALLEVELID,
                                referenceId = ln.REFERENCEID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Count(),
                                approvalStatusId = ln.APPROVALSTATUSID,
                                approverComment = atrail.COMMENT,
                                dateTimeCreated = ln.DATETIMECREATED,
                                loanRecoveryReportApprovalId = ln.LOANRECOVERYREPORTAPPROVALID,
                                operationId = ln.OPERATIONID
                            }).ToList();
            var LoanData = dataLoan.GroupBy(x => x.loanRecoveryReportApprovalId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanRecoveryReportApprovalId);

            return LoanData;
        }

        public IEnumerable<GlobalExposureApplicationViewModel> getAllLoansRecoveryReportingByReference(int staffId, int companyId, string referenceId)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            var dataExposureLoan = (from lr in context.TBL_LOAN_RECOVERY_REPORTING_BATCH
                            join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCENUMBER equals ln.REFERENCENUMBER
                            where
                            lr.REFERENCEID == referenceId
                            && lr.LOANREFERENCENUMBER == ln.REFERENCENUMBER
                            select new GlobalExposureApplicationViewModel
                            {
                                loanRecoveryReportBatchId = lr.LOANRECOVERYREPORTBATCHID,
                                loanId = ln.ID,
                                totalAllrecoveryAmount = lr.TOTALAMOUNTRECOVERY,
                                outstandingAmount = (lr.TOTALAMOUNTRECOVERY-lr.AMOUNTRECOVERED),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(d => d.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(d => d.FIRMNAME).FirstOrDefault(),
                                amountRecovered = (decimal)lr.AMOUNTRECOVERED,
                                casaAccount = ln.ACCOUNTNUMBER,
                                casaAccountName = "CURRENT ACCOUNT",
                                accountBalance = 0,
                                amount = (decimal)ln.LOANAMOUNYLCY,
                                loanReferenceNumber = ln.REFERENCENUMBER,
                                applicationReferenceNumber = ln.REFERENCENUMBER,
                                misCode = ln.ACCOUNTOFFICERCODE,
                                teamMiscode = ln.TEAMCODE,
                                principalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                sectorName = ln.CBNSECTOR,
                                outstandingPrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                customerCode = ln.CUSTOMERID,
                                loanTypeName = ln.ADJFACILITYTYPE,
                                customerName = ln.CUSTOMERNAME,
                                branchName = ln.BRANCHNAME,
                                relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                productName = ln.PRODUCTNAME,
                                productCode = ln.PRODUCTCODE,
                            }).ToList();

            foreach (var xx in dataExposureLoan)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var dataDigitalExposureLoan = (from lr in context.TBL_LOAN_RECOVERY_REPORTING_BATCH
                                    join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCENUMBER equals ln.REFERENCENUMBER
                                    where
                                    lr.REFERENCEID == referenceId
                                    && lr.LOANREFERENCENUMBER == ln.REFERENCENUMBER
                                    select new GlobalExposureApplicationViewModel
                                    {
                                        loanRecoveryReportBatchId = lr.LOANRECOVERYREPORTBATCHID,
                                        loanId = ln.ID,
                                        totalAllrecoveryAmount = lr.TOTALAMOUNTRECOVERY,
                                        outstandingAmount = (lr.TOTALAMOUNTRECOVERY - lr.AMOUNTRECOVERED),
                                        accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(d => d.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(d => d.FIRMNAME).FirstOrDefault(),
                                        amountRecovered = (decimal)lr.AMOUNTRECOVERED,
                                        casaAccount = ln.ACCOUNTNUMBER,
                                        casaAccountName = "CURRENT ACCOUNT",
                                        accountBalance = 0,
                                        amount = (decimal)ln.LOANAMOUNYLCY,
                                        loanReferenceNumber = ln.REFERENCENUMBER,
                                        applicationReferenceNumber = ln.REFERENCENUMBER,
                                        misCode = ln.ACCOUNTOFFICERCODE,
                                        teamMiscode = ln.TEAMCODE,
                                        principalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        sectorName = ln.CBNSECTOR,
                                        outstandingPrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        totalAmountRecovery = (decimal)ln.TOTALEXPOSURE,
                                        customerCode = ln.CUSTOMERID,
                                        loanTypeName = ln.ADJFACILITYTYPE,
                                        customerName = ln.CUSTOMERNAME,
                                        branchName = ln.BRANCHNAME,
                                        relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                        relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                        productName = ln.PRODUCTNAME,
                                        productCode = ln.PRODUCTCODE,
                                    }).ToList();

            foreach (var xx in dataDigitalExposureLoan)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var dataLoan = (from lr in context.TBL_LOAN_RECOVERY_REPORTING_BATCH
                            join ln in context.TBL_LOAN on lr.LOANREFERENCENUMBER equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            where
                            lr.REFERENCEID == referenceId
                            && lr.LOANREFERENCENUMBER == ln.LOANREFERENCENUMBER
                            select new GlobalExposureApplicationViewModel
                            {
                                loanRecoveryReportBatchId = lr.LOANRECOVERYREPORTBATCHID,
                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                totalAllrecoveryAmount = lr.TOTALAMOUNTRECOVERY,
                                outstandingAmount = (lr.TOTALAMOUNTRECOVERY - lr.AMOUNTRECOVERED),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(d => d.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(d => d.FIRMNAME).FirstOrDefault(),
                                amountRecovered = (decimal)lr.AMOUNTRECOVERED,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                accountBalance = (double)context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.LEDGERBALANCE).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                totalAmountRecovery = (ln.OUTSTANDINGPRINCIPAL + ln.PASTDUEINTEREST + ln.PASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL),
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                currencyId = ln.CURRENCYID,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = ""
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_LOAN_RECOVERY_REPORTING_BATCH
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCENUMBER equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where
                                     lr.REFERENCEID == referenceId
                                     && lr.LOANREFERENCENUMBER == ln.LOANREFERENCENUMBER
                                     select new GlobalExposureApplicationViewModel
                                     {
                                         loanRecoveryReportBatchId = lr.LOANRECOVERYREPORTBATCHID,
                                         totalAmountRecovery = (ln.PASTDUEPRINCIPAL + ln.PASTDUEINTEREST + ln.INTERESTONPASTDUEPRINCIPAL + ln.INTERESTONPASTDUEINTEREST + ln.PENALCHARGEAMOUNT),
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         totalAllrecoveryAmount = lr.TOTALAMOUNTRECOVERY,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         amountRecovered = (decimal)lr.AMOUNTRECOVERED,
                                         outstandingAmount = (lr.TOTALAMOUNTRECOVERY - lr.AMOUNTRECOVERED),
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         currencyId = ln.CURRENCYID,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                     }).ToList();


            var data = dataLoan.Union(dataRevolvingLoan).Union(dataExposureLoan).Union(dataDigitalExposureLoan);

            return data;
        }

        public WorkflowResponse GoForRecoveryReportingApproval(ApprovalViewModel entity)
        {
            List<string> receiverEmailList = new List<string>();
            AlertsViewModel alert = new AlertsViewModel();
            var dynamicMessage = string.Empty;

            entity.applicationDate = generalSetup.GetApplicationDate();
            using (var trans = context.Database.BeginTransaction())
            {
                var reviewRecord = (from s in context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL
                                    where s.LOANRECOVERYREPORTAPPROVALID == entity.targetId && s.OPERATIONID == entity.operationId
                                    && s.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                    select s).FirstOrDefault();

                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Referred)
                {

                    int staffId = entity.staffId;
                    var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();

                    var levels = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == entity.operationId)
                         .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
                         .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true),
                             mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new
                             {
                                 groupPosition = mg.m.POSITION,
                                 levelPosition = l.POSITION,
                                 levelId = l.APPROVALLEVELID,
                                 levelName = l.LEVELNAME,
                                 staffRoleId = l.STAFFROLEID,
                             })
                             .OrderBy(x => x.groupPosition)
                             .ThenBy(x => x.levelPosition)
                             .ToList();

                    var staffRoleLevels = levels.Where(x => x.staffRoleId == staff.STAFFROLEID);
                    var staffRoleLevelIds = staffRoleLevels.Select(x => x.levelId);
                    var staffRoleLevelId = staffRoleLevelIds.FirstOrDefault();

                    workFlow.StaffId = entity.createdBy;
                    workFlow.OperationId = entity.operationId;
                    workFlow.TargetId = entity.targetId;
                    workFlow.CompanyId = entity.companyId;
                    workFlow.ProductClassId = null;
                    workFlow.ProductId = null;
                    workFlow.NextLevelId = entity.approvalLevelId;
                    workFlow.ToStaffId = staffId;
                    workFlow.StatusId = (int)ApprovalStatusEnum.Referred;
                    workFlow.Comment = entity.comment;
                    workFlow.DeferredExecution = true;


                    var loanAssigns = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Where(x => x.REFERENCEID == reviewRecord.REFERENCEID).ToList();
                    foreach (var loanAssign in loanAssigns)
                    {
                        var record = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Find(loanAssign.LOANRECOVERYREPORTBATCHID);
                        record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Referred;
                        record.OPERATIONCOMPLETED = false;
                        context.SaveChanges();
                    }
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Referred;
                    context.SaveChanges();
                    trans.Commit();
                    return workFlow.Response;
                }

                workFlow.StaffId = entity.staffId;
                workFlow.CompanyId = entity.companyId;
                workFlow.StatusId = ((short)entity.approvalStatusId == (short)ApprovalStatusEnum.Approved) ? (short)ApprovalStatusEnum.Processing : (short)entity.approvalStatusId;
                workFlow.TargetId = entity.targetId;
                workFlow.Comment = entity.comment;
                workFlow.OperationId = entity.operationId;
                workFlow.DeferredExecution = true;
                workFlow.LogActivity();


                bool output = false;
                if (entity.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                {

                    var loanAssigns = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Where(x => x.REFERENCEID == reviewRecord.REFERENCEID).ToList();
                    foreach (var loanAssign in loanAssigns)
                    {
                        var record = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Find(loanAssign.LOANRECOVERYREPORTBATCHID);
                        record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                        record.OPERATIONCOMPLETED = false;
                        context.SaveChanges();
                    }
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                    context.SaveChanges();
                    trans.Commit();
                    return workFlow.Response;
                }

                if (workFlow.NewState != (int)ApprovalState.Ended)
                {
                    reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    output = context.SaveChanges() > 0;
                    trans.Commit();
                    return workFlow.Response;
                }
                else if (workFlow.NewState == (int)ApprovalState.Ended)
                {
                    if (workFlow.StatusId == (int)ApprovalStatusEnum.Approved)
                    {
                        var loanAssigns = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Where(x => x.REFERENCEID == reviewRecord.REFERENCEID).ToList();
                        foreach (var loanAssign in loanAssigns)
                        {
                            var record = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Find(loanAssign.LOANRECOVERYREPORTBATCHID);
                            record.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                            record.OPERATIONCOMPLETED = true;
                            record.OPERATIONID = entity.operationId;
                            output = context.SaveChanges() > 0;
                        }
                        reviewRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                        output = context.SaveChanges() > 0;
                    }
                    if (output == true)
                    {
                        trans.Commit();

                    }

                }
                return workFlow.Response;

            }

        }


        public IEnumerable<GlobalExposureApplicationViewModel> GetAllLoansRecoveredByAgentForReporting(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var loansId = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Where(x => x.DELETED == false).Select(x => x.COLLATERALLIQUIDATIONRECOVERYID).ToList();
            
            var dataExposureLoan = (from lr  in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY 
                            join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                            where 
                            !loansId.Contains(lr.COLLATERALLIQUIDATIONRECOVERYID) 

                            select new GlobalExposureApplicationViewModel
                            {
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                percentageCommission = lr.PERCENTAGECOMMISSION,
                                loanCategory = ln.CBNCLASSIFICATION,
                                collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                isFullyRecovered = lr.ISFULLYRECOVERED,
                                fileName = lr.FILENAME,
                                fileExtension = lr.FILEEXTENSION,
                                fileSize = lr.FILESIZE,
                                fileSizeUnit = lr.FILESIZEUNIT,
                                receiptDate = lr.RECEIPTDATE,
                                totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                recoveredAmount = lr.RECOVEREDAMOUNT,
                                outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                collateralCode = lr.COLLATERALCODE,
                                collectionMode = lr.COLLECTIONMODE,
                                createdBy = lr.CREATEDBY,
                                loanId = ln.ID,
                                casaAccount = ln.ACCOUNTNUMBER,
                                casaAccountName = "CURRENT ACCOUNT",
                                amount = (decimal)ln.LOANAMOUNYLCY,
                                loanReferenceNumber = ln.REFERENCENUMBER,
                                applicationReferenceNumber = ln.REFERENCENUMBER,
                                misCode = ln.ACCOUNTOFFICERCODE,
                                teamMiscode = ln.TEAMCODE,
                                principalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY, 
                                sectorName = ln.CBNSECTOR,
                                customerCode = ln.CUSTOMERID,
                                loanTypeName = ln.ADJFACILITYTYPE,
                                customerName = ln.CUSTOMERNAME,
                                branchName = ln.BRANCHNAME,
                                relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                productName = ln.PRODUCTNAME,
                                productCode = ln.PRODUCTCODE,
                                creatorName = ln.ACCOUNTOFFICERNAME,
                                pastDueInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                pastDuePrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                outstandingInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                            }).ToList();

            foreach (var xx in dataExposureLoan)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var dataDigitalExposureLoan = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                                    join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                    where
                                    !loansId.Contains(lr.COLLATERALLIQUIDATIONRECOVERYID)

                                    select new GlobalExposureApplicationViewModel
                                    {
                                        accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                        accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                        accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                        agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                        percentageCommission = lr.PERCENTAGECOMMISSION,
                                        loanCategory = ln.CBNCLASSIFICATION,
                                        collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                        accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                        isFullyRecovered = lr.ISFULLYRECOVERED,
                                        fileName = lr.FILENAME,
                                        fileExtension = lr.FILEEXTENSION,
                                        fileSize = lr.FILESIZE,
                                        fileSizeUnit = lr.FILESIZEUNIT,
                                        receiptDate = lr.RECEIPTDATE,
                                        totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                        recoveredAmount = lr.RECOVEREDAMOUNT,
                                        outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                        collateralCode = lr.COLLATERALCODE,
                                        collectionMode = lr.COLLECTIONMODE,
                                        createdBy = lr.CREATEDBY,
                                        loanId = ln.ID,
                                        casaAccount = ln.ACCOUNTNUMBER,
                                        casaAccountName = "CURRENT ACCOUNT",
                                        amount = (decimal)ln.LOANAMOUNYLCY,
                                        loanReferenceNumber = ln.REFERENCENUMBER,
                                        applicationReferenceNumber = ln.REFERENCENUMBER,
                                        misCode = ln.ACCOUNTOFFICERCODE,
                                        teamMiscode = ln.TEAMCODE,
                                        principalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        sectorName = ln.CBNSECTOR,
                                        customerCode = ln.CUSTOMERID,
                                        loanTypeName = ln.ADJFACILITYTYPE,
                                        customerName = ln.CUSTOMERNAME,
                                        branchName = ln.BRANCHNAME,
                                        relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                        relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                        productName = ln.PRODUCTNAME,
                                        productCode = ln.PRODUCTCODE,
                                        creatorName = ln.ACCOUNTOFFICERNAME,
                                        pastDueInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                        pastDuePrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        outstandingInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                    }).ToList();

            foreach (var xx in dataDigitalExposureLoan)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }
            var dataLoan = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            pr.EXCLUDEFROMLITIGATION == false
                            && !loansId.Contains(lr.COLLATERALLIQUIDATIONRECOVERYID)
                            && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                            select new GlobalExposureApplicationViewModel
                            {
                                loanApplicationId = lp.LOANAPPLICATIONID,
                                currencyId = ld.CURRENCYID,
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                percentageCommission = lr.PERCENTAGECOMMISSION,
                                loanCategory = context.TBL_LOAN_REVIEW_OPERATION.Where(l => l.LOANID == ln.TERMLOANID).Select(l => l.OPERATIONTYPEID).FirstOrDefault() == (int)OperationsEnum.CompleteWriteOff ? "Written Off" : "Non Performing",
                                collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                isFullyRecovered = lr.ISFULLYRECOVERED,
                                fileName = lr.FILENAME,
                                fileExtension = lr.FILEEXTENSION,
                                fileSize = lr.FILESIZE,
                                fileSizeUnit = lr.FILESIZEUNIT,
                                receiptDate = lr.RECEIPTDATE,
                                totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                recoveredAmount = lr.RECOVEREDAMOUNT,
                                outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                collateralCode = lr.COLLATERALCODE,
                                collectionMode = lr.COLLECTIONMODE,
                                createdBy = lr.CREATEDBY,
                                //dateTimeCreated = lr.DATETIMECREATED,

                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,

                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where 
                                     pr.EXCLUDEFROMLITIGATION == false
                                     && !loansId.Contains(lr.COLLATERALLIQUIDATIONRECOVERYID)
                                     && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                                     select new GlobalExposureApplicationViewModel
                                     {
                                         loanApplicationId = lp.LOANAPPLICATIONID,
                                         currencyId = ld.CURRENCYID,
                                         accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                         accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                         agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                         percentageCommission = lr.PERCENTAGECOMMISSION,
                                         loanCategory = context.TBL_LOAN_REVIEW_OPERATION.Where(l => l.LOANID == ln.REVOLVINGLOANID).Select(l => l.OPERATIONTYPEID).FirstOrDefault() == (int)OperationsEnum.CompleteWriteOff ? "Written Off" : "Non Performing",
                                         collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                         accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                         isFullyRecovered = lr.ISFULLYRECOVERED,
                                         fileName = lr.FILENAME,
                                         fileExtension = lr.FILEEXTENSION,
                                         fileSize = lr.FILESIZE,
                                         fileSizeUnit = lr.FILESIZEUNIT,
                                         receiptDate = lr.RECEIPTDATE,
                                         totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                         recoveredAmount = lr.RECOVEREDAMOUNT,
                                         outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                         collateralCode = lr.COLLATERALCODE,
                                         collectionMode = lr.COLLECTIONMODE,
                                         createdBy = lr.CREATEDBY,
                                         //dateTimeCreated = lr.DATETIMECREATED,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                     }).ToList();


            var unionAll = dataLoan.Union(dataRevolvingLoan).Union(dataExposureLoan).Union(dataDigitalExposureLoan);

            var data = unionAll;

            return data;
        }


        public IEnumerable<GlobalExposureApplicationViewModel> GetAllLoansRecoveredByAgents(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            
            var dataExposureLoan = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                            join ln in context.TBL_GLOBAL_EXPOSURE on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                            where 
                            ln.REFERENCENUMBER != null

                            select new GlobalExposureApplicationViewModel
                            {
                                currencyId = 1,
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                percentageCommission = lr.PERCENTAGECOMMISSION,
                                loanCategory = ln.CBNCLASSIFICATION,
                                collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                isFullyRecovered = lr.ISFULLYRECOVERED,
                                fileName = lr.FILENAME,
                                fileExtension = lr.FILEEXTENSION,
                                fileSize = lr.FILESIZE,
                                fileSizeUnit = lr.FILESIZEUNIT,
                                receiptDate = lr.RECEIPTDATE,
                                totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                recoveredAmount = lr.RECOVEREDAMOUNT,
                                outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                collateralCode = lr.COLLATERALCODE,
                                collectionMode = lr.COLLECTIONMODE,
                                createdBy = lr.CREATEDBY,
                                loanId = ln.ID,
                                casaAccount = ln.ACCOUNTNUMBER,
                                casaAccountName = "CURRENT ACCOUNT",
                                amount = (decimal)ln.LOANAMOUNYLCY,
                                loanReferenceNumber = ln.REFERENCENUMBER,
                                applicationReferenceNumber = ln.REFERENCENUMBER,
                                teamMiscode = ln.TEAMCODE,
                                principalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY, 
                                sectorName = ln.CBNSECTOR,
                                customerCode = ln.CUSTOMERID,
                                customerName = ln.CUSTOMERNAME,
                                branchName = ln.BRANCHNAME,
                                branchCode = ln.BRANCHCODE,
                                productCode = ln.PRODUCTCODE,
                                relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                productName = ln.PRODUCTNAME,
                                approvedAmount = ln.LOANAMOUNYLCY,
                                creatorName = ln.ACCOUNTOFFICERNAME,
                                pastDueInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                pastDuePrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                outstandingInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                accruedInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                            }).ToList();

            foreach (var xx in dataExposureLoan)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var dataDigitalExposureLoan = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                                    join ln in context.TBL_GLOBAL_EXPOSURE_DIGITAL_LOAN on lr.LOANREFERENCE equals ln.REFERENCENUMBER
                                    where
                                    ln.REFERENCENUMBER != null

                                    select new GlobalExposureApplicationViewModel
                                    {
                                        currencyId = 1,
                                        accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                        accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                        accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                        agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                        percentageCommission = lr.PERCENTAGECOMMISSION,
                                        loanCategory = ln.CBNCLASSIFICATION,
                                        collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                        accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                        isFullyRecovered = lr.ISFULLYRECOVERED,
                                        fileName = lr.FILENAME,
                                        fileExtension = lr.FILEEXTENSION,
                                        fileSize = lr.FILESIZE,
                                        fileSizeUnit = lr.FILESIZEUNIT,
                                        receiptDate = lr.RECEIPTDATE,
                                        totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                        recoveredAmount = lr.RECOVEREDAMOUNT,
                                        outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                        collateralCode = lr.COLLATERALCODE,
                                        collectionMode = lr.COLLECTIONMODE,
                                        createdBy = lr.CREATEDBY,
                                        loanId = ln.ID,
                                        casaAccount = ln.ACCOUNTNUMBER,
                                        casaAccountName = "CURRENT ACCOUNT",
                                        amount = (decimal)ln.LOANAMOUNYLCY,
                                        loanReferenceNumber = ln.REFERENCENUMBER,
                                        applicationReferenceNumber = ln.REFERENCENUMBER,
                                        teamMiscode = ln.TEAMCODE,
                                        principalAmount = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        sectorName = ln.CBNSECTOR,
                                        customerCode = ln.CUSTOMERID,
                                        customerName = ln.CUSTOMERNAME,
                                        branchName = ln.BRANCHNAME,
                                        branchCode = ln.BRANCHCODE,
                                        productCode = ln.PRODUCTCODE,
                                        relationshipOfficerName = ln.ACCOUNTOFFICERNAME,
                                        relationshipManagerName = ln.ACCOUNTOFFICERNAME,
                                        productName = ln.PRODUCTNAME,
                                        approvedAmount = ln.LOANAMOUNYLCY,
                                        creatorName = ln.ACCOUNTOFFICERNAME,
                                        pastDueInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                        pastDuePrincipal = (decimal)ln.PRINCIPALOUTSTANDINGBALLCY,
                                        outstandingInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                        accruedInterest = (decimal)ln.UNPOINTERESTAMOUNT,
                                    }).ToList();

            foreach (var xx in dataDigitalExposureLoan)
            {
                xx.branchId = context.TBL_BRANCH.Where(x => x.BRANCHCODE == xx.branchCode).Select(x => x.BRANCHID).FirstOrDefault();
                xx.customerId = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == xx.customerCode).Select(x => x.CUSTOMERCODE).FirstOrDefault();
                xx.productId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTID).FirstOrDefault();
                xx.productClassId = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == xx.productCode).Select(x => x.PRODUCTCLASSID).FirstOrDefault();
            }

            var dataLoan = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                            join ln in context.TBL_LOAN on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                            join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                            join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                            join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                            join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                            join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                            join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                            join ch in context.TBL_CHART_OF_ACCOUNT on pr.PRINCIPALBALANCEGL equals ch.GLACCOUNTID
                            where
                            pr.EXCLUDEFROMLITIGATION == false
                            && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                            select new GlobalExposureApplicationViewModel
                            {
                                loanApplicationId = lp.LOANAPPLICATIONID,
                                currencyId = ld.CURRENCYID,
                                accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                percentageCommission = lr.PERCENTAGECOMMISSION,
                                loanCategory = context.TBL_LOAN_REVIEW_OPERATION.Where(l => l.LOANID == ln.TERMLOANID).Select(l => l.OPERATIONTYPEID).FirstOrDefault() == (int)OperationsEnum.CompleteWriteOff ? "Written Off" : "Non Performing",
                                collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                isFullyRecovered = lr.ISFULLYRECOVERED,
                                fileName = lr.FILENAME,
                                fileExtension = lr.FILEEXTENSION,
                                fileSize = lr.FILESIZE,
                                fileSizeUnit = lr.FILESIZEUNIT,
                                receiptDate = lr.RECEIPTDATE,
                                totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                recoveredAmount = lr.RECOVEREDAMOUNT,
                                outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                collateralCode = lr.COLLATERALCODE,
                                collectionMode = lr.COLLECTIONMODE,
                                createdBy = lr.CREATEDBY,
                                //dateTimeCreated = lr.DATETIMECREATED,

                                creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                creditAppraisalOperationId = lp.OPERATIONID,

                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                loanId = ln.TERMLOANID,
                                customerId = cu.CUSTOMERCODE,
                                productId = ln.PRODUCTID,
                                productTypeId = pr.PRODUCTTYPEID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                branchId = ln.BRANCHID,
                                amount = ld.APPROVEDAMOUNT,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID != null ? (short)ln.PRINCIPALFREQUENCYTYPEID : (short)0,
                                pricipalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID != null ? (short)ln.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.MODE,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.OUTSTANDINGPRINCIPAL, //\\\ln.PrincipalAmount,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanStatusId = ln.LOANSTATUSID,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = (int)ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                customerGroupId = lp.CUSTOMERGROUPID,
                                operationId = ln.OPERATIONID,
                                loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,
                                customerCode = cu.CUSTOMERCODE,
                                loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                branchName = br.BRANCHNAME,
                                relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                productName = pr.PRODUCTNAME,
                                comment = "",
                                approvedAmount = ld.APPROVEDAMOUNT,
                                creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                pastDueInterest = ln.PASTDUEINTEREST,
                                pastDuePrincipal = ln.PASTDUEPRINCIPAL,
                                interestOnPastDueInterest = ln.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = ln.INTERESTONPASTDUEPRINCIPAL,
                                outstandingInterest = ln.OUTSTANDINGINTEREST,
                                accruedInterest = (from a in context.TBL_LOAN_SCHEDULE_DAILY where a.TBL_LOAN.TERMLOANID == ln.TERMLOANID && a.DATE == applicationDate select a.ACCRUEDINTEREST).FirstOrDefault(),
                            }).ToList();

            var dataRevolvingLoan = (from lr in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                                     join ln in context.TBL_LOAN_REVOLVING on lr.LOANREFERENCE equals ln.LOANREFERENCENUMBER
                                     join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                                     join ld in context.TBL_LOAN_APPLICATION_DETAIL on ln.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                     join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                     join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                     join cu in context.TBL_CUSTOMER on ln.CUSTOMERID equals cu.CUSTOMERID
                                     join pr in context.TBL_PRODUCT on ln.PRODUCTID equals pr.PRODUCTID
                                     join st in context.TBL_STAFF on ln.RELATIONSHIPOFFICERID equals st.STAFFID
                                     join stm in context.TBL_STAFF on ln.RELATIONSHIPMANAGERID equals stm.STAFFID
                                     where 
                                     pr.EXCLUDEFROMLITIGATION == false
                                     && ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved

                                     select new GlobalExposureApplicationViewModel
                                     {
                                         loanApplicationId = lp.LOANAPPLICATIONID,
                                         currencyId = ld.CURRENCYID,
                                         accreditedConsultantName = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.NAME).FirstOrDefault(),
                                         accreditedConsultantCompany = context.TBL_ACCREDITEDCONSULTANT.Where(x => x.ACCREDITEDCONSULTANTID == lr.ACCREDITEDCONSULTANT).Select(x => x.FIRMNAME).FirstOrDefault(),
                                         accreditedConsultantId = lr.ACCREDITEDCONSULTANT,
                                         agentCommission = lr.RECOVEREDAMOUNT * (lr.PERCENTAGECOMMISSION / 100),
                                         percentageCommission = lr.PERCENTAGECOMMISSION,
                                         loanCategory = context.TBL_LOAN_REVIEW_OPERATION.Where(l => l.LOANID == ln.REVOLVINGLOANID).Select(l => l.OPERATIONTYPEID).FirstOrDefault() == (int)OperationsEnum.CompleteWriteOff ? "Written Off" : "Non Performing",
                                         collateralLiquidationRecoveryId = lr.COLLATERALLIQUIDATIONRECOVERYID,
                                         accreditedConsultant = lr.ACCREDITEDCONSULTANT,
                                         isFullyRecovered = lr.ISFULLYRECOVERED,
                                         fileName = lr.FILENAME,
                                         fileExtension = lr.FILEEXTENSION,
                                         fileSize = lr.FILESIZE,
                                         fileSizeUnit = lr.FILESIZEUNIT,
                                         receiptDate = lr.RECEIPTDATE,
                                         totalRecoveryAmount = lr.TOTALRECOVERYAMOUNT,
                                         recoveredAmount = lr.RECOVEREDAMOUNT,
                                         outstandingAmount = lr.OUTSTANDINGAMOUNT,
                                         collateralCode = lr.COLLATERALCODE,
                                         collectionMode = lr.COLLECTIONMODE,
                                         createdBy = lr.CREATEDBY,
                                         //dateTimeCreated = lr.DATETIMECREATED,
                                         creditAppraisalLoanApplicationId = lp.LOANAPPLICATIONID,
                                         creditAppraisalOperationId = lp.OPERATIONID,
                                         loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                         loanId = ln.REVOLVINGLOANID,
                                         customerId = cu.CUSTOMERCODE,
                                         productId = ln.PRODUCTID,
                                         productTypeId = pr.PRODUCTTYPEID,
                                         casaAccountId = ln.CASAACCOUNTID,
                                         casaAccount = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                         casaAccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == ln.CASAACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         branchId = ln.BRANCHID,
                                         loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                         applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER,
                                         relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                         relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                         misCode = ln.MISCODE,
                                         teamMiscode = ln.TEAMMISCODE,
                                         interestRate = ln.INTERESTRATE,
                                         effectiveDate = ln.EFFECTIVEDATE,
                                         maturityDate = ln.MATURITYDATE,
                                         bookingDate = ln.BOOKINGDATE,
                                         approvedBy = (int)ln.APPROVEDBY,
                                         approverComment = ln.APPROVERCOMMENT,
                                         dateApproved = ln.DATEAPPROVED,
                                         loanStatusId = ln.LOANSTATUSID,
                                         isDisbursed = ln.ISDISBURSED,
                                         disburserComment = ln.DISBURSERCOMMENT,
                                         disburseDate = ln.DISBURSEDATE,
                                         customerGroupId = lp.CUSTOMERGROUPID,
                                         operationId = ln.OPERATIONID,
                                         loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                         subSectorId = ln.SUBSECTORID,
                                         subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                         sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                         dischargeLetter = ln.DISCHARGELETTER,
                                         suspendInterest = ln.SUSPENDINTEREST,
                                         customerCode = cu.CUSTOMERCODE,
                                         loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                         customerName = cu.LASTNAME + " " + cu.FIRSTNAME + " " + cu.MIDDLENAME,
                                         branchName = br.BRANCHNAME,
                                         relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                         relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                         productName = pr.PRODUCTNAME,
                                         comment = "",
                                         approvedAmount = ld.APPROVEDAMOUNT,
                                         creatorName = context.TBL_STAFF.Where(x => x.STAFFID == ld.CREATEDBY).Select(x => x.FIRSTNAME + " " + x.LASTNAME).FirstOrDefault(),
                                     }).ToList();


            var unionAll = dataLoan.Union(dataRevolvingLoan).Union(dataExposureLoan).Union(dataDigitalExposureLoan);

            var data = unionAll;

            return data;
        }

        public IEnumerable<LoanRecoveryReportApprovalViewModel> BulkRecoveryReportingApplicationList(int staffId, int companyId)
        {
            var dataLoan = (from ln in context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL
                            where
                            ln.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending

                            select new LoanRecoveryReportApprovalViewModel
                            {
                                referenceId = ln.REFERENCEID,
                                loanRecoveryReportApprovalId = ln.LOANRECOVERYREPORTAPPROVALID,
                                numberOfLoans = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Where(x => x.REFERENCEID == ln.REFERENCEID).Count(),
                                approvalStatusId = (int)ln.APPROVALSTATUSID,
                                dateTimeCreated = ln.DATETIMECREATED,
                                operationId = ln.OPERATIONID
                            }).ToList();
            var LoanData = dataLoan.GroupBy(x => x.loanRecoveryReportApprovalId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.loanRecoveryReportApprovalId);

            return LoanData;
        }

        public IEnumerable<AccreditedConsultantsViewModel> GetAllRecoveryAgents(int staffId, int companyId)
        {

            var data = (from ln in context.TBL_ACCREDITEDCONSULTANT
                            where
                            ln.ACCREDITEDCONSULTANTTYPEID == (int)AccreditedConsultantTypeEnum.RecoveryAgent

                            select new AccreditedConsultantsViewModel
                            {
                                firmName = ln.FIRMNAME,
                                name = ln.NAME,
                                accreditedConsultantId = ln.ACCREDITEDCONSULTANTID
                            }).OrderBy(x=>x.firmName).ToList();

            return data;
        }

        public IEnumerable<RecoveryCollectionsViewModel> GetAllRecoveryCustomersAssignedToAgent(int recoveryAgent)
        {
            var customerIds = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.ACCREDITEDCONSULTANT == recoveryAgent && x.DELETED == false && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved).Select(x => x.CUSTOMERID).Distinct().ToList();
            var data = (from x in context.TBL_CUSTOMER
                        where
                        customerIds.Contains(x.CUSTOMERCODE)

                        select new RecoveryCollectionsViewModel
                        {
                            customerId = x.CUSTOMERID,
                            customerName = x.FIRSTNAME + " " + x.LASTNAME,
                        }).OrderBy(x=>x.customerName).ToList();

            return data;
        }

        public IEnumerable<AccreditedConsultantsViewModel> GetAllInternalRecoveryAgents(int staffId, int companyId, DateTime month)
        {
            var monthInWord = "";
            if(month.Month == 1)
            {
                monthInWord = "January, " +month.Year;
            }
            if (month.Month == 2)
            {
                monthInWord = "February, " + month.Year;
            }
            if (month.Month == 3)
            {
                monthInWord = "March, " + month.Year;
            }
            if (month.Month == 4)
            {
                monthInWord = "April, " + month.Year;
            }
            if (month.Month == 5)
            {
                monthInWord = "May, " + month.Year;
            }
            if (month.Month == 6)
            {
                monthInWord = "June, " + month.Year;
            }
            if (month.Month == 7)
            {
                monthInWord = "July, " + month.Year;
            }
            if (month.Month == 8)
            {
                monthInWord = "August, " + month.Year;
            }
            if (month.Month == 9)
            {
                monthInWord = "September, " + month.Year;
            }
            if (month.Month == 10)
            {
                monthInWord = "October, " + month.Year;
            }
            if (month.Month == 11)
            {
                monthInWord = "November, " + month.Year;
            }
            if (month.Month == 12)
            {
                monthInWord = "December, " + month.Year;
            }

            DateTime collectionDate = DateTime.ParseExact(monthInWord, "MMMM, yyyy", CultureInfo.InvariantCulture);
            var data = (from ln in context.TBL_ACCREDITEDCONSULTANT
                        join a in context.TBL_LOAN_RECOVERY_REPORT_COLLECTION on ln.ACCREDITEDCONSULTANTID equals a.ACCREDITEDCONSULTANT
                        where
                        ln.ACCREDITEDCONSULTANTTYPEID == (int)AccreditedConsultantTypeEnum.RecoveryAgent
                        && ln.CATEGORY.ToLower() == "internal"
                        && a.COLLECTIONDATE.Value.Month == collectionDate.Month
                        && a.COLLECTIONDATE.Value.Year == collectionDate.Year

                        select new AccreditedConsultantsViewModel
                        {
                            firmName = ln.FIRMNAME,
                            name = ln.NAME,
                            accreditedConsultantId = ln.ACCREDITEDCONSULTANTID,
                            phoneNumber = ln.REGISTRATIONNUMBER,
                            emailAddress = ln.EMAILADDRESS,
                            accountNumber = ln.ACCOUNTNUMBER,
                            address = ln.ADDRESS,
                            amountRecovered = context.TBL_LOAN_RECOVERY_REPORT_COLLECTION.Where(x => x.ACCREDITEDCONSULTANT == ln.ACCREDITEDCONSULTANTID && (DbFunctions.TruncateTime(x.COLLECTIONDATE).Value.Month == DbFunctions.TruncateTime(month).Value.Month && DbFunctions.TruncateTime(x.COLLECTIONDATE).Value.Year == DbFunctions.TruncateTime(month).Value.Year)).Sum(x => x.AMOUNTRECOVERED ?? 0m),
                            allAmountRecovered = context.TBL_LOAN_RECOVERY_REPORT_COLLECTION.Where(x => x.ACCREDITEDCONSULTANT == ln.ACCREDITEDCONSULTANTID).Sum(x => x.AMOUNTRECOVERED ?? 0m)
                        }).ToList();

            var records = data.GroupBy(x => x.accreditedConsultantId).Select(y => y.FirstOrDefault()).OrderByDescending(x => x.accreditedConsultantId);
            foreach(var i in records)
            {
                i.currentDate = monthInWord;
                //i.totalRecoveryAmount = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.ACCREDITEDCONSULTANT == i.accreditedConsultantId && x.ISFULLYRECOVERED == false && x.DELETED == false).Sum(x => x.TOTALAMOUNTRECOVERY ?? 0m) + i.amountRecovered ?? 0m;
                i.totalRecoveryAmount = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.ACCREDITEDCONSULTANT == i.accreditedConsultantId && x.ISFULLYRECOVERED == false && x.DELETED == false && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONCOMPLETED == true && (x.DATEASSIGNED.Month == collectionDate.Month && x.DATEASSIGNED.Year == collectionDate.Year)).Sum(x => x.TOTALAMOUNTRECOVERY ?? 0m);
                //var totalRecoveryAssign = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.ACCREDITEDCONSULTANT == i.accreditedConsultantId && x.ISFULLYRECOVERED == false && x.DELETED == false).Sum(x => x.TOTALAMOUNTRECOVERY ?? 0m) + i.amountRecovered ?? 0m;
                var totalRecoveryAssign = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.ACCREDITEDCONSULTANT == i.accreditedConsultantId && x.ISFULLYRECOVERED == false && x.DELETED == false && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONCOMPLETED == true && (x.DATEASSIGNED.Month == collectionDate.Month && x.DATEASSIGNED.Year == collectionDate.Year)).Sum(x => x.TOTALAMOUNTRECOVERY ?? 0m);
                if (i.totalRecoveryAmount == null || i.totalRecoveryAmount < 1)
                {
                    i.totalRecoveryAssigned = i.amountRecovered;
                    i.totalRecoveryAmount = 0m;
                }
                else
                {
                   i.totalRecoveryAssigned = totalRecoveryAssign;
                }
            }
            return records;
        }

    }
}