using FintrakBanking.Common;
using FintrakBanking.Common.Enum;
using FintrakBanking.Entities.Models;
using FintrakBanking.Interfaces.Admin;
using FintrakBanking.Interfaces.Credit;
using FintrakBanking.Interfaces.Customer;
using FintrakBanking.Interfaces.Finance;
using FintrakBanking.Interfaces.Setups.Approval;
using FintrakBanking.Interfaces.Setups.General;
using FintrakBanking.Interfaces.WorkFlow;
using FintrakBanking.ViewModels;
using FintrakBanking.ViewModels.CASA;
using FintrakBanking.ViewModels.Credit;
using FintrakBanking.ViewModels.Customer;
using FintrakBanking.ViewModels.Finance;
using FintrakBanking.ViewModels.Setups.Finance;
using FintrakBanking.ViewModels.Setups.General;
using FintrakBanking.ViewModels.WorkFlow;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Entity;
using System.Linq;
using System.Threading.Tasks;
using FintrakBanking.Interfaces.CASA;
using FintrakBanking.ViewModels.ThridPartyIntegration;
using FintrakBanking.ViewModels.Report;
using FintrakBanking.Common.CustomException;
using FintrakBanking.Entities.StagingModels;
using FinTrakBanking.ThirdPartyIntegration.StagingDatabase.Finacle;
using FintrakBanking.Interfaces.Setups.Finance;
using FinTrakBanking.ThirdPartyIntegration;
using FinTrakBanking.ThirdPartyIntegration.Finacle.CWGAPI;
using GemBox.Spreadsheet;
using System.IO;
using FintrakBanking.ViewModels.Setups.Credit;
using System.Net.Http;
using System.Web.Script.Serialization;
using System.Net.Http.Headers;
using System.Net;
using System.Text;
using FintrakBanking.ViewModels.Flexcube;
using FinTrakBanking.ThirdPartyIntegration.Finacle;
using System.Configuration;
using FinTrakBanking.ThirdPartyIntegration.CustomerInfo;
using System.Transactions;
using FintrakBanking.ViewModels.Reports;
using System.Globalization;

namespace FintrakBanking.Repositories.Credit 
{
    public class LoanRepository : ILoanRepository
    {
        private string API_KEY = string.Empty;
        private string API_URL = string.Empty;
        private IEnumerable<TBL_API_URL> APIUrlConfig;
        private FinTrakBankingContext context;
        private IGeneralSetupRepository generalSetup;
        private IAuditTrailRepository auditTrail;
        private ILoanScheduleRepository loanSchedule;
        private ILoanCovenantRepository loanCovenant;
        private IFinanceTransactionRepository financeTransaction;
        private ICasaLienRepository casaLien;
        private IApprovalLevelStaffRepository level;
        private ICustomerRepository customers;

        private IWorkflow workflow;
        private IAuditTrailRepository audit;
        private IOverRideRepository overrider;
        private IChartOfAccountRepository chartOfAccount;
        private IntegrationWithFlexcube integration;
        private ILoanApplicationRepository loanApp;
        private FinTrakBankingStagingContext stgCon;
        private IAdminRepository admin;
        private IFinanceTransactionRepository transRepo;
        private IApprovalLevelRepository approvalLevelStaff;
        private TransactionPosting transaction;
        //private IAppraisalMemorandumRepository appraisalMemoRepo;


        //private CreditCommonRepository creditCommon;

        private IIntegrationWithFinacle finacle;
        bool USE_THIRD_PARTY_INTEGRATION = false;
        private DateTime? applicationDate = null;

        public LoanRepository(FinTrakBankingContext _context, IGeneralSetupRepository _genSetup,
                                        IAuditTrailRepository _auditTrail, ILoanScheduleRepository _loanSchedule,
                                        ILoanCovenantRepository _loanCovenant, IAuditTrailRepository _audit,
                                        IFinanceTransactionRepository _financeTransaction, IApprovalLevelStaffRepository _level,
                                        ICustomerRepository _customers, IWorkflow _workflow, ICasaLienRepository _casaLien,
                                        IChartOfAccountRepository _chartOfAccount, IFinanceTransactionRepository _transRepo,
                                        //IOverRideRepository _overrider, IntegrationWithFlexcube _integration, ILoanApplicationRepository _loanRepo,
                                        IOverRideRepository _overrider, IntegrationWithFlexcube _integration,
            IIntegrationWithFinacle finacle, FinTrakBankingStagingContext _stgCon, IAdminRepository _admin,//, CreditCommonRepository creditCommon
            IApprovalLevelRepository _approvalLevelStaff, TransactionPosting _transaction
            //, IAppraisalMemorandumRepository _appraisalMemoRepo

            )
        {
            this.context = _context;
            this.generalSetup = _genSetup;
            this.auditTrail = _auditTrail;
            this.loanSchedule = _loanSchedule;
            this.loanCovenant = _loanCovenant;
            this.audit = _audit;
            this.financeTransaction = _financeTransaction;
            this.level = _level;
            this.customers = _customers;
            this.workflow = _workflow;
            this.casaLien = _casaLien;
            this.overrider = _overrider;
            this.chartOfAccount = _chartOfAccount;
            this.integration = _integration;
            //this.loanApp = _loanRepo;
            this.finacle = finacle;
            this.stgCon = _stgCon;
            this.transRepo = _transRepo;
            this.admin = _admin;
            this.approvalLevelStaff = _approvalLevelStaff;
            this.transaction = _transaction;
            //this.appraisalMemoRepo = _appraisalMemoRepo;
            //this.creditCommon = creditCommon;

            APIUrlConfig = context.TBL_API_URL;
            var globalSetting = context.TBL_SETUP_GLOBAL.FirstOrDefault();
            USE_THIRD_PARTY_INTEGRATION = globalSetting.USE_THIRD_PARTY_INTEGRATION;

        }

        public int DateDiff(DateTime startDate, DateTime endDate)
        {
            int noofdays = (((int)(endDate - startDate).TotalDays));
            return noofdays;
        }

        public IEnumerable<RevolvingLoanViewModel> GetRevolvingLoanTypes()
        {
            return (from data in context.TBL_LOAN_REVOLVING_TYPE
                    select new RevolvingLoanViewModel()
                    {
                        revolvingTypeId = data.REVOLVINGTYPEID,
                        revolvingTypeName = data.REVOLVINGTYPENAME,
                        isTemporaryOverdraft = data.ISTEMPORARYOVERDRAFT
                    });
        }



        public IQueryable<LoanViewModel> SearchForLoanPrepaymentReversal(string searchQuery)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            IQueryable<LoanViewModel> allFilteredLoan = null;

            searchQuery = searchQuery.Trim();
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                var loans = (from a in context.TBL_LOAN
                             join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                             join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                             join d in context.TBL_LOAN_REVIEW_OPERATION on a.TERMLOANID equals d.LOANID
                             where a.ISDISBURSED == true && a.MATURITYDATE >= DbFunctions.TruncateTime(applicationDate) && a.LOANSTATUSID == (int)LoanStatusEnum.Active && d.OPERATIONDATE == DbFunctions.TruncateTime(applicationDate)
                             select new LoanViewModel
                             {
                                 loanId = a.TERMLOANID,
                                 customerId = a.CUSTOMERID,
                                 customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                 firstName = b.FIRSTNAME,
                                 lastName = b.LASTNAME,
                                 customerCode = b.CUSTOMERCODE,
                                 productAccountName = c.PRODUCTACCOUNTNAME,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 principalAmount = a.PRINCIPALAMOUNT,
                                 loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                 productName = a.TBL_PRODUCT.PRODUCTNAME,
                                 productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                 currencyId = a.CURRENCYID,
                                 currencyCode = a.TBL_CURRENCY.CURRENCYCODE
                             }).Distinct().ToList();

                allFilteredLoan = loans.Where(x => x.loanReferenceNumber.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.customerCode.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.firstName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.lastName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.productAccountName.ToLower().Contains(searchQuery.ToLower()))
                                   .Take(10).AsQueryable();

            }

            return allFilteredLoan;

        }


        public IEnumerable<LoanCovenantDetailViewModel> GetLoanApplicationDetailCovenantById(int applicationDetailId)
        {
            return (from data in context.TBL_LOAN_APPLICATION_COVENANT
                    where data.LOANAPPLICATIONDETAILID == applicationDetailId && data.DELETED == false
                    select new LoanCovenantDetailViewModel()
                    {
                        loanCovenantDetailId = data.LOANCOVENANTDETAILID,
                        covenantDetail = data.COVENANTDETAIL,
                        covenantTypeId = data.COVENANTTYPEID,
                        covenantTypeName = data.TBL_LOAN_COVENANT_TYPE.COVENANTTYPENAME,
                        frequencyTypeId = data.FREQUENCYTYPEID,
                        frequencyTypeName = data.TBL_FREQUENCY_TYPE.DESCRIPTION,
                        covenantAmount = data.COVENANTAMOUNT,
                        covenantDate = data.COVENANTDATE,
                        loanApplicationDetailId = data.LOANAPPLICATIONDETAILID,
                        isPercentage = data.ISPERCENTAGE,
                        nextCovenantDate = data.NEXTCOVENANTDATE,
                        casaAccountId = data.CASAACCOUNTID,
                        companyId = data.COMPANYID
                    });
        }

        public IEnumerable<RevolvingLoanViewModel> GetTemporaryOverdrafts()
        {
            return (from data in context.TBL_LOAN_REVOLVING_TYPE
                    where data.ISTEMPORARYOVERDRAFT == true
                    select new RevolvingLoanViewModel()
                    {
                        revolvingTypeId = data.REVOLVINGTYPEID,
                        revolvingTypeName = data.REVOLVINGTYPENAME,
                        isTemporaryOverdraft = data.ISTEMPORARYOVERDRAFT
                    });
        }

        /// <summary>
        /// Gets all loan types.
        /// </summary>
        /// <returns></returns>
        public IEnumerable<LookupViewModel> GetLoanApplicationTypes()
        {
            return (from data in context.TBL_LOAN_APPLICATION_TYPE
                    select new LookupViewModel()
                    {
                        lookupId = data.LOANAPPLICATIONTYPEID,
                        lookupName = data.LOANAPPLICATIONTYPENAME
                    });
        }


        public CasaBalanceViewModel GetCASABalanceById(int casaAccountId, int companyId)
        {
            var accountDetails = financeTransaction.GetCASABalance(casaAccountId);
            return accountDetails;
        }

        public CurrencyExchangeRateViewModel GetExchangeRate(string fromCurrencyCode, string toCurrencyCode, string rateCode)
        {
            var rate = integration.GetExchangeRate(fromCurrencyCode, toCurrencyCode, rateCode);
            return rate;
        }

        public IEnumerable<TransactionDynamicsViewModel> GetLoanTransactionDynamics(int loanApplicationDetailId)
        {
            return (from data in context.TBL_LOAN_TRANSACTION_DYNAMICS
                    where data.LOANAPPLICATIONDETAILID == loanApplicationDetailId
                    select new TransactionDynamicsViewModel()
                    {
                        // dynamicsId = data.DYNAMICSID,
                        dynamics = data.DYNAMICS,
                        //productId = data.TBL_TRANSACTION_DYNAMICS.PRODUCTID,
                        // loanDynamicsId = data.LOANDYNAMICSID
                    });
        }

        public List<ProductFeeViewModel> GetLoanProductFees(int loanBookingRequestId)
        {
            var bookingRequest = context.TBL_LOAN_BOOKING_REQUEST.Find(loanBookingRequestId);
            var loanApplicationDeatilId = bookingRequest != null ? bookingRequest.LOANAPPLICATIONDETAILID : 0;

            var loanAppProdFee = (from fa in context.TBL_LOAN_APPLICATION_DETL_FEE
                                  where fa.LOANAPPLICATIONDETAILID == loanApplicationDeatilId
                                  && fa.DELETED == false
                                  select new ProductFeeViewModel
                                  {
                                      feeName = fa.TBL_CHARGE_FEE.CHARGEFEENAME,
                                      loanApplicationDetailId = fa.LOANAPPLICATIONDETAILID,
                                      chargeFeeId = fa.CHARGEFEEID,
                                      consessionReason = fa.CONSESSIONREASON,
                                      approvalStatusId = fa.APPROVALSTATUSID,
                                      defaultfeeRateValue = fa.DEFAULT_FEERATEVALUE,
                                      recommededFeeRateValue = fa.RECOMMENDED_FEERATEVALUE,
                                      feeRateValue = fa.RECOMMENDED_FEERATEVALUE,
                                      feeAmount =  fa.RECOMMENDED_FEERATEVALUE,
                                      feeIntervalName = fa.TBL_CHARGE_FEE.TBL_FEE_INTERVAL.FEEINTERVALNAME,
                                      isIntegralFee = fa.TBL_CHARGE_FEE.ISINTEGRALFEE,
                                      isRecurring = fa.TBL_CHARGE_FEE.RECURRING,
                                      valueBase = fa.TBL_CHARGE_FEE.TBL_FEE_TYPE.FEETYPENAME,//"Rate(%)",
                                      feeTypeId = fa.TBL_CHARGE_FEE.TBL_FEE_TYPE.FEETYPEID,
                                      dealTypeId = 0
                                  }).ToList();

            var lisProdFeeViewModel = new List<ProductFeeViewModel>();
            foreach (var item in loanAppProdFee)
            {
                if(item.feeTypeId == 1 || item.feeTypeId == 3 || item.feeTypeId == 5)
                {
                    item.feeAmount = (bookingRequest.AMOUNT_REQUESTED * item.feeAmount) / 100;
                }
                if(item.feeName.ToLower().Contains("(ad valorem)") && item.deleted == false)
                {
                    item.isDutiable = true;
                    decimal bankShare = 0;
                    var stampFees = context.TBL_FACILITY_STAMP_DUTY.Where(s => s.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId && s.DELETED == false).FirstOrDefault();

                    if (stampFees != null && stampFees.ISSHARED)
                    {
                        bankShare = item.feeAmount * (stampFees.BANKPERCENTAGE / 100);
                        decimal customerShare = item.feeAmount * (stampFees.CUSTOMERPERCENTAGE / 100);
                        item.bankShare = bankShare;
                        item.customerShare = customerShare;
                    }
                    else
                    {
                        item.customerShare = item.feeAmount;
                    }

                }
                var chargeFeeDetail = context.TBL_CHARGE_FEE_DETAIL.Where(x => x.CHARGEFEEID == item.chargeFeeId && x.DETAILTYPEID == (short)ChargeFeeDetailTypeEnum.Tax).FirstOrDefault();
                if (chargeFeeDetail != null)
                {

                    var prodFeeView = new ProductFeeViewModel()
                    {
                        feeName = chargeFeeDetail.DESCRIPTION,
                        loanApplicationDetailId = loanApplicationDeatilId,
                        chargeFeeId = chargeFeeDetail.CHARGEFEEID,
                        recommededFeeRateValue = (decimal)chargeFeeDetail.VALUE,
                        feeRateValue = (decimal)chargeFeeDetail.VALUE,
                        feeAmount = (item.feeAmount * (decimal)chargeFeeDetail.VALUE) / 100,
                        feeIntervalName = chargeFeeDetail.TBL_CHARGE_FEE.TBL_FEE_INTERVAL.FEEINTERVALNAME,
                        isIntegralFee = chargeFeeDetail.TBL_CHARGE_FEE.ISINTEGRALFEE,
                        isRecurring = chargeFeeDetail.TBL_CHARGE_FEE.RECURRING,
                        valueBase = chargeFeeDetail.TBL_CHARGE_FEE.TBL_FEE_TYPE.FEETYPENAME,//"Rate(%)",
                        dealTypeId = (short)ChargeFeeDetailTypeEnum.Tax
                    };

                    lisProdFeeViewModel.Add(prodFeeView);
                }
            }

            loanAppProdFee = loanAppProdFee.Union(lisProdFeeViewModel).OrderBy(x => x.feeName).ToList();

            return loanAppProdFee;
        }


        public string GenerateLoanReferenceNumber(int branchId, int productId, int loanSystemTypeId)
        {
            var branch = this.context.TBL_BRANCH.Find(branchId);
            var productCode = this.context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == productId).PRODUCTCODE;
            if (loanSystemTypeId == (int)LoanSystemTypeEnum.TermDisbursedFacility)
            {
                var data = ((this.context.TBL_LOAN.Count(x => x.BRANCHID == branch.BRANCHID && x.PRODUCTID == productId)) + 1);
                var reference = $"{branch.BRANCHCODE.Trim()}-{productCode.Trim()}-{CommonHelpers.GenerateZeroString(5).Trim() + data.ToString().Right(5).Trim()}";

                for (var count = data; context.TBL_LOAN.Where(x => x.LOANREFERENCENUMBER == reference).Any(); count++)
                {
                    reference = $"{branch.BRANCHCODE.Trim()}-{productCode.Trim()}-{CommonHelpers.GenerateZeroString(5).Trim() + count.ToString().Right(5).Trim()}";
                };
                return reference;
            }
            else if (loanSystemTypeId == (int)LoanSystemTypeEnum.OverdraftFacility)
            {
                var data = ((this.context.TBL_LOAN_REVOLVING.Count(x => x.BRANCHID == branch.BRANCHID && x.PRODUCTID == productId)) + 1);
                return $"{branch.BRANCHCODE.Trim()}-{productCode.Trim()}-{CommonHelpers.GenerateZeroString(5).Trim() + data.ToString().Right(5).Trim()}";
            }
            else if (loanSystemTypeId == (int)LoanSystemTypeEnum.ContingentLiability)
            {
                var data = ((this.context.TBL_LOAN_CONTINGENT.Count(x => x.BRANCHID == branch.BRANCHID && x.PRODUCTID == productId)) + 1);
                return $"{productCode.Trim()}-{branch.BRANCHCODE.Trim()}-{CommonHelpers.GenerateZeroString(5).Trim() + data.ToString().Right(5).Trim()}";
            }
            else throw new ConditionNotMetException("Loan Product Type not defined for Loan Booking");

        }



        public List<OverrideItemVeiwModel> getBookingOverride(string customerCode)
        {
            var data = (from r in context.TBL_OVERRIDE_DETAIL
                        where r.OVERRIDE_ITEMID == (short)OverrideEnum.TakeFeeAtDisbursement && r.CUSTOMERCODE == customerCode
                        && r.ISUSED == false //|| r.SOURCE_REFERENCE_NUMBER == 
                        select new OverrideItemVeiwModel
                        {
                            customerCode = r.CUSTOMERCODE,
                            itemName = r.TBL_OVERRIDE_ITEM.OVERIDE_ITEMNAME,
                            status = r.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                            reason = r.REASON
                        }).ToList();

            return data;
        }

        private bool confirmCustomerAccountFunded(List<LoanChargeFeeViewModel> model, int casaAccountId, int companyId, int customerId, string loanReferenceNumber)
        {
            decimal AllfeeAmount = 0;
            foreach (var item in model) { AllfeeAmount = AllfeeAmount + item.feeAmount; }

            var casaBalance = GetCASABalanceById(casaAccountId, companyId).availableBalance;
            var customer = context.TBL_CUSTOMER.Find(customerId);

            if (AllfeeAmount > casaBalance)
            {
                int custFeeOverridable = overrider.EffectOverride(customer.CUSTOMERCODE, (short)OverrideEnum.TakeFeeAtDisbursement, loanReferenceNumber);
                if (custFeeOverridable > 0)
                {
                    return true;
                }
                else throw new ConditionNotMetException("The customer account is not funded and fee override is not enabled for this customer");
            }
            return false;
        }

        public bool UpdateFacilityLineStatus(LoanViewModel entity)
        {
            var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            var application = context.TBL_LOAN_APPLICATION.Find(applicationDetail.LOANAPPLICATIONID);
            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(entity.loanBookingRequestId);
            if (applicationDetail == null) { return false; }
            var systemdate = getApplicationDate();

            //if (context.TBL_PRODUCT.Where(x => x.PRODUCTID == request.PRODUCTID &&  x.ISFACILITYLINE != true ).Any())
            //{
            //    applicationDetail.APPROVEDLINESTATUSID = entity.approvedLineStatusId;
            //    request.APPROVEDLINESTATUSID = entity.approvedLineStatusId;
            //    //request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
            //    applicationDetail.EFFECTIVEDATE = systemdate;
            //    //request.ISUSED = true;
            //    context.SaveChanges();

            //    return true;
            //}
            var approvalModel = new ForwardViewModel
            {
                createdBy = entity.createdBy,
                companyId = entity.companyId,
                applicationId = entity.loanBookingRequestId,
                comment = "Line Maintained",
                amount = entity.principalAmount,
                operationId = (int)entity.operationId,
            };

            workflow.StaffId = entity.createdBy;
            workflow.CompanyId = entity.companyId;
            workflow.StatusId = (int)ApprovalStatusEnum.Approved;
            workflow.TargetId = (int)entity.loanBookingRequestId;
            workflow.Comment = entity.comment;
            workflow.OperationId = (short)entity.operationId;
            workflow.DeferredExecution = true;
            workflow.ExternalInitialization = false;

            if (application != null) workflow.BusinessUnitId = application.TBL_CUSTOMER?.BUSINESSUNTID;

            var wf = workflow.LogActivity();

            context.SaveChanges();


            if (applicationDetail.APPROVEDLINESTATUSID == null) { applicationDetail.APPROVEDLINESTATUSID = 1; }
            if (request.APPROVEDLINESTATUSID == null) { request.APPROVEDLINESTATUSID = 1; }

            request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Processing;
            request.ISUSED = true;

            if (workflow.NewState == (int)ApprovalState.Ended)
            {
                applicationDetail.EFFECTIVEDATE = systemdate;
                request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
                request.ISMAINTAINEDLINE = false;
            }
            context.SaveChanges();

            return true;

            //
            //{ return false; }

        }


        public string AddLoanBooking(LoanViewModel entity)
        {
            if (entity.productTypeId == (int)LoanProductTypeEnum.TermLoan || entity.productTypeId == (int)LoanProductTypeEnum.SelfLiquidating || entity.productTypeId == (int)LoanProductTypeEnum.SyndicatedTermLoan)
            {
                if (entity.isInEditMode)
                {
                    return this.EditTermLoan(entity);
                }
                else
                {
                    return this.AddTermLoan(entity);
                }
            }
            else if (entity.productTypeId == (int)LoanProductTypeEnum.CommercialLoan)
            {
                if (entity.isInEditMode)
                    return this.EditCommercialLoan(entity);

                else
                    return AddCommercialLoan(entity);
            }
            else if (entity.productTypeId == (int)LoanProductTypeEnum.ForeignXRevolving)
            {
                if (entity.isInEditMode)
                    return this.EditFXLoan(entity);

                else
                    return AddFXLoan(entity, false);
            }
            else if (entity.productTypeId == (int)LoanProductTypeEnum.RevolvingLoan)
            {
                if (entity.isInEditMode)
                    return this.EditRevolvingLoan(entity);

                else
                    return addRevolvingLoan(entity);
            }
            else if (entity.productTypeId == (int)LoanProductTypeEnum.ContingentLiability)
            {
                if (entity.isInEditMode)
                    return this.EditContingentLiability(entity);

                else
                    return addContingentLiability(entity);
            }
            else
            {
                throw new ConditionNotMetException("The Product type is Invalid");
            }
        }

        //private bool PendingBondsAndGuaranteeJobRequest(int applicationId)
        //{
        //    var detailids = context.TBL_LOAN_APPLICATION_DETAIL.Where(x => x.LOANAPPLICATIONID == applicationId)
        //        .Select(x => x.LOANAPPLICATIONDETAILID)
        //        .ToList();
        //    return context.TBL_JOB_REQUEST.Where(x => detailids.Contains(x.TARGETID)
        //        && x.OPERATIONSID == (short)OperationsEnum.LoanApplication
        //        && x.JOBTYPEID == (short)JobTypeEnum.legal
        //        && x.REQUESTSTATUSID == (short)JobRequestStatusEnum.pending
        //    ).Any();
        //}

        private bool PendingBondsAndGuaranteeJobRequest(int applicationDetailId)
        {
            var requestsToLegal = context.TBL_JOB_REQUEST.Where(x => x.TARGETID == applicationDetailId
                && x.OPERATIONSID == (short)OperationsEnum.OfferLetterApproval
                && x.JOBTYPEID == (short)JobTypeEnum.legal && x.REQUESTSTATUSID != (short)JobRequestStatusEnum.cancel
            );
            //if(requestsToLegal.Count() <= 0) { throw new ConditionNotMetException("No request has been sent to Legal for preparation of B&G Instrument."); }

            if (requestsToLegal.Where(x => x.REQUESTSTATUSID == (short)JobRequestStatusEnum.pending).Any())
                throw new ConditionNotMetException("There are pending B&G Legal Job request which must be approved");

            var attendedRequests = requestsToLegal.Where(x => x.REQUESTSTATUSID != (short)JobRequestStatusEnum.pending);

            if (attendedRequests.Any())
            {
                if (attendedRequests.Where(x => x.REQUESTSTATUSID == (short)JobRequestStatusEnum.processing).Any())
                    throw new ConditionNotMetException("Bond and gaurantee job sent to legal is still being processed. Loan cannot be book until process is completed.");

                if (attendedRequests.Where(x => x.REQUESTSTATUSID == (short)JobRequestStatusEnum.disapproved).Any())
                    throw new ConditionNotMetException("Bond and gaurantee job sent to legal was disapproved. You cannot continue with the application.");
            }

            return true;
        }

        private void loanBookingValidation(LoanViewModel entity)
        {
            var application = context.TBL_LOAN_APPLICATION.Find(entity.loanApplicationId);
            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(entity.loanBookingRequestId);
            var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            var systemDate = generalSetup.GetApplicationDate();
            var product = context.TBL_PRODUCT.Find(request.PRODUCTID);

            if (applicationDetail.ISLINEFACILITY == true && applicationDetail.APPROVEDLINESTATUSID == null)
            {
                throw new ConditionNotMetException("Please Maintain the line before booking");
            }

            //**********VALIDATING COMMERCIAL LOAN INPUTS ************//
            if (entity.productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
            {
                var loanTenorDays = (entity.maturityDate - entity.effectiveDate).Days;
                if (loanTenorDays > applicationDetail.APPROVEDTENOR)
                    throw new ConditionNotMetException("The loan tenor cannot be more than the tenor of it's line. \r\n The Line tenor is " + applicationDetail.APPROVEDTENOR + " days");

                if (entity.casaAccountId2 == null || entity.casaAccountId2 == 0)
                    throw new ConditionNotMetException("Specify the recieving account.");

                if (entity.effectiveDate == entity.maturityDate)
                    throw new ConditionNotMetException("Effective date and maturity Date cannot be equal");

                if (request.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                    throw new ConditionNotMetException("This Loan Request has already been booked by another staff");

                if (entity.effectiveDate > entity.maturityDate)
                    throw new ConditionNotMetException("The effective cannot be greater than maturity date");

                if (entity.effectiveDate > systemDate)
                    throw new ConditionNotMetException("You effective date cannot be post-dated.");

                if (applicationDetail.EXPIRYDATE != null && entity.maturityDate > applicationDetail.EXPIRYDATE)
                    throw new ConditionNotMetException($"Commercial Loan maturity date should not exceed the line expiry date [{Convert.ToDateTime(applicationDetail.EXPIRYDATE).ToString("dd/MM/yyyy")}]. ");

                if (product.MAXIMUMTENOR > 0 && product.MAXIMUMTENOR < (entity.maturityDate - entity.effectiveDate).Days)
                    throw new ConditionNotMetException("You have exceeded the maximum tenor of the product. The maximun tenor is " + product.MAXIMUMTENOR);
            }

            //**********VALIDATING FX REVOLVING LOAN INPUTS ************//
            if (entity.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
            {
                if (request.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                    throw new ConditionNotMetException("This Loan Request has already been booked by another staff");

                if (entity.effectiveDate > entity.maturityDate)
                    throw new ConditionNotMetException("The effective cannot be greater than maturity date");

                if (entity.effectiveDate > systemDate)
                    throw new ConditionNotMetException("The effective date cannot be post-dated.");

                if (entity.effectiveDate == entity.maturityDate)
                    throw new ConditionNotMetException("Effective date and maturity Date cannot be equal");

                if (applicationDetail.EXPIRYDATE != null && entity.maturityDate > applicationDetail.EXPIRYDATE)
                    throw new ConditionNotMetException($"FX revolving loan maturity date should not exceed the line expiry date [{Convert.ToDateTime(applicationDetail.EXPIRYDATE).ToString("dd/MM/yyyy")}]. ");

                if (product.MAXIMUMTENOR > 0 && product.MAXIMUMTENOR < (entity.maturityDate - entity.effectiveDate).Days)
                    throw new ConditionNotMetException("You have exceeded the maximun tenor of the product. The maximun tenor is " + product.MAXIMUMTENOR);
            }

            //********** VALIDATING TERM LOAN BOOKING INPUTS ************//
            if (entity.productTypeId == (short)LoanProductTypeEnum.TermLoan)
            {
                if (entity.loanScheduleInput.maturityDate <= entity.loanScheduleInput.effectiveDate)
                    throw new ConditionNotMetException("Loan terminal date should be more than effective date");

                if (request.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                    throw new ConditionNotMetException("This Loan Request has already been booked by another staff");

                if (entity.effectiveDate == entity.maturityDate)
                    throw new ConditionNotMetException("Effective date and maturity Date cannot be equal");

                if (entity.effectiveDate > entity.maturityDate)
                    throw new ConditionNotMetException("The effective date cannot be greater than maturity date");

                if (entity.effectiveDate > systemDate)
                    throw new ConditionNotMetException("The effective date cannot be post-dated.");

                if (application.TBL_PRODUCT_CLASS != null && application.TBL_PRODUCT_CLASS.PRODUCTCLASSID == (short)ProductClassEnum.InvoiceDiscountingFacility)
                {
                    if (entity.casaAccountId2 == null || entity.casaAccountId2 == 0)
                        throw new ConditionNotMetException("Specify the collection account.");
                }

                if (product.MAXIMUMTENOR > 0 && product.MAXIMUMTENOR < (entity.maturityDate - entity.effectiveDate).Days)
                    throw new ConditionNotMetException("You have exceeded the maximun tenor of the product. The maximun tenor is " + product.MAXIMUMTENOR);
            }

            //********** VALIDATING CONTIGENT FACILITY INPUTS ************//
            if (entity.productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
            {
                var contingentLoanInput = entity.contingentLoanInput;
                var contingentAmount = from a in context.TBL_LOAN_CONTINGENT
                                       where a.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId
                                       let sumAmount = context.TBL_LOAN_CONTINGENT.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).Sum(x => x.CONTINGENTAMOUNT)
                                       select sumAmount;

                var currentExchangeRate = financeTransaction.GetExchangeRate(DateTime.Now, (short)contingentLoanInput.currencyId, entity.companyId).sellingRate;

                var totalPreviouslyBookedAmount = contingentAmount.FirstOrDefault();

                var totalContingentAmount = totalPreviouslyBookedAmount + contingentLoanInput.contingentAmount;
                // if (totalContingentAmount > entity.customerAvailableAmount)
                if (applicationDetail.ISLINEFACILITY == false )
                {
                    if (totalContingentAmount > applicationDetail.APPROVEDAMOUNT)
                        throw new ConditionNotMetException("The loan amount cannot be greater than the availiable amount");
                }

                if (request.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                    throw new ConditionNotMetException("This Loan Request has already been booked by another staff");

                if (entity.effectiveDate == entity.maturityDate)
                    throw new ConditionNotMetException("Effective date and maturity Date cannot be equal");

                if (entity.effectiveDate > entity.maturityDate)
                    throw new ConditionNotMetException("The effective cannot be greater than maturity date");

                if (entity.effectiveDate > systemDate)
                    throw new ConditionNotMetException("The effective date cannot be post-dated.");

                if (product.MAXIMUMTENOR > 0 && product.MAXIMUMTENOR < (entity.maturityDate - entity.effectiveDate).Days)
                    throw new ConditionNotMetException("You have exceeded the maximun tenor of the product. The maximun tenor is " + product.MAXIMUMTENOR);
            }

            //********** VALIDATING REVOLVING FACILITY INPUTS ************//
            if (entity.productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
            {
                var revolvingLoanInput = entity.revolvingLoanInput;
                var overdraftLimit = from a in context.TBL_LOAN_REVOLVING
                                     where a.LOANAPPLICATIONDETAILID == revolvingLoanInput.loanApplicationDetailId
                                     let sumLimit = context.TBL_LOAN_REVOLVING.Where(x => x.LOANAPPLICATIONDETAILID == revolvingLoanInput.loanApplicationDetailId).Sum(x => x.OVERDRAFTLIMIT)
                                     select sumLimit;

                var currentExchangeRate = financeTransaction.GetExchangeRate(DateTime.Now, (short)revolvingLoanInput.currencyId, entity.companyId).sellingRate;

                var totalPreviouslyBookedAmount = overdraftLimit.FirstOrDefault();

                var totaloverdraftLimit = totalPreviouslyBookedAmount + revolvingLoanInput.overdraftLimit;

                if (applicationDetail.ISLINEFACILITY == false)
                {
                    if (totaloverdraftLimit > entity.customerAvailableAmount)
                        throw new ConditionNotMetException("The loan amount cannot be greater than the availiable amount");
                }

                if (entity.effectiveDate > entity.maturityDate)
                    throw new ConditionNotMetException("The effective cannot be greater than maturity date");

                if (entity.effectiveDate > systemDate)
                    throw new ConditionNotMetException("The effective date cannot be post-dated.");

                if (request.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                    throw new ConditionNotMetException("This Loan Request has already been booked by another staff");

                if (product.MAXIMUMTENOR > 0 && product.MAXIMUMTENOR < (entity.maturityDate - entity.effectiveDate).Days)
                    throw new ConditionNotMetException("You have exceeded the maximun tenor of the product. The maximun tenor is " + product.MAXIMUMTENOR);
            }

        }

        private string EditRevolvingLoan(LoanViewModel model)
        {
            var application = context.TBL_LOAN_APPLICATION.Find(model.loanApplicationId);
            var revolvingLoanInput = model.revolvingLoanInput;
            var systemDate = generalSetup.GetApplicationDate();

            //var overdraftLimit = from a in context.TBL_LOAN_REVOLVING
            //                     where a.LOANAPPLICATIONDETAILID == revolvingLoanInput.loanApplicationDetailId
            //                     let sumLimit = context.TBL_LOAN_REVOLVING.Where(x => x.LOANAPPLICATIONDETAILID == revolvingLoanInput.loanApplicationDetailId).Sum(x => x.OVERDRAFTLIMIT)
            //                     select sumLimit;

            var currentExchangeRate = financeTransaction.GetExchangeRate(DateTime.Now, (short)revolvingLoanInput.currencyId, model.companyId).sellingRate;

            //var totalPreviouslyBookedAmount = overdraftLimit.FirstOrDefault();

            //var totaloverdraftLimit = totalPreviouslyBookedAmount + revolvingLoanInput.overdraftLimit;

            //if (totaloverdraftLimit > model.customerAvailableAmount)
            //    throw new ConditionNotMetException("The loan amount cannot be greater than the availiable amount");

            //if (model.effectiveDate > model.maturityDate)
            //    throw new ConditionNotMetException("The effective cannot be greater than maturity date");

            //if (model.effectiveDate > systemDate)
            //    throw new ConditionNotMetException("You effective date cannot be post-dated.");


            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(model.loanBookingRequestId);
            //if (request.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
            //    throw new ConditionNotMetException("This Loan Request has already been booked by another staff");

            var product = context.TBL_PRODUCT.Find(model.productId);

            var loanReferenceNumber = GenerateLoanReferenceNumber(application.BRANCHID, model.productId, (short)LoanSystemTypeEnum.OverdraftFacility);
            //branchId, productId, serial

            if (revolvingLoanInput.revolvingTypeId == 0)
                revolvingLoanInput.revolvingTypeId = (short)LoanRevolvingTypeEnum.NormalOverdraft;

            var revolvingFacility = context.TBL_LOAN_REVOLVING.Find(model.loanId);
            revolvingFacility.CASAACCOUNTID = model.casaAccountId;
            revolvingFacility.EFFECTIVEDATE = revolvingLoanInput.effectiveDate;
            revolvingFacility.MATURITYDATE = revolvingLoanInput.maturityDate;
            revolvingFacility.OVERDRAFTLIMIT = revolvingLoanInput.overdraftLimit;
            revolvingFacility.DAYCOUNTCONVENTIONID = revolvingLoanInput.accrualBasis;
            revolvingFacility.REVOLVINGTYPEID = revolvingLoanInput.revolvingTypeId;


            var approvalModel = new ForwardViewModel
            {
                createdBy = model.createdBy,
                companyId = model.companyId,
                applicationId = model.loanBookingRequestId,
                comment = "Please proceed. The loan booking setup has been modified.",
                amount = model.principalAmount,
                operationId = (int)OperationsEnum.RevolvingLoanBooking
            };
            LogApproval(approvalModel, (int)OperationsEnum.RevolvingLoanBooking, false, (int)ApprovalStatusEnum.Processing);

            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.LoanBookingAdded,
                STAFFID = model.createdBy,
                BRANCHID = (short)model.userBranchId,
                DETAIL = $"Applied for loan with reference number: {loanReferenceNumber}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = model.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            context.TBL_AUDIT.Add(audit);

            try
            {
                context.SaveChanges();
                return revolvingFacility.LOANREFERENCENUMBER;
            }
            catch (ConditionNotMetException ex) { throw new ConditionNotMetException(ex.Message); }

            catch (Exception ex) { throw new Exception(ex.Message); }
        }


        private string addRevolvingLoan(LoanViewModel model)
        {
            var application = context.TBL_LOAN_APPLICATION.Find(model.loanApplicationId);
            var applicationdetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(model.loanApplicationDetailId);
            var revolvingLoanInput = model.revolvingLoanInput;
            var systemDate = generalSetup.GetApplicationDate();

            var approvedAmount = context.TBL_LOAN_APPLICATION_DETAIL.Where(x => x.LOANAPPLICATIONDETAILID == model.loanApplicationDetailId).FirstOrDefault().APPROVEDAMOUNT;

            var overdraftLimit = from a in context.TBL_LOAN_REVOLVING
                                 where a.LOANAPPLICATIONDETAILID == revolvingLoanInput.loanApplicationDetailId
                                 let sumLimit = context.TBL_LOAN_REVOLVING.Where(x => x.LOANAPPLICATIONDETAILID == revolvingLoanInput.loanApplicationDetailId).Sum(x => x.OVERDRAFTLIMIT)
                                 select sumLimit;

            var currentExchangeRate = financeTransaction.GetExchangeRate(DateTime.Now, (short)revolvingLoanInput.currencyId, model.companyId).sellingRate;

            var totalPreviouslyBookedAmount = overdraftLimit.FirstOrDefault();

            var totaloverdraftLimit = totalPreviouslyBookedAmount + revolvingLoanInput.overdraftLimit;

            decimal lineReleasePrincipalAmount = 0;

            if (applicationdetail.ISLINEFACILITY == true)
            {
                var lineFacilities = context.TBL_LOAN.Where(a => a.LOANAPPLICATIONDETAILID == model.loanApplicationDetailId).ToList();
                lineReleasePrincipalAmount = lineFacilities.Count() > 0 ? lineFacilities.Sum(x => x.PRINCIPALAMOUNT) : 0;
            }

            if ((totaloverdraftLimit - (decimal)lineReleasePrincipalAmount) > (decimal)approvedAmount)
                throw new ConditionNotMetException("The loan amount cannot be greater than the availiable amount");

            if (model.effectiveDate > model.maturityDate)
                throw new ConditionNotMetException("The effective cannot be greater than maturity date");

            if (model.effectiveDate > systemDate)
                throw new ConditionNotMetException("You effective date cannot be post-dated.");


            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(model.loanBookingRequestId);
            if (request.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
                throw new ConditionNotMetException("This Loan Request has already been booked by another staff");

            var product = context.TBL_PRODUCT.Find(model.productId);

            if (product.MAXIMUMTENOR > 0 && product.MAXIMUMTENOR < (model.maturityDate - model.effectiveDate).Days)
                throw new ConditionNotMetException("You have exceeded the maximun tenor of the product. The maximun tenor is " + product.MAXIMUMTENOR);

            var loanReferenceNumber = GenerateLoanReferenceNumber(application.BRANCHID, model.productId, (short)LoanSystemTypeEnum.OverdraftFacility);

            if (revolvingLoanInput.revolvingTypeId == 0)
                revolvingLoanInput.revolvingTypeId = (short)LoanRevolvingTypeEnum.NormalOverdraft;

            if (applicationdetail.ISLINEFACILITY == true)
            {
                model.customerId = request.CUSTOMERID != null ? (int)request.CUSTOMERID : model.customerId;
            }

            var data = new TBL_LOAN_REVOLVING
            {
                LOAN_BOOKING_REQUESTID = model.loanBookingRequestId,
                CUSTOMERID = model.customerId,
                PRODUCTID = request.PRODUCTID,
                CASAACCOUNTID = model.casaAccountId,
                BRANCHID = application.BRANCHID,
                //CURRENCYID = (short)model.exchangeRate,
                CURRENCYID = (short)model.currencyId,
                EXCHANGERATE = currentExchangeRate,
                LOANAPPLICATIONDETAILID = model.loanApplicationDetailId,
                LOANREFERENCENUMBER = loanReferenceNumber,
                RELATED_LOAN_REFERENCE_NUMBER = loanReferenceNumber,
                SUBSECTORID = model.subSectorId,
                RELATIONSHIPOFFICERID = application.RELATIONSHIPOFFICERID,
                RELATIONSHIPMANAGERID = application.RELATIONSHIPMANAGERID,
                MISCODE = application.MISCODE,
                TEAMMISCODE = application.TEAMMISCODE,
                INTERESTRATE = model.interestRate,
                EFFECTIVEDATE = revolvingLoanInput.effectiveDate,
                MATURITYDATE = revolvingLoanInput.maturityDate,
                BOOKINGDATE = generalSetup.GetApplicationDate(),
                OVERDRAFTLIMIT = revolvingLoanInput.overdraftLimit,
                DAYCOUNTCONVENTIONID = revolvingLoanInput.accrualBasis,
                REVOLVINGTYPEID = revolvingLoanInput.revolvingTypeId,
                APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,
                LOANSTATUSID = (int)LoanStatusEnum.Inactive,
                ISDISBURSED = false,
                OPERATIONID = model.operationId = (int)OperationsEnum.RevolvingLoanBooking,
                LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.OverdraftFacility,
                DISCHARGELETTER = false,
                SUSPENDINTEREST = false,

                COMPANYID = model.companyId,
                CREATEDBY = model.createdBy,
                DATETIMECREATED = DateTime.Now,
                // LASTRESTRUCTUREDATE = revolvingLoanInput.effectiveDate,
                USER_PRUDENTIAL_GUIDE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                EXT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                INT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                //CRMSREPAYMENTAGREEMENTID = model.crmsRepaymentAgreementTypeId
            };

            //Audit Section ---------------------------
            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.LoanBookingAdded,
                STAFFID = model.createdBy,
                BRANCHID = (short)model.userBranchId,
                DETAIL = $"Applied for loan with reference number: {loanReferenceNumber}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = model.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            //end of Audit section -------------------------------

            using (var trans = context.Database.BeginTransaction())
            {
                //confirmCustomerAccountFunded(model.loanChargeFee, model.casaAccountId, model.companyId, model.customerId, loanReferenceNumber);
                model.feeOverride = true;

                var loan = context.TBL_LOAN_REVOLVING.Add(data);

                AddLoanMonitoringTrigger(model.loanApplicationDetailId, model.createdBy, loan.REVOLVINGLOANID, (short)LoanSystemTypeEnum.OverdraftFacility);
                //AddLoanMonitoringTrigger(model.monitoringTriggers, loan.REVOLVINGLOANID, (short)LoanSystemTypeEnum.OverdraftFacility);

                request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
                request.ISUSED = true;
                application.APPLICATIONSTATUSID = (short)LoanApplicationStatusEnum.LoanBookingInProgress;

                context.TBL_AUDIT.Add(audit);

                var dataCount = context.SaveChanges();



                var approvalModel = new ForwardViewModel
                {
                    createdBy = model.createdBy,
                    companyId = model.companyId,
                    applicationId = model.loanBookingRequestId,
                    comment = "Please approve this Loan",
                    amount = revolvingLoanInput.approvedAmount,
                    operationId = (int)OperationsEnum.RevolvingLoanBooking
                };

                if (LogApproval(approvalModel, (int)OperationsEnum.RevolvingLoanBooking, false, (int)ApprovalStatusEnum.Processing))
                {
                    AddLoanCovenant(model, loan.REVOLVINGLOANID, (short)LoanSystemTypeEnum.OverdraftFacility);

                    AddLoanFees(model.loanChargeFee, loan.REVOLVINGLOANID, (short)LoanSystemTypeEnum.OverdraftFacility, model, applicationdetail);
                    //AddDeferredFees(model.loanChargeFee, (short)LoanSystemTypeEnum.OverdraftFacility, model, applicationdetail);

                    model.loanReferenceNumber = loanReferenceNumber;

                    AddLoanCollateralMapping(model.loanApplicationId, loan.REVOLVINGLOANID, (short)LoanSystemTypeEnum.OverdraftFacility);

                    //if (!model.feeOverride) { PostLoanFees(model); }

                    if (product.TBL_PRODUCT_CLASS.PRODUCTCLASSID != (short)ProductClassEnum.Creditcards)
                    {
                        var staffCode = context.TBL_STAFF.Find(model.createdBy).STAFFCODE;
                        // CreateFacilityOnThirdParty(loan.PRODUCTID, loan.LOANAPPLICATIONDETAILID, loan.CASAACCOUNTID, loan.EFFECTIVEDATE, loan.MATURITYDATE, loan.LOANSYSTEMTYPEID, staffCode, staffCode);
                    }

                    if (applicationdetail.STAMPDUTYAPPLICABLE)
                    {
                        var apiResult = new PostingResult();
                        var stampDuty = context.TBL_FACILITY_STAMP_DUTY.Where(f => f.LOANAPPLICATIONDETAILID == applicationdetail.LOANAPPLICATIONDETAILID && f.DELETED == false).FirstOrDefault();
                        var appCol = context.TBL_LOAN_APPLICATION_COLLATERL.Where(c => c.LOANAPPLICATIONDETAILID == stampDuty.LOANAPPLICATIONDETAILID && c.DELETED == false).FirstOrDefault();
                        var col = context.TBL_COLLATERAL_CUSTOMER.Where(co => co.COLLATERALCUSTOMERID == stampDuty.COLLATERALCUSTOMERID).FirstOrDefault();
                        var stampCon = context.TBL_STAMP_DUTY_CONDITION.Where(s => s.COLLATERALSUBTYPEID == col.COLLATERALSUBTYPEID).FirstOrDefault();
                        var stampFeeId = context.TBL_CHARGE_FEE.Where(s => s.CHARGEFEENAME.ToLower().Contains("(fixed)") && s.DELETED == false).FirstOrDefault().CHARGEFEEID;
                        var stampFee = context.TBL_LOAN_APPLICATION_DETL_FEE.Where(f => f.LOANAPPLICATIONDETAILID == applicationdetail.LOANAPPLICATIONDETAILID && f.CHARGEFEEID == stampFeeId).FirstOrDefault()?.RECOMMENDED_FEERATEVALUE;
                        var stampDutyAmount = applicationdetail.APPROVEDAMOUNT * (stampCon.DUTIABLEVALUE / 100);
                        decimal bankShare = 0;
                        decimal customerShare = stampDutyAmount * (stampDuty.CUSTOMERPERCENTAGE / 100) + (decimal)stampFee;
                        if (stampDuty.COLLECTED == false)
                        {
                            if (stampDuty.ISSHARED)
                            {
                                bankShare = stampDutyAmount * (stampDuty.BANKPERCENTAGE / 100);
                                //customerShare = stampDutyAmount * (stampDuty.CUSTOMERPERCENTAGE / 100);

                                StampDutyPostingViewModel stampDutySharedModel = new StampDutyPostingViewModel()
                                {
                                    reference = application.APPLICATIONREFERENCENUMBER,
                                    appId = "FINTRAK",
                                    userId = "STAMPDUTY",
                                    currency = "NGN",
                                    branchCode = model.branchCode,
                                    tranCode = "LSD",
                                    custAccNumber = context.TBL_CHART_OF_ACCOUNT.Where(c => c.ACCOUNTNAME == "STAMP DUTY ON LOANS COLLECTION GL").FirstOrDefault().ACCOUNTCODE,
                                    custAccName = "STAMP DUTY ON LOANS COLLECTION GL",
                                    bankTillName = "STAMP DUTY PAYABLE",
                                    bankTillAccount = context.TBL_CHART_OF_ACCOUNT.Where(c => c.ACCOUNTNAME == "STAMP DUTY ON LOANS PAYABLE GL").FirstOrDefault().ACCOUNTCODE,//To be provided,
                                    amount = bankShare,
                                };

                                if (USE_THIRD_PARTY_INTEGRATION)
                                {
                                    apiResult = integration.PostStampDutyInputs(stampDutySharedModel);
                                }
                            }

                            StampDutyPostingViewModel stampDutyModel = new StampDutyPostingViewModel()
                            {
                                reference = application.APPLICATIONREFERENCENUMBER,
                                appId = "FINTRAK",
                                userId = "STAMPDUTY",
                                currency = "NGN",
                                branchCode = model.branchCode,
                                tranCode = "LSD",
                                custAccNumber = context.TBL_CASA.Where(c => c.CASAACCOUNTID == model.casaAccountId).FirstOrDefault().PRODUCTACCOUNTNUMBER,// entity.casaAccountNumber,
                                custAccName = context.TBL_CASA.Where(c => c.CASAACCOUNTID == model.casaAccountId).FirstOrDefault().PRODUCTACCOUNTNAME,//   entity.casaAccountDetails,
                                bankTillName = "STAMP DUTY PAYABLE",
                                bankTillAccount = context.TBL_CHART_OF_ACCOUNT.Where(c => c.ACCOUNTNAME == "STAMP DUTY ON LOANS PAYABLE GL").FirstOrDefault().ACCOUNTCODE,//To be provided,
                                amount = customerShare,
                            };
                            //var apiResult = new PostingResult();
                            if (USE_THIRD_PARTY_INTEGRATION)
                            {
                                apiResult = integration.PostStampDutyInputs(stampDutyModel);
                                stampDuty.COLLECTED = true;
                            }


                        }

                    }

                    context.SaveChanges();

                    trans.Commit();
                }

                if (dataCount > 0)
                    return loanReferenceNumber;
                else
                    return "";
            }
        }

        private string EditContingentLiability(LoanViewModel entity)
        {
            var application = context.TBL_LOAN_APPLICATION.Find(entity.loanApplicationId);
            var contingentLoanInput = entity.contingentLoanInput;

            if (application.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees)
            {
                if (PendingBondsAndGuaranteeJobRequest(entity.loanApplicationId))
                    throw new ConditionNotMetException("There are pending bonds and gaurantees that must be attended to");
            }

            var contingentFacility = context.TBL_LOAN_CONTINGENT.Find(entity.loanId);
            contingentFacility.EFFECTIVEDATE = contingentLoanInput.effectiveDate;
            contingentFacility.MATURITYDATE = contingentLoanInput.maturityDate;
            contingentFacility.CONTINGENTAMOUNT = contingentLoanInput.contingentAmount;

            var approvalModel = new ForwardViewModel
            {
                createdBy = entity.createdBy,
                companyId = entity.companyId,
                applicationId = entity.loanBookingRequestId,
                comment = "Please proceed. The loan booking setup has been modified.",
                amount = entity.principalAmount,
                operationId = (int)OperationsEnum.ContigentLoanBooking
            };
            LogApproval(approvalModel, (int)OperationsEnum.ContigentLoanBooking, false, (int)ApprovalStatusEnum.Processing);

            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.LoanBookingAdded,
                STAFFID = entity.createdBy,
                BRANCHID = (short)entity.userBranchId,
                DETAIL = $"Applied for loan with reference number: {contingentFacility.LOANREFERENCENUMBER}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = entity.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            context.TBL_AUDIT.Add(audit);

            try
            {
                context.SaveChanges();
                return contingentFacility.LOANREFERENCENUMBER;
            }
            catch (ConditionNotMetException ce) { throw new ConditionNotMetException(ce.Message); }

            catch (Exception ex) { throw new Exception(ex.Message); }
        }

        private string addContingentLiability(LoanViewModel entity)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var application = context.TBL_LOAN_APPLICATION.Find(entity.loanApplicationId);
            var contingentLoanInput = entity.contingentLoanInput;
            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(entity.loanBookingRequestId);
            var currentExchangeRate = financeTransaction.GetExchangeRate(DateTime.Now, (short)contingentLoanInput.currencyId, entity.companyId).sellingRate;
            var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            if (context.TBL_LOAN_CONTINGENT.Where(x => x.LOAN_BOOKING_REQUESTID == entity.loanBookingRequestId).Any())
            {
                throw new ConditionNotMetException("Contigent Liability already undergoing approval.");
            }

            loanBookingValidation(entity);

            var bgData = context.TBL_LOAN_APPLICATION_DETL_BG.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId);

            var isTenored = false;
            var isBankFormat = false;
            if (bgData.Any())
            {
                var bgRecord = bgData.FirstOrDefault();
                if (bgRecord.ISTENORED) isTenored = true;
                if (bgRecord.ISBANKFORMAT) isBankFormat = true;
            }

            if (application.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees)
            {
                entity.productClassId = (short)ProductClassEnum.BondAndGuarantees;
                //bool bAndGRequestSent = false;
                var applicationfacilities = context.TBL_LOAN_APPLICATION_DETAIL.Where(x => x.LOANAPPLICATIONID == entity.loanApplicationId);
                foreach (var item in applicationfacilities)
                {
                    PendingBondsAndGuaranteeJobRequest(item.LOANAPPLICATIONDETAILID);
                }

                //if(!bAndGRequestSent) throw new ConditionNotMetException("You have not sent any request to legal to validate this B&G.");
            }

            if (applicationDetail.ISLINEFACILITY == true)
            {
                entity.customerId = request.CUSTOMERID != null ? (int)request.CUSTOMERID : entity.customerId;
            }

            entity.casaAccountId2 = (entity.casaAccountId2 == 0 || entity.casaAccountId2 == null) ? entity.casaAccountId : entity.casaAccountId2;
            var loanReferenceNumber = GenerateLoanReferenceNumber(application.BRANCHID, entity.productId, (short)LoanSystemTypeEnum.ContingentLiability);



            var data = new TBL_LOAN_CONTINGENT
            {
                LOAN_BOOKING_REQUESTID = entity.loanBookingRequestId,
                CUSTOMERID = entity.customerId,
                PRODUCTID = request.PRODUCTID,
                CASAACCOUNTID = entity.casaAccountId,
                CASAACCOUNTID2 = entity.casaAccountId2,
                BRANCHID = application.BRANCHID, //entity.branchId,
                CURRENCYID = contingentLoanInput.currencyId,
                EXCHANGERATE = currentExchangeRate,
                LOANAPPLICATIONDETAILID = entity.loanApplicationDetailId,
                LOANREFERENCENUMBER = loanReferenceNumber,
                RELATED_LOAN_REFERENCE_NUMBER = loanReferenceNumber,
                SUBSECTORID = applicationDetail.SUBSECTORID,
                RELATIONSHIPOFFICERID = application.RELATIONSHIPOFFICERID,
                RELATIONSHIPMANAGERID = application.RELATIONSHIPMANAGERID,
                MISCODE = application.MISCODE,
                TEAMMISCODE = application.TEAMMISCODE,
                EFFECTIVEDATE = contingentLoanInput.effectiveDate,
                MATURITYDATE = contingentLoanInput.maturityDate,
                ISBANKFORMAT = isBankFormat,
                ISTENORED = isTenored,
                BOOKINGDATE = generalSetup.GetApplicationDate(),
                LEGALCONTINGENTCODE = entity.legalContingentCode,

                LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.ContingentLiability,
                CONTINGENTAMOUNT = contingentLoanInput.contingentAmount,
                APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,
                LOANSTATUSID = (int)LoanStatusEnum.Inactive,
                ISDISBURSED = false,
                OPERATIONID = entity.operationId = (int)OperationsEnum.ContigentLoanBooking,
                DISCHARGELETTER = false,
                COMPANYID = entity.companyId,
                CREATEDBY = entity.createdBy,
                DATETIMECREATED = DateTime.Now
            };

            //Audit Section ---------------------------
            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.LoanBookingAdded,
                STAFFID = entity.createdBy,
                BRANCHID = (short)entity.userBranchId,
                DETAIL = $"Applied for loan with reference number: {loanReferenceNumber}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = entity.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            //end of Audit section -------------------------------

            using (var trans = context.Database.BeginTransaction())
            {
                // ............. Checking customer balance, and fee override ......
                // confirmCustomerAccountFunded(entity.loanChargeFee, entity.casaAccountId, entity.companyId, entity.customerId, loanReferenceNumber);
                entity.feeOverride = true;

                //...................Adding Contingent Loan Record.........................
                var loan = context.TBL_LOAN_CONTINGENT.Add(data);

                //...................Update the Loan Request and loan application table.......................
                request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
                request.ISUSED = true;

                application.APPLICATIONSTATUSID = (short)LoanApplicationStatusEnum.LoanBookingInProgress;
                //...................Adding Audit...............................
                context.TBL_AUDIT.Add(audit);

                //........Save Changes...............
                var dataCount = context.SaveChanges();

                var approvalModel = new ForwardViewModel
                {
                    createdBy = entity.createdBy,
                    companyId = entity.companyId,
                    applicationId = entity.loanBookingRequestId,
                    comment = "Please approve this Loan",
                    amount = contingentLoanInput.approvedAmount,
                    operationId = (int)OperationsEnum.ContigentLoanBooking
                };

                if (LogApproval(approvalModel, (int)OperationsEnum.ContigentLoanBooking, false, (int)ApprovalStatusEnum.Processing))
                {
                    //............save Loan Covenant..........
                    AddLoanCovenant(entity, loan.CONTINGENTLOANID, (short)LoanSystemTypeEnum.ContingentLiability);
                    //............save Loan Fees..........
                    AddLoanFees(entity.loanChargeFee, loan.CONTINGENTLOANID, (short)LoanSystemTypeEnum.ContingentLiability, entity, applicationDetail);
                    //AddDeferredFees(entity.loanChargeFee, (short)LoanSystemTypeEnum.ContingentLiability, entity, applicationDetail);
                    entity.loanReferenceNumber = loanReferenceNumber;

                    //...................Saving Loan Collaterals Mapping.......................
                    AddLoanCollateralMapping(entity.loanApplicationId, loan.CONTINGENTLOANID, (short)LoanSystemTypeEnum.ContingentLiability);

                    //...................Mapping Loan Monitoring Trigger.......................
                    AddLoanMonitoringTrigger(entity.loanApplicationDetailId, entity.createdBy, loan.CONTINGENTLOANID, (short)LoanSystemTypeEnum.ContingentLiability);
                    //if (entity.monitoringTriggers.Count > 0)
                    //    AddLoanMonitoringTrigger(entity.monitoringTriggers, loan.CONTINGENTLOANID, (short)LoanSystemTypeEnum.ContingentLiability);

                    context.SaveChanges();
                    if (entity.feeOverride && application.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees)
                    {
                        entity.isSuspenseCredit = true;
                        var feeRecord = context.TBL_LOAN_FEE.Where(x => x.SOURCELOANID == loan.CONTINGENTLOANID
                        && x.SOURCELOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.ContingentLiability
                        && x.ISPOSTED == false).ToList();

                        List<LoanChargeFeeViewModel> loanChargeFeeList = new List<LoanChargeFeeViewModel>();
                        foreach (var fee in feeRecord)
                        {
                            var loanfee = new LoanChargeFeeViewModel
                            {
                                loanChargeFeeId = fee.LOANCHARGEFEEID,
                                chargeFeeId = fee.CHARGEFEEID,
                                loanId = fee.LOANID,
                                loanSystemTypeId = fee.LOANSYSTEMTYPEID,
                                feeRateValue = fee.FEERATEVALUE,
                                feeDependentAmount = fee.FEERATEVALUE,
                                feeAmount = fee.FEEAMOUNT,
                                isIntegralFee = fee.ISINTEGRALFEE,
                                recurring = fee.ISRECURRING,
                            };
                            loanChargeFeeList.Add(loanfee);
                        };

                        entity.loanChargeFee = loanChargeFeeList;
                        PostBandGFacilityFees(entity);
                    }

                    var staffCode = context.TBL_STAFF.Find(entity.createdBy).STAFFCODE;
                    //CreateFacilityOnThirdParty(loan.PRODUCTID, loan.LOANAPPLICATIONDETAILID, loan.CASAACCOUNTID, loan.EFFECTIVEDATE, loan.MATURITYDATE, loan.LOANSYSTEMTYPEID, staffCode, staffCode);



                    context.SaveChanges();

                    //.....Commit transaction ............
                    trans.Commit();
                }
                //.......................END OF APPROVAL LOG......................................................

                if (dataCount > 0) { return loanReferenceNumber; }

                else { return ""; }

            }
        }

        private string EditTermLoan(LoanViewModel entity)
        {
            var application = context.TBL_LOAN_APPLICATION.Find(entity.loanApplicationId);
            var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            var systemDate = generalSetup.GetApplicationDate();

            entity.effectiveDate = entity.loanScheduleInput.effectiveDate;
            entity.maturityDate = entity.loanScheduleInput.maturityDate;

            loanBookingValidation(entity);
            var principalAmount = from a in context.TBL_LOAN
                                  where a.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId
                                  let sumPrincipalAmount = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).Sum(x => x.PRINCIPALAMOUNT)
                                  select sumPrincipalAmount;

            var interestRate = Convert.ToDouble(applicationDetail.APPROVEDINTERESTRATE);
            var priceIndex = new TBL_PRODUCT_PRICE_INDEX();
            if (entity.productPriceIndexId > 0)
            {
                priceIndex = (from a in context.TBL_PRODUCT_PRICE_INDEX where a.PRODUCTPRICEINDEXID == entity.productPriceIndexId select a).FirstOrDefault();
                if (priceIndex != null)
                {
                    interestRate = priceIndex.PRICEINDEXRATE + interestRate;
                }
            }

            var currentExchangeRate = financeTransaction.GetExchangeRate(DateTime.Now, (short)entity.currencyId, entity.companyId).sellingRate;

            var loanReferenceNumber = GenerateLoanReferenceNumber(application.BRANCHID, entity.productId, (short)LoanSystemTypeEnum.TermDisbursedFacility);

            var approvedAmount = context.TBL_LOAN_APPLICATION_DETAIL.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).FirstOrDefault().APPROVEDAMOUNT;

            var totalPreviouslyBookedAmount = principalAmount.FirstOrDefault();

            var totalPrincipalAmount = (decimal)(totalPreviouslyBookedAmount + (decimal)entity.loanScheduleInput.principalAmount);

            //if (totalPrincipalAmount > (decimal)approvedAmount)
            //    throw new ConditionNotMetException("The loan amount cannot be greater than the availiable amount");

            if (entity.loanScheduleInput.scheduleMethodId == (short)LoanScheduleTypeEnum.BulletPayment)
            {
                entity.loanScheduleInput.principalFrequency = null;
                entity.loanScheduleInput.interestFrequency = null;
            }

            entity.casaAccountId2 = entity.casaAccountId2 != 0 ? entity.casaAccountId2 : null;

            var loanData = context.TBL_LOAN.Find(entity.loanId);
            loanData.CASAACCOUNTID = entity.casaAccountId;
            loanData.CASAACCOUNTID2 = entity.casaAccountId2;
            loanData.SCHEDULETYPEID = entity.loanScheduleInput.scheduleMethodId;
            loanData.EXCHANGERATE = currentExchangeRate;
            loanData.SCHEDULEDPREPAYMENTAMOUNT = entity.scheduledPrepaymentAmount;
            loanData.PRINCIPALFREQUENCYTYPEID = entity.loanScheduleInput.principalFrequency;
            loanData.INTERESTFREQUENCYTYPEID = entity.loanScheduleInput.interestFrequency;
            loanData.OUTSTANDINGPRINCIPAL = Convert.ToDecimal(entity.loanScheduleInput.principalAmount);
            loanData.PRINCIPALAMOUNT = Convert.ToDecimal(entity.loanScheduleInput.principalAmount);
            loanData.EFFECTIVEDATE = entity.loanScheduleInput.effectiveDate;
            loanData.MATURITYDATE = entity.loanScheduleInput.maturityDate;
            loanData.LASTRESTRUCTUREDATE = entity.loanScheduleInput.effectiveDate;
            loanData.FIRSTPRINCIPALPAYMENTDATE = entity.loanScheduleInput.principalFirstpaymentDate;
            loanData.FIRSTINTERESTPAYMENTDATE = entity.loanScheduleInput.interestFirstpaymentDate;
            loanData.SCHEDULEDAYCOUNTCONVENTIONID = entity.loanScheduleInput.accrualBasis;

            if (entity.loanScheduleInput.scheduleMethodId == (short)LoanScheduleTypeEnum.IrregularSchedule)
            {
                var irregularSchedule = context.TBL_LOAN_SCHEDULE_IREGUL_INPUT.Where(x => x.LOANID == entity.loanId);
                foreach (var item in irregularSchedule)
                {
                    context.TBL_LOAN_SCHEDULE_IREGUL_INPUT.Remove(item);
                }

                foreach (var irregular in entity.loanScheduleInput.irregularPaymentSchedule)
                {
                    var irregularRecordData = new TBL_LOAN_SCHEDULE_IREGUL_INPUT
                    {
                        LOANID = loanData.TERMLOANID,
                        PAYMENTAMOUNT = (decimal)irregular.paymentAmount,
                        PAYMENTDATE = irregular.paymentDate,
                        CREATEDBY = entity.createdBy,
                        DATETIMECREATED = DateTime.Now,
                    };
                    context.TBL_LOAN_SCHEDULE_IREGUL_INPUT.Add(irregularRecordData);
                }
            }

            var company = context.TBL_COMPANY.Find(entity.companyId);
            if (entity.currencyId != company.CURRENCYID && application.PRODUCTCLASSID != (short)ProductClassEnum.InvoiceDiscountingFacility)
            {
                var nostroAccount = context.TBL_CUSTOM_CHART_OF_ACCOUNT.Find(entity.casaAccountId2);
                var nostroAccountNumber = nostroAccount.ACCOUNTID;
                var nostroCurrencyId = context.TBL_CURRENCY.FirstOrDefault(c => c.CURRENCYCODE == nostroAccount.CURRENCYCODE).CURRENCYID;

                loanData.CASAACCOUNTID2 = null;
                loanData.NOSTROACCOUNTID = nostroAccountNumber;
                loanData.NOSTRORATECODEID = entity.nostroRateCodeId;
                loanData.NOSTRORATEAMOUNT = entity.nostroRateAmount;
                loanData.NOSTROCURRENCYID = nostroCurrencyId;
            }

            var approvalModel = new ForwardViewModel
            {
                createdBy = entity.createdBy,
                companyId = entity.companyId,
                applicationId = entity.loanBookingRequestId,
                comment = "Please proceed. The loan booking setup has been modified.",
                amount = entity.principalAmount,
                operationId = (int)OperationsEnum.TermLoanBooking
            };
            LogApproval(approvalModel, (int)OperationsEnum.TermLoanBooking, false, (int)ApprovalStatusEnum.Processing);

            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.LoanBookingAdded,
                STAFFID = entity.createdBy,
                BRANCHID = (short)entity.userBranchId,
                DETAIL = $"Editted loan booking with loan account number: {loanReferenceNumber}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = entity.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            context.TBL_AUDIT.Add(audit);

            try
            {
                context.SaveChanges();
                return loanData.LOANREFERENCENUMBER;
            }
            catch (ConditionNotMetException ce) { throw new ConditionNotMetException(ce.Message); }

            catch (Exception ex) { throw new SecureException(ex.Message); }
        }

        private string AddTermLoan(LoanViewModel entity)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var application = context.TBL_LOAN_APPLICATION.Find(entity.loanApplicationId);
            var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == entity.companyId).Select(x => x).FirstOrDefault().CURRENCYID;

            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(entity.loanBookingRequestId);
            var company = context.TBL_COMPANY.Find(entity.companyId);

            entity.effectiveDate = entity.loanScheduleInput.effectiveDate;
            entity.maturityDate = entity.loanScheduleInput.maturityDate;

            var maximumMaturityDate = entity.effectiveDate.AddDays(applicationDetail.APPROVEDTENOR);
            if (entity.maturityDate.Date > maximumMaturityDate.Date) { throw new ConditionNotMetException("You can not exceed the maximum maturity date"); }

            loanBookingValidation(entity);
            var principalAmount = from a in context.TBL_LOAN
                                  where a.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId
                                  //let sumPrincipalAmount = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).Sum(x => x.PRINCIPALAMOUNT)
                                  select a.PRINCIPALAMOUNT;

            //var productCurrencyIndex = context.TBL_PRODUCT_PRICE_INDEX_CURNCY.Where(x => x.CURRENCYID == applicationDetail.CURRENCYID).FirstOrDefault();
            //var priceIndex = (from a in context.TBL_PRODUCT_PRICE_INDEX where a.PRODUCTPRICEINDEXID == productCurrencyIndex.PRODUCTPRICEINDEXID select a).FirstOrDefault();
            //if(entity.productPriceIndexId == null)
            //{

            //}
            var interestRate = Convert.ToDouble(applicationDetail.APPROVEDINTERESTRATE);
            var priceIndex = new TBL_PRODUCT_PRICE_INDEX();
            if (entity.productPriceIndexId > 0)
            {
                priceIndex = (from a in context.TBL_PRODUCT_PRICE_INDEX where a.PRODUCTPRICEINDEXID == entity.productPriceIndexId select a).FirstOrDefault();
                if (priceIndex != null)
                {
                    interestRate = priceIndex.PRICEINDEXRATE + interestRate;
                }
            }

            var currentExchangeRate = financeTransaction.GetExchangeRate(DateTime.Now, (short)entity.currencyId, entity.companyId).sellingRate;

            var loanReferenceNumber = GenerateLoanReferenceNumber(application.BRANCHID, entity.productId, (short)LoanSystemTypeEnum.TermDisbursedFacility);

            var approvedAmount = context.TBL_LOAN_APPLICATION_DETAIL.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).FirstOrDefault().APPROVEDAMOUNT;

            var totalPreviouslyBookedAmount = principalAmount.FirstOrDefault();

            var totalPrincipalAmount = (decimal)(totalPreviouslyBookedAmount + (decimal)entity.loanScheduleInput.principalAmount);

            decimal lineReleasePrincipalAmount = 0;

            if (applicationDetail.ISLINEFACILITY == true)
            {
                var lineFacilities = context.TBL_LOAN.Where(a => a.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).ToList();
                lineReleasePrincipalAmount = lineFacilities.Count() > 0 ? lineFacilities.Sum(x => x.PRINCIPALAMOUNT) : 0;
            }

            //if ((totalPrincipalAmount - (decimal)lineReleasePrincipalAmount) > (decimal)approvedAmount)
            if ((totalPrincipalAmount) > (decimal)approvedAmount)
                throw new ConditionNotMetException("The loan amount cannot be greater than the availiable amount");

            if (entity.loanScheduleInput.scheduleMethodId == (short)LoanScheduleTypeEnum.BulletPayment)
            {
                entity.loanScheduleInput.principalFrequency = null;
                entity.loanScheduleInput.interestFrequency = null;
            }

            if (applicationDetail.ISLINEFACILITY == true)
            {
                entity.customerId = request.CUSTOMERID != null ? (int)request.CUSTOMERID : entity.customerId;
            }

            entity.casaAccountId2 = (entity.casaAccountId2 == 0 || entity.casaAccountId2 == null) ? entity.casaAccountId : entity.casaAccountId2;
            //var repricingIndexId = entity.loanScheduleInput.repricingModeId != 0 ? entity.loanScheduleInput.repricingModeId :  null;
            //var repricingIndexDuration = entity.loanScheduleInput.repricingDuration != 0 ? entity.loanScheduleInput.repricingDuration : null;
            DateTime defaultDate = new DateTime(1753, 1, 1);

            var data = new TBL_LOAN
            {
                LOAN_BOOKING_REQUESTID = entity.loanBookingRequestId,
                LOANAPPLICATIONDETAILID = entity.loanApplicationDetailId,
                LOANREFERENCENUMBER = loanReferenceNumber,
                RELATED_LOAN_REFERENCE_NUMBER = loanReferenceNumber,
                LOANSTATUSID = (short)LoanStatusEnum.Inactive,
                ISDISBURSED = false,
                PRINCIPALNUMBEROFINSTALLMENT = 0,
                INTERESTNUMBEROFINSTALLMENT = 0,
                SCHEDULEDPREPAYMENTAMOUNT = entity.scheduledPrepaymentAmount,
                SCH_PREPAYMENT_FREQUENCY_TYPID = null,

                SUBSECTORID = entity.subSectorId,
                CURRENCYID = (short)entity.currencyId,
                EXCHANGERATE = currentExchangeRate,

                DISCHARGELETTER = false,
                SUSPENDINTEREST = false,

                CUSTOMERID = entity.customerId,
                PRODUCTID = request.PRODUCTID,
                COMPANYID = entity.companyId,
                CASAACCOUNTID = entity.casaAccountId,
                CASAACCOUNTID2 = entity.casaAccountId2,
                BRANCHID = application.BRANCHID,
                SHOULD_DISBURSE = entity.loanScheduleInput.shouldDisburse,

                PRINCIPALFREQUENCYTYPEID = entity.loanScheduleInput.principalFrequency,
                INTERESTFREQUENCYTYPEID = entity.loanScheduleInput.interestFrequency,

                RELATIONSHIPOFFICERID = application.RELATIONSHIPOFFICERID,
                RELATIONSHIPMANAGERID = application.RELATIONSHIPMANAGERID,
                MISCODE = application.MISCODE,
                TEAMMISCODE = application.TEAMMISCODE,
                INTERESTRATE = interestRate,

                PRINCIPALINSTALLMENTLEFT = 0,
                INTERESTINSTALLMENTLEFT = 0,

                SCHEDULETYPEID = entity.loanScheduleInput.scheduleMethodId,

                PRINCIPALAMOUNT = Convert.ToDecimal(entity.loanScheduleInput.principalAmount),

                OPERATIONID = entity.operationId = (int)OperationsEnum.TermLoanBooking,
                LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                EQUITYCONTRIBUTION = 0,
                OUTSTANDINGPRINCIPAL = Convert.ToDecimal(entity.loanScheduleInput.principalAmount),
                PRINCIPALADDITIONCOUNT = 0,
                PRINCIPALREDUCTIONCOUNT = 0,
                FIXEDPRINCIPAL = false,
                PROFILELOAN = false,

                APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,

                BOOKINGDATE = generalSetup.GetApplicationDate(),
                CREATEDBY = entity.createdBy,
                DATETIMECREATED = DateTime.Now,
                EFFECTIVEDATE = entity.loanScheduleInput.effectiveDate,
                MATURITYDATE = entity.loanScheduleInput.maturityDate,
                LASTRESTRUCTUREDATE = entity.loanScheduleInput.effectiveDate,
                FIRSTPRINCIPALPAYMENTDATE = entity.loanScheduleInput.principalFirstpaymentDate < defaultDate ? defaultDate : entity.loanScheduleInput.principalFirstpaymentDate,
                FIRSTINTERESTPAYMENTDATE = entity.loanScheduleInput.interestFirstpaymentDate < defaultDate ? defaultDate : entity.loanScheduleInput.interestFirstpaymentDate,
                ALLOWFORCEDEBITREPAYMENT = false,
                SCHEDULEDAYCOUNTCONVENTIONID = entity.loanScheduleInput.accrualBasis,
                USER_PRUDENTIAL_GUIDE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                EXT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                INT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                //CRMSREPAYMENTAGREEMENTID = entity.crmsRepaymentAgreementTypeId,
                REPRICINGMODEID = entity.loanScheduleInput.repricingModeId != 0 ? entity.loanScheduleInput.repricingModeId : null,
                REPRICINGDURATION = entity.loanScheduleInput.repricingDuration != 0 ? entity.loanScheduleInput.repricingDuration : null,

            };
            if (priceIndex.PRODUCTPRICEINDEXID > 0)
            {
                data.PRODUCTPRICEINDEXID = priceIndex.PRODUCTPRICEINDEXID;
                data.PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE > 0 ? priceIndex.PRICEINDEXRATE : 0;
            }

            //FOREIGN LOANS 'NOSTRO - INTEREST-CAP-ACCOUNT' BEHAVIOUR
            //if (entity.currencyId != company.CURRENCYID && application.PRODUCTCLASSID != (short)ProductClassEnum.InvoiceDiscountingFacility)
            //{
            //    var nostroAccount = context.TBL_CUSTOM_CHART_OF_ACCOUNT.Find(entity.casaAccountId2);
            //    var nostroAccountNumber = nostroAccount.ACCOUNTID;
            //    var nostroCurrencyId = context.TBL_CURRENCY.FirstOrDefault(c => c.CURRENCYCODE == nostroAccount.CURRENCYCODE).CURRENCYID;

            //    data.CASAACCOUNTID2 = applicationDetail.CASAACCOUNTID;
            //    data.NOSTROACCOUNTID = nostroAccountNumber;
            //    data.NOSTRORATECODEID = entity.nostroRateCodeId;
            //    data.NOSTRORATEAMOUNT = entity.nostroRateAmount;
            //    data.NOSTROCURRENCYID = nostroCurrencyId;
            //}


            ////Audit Section ---------------------------
            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.LoanBookingAdded,
                STAFFID = entity.createdBy,
                BRANCHID = (short)entity.userBranchId,
                DETAIL = $"Applied for loan with reference number: {loanReferenceNumber}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = entity.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            ////end of Audit section -------------------------------

            using (var trans = context.Database.BeginTransaction())
            {
                //confirmCustomerAccountFunded(entity.loanChargeFee, entity.casaAccountId, entity.companyId, entity.customerId, loanReferenceNumber);
                entity.feeOverride = true;

                var loan = context.TBL_LOAN.Add(data);

                request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
                request.ISUSED = true;
                application.APPLICATIONSTATUSID = (short)LoanApplicationStatusEnum.LoanBookingInProgress;
                
                    var dataCount = context.SaveChanges();

                    if (dataCount > 0)
                    {
                        var approvalModel = new ForwardViewModel
                        {
                            createdBy = entity.createdBy,
                            companyId = entity.companyId,
                            applicationId = entity.loanBookingRequestId,
                            comment = "Please approve this Loan",
                            amount = entity.principalAmount,
                            operationId = (short)OperationsEnum.TermLoanBooking,
                        };

                        if (LogApproval(approvalModel, (int)OperationsEnum.TermLoanBooking, false, (int)ApprovalStatusEnum.Processing))
                        {
                            if (entity.loanScheduleInput.scheduleMethodId == (short)LoanScheduleTypeEnum.IrregularSchedule)
                            {
                                foreach (var irregular in entity.loanScheduleInput.irregularPaymentSchedule)
                                {
                                    var irregularRecordData = new TBL_LOAN_SCHEDULE_IREGUL_INPUT
                                    {
                                        LOANID = loan.TERMLOANID,
                                        PAYMENTAMOUNT = (decimal)irregular.paymentAmount,
                                        PAYMENTDATE = irregular.paymentDate,
                                        CREATEDBY = entity.createdBy,
                                        DATETIMECREATED = DateTime.Now,
                                    };
                                    context.TBL_LOAN_SCHEDULE_IREGUL_INPUT.Add(irregularRecordData);
                                }
                            }

                            AddLoanCovenant(entity, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility);

                            AddLoanFees(entity.loanChargeFee, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility, entity, applicationDetail);
                            //AddDeferredFees(entity.loanChargeFee, (short)LoanSystemTypeEnum.TermDisbursedFacility, entity, applicationDetail);
                            AddLoanCollateralMapping(entity.loanApplicationId, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility);

                            AddLoanMonitoringTrigger(entity.loanApplicationDetailId, entity.createdBy, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility);

                            entity.loanReferenceNumber = loan.LOANREFERENCENUMBER;

                            var staffCode = context.TBL_STAFF.Find(entity.createdBy).STAFFCODE;
                            // CreateFacilityOnThirdParty(loan.PRODUCTID, loan.LOANAPPLICATIONDETAILID, loan.CASAACCOUNTID, loan.EFFECTIVEDATE, loan.MATURITYDATE, (short) LoanSystemTypeEnum.TermDisbursedFacility, staffCode, staffCode);

                            //if (!entity.feeOverride) PostLoanFees(entity);
                            context.SaveChanges();

                        if (applicationDetail.STAMPDUTYAPPLICABLE)
                        {
                            var apiResult = new PostingResult();
                            var stampDuty = context.TBL_FACILITY_STAMP_DUTY.Where(f => f.LOANAPPLICATIONDETAILID == applicationDetail.LOANAPPLICATIONDETAILID && f.DELETED == false).FirstOrDefault();
                            var appCol = context.TBL_LOAN_APPLICATION_COLLATERL.Where(c => c.LOANAPPLICATIONDETAILID == stampDuty.LOANAPPLICATIONDETAILID && c.DELETED == false).FirstOrDefault();
                            var col = context.TBL_COLLATERAL_CUSTOMER.Where(co => co.COLLATERALCUSTOMERID == stampDuty.COLLATERALCUSTOMERID).FirstOrDefault();
                            var stampCon = context.TBL_STAMP_DUTY_CONDITION.Where(s => s.COLLATERALSUBTYPEID == col.COLLATERALSUBTYPEID).FirstOrDefault();
                            var stampFeeId = context.TBL_CHARGE_FEE.Where(s => s.CHARGEFEENAME.ToLower().Contains("(fixed)") && s.DELETED == false).FirstOrDefault().CHARGEFEEID;
                            var stampFee = context.TBL_LOAN_APPLICATION_DETL_FEE.Where(f => f.LOANAPPLICATIONDETAILID == applicationDetail.LOANAPPLICATIONDETAILID && f.CHARGEFEEID == stampFeeId).FirstOrDefault()?.RECOMMENDED_FEERATEVALUE;
                            var stampDutyAmount = applicationDetail.APPROVEDAMOUNT * (stampCon.DUTIABLEVALUE / 100);
                            decimal bankShare = 0;
                            decimal customerShare = stampDutyAmount * (stampDuty.CUSTOMERPERCENTAGE / 100) + (decimal)stampFee;
                            if(stampDuty.COLLECTED == false)
                            {
                                if (stampDuty.ISSHARED)
                                {
                                    bankShare = stampDutyAmount * (stampDuty.BANKPERCENTAGE / 100);
                                    //customerShare = stampDutyAmount * (stampDuty.CUSTOMERPERCENTAGE / 100);

                                    StampDutyPostingViewModel stampDutySharedModel = new StampDutyPostingViewModel()
                                    {
                                        reference = application.APPLICATIONREFERENCENUMBER,
                                        appId = "FINTRAK",
                                        userId = "STAMPDUTY",
                                        currency = "NGN",
                                        branchCode = entity.branchCode,
                                        tranCode = "LSD",
                                        custAccNumber = context.TBL_CHART_OF_ACCOUNT.Where(c => c.ACCOUNTNAME == "STAMP DUTY ON LOANS COLLECTION GL").FirstOrDefault().ACCOUNTCODE,
                                        custAccName = "STAMP DUTY ON LOANS COLLECTION GL",
                                        bankTillName = "STAMP DUTY PAYABLE",
                                        bankTillAccount = context.TBL_CHART_OF_ACCOUNT.Where(c => c.ACCOUNTNAME == "STAMP DUTY ON LOANS PAYABLE GL").FirstOrDefault().ACCOUNTCODE,//To be provided,
                                        amount = bankShare,
                                    };

                                    if (USE_THIRD_PARTY_INTEGRATION)
                                    {
                                        apiResult = integration.PostStampDutyInputs(stampDutySharedModel);
                                    }
                                }

                                StampDutyPostingViewModel stampDutyModel = new StampDutyPostingViewModel()
                                {
                                    reference = application.APPLICATIONREFERENCENUMBER,
                                    appId = "FINTRAK",
                                    userId = "STAMPDUTY",
                                    currency = "NGN",
                                    branchCode = entity.branchCode,
                                    tranCode = "LSD",
                                    custAccNumber = context.TBL_CASA.Where(c => c.CASAACCOUNTID == entity.casaAccountId).FirstOrDefault().PRODUCTACCOUNTNUMBER,// entity.casaAccountNumber,
                                    custAccName = context.TBL_CASA.Where(c => c.CASAACCOUNTID == entity.casaAccountId).FirstOrDefault().PRODUCTACCOUNTNAME,//   entity.casaAccountDetails,
                                    bankTillName = "STAMP DUTY PAYABLE",
                                    bankTillAccount = context.TBL_CHART_OF_ACCOUNT.Where(c => c.ACCOUNTNAME == "STAMP DUTY ON LOANS PAYABLE GL").FirstOrDefault().ACCOUNTCODE,//To be provided,
                                    amount = customerShare,
                                };
                                //var apiResult = new PostingResult();
                                if (USE_THIRD_PARTY_INTEGRATION)
                                {
                                    apiResult = integration.PostStampDutyInputs(stampDutyModel);
                                    stampDuty.COLLECTED = true;
                                }


                            }

                        }

                            trans.Commit();
                        }

                        return loanReferenceNumber;
                    }
                    else
                    {
                        return "";
                    }
                
            }
        }


        private string EditCommercialLoan(LoanViewModel entity)
        {
            var application = context.TBL_LOAN_APPLICATION.Find(entity.loanApplicationId);
            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(entity.loanBookingRequestId);
            var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            var systemDate = generalSetup.GetApplicationDate();


            loanBookingValidation(entity);

            var principalAmount = from a in context.TBL_LOAN
                                  where a.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId
                                  let sumPrincipalAmount = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).Sum(x => x.PRINCIPALAMOUNT)
                                  select sumPrincipalAmount;

            double? priceIndex = (from a in context.TBL_PRODUCT where a.PRODUCTID == entity.productId select a.TBL_PRODUCT_PRICE_INDEX.PRICEINDEXRATE).FirstOrDefault();



            var approvedAmount = applicationDetail.APPROVEDAMOUNT;
            var totalPreviouslyBookedAmount = principalAmount.FirstOrDefault();
            var totalPrincipalAmount = (decimal)(totalPreviouslyBookedAmount + (decimal)entity.principalAmount);

            var loanData = context.TBL_LOAN.Find(entity.loanId);
            loanData.CASAACCOUNTID = entity.casaAccountId;
            loanData.CASAACCOUNTID2 = entity.casaAccountId2;
            loanData.SCHEDULETYPEID = (short)LoanScheduleTypeEnum.BulletPayment;
            loanData.SCHEDULEDAYCOUNTCONVENTIONID = (short)DayCountConventionEnum.Actual_Actual;
            loanData.SCHEDULEDPREPAYMENTAMOUNT = entity.scheduledPrepaymentAmount;
            loanData.PRINCIPALAMOUNT = Convert.ToDecimal(entity.loanPrincipal);
            loanData.OUTSTANDINGPRINCIPAL = Convert.ToDecimal(entity.loanPrincipal);
            loanData.EFFECTIVEDATE = entity.effectiveDate;
            loanData.MATURITYDATE = entity.maturityDate;
            loanData.INTERESTRATE = Convert.ToInt32(applicationDetail.APPROVEDINTERESTRATE);

            var approvalModel = new ForwardViewModel
            {
                createdBy = entity.createdBy,
                companyId = entity.companyId,
                applicationId = entity.loanBookingRequestId,
                comment = "Please proceed. The loan booking setup has been modified.",
                amount = entity.principalAmount,
                operationId = (int)OperationsEnum.CommercialLoanBooking
            };
            LogApproval(approvalModel, (int)OperationsEnum.CommercialLoanBooking, false, (int)ApprovalStatusEnum.Processing);

            //Audit Section ---------------------------
            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.AddCommercialLoanBooking,
                STAFFID = entity.createdBy,
                BRANCHID = (short)entity.userBranchId,
                DETAIL = $"Editted loan booking with loan account number: {loanData.LOANREFERENCENUMBER}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = entity.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            context.TBL_AUDIT.Add(audit);
            //end of Audit section -------------------------------

            try
            {
                context.SaveChanges();
                return loanData.LOANREFERENCENUMBER;
            }
            catch (ConditionNotMetException ce) { throw new ConditionNotMetException(ce.Message); }

            catch (Exception ex) { throw new Exception(ex.Message); }
        }

        private string AddCommercialLoan(LoanViewModel entity)
        {
            var application = context.TBL_LOAN_APPLICATION.Find(entity.loanApplicationId);
            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(entity.loanBookingRequestId);
            var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            var systemDate = generalSetup.GetApplicationDate();


            loanBookingValidation(entity);

            var loans = context.TBL_LOAN.Where(x => x.LOANSTATUSID == (short)LoanStatusEnum.Active && x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).OrderByDescending(l => l.TERMLOANID);


            var principalAmount = from a in context.TBL_LOAN
                                  where a.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId
                                  let sumPrincipalAmount = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).Sum(x => x.PRINCIPALAMOUNT)
                                  select sumPrincipalAmount;

            // double? priceIndex = (from a in context.TBL_PRODUCT where a.PRODUCTID == entity.productId select a.TBL_PRODUCT_PRICE_INDEX.PRICEINDEXRATE).FirstOrDefault();

            //var priceIndex = (from a in context.TBL_PRODUCT_PRICE_INDEX where a.PRODUCTPRICEINDEXID == applicationDetail.PRODUCTPRICEINDEXID select a).FirstOrDefault();

            //var interestRate = Convert.ToDouble(entity.interestRate);
            //if (priceIndex != null)
            //{
            //    interestRate = priceIndex.PRICEINDEXRATE + interestRate;
            //}
            var interestRate = Convert.ToDouble(applicationDetail.APPROVEDINTERESTRATE);
            var priceIndex = new TBL_PRODUCT_PRICE_INDEX();
            if (entity.productPriceIndexId > 0)
            {
                priceIndex = (from a in context.TBL_PRODUCT_PRICE_INDEX where a.PRODUCTPRICEINDEXID == entity.productPriceIndexId select a).FirstOrDefault();
                if (priceIndex != null)
                {
                    interestRate = priceIndex.PRICEINDEXRATE + interestRate;
                }
            }

            var currentExchangeRate = financeTransaction.GetExchangeRate(DateTime.Now, (short)entity.currencyId, entity.companyId).sellingRate;

            var loanReferenceNumber = GenerateLoanReferenceNumber(application.BRANCHID, entity.productId, (short)LoanSystemTypeEnum.TermDisbursedFacility);

            var approvedAmount = applicationDetail.APPROVEDAMOUNT;

            var totalPreviouslyBookedAmount = principalAmount.FirstOrDefault();

            var totalPrincipalAmount = (decimal)(totalPreviouslyBookedAmount + (decimal)entity.principalAmount);

            decimal lineReleasePrincipalAmount = 0;

            if (applicationDetail.ISLINEFACILITY == true)
            {
                var lineFacilities = context.TBL_LOAN.Where(a => a.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).ToList();
                lineReleasePrincipalAmount = lineFacilities.Count() > 0 ? lineFacilities.Sum(x => x.PRINCIPALAMOUNT) : 0;
            }

            if ((totalPrincipalAmount - (decimal)lineReleasePrincipalAmount) > (decimal)approvedAmount)
                throw new ConditionNotMetException("The loan amount cannot be greater than the available amount");

            var data = new TBL_LOAN
            {
                LOAN_BOOKING_REQUESTID = entity.loanBookingRequestId,
                LOANAPPLICATIONDETAILID = entity.loanApplicationDetailId,
                OPERATIONID = entity.operationId = (int)OperationsEnum.CommercialLoanBooking,
                LOANREFERENCENUMBER = loanReferenceNumber,
                LOANSTATUSID = (short)LoanStatusEnum.Inactive,
                SHOULD_DISBURSE = true,
                ISDISBURSED = false,
                PRINCIPALNUMBEROFINSTALLMENT = 1,
                INTERESTNUMBEROFINSTALLMENT = 1,
                SCH_PREPAYMENT_FREQUENCY_TYPID = null,
                //PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE,
                //PRODUCTPRICEINDEXID = priceIndex.PRODUCTPRICEINDEXID,
                //PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE > 0 ? priceIndex.PRICEINDEXRATE : 0,
                //PRODUCTPRICEINDEXID = priceIndex.PRODUCTPRICEINDEXID,
                SUBSECTORID = applicationDetail.SUBSECTORID,
                CURRENCYID = (short)applicationDetail.CURRENCYID,
                EXCHANGERATE = currentExchangeRate,
                DISCHARGELETTER = false,
                SUSPENDINTEREST = false,
                CUSTOMERID = entity.customerId,
                PRODUCTID = request.PRODUCTID,
                COMPANYID = entity.companyId,
                CASAACCOUNTID = entity.casaAccountId,
                CASAACCOUNTID2 = (entity.casaAccountId2 == 0 || entity.casaAccountId2 == null) ? entity.casaAccountId : entity.casaAccountId2,
                BRANCHID = application.BRANCHID, //entity.branchId,
                LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                RELATIONSHIPOFFICERID = application.RELATIONSHIPOFFICERID,
                RELATIONSHIPMANAGERID = application.RELATIONSHIPMANAGERID,
                MISCODE = application.MISCODE,
                TEAMMISCODE = application.TEAMMISCODE,
                INTERESTRATE = Convert.ToInt32(applicationDetail.APPROVEDINTERESTRATE),
                ALLOWFORCEDEBITREPAYMENT = true,
                PRINCIPALINSTALLMENTLEFT = 0,
                INTERESTINSTALLMENTLEFT = 0,
                EQUITYCONTRIBUTION = 0,
                PRINCIPALADDITIONCOUNT = 0,
                PRINCIPALREDUCTIONCOUNT = 0,
                FIXEDPRINCIPAL = false,
                PROFILELOAN = false,

                APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,
                USER_PRUDENTIAL_GUIDE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                EXT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                INT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,

                SCHEDULETYPEID = (short)LoanScheduleTypeEnum.BulletPayment,
                SCHEDULEDAYCOUNTCONVENTIONID = (short)DayCountConventionEnum.Actual_Actual,
                SCHEDULEDPREPAYMENTAMOUNT = entity.scheduledPrepaymentAmount,
                PRINCIPALAMOUNT = Convert.ToDecimal(entity.loanPrincipal),
                OUTSTANDINGPRINCIPAL = Convert.ToDecimal(entity.loanPrincipal),
                //CRMSREPAYMENTAGREEMENTID = entity.crmsRepaymentAgreementTypeId,

                EFFECTIVEDATE = entity.effectiveDate,
                MATURITYDATE = entity.maturityDate,
                FIRSTPRINCIPALPAYMENTDATE = entity.maturityDate,
                FIRSTINTERESTPAYMENTDATE = entity.maturityDate,
                SCHEDULEDAYINTERESTTYPEID = 0,
                BOOKINGDATE = generalSetup.GetApplicationDate(),
                CREATEDBY = entity.createdBy,
                DATETIMECREATED = DateTime.Now,
            };

            if (priceIndex.PRODUCTPRICEINDEXID > 0)
            {
                data.PRODUCTPRICEINDEXID = priceIndex.PRODUCTPRICEINDEXID;
                data.PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE > 0 ? priceIndex.PRICEINDEXRATE : 0;
            }

            //Audit Section ---------------------------
            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.AddCommercialLoanBooking,
                STAFFID = entity.createdBy,
                BRANCHID = (short)entity.userBranchId,
                DETAIL = $"Applied for loan with reference number: {loanReferenceNumber}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = entity.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            context.TBL_AUDIT.Add(audit);
            //end of Audit section -------------------------------

            using (var trans = context.Database.BeginTransaction())
            {
                // ............. Checking customer balance, and fee override ......
                //confirmCustomerAccountFunded(entity.loanChargeFee, entity.casaAccountId, entity.companyId, entity.customerId, loanReferenceNumber);
                entity.feeOverride = true;

                //...................Adding Commercial Loan Record.........................
                var loan = context.TBL_LOAN.Add(data);
                request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
                request.ISUSED = true;

                //request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
                application.APPLICATIONSTATUSID = (short)LoanApplicationStatusEnum.LoanBookingInProgress;

                //...................Adding Audit...............................
                var dataCount = context.SaveChanges();
                if (dataCount > 0)
                {
                    var approvalModel = new ForwardViewModel
                    {
                        createdBy = entity.createdBy,
                        companyId = entity.companyId,
                        applicationId = entity.loanBookingRequestId,
                        comment = entity.comment, //"Please approve this Loan",
                        amount = entity.principalAmount,
                        operationId = (int)OperationsEnum.CommercialLoanBooking
                    };

                    //.....................LOG COMMERCIAL LOAN BOOKING TRANSACTION FOR APPROVAL......................................
                    if (LogApproval(approvalModel, (int)OperationsEnum.CommercialLoanBooking, false, (int)ApprovalStatusEnum.Processing))
                    {
                        AddLoanCovenant(entity, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility);
                        AddLoanFees(entity.loanChargeFee, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility, entity, applicationDetail);

                        //...................Saving Commercial Loan Collaterals Mapping.......................
                        AddLoanCollateralMapping(entity.loanApplicationId, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility);

                        //...................Mapping Commercial Loan Monitoring Trigger.......................
                        AddLoanMonitoringTrigger(entity.loanApplicationDetailId, entity.createdBy, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility);
                        //if (entity.monitoringTriggers.Count > 0)
                        //    AddLoanMonitoringTrigger(entity.monitoringTriggers, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility);

                        entity.loanReferenceNumber = loan.LOANREFERENCENUMBER;
                        if (!entity.feeOverride) PostLoanFees(entity);

                        var staffCode = context.TBL_STAFF.Find(entity.createdBy).STAFFCODE;
                        //CreateFacilityOnThirdParty(loan.PRODUCTID, loan.LOANAPPLICATIONDETAILID, loan.CASAACCOUNTID, loan.EFFECTIVEDATE, loan.MATURITYDATE, loan.LOANSYSTEMTYPEID, staffCode, staffCode);
                        if (applicationDetail.STAMPDUTYAPPLICABLE)
                        {
                            var apiResult = new PostingResult();
                            var stampDuty = context.TBL_FACILITY_STAMP_DUTY.Where(f => f.LOANAPPLICATIONDETAILID == applicationDetail.LOANAPPLICATIONDETAILID && f.DELETED == false).FirstOrDefault();
                            var appCol = context.TBL_LOAN_APPLICATION_COLLATERL.Where(c => c.LOANAPPLICATIONDETAILID == stampDuty.LOANAPPLICATIONDETAILID && c.DELETED == false).FirstOrDefault();
                            var col = context.TBL_COLLATERAL_CUSTOMER.Where(co => co.COLLATERALCUSTOMERID == stampDuty.COLLATERALCUSTOMERID).FirstOrDefault();
                            var stampCon = context.TBL_STAMP_DUTY_CONDITION.Where(s => s.COLLATERALSUBTYPEID == col.COLLATERALSUBTYPEID).FirstOrDefault();
                            var stampFeeId = context.TBL_CHARGE_FEE.Where(s => s.CHARGEFEENAME.ToLower().Contains("(fixed)") && s.DELETED == false).FirstOrDefault().CHARGEFEEID;
                            var stampFee = context.TBL_LOAN_APPLICATION_DETL_FEE.Where(f => f.LOANAPPLICATIONDETAILID == applicationDetail.LOANAPPLICATIONDETAILID && f.CHARGEFEEID == stampFeeId).FirstOrDefault()?.RECOMMENDED_FEERATEVALUE;
                            var stampDutyAmount = applicationDetail.APPROVEDAMOUNT * (stampCon.DUTIABLEVALUE / 100);
                            decimal bankShare = 0;
                            decimal customerShare = stampDutyAmount * (stampDuty.CUSTOMERPERCENTAGE / 100) + (decimal)stampFee;
                            if (stampDuty.COLLECTED == false)
                            {
                                if (stampDuty.ISSHARED)
                                {
                                    bankShare = stampDutyAmount * (stampDuty.BANKPERCENTAGE / 100);
                                    //customerShare = stampDutyAmount * (stampDuty.CUSTOMERPERCENTAGE / 100);

                                    StampDutyPostingViewModel stampDutySharedModel = new StampDutyPostingViewModel()
                                    {
                                        reference = application.APPLICATIONREFERENCENUMBER,
                                        appId = "FINTRAK",
                                        userId = "STAMPDUTY",
                                        currency = "NGN",
                                        branchCode = entity.branchCode,
                                        tranCode = "LSD",
                                        custAccNumber = context.TBL_CHART_OF_ACCOUNT.Where(c => c.ACCOUNTNAME == "STAMP DUTY ON LOANS COLLECTION GL").FirstOrDefault().ACCOUNTCODE,
                                        custAccName = "STAMP DUTY ON LOANS COLLECTION GL",
                                        bankTillName = "STAMP DUTY PAYABLE",
                                        bankTillAccount = context.TBL_CHART_OF_ACCOUNT.Where(c => c.ACCOUNTNAME == "STAMP DUTY ON LOANS PAYABLE GL").FirstOrDefault().ACCOUNTCODE,//To be provided,
                                        amount = bankShare,
                                    };

                                    if (USE_THIRD_PARTY_INTEGRATION)
                                    {
                                        apiResult = integration.PostStampDutyInputs(stampDutySharedModel);
                                    }
                                }

                                StampDutyPostingViewModel stampDutyModel = new StampDutyPostingViewModel()
                                {
                                    reference = application.APPLICATIONREFERENCENUMBER,
                                    appId = "FINTRAK",
                                    userId = "STAMPDUTY",
                                    currency = "NGN",
                                    branchCode = entity.branchCode,
                                    tranCode = "LSD",
                                    custAccNumber = context.TBL_CASA.Where(c => c.CASAACCOUNTID == entity.casaAccountId).FirstOrDefault().PRODUCTACCOUNTNUMBER,// entity.casaAccountNumber,
                                    custAccName = context.TBL_CASA.Where(c => c.CASAACCOUNTID == entity.casaAccountId).FirstOrDefault().PRODUCTACCOUNTNAME,//   entity.casaAccountDetails,
                                    bankTillName = "STAMP DUTY PAYABLE",
                                    bankTillAccount = context.TBL_CHART_OF_ACCOUNT.Where(c => c.ACCOUNTNAME == "STAMP DUTY ON LOANS PAYABLE GL").FirstOrDefault().ACCOUNTCODE,//To be provided,
                                    amount = customerShare,
                                };
                                //var apiResult = new PostingResult();
                                if (USE_THIRD_PARTY_INTEGRATION)
                                {
                                    apiResult = integration.PostStampDutyInputs(stampDutyModel);
                                    stampDuty.COLLECTED = true;
                                }


                            }

                        }
                        context.SaveChanges();

                        //.....Commit transaction ............
                        trans.Commit();
                    }

                    //.......................END OF APPROVAL LOG......................................................

                    return loanReferenceNumber;
                }
                else
                {
                    return "";
                }
            }
        }

        private string EditFXLoan(LoanViewModel entity)
        {
            var application = context.TBL_LOAN_APPLICATION.Find(entity.loanApplicationId);
            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(entity.loanBookingRequestId);
            var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            var systemDate = generalSetup.GetApplicationDate();

            //if (request.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing)
            //    throw new ConditionNotMetException("This Loan Request has already been booked by another staff");

            //if (entity.effectiveDate > entity.maturityDate)
            //    throw new ConditionNotMetException("The effective cannot be greater than maturity date");

            //if (entity.effectiveDate > systemDate)
            //    throw new ConditionNotMetException("You effective date cannot be post-dated.");

            //if (entity.effectiveDate == entity.maturityDate)
            //    throw new ConditionNotMetException("Effective date and maturity Date cannot be equal");

            //    if (applicationDetail.EXPIRYDATE != null && entity.maturityDate > applicationDetail.EXPIRYDATE)
            //    throw new ConditionNotMetException($"FX revolving loan maturity date should not exceed the line expiry date [{Convert.ToDateTime(applicationDetail.EXPIRYDATE).ToString("dd/MM/yyyy")}]. ");


            var loans = context.TBL_LOAN.Where(x => x.LOANSTATUSID == (short)LoanStatusEnum.Active && x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).OrderByDescending(l => l.TERMLOANID);

            var principalAmount = from a in context.TBL_LOAN
                                  where a.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId
                                  let sumPrincipalAmount = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).Sum(x => x.PRINCIPALAMOUNT)
                                  select sumPrincipalAmount;

            double? priceIndex = (from a in context.TBL_PRODUCT where a.PRODUCTID == entity.productId select a.TBL_PRODUCT_PRICE_INDEX.PRICEINDEXRATE).FirstOrDefault();

            var currentExchangeRate = financeTransaction.GetExchangeRate(DateTime.Now, (short)entity.currencyId, entity.companyId).sellingRate;

            var loanReferenceNumber = GenerateLoanReferenceNumber(application.BRANCHID, entity.productId, (short)LoanSystemTypeEnum.TermDisbursedFacility);

            var approvedAmount = applicationDetail.APPROVEDAMOUNT;

            var totalPreviouslyBookedAmount = principalAmount.FirstOrDefault();

            var totalPrincipalAmount = (decimal)(totalPreviouslyBookedAmount + (decimal)entity.principalAmount);

            if (totalPrincipalAmount > (decimal)approvedAmount)
                throw new ConditionNotMetException("The loan amount cannot be greater than the availiable amount");

            var nostroAccount = context.TBL_CUSTOM_CHART_OF_ACCOUNT.Find(entity.casaAccountId2);
            var nostroAccountNumber = nostroAccount.ACCOUNTID;
            var nostroCurrencyId = context.TBL_CURRENCY.FirstOrDefault(c => c.CURRENCYCODE == nostroAccount.CURRENCYCODE).CURRENCYID;

            var loanData = context.TBL_LOAN.Find(entity.loanId);
            loanData.CASAACCOUNTID = entity.casaAccountId;
            loanData.NOSTROACCOUNTID = nostroAccountNumber;
            loanData.NOSTRORATECODEID = entity.nostroRateCodeId;
            loanData.NOSTRORATEAMOUNT = entity.nostroRateAmount;
            loanData.NOSTROCURRENCYID = nostroCurrencyId;
            loanData.INTERESTRATE = Convert.ToInt32(applicationDetail.APPROVEDINTERESTRATE);
            loanData.SCHEDULETYPEID = (short)LoanScheduleTypeEnum.BulletPayment;
            loanData.SCHEDULEDAYCOUNTCONVENTIONID = (short)DayCountConventionEnum.Actual_Actual;
            loanData.SCHEDULEDPREPAYMENTAMOUNT = entity.scheduledPrepaymentAmount;
            loanData.PRINCIPALAMOUNT = Convert.ToDecimal(entity.loanPrincipal);
            loanData.OUTSTANDINGPRINCIPAL = Convert.ToDecimal(entity.loanPrincipal);
            //loanData.CRMSREPAYMENTAGREEMENTID = entity.crmsRepaymentAgreementTypeId;
            loanData.EFFECTIVEDATE = (DateTime)entity.effectiveDate;
            loanData.MATURITYDATE = (DateTime)entity.maturityDate;

            var approvalModel = new ForwardViewModel
            {
                createdBy = entity.createdBy,
                companyId = entity.companyId,
                applicationId = entity.loanBookingRequestId,
                comment = "Please proceed. The loan booking setup has been modified.",
                amount = entity.principalAmount,
                operationId = (int)OperationsEnum.ForeignExchangeLoanBooking
            };
            LogApproval(approvalModel, (int)OperationsEnum.ForeignExchangeLoanBooking, false, (int)ApprovalStatusEnum.Processing);

            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.ForeignExchangeLoanAdded,
                STAFFID = entity.createdBy,
                BRANCHID = (short)entity.userBranchId,
                DETAIL = $"Editted loan booking with loan account number: {loanData.LOANREFERENCENUMBER}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = entity.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            context.TBL_AUDIT.Add(audit);

            try
            {
                context.SaveChanges();
                return loanData.LOANREFERENCENUMBER;
            }
            catch (ConditionNotMetException ce) { throw new ConditionNotMetException(ce.Message); }

            catch (Exception ex) { throw new Exception(ex.Message); }
        }

        private string AddFXLoan(LoanViewModel entity, bool isTermLoan)
        {
            var application = context.TBL_LOAN_APPLICATION.Find(entity.loanApplicationId);
            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(entity.loanBookingRequestId);
            var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            var systemDate = generalSetup.GetApplicationDate();

            var loans = context.TBL_LOAN.Where(x => x.LOANSTATUSID == (short)LoanStatusEnum.Active && x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).OrderByDescending(l => l.TERMLOANID);

            var principalAmount = from a in context.TBL_LOAN
                                  where a.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId
                                  let sumPrincipalAmount = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId).Sum(x => x.PRINCIPALAMOUNT)
                                  select sumPrincipalAmount;

            //var priceIndex = (from a in context.TBL_PRODUCT_PRICE_INDEX where a.PRODUCTPRICEINDEXID == applicationDetail.PRODUCTPRICEINDEXID select a).FirstOrDefault();

            //var interestRate = Convert.ToDouble(entity.interestRate);
            //if (priceIndex != null)
            //{
            //    interestRate = priceIndex.PRICEINDEXRATE + interestRate;
            //}

            var interestRate = Convert.ToDouble(applicationDetail.APPROVEDINTERESTRATE);
            var priceIndex = new TBL_PRODUCT_PRICE_INDEX();
            if (entity.productPriceIndexId > 0)
            {
                priceIndex = (from a in context.TBL_PRODUCT_PRICE_INDEX where a.PRODUCTPRICEINDEXID == entity.productPriceIndexId select a).FirstOrDefault();
                if (priceIndex != null)
                {
                    interestRate = priceIndex.PRICEINDEXRATE + interestRate;
                }
            }
            if (applicationDetail.ISLINEFACILITY == true)
            {
                entity.customerId = request.CUSTOMERID != null ? (int)request.CUSTOMERID : entity.customerId;
            }

            var currentExchangeRate = financeTransaction.GetExchangeRate(DateTime.Now, (short)entity.currencyId, entity.companyId).sellingRate;

            var loanReferenceNumber = GenerateLoanReferenceNumber(application.BRANCHID, entity.productId, (short)LoanSystemTypeEnum.TermDisbursedFacility);

            var approvedAmount = applicationDetail.APPROVEDAMOUNT;

            var totalPreviouslyBookedAmount = principalAmount.FirstOrDefault();

            var totalPrincipalAmount = (decimal)(totalPreviouslyBookedAmount + (decimal)entity.principalAmount);

            if (totalPrincipalAmount > (decimal)approvedAmount)
                throw new ConditionNotMetException("The loan amount cannot be greater than the availiable amount");

            var nostroAccount = context.TBL_CUSTOM_CHART_OF_ACCOUNT.Find(entity.casaAccountId2);
            var nostroAccountNumber = nostroAccount.ACCOUNTID;
            var nostroCurrencyId = context.TBL_CURRENCY.FirstOrDefault(c => c.CURRENCYCODE == nostroAccount.CURRENCYCODE).CURRENCYID;

            var data = new TBL_LOAN
            {
                LOAN_BOOKING_REQUESTID = entity.loanBookingRequestId,
                LOANAPPLICATIONDETAILID = entity.loanApplicationDetailId,
                OPERATIONID = entity.operationId = (int)OperationsEnum.ForeignExchangeLoanBooking,
                LOANREFERENCENUMBER = loanReferenceNumber,
                LOANSTATUSID = (short)LoanStatusEnum.Inactive,
                SHOULD_DISBURSE = true,
                ISDISBURSED = false,
                PRINCIPALNUMBEROFINSTALLMENT = 1,
                INTERESTNUMBEROFINSTALLMENT = 1,
                SCH_PREPAYMENT_FREQUENCY_TYPID = null,
                //PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE,
                //PRODUCTPRICEINDEXID = priceIndex.PRODUCTPRICEINDEXID,
                //PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE > 0 ? priceIndex.PRICEINDEXRATE : 0,
                //PRODUCTPRICEINDEXID = priceIndex.PRODUCTPRICEINDEXID,
                SUBSECTORID = applicationDetail.SUBSECTORID,
                CURRENCYID = (short)applicationDetail.CURRENCYID,
                EXCHANGERATE = currentExchangeRate,
                DISCHARGELETTER = false,
                SUSPENDINTEREST = false,
                CUSTOMERID = entity.customerId,
                PRODUCTID = request.PRODUCTID,
                COMPANYID = entity.companyId,
                CASAACCOUNTID = entity.casaAccountId,
                CASAACCOUNTID2 = (entity.casaAccountId2 == 0 || entity.casaAccountId2 == null) ? entity.casaAccountId : entity.casaAccountId2,
                NOSTROACCOUNTID = nostroAccountNumber,
                NOSTRORATECODEID = entity.nostroRateCodeId,
                NOSTRORATEAMOUNT = entity.nostroRateAmount,
                NOSTROCURRENCYID = nostroCurrencyId,
                BRANCHID = application.BRANCHID,
                LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                RELATIONSHIPOFFICERID = application.RELATIONSHIPOFFICERID,
                RELATIONSHIPMANAGERID = application.RELATIONSHIPMANAGERID,
                MISCODE = application.MISCODE,
                TEAMMISCODE = application.TEAMMISCODE,
                INTERESTRATE = Convert.ToInt32(applicationDetail.APPROVEDINTERESTRATE),
                ALLOWFORCEDEBITREPAYMENT = false,
                PRINCIPALINSTALLMENTLEFT = 0,
                INTERESTINSTALLMENTLEFT = 0,
                EQUITYCONTRIBUTION = 0,
                PRINCIPALADDITIONCOUNT = 0,
                PRINCIPALREDUCTIONCOUNT = 0,
                FIXEDPRINCIPAL = false,
                PROFILELOAN = false,

                APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,
                USER_PRUDENTIAL_GUIDE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                EXT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                INT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,

                SCHEDULETYPEID = (short)LoanScheduleTypeEnum.BulletPayment,
                SCHEDULEDAYCOUNTCONVENTIONID = (short)DayCountConventionEnum.Actual_Actual,
                SCHEDULEDPREPAYMENTAMOUNT = entity.scheduledPrepaymentAmount,
                PRINCIPALAMOUNT = Convert.ToDecimal(entity.loanPrincipal),
                OUTSTANDINGPRINCIPAL = Convert.ToDecimal(entity.loanPrincipal),
                //CRMSREPAYMENTAGREEMENTID = entity.crmsRepaymentAgreementTypeId,

                EFFECTIVEDATE = (DateTime)entity.effectiveDate,
                MATURITYDATE = (DateTime)entity.maturityDate,
                FIRSTPRINCIPALPAYMENTDATE = entity.maturityDate,
                FIRSTINTERESTPAYMENTDATE = entity.maturityDate,
                SCHEDULEDAYINTERESTTYPEID = 0,
                BOOKINGDATE = generalSetup.GetApplicationDate(),
                CREATEDBY = entity.createdBy,
                DATETIMECREATED = DateTime.Now,
            };

            if (priceIndex.PRODUCTPRICEINDEXID > 0)
            {
                data.PRODUCTPRICEINDEXID = priceIndex.PRODUCTPRICEINDEXID;
                data.PRODUCTPRICEINDEXRATE = priceIndex.PRICEINDEXRATE > 0 ? priceIndex.PRICEINDEXRATE : 0;
            }

            //Audit Section ---------------------------
            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.ForeignExchangeLoanAdded,
                STAFFID = entity.createdBy,
                BRANCHID = (short)entity.userBranchId,
                DETAIL = $"Applied for FX-loan with reference number: {loanReferenceNumber}",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = entity.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            context.TBL_AUDIT.Add(audit);
            //end of Audit section -------------------------------

            using (var trans = context.Database.BeginTransaction())
            {
                //...Checking customer balance, and fee override...
                //confirmCustomerAccountFunded(entity.loanChargeFee, entity.casaAccountId, entity.companyId, entity.customerId, loanReferenceNumber);
                entity.feeOverride = true;

                //...Adding Commercial Loan Record...
                var loan = context.TBL_LOAN.Add(data);

                //...Update the Loan Request and loan application table...
                request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
                request.ISUSED = true;
                application.APPLICATIONSTATUSID = (short)LoanApplicationStatusEnum.LoanBookingInProgress;

                //...Adding Audit...
                var dataCount = context.SaveChanges();
                if (dataCount > 0)
                {
                    var approvalModel = new ForwardViewModel
                    {
                        createdBy = entity.createdBy,
                        companyId = entity.companyId,
                        applicationId = entity.loanBookingRequestId,
                        comment = "Please approve this Loan",
                        amount = entity.principalAmount,
                        operationId = (int)OperationsEnum.ForeignExchangeLoanBooking
                    };

                    //.....................LOG FX LOAN BOOKING TRANSACTION FOR APPROVAL......................................
                    if (LogApproval(approvalModel, (int)OperationsEnum.ForeignExchangeLoanBooking, false, (int)ApprovalStatusEnum.Processing))
                    {
                        AddLoanCovenant(entity, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility);
                        AddLoanFees(entity.loanChargeFee, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility, entity, applicationDetail);
                        //AddDeferredFees(entity.loanChargeFee, (short)LoanSystemTypeEnum.TermDisbursedFacility, entity, applicationDetail);

                        //...................Saving FX Loan Collaterals Mapping.......................
                        AddLoanCollateralMapping(entity.loanApplicationId, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility);

                        //...................Mapping FX Loan Monitoring Trigger.......................
                        AddLoanMonitoringTrigger(entity.loanApplicationDetailId, entity.createdBy, loan.TERMLOANID, (short)LoanSystemTypeEnum.TermDisbursedFacility);

                        if (entity.loanBeneficiary.Count > 0)
                        {
                            foreach (var item in entity.loanBeneficiary)
                            {
                                item.loanId = loan.TERMLOANID;
                            };
                            addLoanBeneficiary(entity.loanBeneficiary);
                        }

                        entity.loanReferenceNumber = loan.LOANREFERENCENUMBER;
                        if (!entity.feeOverride) PostLoanFees(entity);

                        var staffCode = context.TBL_STAFF.Where(O => O.STAFFID == entity.createdBy).FirstOrDefault().STAFFCODE;
                        CreateFacilityOnThirdParty(loan.PRODUCTID, loan.LOANAPPLICATIONDETAILID, loan.CASAACCOUNTID, loan.EFFECTIVEDATE, loan.MATURITYDATE, loan.LOANSYSTEMTYPEID, staffCode, staffCode);

                        context.SaveChanges();

                        //.....Commit transaction ............
                        trans.Commit();
                    }

                    //.......................END OF APPROVAL LOG......................................................

                    return loanReferenceNumber;
                }
                else
                {
                    return "";
                }
            }
        }

        private bool addLoanBeneficiary(List<LoanDisbursementViewModel> entity)
        {
            List<TBL_LOAN_DISBURSEMENT> loanDisbursementList = new List<TBL_LOAN_DISBURSEMENT>();
            foreach (var model in entity)
            {
                var beneficiary = new TBL_LOAN_DISBURSEMENT
                {
                    AMOUNTDISBURSED = model.beneficiaryAmount,
                    // CURRENCYID = model.beneficiaryCurrencyId,
                    NARRATION = model.beneficiaryReason,
                    // RATECODEID = model.beneficiaryRateCodeId,
                    // RATEAMOUNT = model.beneficiaryRateAmount,
                    TERMLOANID = model.loanId,
                    DATETIMECREATED = DateTime.Now,
                    CREATEDBY = model.createdBy,
                };
                loanDisbursementList.Add(beneficiary);

            }
            context.TBL_LOAN_DISBURSEMENT.AddRange(loanDisbursementList);
            //return context.SaveChanges() > 0;

            return true;
        }

        public bool LogApproval(ForwardViewModel model, int operationId, bool externalInitialization, int ApprovalStatusId)
        {
            if (externalInitialization)
            {
                workflow.StaffId = model.createdBy;
                workflow.OperationId = operationId;
                workflow.TargetId = model.applicationId;
                workflow.CompanyId = model.companyId;
                workflow.Comment = model.comment;
                workflow.ExternalInitialization = externalInitialization;
                workflow.StatusId = ApprovalStatusId;
                workflow.Amount = model.amount;
            }

            if (!externalInitialization)
            {
                workflow.StaffId = model.createdBy;
                workflow.CompanyId = model.companyId;
                workflow.StatusId = ApprovalStatusId;
                workflow.TargetId = model.applicationId;
                workflow.Comment = model.comment;
                workflow.OperationId = operationId;
                workflow.DeferredExecution = true;
                workflow.ExternalInitialization = false;
            }

            workflow.LogActivity();

            return context.SaveChanges() > 0;
        }

        private void CreateFacilityOnThirdParty(int productID, int loanApplicationDetailId, int casaAccountId, DateTime effectiveDate, DateTime expiryDate, short loanSystemTypeId, string makerStaffCode, string checkerStaffCode)
        {
            if (USE_THIRD_PARTY_INTEGRATION)
            {
                FlexcubeCreateFacilityViewModel faciltyCreationModel = new FlexcubeCreateFacilityViewModel();

                var product = context.TBL_PRODUCT.Find(productID);
                var productClass = product.TBL_PRODUCT_CLASS;
                var systemDate = generalSetup.GetApplicationDate();
                var facilityDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(loanApplicationDetailId);
                var casa = context.TBL_CASA.Find(casaAccountId);
                var customer = context.TBL_CUSTOMER.Find(facilityDetail.CUSTOMERID);
                var collaterals = context.TBL_LOAN_APPLICATION_COLLATERL.Where(x => x.LOANAPPLICATIONDETAILID == loanApplicationDetailId).ToList();

                faciltyCreationModel.account_no = casa.PRODUCTACCOUNTNUMBER;
                faciltyCreationModel.limit_amount = facilityDetail.APPROVEDAMOUNT.ToString();
                faciltyCreationModel.checker_id = checkerStaffCode;
                faciltyCreationModel.maker_id = makerStaffCode;
                //faciltyCreationModel.= facilityDetail.APPROVEDINTERESTRATE.ToString();
                //faciltyCreationModel.p_facility_description = product.PRODUCTCODE;
                faciltyCreationModel.expiry_date = expiryDate.ToString("dd-MM-yyyy");
                faciltyCreationModel.start_date = effectiveDate.ToString("dd-MM-yyyy");
                //faciltyCreationModel.p_line_serial = facilityDetail.LOANAPPLICATIONDETAILID.ToString();
                //faciltyCreationModel.p_liab_no = customer.LIABILITYLIMITNUMBER;
                faciltyCreationModel.line_code = facilityDetail.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER;
                faciltyCreationModel.sourceReferenceNumber = facilityDetail.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER;
                //faciltyCreationModel.p_collateral_amount = collaterals?.Sum(x => x.BALANCEAVAILABLE ).ToString() == null ? "0" : collaterals?.Sum(x => x.BALANCEAVAILABLE).ToString();
                //faciltyCreationModel.p_collateral_amount = collaterals?.Sum(x=>x.BALANCEAVAILABLE).ToString() ?? "0";
                //faciltyCreationModel.p_collateral_code = collaterals.FirstOrDefault()?.TBL_COLLATERAL_CUSTOMER?.COLLATERALCODE.ToString();
                faciltyCreationModel.channel_code = "FINTRAK";
                faciltyCreationModel.loanApplicationId = facilityDetail.TBL_LOAN_APPLICATION.LOANAPPLICATIONID;


                var apiResult = new PostingResult();

                if (facilityDetail.ISFACILITYCREATED == null || !(bool)facilityDetail.ISFACILITYCREATED)
                {
                    apiResult = integration.PostFacilityCreationInputs(faciltyCreationModel, loanSystemTypeId);
                }

                if (apiResult.responseCode == "00")
                {
                    facilityDetail.ISFACILITYCREATED = true;
                    context.SaveChanges();
                }
            }

        }

        private void CreateLoanOnThirdParty(LoanViewModel model, string loanReffernceNumber)
        {
            FlexcubeCreateLoanAccountViewModel loanCreationModel = new FlexcubeCreateLoanAccountViewModel();
            var product = context.TBL_PRODUCT.Find(model.productId);
            var productClass = product.TBL_PRODUCT_CLASS;
            var staff = context.TBL_STAFF.Find(model.createdBy);
            var systemDate = generalSetup.GetApplicationDate();
            var casa = context.TBL_CASA.Find(model.casaAccountId);
            var facility = context.TBL_LOAN_APPLICATION_DETAIL.Find(model.loanApplicationDetailId);
            var app = facility.TBL_LOAN_APPLICATION;

            var loanLoanRequest = (from b in context.TBL_LOAN
                                   join r in context.TBL_LOAN_BOOKING_REQUEST on b.LOAN_BOOKING_REQUESTID equals r.LOAN_BOOKING_REQUESTID
                                   where b.LOANREFERENCENUMBER == loanReffernceNumber
                                   select b).FirstOrDefault();

            var fee2 = (from lf in context.TBL_LOAN_FEE
                        join f in context.TBL_CHARGE_FEE on lf.CHARGEFEEID equals f.CHARGEFEEID
                        join l in context.TBL_LOAN on lf.LOANID equals l.TERMLOANID
                        where l.LOANREFERENCENUMBER == loanReffernceNumber && (lf.LOANSYSTEMTYPEID == l.LOANSYSTEMTYPEID) && lf.ISPOSTED == false
                        select new { chargeFeeId = f.CHARGEFEEID, feeShortName = f.SHORTNAME, feeRate = lf.FEERATEVALUE, loanFeeId = lf.LOANCHARGEFEEID }).ToList();

            var lineFee = (from lf in context.TBL_LOAN_FEE
                           join f in context.TBL_CHARGE_FEE on lf.CHARGEFEEID equals f.CHARGEFEEID
                           join l in context.TBL_LOAN_APPLICATION_DETAIL on lf.LOANID equals l.LOANAPPLICATIONDETAILID
                           where lf.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility
                           && l.LOANAPPLICATIONDETAILID == model.loanApplicationDetailId && lf.ISPOSTED == false
                           select new { chargeFeeId = f.CHARGEFEEID, feeShortName = f.SHORTNAME, feeRate = lf.FEERATEVALUE, loanFeeId = lf.LOANCHARGEFEEID }).ToList();

            var prod = context.TBL_PRODUCT.Find(model.productId);

            if (prod.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan)
            {
                fee2 = (from lf in context.TBL_LOAN_FEE
                        join f in context.TBL_CHARGE_FEE on lf.CHARGEFEEID equals f.CHARGEFEEID
                        join l in context.TBL_LOAN_REVOLVING on lf.LOANID equals l.REVOLVINGLOANID
                        where l.LOANREFERENCENUMBER == loanReffernceNumber && (lf.LOANSYSTEMTYPEID == l.LOANSYSTEMTYPEID) && lf.ISPOSTED == false
                        select new { chargeFeeId = f.CHARGEFEEID, feeShortName = f.SHORTNAME, feeRate = lf.FEERATEVALUE, loanFeeId = lf.LOANCHARGEFEEID }).ToList();
            }
            if (prod.PRODUCTTYPEID == (short)LoanProductTypeEnum.ContingentLiability)
            {
                fee2 = (from lf in context.TBL_LOAN_FEE
                        join f in context.TBL_CHARGE_FEE on lf.CHARGEFEEID equals f.CHARGEFEEID
                        join l in context.TBL_LOAN_CONTINGENT on lf.LOANID equals l.CONTINGENTLOANID
                        where l.LOANREFERENCENUMBER == loanReffernceNumber && (lf.LOANSYSTEMTYPEID == l.LOANSYSTEMTYPEID) && lf.ISPOSTED == false
                        select new { chargeFeeId = f.CHARGEFEEID, feeShortName = f.SHORTNAME, feeRate = lf.FEERATEVALUE, loanFeeId = lf.LOANCHARGEFEEID }).ToList();
            }

            var fee = fee2.Union(lineFee.ToList());

            var scheduleCount = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(x => x.LOANID == loanLoanRequest.TERMLOANID).Count();

            if (loanLoanRequest.SCHEDULEDAYCOUNTCONVENTIONID == (short)LoanScheduleTypeEnum.IrregularSchedule)
            {
                scheduleCount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == loanLoanRequest.TERMLOANID).Count();
            }

            //var test = fee.ToList();
            var chargefeeIds = fee.Select(x => x.chargeFeeId).ToList();

            var feeVat = (from d in context.TBL_CHARGE_FEE_DETAIL
                          where chargefeeIds.Contains(d.CHARGEFEEID)
                          && d.DETAILTYPEID == (short)ChargeFeeDealTypeEnum.Tax && d.VALUE > 0
                          select d).FirstOrDefault();

            var staffCode = context.TBL_STAFF.Where(O => O.STAFFID == model.createdBy).FirstOrDefault().STAFFCODE;

            var valueDate = model.effectiveDate;

            //DateTime instDate = model.effectiveDate.AddDays(30);
            //if(loanLoanRequest.PRINCIPALFREQUENCYTYPEID == (short)FrequencyTypeEnum.Quarterly)
            //{
            //    instDate = model.effectiveDate.AddDays(90);
            //}
            //if (loanLoanRequest.PRINCIPALFREQUENCYTYPEID == (short)FrequencyTypeEnum.Yearly)
            //{
            //    instDate = model.effectiveDate.AddYears(1);
            //}

            var apiSetup = context.TBL_API_URL.Where(x => x.TYPENAME == "LOANCREATION").FirstOrDefault();

            loanCreationModel.account_no = casa?.PRODUCTACCOUNTNUMBER;
            loanCreationModel.amount_financed = model.principalAmount.ToString();
            loanCreationModel.interest_rate = model.interestRate.ToString();
            loanCreationModel.product_cat = productClass.PRODUCTCLASSNAME.ToUpper();
            loanCreationModel.product_code = product.PRODUCTCODE;
            loanCreationModel.product_desc = product.PRODUCTNAME;
            loanCreationModel.source = apiSetup.SOURCE; // "FINTRAK";
            loanCreationModel.sourceReferenceNumber = loanReffernceNumber;
            loanCreationModel.tax_rate = feeVat != null ? String.Format("{0:0.00}", feeVat.VALUE) : "0";
            loanCreationModel.user_refno = model.loanApplicationDetailId.ToString(); //staff.STAFFCODE;
            loanCreationModel.app_branch_code = "099"; //app.TBL_BRANCH.BRANCHCODE;
            loanCreationModel.app_user_id = apiSetup.USERID; //"FINTRAKUSR";  //"FINTRAKUSER";//;
            loanCreationModel.book_date = model.bookingDate.ToString("yyyy-MM-dd");
            loanCreationModel.effective_date = model.effectiveDate.ToString("yyyy-MM-dd");
            loanCreationModel.value_date = valueDate.ToString("yyyy-MM-dd");
            loanCreationModel.maturity_date = model.maturityDate.ToString("yyyy-MM-dd"); //.ToString("yyyy-MM-dd");

            loanCreationModel.no_of_financials = scheduleCount.ToString(); //"11";
            loanCreationModel.due_dateson = loanLoanRequest.FIRSTPRINCIPALPAYMENTDATE.Value.Day.ToString(); //"4";
            loanCreationModel.inst_date = loanLoanRequest.FIRSTPRINCIPALPAYMENTDATE.Value.ToString("yyyy-MM-dd");
            loanCreationModel.advisory_fee = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "advisory_fee").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "advisory_fee").FirstOrDefault()?.feeRate.ToString() : "0");  //"0";
            loanCreationModel.anniversary_fee = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "anniversary_fee").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "anniversary_fee").FirstOrDefault()?.feeRate.ToString() : "0");  //"0";
            loanCreationModel.appraisal_fee = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "appraisal_fee").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "appraisal_fee").FirstOrDefault()?.feeRate.ToString() : "0");  //"0";
            loanCreationModel.committment_fee = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "committment_fee").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "committment_fee").FirstOrDefault()?.feeRate.ToString() : "0"); //"0";
            loanCreationModel.creditlife_fee = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "creditlife_fee").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "creditlife_fee").FirstOrDefault()?.feeRate.ToString() : "0");  //"0";
            loanCreationModel.in_odchrg_fee = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "in_odchrg_fee").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "in_odchrg_fee").FirstOrDefault()?.feeRate.ToString() : "0");  //"0";
            loanCreationModel.mgt_fee = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "mgt_fee").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "mgt_fee").FirstOrDefault()?.feeRate.ToString() : "0");  //"0";
            loanCreationModel.penal_charge = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "penal_charge").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "penal_charge").FirstOrDefault()?.feeRate.ToString() : "1");  //"1";
            loanCreationModel.prn_odchrg_fee = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "prn_odchrg_fee").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "prn_odchrg_fee").FirstOrDefault()?.feeRate.ToString() : "0");  //"0";
            loanCreationModel.processing_fee = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "processing_fee").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "processing_fee").FirstOrDefault()?.feeRate.ToString() : "0");  //"0";
            loanCreationModel.renann_fee = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "renann_fee").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "renann_fee").FirstOrDefault()?.feeRate.ToString() : "0");  //"0";
            loanCreationModel.vehicle_ins = String.Format("{0:0.00}", fee.Where(x => x.feeShortName == "vehicle_ins").FirstOrDefault() != null ? fee.Where(x => x.feeShortName == "vehicle_ins").FirstOrDefault()?.feeRate.ToString() : "0");  //"0";
            loanCreationModel.vehicle_value = "0";
            loanCreationModel.crms_ref_number = (from b in context.TBL_LOAN join r in context.TBL_LOAN_BOOKING_REQUEST on b.LOAN_BOOKING_REQUESTID equals r.LOAN_BOOKING_REQUESTID where b.LOANREFERENCENUMBER == loanReffernceNumber select r).FirstOrDefault()?.CRMSCODE; //loanLoanRequest.CRMSCODE; // "00044/20150613/356687"; //loanLoanRequest
            loanCreationModel.comp_mis8 = "596912";
            loanCreationModel.freq_unit = "M";
            loanCreationModel.disbursement_type = "BOOKING";
            loanCreationModel.loanApplicationId = facility.LOANAPPLICATIONDETAILID;
            loanCreationModel.maker_id = staffCode;
            loanCreationModel.checker_id = staffCode;

            var apiResult = new PostingResult();

            if (facility.ISFACILITYCREATED == null || !(bool)facility.ISFACILITYCREATED)
            {
                apiResult = integration.PostLoanCreationInputs(loanCreationModel, (short)LoanSystemTypeEnum.TermDisbursedFacility);
            }

            var loanFeeIds = fee.Select(c => c.loanFeeId);
            var loanFeeRecord = context.TBL_LOAN_FEE.Where(x => loanFeeIds.Contains(x.LOANCHARGEFEEID));

            if (apiResult.responseCode == "00")
            {
                facility.ISFACILITYCREATED = true;
                foreach (var record in loanFeeRecord) { record.ISPOSTED = true; }
                context.SaveChanges();
            }
        }



        public void DisburseLoan(LoanViewModel entity, TwoFactorAutheticationViewModel twoFactorAuthDetails = null)
        {
            List<FinanceTransactionViewModel> disbursementTransactions = new List<FinanceTransactionViewModel>();

            disbursementTransactions.AddRange(BuildLoanDisbursmentPosting(entity));

            var feePostings = BuildLoanChargeFeesPosting(entity);

            if (feePostings.Count() > 0)
            {
                financeTransaction.PostTransaction(feePostings, false, twoFactorAuthDetails);

                twoFactorAuthDetails.skipAuthentication = true;
                financeTransaction.PostTransaction(disbursementTransactions, false, twoFactorAuthDetails);
            }
            else
            {
                financeTransaction.PostTransaction(disbursementTransactions, false, twoFactorAuthDetails);
            }
        }

        public void PostLoanFees(LoanViewModel entity)
        {
            var twoFADetails = new TwoFactorAutheticationViewModel
            {
                username = entity.username,
                passcode = entity.passCode,
            };

            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

            inputTransactions.AddRange(BuildLoanChargeFeesPosting(entity));

            if (inputTransactions.Count > 0) financeTransaction.PostTransaction(inputTransactions, false, twoFADetails);
        }

        public void PostBandGFacilityFees(LoanViewModel entity)
        {
            var twoFADetails = new TwoFactorAutheticationViewModel
            {
                username = entity.username,
                passcode = entity.passCode,
                skipAuthentication = true,
            };

            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

            inputTransactions.AddRange(BuildLoanChargeFeesPosting(entity));

            if (inputTransactions.Count > 0) financeTransaction.PostTransaction(inputTransactions, false, twoFADetails);
        }

        public List<ApprovalLevelStaffViewModel> GetLoanOperationApprovers(int operation, int companyId)
        {
            return level.GetAllAssignedApprovalLevelStaff(companyId)
                                                .Where(x => x.operationId == operation).ToList();
        }

        //public int GoForBookingRequestApproval(ApprovalViewModel entity, int loanBookingRequestId)
        //{
        //    using (var trans = context.Database.BeginTransaction())
        //    {
        //        var request = context.TBL_LOAN_BOOKING_REQUEST.Find(entity.targetId);
        //        var applicationDet = context.TBL_LOAN_APPLICATION_DETAIL.Find(request.LOANAPPLICATIONDETAILID);
        //        var application = context.TBL_LOAN_APPLICATION.Find(applicationDet.LOANAPPLICATIONID);

        //        workflow.StaffId = entity.createdBy;
        //        workflow.CompanyId = entity.companyId;
        //        workflow.StatusId = ((int)entity.approvalStatusId == (int)ApprovalStatusEnum.Approved) ? (int)ApprovalStatusEnum.Processing : (int)entity.approvalStatusId;
        //        workflow.TargetId = entity.targetId;
        //        workflow.Comment = entity.comment;
        //        workflow.OperationId = entity.operationId;
        //        workflow.DeferredExecution = true;
        //        workflow.ExternalInitialization = false;
        //        //workflow.FinalLevel = application.TRANCHEAPPROVAL_LEVELID;

        //        if (GetCurrentApprovalLevelId(entity.companyId, entity.operationId, entity.targetId) == application.TRANCHEAPPROVAL_LEVELID)
        //        {
        //            workflow.NextLevelId = GetFirstAvailmentLevelId(entity.operationId);
        //        }

        //        workflow.LevelBusinessRule = new LevelBusinessRule
        //        {
        //            Amount = request.AMOUNT_REQUESTED,
        //            PepAmount = request.AMOUNT_REQUESTED,
        //            Pep = application.ISPOLITICALLYEXPOSED,
        //            InsiderRelated = application.ISRELATEDPARTY,
        //            ProjectRelated = application.ISPROJECTRELATED,
        //            OnLending = application.ISONLENDING,
        //            InterventionFunds = application.ISINTERVENTIONFUNDS,
        //            OrrBasedApproval = application.ISORRBASEDAPPROVAL,
        //            DomiciliationNotInPlace = application.DOMICILIATIONNOTINPLACE,
        //        };

        //        workflow.LogActivity();

        //        context.SaveChanges();

        //        if (entity.approvalStatusId == (int)ApprovalStatusEnum.Disapproved)
        //        {
        //            request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Disapproved;
        //            trans.Commit();
        //            context.SaveChanges();
        //            return 3;
        //        }

        //        else if (workflow.NewState == (int)ApprovalState.Ended)
        //        {
        //            request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
        //            var operationId = 0;
        //            if (request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan)
        //                operationId = (short)OperationsEnum.CommercialLoanBooking;
        //            if (request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.ContingentLiability)
        //                operationId = (short)OperationsEnum.ContigentLoanBooking;
        //            if (request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.TermLoan || request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.SelfLiquidating || request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.SyndicatedTermLoan)
        //                operationId = (short)OperationsEnum.TermLoanBooking;
        //            if (request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving)
        //                operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
        //            if (request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan)
        //                operationId = (short)OperationsEnum.RevolvingLoanBooking;

        //            var approvalModel = new ForwardViewModel
        //            {
        //                createdBy = entity.createdBy,
        //                companyId = entity.companyId,
        //                applicationId = request.LOAN_BOOKING_REQUESTID,
        //                comment = "A request for booking needs your attention",
        //                amount = request.AMOUNT_REQUESTED,
        //            };

        //            if (operationId > 0) LogApproval(approvalModel, operationId, true, (short)ApprovalStatusEnum.Pending);
        //            application.APPLICATIONSTATUSID = (short)LoanApplicationStatusEnum.BookingRequestCompleted;
        //            context.SaveChanges();
        //            trans.Commit();
        //            return 0;
        //        }

        //        else
        //        {
        //            application.APPLICATIONSTATUSID = (short)LoanApplicationStatusEnum.BookingRequestInitiated;
        //            context.SaveChanges();
        //            trans.Commit();
        //            return 1;
        //        }
        //    }
        //}

        public CurrentCustomerExposure GetCurrentCompanyExposure()
        {
            IQueryable<CurrentCustomerExposure> exposure = null;
            List<CurrentCustomerExposure> exposures = new List<CurrentCustomerExposure>();
            CurrentCustomerExposure totalExposures = new CurrentCustomerExposure();

            exposure = context.TBL_LOAN
                    .Where(x => x.LOANSTATUSID == (int)LoanStatusEnum.Active)
                    .GroupBy(x => new { x.CUSTOMERID, x.PRODUCTID })
                    .Select(g => new CurrentCustomerExposure
                    {
                        facilityType = g.FirstOrDefault().TBL_PRODUCT.PRODUCTNAME,
                        existingLimit = g.Sum(x => x.PRINCIPALAMOUNT),
                        proposedLimit = g.Sum(x => x.OUTSTANDINGPRINCIPAL),
                        recommendedLimit = g.FirstOrDefault().TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,
                        PastDueObligationsInterest = g.Sum(x => x.PASTDUEINTEREST),
                        pastDueObligationsPrincipal = g.Sum(x => x.PASTDUEPRINCIPAL),
                        reviewDate = DateTime.Now,
                        prudentialGuideline = g.FirstOrDefault().TBL_LOAN_PRUDENTIALGUIDELINE2.STATUSNAME, // ?
                        loanStatus = "Running"
                    });

            if (exposure.Count() > 0) exposures.AddRange(exposure);

            // Same for revolving and contegent facility ...

            exposure = context.TBL_LOAN_REVOLVING
                .Where(x => x.LOANSTATUSID == (int)LoanStatusEnum.Active)
                .GroupBy(x => new { x.CUSTOMERID, x.PRODUCTID })
                .Select(g => new CurrentCustomerExposure
                {
                    facilityType = g.FirstOrDefault().TBL_PRODUCT.PRODUCTNAME,
                    existingLimit = g.Sum(x => x.OVERDRAFTLIMIT),
                    proposedLimit = g.Sum(x => x.OVERDRAFTLIMIT),
                    recommendedLimit = g.FirstOrDefault().TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,
                    PastDueObligationsInterest = g.Sum(x => x.PASTDUEINTEREST),
                    pastDueObligationsPrincipal = g.Sum(x => x.PASTDUEPRINCIPAL),
                    reviewDate = DateTime.Now,
                    prudentialGuideline = g.FirstOrDefault().TBL_LOAN_PRUDENTIALGUIDELINE2.STATUSNAME, // ?
                    loanStatus = "Running"
                });

            if (exposure.Count() > 0) exposures.AddRange(exposure);


            exposure = context.TBL_LOAN_CONTINGENT
                .Where(x => x.LOANSTATUSID == (int)LoanStatusEnum.Active)
                .GroupBy(x => new { x.CUSTOMERID, x.PRODUCTID })
                .Select(g => new CurrentCustomerExposure
                {
                    facilityType = g.FirstOrDefault().TBL_PRODUCT.PRODUCTNAME,
                    existingLimit = g.Sum(x => x.CONTINGENTAMOUNT),
                    proposedLimit = g.Sum(x => x.CONTINGENTAMOUNT),
                    recommendedLimit = g.FirstOrDefault().TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,
                    reviewDate = DateTime.Now,
                    loanStatus = "Running"
                });

            if (exposure.Count() > 0) exposures.AddRange(exposure);


            totalExposures = new CurrentCustomerExposure()
            {
                facilityType = "TOTAL",
                existingLimit = exposures.Sum(t => t.existingLimit),
                proposedLimit = exposures.Sum(t => t.proposedLimit),
                recommendedLimit = exposures.Sum(t => t.recommendedLimit),
                PastDueObligationsInterest = exposures.Sum(t => t.PastDueObligationsInterest),
                pastDueObligationsPrincipal = exposures.Sum(t => t.pastDueObligationsPrincipal),
                reviewDate = DateTime.Now,
                prudentialGuideline = String.Empty,
                loanStatus = String.Empty,
            };

            return totalExposures;
        }


        public int GoForBookingRequestApproval(ApprovalViewModel entity, int loanBookingRequestId)
        {
            using (var trans = context.Database.BeginTransaction())
            {
                var request = context.TBL_LOAN_BOOKING_REQUEST.Find(entity.targetId);
                var applicationDet = context.TBL_LOAN_APPLICATION_DETAIL.Find(request.LOANAPPLICATIONDETAILID);
                var application = context.TBL_LOAN_APPLICATION.Find(applicationDet.LOANAPPLICATIONID);

                // checking of company limit at availment
                var exposure = GetCurrentCompanyExposure();
                var proposedExposure = exposure.proposedLimit + applicationDet.APPROVEDAMOUNT;
                var company = context.TBL_COMPANY.Find(application.COMPANYID);
                if (proposedExposure >= company.SHAREHOLDERSFUND)
                {
                    throw new SecureException("Company Limit Exceeded!");
                }

                workflow.StaffId = entity.createdBy;
                workflow.CompanyId = entity.companyId;
                workflow.StatusId = ((int)entity.approvalStatusId == (int)ApprovalStatusEnum.Approved) ? (int)ApprovalStatusEnum.Processing : (int)entity.approvalStatusId;
                workflow.TargetId = entity.targetId;
                workflow.Comment = entity.comment;
                workflow.OperationId = entity.operationId;
                workflow.DeferredExecution = true;
                workflow.ExternalInitialization = false;
                workflow.Amount = request.AMOUNT_REQUESTED;

                //if(request.AMOUNT_REQUESTED > 100000000)
                //workflow.FinalLevel = application.TRANCHEAPPROVAL_LEVELID;

                //if (GetCurrentApprovalLevelId(entity.companyId, entity.operationId, entity.targetId) == application.TRANCHEAPPROVAL_LEVELID)
                //{
                //    workflow.NextLevelId = GetFirstAvailmentLevelId(entity.operationId);
                //}

                workflow.LevelBusinessRule = new LevelBusinessRule
                {
                    Amount = request.AMOUNT_REQUESTED,
                    PepAmount = request.AMOUNT_REQUESTED,
                    Pep = application.ISPOLITICALLYEXPOSED,
                    InsiderRelated = application.ISRELATEDPARTY,
                    ProjectRelated = application.ISPROJECTRELATED,
                    OnLending = application.ISONLENDING,
                    InterventionFunds = application.ISINTERVENTIONFUNDS,
                    OrrBasedApproval = application.ISORRBASEDAPPROVAL,
                    DomiciliationNotInPlace = application.DOMICILIATIONNOTINPLACE,
                };

                context.SaveChanges();

                if (entity.approvalStatusId == (int)ApprovalStatusEnum.Disapproved)
                {
                    request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Disapproved;
                    trans.Commit();
                    context.SaveChanges();
                    return 3;
                }

                else if (workflow.NewState == (int)ApprovalState.Ended)
                {
                    request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Approved;
                    var operationId = 0;
                    if (request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan)
                        operationId = (short)OperationsEnum.CommercialLoanBooking;
                    if (request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.ContingentLiability)
                        operationId = (short)OperationsEnum.ContigentLoanBooking;
                    if (request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.TermLoan || request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.SelfLiquidating || request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                        operationId = (short)OperationsEnum.TermLoanBooking;
                    if (request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving)
                        operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
                    if (request.TBL_LOAN_APPLICATION_DETAIL.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan)
                        operationId = (short)OperationsEnum.RevolvingLoanBooking;

                    var approvalModel = new ForwardViewModel
                    {
                        createdBy = entity.createdBy,
                        companyId = entity.companyId,
                        applicationId = request.LOAN_BOOKING_REQUESTID,
                        comment = "A request for booking needs your attention",
                        amount = request.AMOUNT_REQUESTED,
                    };

                    if (operationId > 0) LogApproval(approvalModel, operationId, true, (short)ApprovalStatusEnum.Pending);
                    application.APPLICATIONSTATUSID = (short)LoanApplicationStatusEnum.BookingRequestCompleted;
                    var loanLienDetail = context.TBL_APPLICATIONDETAIL_LIEN.FirstOrDefault(l => l.APPLICATIONDETAILID == request.LOANAPPLICATIONDETAILID && l.DELETED == false && l.ISRELEASED == false);
                    if (loanLienDetail != null)
                    {
                        var twoFactorAuthDetails = new TwoFactorAutheticationViewModel
                        {
                            username = "model.username",//for test, real value to be passed!!!
                            passcode = "model.passCode"
                        };
                        PlaceLien(loanLienDetail.APPLICATIONDETAILID, twoFactorAuthDetails, entity.createdBy);
                    }

                    //PlaceLien(request.LOANAPPLICATIONDETAILID, new TwoFactorAutheticationViewModel() { username = "model.username", passcode = "model.passCode" });

                    context.SaveChanges();
                    trans.Commit();
                    return 0;
                }

                else
                {
                    application.APPLICATIONSTATUSID = (short)LoanApplicationStatusEnum.BookingRequestInitiated;
                    context.SaveChanges();
                    trans.Commit();
                    return 1;
                }
            }

            //return workflow.Response;
        }

        private int? GetCurrentApprovalLevelId(int companyId, int operationId, int targetId)
        {
            var trailLog = context.TBL_APPROVAL_TRAIL.Where(x =>
                                x.COMPANYID == companyId
                                && x.OPERATIONID == operationId
                                && x.TARGETID == targetId
                                && x.RESPONSESTAFFID == null
                                && x.TOAPPROVALLEVELID != null // check in workflow
                                && (x.APPROVALSTATEID != (int)ApprovalState.Ended && x.RESPONSEDATE == null)
                            ).ToList();

            var request = trailLog.OrderByDescending(x => x.APPROVALTRAILID).FirstOrDefault() ?? null;

            return request.TOAPPROVALLEVELID ?? null;
        }

        private int GetFirstAvailmentLevelId(int operationId)
        {
            int nextGroupId = 20; // ------------------------HARDCODING!!!!!!
            var operation = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == operationId);
            // if (operation != null) nextGroupId = operation.NEXTAPPROVALGROUPID;

            var levels = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == operationId && x.GROUPID == nextGroupId)
                 .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
                 .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true),
                     mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new
                     {
                         groupPosition = mg.m.POSITION,
                         levelPosition = l.POSITION,
                         levelId = l.APPROVALLEVELID,
                         levelName = l.LEVELNAME,
                         levelTypeId = l.LEVELTYPEID,
                         staffRoleId = l.STAFFROLEID,
                     })
                     .OrderBy(x => x.groupPosition)
                     .ThenBy(x => x.levelPosition)
                     .ToList()
                     ;

            var level = levels.FirstOrDefault(x => x.levelTypeId == (int)ApprovalLevelType.Routing); // routing
            if (level == null) level = levels.FirstOrDefault(x => x.levelPosition == 1);

            return level.levelId;

            /*select l.POSITION, m.GROUPID, g.GROUPNAME,l.APPROVALLEVELID,l.LEVELNAME from TBL_APPROVAL_GROUP_MAPPING m 
            join TBL_APPROVAL_GROUP g on (m.GROUPID=g.GROUPID)
            join TBL_APPROVAL_LEVEL l on (g.GROUPID=l.GROUPID)
            where m.OPERATIONID=39 and m.GROUPID=20
            order by l.POSITION;*/
        }

        public IEnumerable<CamProcessedLoanViewModel> GetEmployerRelatedData(int staffId, int companyId, DateRange param)
        {
            param.endDate = param.endDate.AddHours(23);
            param.endDate = param.endDate.AddMinutes(59);
            param.endDate = param.endDate.AddSeconds(59);

            var loans = (from a in context.TBL_LOAN
                         join r in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals r.LOAN_BOOKING_REQUESTID
                         join d in context.TBL_LOAN_APPLICATION_DETAIL on r.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                         join l in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                         join m in context.TBL_CUSTOMER_EMPLOYER on l.RELATEDEMPLOYERID equals m.EMPLOYERID
                         join c in context.TBL_CUSTOMER on r.CUSTOMERID equals c.CUSTOMERID
                         join s in context.TBL_LOAN_STATUS on a.LOANSTATUSID equals s.LOANSTATUSID
                         let p = context.TBL_LOAN_SCHEDULE_PERIODIC.Where(p => p.LOANID == a.TERMLOANID).OrderByDescending(p => p.PAYMENTNUMBER).FirstOrDefault()
                         where ((DbFunctions.TruncateTime(a.BOOKINGDATE) >= DbFunctions.TruncateTime(param.startDate)
                                 && DbFunctions.TruncateTime(a.BOOKINGDATE) <= DbFunctions.TruncateTime(param.endDate)))
                                 && l.ISEMPLOYERRELATED == true
                                 && (r.APPROVEDLINESTATUSID == null || r.APPROVEDLINESTATUSID == 0)
                         select new CamProcessedLoanViewModel
                         {
                             loanBookingRequestId = r.LOAN_BOOKING_REQUESTID,
                             requestDate = r.DATETIMECREATED,
                             requestedAmount = r.AMOUNT_REQUESTED,
                             loanApplicationId = l.LOANAPPLICATIONID,
                             loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                             applicationReferenceNumber = l.APPLICATIONREFERENCENUMBER,
                             casaAccountId = a.CASAACCOUNTID,
                             casaAccountId2 = a.CASAACCOUNTID2,
                             accountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                             customerId = d.CUSTOMERID,
                             customerCode = c.CUSTOMERCODE,
                             customerName = c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME,
                             branchName = l.TBL_BRANCH.BRANCHNAME,
                             bookingDate = a.BOOKINGDATE,
                             maturityDate = a.MATURITYDATE,
                             approvedTenor = d.APPROVEDTENOR,
                             approvedInterestRate = d.APPROVEDINTERESTRATE,
                             //applicationTenor = l.APPLICATIONTENOR,
                             effectiveDate = (DateTime)d.EFFECTIVEDATE,
                             expiryDate = (DateTime)d.EXPIRYDATE,
                             employer = m.EMPLOYER_NAME,
                             loanStatus = s.ACCOUNTSTATUS,
                             //daysPastDue = a.PASTDUEDATE,
                             datePastDue = a.PASTDUEDATE,
                             currencyId = d.CURRENCYID,
                             currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                             exchangeRate = d.EXCHANGERATE,
                             interestRate = a.INTERESTRATE,
                             submittedForAppraisal = l.SUBMITTEDFORAPPRAISAL,
                             approvedAmount = d.APPROVEDAMOUNT,
                             groupApprovedAmount = l.APPROVEDAMOUNT,
                             availmentDate = l.AVAILMENTDATE,
                             repaymentTerms = d.REPAYMENTTERMS,
                             repaymentSchedule = d.TBL_REPAYMENT_TERM.REPAYMENTTERMDETAIL,
                             createdBy = l.OWNEDBY,
                             applicationDate = l.APPLICATIONDATE,
                             dateTimeCreated = d.DATETIMECREATED,
                             monthlyPayment = (p != null) ? p.PERIODPAYMENTAMOUNT : 0
                             //isLocalCurrrency = company.CURRENCYID == d.CURRENCYID ? true : false,
                         }).ToList();

            var contingents = (from a in context.TBL_LOAN_CONTINGENT
                             join r in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals r.LOAN_BOOKING_REQUESTID
                             join d in context.TBL_LOAN_APPLICATION_DETAIL on r.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                             join l in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                             join m in context.TBL_CUSTOMER_EMPLOYER on l.RELATEDEMPLOYERID equals m.EMPLOYERID
                             join c in context.TBL_CUSTOMER on r.CUSTOMERID equals c.CUSTOMERID
                             join s in context.TBL_LOAN_STATUS on a.LOANSTATUSID equals s.LOANSTATUSID
                             where ((DbFunctions.TruncateTime(a.BOOKINGDATE) >= DbFunctions.TruncateTime(param.startDate)
                                     && DbFunctions.TruncateTime(a.BOOKINGDATE) <= DbFunctions.TruncateTime(param.endDate)))
                                     && l.ISEMPLOYERRELATED == true
                                     && (r.APPROVEDLINESTATUSID == null || r.APPROVEDLINESTATUSID == 0)//to exempt the line maintenance tranche
                             select new CamProcessedLoanViewModel
                             {
                                 loanBookingRequestId = r.LOAN_BOOKING_REQUESTID,
                                 requestDate = r.DATETIMECREATED,
                                 requestedAmount = r.AMOUNT_REQUESTED,
                                 loanApplicationId = l.LOANAPPLICATIONID,
                                 loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                 applicationReferenceNumber = l.APPLICATIONREFERENCENUMBER,
                                 casaAccountId = a.CASAACCOUNTID,
                                 casaAccountId2 = a.CASAACCOUNTID2,
                                 accountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                 customerId = d.CUSTOMERID,
                                 customerCode = c.CUSTOMERCODE,
                                 customerName = c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME,
                                 branchName = l.TBL_BRANCH.BRANCHNAME,
                                 bookingDate = a.BOOKINGDATE,
                                 maturityDate = a.MATURITYDATE,
                                 approvedTenor = d.APPROVEDTENOR,
                                 approvedInterestRate = d.APPROVEDINTERESTRATE,
                                 effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                 expiryDate = (DateTime)d.EXPIRYDATE,
                                 employer = m.EMPLOYER_NAME,
                                 loanStatus = s.ACCOUNTSTATUS,
                                 //daysPastDue = a.PASTDUEDATE,
                                 datePastDue = null,
                                 currencyId = d.CURRENCYID,
                                 currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                                 exchangeRate = d.EXCHANGERATE,
                                 interestRate = d.APPROVEDINTERESTRATE,
                                 submittedForAppraisal = l.SUBMITTEDFORAPPRAISAL,
                                 approvedAmount = d.APPROVEDAMOUNT,
                                 groupApprovedAmount = l.APPROVEDAMOUNT,
                                 availmentDate = l.AVAILMENTDATE,
                                 repaymentTerms = d.REPAYMENTTERMS,
                                 repaymentSchedule = d.TBL_REPAYMENT_TERM.REPAYMENTTERMDETAIL,
                                 createdBy = l.OWNEDBY,
                                 applicationDate = l.APPLICATIONDATE,
                                 dateTimeCreated = d.DATETIMECREATED,
                                 monthlyPayment = 0
                             }).ToList();

            var revolving = (from a in context.TBL_LOAN_REVOLVING
                            join r in context.TBL_LOAN_BOOKING_REQUEST on a.LOAN_BOOKING_REQUESTID equals r.LOAN_BOOKING_REQUESTID
                            join d in context.TBL_LOAN_APPLICATION_DETAIL on r.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                            join l in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals l.LOANAPPLICATIONID
                            join m in context.TBL_CUSTOMER_EMPLOYER on l.RELATEDEMPLOYERID equals m.EMPLOYERID
                            join c in context.TBL_CUSTOMER on r.CUSTOMERID equals c.CUSTOMERID
                            join s in context.TBL_LOAN_STATUS on a.LOANSTATUSID equals s.LOANSTATUSID
                            where ((DbFunctions.TruncateTime(a.BOOKINGDATE) >= DbFunctions.TruncateTime(param.startDate)
                                    && DbFunctions.TruncateTime(a.BOOKINGDATE) <= DbFunctions.TruncateTime(param.endDate)))
                                    && l.ISEMPLOYERRELATED == true
                                    && (r.APPROVEDLINESTATUSID == null || r.APPROVEDLINESTATUSID == 0)
                            select new CamProcessedLoanViewModel
                            {
                                loanBookingRequestId = r.LOAN_BOOKING_REQUESTID,
                                requestDate = r.DATETIMECREATED,
                                requestedAmount = r.AMOUNT_REQUESTED,
                                loanApplicationId = l.LOANAPPLICATIONID,
                                loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                applicationReferenceNumber = l.APPLICATIONREFERENCENUMBER,
                                casaAccountId = a.CASAACCOUNTID,
                                casaAccountId2 = r.CASAACCOUNTID2,
                                accountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                customerId = d.CUSTOMERID,
                                customerCode = c.CUSTOMERCODE,
                                customerName = c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME,
                                branchName = l.TBL_BRANCH.BRANCHNAME,
                                bookingDate = a.BOOKINGDATE,
                                maturityDate = a.MATURITYDATE,
                                approvedTenor = d.APPROVEDTENOR,
                                approvedInterestRate = d.APPROVEDINTERESTRATE,
                                effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                expiryDate = (DateTime)d.EXPIRYDATE,
                                employer = m.EMPLOYER_NAME,
                                loanStatus = s.ACCOUNTSTATUS,
                                //daysPastDue = a.PASTDUEDATE,
                                datePastDue = null,
                                currencyId = d.CURRENCYID,
                                currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                                exchangeRate = d.EXCHANGERATE,
                                interestRate = a.INTERESTRATE,
                                submittedForAppraisal = l.SUBMITTEDFORAPPRAISAL,
                                approvedAmount = d.APPROVEDAMOUNT,
                                groupApprovedAmount = l.APPROVEDAMOUNT,
                                availmentDate = l.AVAILMENTDATE,
                                repaymentTerms = d.REPAYMENTTERMS,
                                repaymentSchedule = d.TBL_REPAYMENT_TERM.REPAYMENTTERMDETAIL,
                                createdBy = l.OWNEDBY,
                                applicationDate = l.APPLICATIONDATE,
                                dateTimeCreated = d.DATETIMECREATED,
                                monthlyPayment = 0
                            }).ToList();

            var data = loans.Union(contingents).Union(revolving).ToList();
            //var groups = data.GroupBy(g => g.loanApplicationDetailId);
            foreach(var g in data.GroupBy(l => l.loanApplicationDetailId))
            {
                foreach(var h in g)
                {
                    h.totalUtilized += g.Sum(a => a.requestedAmount);
                }
            }
            return data;
        }

        public IEnumerable<CamProcessedLoanViewModel> GetBookingRequestAwaitingApproval(int staffId, int companyId, bool isInitiation = false)
        {
            List<int> levelIds = new List<int>();
            levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.CorporateDrawdownRequest).ToList());
            levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.IndividualDrawdownRequest).ToList());
            levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.CreditCardDrawdownRequest).ToList());

            List<int> operationIds = new List<int>();
            operationIds.Add((int)OperationsEnum.CorporateDrawdownRequest);
            operationIds.Add((int)OperationsEnum.IndividualDrawdownRequest);
            operationIds.Add((int)OperationsEnum.CreditCardDrawdownRequest);

            List<CamProcessedLoanViewModel> data = new List<CamProcessedLoanViewModel>();

            data = (from req in context.TBL_LOAN_BOOKING_REQUEST
                    join d in context.TBL_LOAN_APPLICATION_DETAIL on req.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                    join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                    join coy in context.TBL_COMPANY on m.COMPANYID equals coy.COMPANYID
                    join p in context.TBL_PRODUCT on d.APPROVEDPRODUCTID equals p.PRODUCTID
                    join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                    join br in context.TBL_BRANCH on m.BRANCHID equals br.BRANCHID
                    join atrail in context.TBL_APPROVAL_TRAIL on req.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                    where (
                              operationIds.Contains(atrail.OPERATIONID)
                              && req.DELETED == false && req.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending
                              && m.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.CAMInProgress
                              && m.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.CancellationCompleted
                              && (((atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing) || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending)
                                        || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Referred)) && (levelIds.Contains((int)atrail.TOAPPROVALLEVELID)) && (atrail.LOOPEDSTAFFID == null))


                              && atrail.RESPONSESTAFFID == null
                          )
                          || (isInitiation == true && req.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved && req.DELETED == false)
                          || ((atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Referred) && atrail.LOOPEDSTAFFID == staffId && atrail.RESPONSESTAFFID == null)
                    orderby d.LOANAPPLICATIONDETAILID descending

                    select new CamProcessedLoanViewModel
                    {
                        divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                        loanBookingRequestId = req.LOAN_BOOKING_REQUESTID,
                        approvalStatusId = (short)atrail.APPROVALSTATUSID,
                        approvalStatusName = atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                        loanApplicationId = m.LOANAPPLICATIONID,
                        loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                        applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                        applicationStatusId = m.APPLICATIONSTATUSID,
                        appraisalOperationId = m.OPERATIONID,
                        operationId = atrail.OPERATIONID, //(short)OperationsEnum.LoanTrancheBookingRequest,
                        requestedAmount = req.AMOUNT_REQUESTED,
                        customerId = m.CUSTOMERID ?? 0,
                        customerCode = cust.CUSTOMERCODE,
                        customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                        customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                        customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                        customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                        isRelatedParty = m.ISRELATEDPARTY,
                        customerSensitivityLevelId = cust.CUSTOMERSENSITIVITYLEVELID,
                        customerOccupation = cust.OCCUPATION,
                        customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                        isPoliticallyExposed = d.TBL_CUSTOMER.ISPOLITICALLYEXPOSED,
                        isInvestmentGrade = m.ISINVESTMENTGRADE,

                        companyId = m.COMPANYID,
                        branchId = m.BRANCHID,
                        branchName = m.TBL_BRANCH.BRANCHNAME,
                        subSectorId = d.SUBSECTORID,
                        subSectorName = d.TBL_SUB_SECTOR.NAME,
                        sectorName = d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                        applicationTenor = m.APPLICATIONTENOR,
                        effectiveDate = (DateTime)d.EFFECTIVEDATE,
                        expiryDate = (DateTime)d.EXPIRYDATE,
                        relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                        relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                        relationshipManagerId = m.RELATIONSHIPMANAGERID,
                        relationshipManagerName = m.TBL_STAFF1.FIRSTNAME + " " + m.TBL_STAFF1.MIDDLENAME + " " + m.TBL_STAFF1.LASTNAME,

                        currencyId = d.CURRENCYID,
                        currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                        exchangeRate = d.EXCHANGERATE,
                        loanTypeId = m.LOANAPPLICATIONTYPEID,
                        loanTypeName = m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                        camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                        productId = d.APPROVEDPRODUCTID,
                        productTypeId = p.PRODUCTTYPEID,
                        productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                        productName = p.PRODUCTNAME,
                        productClassId = p.PRODUCTCLASSID,
                        productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                        productClassProcessId = m.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                        misCode = m.MISCODE,
                        teamMisCode = m.TEAMMISCODE,
                        casaAccountId = req.CASAACCOUNTID,
                        casaAccountId2 = req.CASAACCOUNTID2,

                        interestRate = d.APPROVEDINTERESTRATE,
                        approvedAmount = d.APPROVEDAMOUNT,
                        approvedDate = m.APPROVEDDATE,
                        groupApprovedAmount = m.APPROVEDAMOUNT,
                        approvedTenor = d.APPROVEDTENOR,
                        createdBy = m.OWNEDBY,
                        newApplicationDate = m.APPLICATIONDATE,
                        dateTimeCreated = d.DATETIMECREATED,
                        availmentDate = m.AVAILMENTDATE,
                        requestDate = req.DATETIMECREATED,
                        divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                    }).ToList();

            data = data.Where(x => x.applicationReferenceNumber != "-")
              .GroupBy(p => p.applicationReferenceNumber)
              .Select(g => g.First())
                  .ToList();


            foreach (var item in data)
            {
                var casa1 = context.TBL_CASA.Find(item.casaAccountId);
                var casa2 = context.TBL_CASA.Find(item.casaAccountId2);
                if (casa1 != null) item.accountNumber = casa1.PRODUCTACCOUNTNUMBER;
                if (casa2 != null) item.accountNumber2 = casa2.PRODUCTACCOUNTNUMBER;


                var requests = context.TBL_LOAN_BOOKING_REQUEST.Where(r => r.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);

                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Count() > 0)
                    item.approveRequestAmount = (decimal)requests.Where(k => k.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Sum(s => s.AMOUNT_REQUESTED);

                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                    item.pendingRequestAmount = (decimal)requests.Where(j => j.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount;

                if (requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                    item.allRequestAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount;

                item.disapprovedCount = (int)requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Count();

                if (item.disapprovedCount > 0)
                    item.disApprovedAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Sum(s => s.AMOUNT_REQUESTED);

                item.customerAvailableAmount = item.approvedAmount - (item.allRequestAmount - item.requestedAmount);

                var disbursedLoan = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId && x.ISDISBURSED == true);
                if (disbursedLoan.Any())
                {
                    item.amountDisbursed = disbursedLoan.Sum(c => c.PRINCIPALAMOUNT);
                }
            }

            return data.ToList();
        }

        public IEnumerable<CamProcessedLoanViewModel> GetBookedLoanApplicationForBookingVerification(int staffId, int companyId)
        {
            var company = context.TBL_COMPANY.Find(companyId);
            var canReRouteBooking = context.TBL_PROFILE_ADDITIONALACTIVITY.Where(x => x.USERID == staffId && x.ACTIVITYID == 177).Any();

            var newApplicationDate = generalSetup.GetApplicationDate();

            var data = (from s in context.TBL_LOAN_BOOKING_REQUEST
                        join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                        join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                        join cust in context.TBL_CUSTOMER on s.CUSTOMERID equals cust.CUSTOMERID
                        where d.DELETED == false && s.DELETED == false
                        && m.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                        && s.ISUSED == true
                        && s.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                        && s.ISMAINTAINEDLINE == null
                        && s.ISDISBURSED == false
                        && m.COMPANYID == companyId

                        orderby s.DATETIMECREATED descending
                        select new CamProcessedLoanViewModel
                        {
                            bookingAmountRequested = s.AMOUNT_REQUESTED,
                            loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                            bookingRequestStatusId = s.APPROVALSTATUSID,
                            requestDate = s.DATETIMECREATED,
                            requestedBy = "",
                            systemArrivalDateTime = s.DATETIMECREATED,
                            divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                            divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                            appraisalOperationId = m.OPERATIONID,
                            requestedAmount = s.AMOUNT_REQUESTED,
                            requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                            approvalStatusId = (short)m.APPROVALSTATUSID,
                            loanApplicationId = m.LOANAPPLICATIONID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                            applicationStatusId = m.APPLICATIONSTATUSID,
                            casaAccountId = s.CASAACCOUNTID,
                            casaAccountId2 = s.CASAACCOUNTID2,
                            feeAccountName = (from t in context.TBL_CASA where t.CASAACCOUNTID == s.CASAACCOUNTID select t.PRODUCTACCOUNTNAME + "(" + t.PRODUCTACCOUNTNUMBER + ")").FirstOrDefault(),
                            customerId = d.CUSTOMERID,
                            customerCode = cust.CUSTOMERCODE,
                            customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                            customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                            customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                            customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                            isRelatedParty = m.ISRELATEDPARTY,
                            customerSensitivityLevelId = cust.CUSTOMERSENSITIVITYLEVELID,

                            customerOccupation = cust.OCCUPATION,
                            customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                            isPoliticallyExposed = cust.ISPOLITICALLYEXPOSED,
                            isInvestmentGrade = m.ISINVESTMENTGRADE,
                            newApplicationDate = newApplicationDate,
                            loanInformation = m.LOANINFORMATION,
                            companyId = m.COMPANYID,
                            branchId = m.BRANCHID,
                            branchName = m.TBL_BRANCH.BRANCHNAME,
                            subSectorId = d.SUBSECTORID,
                            subSectorName = d.TBL_SUB_SECTOR.NAME,
                            sectorName = (from y in context.TBL_SECTOR.Where(i => i.SECTORID == d.TBL_SUB_SECTOR.SECTORID) select y).FirstOrDefault().NAME, //d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            applicationTenor = m.APPLICATIONTENOR,
                            effectiveDate = (DateTime)d.EFFECTIVEDATE,
                            expiryDate = (DateTime)d.EXPIRYDATE,
                            canReRouteBooking = canReRouteBooking,
                            ////isTemporaryOverdraft = p.TBL_PRODUCT_BEHAVIOUR.FirstOrDefault() != null ? p.TBL_PRODUCT_BEHAVIOUR.FirstOrDefault().ISTEMPORARYOVERDRAFT : false,

                            // relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                            relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                            //relationshipManagerId = m.RELATIONSHIPMANAGERID,

                            //relationshipManagerId = m.TBL_STAFF.SUPERVISOR_STAFFID.Value,
                            relationshipManagerName = (from r in context.TBL_STAFF where r.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID.Value select r.FIRSTNAME + " " + r.LASTNAME).FirstOrDefault(), //.FirstOrDefault()?.FIRSTNAME + " " + context.TBL_STAFF.Where(O => O.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID.Value).FirstOrDefault()?.MIDDLENAME + " " + context.TBL_STAFF.Where(O => O.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID.Value).FirstOrDefault().LASTNAME,


                            currencyId = d.CURRENCYID,
                            currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                            exchangeRate = d.EXCHANGERATE,
                            loanTypeId = m.LOANAPPLICATIONTYPEID,
                            loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME,
                            // //camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                            productId = s.PRODUCTID,
                            productTypeId = p.PRODUCTTYPEID,
                            productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                            productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            productName = p.PRODUCTNAME,
                            productClassId = p.PRODUCTCLASSID,
                            //productClassProcessId = p.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                            productScheduleTypeId = p.SCHEDULETYPEID,
                            productDealTypeId = p.DEALTYPEID,
                            productDayCountConventionId = p.TBL_PRODUCT_CURRENCY.Select(x => x.DAYCOUNTCONVENTIONID).FirstOrDefault() ?? 0, // p.DAYCOUNTCONVENTIONID,
                            misCode = m.MISCODE,
                            teamMisCode = m.TEAMMISCODE,

                            interestRate = d.APPROVEDINTERESTRATE,
                            approvedInterestRate = d.APPROVEDINTERESTRATE,
                            submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                            approvedAmount = d.APPROVEDAMOUNT,
                            groupApprovedAmount = m.APPROVEDAMOUNT,
                            availmentDate = m.AVAILMENTDATE,
                            isBidbond = p.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees ? true : false,
                            isOverdraft = p.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan ? true : false,
                            repaymentTerms = d.REPAYMENTTERMS,
                            repaymentSchedule = d.TBL_REPAYMENT_TERM.REPAYMENTTERMDETAIL,
                            approvedTenor = d.APPROVEDTENOR,
                            createdBy = m.OWNEDBY,
                            applicationDate = m.APPLICATIONDATE,
                            dateTimeCreated = d.DATETIMECREATED,
                            loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,
                            isLocalCurrrency = company.CURRENCYID == d.CURRENCYID ? true : false,
                            crmsCode = s.CRMSCODE,
                            accountToCredit = (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == s.CASAACCOUNTID) select y.PRODUCTACCOUNTNUMBER).FirstOrDefault() +
                            "(" + (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == s.CASAACCOUNTID) select y.PRODUCTACCOUNTNAME).FirstOrDefault() + ")",
                        }).ToList().Take(60);

            //var books = data.Where(d => d.loanBookingRequestId == 1380).ToList();


            foreach (var item in data)
            {
                item.isBooked = context.TBL_LOAN.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId).Any();

                int operationId = 0;
                if (item.productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                    operationId = (short)OperationsEnum.ContigentLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
                    operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
                    operationId = (short)OperationsEnum.CommercialLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.TermLoan || item.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating || item.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                    operationId = (short)OperationsEnum.TermLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                    operationId = (short)OperationsEnum.RevolvingLoanBooking;

                item.operationId = operationId;

                var trailInfo = context.TBL_APPROVAL_TRAIL.Where(x => x.OPERATIONID == operationId && x.TARGETID == item.loanBookingRequestId);
                if (trailInfo.Any())
                {
                    item.isUnderApproval = true;
                    foreach (var trail in trailInfo)
                    {
                        if (trail.RESPONSESTAFFID == null)
                        {
                            item.currentApprovalLevelId = trail.TOAPPROVALLEVELID;
                            var routedStaffRecord = context.TBL_STAFF.Where(x => x.STAFFID == trail.TOSTAFFID).FirstOrDefault();
                            if (routedStaffRecord != null) item.routedToStaff = routedStaffRecord.FIRSTNAME + " " + routedStaffRecord.LASTNAME;
                        }

                    }
                }

                var loans = context.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var overdrafts = context.TBL_LOAN_REVOLVING.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var contingents = context.TBL_LOAN_CONTINGENT.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);


                var productBehaviour = context.TBL_PRODUCT_BEHAVIOUR.Where(x => x.PRODUCTID == item.productId).FirstOrDefault();
                if (productBehaviour != null)
                    item.isTemporaryOverdraft = productBehaviour.ISTEMPORARYOVERDRAFT;

                switch (item.productTypeId)
                {
                    case (short)LoanProductTypeEnum.TermLoan:
                        decimal customerAvailableAmount = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount;
                        item.loanId = loans.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId)?.TERMLOANID;
                        break;
                    case (short)LoanProductTypeEnum.CommercialLoan:
                        decimal customerAvailableAmount2 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount2 = customerAvailableAmount2 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount2;
                        item.loanId = loans.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId)?.TERMLOANID;
                        break;
                    case (short)LoanProductTypeEnum.SelfLiquidating:
                        decimal customerAvailableAmount3 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount3 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount3;
                        item.loanId = loans.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId)?.TERMLOANID;
                        break;
                    case (short)LoanProductTypeEnum.RevolvingLoan:
                        decimal overdraftBal = 0;
                        foreach (var overdraft in overdrafts)
                        {
                            if (overdraft.OVERDRAFTLIMIT > 0) overdraftBal = overdraftBal + overdraft.OVERDRAFTLIMIT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - overdraftBal;
                        item.loanId = overdrafts.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId)?.REVOLVINGLOANID;
                        break;
                    case (short)LoanProductTypeEnum.ContingentLiability:
                        decimal contingentBal = 0;
                        foreach (var contingent in contingents)
                        {
                            if (contingent.CONTINGENTAMOUNT > 0) contingentBal = contingentBal + contingent.CONTINGENTAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - contingentBal;
                        item.loanId = contingents.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId)?.CONTINGENTLOANID;
                        break;
                }

                if (item.operationId == (short)OperationsEnum.TermLoanBooking || item.operationId == (short)OperationsEnum.CommercialLoanBooking || item.operationId == (short)OperationsEnum.ForeignExchangeLoanBooking)
                {
                    var priceIndex = context.TBL_PRODUCT_PRICE_INDEX.Find(item.productPriceIndexId);
                    var interestRate = Convert.ToDouble(item.approvedInterestRate);
                    if (priceIndex != null)
                    {
                        item.interestRate = priceIndex.PRICEINDEXRATE + interestRate;
                        item.productPriceIndex = priceIndex.PRICEINDEXNAME;
                        item.productPriceDescription = priceIndex.PRICEINDEXDESCRIPTION;
                    }
                }
            }

            // data = data.Where(x => x.customerAvailableAmount!= null && x.customerAvailableAmount > 0 ).ToList();
            IEnumerable<LoanViewModel> bookedDataRecord = GetLoanFacilityBookingAwaitingApproval(staffId, companyId).Where(x => x.loanStatusId == (short)LoanStatusEnum.Inactive).ToList();
            IEnumerable<RevolvingLoanViewModel> revolvingFacilityRecord = GetRevolvingFacilityBookingAwaitingApproval(staffId, companyId).Where(x => x.loanStatusId == (short)LoanStatusEnum.Inactive).ToList();

            foreach (var item in bookedDataRecord)
            {
                foreach (var datum in data)
                {
                    if (datum.loanApplicationDetailId == item.loanApplicationDetailId && datum.loanBookingRequestId == item.loanBookingRequestId)
                    {
                        if (!datum.customerAvailableAmount.HasValue)
                            datum.customerAvailableAmount = item.approvedAmount;

                        datum.bookedLoanData = item;
                        datum.applicationReferenceNumber = item.applicationReferenceNumber;
                        datum.loanReferenceNumber = item.loanReferenceNumber;
                        //data.Add(applicationRecord);
                    }
                }
            }

            foreach (var item in revolvingFacilityRecord)
            {
                //var applicationRecord = data.Where(x =>  x.loanApplicationDetailId == item.loanApplicationDetailId && x.loanBookingRequestId == item.loanBookingRequestId).FirstOrDefault();
                //if (applicationRecord != null && !applicationRecord.customerAvailableAmount.HasValue)
                //    applicationRecord.customerAvailableAmount = item.approvedAmount;

                //if (applicationRecord != null)
                //{
                //    applicationRecord.bookedRevolvingFacilityData = item;
                //    applicationRecord.applicationReferenceNumber = item.applicationReferenceNumber;
                //    applicationRecord.loanReferenceNumber = item.loanReferenceNumber;
                //    data.Add(applicationRecord);
                //}

                foreach (var datum in data)
                {
                    if (datum.loanApplicationDetailId == item.loanApplicationDetailId && datum.loanBookingRequestId == item.loanBookingRequestId)
                    {
                        if (!datum.customerAvailableAmount.HasValue)
                            datum.customerAvailableAmount = item.approvedAmount;

                        datum.bookedRevolvingFacilityData = item;
                        datum.applicationReferenceNumber = item.applicationReferenceNumber;
                        datum.loanReferenceNumber = item.loanReferenceNumber;
                        //data.Add(applicationRecord);
                    }
                }
            }

            var books2 = data.Where(d => d.loanReferenceNumber != null).ToList();
            return data.Where(x => x.loanReferenceNumber != null); //.Distinct().ToList();
        }


        public IEnumerable<CamProcessedLoanViewModel> GetBookedLoanApplicationForBookingVerificationParam(int staffId, int companyId, string searchString)
        {
            var company = context.TBL_COMPANY.Find(companyId);
            var canReRouteBooking = context.TBL_PROFILE_ADDITIONALACTIVITY.Where(x => x.USERID == staffId && x.ACTIVITYID == 177).Any();

            var newApplicationDate = generalSetup.GetApplicationDate();

            var data = (from s in context.TBL_LOAN_BOOKING_REQUEST
                        join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                        join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                        join cust in context.TBL_CUSTOMER on s.CUSTOMERID equals cust.CUSTOMERID
                        where m.APPLICATIONREFERENCENUMBER == searchString
                        && d.DELETED == false && s.DELETED == false
                        && m.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                        && s.ISUSED == true
                        && s.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                        && s.ISMAINTAINEDLINE == null
                        && s.ISDISBURSED == false

                        orderby s.DATETIMECREATED descending
                        select new CamProcessedLoanViewModel
                        {
                            bookingAmountRequested = s.AMOUNT_REQUESTED,
                            loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                            bookingRequestStatusId = s.APPROVALSTATUSID,
                            requestDate = s.DATETIMECREATED,
                            requestedBy = "",
                            systemArrivalDateTime = s.DATETIMECREATED,
                            divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                            divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                            appraisalOperationId = m.OPERATIONID,
                            requestedAmount = s.AMOUNT_REQUESTED,
                            requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                            approvalStatusId = (short)m.APPROVALSTATUSID,
                            loanApplicationId = m.LOANAPPLICATIONID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                            applicationStatusId = m.APPLICATIONSTATUSID,
                            casaAccountId = s.CASAACCOUNTID,
                            casaAccountId2 = s.CASAACCOUNTID2,
                            feeAccountName = (from t in context.TBL_CASA where t.CASAACCOUNTID == s.CASAACCOUNTID select t.PRODUCTACCOUNTNAME + "(" + t.PRODUCTACCOUNTNUMBER + ")").FirstOrDefault(),
                            customerId = d.CUSTOMERID,
                            customerCode = cust.CUSTOMERCODE,
                            customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                            customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                            customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                            customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                            isRelatedParty = m.ISRELATEDPARTY,
                            customerSensitivityLevelId = cust.CUSTOMERSENSITIVITYLEVELID,

                            customerOccupation = cust.OCCUPATION,
                            customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                            isPoliticallyExposed = cust.ISPOLITICALLYEXPOSED,
                            isInvestmentGrade = m.ISINVESTMENTGRADE,
                            newApplicationDate = newApplicationDate,
                            loanInformation = m.LOANINFORMATION,
                            companyId = m.COMPANYID,
                            branchId = m.BRANCHID,
                            branchName = m.TBL_BRANCH.BRANCHNAME,
                            subSectorId = d.SUBSECTORID,
                            subSectorName = d.TBL_SUB_SECTOR.NAME,
                            sectorName = (from y in context.TBL_SECTOR.Where(i => i.SECTORID == d.TBL_SUB_SECTOR.SECTORID) select y).FirstOrDefault().NAME, //d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            applicationTenor = m.APPLICATIONTENOR,
                            effectiveDate = (DateTime)d.EFFECTIVEDATE,
                            expiryDate = (DateTime)d.EXPIRYDATE,
                            canReRouteBooking = canReRouteBooking,
                            ////isTemporaryOverdraft = p.TBL_PRODUCT_BEHAVIOUR.FirstOrDefault() != null ? p.TBL_PRODUCT_BEHAVIOUR.FirstOrDefault().ISTEMPORARYOVERDRAFT : false,

                            // relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                            relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                            //relationshipManagerId = m.RELATIONSHIPMANAGERID,

                            //relationshipManagerId = m.TBL_STAFF.SUPERVISOR_STAFFID.Value,
                            relationshipManagerName = (from r in context.TBL_STAFF where r.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID.Value select r.FIRSTNAME + " " + r.LASTNAME).FirstOrDefault(), //.FirstOrDefault()?.FIRSTNAME + " " + context.TBL_STAFF.Where(O => O.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID.Value).FirstOrDefault()?.MIDDLENAME + " " + context.TBL_STAFF.Where(O => O.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID.Value).FirstOrDefault().LASTNAME,


                            currencyId = d.CURRENCYID,
                            currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                            exchangeRate = d.EXCHANGERATE,
                            loanTypeId = m.LOANAPPLICATIONTYPEID,
                            loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME,
                            // //camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                            productId = s.PRODUCTID,
                            productTypeId = p.PRODUCTTYPEID,
                            productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                            productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            productName = p.PRODUCTNAME,
                            productClassId = p.PRODUCTCLASSID,
                            //productClassProcessId = p.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                            productScheduleTypeId = p.SCHEDULETYPEID,
                            productDealTypeId = p.DEALTYPEID,
                            productDayCountConventionId = p.TBL_PRODUCT_CURRENCY.Select(x => x.DAYCOUNTCONVENTIONID).FirstOrDefault() ?? 0, // p.DAYCOUNTCONVENTIONID,
                            misCode = m.MISCODE,
                            teamMisCode = m.TEAMMISCODE,

                            interestRate = d.APPROVEDINTERESTRATE,
                            approvedInterestRate = d.APPROVEDINTERESTRATE,
                            submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                            approvedAmount = d.APPROVEDAMOUNT,
                            groupApprovedAmount = m.APPROVEDAMOUNT,
                            availmentDate = m.AVAILMENTDATE,
                            isBidbond = p.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees ? true : false,
                            isOverdraft = p.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan ? true : false,
                            repaymentTerms = d.REPAYMENTTERMS,
                            repaymentSchedule = d.TBL_REPAYMENT_TERM.REPAYMENTTERMDETAIL,
                            approvedTenor = d.APPROVEDTENOR,
                            createdBy = m.OWNEDBY,
                            applicationDate = m.APPLICATIONDATE,
                            dateTimeCreated = d.DATETIMECREATED,
                            loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,
                            isLocalCurrrency = company.CURRENCYID == d.CURRENCYID ? true : false,
                            crmsCode = s.CRMSCODE,

                        }).ToList();

            //var books = data.Where(d => d.loanBookingRequestId == 1380).ToList();
            var test = data.Where(d => d.applicationReferenceNumber.Contains("1267369410910")).ToList();


            foreach (var item in data)
            {
                item.isBooked = context.TBL_LOAN.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId).Any();

                int operationId = 0;
                if (item.productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                    operationId = (short)OperationsEnum.ContigentLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
                    operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
                    operationId = (short)OperationsEnum.CommercialLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.TermLoan || item.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating || item.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                    operationId = (short)OperationsEnum.TermLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                    operationId = (short)OperationsEnum.RevolvingLoanBooking;

                item.operationId = operationId;

                var trailInfo = context.TBL_APPROVAL_TRAIL.Where(x => x.OPERATIONID == operationId && x.TARGETID == item.loanBookingRequestId);
                if (trailInfo.Any())
                {
                    item.isUnderApproval = true;
                    foreach (var trail in trailInfo)
                    {
                        if (trail.RESPONSESTAFFID == null)
                        {
                            item.currentApprovalLevelId = trail.TOAPPROVALLEVELID;
                            var routedStaffRecord = context.TBL_STAFF.Where(x => x.STAFFID == trail.TOSTAFFID).FirstOrDefault();
                            if (routedStaffRecord != null) item.routedToStaff = routedStaffRecord.FIRSTNAME + " " + routedStaffRecord.LASTNAME;
                        }

                    }
                }

                var loans = context.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var overdrafts = context.TBL_LOAN_REVOLVING.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var contingents = context.TBL_LOAN_CONTINGENT.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);


                var productBehaviour = context.TBL_PRODUCT_BEHAVIOUR.Where(x => x.PRODUCTID == item.productId).FirstOrDefault();
                if (productBehaviour != null)
                    item.isTemporaryOverdraft = productBehaviour.ISTEMPORARYOVERDRAFT;

                switch (item.productTypeId)
                {
                    case (short)LoanProductTypeEnum.TermLoan:
                        decimal customerAvailableAmount = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount;
                        item.loanId = loans.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId)?.TERMLOANID;
                        break;
                    case (short)LoanProductTypeEnum.CommercialLoan:
                        decimal customerAvailableAmount2 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount2 = customerAvailableAmount2 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount2;
                        item.loanId = loans.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId)?.TERMLOANID;
                        break;
                    case (short)LoanProductTypeEnum.SelfLiquidating:
                        decimal customerAvailableAmount3 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount3 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount3;
                        item.loanId = loans.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId)?.TERMLOANID;
                        break;
                    case (short)LoanProductTypeEnum.RevolvingLoan:
                        decimal overdraftBal = 0;
                        foreach (var overdraft in overdrafts)
                        {
                            if (overdraft.OVERDRAFTLIMIT > 0) overdraftBal = overdraftBal + overdraft.OVERDRAFTLIMIT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - overdraftBal;
                        item.loanId = overdrafts.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId)?.REVOLVINGLOANID;
                        break;
                    case (short)LoanProductTypeEnum.ContingentLiability:
                        decimal contingentBal = 0;
                        foreach (var contingent in contingents)
                        {
                            if (contingent.CONTINGENTAMOUNT > 0) contingentBal = contingentBal + contingent.CONTINGENTAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - contingentBal;
                        item.loanId = contingents.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId)?.CONTINGENTLOANID;
                        break;
                }

                if (item.operationId == (short)OperationsEnum.TermLoanBooking || item.operationId == (short)OperationsEnum.CommercialLoanBooking || item.operationId == (short)OperationsEnum.ForeignExchangeLoanBooking)
                {
                    var priceIndex = context.TBL_PRODUCT_PRICE_INDEX.Find(item.productPriceIndexId);
                    var interestRate = Convert.ToDouble(item.approvedInterestRate);
                    if (priceIndex != null)
                    {
                        item.interestRate = priceIndex.PRICEINDEXRATE + interestRate;
                        item.productPriceIndex = priceIndex.PRICEINDEXNAME;
                        item.productPriceDescription = priceIndex.PRICEINDEXDESCRIPTION;
                    }
                }
            }

            // data = data.Where(x => x.customerAvailableAmount!= null && x.customerAvailableAmount > 0 ).ToList();

            IEnumerable<LoanViewModel> bookedDataRecord = GetLoanFacilityBookingAwaitingApproval(staffId, companyId).Where(x => x.loanStatusId == (short)LoanStatusEnum.Inactive).ToList();
            IEnumerable<RevolvingLoanViewModel> revolvingFacilityRecord = GetRevolvingFacilityBookingAwaitingApproval(staffId, companyId).Where(x => x.loanStatusId == (short)LoanStatusEnum.Inactive).ToList();

            foreach (var item in bookedDataRecord)
            {
                foreach (var datum in data)
                {
                    if (datum.loanApplicationDetailId == item.loanApplicationDetailId && datum.loanBookingRequestId == item.loanBookingRequestId)
                    {
                        if (!datum.customerAvailableAmount.HasValue)
                            datum.customerAvailableAmount = item.approvedAmount;

                        datum.bookedLoanData = item;
                        datum.applicationReferenceNumber = item.applicationReferenceNumber;
                        datum.loanReferenceNumber = item.loanReferenceNumber;
                        //data.Add(applicationRecord);
                    }
                }
            }

            foreach (var item in revolvingFacilityRecord)
            {
                //var applicationRecord = data.Where(x =>  x.loanApplicationDetailId == item.loanApplicationDetailId && x.loanBookingRequestId == item.loanBookingRequestId).FirstOrDefault();
                //if (applicationRecord != null && !applicationRecord.customerAvailableAmount.HasValue)
                //    applicationRecord.customerAvailableAmount = item.approvedAmount;

                //if (applicationRecord != null)
                //{
                //    applicationRecord.bookedRevolvingFacilityData = item;
                //    applicationRecord.applicationReferenceNumber = item.applicationReferenceNumber;
                //    applicationRecord.loanReferenceNumber = item.loanReferenceNumber;
                //    data.Add(applicationRecord);
                //}

                foreach (var datum in data)
                {
                    if (datum.loanApplicationDetailId == item.loanApplicationDetailId && datum.loanBookingRequestId == item.loanBookingRequestId)
                    {
                        if (!datum.customerAvailableAmount.HasValue)
                            datum.customerAvailableAmount = item.approvedAmount;

                        datum.bookedRevolvingFacilityData = item;
                        datum.applicationReferenceNumber = item.applicationReferenceNumber;
                        datum.loanReferenceNumber = item.loanReferenceNumber;
                        //data.Add(applicationRecord);
                    }
                }
            }

            //var books2 = data.Where(d => d.loanBookingRequestId == 1380).ToList();
            return data.Where(x => x.loanReferenceNumber != null); //.Distinct().ToList();
        }

        public IEnumerable<LoanViewModel> GetLoanFacilityBookingAwaitingApproval(int staffId, int companyId)
        {
            var ids = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.TermLoanBooking).ToList();
            List<int> operationIds = new List<int>();
            operationIds.Add((int)OperationsEnum.TermLoanBooking);
            operationIds.Add((int)OperationsEnum.CommercialLoanBooking);
            operationIds.Add((int)OperationsEnum.ForeignExchangeLoanBooking);

            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

            var data = (from ln in context.TBL_LOAN
                        join coy in context.TBL_COMPANY on ln.COMPANYID equals coy.COMPANYID
                        join req in context.TBL_LOAN_BOOKING_REQUEST on ln.LOAN_BOOKING_REQUESTID equals req.LOAN_BOOKING_REQUESTID
                        join d in context.TBL_LOAN_APPLICATION_DETAIL on req.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                        join a in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals a.LOANAPPLICATIONID
                        join cust in context.TBL_CUSTOMER on ln.CUSTOMERID equals cust.CUSTOMERID
                        join p in context.TBL_PRODUCT on ln.PRODUCTID equals p.PRODUCTID
                        join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                        join atrail in context.TBL_APPROVAL_TRAIL on req.LOAN_BOOKING_REQUESTID equals atrail.TARGETID

                        where (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending)
                              && operationIds.Contains(atrail.OPERATIONID)
                              && ln.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility
                              && p.PRODUCTTYPEID != (short)LoanProductTypeEnum.RevolvingLoan
                              //&& ln.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan
                              && req.DELETED == false && req.ISUSED == true
                              && req.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                              && ln.LOANSTATUSID == (short)LoanStatusEnum.Inactive
                              && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                              && atrail.RESPONSESTAFFID == null

                        orderby ln.TERMLOANID descending

                        select new LoanViewModel()
                        {
                            divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                            divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                            loanId = ln.TERMLOANID,
                            operationId = ln.OPERATIONID,
                            operationTypeId = atrail.OPERATIONID,
                            appraisalOperationId = a.OPERATIONID,
                            loanBookingRequestId = req.LOAN_BOOKING_REQUESTID,
                            applicationReferenceNumber = a.APPLICATIONREFERENCENUMBER,
                            loanReferenceNumber = ln.LOANREFERENCENUMBER,
                            customerId = ln.CUSTOMERID,
                            productId = ln.PRODUCTID,
                            casaAccountId = ln.CASAACCOUNTID,
                            casaAccountId2 = ln.CASAACCOUNTID2,
                            casaAccountNumber = (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID) select y.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                            casaAccountDetails = (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID) select y.PRODUCTACCOUNTNUMBER).FirstOrDefault(), // + (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID) select y.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                                                                                                                                                              // ln.TBL_CASA.PRODUCTACCOUNTNUMBER + " (" + ln.TBL_CASA.PRODUCTACCOUNTNAME + ") ",
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            loanApplicationId = a.LOANAPPLICATIONID,
                            currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == ln.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //ln.TBL_CURRENCY.CURRENCYCODE,
                            branchId = ln.BRANCHID,
                            //crmsCode = ln.CRMSCODE,
                            staffId = staffId,
                            timeIn = atrail.SYSTEMARRIVALDATETIME,
                            pricipalFrequencyTypeName = (from y in context.TBL_FREQUENCY_TYPE.Where(i => i.FREQUENCYTYPEID == ln.PRINCIPALFREQUENCYTYPEID) select y.DESCRIPTION).FirstOrDefault(), //ln.TBL_FREQUENCY_TYPE.DESCRIPTION ?? null,
                            interestFrequencyTypeName = (from y in context.TBL_FREQUENCY_TYPE.Where(i => i.FREQUENCYTYPEID == ln.INTERESTFREQUENCYTYPEID) select y.DESCRIPTION).FirstOrDefault(), //ln.TBL_FREQUENCY_TYPE1.DESCRIPTION ?? null,
                            scheduleDayCountConventionId = ln.SCHEDULEDAYCOUNTCONVENTIONID,
                            principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                            interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                            misCode = ln.MISCODE,
                            teamMiscode = ln.TEAMMISCODE,
                            interestRate = ln.INTERESTRATE,
                            effectiveDate = ln.EFFECTIVEDATE,
                            bookedAmount = ln.PRINCIPALAMOUNT,

                            maturityDate = ln.MATURITYDATE,
                            bookingDate = ln.BOOKINGDATE,
                            principalAmount = ln.PRINCIPALAMOUNT,
                            principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                            interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                            approvalStatusId = ln.APPROVALSTATUSID,
                            approvedBy = ln.APPROVEDBY,
                            approverComment = ln.APPROVERCOMMENT,
                            dateApproved = ln.DATEAPPROVED,
                            scheduleTypeId = ln.SCHEDULETYPEID,
                            isDisbursed = ln.ISDISBURSED,
                            disbursedBy = ln.DISBURSEDBY,
                            disburserComment = ln.DISBURSERCOMMENT,
                            disburseDate = ln.DISBURSEDATE,
                            disbursableAmount = ln.PRINCIPALAMOUNT,
                            approvedAmount = d.APPROVEDAMOUNT,
                            loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                            customerGroupId = a.CUSTOMERGROUPID,

                            loanTypeId = a.LOANAPPLICATIONTYPEID,
                            equityContribution = ln.EQUITYCONTRIBUTION,
                            subSectorId = ln.SUBSECTORID,
                            //subSectorName = (from y in context.TBL_SUB_SECTOR.Where(i => i.SUBSECTORID == ln.SUBSECTORID) select y.NAME).FirstOrDefault(), //ln.TBL_SUB_SECTOR.NAME,
                            //sectorName = (from y in context.TBL_SECTOR join s in context.TBL_SUB_SECTOR on y.SECTORID equals s.SECTORID where s.SUBSECTORID == ln.SUBSECTORID select y.NAME).FirstOrDefault(), //ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,

                            firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                            firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                            outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                            principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                            interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID,
                            principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID,
                            principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                            fixedPrincipal = ln.FIXEDPRINCIPAL,
                            profileLoan = ln.PROFILELOAN,
                            dischargeLetter = ln.DISCHARGELETTER,
                            suspendInterest = ln.SUSPENDINTEREST,
                            productPriceIndexId = ln.PRODUCTPRICEINDEXID ?? 0,

                            scheduled = ln.ISSCHEDULEDPREPAYMENT,
                            isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                            scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                            scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,

                            firstName = cust.FIRSTNAME,
                            middleName = cust.MIDDLENAME,
                            lastName = cust.LASTNAME,
                            customerCode = cust.CUSTOMERCODE,
                            productAccountName = p.PRODUCTNAME,
                            productAccountName2 = (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID2) select y.PRODUCTACCOUNTNUMBER).FirstOrDefault() + (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID2) select y.PRODUCTACCOUNTNAME).FirstOrDefault(),
                            //accountToCredit = (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID2) select y.PRODUCTACCOUNTNUMBER).FirstOrDefault() + (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID2) select y.PRODUCTACCOUNTNAME).FirstOrDefault(),
                            //ln.TBL_CASA.PRODUCTACCOUNTNUMBER + " - (" + ln.TBL_CASA.PRODUCTACCOUNTNAME + ")",
                            loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == a.LOANAPPLICATIONTYPEID) select y.LOANAPPLICATIONTYPENAME).FirstOrDefault(), //a.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            customerName = cust.LASTNAME + " " + cust.FIRSTNAME + " " + cust.MIDDLENAME,
                            currencyId = ln.CURRENCYID,
                            branchName = (from y in context.TBL_BRANCH.Where(i => i.BRANCHID == ln.BRANCHID) select y.BRANCHNAME).FirstOrDefault(),// ln.TBL_BRANCH.BRANCHNAME,
                                                                                                                                                   //relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,                                                                                                                                              //relationshipManagerName = ln.TBL_STAFF1.FIRSTNAME + " " + ln.TBL_STAFF1.MIDDLENAME + " " + ln.TBL_STAFF1.LASTNAME,
                            productClassId = p.PRODUCTCLASSID,
                            productTypeId = p.PRODUCTTYPEID,
                            productName = p.PRODUCTNAME,
                            productTypeName = (from y in context.TBL_PRODUCT_TYPE.Where(i => i.PRODUCTTYPEID == p.PRODUCTTYPEID) select y.PRODUCTTYPENAME).FirstOrDefault(), //p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            loanStatusName = (from y in context.TBL_LOAN_STATUS.Where(i => i.LOANSTATUSID == ln.LOANSTATUSID) select y.ACCOUNTSTATUS).FirstOrDefault(), //ln.TBL_LOAN_STATUS.ACCOUNTSTATUS,

                            createdBy = ln.CREATEDBY,
                            //creatorName = ln.TBL_STAFF.LASTNAME + " " + ln.TBL_STAFF.FIRSTNAME + " (" + ln.TBL_STAFF.STAFFCODE + ")",
                            dateTimeCreated = ln.DATETIMECREATED,
                            comment = atrail.COMMENT,
                            isBidbond = false,
                            isOverdraft = false,

                            requestStatusId = req.APPROVALSTATUSID,
                            requestDeleted = req.DELETED,
                            loanStatusId = ln.LOANSTATUSID,
                            nostroRateCodeId = ln.NOSTRORATECODEID,
                            nostroRateAmount = ln.NOSTRORATEAMOUNT,
                            nostroAccountId = ln.NOSTROACCOUNTID,
                            principalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.DESCRIPTION ?? null,
                            subSectorName = ln.TBL_SUB_SECTOR.NAME,
                            sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                            relationshipManagerName = ln.TBL_STAFF1.FIRSTNAME + " " + ln.TBL_STAFF1.MIDDLENAME + " " + ln.TBL_STAFF1.LASTNAME,

                            //crmsRepaymentAgreementTypeId = ln.CRMSREPAYMENTAGREEMENTID,

                            loanCollateral = (from cm in context.TBL_LOAN_COLLATERAL_MAPPING
                                              join cc in context.TBL_COLLATERAL_CUSTOMER on cm.COLLATERALCUSTOMERID equals cc.COLLATERALCUSTOMERID
                                              join ct in context.TBL_COLLATERAL_TYPE on cc.COLLATERALTYPEID equals ct.COLLATERALTYPEID
                                              where cm.LOANID == ln.TERMLOANID && cm.LOANSYSTEMTYPEID == ln.LOANSYSTEMTYPEID
                                              select (new LoanCollateralMappingViewModel
                                              {
                                                  collateralTypeName = ct.COLLATERALTYPENAME
                                                           + "(" + ct.TBL_COLLATERAL_TYPE_SUB.FirstOrDefault().COLLATERALSUBTYPENAME + ")",
                                                  collateralCustomerId = cm.COLLATERALCUSTOMERID,
                                                  collateralValue = cc.COLLATERALVALUE,
                                                  hairCut = cc.HAIRCUT,
                                                  valuationCycle = cc.VALUATIONCYCLE,
                                                  currencyId = cc.CURRENCYID,
                                                  currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == cc.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //cc.TBL_CURRENCY.CURRENCYCODE,
                                                  currency = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == cc.CURRENCYID) select y.CURRENCYNAME).FirstOrDefault(),
                                                  //cc.TBL_CURRENCY.CURRENCYNAME
                                              })).ToList(),
                            loanBeneficiary = (from i in context.TBL_LOAN_DISBURSEMENT.Where(x => x.TERMLOANID == ln.TERMLOANID)
                                               select (
                                                        new LoanDisbursementViewModel
                                                        {
                                                            amountDisbursed = i.AMOUNTDISBURSED,
                                                            beneficiaryReason = i.NARRATION,
                                                            loanDisbursementId = i.LOANDISBURSEMENTID
                                                        })).ToList(),

                            monitoringTriggers = (from i in context.TBL_LOAN_MONITORING_TRIGGER.Where(x => x.LOANID == ln.TERMLOANID && x.LOANSYSTEMTYPEID == ln.LOANSYSTEMTYPEID)
                                                  select (
                                                           new LoanMonitoringTriggerViewModel
                                                           {
                                                               loanMonitoringTriggerId = i.LOAN_MONITORING_TRIGGERID,
                                                               loanSystemTypeId = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                                                               monitoringTriggerId = i.MONITORING_TRIGGERID,
                                                               monitoringTrigger = i.MONITORING_TRIGGER,
                                                               monitoringTriggerSetupName = (from y in context.TBL_LOAN_MONITORING_TRIG_SETUP.Where(d => d.MONITORING_TRIGGERID == i.MONITORING_TRIGGERID) select y.MONITORING_TRIGGER_NAME).FirstOrDefault(), // i.TBL_LOAN_MONITORING_TRIG_SETUP.MONITORING_TRIGGER_NAME,
                                                           })).ToList(),

                        }).ToList();
            
            var test = data.Where(d => d.applicationReferenceNumber.Contains("1282210277431")).ToList();
            List<LoanViewModel> lcyLoans = new List<LoanViewModel>();
            List<LoanViewModel> fcyLoans = new List<LoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = data.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
            }

            if (isFCYUser == true)
            {
                fcyLoans = data.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            data = lcyLoans.Union(fcyLoans).ToList();
            var test2 = data.Where(d => d.applicationReferenceNumber.Contains("1282210277431")).ToList();
            return data;


        }

        public IEnumerable<RevolvingLoanViewModel> GetRevolvingFacilityBookingAwaitingApproval(int staffId, int companyId)
        {
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);

            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

            var ids = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.TermLoanBooking).ToList();

            var data = (from ln in context.TBL_LOAN_REVOLVING
                        join coy in context.TBL_COMPANY on ln.COMPANYID equals coy.COMPANYID
                        join req in context.TBL_LOAN_BOOKING_REQUEST on ln.LOAN_BOOKING_REQUESTID equals req.LOAN_BOOKING_REQUESTID
                        join d in context.TBL_LOAN_APPLICATION_DETAIL on req.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                        join a in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals a.LOANAPPLICATIONID
                        join cust in context.TBL_CUSTOMER on ln.CUSTOMERID equals cust.CUSTOMERID
                        join p in context.TBL_PRODUCT on ln.PRODUCTID equals p.PRODUCTID
                        join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                        join atrail in context.TBL_APPROVAL_TRAIL.Distinct() on req.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                        where (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending)
                              && atrail.OPERATIONID == (int)OperationsEnum.RevolvingLoanBooking
                              && req.DELETED == false && req.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && req.ISUSED == true
                              && ln.LOANSTATUSID == (short)LoanStatusEnum.Inactive
                              && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                              && atrail.RESPONSESTAFFID == null
                        orderby ln.REVOLVINGLOANID descending
                        select new RevolvingLoanViewModel()
                        {
                            divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                            divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                            loanId = ln.REVOLVINGLOANID,
                            operationId = ln.OPERATIONID,
                            operationTypeId = (int)OperationsEnum.RevolvingLoanBooking,
                            loanBookingRequestId = req.LOAN_BOOKING_REQUESTID,
                            customerId = ln.CUSTOMERID,
                            productId = ln.PRODUCTID,
                            casaAccountId = ln.CASAACCOUNTID,
                            casaAccountNumber = (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID) select y.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                            casaAccountDetails = (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID) select y.PRODUCTACCOUNTNUMBER).FirstOrDefault() + (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID) select y.PRODUCTACCOUNTNAME).FirstOrDefault(),
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            loanApplicationId = a.LOANAPPLICATIONID,
                            currencyCode = ln.TBL_CURRENCY.CURRENCYCODE,
                            branchId = ln.BRANCHID,
                            loanReferenceNumber = ln.LOANREFERENCENUMBER,
                            timeIn = atrail.SYSTEMARRIVALDATETIME,
                            applicationReferenceNumber = a.APPLICATIONREFERENCENUMBER,

                            relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                            relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                            misCode = ln.MISCODE,
                            teamMiscode = ln.TEAMMISCODE,
                            interestRate = ln.INTERESTRATE,
                            effectiveDate = ln.EFFECTIVEDATE,
                            maturityDate = ln.MATURITYDATE,
                            bookingDate = ln.BOOKINGDATE,

                            scheduleDayCountConventionId = ln.DAYCOUNTCONVENTIONID,
                            approvalStatusId = ln.APPROVALSTATUSID,
                            approverComment = ln.APPROVERCOMMENT,
                            dateApproved = ln.DATEAPPROVED,
                            loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                            isDisbursed = ln.ISDISBURSED,
                            disbursedBy = ln.DISBURSEDBY,
                            disburserComment = ln.DISBURSERCOMMENT,
                            disburseDate = ln.DISBURSEDATE,
                            loanStatusName = ln.TBL_LOAN_STATUS.ACCOUNTSTATUS,
                            loanStatusId = ln.LOANSTATUSID,
                            comment = atrail.COMMENT,
                            overdraftLimit = ln.OVERDRAFTLIMIT,
                            bookedAmount = ln.OVERDRAFTLIMIT,
                            approvedAmount = d.APPROVEDAMOUNT,
                            disbursableAmount = ln.OVERDRAFTLIMIT,
                            customerGroupId = a.CUSTOMERGROUPID,
                            loanTypeId = a.LOANAPPLICATIONTYPEID,

                            subSectorId = ln.SUBSECTORID,
                            subSectorName = ln.TBL_SUB_SECTOR.NAME,
                            dischargeLetter = ln.DISCHARGELETTER,
                            suspendInterest = ln.SUSPENDINTEREST,

                            firstName = cust.FIRSTNAME,
                            middleName = cust.MIDDLENAME,
                            lastName = cust.LASTNAME,
                            customerCode = cust.CUSTOMERCODE,
                            productAccountNumber = (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID) select y.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                            productAccountName = (from y in context.TBL_CASA.Where(i => i.CASAACCOUNTID == ln.CASAACCOUNTID) select y.PRODUCTACCOUNTNAME).FirstOrDefault(),
                            loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == a.LOANAPPLICATIONTYPEID) select y.LOANAPPLICATIONTYPENAME).FirstOrDefault(),
                            customerName = cust.LASTNAME + " " + cust.FIRSTNAME + " " + cust.MIDDLENAME,
                            currencyId = ln.CURRENCYID,
                            branchName = (from y in context.TBL_BRANCH.Where(i => i.BRANCHID == ln.BRANCHID) select y.BRANCHNAME).FirstOrDefault(),

                            productClassId = p.PRODUCTCLASSID,
                            productTypeId = p.PRODUCTTYPEID,
                            productName = p.PRODUCTNAME,
                            productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,

                            createdBy = ln.CREATEDBY,
                            dateTimeCreated = ln.DATETIMECREATED,
                            isBidbond = false,
                            isOverdraft = false,

                            customerSensitivityLevelId = ln.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                            customerSensitivityLevelName = ln.TBL_CUSTOMER.TBL_CUSTOMER_SENSITIVITY_LEVEL.DESCRIPTION,

                            relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                            relationshipManagerName = ln.TBL_STAFF1.FIRSTNAME + " " + ln.TBL_STAFF1.MIDDLENAME + " " + ln.TBL_STAFF1.LASTNAME,

                            loanCollateral = (from cm in context.TBL_LOAN_COLLATERAL_MAPPING
                                              join cc in context.TBL_COLLATERAL_CUSTOMER on cm.COLLATERALCUSTOMERID equals cc.COLLATERALCUSTOMERID
                                              join ct in context.TBL_COLLATERAL_TYPE on cc.COLLATERALTYPEID equals ct.COLLATERALTYPEID
                                              where cm.LOANID == ln.REVOLVINGLOANID && cm.LOANSYSTEMTYPEID == ln.LOANSYSTEMTYPEID
                                              select (new LoanCollateralMappingViewModel
                                              {
                                                  collateralTypeName = ct.COLLATERALTYPENAME
                                                           + "(" + ct.TBL_COLLATERAL_TYPE_SUB.FirstOrDefault().COLLATERALSUBTYPENAME + ")",
                                                  collateralCustomerId = cm.COLLATERALCUSTOMERID,
                                                  collateralValue = cc.COLLATERALVALUE,
                                                  hairCut = cc.HAIRCUT,
                                                  valuationCycle = cc.VALUATIONCYCLE,
                                                  currencyId = cc.CURRENCYID,
                                                  currencyCode = cc.TBL_CURRENCY.CURRENCYCODE,
                                                  currency = cc.TBL_CURRENCY.CURRENCYNAME
                                              })).ToList(),
                            monitoringTriggers = (from i in context.TBL_LOAN_MONITORING_TRIGGER.Where(x => x.LOANID == ln.REVOLVINGLOANID && x.LOANSYSTEMTYPEID == ln.TBL_PRODUCT.PRODUCTTYPEID)
                                                  select (
                                                           new LoanMonitoringTriggerViewModel
                                                           {
                                                               loanMonitoringTriggerId = i.LOAN_MONITORING_TRIGGERID,
                                                               loanSystemTypeId = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                                                               monitoringTriggerId = i.MONITORING_TRIGGERID,
                                                               monitoringTrigger = i.MONITORING_TRIGGER,
                                                               monitoringTriggerSetupName = i.TBL_LOAN_MONITORING_TRIG_SETUP.MONITORING_TRIGGER_NAME,
                                                           })).ToList(),

                        }).ToList();

            var test = data.Where(d => d.applicationReferenceNumber.Contains("1282210277431")).ToList();
            List<RevolvingLoanViewModel> lcyLoans = new List<RevolvingLoanViewModel>();
            List<RevolvingLoanViewModel> fcyLoans = new List<RevolvingLoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = data.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
            }

            if (isFCYUser == true)
            {
                fcyLoans = data.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            data = lcyLoans.Union(fcyLoans).ToList();
            var test2 = data.Where(d => d.applicationReferenceNumber.Contains("1282210277431")).ToList();


            return data.ToList();

        }

        public IEnumerable<ContingentLoanViewModel> GetContingentFacilityBookingAwaitingApproval(int staffId, int companyId)
        {

            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            //var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;


            var ids = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.ContigentLoanBooking).ToList();

            var data = (from ln in context.TBL_LOAN_CONTINGENT
                        join coy in context.TBL_COMPANY on ln.COMPANYID equals coy.COMPANYID
                        join req in context.TBL_LOAN_BOOKING_REQUEST on ln.LOANAPPLICATIONDETAILID equals req.LOANAPPLICATIONDETAILID
                        join d in context.TBL_LOAN_APPLICATION_DETAIL on req.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                        join a in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals a.LOANAPPLICATIONID
                        join cust in context.TBL_CUSTOMER on ln.CUSTOMERID equals cust.CUSTOMERID
                        join p in context.TBL_PRODUCT on ln.PRODUCTID equals p.PRODUCTID
                        join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                        join atrail in context.TBL_APPROVAL_TRAIL on req.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                        where (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending)
                              && atrail.OPERATIONID == (int)OperationsEnum.ContigentLoanBooking
                              && req.DELETED == false && req.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                              && ln.LOANSTATUSID == (short)LoanStatusEnum.Inactive
                              && ids.Contains((int)atrail.TOAPPROVALLEVELID)
                              && atrail.RESPONSESTAFFID == null
                        orderby ln.CONTINGENTLOANID descending

                        select new ContingentLoanViewModel()
                        {
                            divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                            divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                            loanId = ln.CONTINGENTLOANID,
                            operationId = (int)OperationsEnum.ContigentLoanBooking,
                            appraisalOperationId = (short)a.OPERATIONID,
                            operationTypeId = (int)OperationsEnum.ContigentLoanBooking,
                            loanBookingRequestId = req.LOAN_BOOKING_REQUESTID,
                            customerId = ln.CUSTOMERID,
                            productId = ln.PRODUCTID,
                            systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,

                            casaAccountId = ln.CASAACCOUNTID,
                            casaAccountNumber = ln.TBL_CASA.PRODUCTACCOUNTNUMBER,
                            casaAccountDetails = ln.TBL_CASA.PRODUCTACCOUNTNUMBER + " (" + ln.TBL_CASA.PRODUCTACCOUNTNAME + ") ",
                            loanApplicationDetailId = (int)ln.LOANAPPLICATIONDETAILID,
                            loanApplicationId = d.LOANAPPLICATIONID,
                            currencyCode = ln.TBL_CURRENCY.CURRENCYCODE,
                            branchId = ln.BRANCHID,
                            loanReferenceNumber = ln.LOANREFERENCENUMBER,
                            applicationReferenceNumber = a.APPLICATIONREFERENCENUMBER,

                            relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                            relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                            misCode = ln.MISCODE,
                            teamMiscode = ln.TEAMMISCODE,
                            effectiveDate = ln.EFFECTIVEDATE,
                            maturityDate = ln.MATURITYDATE,
                            bookingDate = ln.BOOKINGDATE,
                            // bookedAmount = ln.CONTINGENTAMOUNT,
                            timeIn = atrail.SYSTEMARRIVALDATETIME,
                            approvalStatusId = ln.APPROVALSTATUSID,
                            //approvedBy = (int)ln.APPROVEDBY,
                            approverComment = ln.APPROVERCOMMENT,
                            dateApproved = ln.DATEAPPROVED,
                            loanStatusId = ln.LOANSTATUSID,
                            loanStatusName = ln.TBL_LOAN_STATUS.ACCOUNTSTATUS,
                            isDisbursed = ln.ISDISBURSED,
                            disbursedBy = ln.DISBURSEDBY,
                            disburserComment = ln.DISBURSERCOMMENT,
                            disburseDate = ln.DISBURSEDATE,
                            loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                            approvedAmount = d.APPROVEDAMOUNT,
                            disbursableAmount = ln.CONTINGENTAMOUNT,

                            customerGroupId = a.CUSTOMERGROUPID,
                            loanTypeId = a.LOANAPPLICATIONTYPEID,
                            subSectorId = ln.SUBSECTORID,
                            subSectorName = ln.TBL_SUB_SECTOR.NAME,
                            dischargeLetter = ln.DISCHARGELETTER,
                            contingentAmount = ln.CONTINGENTAMOUNT,

                            //customerSensitivityLevelId = ln.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                            //customerSensitivityLevelName = ln.TBL_CUSTOMER.TBL_CUSTOMER_SENSITIVITY_LEVEL.DESCRIPTION,
                            firstName = cust.FIRSTNAME,
                            middleName = cust.MIDDLENAME,
                            lastName = cust.LASTNAME,
                            customerCode = cust.CUSTOMERCODE,
                            productAccountNumber = p.TBL_CHART_OF_ACCOUNT.ACCOUNTCODE,
                            productAccountName = p.TBL_CHART_OF_ACCOUNT.ACCOUNTNAME,
                            productAccountName2 = ln.TBL_CASA.PRODUCTACCOUNTNUMBER + " - (" + ln.TBL_CASA.PRODUCTACCOUNTNAME + ")",
                            loanTypeName = a.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            customerName = cust.LASTNAME + " " + cust.FIRSTNAME + " " + cust.MIDDLENAME,
                            currencyId = ln.CURRENCYID,

                            branchName = ln.TBL_BRANCH.BRANCHNAME,
                            relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                            relationshipManagerName = ln.TBL_STAFF1.FIRSTNAME + " " + ln.TBL_STAFF1.MIDDLENAME + " " + ln.TBL_STAFF1.LASTNAME,

                            productClassId = p.PRODUCTCLASSID,
                            productTypeId = p.PRODUCTTYPEID,
                            productName = p.PRODUCTNAME,
                            productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            createdBy = ln.CREATEDBY,
                            creatorName = ln.TBL_STAFF.LASTNAME + " " + ln.TBL_STAFF.FIRSTNAME + " (" + ln.TBL_STAFF.STAFFCODE + ")",
                            dateTimeCreated = ln.DATETIMECREATED,
                            comment = atrail.COMMENT,
                            isBidbond = p.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees ? true : false,
                            isOverdraft = p.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan ? true : false,
                            customerSensitivityLevelId = ln.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                            customerSensitivityLevelName = ln.TBL_CUSTOMER.TBL_CUSTOMER_SENSITIVITY_LEVEL.DESCRIPTION,

                            loanCollateral = (from cm in context.TBL_LOAN_COLLATERAL_MAPPING
                                              join cc in context.TBL_COLLATERAL_CUSTOMER on cm.COLLATERALCUSTOMERID equals cc.COLLATERALCUSTOMERID
                                              join ct in context.TBL_COLLATERAL_TYPE on cc.COLLATERALTYPEID equals ct.COLLATERALTYPEID
                                              where cm.LOANID == ln.CONTINGENTLOANID && cm.LOANSYSTEMTYPEID == ln.LOANSYSTEMTYPEID
                                              select (new LoanCollateralMappingViewModel
                                              {
                                                  collateralTypeName = ct.COLLATERALTYPENAME
                                                           + "(" + ct.TBL_COLLATERAL_TYPE_SUB.FirstOrDefault().COLLATERALSUBTYPENAME + ")",
                                                  collateralCustomerId = cm.COLLATERALCUSTOMERID,
                                                  collateralValue = cc.COLLATERALVALUE,
                                                  hairCut = cc.HAIRCUT,
                                                  valuationCycle = cc.VALUATIONCYCLE,
                                                  currencyId = cc.CURRENCYID,
                                                  currencyCode = cc.TBL_CURRENCY.CURRENCYCODE,
                                                  currency = cc.TBL_CURRENCY.CURRENCYNAME
                                              })).ToList(),
                            monitoringTriggers = (from i in context.TBL_LOAN_MONITORING_TRIGGER.Where(x => x.LOANID == ln.CONTINGENTLOANID && x.LOANSYSTEMTYPEID == ln.TBL_PRODUCT.PRODUCTTYPEID)
                                                  select (
                                                           new LoanMonitoringTriggerViewModel
                                                           {
                                                               loanMonitoringTriggerId = i.LOAN_MONITORING_TRIGGERID,
                                                               loanSystemTypeId = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                                                               monitoringTriggerId = i.MONITORING_TRIGGERID,
                                                               monitoringTrigger = i.MONITORING_TRIGGER,
                                                               monitoringTriggerSetupName = i.TBL_LOAN_MONITORING_TRIG_SETUP.MONITORING_TRIGGER_NAME,
                                                           })).ToList(),
                        }).ToList().Take(50);


            List<ContingentLoanViewModel> lcyLoans = new List<ContingentLoanViewModel>();
            List<ContingentLoanViewModel> fcyLoans = new List<ContingentLoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = data.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
            }

            if (isFCYUser == true)
            {
                fcyLoans = data.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            data = lcyLoans.Union(fcyLoans).ToList();

            return data;
        }

        public IEnumerable<CamProcessedLoanViewModel> GetdisbursedLoansApplicationDetails(int staffId, int companyId)
        {
            var company = context.TBL_COMPANY.Find(companyId);
            var canReRouteBooking = context.TBL_PROFILE_ADDITIONALACTIVITY.Where(x => x.USERID == staffId && x.ACTIVITYID == 177).Any();
            var newApplicationDate = generalSetup.GetApplicationDate();
            var data = (from s in context.TBL_LOAN_BOOKING_REQUEST
                        join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                        join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                        join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                        where d.DELETED == false && s.DELETED == false
                        && m.COMPANYID == companyId

                        orderby s.LOAN_BOOKING_REQUESTID descending
                        select new CamProcessedLoanViewModel
                        {
                            bookingAmountRequested = s.AMOUNT_REQUESTED,
                            loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                            bookingRequestStatusId = s.APPROVALSTATUSID,
                            requestDate = s.DATETIMECREATED,
                            requestedBy = "",
                            appraisalOperationId = m.OPERATIONID,
                            requestedAmount = s.AMOUNT_REQUESTED,
                            requestOperationId = (short)s.OPERATIONID,
                            approvalStatusId = (short)m.APPROVALSTATUSID,
                            loanApplicationId = m.LOANAPPLICATIONID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                            applicationStatusId = m.APPLICATIONSTATUSID,
                            casaAccountId = s.CASAACCOUNTID,
                            casaAccountId2 = s.CASAACCOUNTID2,
                            feeAccountName = (from t in context.TBL_CASA where t.CASAACCOUNTID == s.CASAACCOUNTID select t.PRODUCTACCOUNTNAME + "(" + t.PRODUCTACCOUNTNUMBER + ")").FirstOrDefault(),
                            customerId = d.CUSTOMERID,
                            customerCode = cust.CUSTOMERCODE,
                            customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                            customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                            customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                            customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                            isRelatedParty = m.ISRELATEDPARTY,
                            customerSensitivityLevelId = cust.CUSTOMERSENSITIVITYLEVELID,

                            customerOccupation = cust.OCCUPATION,
                            customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                            isPoliticallyExposed = cust.ISPOLITICALLYEXPOSED,
                            isInvestmentGrade = m.ISINVESTMENTGRADE,
                            newApplicationDate = newApplicationDate,
                            loanInformation = m.LOANINFORMATION,
                            companyId = m.COMPANYID,
                            branchId = m.BRANCHID,
                            branchName = m.TBL_BRANCH.BRANCHNAME,
                            subSectorId = d.SUBSECTORID,
                            subSectorName = d.TBL_SUB_SECTOR.NAME,
                            sectorName = (from y in context.TBL_SECTOR.Where(i => i.SECTORID == d.TBL_SUB_SECTOR.SECTORID) select y).FirstOrDefault().NAME, //d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            applicationTenor = m.APPLICATIONTENOR,
                            effectiveDate = (DateTime)d.EFFECTIVEDATE,
                            expiryDate = (DateTime)d.EXPIRYDATE,
                            canReRouteBooking = canReRouteBooking,
                            //isTemporaryOverdraft = p.TBL_PRODUCT_BEHAVIOUR.FirstOrDefault() != null ? p.TBL_PRODUCT_BEHAVIOUR.FirstOrDefault().ISTEMPORARYOVERDRAFT : false,

                            relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                            relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                            //relationshipManagerId = m.RELATIONSHIPMANAGERID,
                            //relationshipManagerName = m.TBL_STAFF1.FIRSTNAME + " " + m.TBL_STAFF1.MIDDLENAME + " " + m.TBL_STAFF1.LASTNAME,
                            relationshipManagerId = m.TBL_STAFF.SUPERVISOR_STAFFID.Value,
                            relationshipManagerName = context.TBL_STAFF.Where(O => O.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID.Value).FirstOrDefault().FIRSTNAME + " " + context.TBL_STAFF.Where(O => O.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID.Value).FirstOrDefault().MIDDLENAME + " " + context.TBL_STAFF.Where(O => O.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID.Value).FirstOrDefault().LASTNAME,


                            currencyId = d.CURRENCYID,
                            currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                            exchangeRate = d.EXCHANGERATE,
                            loanTypeId = m.LOANAPPLICATIONTYPEID,
                            loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME,
                            camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                            productId = s.PRODUCTID,
                            productTypeId = p.PRODUCTTYPEID,
                            productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                            productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            productName = p.PRODUCTNAME,
                            productClassId = p.PRODUCTCLASSID,
                            productClassProcessId = p.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                            productScheduleTypeId = p.SCHEDULETYPEID,
                            productDealTypeId = p.DEALTYPEID,
                            productDayCountConventionId = p.TBL_PRODUCT_CURRENCY.FirstOrDefault() != null ? p.TBL_PRODUCT_CURRENCY.FirstOrDefault().DAYCOUNTCONVENTIONID : 0, // p.DAYCOUNTCONVENTIONID,
                            misCode = m.MISCODE,
                            teamMisCode = m.TEAMMISCODE,

                            interestRate = d.APPROVEDINTERESTRATE,
                            approvedInterestRate = d.APPROVEDINTERESTRATE,
                            submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                            approvedAmount = d.APPROVEDAMOUNT,
                            groupApprovedAmount = m.APPROVEDAMOUNT,
                            availmentDate = m.AVAILMENTDATE,
                            isBidbond = p.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees ? true : false,
                            isOverdraft = p.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan ? true : false,
                            repaymentTerms = d.REPAYMENTTERMS,
                            repaymentSchedule = d.TBL_REPAYMENT_TERM.REPAYMENTTERMDETAIL,
                            approvedTenor = d.APPROVEDTENOR,
                            createdBy = m.OWNEDBY,
                            applicationDate = m.APPLICATIONDATE,
                            dateTimeCreated = d.DATETIMECREATED,
                            loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,
                            isLocalCurrrency = company.CURRENCYID == d.CURRENCYID ? true : false,
                            crmsCode = s.CRMSCODE,
                            staffId = staffId
                            
                        }).ToList();


            foreach (var item in data)
            {
                item.isBooked = context.TBL_LOAN.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId).Any();

                int operationId = 0;
                if (item.productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                    operationId = (short)OperationsEnum.ContigentLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
                    operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
                    operationId = (short)OperationsEnum.CommercialLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.TermLoan || item.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating || item.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                    operationId = (short)OperationsEnum.TermLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                    operationId = (short)OperationsEnum.RevolvingLoanBooking;

                item.operationId = operationId;

                var trailInfo = context.TBL_APPROVAL_TRAIL.Where(x => x.OPERATIONID == operationId && x.TARGETID == item.loanBookingRequestId);
                if (trailInfo.Any())
                {
                    item.isUnderApproval = true;
                    foreach (var trail in trailInfo)
                    {
                        if (trail.RESPONSESTAFFID == null)
                        {
                            var routedStaffRecord = context.TBL_STAFF.Where(x => x.STAFFID == trail.TOSTAFFID).FirstOrDefault();
                            if (routedStaffRecord != null) item.routedToStaff = routedStaffRecord.FIRSTNAME + " " + routedStaffRecord.LASTNAME;
                        }

                    }
                }

                var loans = context.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var overdrafts = context.TBL_LOAN_REVOLVING.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var contingents = context.TBL_LOAN_CONTINGENT.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);


                var productBehaviour = context.TBL_PRODUCT_BEHAVIOUR.Where(x => x.PRODUCTID == item.productId).FirstOrDefault();
                if (productBehaviour != null)
                    item.isTemporaryOverdraft = productBehaviour.ISTEMPORARYOVERDRAFT;

                switch (item.productTypeId)
                {
                    case (short)LoanProductTypeEnum.TermLoan:
                        decimal customerAvailableAmount = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount;
                        break;
                    case (short)LoanProductTypeEnum.CommercialLoan:
                        decimal customerAvailableAmount2 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount2 = customerAvailableAmount2 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount2;
                        break;
                    case (short)LoanProductTypeEnum.SelfLiquidating:
                        decimal customerAvailableAmount3 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount3 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount3;
                        break;
                    case (short)LoanProductTypeEnum.RevolvingLoan:
                        decimal overdraftBal = 0;
                        foreach (var overdraft in overdrafts)
                        {
                            if (overdraft.OVERDRAFTLIMIT > 0) overdraftBal = overdraftBal + overdraft.OVERDRAFTLIMIT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - overdraftBal;
                        break;
                    case (short)LoanProductTypeEnum.ContingentLiability:
                        decimal contingentBal = 0;
                        foreach (var contingent in contingents)
                        {
                            if (contingent.CONTINGENTAMOUNT > 0) contingentBal = contingentBal + contingent.CONTINGENTAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - contingentBal;
                        break;
                }

                if (item.operationId == (short)OperationsEnum.TermLoanBooking || item.operationId == (short)OperationsEnum.CommercialLoanBooking || item.operationId == (short)OperationsEnum.ForeignExchangeLoanBooking)
                {
                    var priceIndex = context.TBL_PRODUCT_PRICE_INDEX.Find(item.productPriceIndexId);
                    var interestRate = Convert.ToDouble(item.approvedInterestRate);
                    if (priceIndex != null)
                    {
                        item.interestRate = priceIndex.PRICEINDEXRATE + interestRate;
                        item.productPriceIndex = priceIndex.PRICEINDEXNAME;
                        item.productPriceDescription = priceIndex.PRICEINDEXDESCRIPTION;
                    }
                }
            }

            IEnumerable<LoanViewModel> bookedDataRecord = GetLoanFacilityBooked(staffId, companyId);
            IEnumerable<RevolvingLoanViewModel> revolvingFacilityRecord = GetRevolvingFacilityBooked(staffId, companyId).ToList();

            foreach (var item in bookedDataRecord)
            {
                var applicationRecord = data.Where(x => x.staffId == staffId && x.companyId == companyId && x.loanApplicationDetailId == item.loanApplicationDetailId && x.loanBookingRequestId == item.loanBookingRequestId).FirstOrDefault();

                if (applicationRecord != null)
                {
                    if (!applicationRecord.customerAvailableAmount.HasValue)
                    {
                        applicationRecord.customerAvailableAmount = item.approvedAmount;
                    }

                    applicationRecord.bookedLoanData = item;
                    applicationRecord.applicationReferenceNumber = item.applicationReferenceNumber;
                    applicationRecord.loanReferenceNumber = item.loanReferenceNumber;
                    data.Add(applicationRecord);
                }
            }

            foreach (var item in revolvingFacilityRecord)
            {
                var applicationRecord = data.Where(x => x.staffId == staffId && x.companyId == companyId && x.loanApplicationDetailId == item.loanApplicationDetailId && x.loanBookingRequestId == item.loanBookingRequestId).FirstOrDefault();

                if (applicationRecord != null)
                {
                    if (!applicationRecord.customerAvailableAmount.HasValue)
                    {
                        applicationRecord.customerAvailableAmount = item.approvedAmount;
                    }

                    applicationRecord.bookedRevolvingFacilityData = item;
                    applicationRecord.applicationReferenceNumber = item.applicationReferenceNumber;
                    applicationRecord.loanReferenceNumber = item.loanReferenceNumber;
                    data.Add(applicationRecord);
                }
            }

            return data;
        }

        public IEnumerable<LoanViewModel> GetLoanFacilityBooked(int staffId, int companyId)
        {
            //var ids = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.TermLoanBooking).ToList();
            //List<int> operationIds = new List<int>();
            //operationIds.Add((int)OperationsEnum.TermLoanBooking);
            //operationIds.Add((int)OperationsEnum.CommercialLoanBooking);
            //operationIds.Add((int)OperationsEnum.ForeignExchangeLoanBooking);

            var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

            try
            {
                var data = (from ln in context.TBL_LOAN
                            join coy in context.TBL_COMPANY on ln.COMPANYID equals coy.COMPANYID
                            join req in context.TBL_LOAN_BOOKING_REQUEST on ln.LOANAPPLICATIONDETAILID equals req.LOANAPPLICATIONDETAILID
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join atrail in context.TBL_APPROVAL_TRAIL on req.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                            where (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                  //&& operationIds.Contains(atrail.OPERATIONID)
                                  && ln.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility
                                  && ln.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.RevolvingLoan
                                  //&& ln.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan
                                  && req.DELETED == false
                                  && req.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                  && ln.LOANSTATUSID == (short)LoanStatusEnum.Active
                                  //&& ids.Contains((int)atrail.TOAPPROVALLEVELID)// == staffApprovalLevelId
                                  && ln.ISDISBURSED == true
                            orderby ln.TERMLOANID descending

                            select new LoanViewModel()
                            {
                                loanId = ln.TERMLOANID,
                                operationId = ln.OPERATIONID,
                                operationTypeId = atrail.OPERATIONID,
                                loanBookingRequestId = req.LOAN_BOOKING_REQUESTID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccountId2 = ln.CASAACCOUNTID2,
                                casaAccountNumber = ln.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                casaAccountDetails = ln.TBL_CASA.PRODUCTACCOUNTNUMBER + " (" + ln.TBL_CASA.PRODUCTACCOUNTNAME + ") ",
                                loanApplicationDetailId = (int)ln.LOANAPPLICATIONDETAILID,
                                loanApplicationId = ln.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
                                currencyCode = ln.TBL_CURRENCY.CURRENCYCODE,
                                branchId = ln.BRANCHID,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,
                                applicationReferenceNumber = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER,
                                //crmsCode = ln.CRMSCODE,
                                staffId = staffId,
                                timeIn = atrail.SYSTEMARRIVALDATETIME,
                                principalFrequencyTypeName = ln.TBL_FREQUENCY_TYPE.DESCRIPTION ?? null,
                                interestFrequencyTypeName = ln.TBL_FREQUENCY_TYPE1.DESCRIPTION ?? null,
                                scheduleDayCountConventionId = ln.SCHEDULEDAYCOUNTCONVENTIONID,
                                principalNumberOfInstallment = ln.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = ln.INTERESTNUMBEROFINSTALLMENT,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                bookedAmount = ln.PRINCIPALAMOUNT,

                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,
                                principalAmount = ln.PRINCIPALAMOUNT,
                                principalInstallmentLeft = ln.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = ln.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = ln.APPROVALSTATUSID,
                                approvedBy = ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                scheduleTypeId = ln.SCHEDULETYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                disbursableAmount = ln.PRINCIPALAMOUNT,
                                approvedAmount = ln.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                customerGroupId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,

                                loanTypeId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                equityContribution = ln.EQUITYCONTRIBUTION,
                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                sectorName = ln.TBL_SUB_SECTOR.TBL_SECTOR.NAME,

                                firstPrincipalPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                firstInterestPaymentDate = ln.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = ln.OUTSTANDINGPRINCIPAL,
                                principalAdditionCount = ln.PRINCIPALADDITIONCOUNT,
                                interestFrequencyTypeId = ln.INTERESTFREQUENCYTYPEID,
                                principalFrequencyTypeId = ln.PRINCIPALFREQUENCYTYPEID,
                                principalReductionCount = ln.PRINCIPALREDUCTIONCOUNT,
                                fixedPrincipal = ln.FIXEDPRINCIPAL,
                                profileLoan = ln.PROFILELOAN,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,
                                productPriceIndexId = ln.PRODUCTPRICEINDEXID ?? 0,

                                scheduled = ln.ISSCHEDULEDPREPAYMENT,
                                isScheduledPrepayment = ln.ISSCHEDULEDPREPAYMENT,
                                scheduledPrepaymentAmount = ln.SCHEDULEDPREPAYMENTAMOUNT,
                                scheduledPrepaymentDate = ln.SCHEDULEDPREPAYMENTDATE,

                                firstName = ln.TBL_CUSTOMER.FIRSTNAME,
                                middleName = ln.TBL_CUSTOMER.MIDDLENAME,
                                lastName = ln.TBL_CUSTOMER.LASTNAME,
                                customerCode = ln.TBL_CUSTOMER.CUSTOMERCODE,
                                productAccountName = ln.TBL_PRODUCT.PRODUCTNAME,
                                productAccountName2 = ln.TBL_CASA.PRODUCTACCOUNTNUMBER + " - (" + ln.TBL_CASA.PRODUCTACCOUNTNAME + ")",
                                loanTypeName = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                customerName = ln.TBL_CUSTOMER.LASTNAME + " " + ln.TBL_CUSTOMER.FIRSTNAME + " " + ln.TBL_CUSTOMER.MIDDLENAME,
                                currencyId = ln.CURRENCYID,

                                branchName = ln.TBL_BRANCH.BRANCHNAME,
                                relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                                relationshipManagerName = ln.TBL_STAFF1.FIRSTNAME + " " + ln.TBL_STAFF1.MIDDLENAME + " " + ln.TBL_STAFF1.LASTNAME,

                                productClassId = ln.TBL_PRODUCT.PRODUCTCLASSID,
                                productTypeId = ln.TBL_PRODUCT.PRODUCTTYPEID,
                                productName = ln.TBL_PRODUCT.PRODUCTNAME,
                                productTypeName = ln.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                loanStatusName = ln.TBL_LOAN_STATUS.ACCOUNTSTATUS,

                                createdBy = ln.CREATEDBY,
                                creatorName = ln.TBL_STAFF.LASTNAME + " " + ln.TBL_STAFF.FIRSTNAME + " (" + ln.TBL_STAFF.STAFFCODE + ")",
                                dateTimeCreated = ln.DATETIMECREATED,
                                comment = atrail.COMMENT,
                                isBidbond = false,
                                isOverdraft = false,

                                requestStatusId = req.APPROVALSTATUSID,
                                requestDeleted = req.DELETED,
                                loanStatusId = ln.LOANSTATUSID,
                                nostroRateCodeId = ln.NOSTRORATECODEID,
                                nostroRateAmount = ln.NOSTRORATEAMOUNT,
                                nostroAccountId = ln.NOSTROACCOUNTID,

                                //crmsRepaymentAgreementTypeId = ln.CRMSREPAYMENTAGREEMENTID,

                                loanCollateral = (from cm in context.TBL_LOAN_COLLATERAL_MAPPING.Where(x => x.LOANID == ln.TERMLOANID && x.LOANSYSTEMTYPEID == ln.LOANSYSTEMTYPEID)
                                                  select (new LoanCollateralMappingViewModel
                                                  {
                                                      collateralTypeName = cm.TBL_COLLATERAL_CUSTOMER.TBL_COLLATERAL_TYPE.COLLATERALTYPENAME
                                                               + "(" + cm.TBL_COLLATERAL_CUSTOMER.TBL_COLLATERAL_TYPE.TBL_COLLATERAL_TYPE_SUB.FirstOrDefault().COLLATERALSUBTYPENAME + ")",
                                                      collateralCustomerId = cm.COLLATERALCUSTOMERID,
                                                      collateralValue = cm.TBL_COLLATERAL_CUSTOMER.COLLATERALVALUE,
                                                      hairCut = cm.TBL_COLLATERAL_CUSTOMER.HAIRCUT,
                                                      valuationCycle = cm.TBL_COLLATERAL_CUSTOMER.VALUATIONCYCLE,
                                                      currencyId = cm.TBL_COLLATERAL_CUSTOMER.CURRENCYID,
                                                      currencyCode = cm.TBL_COLLATERAL_CUSTOMER.TBL_CURRENCY.CURRENCYCODE,
                                                      currency = cm.TBL_COLLATERAL_CUSTOMER.TBL_CURRENCY.CURRENCYNAME
                                                  })).ToList(),
                                loanBeneficiary = (from i in context.TBL_LOAN_DISBURSEMENT.Where(x => x.TERMLOANID == ln.TERMLOANID)
                                                   select (
                                                            new LoanDisbursementViewModel
                                                            {
                                                                amountDisbursed = i.AMOUNTDISBURSED,
                                                                beneficiaryReason = i.NARRATION,
                                                                loanDisbursementId = i.LOANDISBURSEMENTID
                                                            })).ToList(),

                                monitoringTriggers = (from i in context.TBL_LOAN_MONITORING_TRIGGER.Where(x => x.LOANID == ln.TERMLOANID && x.LOANSYSTEMTYPEID == ln.LOANSYSTEMTYPEID)
                                                      select (
                                                               new LoanMonitoringTriggerViewModel
                                                               {
                                                                   loanMonitoringTriggerId = i.LOAN_MONITORING_TRIGGERID,
                                                                   loanSystemTypeId = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                                                                   monitoringTriggerId = i.MONITORING_TRIGGERID,
                                                                   monitoringTrigger = i.MONITORING_TRIGGER,
                                                                   monitoringTriggerSetupName = i.TBL_LOAN_MONITORING_TRIG_SETUP.MONITORING_TRIGGER_NAME,
                                                               })).ToList(),

                            }).ToList();


                List<LoanViewModel> lcyLoans = new List<LoanViewModel>();
                List<LoanViewModel> fcyLoans = new List<LoanViewModel>();

                var isLCYUser = activities.Contains("lcy-user");
                var isFCYUser = activities.Contains("fcy-user");

                if (isLCYUser == true)
                {
                    lcyLoans = data.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                    //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
                }

                if (isFCYUser == true)
                {
                    fcyLoans = data.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

                }



                data = lcyLoans.Union(fcyLoans).ToList();
                var uniqueData = data.Where(x => x.loanReferenceNumber != "-")
                    .GroupBy(p => p.loanReferenceNumber)
                    .Select(g => g.First())
                        .ToList();

                return uniqueData;


            }
            catch (Exception ex)
            {
                throw new ConditionNotMetException("An error Occured reading term loan details");
            }

        }

        public IEnumerable<RevolvingLoanViewModel> GetRevolvingFacilityBooked(int staffId, int companyId)
        {
            var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

            //var ids = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.TermLoanBooking).ToList();
            try
            {
                var data = (from ln in context.TBL_LOAN_REVOLVING
                            join coy in context.TBL_COMPANY on ln.COMPANYID equals coy.COMPANYID
                            join req in context.TBL_LOAN_BOOKING_REQUEST on ln.LOANAPPLICATIONDETAILID equals req.LOANAPPLICATIONDETAILID
                            join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                            join atrail in context.TBL_APPROVAL_TRAIL on req.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                            where (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved)
                                  //&& atrail.OPERATIONID == (int)OperationsEnum.RevolvingLoanBooking
                                  && req.DELETED == false && req.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                  && ln.LOANSTATUSID == (short)LoanStatusEnum.Active
                                  //&& ids.Contains((int)atrail.TOAPPROVALLEVELID)
                                  && ln.ISDISBURSED == true
                            orderby ln.REVOLVINGLOANID descending
                            select new RevolvingLoanViewModel()
                            {
                                loanId = ln.REVOLVINGLOANID,
                                operationId = ln.OPERATIONID,
                                operationTypeId = (int)OperationsEnum.RevolvingLoanBooking,
                                loanBookingRequestId = req.LOAN_BOOKING_REQUESTID,
                                customerId = ln.CUSTOMERID,
                                productId = ln.PRODUCTID,
                                casaAccountId = ln.CASAACCOUNTID,
                                casaAccountNumber = ln.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                casaAccountDetails = ln.TBL_CASA.PRODUCTACCOUNTNUMBER + " (" + ln.TBL_CASA.PRODUCTACCOUNTNAME + ") ",
                                loanApplicationDetailId = (int)ln.LOANAPPLICATIONDETAILID,
                                loanApplicationId = ln.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
                                currencyCode = ln.TBL_CURRENCY.CURRENCYCODE,
                                branchId = ln.BRANCHID,
                                loanReferenceNumber = ln.LOANREFERENCENUMBER,

                                applicationReferenceNumber = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER,
                                //crmsRepaymentAgreementTypeId = ln.CRMSREPAYMENTAGREEMENTID,

                                relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                                relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                                misCode = ln.MISCODE,
                                teamMiscode = ln.TEAMMISCODE,
                                interestRate = ln.INTERESTRATE,
                                effectiveDate = ln.EFFECTIVEDATE,
                                maturityDate = ln.MATURITYDATE,
                                bookingDate = ln.BOOKINGDATE,

                                scheduleDayCountConventionId = ln.DAYCOUNTCONVENTIONID,
                                timeIn = atrail.SYSTEMARRIVALDATETIME,
                                approvalStatusId = ln.APPROVALSTATUSID,
                                // approvedBy = (int)ln.APPROVEDBY,
                                approverComment = ln.APPROVERCOMMENT,
                                dateApproved = ln.DATEAPPROVED,
                                loanSystemTypeId = ln.LOANSYSTEMTYPEID,
                                isDisbursed = ln.ISDISBURSED,
                                disbursedBy = ln.DISBURSEDBY,
                                disburserComment = ln.DISBURSERCOMMENT,
                                disburseDate = ln.DISBURSEDATE,
                                loanStatusName = ln.TBL_LOAN_STATUS.ACCOUNTSTATUS,
                                comment = atrail.COMMENT,
                                overdraftLimit = ln.OVERDRAFTLIMIT,
                                bookedAmount = ln.OVERDRAFTLIMIT,
                                approvedAmount = ln.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,
                                disbursableAmount = ln.OVERDRAFTLIMIT,
                                customerGroupId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                loanTypeId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,

                                subSectorId = ln.SUBSECTORID,
                                subSectorName = ln.TBL_SUB_SECTOR.NAME,
                                dischargeLetter = ln.DISCHARGELETTER,
                                suspendInterest = ln.SUSPENDINTEREST,

                                customerSensitivityLevelId = ln.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                customerSensitivityLevelName = ln.TBL_CUSTOMER.TBL_CUSTOMER_SENSITIVITY_LEVEL.DESCRIPTION,
                                firstName = ln.TBL_CUSTOMER.FIRSTNAME,
                                middleName = ln.TBL_CUSTOMER.MIDDLENAME,
                                lastName = ln.TBL_CUSTOMER.LASTNAME,
                                customerCode = ln.TBL_CUSTOMER.CUSTOMERCODE,
                                productAccountNumber = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTCODE,
                                productAccountName = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTNAME,
                                productAccountName2 = ln.TBL_CASA.PRODUCTACCOUNTNUMBER + " - (" + ln.TBL_CASA.PRODUCTACCOUNTNAME + ")",
                                loanTypeName = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                customerName = ln.TBL_CUSTOMER.LASTNAME + " " + ln.TBL_CUSTOMER.FIRSTNAME + " " + ln.TBL_CUSTOMER.MIDDLENAME,
                                currencyId = ln.CURRENCYID,

                                branchName = ln.TBL_BRANCH.BRANCHNAME,
                                relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                                relationshipManagerName = ln.TBL_STAFF1.FIRSTNAME + " " + ln.TBL_STAFF1.MIDDLENAME + " " + ln.TBL_STAFF1.LASTNAME,

                                productClassId = ln.TBL_PRODUCT.PRODUCTCLASSID,
                                productTypeId = ln.TBL_PRODUCT.PRODUCTTYPEID,
                                productName = ln.TBL_PRODUCT.PRODUCTNAME,
                                productTypeName = ln.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,

                                createdBy = ln.CREATEDBY,
                                creatorName = ln.TBL_STAFF.LASTNAME + " " + ln.TBL_STAFF.FIRSTNAME + " (" + ln.TBL_STAFF.STAFFCODE + ")",
                                dateTimeCreated = ln.DATETIMECREATED,
                                isBidbond = false,
                                isOverdraft = false,
                                loanCollateral = (from cm in context.TBL_LOAN_COLLATERAL_MAPPING.Where(x => x.LOANID == ln.REVOLVINGLOANID && x.LOANSYSTEMTYPEID == ln.LOANSYSTEMTYPEID)
                                                  select (
                                                           new LoanCollateralMappingViewModel
                                                           {
                                                               loanCollateralMappingId = cm.LOANCOLLATERALMAPPINGID,
                                                               collateralTypeName = cm.TBL_COLLATERAL_CUSTOMER.TBL_COLLATERAL_TYPE.COLLATERALTYPENAME
                                                               + "(" + cm.TBL_COLLATERAL_CUSTOMER.TBL_COLLATERAL_TYPE.TBL_COLLATERAL_TYPE_SUB.FirstOrDefault().COLLATERALSUBTYPENAME + ")",
                                                               collateralCustomerId = cm.COLLATERALCUSTOMERID,
                                                               collateralValue = cm.TBL_COLLATERAL_CUSTOMER.COLLATERALVALUE,
                                                               hairCut = cm.TBL_COLLATERAL_CUSTOMER.HAIRCUT,
                                                               valuationCycle = cm.TBL_COLLATERAL_CUSTOMER.VALUATIONCYCLE,
                                                               currencyId = cm.TBL_COLLATERAL_CUSTOMER.CURRENCYID,
                                                               currencyCode = cm.TBL_COLLATERAL_CUSTOMER.TBL_CURRENCY.CURRENCYCODE,
                                                               currency = cm.TBL_COLLATERAL_CUSTOMER.TBL_CURRENCY.CURRENCYNAME
                                                           })).ToList(),
                                monitoringTriggers = (from i in context.TBL_LOAN_MONITORING_TRIGGER.Where(x => x.LOANID == ln.REVOLVINGLOANID && x.LOANSYSTEMTYPEID == ln.TBL_PRODUCT.PRODUCTTYPEID)
                                                      select (
                                                               new LoanMonitoringTriggerViewModel
                                                               {
                                                                   loanMonitoringTriggerId = i.LOAN_MONITORING_TRIGGERID,
                                                                   loanSystemTypeId = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                                                                   monitoringTriggerId = i.MONITORING_TRIGGERID,
                                                                   monitoringTrigger = i.MONITORING_TRIGGER,
                                                                   monitoringTriggerSetupName = i.TBL_LOAN_MONITORING_TRIG_SETUP.MONITORING_TRIGGER_NAME,
                                                               })).ToList(),

                            }).ToList();

                List<RevolvingLoanViewModel> lcyLoans = new List<RevolvingLoanViewModel>();
                List<RevolvingLoanViewModel> fcyLoans = new List<RevolvingLoanViewModel>();

                var isLCYUser = activities.Contains("lcy-user");
                var isFCYUser = activities.Contains("fcy-user");

                if (isLCYUser == true)
                {
                    lcyLoans = data.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                    //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
                }

                if (isFCYUser == true)
                {
                    fcyLoans = data.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

                }

                data = lcyLoans.Union(fcyLoans).ToList();

                var uniqueData = data.Where(x => x.loanReferenceNumber != "-")
                   .GroupBy(p => p.loanReferenceNumber)
                   .Select(g => g.First())
                       .ToList();

                return uniqueData;
            }
            catch (Exception ex)
            {
                throw new BadLogicException("An error Occured reading reading revolving loan details");
            }

        }


        public bool GoForFeeOverrideApproval(ApprovalViewModel entity)
        {
            entity.externalInitialization = false;

            using (var trans = context.Database.BeginTransaction())
            {
                try
                {
                    workflow.LogForApproval(entity);

                    var b = workflow.NextLevelId ?? 0;

                    if (b == 0 && workflow.NewState != (int)ApprovalState.Ended)
                    {
                        trans.Rollback();
                        throw new BadLogicException("Approval Failed");
                    }

                    try
                    {
                        if (workflow.NewState != (int)ApprovalState.Ended)
                        {
                            var feeRec = context.TBL_LOAN_FEE.Find(entity.targetId);
                            var allTargetLoanFees = context.TBL_LOAN_FEE.Where(x => x.LOANID == feeRec.LOANID);
                            foreach (var fee in allTargetLoanFees)
                            {
                                fee.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                                fee.FEESOURCEMODULE = "LOS";
                            }

                            ApprovalViewModel approvalModel = new ApprovalViewModel();
                            if (entity.operationId == (int)OperationsEnum.TermLoanBooking)
                            {
                                var termLoanRecord = context.TBL_LOAN.Find(feeRec.LOANID);
                                approvalModel.targetId = termLoanRecord.TERMLOANID;
                                approvalModel.amount = termLoanRecord.PRINCIPALAMOUNT;
                            }
                            else if (entity.operationId == (int)OperationsEnum.RevolvingLoanBooking)
                            {
                                var revolvingLoanRecord = context.TBL_LOAN_REVOLVING.Find(feeRec.LOANID);
                                approvalModel.targetId = revolvingLoanRecord.REVOLVINGLOANID;
                                approvalModel.amount = revolvingLoanRecord.OVERDRAFTLIMIT;
                            }
                            else if (entity.operationId == (int)OperationsEnum.ContigentLoanBooking)
                            {
                                var contingentLoanRecord = context.TBL_LOAN_CONTINGENT.Find(feeRec.LOANID);
                                approvalModel.targetId = contingentLoanRecord.CONTINGENTLOANID;
                                approvalModel.amount = contingentLoanRecord.CONTINGENTAMOUNT;
                            }

                            approvalModel.companyId = entity.companyId;
                            approvalModel.createdBy = entity.createdBy;

                            approvalModel.approvalStatusId = (int)ApprovalStatusEnum.Pending;
                            approvalModel.externalInitialization = true;
                            approvalModel.operationId = (int)OperationsEnum.LoanBookingFeeDeferral;

                            workflow.LogForApproval(approvalModel);

                            return context.SaveChanges() > 0;
                        }
                        else
                        {
                            return false;
                        }
                    }
                    catch (Exception e)
                    {
                        trans.Rollback();
                        throw new SecureException("Approval failed. " + e.Message);
                    }
                }
                catch (Exception ex)
                {
                    trans.Rollback();
                    throw new SecureException(ex.Message);
                }
            }

        }

        public decimal getDailyInterest(decimal principal, double interestRate, int daysInAYear)
        {
            return decimal.Round(((decimal)(principal * (decimal)interestRate / 100) * (1 / daysInAYear)), 4);
        }

        public decimal getTotalInterest(decimal principal, double interestRate, int tenorDays, DayCountConventionEnum dayCountConventionId)
        {
            var daysInAYear = GetDaysInAYear(dayCountConventionId);
            Decimal dailyInterest = decimal.Round(((decimal)((principal * (decimal)interestRate) / 100) * tenorDays) / daysInAYear, 4);
            return dailyInterest;
        }

        public decimal getLoanInterestRateAmount(decimal principal, double interestRate, DateTime startDate, DateTime endDate, DayCountConventionEnum dayCountConventionId)
        {
            if (endDate.Date < startDate.Date)
                throw new ConditionNotMetException("Maturity cannot be less than effective date");

            var totalInterest = getTotalInterest(principal, interestRate, (endDate.Date - startDate.Date).Days, dayCountConventionId);

            return totalInterest;
        }

        public int GoForApproval(ApprovalViewModel entity, int loanBookingRequestId, bool isManual = false)
        {

            //var coreBankingRef = entity.coreBankingRef;

            /*var validateRef = GetLoanBookingDetailFromFlexcube(entity.coreBankingRef);
            if (validateRef.response_code != "00")
            {
                throw new APIErrorException("Core Banking API Error 205 " + validateRef.response_message + " - Kindly Contact System Administrator!");
            }

            var refExist = context.TBL_LOAN.Where(x => x.COREBANKINGREF.Trim() == entity.coreBankingRef.Trim()).FirstOrDefault();
            var refExist2 = context.TBL_LOAN_REVOLVING.Where(x => x.COREBANKINGREF == entity.coreBankingRef.Trim()).FirstOrDefault();
            var refExist3 = context.TBL_LOAN_CONTINGENT.Where(x => x.COREBANKINGREF == entity.coreBankingRef.Trim()).FirstOrDefault();

            if(refExist != null)
            {
                throw new APIErrorException("Sorry Flexcube reference " + entity.coreBankingRef + " has already been used for a term loan facility refernce number "+ refExist.LOANREFERENCENUMBER);
            }

            if (refExist2 != null)
            {
                throw new APIErrorException("Sorry Flexcube reference " + entity.coreBankingRef + " has already been used for a revolving facility refernce number " + refExist2.LOANREFERENCENUMBER);
            }

            if (refExist3 != null)
            {
                throw new APIErrorException("Sorry Flexcube reference " + entity.coreBankingRef + " has already been used for a contingent facility refernce number " + refExist3.LOANREFERENCENUMBER);
            }*/

            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(loanBookingRequestId);
            var appDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(request.LOANAPPLICATIONDETAILID);
            var dynamicMessage = string.Empty;
            var staffEmail = context.TBL_STAFF.Find(request.CREATEDBY);
            var customer = context.TBL_CUSTOMER.Find(appDetail.CUSTOMERID);

            var fullCustomer = customer.FIRSTNAME + " " + customer.LASTNAME + " " + customer.MIDDLENAME;

            /*if (validateRef.loandetailsresp[0].customer_no != customer.CUSTOMERCODE)
            {
                throw new APIErrorException("Sorry Customer ID " + validateRef.loandetailsresp[0].customer_no + " (" + validateRef.loandetailsresp[0].customer_name + ") did not match that of Customer on Credit360  " + customer.CUSTOMERCODE + " (" + fullCustomer +")" );
            }*/


            var loanBrief = "for customer: (" + customer.FIRSTNAME + " " + customer.LASTNAME + " " + customer.MIDDLENAME + " Customer Code:" + customer.CUSTOMERCODE + ")" +
                            " with loan purpose " + appDetail.LOANPURPOSE.ToUpper() + " and loan amount " + string.Format("{0:#,##.00}", Convert.ToDecimal(request.AMOUNT_REQUESTED));

            List<string> receiverEmailList = new List<string>();
            AlertsViewModel alert = new AlertsViewModel();

            using (var trans = context.Database.BeginTransaction())
            {

                workflow.StaffId = entity.createdBy;
                workflow.CompanyId = entity.companyId;
                workflow.StatusId = ((int)entity.approvalStatusId == (int)ApprovalStatusEnum.Approved) ? (int)ApprovalStatusEnum.Processing : (int)entity.approvalStatusId;
                workflow.TargetId = loanBookingRequestId;
                workflow.Comment = entity.comment;
                workflow.OperationId = entity.operationId;
                workflow.DeferredExecution = true;
                workflow.ExternalInitialization = false;
                if (appDetail != null) workflow.BusinessUnitId = appDetail.TBL_CUSTOMER?.BUSINESSUNTID;

                workflow.LogActivity();

                context.SaveChanges();

                if (ApproveLoanBooking(entity.targetId, loanBookingRequestId, (short)workflow.StatusId, entity, isManual))
                {
                    trans.Commit();
                    if (workflow.NewState != (int)ApprovalState.Ended)
                    {

                        if (entity.approvalStatusId == (int)ApprovalStatusEnum.Approved) return 1;
                        else return 3;
                    }
                    else
                    {
                        if (entity.approvalStatusId == (int)ApprovalStatusEnum.Approved)
                        {
                            alert.receiverEmailList.Add(staffEmail.EMAIL);
                            dynamicMessage = "Loan has been successfully disbursed";
                            if (entity.operationId == (short)OperationsEnum.RevolvingLoanBooking)
                            {
                                dynamicMessage = "Overdraft facility grant successfully committed " + loanBrief;
                                LogEmailAlert(dynamicMessage, "LOAN DISBURSEMENT, OVERDRAFT FACILITY GRANT SUCCESSFULLY", alert.receiverEmailList, "10023", 10023, "OverDraftLoanDisbursement");
                            }
                            if (entity.operationId == (short)OperationsEnum.ContigentLoanBooking)
                            {
                                dynamicMessage = "Contingent Liability has been committed successfully " + loanBrief;
                                LogEmailAlert(dynamicMessage, "LOAN DISBURSEMENT, CONTINGENT LIABILITY HAS BEEN COMMITTED SUCCESSFULLY", alert.receiverEmailList, "10023", 10023, "ContingentLiabilityDisbursement");
                            }
                            if (entity.operationId == (short)OperationsEnum.TermLoanBooking)
                            {
                                dynamicMessage = "Loan has been successfully disbursed " + loanBrief;
                                LogEmailAlert(dynamicMessage, "LOAN DISBURSEMENT, TERM LOAN HAS BEEN SUCCESSFULLY DISBURSED", alert.receiverEmailList, "10023", 10023, "TermLoanDisbursement");
                            }

                            if (CustomerIsDirector(appDetail.CUSTOMERID))
                            {
                                var alertDetail = context.TBL_ALERT_TITLE.Where(x => x.BINDINGMETHOD == "GetEnhancedDisbursementToDirectorsNotification").FirstOrDefault();
                                var emailList = GetBusinessUsersEmailsToGroupHead(staffEmail.MISCODE) + ";" + alertDetail.DEFAULTEMAIL + GetAllCreditPortfolioStaffEmails();
                                alert.receiverEmailList.Add(emailList);
                                var alertTemplate = alertDetail.TEMPLATE;
                                var accountOfficer = staffEmail.FIRSTNAME + " " + staffEmail.LASTNAME + " " + staffEmail.MIDDLENAME;
                                alertTemplate = alertTemplate.Replace("@{{accountOfficer}}", accountOfficer);
                                LogEmailAlert(alertTemplate, alertDetail.TITLE, alert.receiverEmailList, "20023", 20023, "GetEnhancedDisbursementToDirectorsNotification");
                            }

                            return 2;
                        }
                        else return 3;
                    }
                }
                else
                {
                    trans.Rollback();
                    return 0;
                }
            }
        }

        private string GetBusinessUsersEmailsToGroupHead(string accountOfficerMIsCode)
        {
            string emailList = "";

            var accountOfficer = context.TBL_STAFF.Where(x => x.MISCODE.ToLower() == accountOfficerMIsCode.ToLower()).FirstOrDefault();
            if (accountOfficer != null)
            {
                emailList = accountOfficer.EMAIL;
                if (accountOfficer.SUPERVISOR_STAFFID != null)
                {
                    var relationshipManager = context.TBL_STAFF.Where(x => x.STAFFID == accountOfficer.SUPERVISOR_STAFFID).FirstOrDefault();
                    if (relationshipManager != null)
                    {
                        emailList = emailList + ";" + relationshipManager.EMAIL;
                        if (relationshipManager.SUPERVISOR_STAFFID != null)
                        {
                            var zonalHead = context.TBL_STAFF.Where(x => x.STAFFID == relationshipManager.SUPERVISOR_STAFFID).FirstOrDefault();
                            if (zonalHead != null)
                            {
                                emailList = emailList + ";" + zonalHead.EMAIL;

                                var groupHead = context.TBL_STAFF.Where(x => x.STAFFID == zonalHead.SUPERVISOR_STAFFID).FirstOrDefault();

                                if (groupHead != null)
                                {
                                    emailList = emailList + ";" + groupHead.EMAIL;
                                }
                            }
                        }
                    }
                }

            }

            return emailList;
        }
        public string GetAllCreditPortfolioStaffEmails()
        {
            var list = "";
            var role = context.TBL_STAFF_ROLE.Where(r => r.STAFFROLECODE == "CP").FirstOrDefault();
            var roleEmail = context.TBL_STAFF.Where(s => s.STAFFROLEID == role.STAFFROLEID).ToList();

            foreach (var t in roleEmail)
            {
                list = list + ";" + t.EMAIL;
            }
            return list;
        }
        private bool CustomerIsDirector(int? customerId)
        {
            if (customerId == null || customerId == 0)
            {
                return false;
            }
            var bvn = context.TBL_CUSTOMER.Find(customerId).CUSTOMERBVN;
            if (String.IsNullOrEmpty(bvn) || String.IsNullOrEmpty(bvn)) return false;
            var isDirector = context.TBL_COMPANY_DIRECTOR.Any(d => d.BVN.Trim() == bvn.Trim());
            if (isDirector) return isDirector;
            return false;
        }

        private bool ApproveLoanBooking(int loanId, int loanBookingRequestId, short approvalStatusId, ApprovalViewModel user, bool isManual)
        {
            var loanRecord = context.TBL_LOAN.Find(loanId);
            var revolvingLoanRecord = context.TBL_LOAN_REVOLVING.Find(loanId);
            var contingentLoanRecord = context.TBL_LOAN_CONTINGENT.Find(loanId);
            var loanReferenceNumber = string.Empty;
            var systemDate = generalSetup.GetApplicationDate();

            var twoFactorAuthDetails = new TwoFactorAutheticationViewModel
            {
                username = user.userName,
                passcode = user.passCode
            };

            if (workflow.NewState != (int)ApprovalState.Ended)
            {
                if ((user.operationId == (int)OperationsEnum.TermLoanBooking || user.operationId == (int)OperationsEnum.CommercialLoanBooking
                        || user.operationId == (int)OperationsEnum.ForeignExchangeLoanBooking) && user.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                {
                    loanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                    loanRecord.LOANSTATUSID = (int)LoanStatusEnum.Cancelled;
                    loanRecord.APPROVEDBY = user.staffId;
                    loanRecord.APPROVERCOMMENT = user.comment;
                }
                else if ((user.operationId == (int)OperationsEnum.TermLoanBooking || user.operationId == (int)OperationsEnum.CommercialLoanBooking
                        || user.operationId == (int)OperationsEnum.ForeignExchangeLoanBooking) && user.approvalStatusId != (short)ApprovalStatusEnum.Disapproved)
                {
                    loanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    context.SaveChanges();
                    return true;
                }

                if (user.operationId == (int)OperationsEnum.RevolvingLoanBooking && user.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                {
                    revolvingLoanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                    revolvingLoanRecord.LOANSTATUSID = (int)LoanStatusEnum.Cancelled;
                    revolvingLoanRecord.APPROVEDBY = user.staffId;
                    revolvingLoanRecord.APPROVERCOMMENT = user.comment;
                }
                else if (user.operationId == (int)OperationsEnum.RevolvingLoanBooking && user.approvalStatusId != (short)ApprovalStatusEnum.Disapproved)
                {
                    revolvingLoanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    context.SaveChanges();
                    return true;
                }

                if (user.operationId == (int)OperationsEnum.ContigentLoanBooking && user.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
                {
                    contingentLoanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                    contingentLoanRecord.LOANSTATUSID = (int)LoanStatusEnum.Cancelled;
                    contingentLoanRecord.APPROVEDBY = user.staffId;
                    contingentLoanRecord.APPROVERCOMMENT = user.comment;
                }
                else if (user.operationId == (int)OperationsEnum.ContigentLoanBooking && user.approvalStatusId != (short)ApprovalStatusEnum.Disapproved)
                {
                    contingentLoanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    context.SaveChanges();
                    return true;
                }
            }

            if (workflow.NewState == (int)ApprovalState.Ended)
            {
                if (user.operationId == (int)OperationsEnum.RevolvingLoanBooking)
                {
                    ProcessRevolvingLoanFacilityApproval(loanId, twoFactorAuthDetails, revolvingLoanRecord, user, user.createdBy, isManual);
                }

                if (user.operationId == (int)OperationsEnum.ContigentLoanBooking)
                {
                    ProcessContingentLiabilityApproval(loanId, twoFactorAuthDetails, contingentLoanRecord, user, isManual);
                }

                if (user.operationId == (int)OperationsEnum.TermLoanBooking || user.operationId == (int)OperationsEnum.CommercialLoanBooking
                    || user.operationId == (int)OperationsEnum.ForeignExchangeLoanBooking)
                {
                    ProcessLoanBookingApproval(loanId, twoFactorAuthDetails, loanRecord, user, isManual);
                }


                // Audit Section ---------------------------
                var action = user.approvalStatusId == (short)ApprovalStatusEnum.Approved ? "Approved" : "Disapproved";
                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = user.approvalStatusId == (short)ApprovalStatusEnum.Approved ? (short)AuditTypeEnum.LoanBookingApproved : (short)AuditTypeEnum.LoanBookingDisapproved,
                    STAFFID = user.staffId,
                    BRANCHID = (short)user.BranchId,
                    DETAIL = $"{action} Facility Booking with code ({loanReferenceNumber})",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = user.applicationUrl,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName(),
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now
                };
                this.auditTrail.AddAuditTrail(audit);
                // Audit Section ---------------------------

                var request = context.TBL_LOAN_BOOKING_REQUEST.Find(loanBookingRequestId);
                if (request != null)
                {
                    request.ISUSED = true;
                }

            }
            return this.context.SaveChanges() > 0;
        }


        public void LogEmailAlert(string messageBody, string alertSubject, List<string> recipients, string referenceCode, int targetId, string operationMehtod)
        {
            try
            {
                var title = alertSubject.Trim();
                if (title.Contains("&"))
                {
                    title = title.Replace("&", "AND");
                }
                if (title.Contains("."))
                {
                    title = title.Replace(".", "");
                }

                string recipient = string.Join("", recipients.ToArray());
                string messageSubject = title;
                string messageContent = messageBody;
                MessageLogViewModel messageModel = new MessageLogViewModel
                {
                    MessageSubject = messageSubject,
                    MessageBody = messageContent,
                    MessageStatusId = 1,
                    MessageTypeId = 1,
                    FromAddress = ConfigurationManager.AppSettings["SupportEmailAddr"],
                    ToAddress = $"{recipient}",
                    DateTimeReceived = DateTime.Now,
                    SendOnDateTime = DateTime.Now,
                    ReferenceCode = referenceCode,
                    targetId = targetId,
                    operationMethod = operationMehtod,
                };
                SaveMessageDetails(messageModel);
            }
            catch (Exception ex)
            {
                new SecureException(ex.ToString());
            }
        }

        private void SaveMessageDetails(MessageLogViewModel model)
        {
            var message = new TBL_MESSAGE_LOG()
            {
                //MessageId = model.MessageId,
                MESSAGESUBJECT = model.MessageSubject,
                MESSAGEBODY = model.MessageBody,
                MESSAGESTATUSID = model.MessageStatusId,
                MESSAGETYPEID = model.MessageTypeId,
                FROMADDRESS = model.FromAddress,
                TOADDRESS = model.ToAddress,
                DATETIMERECEIVED = model.DateTimeReceived,
                SENDONDATETIME = model.SendOnDateTime,
                ATTACHMENTCODE = model.ReferenceCode,
                ATTACHMENTTYPEID = (short)AttachementTypeEnum.JobRequest,
                TARGETID = (int)model.targetId,
                OPERATIONMETHOD = model.operationMethod
            };

            context.TBL_MESSAGE_LOG.Add(message);
            context.SaveChanges();

        }


        private void ProcessLoanBookingApproval(int loanId, TwoFactorAutheticationViewModel twoFactorAuthDetails, TBL_LOAN loanRecord, ApprovalViewModel user, bool isManual)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var loanReferenceNumber = loanRecord.LOANREFERENCENUMBER;
            decimal totalBookedAmount = 0;

            if (user.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
            {
                loanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                loanRecord.LOANSTATUSID = (int)LoanStatusEnum.Cancelled;
            }
            else
            {
                loanRecord.DATEAPPROVED = DateTime.Now;
                loanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;

                totalBookedAmount = (from a in context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == loanRecord.LOANAPPLICATIONDETAILID) select a).Sum(s => s.PRINCIPALAMOUNT);
                var loanApplicationRecord = context.TBL_LOAN_APPLICATION.Find(loanRecord.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID);

                if (totalBookedAmount >= loanRecord.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT)
                {
                    //var loanApplicationRecord = context.TBL_LOAN_APPLICATION.Find(loanRecord.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID);
                    loanApplicationRecord.APPLICATIONSTATUSID = (int)LoanApplicationStatusEnum.LoanBookingCompleted;
                }

                var convenantDetail = context.TBL_LOAN_COVENANT_DETAIL.Where(c => c.LOANID == loanId)?.FirstOrDefault();
                if (convenantDetail != null)
                {
                    convenantDetail.COVENANTDATE = DateTime.Now;
                    convenantDetail.DATETIMEUPDATED = DateTime.Now;
                    context.SaveChanges();
                }

                var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(loanRecord.LOANAPPLICATIONDETAILID);
                var loanProductInfo = context.TBL_PRODUCT.Find(loanRecord.PRODUCTID);

                if (user.operationId == (int)OperationsEnum.TermLoanBooking)
                {

                    if (loanProductInfo.PRODUCTCLASSID == (short)ProductClassEnum.InvoiceDiscountingFacility)
                    {
                        var casa = context.TBL_CASA.Find(loanRecord.CASAACCOUNTID2);

                        var lienModel = new CasaLienViewModel
                        {
                            productAccountNumber = casa.PRODUCTACCOUNTNUMBER,
                            sourceReferenceNumber = loanRecord.LOANREFERENCENUMBER,
                            userBranchId = (short)user.BranchId,
                            branchId = (short)user.BranchId,
                            companyId = user.companyId,
                            lienAmount = loanRecord.PRINCIPALAMOUNT + loanRecord.OUTSTANDINGINTEREST,
                            description = "Lien for IDF Booking",
                            lienTypeId = (short)LienTypeEnum.IDFBooking,
                            createdBy = user.createdBy,
                            userIPAddress = user.userIPAddress,
                            applicationUrl = user.applicationUrl,
                        };
                        //casaLien.PlaceLien(lienModel, twoFactorAuthDetails);
                        twoFactorAuthDetails.skipAuthentication = true;
                    }

                }

                if (user.operationId == (int)OperationsEnum.CommercialLoanBooking)
                {
                    var totalInterest = getTotalInterest(loanRecord.PRINCIPALAMOUNT, loanRecord.INTERESTRATE, (loanRecord.MATURITYDATE.Date - loanRecord.EFFECTIVEDATE.Date).Days, DayCountConventionEnum.Actual_Actual);

                    loanRecord.OUTSTANDINGINTEREST = totalInterest;

                    if (loanProductInfo.DEALTYPEID == (short)DealTypeEnum.Upfront)
                    {
                        loanRecord.OUTSTANDINGPRINCIPAL = loanRecord.PRINCIPALAMOUNT - totalInterest;
                    }
                    else
                    {
                        loanRecord.OUTSTANDINGPRINCIPAL = loanRecord.PRINCIPALAMOUNT;
                    }
                }

                if (user.operationId == (int)OperationsEnum.ForeignExchangeLoanBooking)
                {
                    var totalInterest = getTotalInterest(loanRecord.PRINCIPALAMOUNT, loanRecord.INTERESTRATE, (loanRecord.MATURITYDATE.Date - loanRecord.EFFECTIVEDATE.Date).Days, DayCountConventionEnum.Actual_Actual);

                    loanRecord.OUTSTANDINGINTEREST = totalInterest;

                    if (loanProductInfo.DEALTYPEID == (short)DealTypeEnum.Upfront)
                    {
                        loanRecord.OUTSTANDINGPRINCIPAL = loanRecord.PRINCIPALAMOUNT - totalInterest;
                    }
                    else
                    {
                        loanRecord.OUTSTANDINGPRINCIPAL = loanRecord.PRINCIPALAMOUNT;
                    }
                }

                loanRecord.LOANSTATUSID = (short)LoanStatusEnum.Active;
                loanRecord.DISBURSEDATE = generalSetup.GetApplicationDate();
                loanRecord.ISDISBURSED = true;
                loanRecord.DISBURSEDATE = DateTime.Now;
                loanRecord.DISBURSEDBY = user.createdBy;
                loanRecord.APPROVEDBY = user.createdBy;
                loanRecord.APPROVERCOMMENT = user.comment;
                loanRecord.ISMANUALBOOKING = isManual;
                loanRecord.COREBANKINGREF = user.coreBankingRef;

                loanRecord.EXT_PRUDENT_GUIDELINE_STATUSID = (int)LoanPrudentialStatusEnum.Performing;
                loanRecord.USER_PRUDENTIAL_GUIDE_STATUSID = (int)LoanPrudentialStatusEnum.Performing;

                if (loanRecord.EFFECTIVEDATE < systemDate)
                {
                    //  ProcessBackDatedTeamLoansInterestAccrual(loanRecord.EFFECTIVEDATE, loanRecord.TERMLOANID);
                }



                /*UPDATING STAFF MIS */
                // this.updateloanStaffMIS(loanRecord);

                context.SaveChanges();
                /* BUILD SCHEDULE MODEL & CALL GENERATE SCHEDULE METHOD */
                var loanScheduleModel = BuildScheduleModel(loanId, user.createdBy);

                //if (user.operationId == (int)OperationsEnum.TermLoanBooking)
                this.loanSchedule.AddLoanSchedule(loanId, loanScheduleModel, user.createdBy);

                /* BUILD DISBURSEMENT MODEL & CALL LOAN DISBURSEMENT METHOD */
                var loanDisbursementModel = BuildDisbursementModel(loanId, loanScheduleModel, user.createdBy);

                if (USE_THIRD_PARTY_INTEGRATION)
                {
                    var userDetail = new UserInfo();
                    List<TBL_LOAN> loanRecords = new List<TBL_LOAN>();
                    userDetail.createdBy = loanRecord.CREATEDBY;
                    userDetail.staffId = loanRecord.CREATEDBY;
                    userDetail.companyId = loanRecord.COMPANYID;

                    loanRecords.Add(loanRecord);
                    // createLoanOnThirdParty(loanRecords, userDetail);

                    LoanViewModel loanApplication = new LoanViewModel()
                    {
                        bookingDate = loanRecord.BOOKINGDATE,
                        effectiveDate = loanRecord.EFFECTIVEDATE,
                        maturityDate = loanRecord.MATURITYDATE,
                        sourceReferenceNumber = loanRecord.LOANREFERENCENUMBER,
                        userBranchId = (short)user.BranchId,
                        branchId = (short)user.BranchId,
                        companyId = user.companyId,
                        principalAmount = loanRecord.PRINCIPALAMOUNT,
                        interestRate = loanRecord.INTERESTRATE,
                        productId = loanRecord.PRODUCTID,
                        casaAccountId = loanRecord.CASAACCOUNTID,
                        loanApplicationDetailId = loanRecord.LOANAPPLICATIONDETAILID,
                        description = "Loan Creation From Flexcube API Call",
                        createdBy = user.createdBy,
                        userIPAddress = user.userIPAddress,
                        applicationUrl = user.applicationUrl,
                    };

                    if (isManual == false) CreateLoanOnThirdParty(loanApplication, loanReferenceNumber);
                }
                //DisburseLoan(loanDisbursementModel, twoFactorAuthDetails);

                if (loanProductInfo?.PRODUCTCODE == "EBFC")
                {
                    var statusCode = "90"; // Disbursement
                    LoanStatusChangeThroughAPI(loanApplicationRecord, user.comment, user.staffId, statusCode);
                }

            }
        }

        private void LoanStatusChangeThroughAPI(TBL_LOAN_APPLICATION loanApplication, string comment, int staffId, string statusCode)
        {
            //string cflReport = builder.ToString();
            string WorkflowStageName = "";
            var staff = context.TBL_STAFF.Where(s => s.STAFFID == staffId).FirstOrDefault();
            var WorkflowStage = context.TBL_STAFF_ROLE.Where(s => s.STAFFROLEID == staff.STAFFROLEID).Select(s => s.STAFFROLECODE).FirstOrDefault();

            if (WorkflowStage == "RM") { WorkflowStageName = "11"; }

            if (WorkflowStage == "CA") { WorkflowStageName = "12"; }
            //if (WorkflowStage.Substring(0, 2) == "CR") { WorkflowStageName = "12"; }

            if (WorkflowStage == "GH") { WorkflowStageName = "13"; }

            if (WorkflowStage == "COA") { WorkflowStageName = "15"; }

            var staffFullName = staff.FIRSTNAME + " " + staff.LASTNAME;

            OfferLetterResponse offerLetters = new OfferLetterResponse();
            offerLetters.StatusCode = statusCode;
            offerLetters.Comment = comment;
            offerLetters.RequestId = loanApplication.APIREQUESTID;
            offerLetters.WorkflowStage = WorkflowStageName;
            //offerLetters.Attachment.FileLink = cflReport;
            //offerLetters.Attachment.FileType = "pdf";
            //offerLetters.ReasonForRejection = ReasonForRejection;
            offerLetters.ActionByName = staffFullName;

            if (WorkflowStageName != "" && loanApplication.APIREQUESTID != null)
            {
                transaction.ApiOfferLetterPosting(offerLetters, loanApplication.APPLICATIONREFERENCENUMBER);
            }
        }

        private void ProcessRevolvingLoanFacilityApproval(int loanId, TwoFactorAutheticationViewModel twoFactorAuthDetails, TBL_LOAN_REVOLVING revolvingLoanRecord, ApprovalViewModel user, int createdBy, bool isManual)
        {
            decimal totalBookedAmount = 0;
            var loanReferenceNumber = revolvingLoanRecord.LOANREFERENCENUMBER;
            var systemDate = generalSetup.GetApplicationDate();
            if (user.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
            {
                revolvingLoanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                revolvingLoanRecord.LOANSTATUSID = (int)LoanStatusEnum.Cancelled;
            }
            else
            {
                var loanApplicationRecord = context.TBL_LOAN_APPLICATION.Find(revolvingLoanRecord.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID);
                totalBookedAmount = (from a in context.TBL_LOAN_REVOLVING.Where(x => x.LOANAPPLICATIONDETAILID == revolvingLoanRecord.LOANAPPLICATIONDETAILID) select a).Sum(s => s.OVERDRAFTLIMIT);
                if (totalBookedAmount >= revolvingLoanRecord.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT)
                {

                    loanApplicationRecord.APPLICATIONSTATUSID = (int)LoanApplicationStatusEnum.LoanBookingCompleted;
                }

                var convenantDetail = context.TBL_LOAN_COVENANT_DETAIL.Where(c => c.LOANID == loanId)?.FirstOrDefault();
                if (convenantDetail != null)
                {
                    convenantDetail.COVENANTDATE = DateTime.Now;
                    convenantDetail.DATETIMEUPDATED = DateTime.Now;
                    context.SaveChanges();
                }

                if (USE_THIRD_PARTY_INTEGRATION)
                {
                    var reviewDate = revolvingLoanRecord.EFFECTIVEDATE.AddDays(31); //.BOOKINGDATE.AddMonths(1);
                    var batchCode = CommonHelpers.GenerateRandomDigitCode(10);
                    var acctType = "DR";

                    var casa = context.TBL_CASA.Find(revolvingLoanRecord.CASAACCOUNTID);
                    var collateralMappings = context.TBL_LOAN_APPLICATION_COLLATERL.Where(x => x.LOANAPPLICATIONID == loanApplicationRecord.LOANAPPLICATIONID);

                    List<int> collateralCustomerIds = new List<int>();
                    foreach (var item in collateralMappings)
                    {
                        collateralCustomerIds.Add(item.COLLATERALCUSTOMERID);
                    }
                    var collaterals = context.TBL_COLLATERAL_CUSTOMER.Where(x => collateralCustomerIds.Contains(x.COLLATERALCUSTOMERID));

                    string collateralcodes = string.Empty;
                    foreach (var i in collaterals) { collateralcodes = collateralcodes + i.COLLATERALCODE; }


                    var product = context.TBL_PRODUCT.Find(revolvingLoanRecord.PRODUCTID);
                    if (product.TBL_PRODUCT_CLASS.PRODUCTCLASSID != (short)ProductClassEnum.Creditcards)
                    {
                        var staffCode = context.TBL_STAFF.Where(O => O.STAFFID == createdBy).FirstOrDefault().STAFFCODE;

                        var model = new FlexcubeCreateOverdraftViewModel
                        {
                            account_no = casa.PRODUCTACCOUNTNUMBER,
                            collateral_code = collateralcodes == "" ? "NOCOLLATERALCODE" : collateralcodes,
                            collateral_value = collaterals.ToList().Count == 0 ? "0" : collaterals.Sum(x => x.COLLATERALVALUE).ToString(),
                            start_date = revolvingLoanRecord.EFFECTIVEDATE.ToString("dd-MMM-yyyy", null),
                            end_date = revolvingLoanRecord.MATURITYDATE.ToString("dd-MMM-yyyy", null),
                            channel_code = "FINTRAK",
                            maker_id = staffCode,
                            checker_id = staffCode,
                            loanId = loanId,
                            loanApplicationId = revolvingLoanRecord.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,

                        };

                        if (isManual == false) integration.FlexcubeOverDraft(model, revolvingLoanRecord.LOANSYSTEMTYPEID);
                    }


                    //if (revolvingLoanRecord.REVOLVINGTYPEID == (short)LoanRevolvingTypeEnum.NormalOverdraft)
                    //{
                    //    InterestRateInquiryViewModel accountOutput = finacle.GetInterestRateInquiry(model.accountNumber, acctType);

                    //    var model = new OverDraftNormalViewModel
                    //    {
                    //        accountNumber = revolvingLoanRecord.TBL_CASA.PRODUCTACCOUNTNUMBER,
                    //        applicationDate = systemDate.ToString("dd-MMM-yyyy", null), //revolvingLoanRecord.EFFECTIVEDATE.ToString("dd-MMM-yyyy", null),
                    //        documentDate = revolvingLoanRecord.EFFECTIVEDATE.ToString("dd-MMM-yyyy", null),
                    //        expiryDate = revolvingLoanRecord.MATURITYDATE.ToString("dd-MMM-yyyy", null),
                    //        reviewedDate = reviewDate.ToString("dd-MMM-yyyy", null),
                    //        sanctionDate = revolvingLoanRecord.EFFECTIVEDATE.ToString("dd-MMM-yyyy", null),
                    //        sanctionLimit = String.Format("{0:0.00}", revolvingLoanRecord.OVERDRAFTLIMIT),
                    //        sanctionReferenceNumber = batchCode,//revolvingLoanRecord.LOANREFERENCENUMBER
                    //        sourceReferenceNumber = revolvingLoanRecord.LOANREFERENCENUMBER,
                    //        interestRateAmount = String.Format("{0:0.00}", revolvingLoanRecord.INTERESTRATE),
                    //        sanctionLevel = "003",
                    //        sanctionAuthorizer = "999"
                    //    };
                    //    InterestRateInquiryViewModel accountOutput = finacle.GetInterestRateInquiry(model.accountNumber, acctType);

                    //    if (accountOutput.interestRateAmount == model.interestRateAmount)
                    //    {
                    //        ResponseMessageViewModel res = finacle.OverDraftNormal(model, twoFactorAuthDetails);
                    //        revolvingLoanRecord.SERIALNUMBER = res.serialNumber;
                    //        twoFactorAuthDetails.skipAuthentication = true;
                    //    }
                    //    else
                    //    {
                    //        var data = new InterestRateInquiryViewModel
                    //        {
                    //            interestRateAmount = String.Format("{0:0.00}", revolvingLoanRecord.INTERESTRATE),
                    //            interestTableCode = accountOutput.interestTableCode,
                    //            accountNumber = revolvingLoanRecord.TBL_CASA.PRODUCTACCOUNTNUMBER,
                    //            endDate = revolvingLoanRecord.MATURITYDATE.ToString("dd-MMM-yyyy", null),
                    //            accountType = acctType,
                    //            startDate = revolvingLoanRecord.EFFECTIVEDATE.ToString("dd-MMM-yyyy", null),
                    //        };

                    //        var result = finacle.ChangeOverDraftInterestRate(data, data.accountType, twoFactorAuthDetails);
                    //        twoFactorAuthDetails.skipAuthentication = true;
                    //        if (result == true)
                    //        {
                    //            twoFactorAuthDetails.skipAuthentication = true;
                    //            ResponseMessageViewModel res = finacle.OverDraftNormal(model, twoFactorAuthDetails);
                    //            revolvingLoanRecord.SERIALNUMBER = res.serialNumber;
                    //            twoFactorAuthDetails.skipAuthentication = true;
                    //        }
                    //        else
                    //        {
                    //            throw new SecureException("OD Operation Not Completed because interest rate cannot be set");
                    //        }
                    //    }
                    //}
                    //if (revolvingLoanRecord.REVOLVINGTYPEID == (short)LoanRevolvingTypeEnum.NormalTemporaryOverdraft)
                    //{
                    //    var model = new TemporaryOverDraftViewModel
                    //    {
                    //        AccountNumber = revolvingLoanRecord.TBL_CASA.PRODUCTACCOUNTNUMBER,
                    //        TemporaryOverDraftFlag = "true",
                    //        TemporaryOverDraftAmount = String.Format("{0:0.00}", revolvingLoanRecord.OVERDRAFTLIMIT),
                    //        TemporaryOverDraftDate = reviewDate.ToString("dd-MMM-yyyy", null),
                    //        TemporaryOverDraftNaration = "Normal Temporary Overdraft",
                    //        TemporaryOverDraftInterestRate = String.Format("{0:0.00}", revolvingLoanRecord.INTERESTRATE),
                    //        sourceReferenceNumber = revolvingLoanRecord.LOANREFERENCENUMBER,
                    //    };
                    //    ResponseMessageViewModel res = finacle.TemporaryOverDraftNormal(model, twoFactorAuthDetails);
                    //    twoFactorAuthDetails.skipAuthentication = true;
                    //    revolvingLoanRecord.SERIALNUMBER = res.serialNumber;
                    //}
                    //if (revolvingLoanRecord.REVOLVINGTYPEID == (short)LoanRevolvingTypeEnum.SingleLimitTemporaryOverdraft)
                    //{
                    //    var model = new TemporaryOverDraftViewModel
                    //    {
                    //        AccountNumber = revolvingLoanRecord.TBL_CASA.PRODUCTACCOUNTNUMBER,
                    //        TemporaryOverDraftFlag = "true",
                    //        TemporaryOverDraftAmount = String.Format("{0:0.00}", revolvingLoanRecord.OVERDRAFTLIMIT),
                    //        TemporaryOverDraftDate = reviewDate.ToString("dd-MMM-yyyy", null),
                    //        TemporaryOverDraftNaration = "Single Limit Temporary Overdraft",
                    //        TemporaryOverDraftInterestRate = String.Format("{0:0.00}", revolvingLoanRecord.INTERESTRATE),
                    //        sourceReferenceNumber = revolvingLoanRecord.LOANREFERENCENUMBER,
                    //    };
                    //    ResponseMessageViewModel res = finacle.TemporaryOverDraftSingle(model, twoFactorAuthDetails);
                    //    revolvingLoanRecord.SERIALNUMBER = res.serialNumber;
                    //    twoFactorAuthDetails.skipAuthentication = true;
                    //}
                }

                /*UPDATING STAFF MIS */
                //this.updateLoanRevolvingStaffMIS(revolvingLoanRecord);

                /* BUILD FEE MODEL & HANDLE FEE POSTING */
                var loanScheduleModel = BuildLoanFeeDisbursementModel(loanId, (short)LoanSystemTypeEnum.OverdraftFacility);
                loanScheduleModel.operationId = revolvingLoanRecord.OPERATIONID;
                loanScheduleModel.createdBy = revolvingLoanRecord.CREATEDBY;
                loanScheduleModel.casaAccountId = revolvingLoanRecord.CASAACCOUNTID;
                loanScheduleModel.companyId = revolvingLoanRecord.COMPANYID;
                loanScheduleModel.loanReferenceNumber = revolvingLoanRecord.LOANREFERENCENUMBER;
                loanScheduleModel.branchId = revolvingLoanRecord.BRANCHID;
                var feePostings = BuildLoanChargeFeesPosting(loanScheduleModel);

                //if (feePostings.Count() > 0)
                //    financeTransaction.PostTransaction(feePostings, false, twoFactorAuthDetails);

                revolvingLoanRecord.DATEAPPROVED = DateTime.Now;
                revolvingLoanRecord.DISBURSEDATE = DateTime.Now;
                revolvingLoanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;
                revolvingLoanRecord.LOANSTATUSID = (short)LoanStatusEnum.Active;
                revolvingLoanRecord.ISDISBURSED = true;
                revolvingLoanRecord.APPROVEDBY = user.createdBy;
                revolvingLoanRecord.APPROVERCOMMENT = user.comment;
                revolvingLoanRecord.ISMANUALBOOKING = isManual;
                revolvingLoanRecord.COREBANKINGREF = user.coreBankingRef;
            }
        }

        private void ProcessContingentLiabilityApproval(int loanId, TwoFactorAutheticationViewModel twoFactorAuthDetails, TBL_LOAN_CONTINGENT contingentLoanRecord, ApprovalViewModel user, bool isManual)
        {
            decimal totalBookedAmount = 0;
            var loanReferenceNumber = contingentLoanRecord.LOANREFERENCENUMBER;
            if (user.approvalStatusId == (short)ApprovalStatusEnum.Disapproved)
            {
                contingentLoanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                contingentLoanRecord.LOANSTATUSID = (int)LoanStatusEnum.Cancelled;
            }
            else
            {
                totalBookedAmount = (from a in context.TBL_LOAN_CONTINGENT.Where(x => x.LOANAPPLICATIONDETAILID == contingentLoanRecord.LOANAPPLICATIONDETAILID) select a).Sum(s => s.CONTINGENTAMOUNT);
                if (totalBookedAmount >= contingentLoanRecord.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT)
                {
                    var loanApplicationRecord = context.TBL_LOAN_APPLICATION.Find(contingentLoanRecord.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID);
                    loanApplicationRecord.APPLICATIONSTATUSID = (int)LoanApplicationStatusEnum.LoanBookingCompleted;
                }

                var convenantDetail = context.TBL_LOAN_COVENANT_DETAIL.Where(c => c.LOANID == loanId)?.FirstOrDefault();
                if (convenantDetail != null)
                {
                    convenantDetail.COVENANTDATE = DateTime.Now;
                    convenantDetail.DATETIMEUPDATED = DateTime.Now;
                    context.SaveChanges();
                }

                contingentLoanRecord.DATEAPPROVED = DateTime.Now;
                contingentLoanRecord.APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved;

                var loanScheduleModel = BuildLoanFeeDisbursementModel(loanId, (short)LoanSystemTypeEnum.ContingentLiability);
                loanScheduleModel.operationId = contingentLoanRecord.OPERATIONID;
                loanScheduleModel.createdBy = contingentLoanRecord.CREATEDBY;
                loanScheduleModel.casaAccountId = contingentLoanRecord.CASAACCOUNTID;
                loanScheduleModel.companyId = contingentLoanRecord.COMPANYID;
                loanScheduleModel.loanReferenceNumber = contingentLoanRecord.LOANREFERENCENUMBER;
                loanScheduleModel.branchId = contingentLoanRecord.BRANCHID;

                var feePostings = BuildLoanChargeFeesPosting(loanScheduleModel);
                //if (feePostings.Count() > 0) { financeTransaction.PostTransaction(feePostings, false, twoFactorAuthDetails); }
                twoFactorAuthDetails.skipAuthentication = true;

                var loanProductInfo = context.TBL_PRODUCT.Find(contingentLoanRecord.PRODUCTID);
                var productBehaviour = loanProductInfo.TBL_PRODUCT_BEHAVIOUR.Where(x => x.PRODUCTID == loanProductInfo.PRODUCTID);
                if (loanProductInfo.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees && productBehaviour.Any() && productBehaviour.FirstOrDefault().ALLOWFUNDUSAGE == true)
                {   /* LIENABLE BOND AND GAURANTEE SPECIFIC TRANSACTION ENTRIES WHERE PRODUCT ALLOW FUND USAGE */
                    var casa1 = context.TBL_CASA.Where(x => x.CASAACCOUNTID == contingentLoanRecord.CASAACCOUNTID).FirstOrDefault();


                    var lienModel = new CasaLienViewModel
                    {
                        productAccountNumber = casa1.PRODUCTACCOUNTNUMBER,
                        sourceReferenceNumber = contingentLoanRecord.LOANREFERENCENUMBER,
                        userBranchId = (short)user.BranchId,
                        branchId = (short)user.BranchId,
                        companyId = user.companyId,
                        lienAmount = contingentLoanRecord.CONTINGENTAMOUNT,
                        description = "Lien for APG Fund",
                        lienTypeId = (short)LienTypeEnum.APGBooking,
                        createdBy = user.createdBy,
                        userIPAddress = user.userIPAddress,
                        applicationUrl = user.applicationUrl,
                    };
                    //casaLien.PlaceLien(lienModel, twoFactorAuthDetails);
                    twoFactorAuthDetails.skipAuthentication = true;
                }

                /* DEBIT B&G CUSTOMER WHERE PRODUCT DOES NOT ALLOW FUND USAGE */
                var casa = context.TBL_CASA.Where(x => x.PRODUCTID == loanProductInfo.PRODUCTID).FirstOrDefault();
                var basicPostInputs = new BasicTrasactionSourceInputModel
                {
                    sourceApplicationId = (short)contingentLoanRecord.CONTINGENTLOANID,
                    applicationUrl = user.applicationUrl,
                    description = "Contingent Liability Issuance",
                    companyId = user.companyId,
                    createdBy = user.createdBy,
                    userBranchId = (short)user.BranchId,
                    userIPAddress = user.userIPAddress
                };
                // PostContingentLiabilityPrincipalEntry((int)loanProductInfo.PRINCIPALBALANCEGL, (int)loanProductInfo.PRINCIPALBALANCEGL2, contingentLoanRecord, contingentLoanRecord.CONTINGENTAMOUNT, basicPostInputs, twoFactorAuthDetails);
                twoFactorAuthDetails.skipAuthentication = true;

                /*UPDATING STAFF MIS */
                //this.updateLoanContingentStaffMIS(contingentLoanRecord);

                contingentLoanRecord.LOANSTATUSID = (short)LoanStatusEnum.Active;
                contingentLoanRecord.ISDISBURSED = true;
                contingentLoanRecord.DISBURSEDATE = DateTime.Now; ;
                contingentLoanRecord.APPROVEDBY = user.createdBy;
                contingentLoanRecord.APPROVERCOMMENT = user.comment;
                contingentLoanRecord.ISMANUALBOOKING = isManual;
                contingentLoanRecord.COREBANKINGREF = user.coreBankingRef;
            }
            context.SaveChanges();
        }

        private void updateLoanRevolvingStaffMIS(TBL_LOAN_REVOLVING revolvingLoanRecord)
        {
            FinTrakBankingStagingContext staggingContext = new FinTrakBankingStagingContext();
            StaffMIS staffMIS = new StaffMIS(context, staggingContext);

            var relationshipOfficerStaffInfo = staffMIS.StaffInformationSystem(revolvingLoanRecord.RELATIONSHIPOFFICERID);
            revolvingLoanRecord.FIELD1 = relationshipOfficerStaffInfo.field1;
            revolvingLoanRecord.FIELD2 = relationshipOfficerStaffInfo.field2;
            revolvingLoanRecord.FIELD3 = relationshipOfficerStaffInfo.field3;
            revolvingLoanRecord.FIELD4 = relationshipOfficerStaffInfo.field4;
            revolvingLoanRecord.FIELD5 = relationshipOfficerStaffInfo.field5;
            revolvingLoanRecord.FIELD6 = relationshipOfficerStaffInfo.field6;
            revolvingLoanRecord.FIELD7 = relationshipOfficerStaffInfo.field7;
            revolvingLoanRecord.FIELD8 = relationshipOfficerStaffInfo.field8;
            revolvingLoanRecord.FIELD9 = relationshipOfficerStaffInfo.field9;
            revolvingLoanRecord.FIELD10 = relationshipOfficerStaffInfo.field10;
        }

        private void updateloanStaffMIS(TBL_LOAN loanRecord)
        {
            FinTrakBankingStagingContext staggingContext = new FinTrakBankingStagingContext();
            StaffMIS staffMIS = new StaffMIS(context, staggingContext);

            var relationshipOfficerStaffInfo = staffMIS.StaffInformationSystem(loanRecord.RELATIONSHIPOFFICERID);
            loanRecord.FIELD1 = relationshipOfficerStaffInfo.field1;
            loanRecord.FIELD2 = relationshipOfficerStaffInfo.field2;
            loanRecord.FIELD3 = relationshipOfficerStaffInfo.field3;
            loanRecord.FIELD4 = relationshipOfficerStaffInfo.field4;
            loanRecord.FIELD5 = relationshipOfficerStaffInfo.field5;
            loanRecord.FIELD6 = relationshipOfficerStaffInfo.field6;
            loanRecord.FIELD7 = relationshipOfficerStaffInfo.field7;
            loanRecord.FIELD8 = relationshipOfficerStaffInfo.field8;
            loanRecord.FIELD9 = relationshipOfficerStaffInfo.field9;
            loanRecord.FIELD10 = relationshipOfficerStaffInfo.field10;
        }

        private void updateLoanContingentStaffMIS(TBL_LOAN_CONTINGENT contingentLoanRecord)
        {
            FinTrakBankingStagingContext staggingContext = new FinTrakBankingStagingContext();
            StaffMIS staffMIS = new StaffMIS(context, staggingContext);

            var relationshipOfficerStaffInfo = staffMIS.StaffInformationSystem(contingentLoanRecord.RELATIONSHIPOFFICERID);
            contingentLoanRecord.FIELD1 = relationshipOfficerStaffInfo.field1;
            contingentLoanRecord.FIELD2 = relationshipOfficerStaffInfo.field2;
            contingentLoanRecord.FIELD3 = relationshipOfficerStaffInfo.field3;
            contingentLoanRecord.FIELD4 = relationshipOfficerStaffInfo.field4;
            contingentLoanRecord.FIELD5 = relationshipOfficerStaffInfo.field5;
            contingentLoanRecord.FIELD6 = relationshipOfficerStaffInfo.field6;
            contingentLoanRecord.FIELD7 = relationshipOfficerStaffInfo.field7;
            contingentLoanRecord.FIELD8 = relationshipOfficerStaffInfo.field8;
            contingentLoanRecord.FIELD9 = relationshipOfficerStaffInfo.field9;
            contingentLoanRecord.FIELD10 = relationshipOfficerStaffInfo.field10;
        }

        private IEnumerable<DailyInterestAccrualViewModel> ProcessAccrualTeamLoansInterestAccrual(DateTime applicationDate, int loanId)
        {
            var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);
            var schedule = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == loanId && x.DATE <= DbFunctions.TruncateTime(applicationDate));
            int count = schedule.Count();

            var data = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                        join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                        join c in context.TBL_LOAN_SCHEDULE_PERIODIC on b.TERMLOANID equals c.LOANID
                        join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
                        where a.DATE <= DbFunctions.TruncateTime(applicationDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active && a.LOANID == loanId

                        select new DailyInterestAccrualViewModel()
                        {
                            referenceNumber = b.LOANREFERENCENUMBER,
                            productId = b.PRODUCTID,
                            branchId = b.BRANCHID,
                            companyId = b.COMPANYID,
                            currencyId = b.CURRENCYID,
                            exchangeRate = b.EXCHANGERATE,
                            interestRate = a.INTERESTRATE,
                            date = applicationDate,
                            dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT,
                            mainAmount = c.PERIODINTERESTAMOUNT,
                            categoryId = (short)DailyAccrualCategory.TermLoan,
                            transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                            baseReferenceNumber = null,
                            dayCountConventionId = d.DAYCOUNTCONVENTIONID,

                        }).ToList();

            List<TBL_DAILY_ACCRUAL> transAccrual = new List<TBL_DAILY_ACCRUAL>();


            foreach (var item in data)
            {
                TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                dailyAccrual.PRODUCTID = item.productId;
                dailyAccrual.BRANCHID = item.branchId;
                dailyAccrual.EXCHANGERATE = item.exchangeRate;
                dailyAccrual.CURRENCYID = item.currencyId;
                dailyAccrual.INTERESTRATE = item.interestRate;
                dailyAccrual.DATE = item.date;
                dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs(item.dailyAccuralAmount);
                dailyAccrual.MAINAMOUNT = item.mainAmount;
                dailyAccrual.CATEGORYID = item.categoryId;
                dailyAccrual.COMPANYID = item.companyId;
                dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
                dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
                dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;


                transAccrual.Add(dailyAccrual);

            }
            this.context.TBL_DAILY_ACCRUAL.AddRange(transAccrual);
            context.SaveChanges();

            //var model = (from a in context.TBL_DAILY_ACCRUAL
            //             where a.DATE == DbFunctions.TruncateTime(applicationDate) && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan
            //             group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID, a.EXCHANGERATE } into groupedQ
            //             select new DailyInterestAccrualViewModel()
            //             {
            //                 productId = groupedQ.Key.PRODUCTID,
            //                 branchId = groupedQ.Key.BRANCHID,
            //                 companyId = groupedQ.Key.COMPANYID,
            //                 currencyId = groupedQ.Key.CURRENCYID,
            //                 exchangeRate = groupedQ.Key.EXCHANGERATE,
            //                 dailyAccuralAmount = (double)groupedQ.Sum(i => i.DAILYACCURALAMOUNT),
            //             }).ToList();

            //foreach (var item in model)
            //{
            //    financeTransaction.PostDailyLoansInterestAccrual(item);
            //}
            //context.SaveChanges();
            return data;
        }

        public LoanPaymentScheduleInputViewModel BuildScheduleModel(int targetId, int createdBy)
        {
            List<IrregularLoanScheduleInputViewModel> irregularPaymentScheduleList = new List<IrregularLoanScheduleInputViewModel>();
            var loanIrregularRecord = context.TBL_LOAN_SCHEDULE_IREGUL_INPUT.Where(x => x.LOANID == targetId);
            foreach (var irregularLoan in loanIrregularRecord)
            {
                var irregularViewData = new IrregularLoanScheduleInputViewModel
                {
                    paymentAmount = (double)irregularLoan.PAYMENTAMOUNT,
                    paymentDate = irregularLoan.PAYMENTDATE
                };
                irregularPaymentScheduleList.Add(irregularViewData);
            };

            var loanScheduleData = context.TBL_LOAN.Find(targetId);
            var loanFeeData = context.TBL_LOAN_FEE.Where(x => x.LOANID == targetId && x.ISINTEGRALFEE == true);
            double integraFeeAmount = 0;

            //var effectiveDate = loanScheduleData.EFFECTIVEDATE;
            //var maturityDate = effectiveDate.AddDays(loanScheduleData.TBL_LOAN_APPLICATION_DETAIL.APPROVEDTENOR);

            foreach (var record in loanFeeData)
            {
                integraFeeAmount = integraFeeAmount + (double)record.FEEAMOUNT;
            }

            var scheduleModel = new LoanPaymentScheduleInputViewModel();
            if (loanScheduleData.SCHEDULETYPEID == (short)LoanScheduleTypeEnum.BulletPayment)
            {
                loanScheduleData.PRINCIPALFREQUENCYTYPEID = null;
                loanScheduleData.INTERESTFREQUENCYTYPEID = null;

            }

            if (loanScheduleData.OPERATIONID == (short)OperationsEnum.CommercialLoanBooking || loanScheduleData.OPERATIONID == (short)OperationsEnum.ForeignExchangeLoanBooking)
            {
                if (loanScheduleData.SCHEDULETYPEID == 0)
                    loanScheduleData.SCHEDULETYPEID = (short)LoanScheduleTypeEnum.BulletPayment;
                if (loanScheduleData.SCHEDULEDAYCOUNTCONVENTIONID == 0)
                    loanScheduleData.SCHEDULETYPEID = (short)DayCountConventionEnum.Actual_Actual;
                if (loanScheduleData.FIRSTPRINCIPALPAYMENTDATE == null)
                    loanScheduleData.FIRSTPRINCIPALPAYMENTDATE = loanScheduleData.MATURITYDATE;
                if (loanScheduleData.FIRSTPRINCIPALPAYMENTDATE == null)
                    loanScheduleData.FIRSTINTERESTPAYMENTDATE = loanScheduleData.MATURITYDATE;
            }


            scheduleModel = new LoanPaymentScheduleInputViewModel();

            scheduleModel.scheduleMethodId = loanScheduleData.SCHEDULETYPEID;
            scheduleModel.principalAmount = (double)loanScheduleData.PRINCIPALAMOUNT;
            scheduleModel.effectiveDate = loanScheduleData.EFFECTIVEDATE;
            scheduleModel.interestRate = loanScheduleData.INTERESTRATE;
            scheduleModel.principalFrequency = loanScheduleData.PRINCIPALFREQUENCYTYPEID;
            scheduleModel.interestFrequency = loanScheduleData.INTERESTFREQUENCYTYPEID;
            scheduleModel.tenor = (loanScheduleData.MATURITYDATE.Date - loanScheduleData.EFFECTIVEDATE.Date).Days;
            scheduleModel.principalFirstpaymentDate = (DateTime)loanScheduleData.FIRSTPRINCIPALPAYMENTDATE;
            scheduleModel.interestFirstpaymentDate = (DateTime)loanScheduleData.FIRSTINTERESTPAYMENTDATE; //
            scheduleModel.maturityDate = loanScheduleData.MATURITYDATE;
            scheduleModel.accrualBasis = loanScheduleData.SCHEDULEDAYCOUNTCONVENTIONID;
            scheduleModel.integralFeeAmount = integraFeeAmount;
            scheduleModel.shouldDisburse = loanScheduleData.SHOULD_DISBURSE;
            scheduleModel.firstDayType = loanScheduleData.SCHEDULEDAYINTERESTTYPEID;
            scheduleModel.irregularPaymentSchedule = irregularPaymentScheduleList;


            return scheduleModel;
        }

        private LoanPaymentScheduleInputViewModel BuildBaloonScheduleModel(int targetId, int createdBy)
        {
            var loanScheduleData = context.TBL_LOAN.Find(targetId);
            var loanFeeData = context.TBL_LOAN_FEE.Where(x => x.LOANID == targetId && x.ISINTEGRALFEE == true);
            double integraFeeAmount = 0;

            var effectiveDate = loanScheduleData.EFFECTIVEDATE;
            var maturityDate = effectiveDate.AddDays(loanScheduleData.TBL_LOAN_APPLICATION_DETAIL.APPROVEDTENOR);

            foreach (var record in loanFeeData)
            {
                integraFeeAmount = integraFeeAmount + (double)record.FEEAMOUNT;
            }
            if (loanScheduleData.SCHEDULETYPEID == (short)LoanScheduleTypeEnum.BulletPayment)
            {
                loanScheduleData.PRINCIPALFREQUENCYTYPEID = null;
                loanScheduleData.INTERESTFREQUENCYTYPEID = null;

            }
            var scheduleModel = new LoanPaymentScheduleInputViewModel
            {
                scheduleMethodId = (short)LoanScheduleTypeEnum.BallonPayment,

                principalAmount = (double)loanScheduleData.PRINCIPALAMOUNT,
                effectiveDate = effectiveDate,
                interestRate = loanScheduleData.INTERESTRATE,
                principalFrequency = loanScheduleData.PRINCIPALFREQUENCYTYPEID,
                interestFrequency = loanScheduleData.INTERESTFREQUENCYTYPEID,
                tenor = (loanScheduleData.MATURITYDATE - loanScheduleData.EFFECTIVEDATE).Days,
                principalFirstpaymentDate = (DateTime)loanScheduleData.FIRSTPRINCIPALPAYMENTDATE,
                interestFirstpaymentDate = (DateTime)loanScheduleData.FIRSTINTERESTPAYMENTDATE,
                maturityDate = maturityDate,
                accrualBasis = (short)DayCountConventionEnum.Actual_360,
                integralFeeAmount = integraFeeAmount,
                shouldDisburse = loanScheduleData.SHOULD_DISBURSE,
                firstDayType = loanScheduleData.SCHEDULEDAYINTERESTTYPEID,
            };

            return scheduleModel;
        }

        private LoanViewModel BuildLoanFeeDisbursementModel(int loanId, short loanSystemTypeId)
        {
            //List<TBL_LOAN_FEE> feeRecords = new List<TBL_LOAN_FEE>();
            var feeRecords = context.TBL_LOAN_FEE.Where(x => x.LOANID == loanId && x.LOANSYSTEMTYPEID == loanSystemTypeId && x.ISPOSTED == false).ToList();
            LoanViewModel loanModel;

            List<LoanChargeFeeViewModel> loanChargeFeeList = new List<LoanChargeFeeViewModel>();
            foreach (var fee in feeRecords)
            {
                var loanfee = new LoanChargeFeeViewModel
                {
                    loanChargeFeeId = fee.LOANCHARGEFEEID,
                    chargeFeeId = fee.CHARGEFEEID,
                    loanId = fee.LOANID,
                    loanSystemTypeId = fee.LOANSYSTEMTYPEID,
                    feeRateValue = fee.FEERATEVALUE,
                    feeDependentAmount = fee.FEERATEVALUE,
                    feeAmount = fee.FEEAMOUNT,
                    isIntegralFee = fee.ISINTEGRALFEE,
                    recurring = fee.ISRECURRING,
                };
                loanChargeFeeList.Add(loanfee);
            };
            loanModel = new LoanViewModel
            {
                loanChargeFee = loanChargeFeeList,
            };

            return loanModel;
        }

        public LoanViewModel BuildDisbursementModel(int loanId, LoanPaymentScheduleInputViewModel loanInputModel, int staffId)
        {
            var covenantRecord = context.TBL_LOAN_COVENANT_DETAIL.Where(x => x.LOANID == loanId).ToList();
            List<LoanCovenantDetailViewModel> loanCovenantList = new List<LoanCovenantDetailViewModel>();

            foreach (var covenant in covenantRecord)
            {
                var loanCovenant = new LoanCovenantDetailViewModel
                {
                    loanCovenantDetailId = covenant.LOANCOVENANTDETAILID,
                    covenantDetail = covenant.COVENANTDETAIL,
                    loanId = covenant.LOANID,
                    covenantTypeId = covenant.COVENANTTYPEID,
                    frequencyTypeId = covenant.FREQUENCYTYPEID,
                    covenantAmount = covenant.COVENANTAMOUNT ?? 0,
                    covenantDate = covenant.COVENANTDATE,

                };
                loanCovenantList.Add(loanCovenant);
            };

            var feeRecord = context.TBL_LOAN_FEE.Where(x => x.LOANID == loanId && x.ISPOSTED == false).ToList();
            List<LoanChargeFeeViewModel> loanChargeFeeList = new List<LoanChargeFeeViewModel>();
            foreach (var fee in feeRecord)
            {
                var loanfee = new LoanChargeFeeViewModel
                {
                    loanChargeFeeId = fee.LOANCHARGEFEEID,
                    chargeFeeId = fee.CHARGEFEEID,
                    loanId = fee.LOANID,
                    loanSystemTypeId = fee.LOANSYSTEMTYPEID,
                    feeRateValue = fee.FEERATEVALUE,
                    feeDependentAmount = fee.FEERATEVALUE,
                    feeAmount = fee.FEEAMOUNT,
                    isIntegralFee = fee.ISINTEGRALFEE,
                    recurring = fee.ISRECURRING,
                };
                loanChargeFeeList.Add(loanfee);
            };

            var loanRecord = context.TBL_LOAN.Find(loanId);
            if (loanRecord.SCHEDULETYPEID == (short)LoanScheduleTypeEnum.BulletPayment)
            {
                loanRecord.PRINCIPALFREQUENCYTYPEID = null;
                loanRecord.INTERESTFREQUENCYTYPEID = null;
            }

            LoanViewModel loanModel;
            if (loanRecord.OPERATIONID == (short)OperationsEnum.TermLoanBooking)
            {
                loanModel = new LoanViewModel
                {
                    loanId = loanRecord.TERMLOANID,
                    customerId = loanRecord.CUSTOMERID,
                    productId = loanRecord.PRODUCTID,
                    casaAccountId = loanRecord.CASAACCOUNTID,
                    loanBookingRequestId = loanRecord.LOAN_BOOKING_REQUESTID ?? 0,
                    loanApplicationDetailId = (int)loanRecord.LOANAPPLICATIONDETAILID,
                    branchId = loanRecord.BRANCHID,
                    loanReferenceNumber = loanRecord.LOANREFERENCENUMBER,
                    applicationReferenceNumber = loanRecord.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER,
                    principalFrequencyTypeId = loanRecord.PRINCIPALFREQUENCYTYPEID,
                    interestFrequencyTypeId = loanRecord.INTERESTFREQUENCYTYPEID,
                    principalNumberOfInstallment = loanRecord.PRINCIPALNUMBEROFINSTALLMENT,
                    interestNumberOfInstallment = loanRecord.INTERESTNUMBEROFINSTALLMENT,
                    interestRate = loanRecord.INTERESTRATE,
                    effectiveDate = generalSetup.GetApplicationDate(),
                    maturityDate = generalSetup.GetApplicationDate().AddDays(loanRecord.TBL_LOAN_APPLICATION_DETAIL.APPROVEDTENOR),
                    principalAmount = loanRecord.PRINCIPALAMOUNT,
                    createdBy = staffId,
                    loanStatusId = loanRecord.LOANSTATUSID,
                    scheduleTypeId = loanRecord.SCHEDULETYPEID,
                    operationId = (int)OperationsEnum.TermLoanBooking,
                    customerGroupId = loanRecord.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                    loanTypeId = loanRecord.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                    firstPrincipalPaymentDate = loanRecord.FIRSTPRINCIPALPAYMENTDATE,
                    firstInterestPaymentDate = loanRecord.FIRSTINTERESTPAYMENTDATE,
                    companyId = loanRecord.COMPANYID,
                    currencyId = loanRecord.CURRENCYID,
                    accurialBasis = loanRecord.SCHEDULEDAYCOUNTCONVENTIONID,
                    integralFeeAmount = (decimal)loanInputModel.integralFeeAmount,
                    firstDayType = loanRecord.SCHEDULEDAYINTERESTTYPEID,
                    loanChargeFee = loanChargeFeeList,
                };
            }
            else
            {
                var operationId = 0;
                if (loanRecord.OPERATIONID == (short)OperationsEnum.CommercialLoanBooking)
                    operationId = (short)OperationsEnum.CommercialLoanBooking;
                if (loanRecord.OPERATIONID == (short)OperationsEnum.ForeignExchangeLoanBooking)
                    operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;

                loanModel = new LoanViewModel();

                loanModel.loanId = loanRecord.TERMLOANID;
                loanModel.customerId = loanRecord.CUSTOMERID;
                loanModel.productId = loanRecord.PRODUCTID;
                loanModel.casaAccountId = loanRecord.CASAACCOUNTID;
                loanModel.loanApplicationDetailId = (int)loanRecord.LOANAPPLICATIONDETAILID;
                loanModel.branchId = loanRecord.BRANCHID;
                loanModel.loanReferenceNumber = loanRecord.LOANREFERENCENUMBER;
                loanModel.interestRate = loanRecord.INTERESTRATE;
                loanModel.effectiveDate = loanRecord.EFFECTIVEDATE;
                loanModel.maturityDate = loanRecord.MATURITYDATE;
                loanModel.principalAmount = loanRecord.PRINCIPALAMOUNT;
                loanModel.createdBy = staffId;
                loanModel.loanStatusId = loanRecord.LOANSTATUSID;
                loanModel.operationId = operationId;
                loanModel.companyId = loanRecord.COMPANYID;
                loanModel.currencyId = loanRecord.CURRENCYID;
                loanModel.integralFeeAmount = (decimal)loanInputModel.integralFeeAmount;
                loanModel.loanChargeFee = loanChargeFeeList;
                loanModel.loanBookingRequestId = loanRecord.LOAN_BOOKING_REQUESTID ?? 0;

                var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(loanRecord.LOANAPPLICATIONDETAILID);
                if (applicationDetail != null)
                {
                    loanModel.customerGroupId = applicationDetail.TBL_LOAN_APPLICATION.CUSTOMERGROUPID;
                    loanModel.loanTypeId = applicationDetail.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID;
                    loanModel.applicationReferenceNumber = applicationDetail.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER;
                }


            }

            return loanModel;
        }

        //private string getLoanDisbursementDescription(LoanViewModel model)
        //{
        //    var loanDescription = "FTK" + model.loanReferenceNumber + " disbursement";

        //    //if (model.productTypeId == (short)LoanProductTypeEnum.TermLoan)
        //    //    loanDescription = "Term Loan Disbursement";

        //    //if (model.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating)
        //    //    loanDescription = "Self Liquidating Loan Disbursement";

        //    //if (model.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
        //    //    loanDescription = "Syndicated Loan Disbursement";

        //    //if ((int)model.productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
        //    //    loanDescription = "Commercial Loan Disbursement";

        //    //if ((int)model.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
        //    //    loanDescription = "fx revolving Loan Disbursement";

        //    return loanDescription;
        //}

        public List<FinanceTransactionViewModel> BuildLoanDisbursmentPosting(LoanViewModel model)
        {
            List<FinanceTransactionViewModel> loanTransaction = new List<FinanceTransactionViewModel>();

            var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == model.casaAccountId && x.COMPANYID == model.companyId);
            var product = this.context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == model.productId && x.COMPANYID == model.companyId);
            var batchCode = CommonHelpers.GenerateRandomDigitCode(10);
            var description = string.Empty;
            var loan = context.TBL_LOAN.Find(model.loanId);
            var company = context.TBL_COMPANY.Find(loan.COMPANYID);
            var loanDisbursement = context.TBL_LOAN_DISBURSEMENT.Where(x => x.TERMLOANID == model.loanId);
            string rateCode = "";
            TBL_CUSTOM_CHART_OF_ACCOUNT customNostro = new TBL_CUSTOM_CHART_OF_ACCOUNT();


            //loanTransaction.operationId = (int)OperationsEnum.TermLoanBooking;
            //loanTransaction.description = "Loan Disbursment Amount";
            //loanTransaction.valueDate = generalSetup.GetApplicationDate();
            //loanTransaction.transactionDate = loanTransaction.valueDate;
            //loanTransaction.currencyId = casa.CURRENCYID;
            //loanTransaction.currencyRate = financeTransaction.GetExchangeRate(loanTransaction.valueDate,loanTransaction.currencyId, model.companyId).sellingRate;
            //loanTransaction.isApproved = true;
            //loanTransaction.postedBy = model.createdBy;
            //loanTransaction.approvedBy = model.createdBy;
            //loanTransaction.approvedDate = loanTransaction.transactionDate;
            //loanTransaction.approvedDateTime = DateTime.Now;
            //loanTransaction.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
            //loanTransaction.companyId = model.companyId;

            //FinanceTransactionDetailViewModel debit = new FinanceTransactionDetailViewModel();

            List<FinanceTransactionViewModel> debits = new List<FinanceTransactionViewModel>();
            FinanceTransactionViewModel debit = new FinanceTransactionViewModel();

            var loanDescription = "FTK" + model.loanReferenceNumber + " disbursement"; //getLoanDisbursementDescription(model);
            if (loanDescription.Length > 40)
            {
                loanDescription = loanDescription.Substring(0, 40);
            }

            debit.operationId = (int)model.operationId;
            debit.description = loanDescription; // $"Loan disbursement";
            debit.valueDate = generalSetup.GetApplicationDate();
            debit.transactionDate = debit.valueDate;

            //LOAN DEBIT ENTRIES FOR POSTING
            if (model.productTypeId != (int)LoanProductTypeEnum.ForeignXRevolving)
            {
                //...NAIRA LOANS DEBIT ...
                if (loan.CURRENCYID == company.CURRENCYID)
                {
                    debit.currencyId = casa.CURRENCYID;
                    debit.currencyRate = financeTransaction.GetExchangeRate(debit.valueDate, debit.currencyId, model.companyId).sellingRate;
                    debit.isApproved = true;
                    debit.postedBy = model.createdBy;
                    debit.approvedBy = model.createdBy;
                    debit.approvedDate = debit.transactionDate;
                    debit.approvedDateTime = DateTime.Now;
                    debit.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
                    debit.companyId = model.companyId;

                    if (context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == product.PRODUCTID).PRINCIPALBALANCEGL == null)
                        throw new BadLogicException("No GL is currently mapped to this product code '{product.PRODUCTCODE}'.");

                    debit.glAccountId = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == product.PRODUCTID).PRINCIPALBALANCEGL.Value;
                    debit.sourceReferenceNumber = model.loanReferenceNumber;
                    debit.batchCode = batchCode;
                    debit.casaAccountId = null;
                    debit.debitAmount = model.principalAmount;
                    debit.creditAmount = 0;
                    debit.sourceBranchId = model.branchId;
                    debit.destinationBranchId = casa.BRANCHID;
                    debits.Add(debit);
                }

                //...NON REVOLVING FOREIGN LOANS DEBIT...
                if (loan.CURRENCYID != company.CURRENCYID)
                {
                    debit.currencyId = loan.CURRENCYID;
                    debit.currencyRate = financeTransaction.GetExchangeRate(debit.valueDate, debit.currencyId, model.companyId).sellingRate;  //(double)loan.NOSTRORATEAMOUNT; 

                    rateCode = this.context.TBL_CURRENCY_RATECODE.FirstOrDefault(x => x.RATECODEID == loan.NOSTRORATECODEID).RATECODE;
                    customNostro = context.TBL_CUSTOM_CHART_OF_ACCOUNT.Where(x => x.ACCOUNTID == loan.NOSTROACCOUNTID && x.ISNOSTROACCOUNT == true).FirstOrDefault();

                    debit.rateCode = rateCode;
                    debit.rateUnit = String.Format("{0:0.00}", loan.NOSTRORATEAMOUNT);
                    debit.currencyCrossCode = customNostro.CURRENCYCODE;

                    debit.isApproved = true;
                    debit.postedBy = model.createdBy;
                    debit.approvedBy = model.createdBy;
                    debit.approvedDate = debit.transactionDate;
                    debit.approvedDateTime = DateTime.Now;
                    debit.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
                    debit.companyId = model.companyId;

                    if (context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == product.PRODUCTID).PRINCIPALBALANCEGL == null)
                        throw new BadLogicException("No GL is currently mapped to this product code '{product.PRODUCTCODE}'.");

                    debit.glAccountId = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == product.PRODUCTID).PRINCIPALBALANCEGL.Value;
                    debit.sourceReferenceNumber = model.loanReferenceNumber;
                    debit.batchCode = batchCode;
                    debit.casaAccountId = null;
                    debit.debitAmount = model.principalAmount;
                    debit.creditAmount = 0;
                    debit.sourceBranchId = model.branchId;
                    debit.destinationBranchId = casa.BRANCHID;
                    debits.Add(debit);
                }
            }
            else
            {
                //...FX REVOLVING LOANS DEBIT...
                foreach (var item in loanDisbursement)
                {
                    debit.currencyId = loan.CURRENCYID;
                    debit.currencyRate = financeTransaction.GetExchangeRate(debit.valueDate, debit.currencyId, model.companyId).sellingRate;  //(double)loan.NOSTRORATEAMOUNT; //financeTransaction.GetExchangeRate(debit.valueDate, debit.currencyId, model.companyId).sellingRate;

                    rateCode = this.context.TBL_CURRENCY_RATECODE.FirstOrDefault(x => x.RATECODEID == loan.NOSTRORATECODEID).RATECODE;
                    customNostro = context.TBL_CUSTOM_CHART_OF_ACCOUNT.Where(x => x.ACCOUNTID == loan.NOSTROACCOUNTID && x.ISNOSTROACCOUNT == true).FirstOrDefault();

                    debit.rateCode = rateCode;
                    debit.rateUnit = String.Format("{0:0.00}", loan.NOSTRORATEAMOUNT); //loan.NOSTRORATEAMOUNT;
                    debit.currencyCrossCode = customNostro.CURRENCYCODE;

                    debit.isApproved = true;
                    debit.postedBy = model.createdBy;
                    debit.approvedBy = model.createdBy;
                    debit.approvedDate = debit.transactionDate;
                    debit.approvedDateTime = DateTime.Now;
                    debit.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
                    debit.companyId = model.companyId;

                    if (context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == product.PRODUCTID).PRINCIPALBALANCEGL == null)
                        throw new BadLogicException("No GL is currently mapped to this product code '{product.PRODUCTCODE}'.");

                    debit.glAccountId = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == product.PRODUCTID).PRINCIPALBALANCEGL.Value;
                    debit.sourceReferenceNumber = model.loanReferenceNumber;
                    debit.batchCode = batchCode;
                    debit.casaAccountId = null;
                    debit.debitAmount = model.principalAmount;
                    debit.creditAmount = 0;
                    debit.sourceBranchId = model.branchId;
                    debit.destinationBranchId = casa.BRANCHID;
                    debits.Add(debit);
                }
            }


            //LOAN CREDIT ENTRIES FOR POSTING
            List<FinanceTransactionViewModel> credits = new List<FinanceTransactionViewModel>();

            if (model.productTypeId != (int)LoanProductTypeEnum.ForeignXRevolving)
            {
                FinanceTransactionViewModel credit = new FinanceTransactionViewModel();
                //...NAIRA LOANS CREDIT...
                if (loan.CURRENCYID == company.CURRENCYID)
                {
                    credit.operationId = (int)model.operationId;
                    credit.description = loanDescription; // "Loan disbursement";
                    credit.valueDate = debit.valueDate;
                    credit.transactionDate = debit.valueDate;
                    credit.currencyId = casa.CURRENCYID;
                    credit.currencyRate = financeTransaction.GetExchangeRate(debit.valueDate, debit.currencyId, model.companyId).sellingRate;
                    credit.isApproved = true;
                    credit.postedBy = model.createdBy;
                    credit.approvedBy = model.createdBy;
                    credit.approvedDate = debit.transactionDate;
                    credit.approvedDateTime = DateTime.Now;
                    credit.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
                    credit.companyId = model.companyId;

                    var repaymentAccountGL = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == casa.PRODUCTID).PRINCIPALBALANCEGL.Value;
                    credit.glAccountId = repaymentAccountGL;
                    credit.sourceReferenceNumber = model.loanReferenceNumber;
                    credit.batchCode = batchCode;
                    credit.casaAccountId = casa.CASAACCOUNTID;
                    credit.debitAmount = 0;
                    credit.creditAmount = model.principalAmount;
                    credit.sourceBranchId = model.branchId;
                    credit.destinationBranchId = model.branchId;
                    credits.Add(credit);
                }

                //...NON REVOLVING FOREIGN LOANS CREDIT...
                if (loan.CURRENCYID != company.CURRENCYID)
                {
                    var nostroGL = context.TBL_CHART_OF_ACCOUNT.Where(x => x.ACCOUNTCODE == customNostro.ACCOUNTID).FirstOrDefault();
                    credit.operationId = (int)model.operationId;
                    credit.description = loanDescription;
                    credit.valueDate = debit.valueDate;
                    credit.transactionDate = debit.valueDate;
                    credit.currencyId = (short)loan.NOSTROCURRENCYID;
                    credit.currencyRate = financeTransaction.GetExchangeRate(credit.valueDate, credit.currencyId, model.companyId).sellingRate; //(double)loan.NOSTRORATEAMOUNT;
                    credit.isApproved = true;
                    credit.postedBy = model.createdBy;
                    credit.approvedBy = model.createdBy;
                    credit.approvedDate = debit.transactionDate;
                    credit.approvedDateTime = DateTime.Now;
                    credit.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
                    credit.companyId = model.companyId;

                    credit.glAccountId = nostroGL.GLACCOUNTID;
                    credit.sourceReferenceNumber = model.loanReferenceNumber;
                    credit.batchCode = batchCode;
                    credit.casaAccountId = null;
                    credit.debitAmount = 0;
                    credit.creditAmount = model.principalAmount;
                    credit.sourceBranchId = model.branchId;
                    credit.destinationBranchId = model.branchId;

                    credit.rateCode = rateCode;
                    credit.rateUnit = String.Format("{0:0.00}", loan.NOSTRORATEAMOUNT);
                    credit.currencyCrossCode = customNostro.CURRENCYCODE;
                    credits.Add(credit);
                }
            }
            else
            {
                //...FX REVOLVING FOREIGN LOANS CREDIT LEG...
                var nostroGL = context.TBL_CHART_OF_ACCOUNT.Where(x => x.ACCOUNTCODE == customNostro.ACCOUNTID).FirstOrDefault();
                foreach (var item in loanDisbursement)
                {
                    FinanceTransactionViewModel credit = new FinanceTransactionViewModel();
                    credit.operationId = (int)model.operationId;
                    credit.description = $"{item.NARRATION} ";
                    credit.valueDate = debit.valueDate;
                    credit.transactionDate = debit.valueDate;
                    credit.currencyId = (short)loan.NOSTROCURRENCYID; //.CURRENCYID;
                    credit.currencyRate = financeTransaction.GetExchangeRate(credit.valueDate, credit.currencyId, model.companyId).sellingRate;  //(double)loan.NOSTRORATEAMOUNT; // financeTransaction.GetExchangeRate(debit.valueDate, debit.currencyId, model.companyId).sellingRate;
                    credit.isApproved = true;
                    credit.postedBy = model.createdBy;
                    credit.approvedBy = model.createdBy;
                    credit.approvedDate = debit.transactionDate;
                    credit.approvedDateTime = DateTime.Now;
                    credit.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
                    credit.companyId = model.companyId;

                    // var repaymentAccountGL = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == casa.PRODUCTID).PRINCIPALBALANCEGL.Value;
                    credit.glAccountId = nostroGL.GLACCOUNTID;
                    credit.sourceReferenceNumber = model.loanReferenceNumber;
                    credit.batchCode = batchCode;
                    credit.casaAccountId = null; // casa.CASAACCOUNTID;
                    credit.debitAmount = 0;
                    credit.creditAmount = item.AMOUNTDISBURSED; // model.principalAmount;
                    credit.sourceBranchId = model.branchId;
                    credit.destinationBranchId = model.branchId;

                    credit.rateCode = rateCode;
                    credit.rateUnit = String.Format("{0:0.00}", loan.NOSTRORATEAMOUNT); //loan.NOSTRORATEAMOUNT;
                    credit.currencyCrossCode = customNostro.CURRENCYCODE;

                    credits.Add(credit);
                };
            }

            loanTransaction.AddRange(debits);
            loanTransaction.AddRange(credits);
            //loanTransaction.Add(credit);

            //financeTransaction.PostTransaction(loanTransaction);

            // Audit Section ---------------------------            


            return loanTransaction;

        }

        public List<FinanceTransactionViewModel> BuildLoanChargeFeesPosting(LoanViewModel loanDetails)
        {
            var batchCode = CommonHelpers.GenerateRandomDigitCode(10);
            var feeDescription = "FTK" + loanDetails.loanReferenceNumber + " fees";
            if (feeDescription.Length > 40)
            {
                feeDescription = feeDescription.Substring(0, 40);
            }

            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

            //TBL_LOAN loanTable = new TBL_LOAN();
            var bookingRequestDetails = context.TBL_LOAN_BOOKING_REQUEST.FirstOrDefault(x => x.LOAN_BOOKING_REQUESTID == loanDetails.loanBookingRequestId);
            var company = context.TBL_COMPANY.Find(loanDetails.companyId);
            foreach (var item in loanDetails.loanChargeFee)
            {
                //if (item.loanSystemTypeId == (short)LoanSystemTypeEnum.TermDisbursedFacility)
                //{
                //    loanTable = context.TBL_LOAN.Find(item.loanId);
                //}

                if (item.isPosted == false && item.feeAmount != 0)
                {
                    var casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == loanDetails.casaAccountId);

                    if (company.CURRENCYID != loanDetails.currencyId && loanDetails.casaAccountId2 != null)
                    {
                        //FOREIGN LOANS FEES ARE TAKEN FROM CASAACCOUNT SELECTED @BOOKING REQUEST
                        casa = this.context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == bookingRequestDetails.CASAACCOUNTID);
                    }

                    var postingGroups = (from details in this.context.TBL_CHARGE_FEE_DETAIL where details.CHARGEFEEID == item.chargeFeeId select details.POSTINGGROUP).Distinct().ToList();

                    foreach (var post in postingGroups)
                    {
                        var feeDetails = (from details in this.context.TBL_CHARGE_FEE_DETAIL where details.CHARGEFEEID == item.chargeFeeId && details.POSTINGGROUP == post orderby details.POSTINGTYPEID select details).ToList();

                        foreach (var debits in feeDetails.Where(a => a.POSTINGTYPEID == (int)GLPostingTypeEnum.Debit))
                        {
                            FinanceTransactionViewModel debit = new FinanceTransactionViewModel();
                            decimal debitAmount = 0;
                            if (debits.FEETYPEID == (int)FeeTypeEnum.Rate)
                                debitAmount = (decimal)item.feeAmount * (decimal)(debits.VALUE / 100.0);
                            else if (debits.FEETYPEID == (int)FeeTypeEnum.Amount)
                                debitAmount = (decimal)debits.VALUE;

                            debit.operationId = (int)loanDetails.operationId;
                            debit.description = feeDescription; // $"Fee charge on {debits.DESCRIPTION}";
                            debit.valueDate = generalSetup.GetApplicationDate();
                            debit.transactionDate = debit.valueDate;
                            debit.currencyId = casa.CURRENCYID;
                            debit.currencyRate = financeTransaction.GetExchangeRate(debit.valueDate, debit.currencyId, loanDetails.companyId).sellingRate;
                            debit.isApproved = true;
                            debit.postedBy = loanDetails.createdBy;
                            debit.approvedBy = loanDetails.createdBy;
                            debit.approvedDate = debit.transactionDate;
                            debit.approvedDateTime = DateTime.Now;
                            debit.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
                            debit.companyId = loanDetails.companyId;


                            debit.glAccountId = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == casa.PRODUCTID).PRINCIPALBALANCEGL.Value;
                            debit.sourceReferenceNumber = loanDetails.loanReferenceNumber;
                            debit.batchCode = batchCode;
                            debit.casaAccountId = casa.CASAACCOUNTID;
                            debit.debitAmount = debitAmount;
                            debit.creditAmount = 0;
                            debit.sourceBranchId = loanDetails.branchId;
                            debit.destinationBranchId = casa.BRANCHID;

                            debit.rateCode = "TTB"; //loanDetails.nostroRateCode;
                            debit.rateUnit = string.Empty;
                            debit.currencyCrossCode = casa.TBL_CURRENCY.CURRENCYCODE;
                            if (loanDetails.productClassId == (short)ProductClassEnum.BondAndGuarantees)
                            {
                                if (!loanDetails.isSuspenseCredit)
                                {
                                    var glStore = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanDetails.productId);
                                    var prodCasa = context.TBL_CASA.FirstOrDefault(x => x.PRODUCTID == loanDetails.productId);
                                    if (glStore != null)
                                    {
                                        debit.glAccountId = glStore.PRINCIPALBALANCEGL2.Value;
                                        debit.casaAccountId = null;
                                    }
                                    else throw new ConditionNotMetException("Suspense Account to be creditted not defined");
                                }
                            }

                            inputTransactions.Add(debit);
                        }

                        foreach (var credits in feeDetails.Where(a => a.POSTINGTYPEID == (int)GLPostingTypeEnum.Credit))
                        {
                            FinanceTransactionViewModel credit = new FinanceTransactionViewModel();
                            decimal creditAmount = 0;
                            if (credits.FEETYPEID == (int)FeeTypeEnum.Rate)
                                creditAmount = (decimal)item.feeAmount * (decimal)(credits.VALUE / 100.0);
                            else if (credits.FEETYPEID == (int)FeeTypeEnum.Amount)
                                creditAmount = (decimal)credits.VALUE;

                            credit.operationId = (int)loanDetails.operationId;
                            credit.description = feeDescription;
                            credit.valueDate = generalSetup.GetApplicationDate();
                            credit.transactionDate = credit.valueDate;
                            credit.currencyId = context.TBL_COMPANY.FirstOrDefault(x => x.COMPANYID == loanDetails.companyId).CURRENCYID; //(short)chartOfAccount.GetAccountDefaultCurrency((int)credits.GLACCOUNTID1, loanDetails.companyId); //casa.CURRENCYID;
                            credit.currencyRate = financeTransaction.GetExchangeRate(credit.valueDate, credit.currencyId, loanDetails.companyId).sellingRate;
                            credit.isApproved = true;
                            credit.postedBy = loanDetails.createdBy;
                            credit.approvedBy = loanDetails.createdBy;
                            credit.approvedDate = credit.transactionDate;
                            credit.approvedDateTime = DateTime.Now;
                            credit.sourceApplicationId = (short)SourceApplicationEnum.FinTrakBanking;
                            credit.companyId = loanDetails.companyId;
                            credit.glAccountId = (int)credits.GLACCOUNTID1;
                            credit.sourceReferenceNumber = loanDetails.loanReferenceNumber;
                            credit.batchCode = batchCode;
                            credit.casaAccountId = null;
                            credit.debitAmount = 0;
                            credit.creditAmount = creditAmount;
                            credit.sourceBranchId = loanDetails.branchId;
                            credit.destinationBranchId = loanDetails.branchId;
                            credit.rateCode = "TTB";
                            credit.rateUnit = string.Empty;
                            credit.currencyCrossCode = casa.TBL_CURRENCY.CURRENCYCODE;
                            if (loanDetails.productClassId == (short)ProductClassEnum.BondAndGuarantees)
                            {
                                if (loanDetails.isSuspenseCredit)
                                {
                                    var glStore = context.TBL_PRODUCT.FirstOrDefault(x => x.PRODUCTID == loanDetails.productId);
                                    var prodCasa = context.TBL_CASA.FirstOrDefault(x => x.PRODUCTID == loanDetails.productId);
                                    if (glStore != null)
                                    {
                                        credit.glAccountId = glStore.PRINCIPALBALANCEGL2.Value;
                                        //credit.casaAccountId = prodCasa.CASAACCOUNTID;
                                    }
                                    else throw new ConditionNotMetException("Suspense Account to be creditted not defined");
                                }
                            }

                            inputTransactions.Add(credit);
                        }
                    }
                }

            }
            return inputTransactions;
        }

        private bool AddLoanMonitoringTrigger(int loanApplicationDetailId, int createdBy, int loanId, short loanSystemTypeId)
        {
            var mornitoringTrigger = context.TBL_LOAN_APPLICATN_DETL_MTRIG.Where(x => x.LOANAPPLICATIONDETAILID == loanApplicationDetailId);
            foreach (var entity in mornitoringTrigger)
            {
                if (entity.MONITORING_TRIGGER != null && entity.MONITORING_TRIGGER != string.Empty)
                {
                    var data = new TBL_LOAN_MONITORING_TRIGGER
                    {
                        MONITORING_TRIGGER = entity.MONITORING_TRIGGER,
                        MONITORING_TRIGGERID = entity.MONITORING_TRIGGERID,
                        LOANID = loanId,
                        LOANSYSTEMTYPEID = loanSystemTypeId,
                        CREATEDBY = createdBy,
                        DATETIMECREATED = DateTime.Now,
                        DELETED = false

                    };
                    context.TBL_LOAN_MONITORING_TRIGGER.Add(data);
                }
            }
            //var result = context.SaveChanges() > 0;
            return true;
        }

        private bool AddLoanCovenant(LoanViewModel model, int loanId, short loanSystemTypeId)
        {
            var covenantModel = context.TBL_LOAN_APPLICATION_COVENANT.Where(x => x.LOANAPPLICATIONDETAILID == model.loanApplicationDetailId).ToList();
            foreach (var entity in covenantModel)
            {
                var covenant = new TBL_LOAN_COVENANT_DETAIL
                {
                    COMPANYID = model.companyId,
                    COVENANTAMOUNT = entity.COVENANTAMOUNT,
                    COVENANTDATE = entity.COVENANTDATE,
                    COVENANTDETAIL = entity.COVENANTDETAIL,
                    COVENANTTYPEID = entity.COVENANTTYPEID,
                    CREATEDBY = entity.CREATEDBY,
                    DATETIMECREATED = DateTime.Now,
                    FREQUENCYTYPEID = entity.FREQUENCYTYPEID,
                    LOANID = loanId,
                    CASAACCOUNTID = entity.CASAACCOUNTID,
                    LOANSYSTEMTYPEID = loanSystemTypeId,
                };

                context.TBL_LOAN_COVENANT_DETAIL.Add(covenant);
            }
            var result = context.SaveChanges() > 0;
            return result;

        }

        public bool AddLoanGuarantor(LoanGuarantorViewModel entity, short productTypeId, int loanApplicationId)
        {
            if (entity.customerType == "Corporate")
            {
                entity.customerTypeId = (short)CustomerTypeEnum.Corporate;
            }
            else entity.customerTypeId = (short)CustomerTypeEnum.Individual;

            var guarantor = new TBL_COLLATERAL_GAURANTEE
            {
                FIRSTNAME = entity.firstname != null ? entity.firstname : " ",
                LASTNAME = entity.lastname != null ? entity.lastname : " ",
                MIDDLENAME = entity.middlename != null ? entity.middlename : " ",
                PHONENUMBER1 = entity.phoneNumber1,
                PHONENUMBER2 = entity.phoneNumber2,
                RELATIONSHIP = entity.relationship,
                BVN = entity.bvn,
                EMAILADDRESS = entity.emailAddress,

            };
            //context.TBL_LOAN_GUARANTOR.Add(guarantor);
            //return context.SaveChanges() > 0;

            return true;
        }

        private ICollection<TBL_LOAN_COVENANT_DETAIL> AddLoanCovenant(LoanCovenantDetailViewModel entity, short loanSystemTypeId)
        {
            ICollection<TBL_LOAN_COVENANT_DETAIL> covenant;

            covenant = new List<TBL_LOAN_COVENANT_DETAIL>();

            covenant.Add(new TBL_LOAN_COVENANT_DETAIL
            {
                COMPANYID = entity.companyId,
                COVENANTAMOUNT = entity.covenantAmount,
                COVENANTDETAIL = entity.covenantDetail,
                COVENANTDATE = entity.covenantDate,
                LOANID = entity.loanId,
                LOANSYSTEMTYPEID = loanSystemTypeId,
                COVENANTTYPEID = entity.covenantTypeId,
                FREQUENCYTYPEID = entity.frequencyTypeId,
                CASAACCOUNTID = entity.casaAccountId,
                CREATEDBY = entity.createdBy,
                DATETIMECREATED = DateTime.Now // generalSetup.GetApplicationDate(),
            });

            return covenant;
        }

        public bool AddLoanCollateralMapping(int loanApplicationId, int loanId, short loanSystemTypeId)
        {
            var collateralModel = context.TBL_LOAN_APPLICATION_COLLATERL.Where(x => x.LOANAPPLICATIONID == loanApplicationId && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.DELETED == false).ToList();
            foreach (var entity in collateralModel)
            {
                var collateral = new TBL_LOAN_COLLATERAL_MAPPING
                {
                    COLLATERALCUSTOMERID = entity.COLLATERALCUSTOMERID,
                    LOANID = loanId,
                    LOANSYSTEMTYPEID = loanSystemTypeId,
                    ISRELEASED = false,
                    LOANAPPCOLLATERALID = entity.LOANAPPCOLLATERALID,
                };
                context.TBL_LOAN_COLLATERAL_MAPPING.Add(collateral);
            }
            return true;
        }

        private void AddLoanFees(List<LoanChargeFeeViewModel> feeModel, int loanId, short loanSystemTypeId, LoanViewModel loanModel, TBL_LOAN_APPLICATION_DETAIL facilityDetail)
        {
            if (facilityDetail.ISFEETAKEN == true) return;


            var request = context.TBL_LOAN_BOOKING_REQUEST.Where(x => x.LOAN_BOOKING_REQUESTID == loanModel.loanBookingRequestId).FirstOrDefault();
            var chargeByApprovedAmount = false;
            foreach (var ent in feeModel)
            {
                if (ent.isDeferred)
                {
                    AddDeferredFees(ent, loanSystemTypeId, loanModel, facilityDetail);
                    continue;
                }
                var chargeFee = context.TBL_CHARGE_FEE.Find(ent.chargeFeeId);
                if (chargeFee != null & chargeFee.FEETARGETID == (short)ChargeFeeTargetEnum.ApprovedLoanAmount)
                {
                    if (context.TBL_LOAN_FEE.Where(x => x.LOANID == facilityDetail.LOANAPPLICATIONDETAILID && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).Any())
                    {
                        chargeByApprovedAmount = true;
                        continue;
                    }
                    else if (request.TAKEFEEONCE == true || facilityDetail.TAKEFEETYPEID == (short)TakeFeeTypeEnum.ApprovedAmount)
                    {
                        chargeByApprovedAmount = true;
                        continue;
                    }
                    else { chargeByApprovedAmount = false; }
                }


                if (ent.dealTypeId != (short)ChargeFeeDealTypeEnum.Tax)
                {

                    var fee = new TBL_LOAN_FEE
                    {
                        CHARGEFEEID = ent.chargeFeeId,
                        FEEAMOUNT = chargeByApprovedAmount ? facilityDetail.APPROVEDAMOUNT : ent.feeAmount,
                        FEEDEPENDENTAMOUNT = chargeByApprovedAmount ? facilityDetail.APPROVEDAMOUNT : ent.feeDependentAmount,
                        FEERATEVALUE = ent.feeRateValue,
                        ISINTEGRALFEE = ent.isIntegralFee,
                        LOANID = chargeByApprovedAmount ? facilityDetail.LOANAPPLICATIONDETAILID : loanId,
                        SOURCELOANID = loanId,
                        LOANSYSTEMTYPEID = chargeByApprovedAmount ? (short)LoanSystemTypeEnum.LineFacility : loanSystemTypeId,
                        SOURCELOANSYSTEMTYPEID = loanSystemTypeId,
                        ISRECURRING = ent.recurring,
                        RECURRINGPAYMENTDAY = 28,
                        CREATEDBY = loanModel.createdBy,
                        DATETIMECREATED = DateTime.Now.Date,
                        ISPOSTED = ent.isPosted,
                        FEESOURCEMODULE = "LOS",
                    };
                    if (loanModel.feeOverride)
                    {
                        fee.ISPOSTED = false;
                    }
                    else fee.ISPOSTED = true;

                    context.TBL_LOAN_FEE.Add(fee);
                }
            }
            //return context.SaveChanges() > 0;
        }

        private void AddDeferredFees(LoanChargeFeeViewModel feeModel, short loanSystemTypeId, LoanViewModel loanModel, TBL_LOAN_APPLICATION_DETAIL facilityDetail)
        {
            var chargeByApprovedAmount = false;
            var chargeFee = context.TBL_CHARGE_FEE.Find(feeModel.chargeFeeId);
            if (chargeFee != null & chargeFee.FEETARGETID == (short)ChargeFeeTargetEnum.ApprovedLoanAmount)
            {
                if (context.TBL_DEFERRED_LOAN_FEE.Where(x => x.LOANAPPLICATIONDETAILID == facilityDetail.LOANAPPLICATIONDETAILID && x.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility).Any())
                {
                    chargeByApprovedAmount = false;
                }
                else { chargeByApprovedAmount = true; }
            }


            if (feeModel.dealTypeId != (short)ChargeFeeDealTypeEnum.Tax)
            {

                var fee = new TBL_DEFERRED_LOAN_FEE
                {
                    CHARGEFEEID = feeModel.chargeFeeId,
                    FEEAMOUNT = feeModel.feeAmount,
                    FEEDEPENDENTAMOUNT = feeModel.feeDependentAmount,
                    FEERATEVALUE = feeModel.feeRateValue,
                    ISINTEGRALFEE = feeModel.isIntegralFee,
                    LOANAPPLICATIONDETAILID = feeModel.applicationDetailIdId,
                    //LOANAPPLICATIONDETAILID = chargeByApprovedAmount ? facilityDetail.LOANAPPLICATIONDETAILID : loanId,
                    //SOURCELOANID = loanId,
                    LOANSYSTEMTYPEID = loanSystemTypeId,
                    //LOANSYSTEMTYPEID = chargeByApprovedAmount ? (short)LoanSystemTypeEnum.LineFacility : loanSystemTypeId,
                    //SOURCELOANSYSTEMTYPEID = loanSystemTypeId,
                    //ISRECURRING = ent.recurring,
                    //RECURRINGPAYMENTDAY = 28,
                    CREATEDBY = loanModel.createdBy,
                    DATETIMECREATED = DateTime.Now.Date,
                    ISPOSTED = feeModel.isPosted
                };
                if (loanModel.feeOverride)
                {
                    fee.ISPOSTED = false;
                }
                else fee.ISPOSTED = true;

                context.TBL_DEFERRED_LOAN_FEE.Add(fee);
                //return context.SaveChanges() > 0;
            }
        }

        public List<LoanMonitoringTriggerViewModel> GetLoanMonitoringTrigger()
        {
            var data = (from c in context.TBL_LOAN_MONITORING_TRIG_SETUP
                        select new LoanMonitoringTriggerViewModel
                        {
                            monitoringTriggerId = c.MONITORING_TRIGGERID,
                            monitoringTriggerSetupName = c.MONITORING_TRIGGER_NAME
                        }).ToList();
            return data;
        }

        public List<LookupViewModel> GetLoanRepricingModes()
        {
            var data = (from c in context.TBL_LOAN_REPRICING_MODE
                        select new LookupViewModel
                        {
                            lookupId = (short)c.REPRICINGMODEID,
                            lookupName = c.REPRICINGMODENAME
                        }).ToList();
            return data;
        }

        public List<LoanMonitoringTriggerViewModel> GetLoanMonitoringTriggerByLoanApplicationDetailId(int loanApplicationDetailId)
        {
            var loanMonitoringTrigger = (from tr in context.TBL_LOAN_APPLICATN_DETL_MTRIG.Where(x => x.LOANAPPLICATIONDETAILID == loanApplicationDetailId)
                                         select (
                                                  new LoanMonitoringTriggerViewModel
                                                  {
                                                      loanMonitoringTriggerId = tr.LOAN_MONITORING_TRIGGERID,
                                                      monitoringTrigger = tr.MONITORING_TRIGGER,
                                                      monitoringTriggerId = tr.MONITORING_TRIGGERID,
                                                  })).ToList();
            return loanMonitoringTrigger;
        }

        private IQueryable<LoanViewModel> GetAllLoans()
        {
            var data = (from l in context.TBL_LOAN
                        join cust in context.TBL_CUSTOMER on l.CUSTOMERID equals cust.CUSTOMERID
                        join loanDetail in context.TBL_LOAN_APPLICATION_DETAIL on l.LOANAPPLICATIONDETAILID equals loanDetail.LOANAPPLICATIONDETAILID
                        join loanApp in context.TBL_LOAN_APPLICATION on loanDetail.LOANAPPLICATIONID equals loanApp.LOANAPPLICATIONID
                        select new LoanViewModel
                        {
                            loanId = l.TERMLOANID,
                            customerId = l.CUSTOMERID,
                            customerName = cust.FIRSTNAME + " " + cust.LASTNAME,
                            productId = l.PRODUCTID,

                            companyId = l.COMPANYID,
                            casaAccountId = l.CASAACCOUNTID,
                            branchId = l.BRANCHID,
                            branchName = l.TBL_BRANCH.BRANCHNAME,
                            loanReferenceNumber = l.LOANREFERENCENUMBER,

                            principalFrequencyTypeId = (short)l.PRINCIPALFREQUENCYTYPEID,
                            principalFrequencyTypeName = l.TBL_FREQUENCY_TYPE.DESCRIPTION,
                            interestFrequencyTypeId = (short)l.INTERESTFREQUENCYTYPEID,
                            interestFrequencyTypeName = l.TBL_FREQUENCY_TYPE.DESCRIPTION,

                            principalNumberOfInstallment = l.PRINCIPALNUMBEROFINSTALLMENT,
                            interestNumberOfInstallment = l.INTERESTNUMBEROFINSTALLMENT,

                            relationshipOfficerId = l.RELATIONSHIPOFFICERID,
                            //  relationshipOfficerName = l.TBL_STAFF.FIRSTNAME + " " + l.TBL_STAFF.MIDDLENAME + " " + l.TBL_STAFF.LASTNAME,
                            relationshipManagerId = l.RELATIONSHIPMANAGERID,
                            // relationshipManagerName = l.TBL_STAFF1.FIRSTNAME + " " + l.TBL_STAFF1.MIDDLENAME + " " + l.TBL_STAFF1.LASTNAME,
                            misCode = l.MISCODE,
                            teamMiscode = l.TEAMMISCODE,
                            interestRate = l.INTERESTRATE,
                            effectiveDate = l.EFFECTIVEDATE,
                            maturityDate = l.MATURITYDATE,
                            bookingDate = l.BOOKINGDATE,
                            principalAmount = l.PRINCIPALAMOUNT,
                            principalInstallmentLeft = l.PRINCIPALINSTALLMENTLEFT,
                            interestInstallmentLeft = l.INTERESTINSTALLMENTLEFT,
                            approvalStatusId = l.APPROVALSTATUSID,
                            approvedBy = l.APPROVEDBY,
                            approverComment = l.APPROVERCOMMENT,
                            dateApproved = l.DATEAPPROVED,
                            loanStatusId = l.LOANSTATUSID,
                            scheduleTypeId = l.SCHEDULETYPEID,
                            isDisbursed = l.ISDISBURSED,
                            disbursedBy = l.DISBURSEDBY,
                            disburserComment = l.DISBURSERCOMMENT,
                            disburseDate = l.DISBURSEDATE,

                            approvedAmount = loanDetail.APPROVEDAMOUNT,

                            //creditAppraisalCompleted = l.CreditAppraisalCompleted,
                            operationId = l.OPERATIONID,
                            // operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == l.OPERATIONID).OPERATIONNAME,
                            casaAccountNumber = l.TBL_CASA.PRODUCTACCOUNTNUMBER,
                            // productAccountName = l.TBL_PRODUCT.PRODUCTNAME,
                            subSectorName = l.TBL_SUB_SECTOR.NAME,
                            sectorName = l.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            customerGroupId = loanApp.CUSTOMERGROUPID,
                            loanTypeId = loanApp.LOANAPPLICATIONTYPEID,
                            // loanTypeName = loanApp.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            equityContribution = l.EQUITYCONTRIBUTION,
                            firstPrincipalPaymentDate = l.FIRSTPRINCIPALPAYMENTDATE ?? DateTime.Now,
                            firstInterestPaymentDate = l.FIRSTINTERESTPAYMENTDATE ?? DateTime.Now,
                            outstandingPrincipal = l.OUTSTANDINGPRINCIPAL,
                            principalAdditionCount = l.PRINCIPALADDITIONCOUNT ?? 0,
                            principalReductionCount = l.PRINCIPALREDUCTIONCOUNT ?? 0,
                            fixedPrincipal = l.FIXEDPRINCIPAL,
                            profileLoan = l.PROFILELOAN,
                            dischargeLetter = l.DISCHARGELETTER,
                            suspendInterest = l.SUSPENDINTEREST,
                            //customerSensitivityLevelId = l.CUSTOMERSENSITIVITYLEVELID,
                            createdBy = l.CREATEDBY,
                            dateTimeCreated = l.DATETIMECREATED,
                            // isCamsol = context.TBL_LOAN_CAMSOL.Any(x => x.LOANID == l.TERMLOANID),
                            productName = l.TBL_PRODUCT.PRODUCTNAME
                        });
            return data;
        }

        //public bool ValidateCamsol(int loanId)
        //{
        //    var check = context.tbl_Loan_Camsol.Where(x => x.LoanId == loanId);

        //    if (check.Any())
        //    {
        //        return true;
        //    }

        //    return false;
        //}

        public int CalculateTenorValue(DateTime maturityDate, DateTime effectiveDate)
        {
            var result = (maturityDate - effectiveDate).Days;

            return result;
        }

        //public bool ValidateCamsol(int loanId)
        //{
        //    var check = context.tbl_Loan_Camsol.Where(x => x.LoanId == loanId);

        //    if (check.Any())
        //    {
        //        return true;
        //    }

        //    return false;
        //}

        public IEnumerable<LoanViewModel> GetLoanByCustomer(int customerId)
        {
            var data = GetAllLoans().Where(l => l.customerId == customerId && l.loanStatusId == (short)LoanStatusEnum.Active).GroupBy(x => x.loanId).Select(g => g.FirstOrDefault());
            return data;

        }

        public List<LoanViewModel> GetLoanApplicationExistingLoans(int applicationId)
        {
            var customerIds = context.TBL_LOAN_APPLICATION_DETAIL
                              .Where(x => x.LOANAPPLICATIONID == applicationId && x.DELETED == false)
                                .Select(x => x.CUSTOMERID)
                                .ToList();
            //List<CustomerExposure> customers = (from a in context.TBL_LOAN_APPLICATION_DETAIL
            //                                   where a.LOANAPPLICATIONID == applicationId && a.DELETED == false
            //                                   select new CustomerExposure()
            //                                   {
            //                                       customerId = a.CUSTOMERID,
            //                                   }
            //                                   ).ToList();

            var data = GetAllLoans().Where(l => customerIds.Contains(l.customerId) && l.loanStatusId == (short)LoanStatusEnum.Active).GroupBy(x => x.loanId).Select(g => g.FirstOrDefault());
            //var limit = GetCurrentCustomerExposure(customers, 1).Where(m=>m.facilityType == "TOTAL").FirstOrDefault();
            //foreach(var loan in data)
            //{
            //    loan.totalOutstandingAmount = limit.proposedLimit;
            //    loan.totalExistingLimitAmount = limit.existingLimit;
            //}
            return data.ToList();
        }

        public IEnumerable<LoanViewModel> GetLoanByCustomerGroup(int customerGroupId)
        {
            var data = GetAllLoans().Where(l => l.customerGroupId == customerGroupId).GroupBy(x => x.loanId)
                .Select(g => g.FirstOrDefault());
            return data;
        }

        public IQueryable<LoanRepaymentScheduleViewModel> RunningLoans(int customerId, int companyId)
        {
            var loans = GetLoansByCompanyId(companyId)
                .Where(c => c.approvalStatusId == (int)ApprovalStatusEnum.Approved && c.customerId == customerId)
                .Select(c => new LoanRepaymentScheduleViewModel
                {
                    loanReferenceNumber = c.loanReferenceNumber,
                    loanApplicationId = c.loanApplicationId,
                    principalRepayment = c.outstandingPrincipal,
                    interestAccrual = c.outstandingInterest,
                    customerId = c.customerId,
                    principalAmount = c.principalAmount,
                    effectiveDate = c.effectiveDate,
                    maturityDate = c.maturityDate,
                    interestRate = c.interestRate,
                    loanId = c.loanId,
                    productName = c.productName,
                    productTypeId = c.productTypeId,
                    terminationDate = c.maturityDate
                })
                .AsQueryable();

            return loans;
        }

        public IEnumerable<LoanViewModel> GetCommercialLoanByApplicationDetailId(int loanApplicationDetailId)
        {
            var data = GetLoanByApplicationDetailId(loanApplicationDetailId);
            return data.Where(x => x.operationId == (short)OperationsEnum.CommercialLoanBooking);
        }

        public IEnumerable<LoanViewModel> GetLoanHistoryByLoanAccountNumber(string loanReferenceNumber)
        {
            return (from data in context.TBL_LOAN
                    where (data.LOANREFERENCENUMBER == loanReferenceNumber) || (data.RELATED_LOAN_REFERENCE_NUMBER == loanReferenceNumber)
                    select new LoanViewModel()
                    {
                        loanId = data.TERMLOANID,
                        customerId = data.CUSTOMERID,
                        productId = data.PRODUCTID,
                        companyId = data.COMPANYID,
                        casaAccountId = data.CASAACCOUNTID,
                        branchId = data.BRANCHID,
                        loanReferenceNumber = data.LOANREFERENCENUMBER,
                        //tenor = (data.MaturityDate - data.EffectiveDate).Days,
                        principalFrequencyTypeId = (short)data.PRINCIPALFREQUENCYTYPEID,
                        interestFrequencyTypeId = (short)data.INTERESTFREQUENCYTYPEID,

                        principalNumberOfInstallment = data.PRINCIPALNUMBEROFINSTALLMENT,
                        interestNumberOfInstallment = data.INTERESTNUMBEROFINSTALLMENT,
                        relationshipOfficerId = data.RELATIONSHIPOFFICERID,
                        relationshipManagerId = data.RELATIONSHIPMANAGERID,
                        misCode = data.MISCODE,
                        teamMiscode = data.TEAMMISCODE,
                        interestRate = data.INTERESTRATE,
                        effectiveDate = data.EFFECTIVEDATE,
                        maturityDate = data.MATURITYDATE,
                        bookingDate = (DateTime)data.BOOKINGDATE,
                        principalAmount = data.PRINCIPALAMOUNT,
                        principalInstallmentLeft = data.PRINCIPALINSTALLMENTLEFT,
                        interestInstallmentLeft = data.INTERESTINSTALLMENTLEFT,
                        approvalStatusId = data.APPROVALSTATUSID,
                        approvedBy = data.APPROVEDBY,
                        approverComment = data.APPROVERCOMMENT,
                        dateApproved = data.DATEAPPROVED,
                        loanStatusId = data.LOANSTATUSID,
                        loanStatusName = data.TBL_LOAN_STATUS.ACCOUNTSTATUS,
                        scheduleTypeId = data.SCHEDULETYPEID,
                        isDisbursed = data.ISDISBURSED,
                        disbursedBy = data.DISBURSEDBY,
                        disburserComment = data.DISBURSERCOMMENT,
                        disburseDate = data.DISBURSEDATE,
                        currencyCode = data.TBL_CURRENCY.CURRENCYCODE,
                        approvedAmount = data.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,

                        operationId = data.OPERATIONID,
                        customerGroupId = data.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                        loanTypeId = data.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                        equityContribution = data.EQUITYCONTRIBUTION,
                        firstPrincipalPaymentDate = data.FIRSTPRINCIPALPAYMENTDATE,
                        firstInterestPaymentDate = data.FIRSTINTERESTPAYMENTDATE,
                        outstandingPrincipal = data.OUTSTANDINGPRINCIPAL,
                        outstandingInterest = data.OUTSTANDINGINTEREST,
                        principalAdditionCount = data.PRINCIPALADDITIONCOUNT,
                        principalReductionCount = data.PRINCIPALREDUCTIONCOUNT,
                        fixedPrincipal = data.FIXEDPRINCIPAL,
                        profileLoan = data.PROFILELOAN,
                        dischargeLetter = data.DISCHARGELETTER,
                        suspendInterest = data.SUSPENDINTEREST,
                        createdBy = data.CREATEDBY,
                        dateTimeCreated = data.DATETIMECREATED
                    }).ToList();
        }

        public IEnumerable<LoanBookingRequestViewModel> GetLoanRequestsByApplicationDetailId(int loanApplicationDetailId)
        {
            var detail = context.TBL_LOAN_APPLICATION_DETAIL.Find(loanApplicationDetailId);
            return (from data in context.TBL_LOAN_BOOKING_REQUEST
                    where data.LOANAPPLICATIONDETAILID == loanApplicationDetailId
                    select new LoanBookingRequestViewModel()
                    {
                        loanApplicationDetailId = data.LOANAPPLICATIONDETAILID,
                        loanBookingRequestId = data.LOAN_BOOKING_REQUESTID,
                        amount_Requested = data.AMOUNT_REQUESTED,
                        currencyCode = detail != null ? detail.TBL_CURRENCY.CURRENCYCODE : null,
                        approvalStatusId = data.APPROVALSTATUSID,
                        isUsed = data.ISUSED,
                        createdBy = data.CREATEDBY,
                        dateTimeCreated = data.DATETIMECREATED
                    }).ToList();
        }


        public IEnumerable<LoanViewModel> GetLoanByApplicationDetailId(int loanApplicationDetailId)
        {
            return (from data in context.TBL_LOAN
                    where data.LOANAPPLICATIONDETAILID == loanApplicationDetailId
                    select new LoanViewModel()
                    {
                        loanId = data.TERMLOANID,
                        customerId = data.CUSTOMERID,
                        productId = data.PRODUCTID,
                        companyId = data.COMPANYID,
                        casaAccountId = data.CASAACCOUNTID,
                        branchId = data.BRANCHID,
                        loanReferenceNumber = data.LOANREFERENCENUMBER,
                        //tenor = (data.MaturityDate - data.EffectiveDate).Days,
                        principalFrequencyTypeId = (short)data.PRINCIPALFREQUENCYTYPEID,
                        interestFrequencyTypeId = (short)data.INTERESTFREQUENCYTYPEID,

                        principalNumberOfInstallment = data.PRINCIPALNUMBEROFINSTALLMENT,
                        interestNumberOfInstallment = data.INTERESTNUMBEROFINSTALLMENT,
                        relationshipOfficerId = data.RELATIONSHIPOFFICERID,
                        relationshipManagerId = data.RELATIONSHIPMANAGERID,
                        misCode = data.MISCODE,
                        teamMiscode = data.TEAMMISCODE,
                        interestRate = data.INTERESTRATE,
                        effectiveDate = data.EFFECTIVEDATE,
                        maturityDate = data.MATURITYDATE,
                        bookingDate = (DateTime)data.BOOKINGDATE,
                        principalAmount = data.PRINCIPALAMOUNT,
                        principalInstallmentLeft = data.PRINCIPALINSTALLMENTLEFT,
                        interestInstallmentLeft = data.INTERESTINSTALLMENTLEFT,
                        approvalStatusId = data.APPROVALSTATUSID,
                        approvedBy = data.APPROVEDBY,
                        approverComment = data.APPROVERCOMMENT,
                        dateApproved = data.DATEAPPROVED,
                        loanStatusId = data.LOANSTATUSID,
                        loanStatusName = data.TBL_LOAN_STATUS.ACCOUNTSTATUS,
                        scheduleTypeId = data.SCHEDULETYPEID,
                        isDisbursed = data.ISDISBURSED,
                        disbursedBy = data.DISBURSEDBY,
                        disburserComment = data.DISBURSERCOMMENT,
                        disburseDate = data.DISBURSEDATE,
                        currencyCode = data.TBL_CURRENCY.CURRENCYCODE,
                        approvedAmount = data.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,

                        operationId = data.OPERATIONID,
                        customerGroupId = data.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                        loanTypeId = data.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                        equityContribution = data.EQUITYCONTRIBUTION,
                        firstPrincipalPaymentDate = data.FIRSTPRINCIPALPAYMENTDATE,
                        firstInterestPaymentDate = data.FIRSTINTERESTPAYMENTDATE,
                        outstandingPrincipal = data.OUTSTANDINGPRINCIPAL,
                        outstandingInterest = data.OUTSTANDINGINTEREST,
                        principalAdditionCount = data.PRINCIPALADDITIONCOUNT,
                        principalReductionCount = data.PRINCIPALREDUCTIONCOUNT,
                        fixedPrincipal = data.FIXEDPRINCIPAL,
                        profileLoan = data.PROFILELOAN,
                        dischargeLetter = data.DISCHARGELETTER,
                        suspendInterest = data.SUSPENDINTEREST,
                        createdBy = data.CREATEDBY,
                        dateTimeCreated = data.DATETIMECREATED
                    }).ToList();
        }

        public IEnumerable<CamProcessedLoanViewModel> GetCustomerApprovedLines(int customerId)
        {
            var customerFacilities = (from a in context.TBL_LOAN_APPLICATION
                                      join b in context.TBL_LOAN_APPLICATION_DETAIL
                                      on a.LOANAPPLICATIONID equals b.LOANAPPLICATIONID
                                      where a.CUSTOMERID == customerId &&
                                      ((a.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.AvailmentCompleted)
                                        || (a.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.BookingRequestInitiated)
                                        || (a.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.BookingRequestCompleted)
                                        || (a.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.LoanBookingInProgress)
                                        || (a.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.LoanBookingCompleted))
                                        && a.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.CancellationInProgress
                                        && a.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.CancellationCompleted
                                        && !(a.LOANAPPROVEDLIMITID > 0)
                                      select new CamProcessedLoanViewModel()
                                      {
                                          loanApplicationDetailId = b.LOANAPPLICATIONDETAILID,
                                          loanApplicationId = a.LOANAPPLICATIONID,
                                          productName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME + " " + b.TBL_PRODUCT.PRODUCTNAME + " " + a.APPLICATIONREFERENCENUMBER,
                                          loanTypeId = b.TBL_PRODUCT.PRODUCTTYPEID,
                                          requireCollateralTypeId = a.REQUIRECOLLATERALTYPEID,
                                          relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                          loanPurpose = a.LOANINFORMATION,
                                          productClassId = a.PRODUCTCLASSID,
                                          currencyCode = b.TBL_CURRENCY.CURRENCYCODE,
                                          approvedAmount = a.TBL_LOAN_APPLICATION_DETAIL.Sum(d => d.APPROVEDAMOUNT),
                                      }).OrderBy(d => d.productName);
            return customerFacilities;
        }

        public IEnumerable<CamProcessedLoanViewModel> GetCustomerLines(int customerId)
        {
            var data = GetCustomerApprovedLines(customerId).ToList();
            foreach (var item in data)
            {

                var requests = context.TBL_LOAN_BOOKING_REQUEST.Where(r => r.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var multipleDrawnFacilities = context.TBL_LOAN_APPLICATION.Where(l => l.LOANAPPROVEDLIMITID == item.loanApplicationId).ToList();
                var multipleDrawnFacilitiesAmount = multipleDrawnFacilities.Sum(f => f.TBL_LOAN_APPLICATION_DETAIL.Sum(d => d.PROPOSEDAMOUNT));
                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Count() > 0)
                    item.approveRequestAmount = (decimal)requests.Where(k => k.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Sum(s => s.AMOUNT_REQUESTED);

                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                    item.pendingRequestAmount = (decimal)requests.Where(j => j.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount;

                if (requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                    item.allRequestAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount;

                item.disapprovedCount = (int)requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Count();

                if (item.disapprovedCount > 0)
                    item.disApprovedAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Sum(s => s.AMOUNT_REQUESTED);

                item.customerAvailableAmount = item.approvedAmount - (item.allRequestAmount - item.requestedAmount) - multipleDrawnFacilitiesAmount;

                var disbursedLoan = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId && x.ISDISBURSED == true);
                if (disbursedLoan.Any())
                {
                    item.amountDisbursed = disbursedLoan.Sum(c => c.PRINCIPALAMOUNT);
                }
                item.productName = item.productName + " " + item.currencyCode + String.Format("{0:0,0.00}", item.customerAvailableAmount);
            }

            return data;


        }

        public LoanViewModel GetLoan(int loanId)
        {
            var dataRecord = (from data in context.TBL_LOAN
                              where data.TERMLOANID == loanId
                              select new LoanViewModel()
                              {
                                  loanId = data.TERMLOANID,
                                  customerId = data.CUSTOMERID,
                                  productId = data.PRODUCTID,
                                  companyId = data.COMPANYID,
                                  casaAccountId = data.CASAACCOUNTID,
                                  casaAccountId2 = data.CASAACCOUNTID2,
                                  branchId = data.BRANCHID,
                                  loanReferenceNumber = data.LOANREFERENCENUMBER,
                                  principalFrequencyTypeId = (short)data.PRINCIPALFREQUENCYTYPEID,
                                  interestFrequencyTypeId = (short)data.INTERESTFREQUENCYTYPEID,

                                  principalNumberOfInstallment = data.PRINCIPALNUMBEROFINSTALLMENT,
                                  interestNumberOfInstallment = data.INTERESTNUMBEROFINSTALLMENT,
                                  relationshipOfficerId = data.RELATIONSHIPOFFICERID,
                                  relationshipManagerId = data.RELATIONSHIPMANAGERID,
                                  misCode = data.MISCODE,
                                  teamMiscode = data.TEAMMISCODE,
                                  interestRate = data.INTERESTRATE,
                                  effectiveDate = data.EFFECTIVEDATE,
                                  maturityDate = data.MATURITYDATE,
                                  bookingDate = (DateTime)data.BOOKINGDATE,
                                  principalAmount = data.PRINCIPALAMOUNT,
                                  principalInstallmentLeft = data.PRINCIPALINSTALLMENTLEFT,
                                  interestInstallmentLeft = data.INTERESTINSTALLMENTLEFT,
                                  approvalStatusId = data.APPROVALSTATUSID,
                                  approvedBy = data.APPROVEDBY,
                                  approverComment = data.APPROVERCOMMENT,
                                  dateApproved = data.DATEAPPROVED,
                                  loanStatusId = data.LOANSTATUSID,
                                  scheduleTypeId = data.SCHEDULETYPEID,
                                  isDisbursed = data.ISDISBURSED,
                                  disbursedBy = data.DISBURSEDBY,
                                  disburserComment = data.DISBURSERCOMMENT,
                                  disburseDate = data.DISBURSEDATE,
                                  nostroAccountId = data.NOSTROACCOUNTID,
                                  nostroRateAmount = data.NOSTRORATEAMOUNT,
                                  nostroRateCodeId = data.NOSTRORATECODEID,
                                  //crmsRepaymentAgreementTypeId = data.CRMSREPAYMENTAGREEMENTID,

                                  approvedAmount = data.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,

                                  operationId = data.OPERATIONID,
                                  customerGroupId = data.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                  loanTypeId = data.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                  equityContribution = data.EQUITYCONTRIBUTION,
                                  firstPrincipalPaymentDate = data.FIRSTPRINCIPALPAYMENTDATE,
                                  firstInterestPaymentDate = data.FIRSTINTERESTPAYMENTDATE,
                                  outstandingPrincipal = data.OUTSTANDINGPRINCIPAL,
                                  principalAdditionCount = data.PRINCIPALADDITIONCOUNT,
                                  principalReductionCount = data.PRINCIPALREDUCTIONCOUNT,
                                  fixedPrincipal = data.FIXEDPRINCIPAL,
                                  profileLoan = data.PROFILELOAN,
                                  dischargeLetter = data.DISCHARGELETTER,
                                  suspendInterest = data.SUSPENDINTEREST,
                                  createdBy = data.CREATEDBY,
                                  dateTimeCreated = data.DATETIMECREATED
                              }).FirstOrDefault();

            //if (dataRecord.operationId == (short)OperationsEnum.ForeignExchangeLoanBooking)
            //{
            //    dataRecord.casaAccountId2 = context.TBL_CUSTOM_CHART_OF_ACCOUNT.Where(x => x.ACCOUNTID == dataRecord.nostroAccountId).FirstOrDefault()?.CUSTOMACCOUNTID;
            //}
            return dataRecord;
        }

        public IEnumerable<LoanViewModel> FindLoan(string referenceNumberOrName, int companyId)
        {
            return (from data in context.TBL_LOAN
                    where data.COMPANYID == companyId && (data.LOANREFERENCENUMBER == referenceNumberOrName ||
                      $"{data.TBL_CUSTOMER.FIRSTNAME} {data.TBL_CUSTOMER.MIDDLENAME} {data.TBL_CUSTOMER.LASTNAME} {data.TBL_CUSTOMER.CUSTOMERCODE} {data.TBL_CASA.PRODUCTACCOUNTNUMBER}".Contains(referenceNumberOrName)) //orderby account.AccountCode ascending, account.AccountName ascending
                    select new LoanViewModel()
                    {
                        loanId = data.TERMLOANID,
                        customerId = data.CUSTOMERID,
                        productId = data.PRODUCTID,
                        companyId = data.COMPANYID,
                        casaAccountId = data.CASAACCOUNTID,
                        branchId = data.BRANCHID,
                        loanReferenceNumber = data.LOANREFERENCENUMBER,
                        //tenor = (data.MaturityDate - data.EffectiveDate).Days,
                        //tenorModeId = data.TenorModeId,
                        principalFrequencyTypeId = (short)data.PRINCIPALFREQUENCYTYPEID,
                        interestFrequencyTypeId = (short)data.INTERESTFREQUENCYTYPEID,

                        principalNumberOfInstallment = data.PRINCIPALNUMBEROFINSTALLMENT,
                        interestNumberOfInstallment = data.INTERESTNUMBEROFINSTALLMENT,
                        relationshipOfficerId = data.RELATIONSHIPOFFICERID,
                        relationshipManagerId = data.RELATIONSHIPMANAGERID,
                        misCode = data.MISCODE,
                        teamMiscode = data.TEAMMISCODE,
                        interestRate = data.INTERESTRATE,
                        effectiveDate = data.EFFECTIVEDATE,
                        maturityDate = data.MATURITYDATE,
                        bookingDate = (DateTime)data.BOOKINGDATE,
                        principalAmount = data.PRINCIPALAMOUNT,
                        principalInstallmentLeft = data.PRINCIPALINSTALLMENTLEFT,
                        interestInstallmentLeft = data.INTERESTINSTALLMENTLEFT,
                        approvalStatusId = data.APPROVALSTATUSID,
                        approvedBy = data.APPROVEDBY,
                        approverComment = data.APPROVERCOMMENT,
                        dateApproved = data.DATEAPPROVED,
                        loanStatusId = data.LOANSTATUSID,
                        scheduleTypeId = data.SCHEDULETYPEID,
                        isDisbursed = data.ISDISBURSED,
                        disbursedBy = data.DISBURSEDBY,
                        disburserComment = data.DISBURSERCOMMENT,
                        disburseDate = data.DISBURSEDATE,

                        approvedAmount = data.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,

                        operationId = data.OPERATIONID,
                        customerGroupId = data.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                        loanTypeId = data.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                        equityContribution = data.EQUITYCONTRIBUTION,
                        firstPrincipalPaymentDate = data.FIRSTPRINCIPALPAYMENTDATE,
                        outstandingPrincipal = data.OUTSTANDINGPRINCIPAL,
                        principalAdditionCount = data.PRINCIPALADDITIONCOUNT,
                        principalReductionCount = data.PRINCIPALREDUCTIONCOUNT,
                        fixedPrincipal = data.FIXEDPRINCIPAL,
                        profileLoan = data.PROFILELOAN,
                        dischargeLetter = data.DISCHARGELETTER,
                        suspendInterest = data.SUSPENDINTEREST,
                        //customerSensitivityLevelId = data.CUSTOMERSENSITIVITYLEVELID,
                        createdBy = data.CREATEDBY,
                        dateTimeCreated = data.DATETIMECREATED

                    });
        }

        public IQueryable<LoanViewModel> GetLoansByCompanyId(int companyId) // EXTEND FOR ORDER LOAN TYPES
        {
            var systemDate = generalSetup.GetApplicationDate();
            return (context.TBL_LOAN
                .Where(x => x.COMPANYID == companyId)
                .Select(o => new LoanViewModel
                {
                    loanId = o.TERMLOANID,
                    loanApplicationId = o.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
                    customerId = o.CUSTOMERID,
                    productId = o.PRODUCTID,
                    casaAccountId = o.CASAACCOUNTID,
                    branchId = o.BRANCHID,
                    loanReferenceNumber = o.LOANREFERENCENUMBER,
                    principalFrequencyTypeId = (short)o.PRINCIPALFREQUENCYTYPEID,
                    interestFrequencyTypeId = (short)o.INTERESTFREQUENCYTYPEID,

                    principalNumberOfInstallment = o.PRINCIPALNUMBEROFINSTALLMENT,
                    interestNumberOfInstallment = o.INTERESTNUMBEROFINSTALLMENT,
                    relationshipOfficerId = o.RELATIONSHIPOFFICERID,
                    relationshipManagerId = o.RELATIONSHIPMANAGERID,
                    misCode = o.MISCODE,
                    teamMiscode = o.TEAMMISCODE,
                    interestRate = o.INTERESTRATE,
                    effectiveDate = o.EFFECTIVEDATE,
                    maturityDate = o.MATURITYDATE,
                    bookingDate = (DateTime)o.BOOKINGDATE,
                    principalAmount = o.PRINCIPALAMOUNT,
                    principalInstallmentLeft = o.PRINCIPALINSTALLMENTLEFT,
                    interestInstallmentLeft = o.INTERESTINSTALLMENTLEFT,
                    approvalStatusId = o.APPROVALSTATUSID,
                    firstName = o.TBL_CUSTOMER.FIRSTNAME,
                    middleName = o.TBL_CUSTOMER.MIDDLENAME,
                    lastName = o.TBL_CUSTOMER.LASTNAME,
                    customerCode = o.TBL_CUSTOMER.CUSTOMERCODE,
                    //productAccountNumber = o.TBL_CASA.PRODUCTACCOUNTNUMBER,
                    //productAccountName = o.TBL_CASA.PRODUCTACCOUNTNAME,
                    outstandingPrincipal = o.OUTSTANDINGPRINCIPAL,
                    outstandingInterest = o.OUTSTANDINGINTEREST,
                    productName = o.TBL_PRODUCT.PRODUCTNAME,
                    productTypeId = o.TBL_PRODUCT.PRODUCTTYPEID,
                }));
        }


        public IEnumerable<LoanViewModel> LoanSearch(int companyId, LoanSearchViewModel searchModel)
        {
            var loans = GetLoansByCompanyId(companyId);

            if (!String.IsNullOrEmpty(searchModel.loanReferenceNumber))
            {
                loans = loans.Where(x => x.loanReferenceNumber == searchModel.loanReferenceNumber);
            }

            if (!String.IsNullOrEmpty(searchModel.productAccountNumber))
            {
                loans = loans.Where(x => x.casaAccountNumber == searchModel.productAccountNumber);
            }

            if (!String.IsNullOrEmpty(searchModel.customerName))
            {
                loans = loans.Where(x =>
                x.firstName.ToLower().Contains(searchModel.customerName.ToLower())
                || x.lastName.ToLower().Contains(searchModel.customerName.ToLower())
                || x.middleName.ToLower().Contains(searchModel.customerName.ToLower())
                || x.customerCode.ToLower().Contains(searchModel.customerName.ToLower())
                );
            }

            if (!String.IsNullOrEmpty(searchModel.loanName))
            {
                loans = loans.Where(x => x.productAccountName.ToLower().Contains(searchModel.loanName.ToLower()));
            }

            loans.OrderBy(x => x.casaAccountNumber).ThenBy(x => x.productAccountName);

            return loans;
        }

        private int GetDaysInAYear(DayCountConventionEnum dayCountId)
        {
            if (dayCountId == DayCountConventionEnum.Actual_Actual)
            {
                var currentDate = DateTime.Now;
                var firstDate = new DateTime(currentDate.Year, 1, 1); //  DateTime.ParseExact(user, "MM-dd-yyyy", System.Globalization.CultureInfo.InvariantCulture);
                var lastdate = new DateTime(currentDate.Year, 12, 31);
                var difference = (lastdate - firstDate).TotalDays + 1;

                return Convert.ToInt32(difference);
            }

            var value = context.TBL_DAY_COUNT_CONVENTION.FirstOrDefault(x => x.DAYCOUNTCONVENTIONID == (short)dayCountId).DAYSINAYEAR;

            return value;
        }

        public List<CollateralLoanApplication> GetLoanCollateral(int loanId, int loanType)
        {
            var data = (from a in context.TBL_LOAN_COLLATERAL_MAPPING
                        join b in context.TBL_COLLATERAL_CUSTOMER on a.COLLATERALCUSTOMERID equals b.COLLATERALCUSTOMERID
                        where a.LOANID == loanId && a.DELETED == false && a.LOANSYSTEMTYPEID == loanType
                        select new CollateralLoanApplication
                        {
                            haircut = b.HAIRCUT,
                            collateralCode = b.COLLATERALCODE,
                            collateralValue = (double)b.COLLATERALVALUE,
                            collateralId = b.COLLATERALCUSTOMERID,
                            collateralTypeId = (int)b.COLLATERALTYPEID,
                            collateralType = context.TBL_COLLATERAL_TYPE.Where(x => x.COLLATERALTYPEID == b.COLLATERALTYPEID).Select(m => m.COLLATERALTYPENAME).FirstOrDefault(),
                            valuationCycle = b.VALUATIONCYCLE,
                            collateralTypeName = b.TBL_COLLATERAL_TYPE.COLLATERALTYPENAME,
                            collateralCustomerId = a.COLLATERALCUSTOMERID,
                            currencyCode = b.TBL_CURRENCY.CURRENCYCODE,
                            currencyId = b.TBL_CURRENCY.CURRENCYID,
                            currency = b.TBL_CURRENCY.CURRENCYNAME
                        }).ToList();

            return data;
        }

        public List<LoanDisbursementViewModel> GetForeignLoanBeneficiaryNaration(int loanId)
        {
            return (from i in context.TBL_LOAN_DISBURSEMENT.Where(x => x.TERMLOANID == loanId)
                    select (
                             new LoanDisbursementViewModel
                             {
                                 amountDisbursed = i.AMOUNTDISBURSED,
                                 beneficiaryReason = i.NARRATION,
                                 loanDisbursementId = i.LOANDISBURSEMENTID
                             })).ToList();
        }

        public List<LoanMonitoringTriggerViewModel> GetLoanMonitoringTriggers(int loanId, int loanSystemTypeId)
        {
            return (from i in context.TBL_LOAN_MONITORING_TRIGGER.Where(x => x.LOANID == loanId && x.LOANSYSTEMTYPEID == loanSystemTypeId)
                    select (
                             new LoanMonitoringTriggerViewModel
                             {
                                 loanMonitoringTriggerId = i.LOAN_MONITORING_TRIGGERID,
                                 loanSystemTypeId = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                                 monitoringTriggerId = i.MONITORING_TRIGGERID,
                                 monitoringTrigger = i.MONITORING_TRIGGER,
                                 monitoringTriggerSetupName = i.TBL_LOAN_MONITORING_TRIG_SETUP.MONITORING_TRIGGER_NAME,
                             })).ToList();
        }


        public List<LoanCovenantDetailViewModel> GetLoanCovenant(int loanId, int loanType)
        {
            var data = (from a in context.TBL_LOAN_COVENANT_DETAIL
                        where a.LOANID == loanId && a.DELETED == false && a.LOANSYSTEMTYPEID == loanType
                        select new LoanCovenantDetailViewModel
                        {
                            loanCovenantDetailId = a.LOANCOVENANTDETAILID,
                            covenantDetail = a.COVENANTDETAIL,
                            loanId = a.LOANID,
                            covenantTypeId = (short)a.COVENANTTYPEID,
                            frequencyTypeId = (short)a.FREQUENCYTYPEID,
                            covenantAmount = a.COVENANTAMOUNT,
                            covenantDate = a.COVENANTDATE,
                            casaAccountId = a.CASAACCOUNTID
                        }).ToList();
            return data;
        }
        public List<LoanCovenantDetailViewModel> GetLoanCovenant(int loanId)
        {
            var data = (from a in context.TBL_LOAN_COVENANT_DETAIL
                        where a.LOANID == loanId && a.DELETED == false
                        select new LoanCovenantDetailViewModel
                        {
                            loanCovenantDetailId = a.LOANCOVENANTDETAILID,
                            covenantDetail = a.COVENANTDETAIL,
                            loanId = a.LOANID,
                            covenantTypeId = (short)a.COVENANTTYPEID,
                            frequencyTypeId = (short)a.FREQUENCYTYPEID,
                            covenantAmount = a.COVENANTAMOUNT,
                            covenantDate = a.COVENANTDATE,
                            casaAccountId = a.CASAACCOUNTID
                        }).ToList();
            return data;
        }

        public IEnumerable<LoanChargeFeeViewModel> GetProductFees(int productId)
        {
            var data = (from c in context.TBL_CHARGE_FEE
                        join p in context.TBL_PRODUCT_CHARGE_FEE on c.CHARGEFEEID equals p.CHARGEFEEID
                        where p.PRODUCTID == productId && c.DELETED == false
                        select new LoanChargeFeeViewModel
                        {
                            chargeFeeId = c.CHARGEFEEID,
                            chargeFeeName = c.CHARGEFEENAME,
                            feeTypeId = c.FEETYPEID,
                            feeTypeName = c.TBL_FEE_TYPE.FEETYPENAME,
                            feeIntervalId = c.FEEINTERVALID,
                            productFeeId = p.PRODUCTFEEID,
                            feeRateValue = p.RATEVALUE,
                            feeDependentAmount = p.DEPENDENTAMOUNT ?? 0,
                            chargeAmount = c.AMOUNT ?? 0,
                            feeIntervalName = c.TBL_FEE_INTERVAL.FEEINTERVALNAME,
                            required = c.TBL_FEE_TYPE.BYAMOUNTREQUIRED,
                            recurring = (bool)c.RECURRING,
                            feeTargetId = c.FEETARGETID,
                            feeTargetName = c.TBL_FEE_TARGET.FEETARGETNAME,
                            isIntegralFee = c.ISINTEGRALFEE,
                            chargeRange = (from r in context.TBL_CHARGE_RANGE
                                           where r.CHARGEFEEID == c.CHARGEFEEID
                                           select new ChargeRangeViewModel
                                           {
                                               maximum = r.MAXIMUM,
                                               minimum = r.MINIMUM,
                                               rate = r.RATE,
                                               amount = r.AMOUNT,
                                               maximumAndBelow = r.MAXIMUMANDBELOW,
                                               minimumAndAbove = r.MINIMUMANDABOVE,
                                           }).ToList(),

                        }).ToList();
            return data;
        }

        public List<LoanChargeFeeViewModel> GetLoanChargeFee(int loanId, int loanType)
        {
            var data = (from c in context.TBL_LOAN_FEE
                        where c.LOANID == loanId && c.LOANSYSTEMTYPEID == loanType //&& c.Deleted == false
                        select new LoanChargeFeeViewModel
                        {
                            loanChargeFeeId = c.LOANCHARGEFEEID,
                            loanId = c.LOANID,
                            chargeFeeId = c.CHARGEFEEID,
                            chargeFeeName = c.TBL_CHARGE_FEE.CHARGEFEENAME,
                            feeRateValue = c.FEERATEVALUE,
                            feeDependentAmount = c.FEEDEPENDENTAMOUNT,
                            feeAmount = c.FEEAMOUNT,
                            feeIntervalId = c.TBL_CHARGE_FEE.FEEINTERVALID,
                            feeIntervalName = c.TBL_CHARGE_FEE.TBL_FEE_INTERVAL.FEEINTERVALNAME,
                            feeSourceModule = c.FEESOURCEMODULE == null ? "LOS": c.FEESOURCEMODULE,
                        }).ToList();
            return data;
        }
        public List<LoanChargeFeeViewModel> GetLoanChargeFee(int loanId)
        {
            var data = (from c in context.TBL_LOAN_FEE
                        where c.LOANID == loanId //&& c.Deleted == false
                        select new LoanChargeFeeViewModel
                        {
                            loanChargeFeeId = c.LOANCHARGEFEEID,
                            loanId = c.LOANID,
                            chargeFeeId = c.CHARGEFEEID,
                            chargeFeeName = c.TBL_CHARGE_FEE.CHARGEFEENAME,
                            feeRateValue = c.FEERATEVALUE,
                            feeDependentAmount = c.FEEDEPENDENTAMOUNT,
                            feeAmount = c.FEEAMOUNT,
                            feeIntervalId = c.TBL_CHARGE_FEE.FEEINTERVALID,
                            feeIntervalName = c.TBL_CHARGE_FEE.TBL_FEE_INTERVAL.FEEINTERVALNAME,
                            feeSourceModule = c.FEESOURCEMODULE == null ? "LOS" : c.FEESOURCEMODULE,
                        }).ToList();
            return data;
        }

        public IEnumerable<ProductFeeViewModel> GetLoanProductChargeFeesByProductId(int productId)
        {
            var data = (from c in context.TBL_CHARGE_FEE
                        join p in context.TBL_PRODUCT_CHARGE_FEE
                        on c.CHARGEFEEID equals p.CHARGEFEEID
                        where p.PRODUCTID == productId && p.DELETED == false
                        select new ProductFeeViewModel
                        {
                            productFeeId = p.PRODUCTFEEID,
                            productId = p.PRODUCTID,
                            productName = p.TBL_PRODUCT.PRODUCTNAME,
                            feeId = c.CHARGEFEEID,
                            feeName = c.CHARGEFEENAME,
                            feeTargetName = c.TBL_FEE_TARGET.FEETARGETNAME,
                            feeIntervalName = c.TBL_FEE_INTERVAL.FEEINTERVALNAME,
                            rateValue = (decimal)p.RATEVALUE,
                            dependentAmount = p.DEPENDENTAMOUNT

                        }).ToList();
            return data;
        }

        public IEnumerable<ProductFeeViewModel> GetLoanProductChargeFeesByChargeFeeId(int chargeFeeId)
        {
            var data = (from c in context.TBL_CHARGE_FEE
                        join p in context.TBL_PRODUCT_CHARGE_FEE
                        on c.CHARGEFEEID equals p.CHARGEFEEID
                        where p.CHARGEFEEID == chargeFeeId && p.DELETED == false
                        select new ProductFeeViewModel
                        {
                            productFeeId = p.PRODUCTFEEID,
                            productId = p.PRODUCTID,
                            productName = p.TBL_PRODUCT.PRODUCTNAME,
                            feeId = c.CHARGEFEEID,
                            feeName = c.CHARGEFEENAME,
                            feeTargetName = c.TBL_FEE_TARGET.FEETARGETNAME,
                            feeIntervalName = c.TBL_FEE_INTERVAL.FEEINTERVALNAME,
                            rateValue = (decimal)p.RATEVALUE,
                            dependentAmount = p.DEPENDENTAMOUNT

                        }).ToList();
            return data;
        }

        public IEnumerable<LoanChargeFeeViewModel> GetLoanProductChargeFee(int chargeFeeId, int productId)
        {
            var data = (from c in context.TBL_CHARGE_FEE
                        join p in context.TBL_PRODUCT_CHARGE_FEE on c.CHARGEFEEID equals p.CHARGEFEEID
                        where p.PRODUCTID == productId && c.DELETED == false
                        select new LoanChargeFeeViewModel
                        {
                            productFeeId = p.PRODUCTFEEID,
                            chargeFeeId = c.CHARGEFEEID,
                            chargeFeeName = c.CHARGEFEENAME,
                            feeRateValue = p.RATEVALUE,
                            feeDependentAmount = p.DEPENDENTAMOUNT ?? 0,
                            feeAmount = c.AMOUNT ?? 0,
                            feeIntervalId = c.FEEINTERVALID,
                            feeIntervalName = c.TBL_FEE_INTERVAL.FEEINTERVALNAME,
                            feeTypeId = c.FEETYPEID,
                            required = c.TBL_FEE_TYPE.BYAMOUNTREQUIRED,
                            recurring = (bool)c.RECURRING,

                        }).ToList();
            return data;
        }

        public IQueryable<CustomerSearchItemViewModels> SearchCustomerCollateral(int companyId, string searchQuery)
        {
            return this.customers.CustomerSearchRealTime(companyId, searchQuery);
        }

        public IQueryable<CustomerViewModels> SearchForCustomerCollateral(int companyId, string searchQuery)
        {
            IQueryable<CustomerViewModels> allCustomers = null;

            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToLower();
            }

            if (!string.IsNullOrWhiteSpace(searchQuery.Trim()))
            {
                allCustomers = GetCustomers()
                    .Where(c => c.companyId == companyId)
                    .Where(x => x.firstName.Contains(searchQuery)
               || x.lastName.Contains(searchQuery)
               || x.middleName.Contains(searchQuery)
                );
            }

            return allCustomers;
        }

        IQueryable<CustomerViewModels> GetCustomers()
        {
            return from a in context.TBL_CUSTOMER
                   where a.DELETED == false
                   select

                   new CustomerViewModels
                   {
                       accountCreationComplete = a.ACCOUNTCREATIONCOMPLETE,
                       branchId = a.BRANCHID,
                       branchName = a.TBL_BRANCH.BRANCHNAME,
                       //childDateOfBirth = a.CHILDDATEOFBIRTH.Value,
                       companyMainId = a.COMPANYID,
                       createdBy = a.CREATEDBY,
                       creationMailSent = a.CREATIONMAILSENT,
                       customerCode = a.CUSTOMERCODE,
                       customerSensitivityLevelId = a.CUSTOMERSENSITIVITYLEVELID,
                       customerTypeId = a.CUSTOMERTYPEID.Value,
                       dateOfBirth = (DateTime)a.DATEOFBIRTH,
                       customerId = a.CUSTOMERID,
                       emailAddress = a.EMAILADDRESS,
                       //firstChildName = a.FIRSTCHILDNAME,
                       firstName = a.FIRSTNAME,
                       gender = a.GENDER,
                       lastName = a.LASTNAME,
                       maidenName = a.MAIDENNAME,
                       maritalStatus = a.MARITALSTATUS.Value == 1 ? "M" : "F",
                       title = a.TITLE,
                       middleName = a.MIDDLENAME,
                       customerTypeName = context.TBL_CUSTOMER_TYPE.FirstOrDefault(c => c.CUSTOMERTYPEID == a.CUSTOMERTYPEID).NAME,
                       misCode = a.MISCODE,
                       misStaff = a.MISSTAFF,
                       nationalityId = a.NATIONALITYID,
                       occupation = a.OCCUPATION,
                       placeOfBirth = a.PLACEOFBIRTH,
                       isInvestmentGrade = a.ISINVESTMENTGRADE,
                       isRealatedParty = a.ISREALATEDPARTY,
                       isPoliticallyExposed = a.ISPOLITICALLYEXPOSED,
                       relationshipOfficerId = a.RELATIONSHIPOFFICERID.Value,
                       spouse = a.SPOUSE,
                       sectorId = a.TBL_SUB_SECTOR.TBL_SECTOR.SECTORID,
                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                       subSectorId = (short)a.SUBSECTORID,
                       subSectorName = a.TBL_SUB_SECTOR.NAME,
                       taxNumber = a.TAXNUMBER
                       ,
                       CustomerAddresses = context.TBL_CUSTOMER_ADDRESS.Where(x => x.CUSTOMERID == a.CUSTOMERID).Select(x => new CustomerAddressViewModels()
                       {
                           address = x.ADDRESS,
                           addressTypeId = x.ADDRESSTYPEID,
                           cityId = x.CITYID,
                           customerId = x.CUSTOMERID,
                           homeTown = x.HOMETOWN,
                           nearestLandmark = x.NEARESTLANDMARK,
                           electricMeterNumber = x.ELECTRICMETERNUMBER,
                           pobox = x.POBOX,
                           stateId = x.STATEID,
                           addressId = x.ADDRESSID
                       }).ToList(),
                       CustomerPhoneContact = context.TBL_CUSTOMER_PHONECONTACT.Where(c => c.CUSTOMERID == a.CUSTOMERID).Select(c => new CustomerPhoneContactViewModels
                       {
                           active = c.ACTIVE,
                           customerId = c.CUSTOMERID,
                           phone = c.PHONE,
                           phoneContactId = c.PHONECONTACTID,
                           phoneNumber = c.PHONENUMBER
                       }).ToList(),
                       CustomerCompanyInfomation = context.TBL_CUSTOMER_COMPANYINFOMATION.Where(d => d.CUSTOMERID == a.CUSTOMERID).Select(d => new CustomerCompanyInfomationViewModels()
                       {
                           annualTurnOver = d.ANNUALTURNOVER,
                           companyEmail = d.COMPANYEMAIL,
                           companyId = d.CUSTOMERID,
                           companyName = d.COMPANYNAME,
                           companyWebsite = d.COMPANYWEBSITE,
                           companyInfomationId = d.COMPANYINFOMATIONID,
                           corporateBusinessCategory = d.CORPORATEBUSINESSCATEGORY,
                           createdBy = a.CREATEDBY,
                           //creditRating = d.CREDITRATING,
                           registeredOffice = d.REGISTEREDOFFICE,
                           // previousCreditRating = d.PREVIOUSCREDITRATING,
                           registrationNumber = d.REGISTRATIONNUMBER,
                           paidUpCapital = d.PAIDUPCAPITAL,
                           authorizedCapital = d.AUTHORISEDCAPITAL

                       }).ToList(),
                       CustomerIdentification = context.TBL_CUSTOMER_IDENTIFICATION.Where(e => e.CUSTOMERID == a.CUSTOMERID).Select(e => new CustomerIdentificationViewModels()
                       {
                           identificationId = e.IDENTIFICATIONID,
                           identificationModeId = e.IDENTIFICATIONMODEID.Value,
                           identificationMode = context.TBL_CUSTOMER_IDENTI_MODE_TYPE.FirstOrDefault(r => r.IDENTIFICATIONMODEID == e.IDENTIFICATIONMODEID).IDENTIFICATIONMODE,
                           identificationNo = e.IDENTIFICATIONNO,
                           issueAuthority = e.ISSUEAUTHORITY,
                           issuePlace = e.ISSUEPLACE
                       }).ToList(),
                       CustomerEmploymentHistory = context.TBL_CUSTOMER_EMPLOYMENTHISTORY.Where(s => s.CUSTOMERID == a.CUSTOMERID).Select(s => new CustomerEmploymentHistoryViewModels()
                       {
                           active = s.ACTIVE,
                           previousEmployer = s.PREVIOUSEMPLOYER,
                           customerId = s.CUSTOMERID,
                           employDate = s.EMPLOYDATE,
                           placeOfWorkId = s.PLACEOFWORKID,
                           employerAddress = s.EMPLOYERADDRESS,
                           employerCountryId = s.EMPLOYERCOUNTRYID,
                           employerName = s.EMPLOYERNAME,
                           officePhone = s.OFFICEPHONE,
                           employerStateId = s.EMPLOYERSTATEID
                       }).ToList(),
                       CustomerCompanyDirectors = context.TBL_CUSTOMER_COMPANY_DIRECTOR.Where(s => s.CUSTOMERID == a.CUSTOMERID && s.COMPANYDIRECTORTYPEID == (short)CompanyDirectorTypeEnum.BoardMember)
                       .Select(s => new CustomerCompanyDirectorsViewModels()
                       {
                           companyDirectorId = s.COMPANYDIRECTORID,
                           surname = s.SURNAME,
                           firstname = s.FIRSTNAME,
                           numberOfShares = s.SHAREHOLDINGPERCENTAGE,
                           isPoliticallyExposed = s.ISPOLITICALLYEXPOSED,
                           bankVerificationNumber = s.CUSTOMERBVN,
                           companyDirectorTypeId = s.COMPANYDIRECTORTYPEID,
                           companyDirectorTypeName = s.TBL_CUSTOMER_COMPANY_DIREC_TYP.COMPANYDIRECTORYTYPENAME,
                           customerId = s.CUSTOMERID,
                           customerName = s.FIRSTNAME + " " + s.SURNAME,
                           address = s.ADDRESS,
                           phoneNumber = s.PHONENUMBER,
                           email = s.EMAILADDRESS
                       }).ToList(),
                       CustomerCompanyShareholder = context.TBL_CUSTOMER_COMPANY_DIRECTOR.Where(s => s.CUSTOMERID == a.CUSTOMERID && s.COMPANYDIRECTORTYPEID == (short)CompanyDirectorTypeEnum.Shareholder)
                       .Select(s => new CustomerCompanyShareholderViewModels()
                       {
                           companyDirectorId = s.COMPANYDIRECTORID,
                           surname = s.SURNAME,
                           firstname = s.FIRSTNAME,
                           numberOfShares = s.SHAREHOLDINGPERCENTAGE,
                           isPoliticallyExposed = s.ISPOLITICALLYEXPOSED,
                           bankVerificationNumber = s.CUSTOMERBVN,
                           companyDirectorTypeId = s.COMPANYDIRECTORTYPEID,
                           companyDirectorTypeName = s.TBL_CUSTOMER_COMPANY_DIREC_TYP.COMPANYDIRECTORYTYPENAME,
                           customerId = s.CUSTOMERID,
                           customerName = s.FIRSTNAME + " " + s.SURNAME,
                           address = s.ADDRESS,
                           phoneNumber = s.PHONENUMBER,
                           email = s.EMAILADDRESS
                       }).ToList(),
                       CustomerCollateral = context.TBL_COLLATERAL_CUSTOMER.Where(cc => cc.CUSTOMERID == a.CUSTOMERID)
                       .Select(x => new CollateralViewModel()
                       {
                           collateralId = x.COLLATERALCUSTOMERID,
                           collateralTypeId = x.COLLATERALTYPEID,
                           collateralSubTypeId = x.COLLATERALSUBTYPEID,
                           customerId = x.CUSTOMERID.Value,
                           currencyId = x.CURRENCYID,
                           currency = x.TBL_CURRENCY.CURRENCYNAME,
                           collateralTypeName = x.TBL_COLLATERAL_TYPE.COLLATERALTYPENAME,
                           collateralCode = x.COLLATERALCODE,
                           camRefNumber = x.CAMREFNUMBER,
                           allowSharing = x.ALLOWSHARING,
                           isLocationBased = (bool)x.ISLOCATIONBASED,
                           valuationCycle = x.VALUATIONCYCLE,
                           haircut = x.HAIRCUT,
                           approvalStatusName = x.APPROVALSTATUS,
                       }).ToList(),
                   };

        }


        public AppraisalMemorandumLoanDetailViewModel GetAppraisalMemorandumLoanUpdates(int appraisalMemorandumId)
        {
            return (from data in context.TBL_CREDIT_APPRAISAL_MEMO_DETL
                    where data.APPRAISALMEMORANDUMID == appraisalMemorandumId
                    orderby data.MEMORANDUMLOANDETAILID descending
                    select new AppraisalMemorandumLoanDetailViewModel()
                    {
                        interestRate = data.INTERESTRATE,
                        principalAmount = data.PRINCIPALAMOUNT,
                        tenor = data.TENOR,
                    }).FirstOrDefault();
        }

        public bool CancelFullAndFinal(int loanId, int statusId)
        {
            bool result = false;
            try
            {
                if (statusId == (int)FullAndFinalStatusEnum.Cancelled)
                {
                    var loan = context.TBL_LOAN.Where(o => o.TERMLOANID == loanId).Select(o => o).FirstOrDefault();
                    if (loan != null)
                    {
                        loan.FULLANDFINALSTATUSID = (int)FullAndFinalStatusEnum.Cancelled;
                        if (context.SaveChanges() > 0)
                            result = true; ;
                    }

                }

                return result;
            }
            catch (System.Exception ex)
            {
                throw ex;
            }
        }

        private IEnumerable<CamProcessedLoanViewModel> ApprovedLoans(int companyId, int staffId, int branchId)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var company = context.TBL_COMPANY.Find(companyId);

            var data = (from d in context.TBL_LOAN_APPLICATION_DETAIL
                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                        //join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID

                        where m.COMPANYID == companyId && d.DELETED == false
                        && ((m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.AvailmentCompleted)
                        || (m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.OfferLetterGenerationInProgress)
                        || (m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.OfferLetterGenerationCompleted)
                        || (m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.BookingRequestInitiated)
                        || (m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.BookingRequestCompleted)
                        || (m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.LoanBookingInProgress)
                        || (m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.LoanBookingCompleted))
                        && m.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.CancellationInProgress
                        && m.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.CancellationCompleted
                        && m.BRANCHID == branchId
                        orderby m.AVAILMENTDATE descending, m.DATETIMECREATED descending
                        select new CamProcessedLoanViewModel
                        {
                            approvalStatusId = (short)m.APPROVALSTATUSID,
                            loanApplicationId = m.LOANAPPLICATIONID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                            applicationStatusId = m.APPLICATIONSTATUSID,
                            customerId = d.CUSTOMERID,
                            //customerCode = from cust in context.TBL_CUSTOMER where cust.CUSTOMERID == d.CUSTOMERID select cust.CUSTOMERCODE.FirstOrDefault( ,
                            customerName = d.TBL_CUSTOMER.FIRSTNAME + " " + d.TBL_CUSTOMER.MIDDLENAME + " " + d.TBL_CUSTOMER.LASTNAME,
                            customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                            customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                            customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                            isRelatedParty = m.ISRELATEDPARTY,
                            customerSensitivityLevelId = d.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                            customerOccupation = d.TBL_CUSTOMER.OCCUPATION,
                            customerType = d.TBL_CUSTOMER.TBL_CUSTOMER_TYPE.NAME,
                            operationId = m.OPERATIONID,
                            isPoliticallyExposed = d.TBL_CUSTOMER.ISPOLITICALLYEXPOSED,
                            isInvestmentGrade = m.ISINVESTMENTGRADE,

                            companyId = m.COMPANYID,
                            branchId = m.BRANCHID,
                            branchName = m.TBL_BRANCH.BRANCHNAME,
                            subSectorId = d.SUBSECTORID,
                            subSectorName = d.TBL_SUB_SECTOR.NAME,
                            sectorName = d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            applicationTenor = m.APPLICATIONTENOR,
                            effectiveDate = (DateTime)d.EFFECTIVEDATE,
                            expiryDate = (DateTime)d.EXPIRYDATE,
                            relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                            relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                            relationshipManagerId = m.RELATIONSHIPMANAGERID,
                            relationshipManagerName = m.TBL_STAFF1.FIRSTNAME + " " + m.TBL_STAFF1.MIDDLENAME + " " + m.TBL_STAFF1.LASTNAME,

                            currencyId = d.CURRENCYID,
                            currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                            isLocalCurrency = company.CURRENCYID == d.CURRENCYID ? true : false,
                            exchangeRate = d.EXCHANGERATE,
                            loanTypeId = m.LOANAPPLICATIONTYPEID,
                            loanTypeName = m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                            productId = d.APPROVEDPRODUCTID,
                            productTypeId = d.TBL_PRODUCT.PRODUCTTYPEID,
                            productTypeName = d.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            productName = d.TBL_PRODUCT.PRODUCTNAME,
                            productClassProcessId = m.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                            productClassId = m.PRODUCTCLASSID,
                            misCode = m.MISCODE,
                            teamMisCode = m.TEAMMISCODE,
                            casaAccountId = d.CASAACCOUNTID,

                            interestRate = d.APPROVEDINTERESTRATE,
                            submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                            approvedAmount = d.APPROVEDAMOUNT,
                            approvedDate = m.APPROVEDDATE,
                            groupApprovedAmount = m.APPROVEDAMOUNT,
                            approvedTenor = d.APPROVEDTENOR,
                            createdBy = m.OWNEDBY,
                            newApplicationDate = m.APPLICATIONDATE,
                            dateTimeCreated = d.DATETIMECREATED,
                            availmentDate = m.AVAILMENTDATE,
                            systemCurrentDate = systemDate,
                            isTemporaryOverdraft = context.TBL_PRODUCT_BEHAVIOUR.Where(x => x.PRODUCTID == d.PROPOSEDPRODUCTID && x.ISTEMPORARYOVERDRAFT == true).Any(),
                            loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,
                        });

            foreach (var item in data)
            {
                var loans = context.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var overdrafts = context.TBL_LOAN_REVOLVING.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var contingents = context.TBL_LOAN_CONTINGENT.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                switch (item.productTypeId)
                {
                    case (short)LoanProductTypeEnum.TermLoan:
                        decimal customerAvailableAmount = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount;
                        break;
                    case (short)LoanProductTypeEnum.CommercialLoan:
                        decimal customerAvailableAmount2 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount2 = customerAvailableAmount2 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount2;
                        break;
                    case (short)LoanProductTypeEnum.SelfLiquidating:
                        decimal customerAvailableAmount3 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount3 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount3;
                        break;
                    case (short)LoanProductTypeEnum.RevolvingLoan:
                        decimal overdraftBal = 0;
                        foreach (var overdraft in overdrafts)
                        {
                            if (overdraft.OVERDRAFTLIMIT > 0) overdraftBal = overdraftBal + overdraft.OVERDRAFTLIMIT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - overdraftBal;
                        break;
                    case (short)LoanProductTypeEnum.ContingentLiability:
                        decimal contingentBal = 0;
                        foreach (var contingent in contingents)
                        {
                            if (contingent.CONTINGENTAMOUNT > 0) contingentBal = contingentBal + contingent.CONTINGENTAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - contingentBal;
                        break;
                    case (short)LoanProductTypeEnum.SyndicatedTermLoan:
                        decimal customerAvailableAmount4 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount4 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount4;
                        break;
                }

                if (item.effectiveDate == null) item.effectiveDate = item.availmentDate;
                if (item.expiryDate == null && item.effectiveDate != null) item.expiryDate = item.effectiveDate.Value.AddDays(item.approvedTenor);
            }

            return data;
        }

        public IEnumerable<CamProcessedLoanViewModel> ApprovedLoansForIFF(int companyId, int staffId, int branchId)
        {
            var data = ApprovedLoans(companyId, staffId, branchId);
            data = (from a in data where ((a.customerAvailableAmount > 0) || (a.customerAvailableAmount == null)) select a).ToList();

            foreach (var item in data)
            {

                var requests = context.TBL_LOAN_BOOKING_REQUEST.Where(r => r.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);

                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Count() > 0)
                { item.approveRequestAmount = (decimal)requests.Where(k => k.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Sum(s => s.AMOUNT_REQUESTED); }

                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                { item.pendingRequestAmount = (decimal)requests.Where(j => j.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount; }

                if (requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                { item.allRequestAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount; }

                item.disapprovedCount = (int)requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Count();

                if (item.disapprovedCount > 0)
                { item.disApprovedAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Sum(s => s.AMOUNT_REQUESTED); }

                var disbursedLoan = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId && x.ISDISBURSED == true);
                if (disbursedLoan.Any())
                {
                    item.amountDisbursed = disbursedLoan.Sum(c => c.PRINCIPALAMOUNT);
                }

                item.customerAvailableAmount = item.approvedAmount - (item.allRequestAmount - item.requestedAmount);
            }

            return data;
        }

        private IEnumerable<CamProcessedLoanViewModel> AvailedLoanApplicationsDetails(int companyId, int staffId, int branchId)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var company = context.TBL_COMPANY.Find(companyId);

            var staffIds = generalSetup.GetStaffRlieved(staffId);
            //IEnumerable<CamProcessedLoanViewModel> data2;

            var data2 = (from d in context.TBL_LOAN_APPLICATION_DETAIL
                         join a in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals a.LOANAPPLICATIONID
                         join p in context.TBL_PRODUCT on d.APPROVEDPRODUCTID equals p.PRODUCTID
                         where a.COMPANYID == companyId && d.DELETED == false
                         && staffIds.Contains(a.OWNEDBY)
                         && a.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                         && a.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.OfferLetterGenerationInProgress
                         && a.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.OfferLetterReviewInProgress
                         && a.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.CAMInProgress
                         && a.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.CancellationCompleted
                         //&& a.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.BookingRequestInitiated
                         orderby a.AVAILMENTDATE descending, a.DATETIMECREATED descending
                         select new CamProcessedLoanViewModel
                         {
                             //approvalStatusId = (short)atrail.APPROVALSTATUSID,
                             loanBookingRequestId = 0,
                             approvalTrailId = 0,
                             isLineFacility = context.TBL_PRODUCT.Where(x => x.PRODUCTID == d.APPROVEDPRODUCTID && x.ISFACILITYLINE == true).Any(),
                             appraisalOperationId = a.OPERATIONID,
                             //bookingAmountRequested = r.AMOUNT_REQUESTED,
                             requestedAmount = 0,
                             loanApplicationId = a.LOANAPPLICATIONID,
                             loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                             applicationReferenceNumber = a.APPLICATIONREFERENCENUMBER,
                             applicationStatusId = a.APPLICATIONSTATUSID,
                             customerId = d.CUSTOMERID,
                             //customerCode = from cust in context.TBL_CUSTOMER where cust.CUSTOMERID == d.CUSTOMERID select cust.CUSTOMERCODE.FirstOrDefault( ,
                             customerName = d.TBL_CUSTOMER.FIRSTNAME + " " + d.TBL_CUSTOMER.MIDDLENAME + " " + d.TBL_CUSTOMER.LASTNAME,
                             customerGroupId = a.CUSTOMERGROUPID.HasValue ? a.CUSTOMERGROUPID : 0,
                             customerGroupName = a.CUSTOMERGROUPID.HasValue ? a.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                             customerGroupCode = a.CUSTOMERGROUPID.HasValue ? a.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                             isRelatedParty = a.ISRELATEDPARTY,
                             customerSensitivityLevelId = d.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                             customerOccupation = d.TBL_CUSTOMER.OCCUPATION,
                             customerType = d.TBL_CUSTOMER.TBL_CUSTOMER_TYPE.NAME,
                             operationId = a.OPERATIONID,
                             isPoliticallyExposed = d.TBL_CUSTOMER.ISPOLITICALLYEXPOSED,
                             isInvestmentGrade = a.ISINVESTMENTGRADE,
                             productClassName = d.TBL_PRODUCT.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                             companyId = a.COMPANYID,
                             branchId = a.BRANCHID,
                             branchName = a.TBL_BRANCH.BRANCHNAME,
                             subSectorId = d.SUBSECTORID,
                             subSectorName = d.TBL_SUB_SECTOR.NAME,
                             sectorName = d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                             applicationTenor = a.APPLICATIONTENOR,
                             effectiveDate = (DateTime)d.EFFECTIVEDATE,
                             expiryDate = (DateTime)d.EXPIRYDATE,
                             relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                             relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                             relationshipManagerId = a.RELATIONSHIPMANAGERID,
                             relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,

                             currencyId = d.CURRENCYID,
                             currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                             isLocalCurrency = company.CURRENCYID == d.CURRENCYID ? true : false,
                             exchangeRate = d.EXCHANGERATE,
                             loanTypeId = a.LOANAPPLICATIONTYPEID,
                             loanTypeName = a.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                             camReference = a.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                             productId = d.APPROVEDPRODUCTID,
                             productTypeId = d.TBL_PRODUCT.PRODUCTTYPEID,
                             productTypeName = d.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                             productName = d.TBL_PRODUCT.PRODUCTNAME,
                             productClassProcessId = a.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                             productClassId = a.PRODUCTCLASSID,
                             misCode = a.MISCODE,
                             teamMisCode = a.TEAMMISCODE,
                             casaAccountId = d.CASAACCOUNTID,

                             interestRate = d.APPROVEDINTERESTRATE,
                             submittedForAppraisal = a.SUBMITTEDFORAPPRAISAL,
                             approvedAmount = d.APPROVEDAMOUNT,
                             approvedDate = a.APPROVEDDATE,
                             groupApprovedAmount = a.APPROVEDAMOUNT,
                             approvedTenor = d.APPROVEDTENOR,
                             createdBy = a.OWNEDBY,
                             newApplicationDate = a.APPLICATIONDATE,
                             dateTimeCreated = d.DATETIMECREATED,
                             availmentDate = a.AVAILMENTDATE,
                             systemCurrentDate = systemDate,
                             isTemporaryOverdraft = context.TBL_PRODUCT_BEHAVIOUR.Where(x => x.PRODUCTID == d.PROPOSEDPRODUCTID && x.ISTEMPORARYOVERDRAFT == true).Any(),
                             loanPreliminaryEvaluationId = a.LOANPRELIMINARYEVALUATIONID ?? 0,

                             approvalStatusId = (short)a.APPROVALSTATUSID,
                             approvalStatusName = context.TBL_APPROVAL_STATUS.Where(o => o.APPROVALSTATUSID == a.APPROVALSTATUSID).Select(o => o.APPROVALSTATUSNAME.ToUpper()).FirstOrDefault(),

                             //availableAmount = 
                         }).ToList();

            var data = (from d in context.TBL_LOAN_APPLICATION_DETAIL
                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                        //join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID

                        where m.COMPANYID == companyId && d.DELETED == false
                        && ((m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.AvailmentCompleted)
                        || (m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.BookingRequestInitiated)
                        || (m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.BookingRequestCompleted)
                        || (m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.LoanBookingInProgress)
                        || (m.APPLICATIONSTATUSID == (int)LoanApplicationStatusEnum.LoanBookingCompleted))
                        && m.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.CancellationInProgress
                        && m.APPLICATIONSTATUSID != (short)LoanApplicationStatusEnum.CancellationCompleted
                        && m.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved
                        && m.BRANCHID == branchId
                        join r in context.TBL_LOAN_BOOKING_REQUEST on d.LOANAPPLICATIONDETAILID equals r.LOANAPPLICATIONDETAILID
                        join atrail in context.TBL_APPROVAL_TRAIL on r.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                        where r.APPROVALSTATUSID != (short)ApprovalStatusEnum.Approved
                        && r.APPROVALSTATUSID != (short)ApprovalStatusEnum.Disapproved && atrail.RESPONSESTAFFID == null
                        && ((atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Referred) && staffIds.Contains(atrail.LOOPEDSTAFFID ?? 0))
                        //&& ((atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing) || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending))
                        orderby atrail.SYSTEMARRIVALDATETIME descending, m.DATETIMECREATED descending
                        //orderby m.AVAILMENTDATE descending, m.DATETIMECREATED descending
                        select new CamProcessedLoanViewModel
                        {
                            loanBookingRequestId = r.LOAN_BOOKING_REQUESTID,
                            approvalTrailId = atrail.APPROVALTRAILID,
                            //bookingAmountRequested = r.AMOUNT_REQUESTED,
                            requestedAmount = r.AMOUNT_REQUESTED,
                            //approvalStatusId = (short) m.APPROVALSTATUSID,
                            appraisalOperationId = m.OPERATIONID,
                            loanApplicationId = m.LOANAPPLICATIONID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                            applicationStatusId = m.APPLICATIONSTATUSID,
                            customerId = d.CUSTOMERID,
                            //customerCode = from cust in context.TBL_CUSTOMER where cust.CUSTOMERID == d.CUSTOMERID select cust.CUSTOMERCODE.FirstOrDefault( ,
                            customerName = d.TBL_CUSTOMER.FIRSTNAME + " " + d.TBL_CUSTOMER.MIDDLENAME + " " + d.TBL_CUSTOMER.LASTNAME,
                            customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                            customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                            customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                            isRelatedParty = m.ISRELATEDPARTY,
                            customerSensitivityLevelId = d.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                            customerOccupation = d.TBL_CUSTOMER.OCCUPATION,
                            customerType = d.TBL_CUSTOMER.TBL_CUSTOMER_TYPE.NAME,
                            operationId = atrail.OPERATIONID,
                            isPoliticallyExposed = d.TBL_CUSTOMER.ISPOLITICALLYEXPOSED,
                            isInvestmentGrade = m.ISINVESTMENTGRADE,
                            productClassName = d.TBL_PRODUCT.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,

                            companyId = m.COMPANYID,
                            branchId = m.BRANCHID,
                            branchName = m.TBL_BRANCH.BRANCHNAME,
                            subSectorId = d.SUBSECTORID,
                            subSectorName = d.TBL_SUB_SECTOR.NAME,
                            sectorName = d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            applicationTenor = m.APPLICATIONTENOR,
                            effectiveDate = (DateTime)d.EFFECTIVEDATE,
                            expiryDate = (DateTime)d.EXPIRYDATE,
                            relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                            relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                            relationshipManagerId = m.RELATIONSHIPMANAGERID,
                            relationshipManagerName = m.TBL_STAFF1.FIRSTNAME + " " + m.TBL_STAFF1.MIDDLENAME + " " + m.TBL_STAFF1.LASTNAME,

                            currencyId = d.CURRENCYID,
                            currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                            isLocalCurrency = company.CURRENCYID == d.CURRENCYID ? true : false,
                            exchangeRate = d.EXCHANGERATE,
                            loanTypeId = m.LOANAPPLICATIONTYPEID,
                            loanTypeName = m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                            productId = d.APPROVEDPRODUCTID,
                            productTypeId = d.TBL_PRODUCT.PRODUCTTYPEID,
                            productTypeName = d.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            productName = d.TBL_PRODUCT.PRODUCTNAME,
                            productClassProcessId = m.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                            productClassId = m.PRODUCTCLASSID,
                            misCode = m.MISCODE,
                            teamMisCode = m.TEAMMISCODE,
                            casaAccountId = r.CASAACCOUNTID,

                            interestRate = d.APPROVEDINTERESTRATE,
                            submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                            approvedAmount = d.APPROVEDAMOUNT,
                            approvedDate = m.APPROVEDDATE,
                            groupApprovedAmount = m.APPROVEDAMOUNT,
                            approvedTenor = d.APPROVEDTENOR,
                            createdBy = m.OWNEDBY,
                            newApplicationDate = m.APPLICATIONDATE,
                            dateTimeCreated = d.DATETIMECREATED,
                            availmentDate = m.AVAILMENTDATE,
                            systemCurrentDate = systemDate,
                            isTemporaryOverdraft = context.TBL_PRODUCT_BEHAVIOUR.Where(x => x.PRODUCTID == d.PROPOSEDPRODUCTID && x.ISTEMPORARYOVERDRAFT == true).Any(),
                            loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,

                            //approvalStatusId = (short)m.APPROVALSTATUSID,
                            approvalStatusId = (short)atrail.APPROVALSTATUSID,
                            approvalStatusName = context.TBL_APPROVAL_STATUS.Where(o => o.APPROVALSTATUSID == atrail.APPROVALSTATUSID).Select(o => o.APPROVALSTATUSNAME.ToUpper()).FirstOrDefault(),

                        }).ToList();

            data = data.Union(data2).ToList();

            foreach (var item in data)
            {
                var loans = context.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var overdrafts = context.TBL_LOAN_REVOLVING.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var contingents = context.TBL_LOAN_CONTINGENT.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                switch (item.productTypeId)
                {
                    case (short)LoanProductTypeEnum.TermLoan:
                        decimal customerAvailableAmount = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount;
                        break;
                    case (short)LoanProductTypeEnum.CommercialLoan:
                        decimal customerAvailableAmount2 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount2 = customerAvailableAmount2 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount2;
                        break;
                    case (short)LoanProductTypeEnum.SelfLiquidating:
                        decimal customerAvailableAmount3 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount3 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount3;
                        break;
                    case (short)LoanProductTypeEnum.RevolvingLoan:
                        decimal overdraftBal = 0;
                        foreach (var overdraft in overdrafts)
                        {
                            if (overdraft.OVERDRAFTLIMIT > 0) overdraftBal = overdraftBal + overdraft.OVERDRAFTLIMIT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - overdraftBal;
                        break;
                    case (short)LoanProductTypeEnum.ContingentLiability:
                        decimal contingentBal = 0;
                        foreach (var contingent in contingents)
                        {
                            if (contingent.CONTINGENTAMOUNT > 0) contingentBal = contingentBal + contingent.CONTINGENTAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - contingentBal;
                        break;
                    case (short)LoanProductTypeEnum.SyndicatedTermLoan:
                        decimal customerAvailableAmount4 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount4 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount4;
                        break;
                }

                if (item.effectiveDate == null) item.effectiveDate = item.availmentDate;
                if (item.expiryDate == null && item.effectiveDate != null) item.expiryDate = item.effectiveDate.Value.AddDays(item.approvedTenor);
            }

            return data;
        }

        public int GetDrawdownOperationId(int applicationDetailId)
        {
            var loanApplicationDetails = context.TBL_LOAN_APPLICATION_DETAIL.Find(applicationDetailId);

            var requestedProduct = context.TBL_PRODUCT.Find(loanApplicationDetails.APPROVEDPRODUCTID);

            var operationId = 0;
            if (requestedProduct.PRODUCTCLASSID == (short)ProductClassEnum.Creditcards)
            {
                operationId = (short)OperationsEnum.CreditCardDrawdownRequest;
            }
            else if (loanApplicationDetails.TBL_CUSTOMER.CUSTOMERTYPEID == (short)CustomerTypeEnum.Individual)
            {
                if (requestedProduct.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID == (short)ProductClassProcessEnum.CAMBased)
                {
                    operationId = (short)OperationsEnum.CorporateDrawdownRequest;
                }
                operationId = (short)OperationsEnum.IndividualDrawdownRequest;
            }
            else if (loanApplicationDetails.TBL_CUSTOMER.CUSTOMERTYPEID == (short)CustomerTypeEnum.Corporate)
            {
                operationId = (short)OperationsEnum.CorporateDrawdownRequest;
            }

            return operationId;
        }

        public IEnumerable<CamProcessedLoanViewModel> GetAvailedLoanApplicationsDueForInitiateBooking(int companyId, int staffId, int branchId)
        {
            //var data = AvailedLoanApplicationsDetails(companyId, staffId, branchId).Where(x => x.productTypeId != (short)LoanProductTypeEnum.ContingentLiability);
            var data = AvailedLoanApplicationsDetails(companyId, staffId, branchId).ToList();
            data = (from a in data where ((a.customerAvailableAmount > 0) || (a.customerAvailableAmount == null)) select a).ToList();

            var referredItem = GetBookingRequestAwaitingApproval(staffId, companyId, true).Where(x => x.approvalStatusId == (short)ApprovalStatusEnum.Referred).ToList();
            data.AddRange(referredItem);

            foreach (var item in data)
            {
                var approvedLCIssuanceIds = context.TBL_LC_ISSUANCE.Where(t => t.APPLICATIONSTATUSID != null && t.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.LcIssuanceInProgress).Select(t => t.LCISSUANCEID).ToList();
                var lcIFFRequests = context.TBL_LC_ISSUANCE.Where(l => l.DELETED == false && l.FUNDSOURCEID == (int)LCFundSource.IFF);
                var lcapprovedLCIFFs = lcIFFRequests.Where(i => approvedLCIssuanceIds.Contains(i.LCISSUANCEID)).Select(i => new { i.FUNDSOURCEDETAILS, i.LETTEROFCREDITAMOUNT });
                var lcapprovedLCIFFsRecords = lcapprovedLCIFFs.Where(i => i.FUNDSOURCEDETAILS == item.loanApplicationId);
                var lcApprovedAmounts = lcapprovedLCIFFsRecords.Count() > 0 ? lcapprovedLCIFFsRecords?.Sum(i => i.LETTEROFCREDITAMOUNT) : 0;
                var requests = context.TBL_LOAN_BOOKING_REQUEST.Where(r => r.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                item.operationId = GetDrawdownOperationId(item.loanApplicationDetailId);
                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Count() > 0)
                { item.approveRequestAmount = (decimal)requests.Where(k => k.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Sum(s => s.AMOUNT_REQUESTED); }

                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                { item.pendingRequestAmount = (decimal)requests.Where(j => j.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount; }

                if (requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                { item.allRequestAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount; }

                item.disapprovedCount = (int)requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Count();

                if (item.disapprovedCount > 0)
                { item.disApprovedAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Sum(s => s.AMOUNT_REQUESTED); }

                var disbursedLoan = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId && x.ISDISBURSED == true);
                if (disbursedLoan.Any())
                {
                    item.amountDisbursed = disbursedLoan.Sum(c => c.PRINCIPALAMOUNT);
                }

                item.customerAvailableAmount = item.approvedAmount - (item.allRequestAmount - item.requestedAmount);
                if (lcApprovedAmounts > 0)
                {
                    item.customerAvailableAmount -= lcApprovedAmounts;
                }
            }

            return data;

        }

        public IEnumerable<CamProcessedLoanViewModel> getApplicationsToBeAdhocApprovedForInitiateBooking(int companyId, int staffId, int branchId)
        {
            //var data = AvailedLoanApplicationsDetails(companyId, staffId, branchId).Where(x => x.productTypeId != (short)LoanProductTypeEnum.ContingentLiability);
            var data = AvailedLoanApplicationsDetails(companyId, staffId, branchId);
            data = (from a in data where ((a.customerAvailableAmount > 0) || (a.customerAvailableAmount == null)) select a).ToList();

            foreach (var item in data)
            {

                var requests = context.TBL_LOAN_BOOKING_REQUEST.Where(r => r.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);

                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Count() > 0)
                    item.approveRequestAmount = (decimal)requests.Where(k => k.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Sum(s => s.AMOUNT_REQUESTED);

                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                    item.pendingRequestAmount = (decimal)requests.Where(j => j.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount;

                if (requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                    item.allRequestAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount;

                item.disapprovedCount = (int)requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Count();

                if (item.disapprovedCount > 0)
                    item.disApprovedAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Sum(s => s.AMOUNT_REQUESTED);

                item.customerAvailableAmount = item.approvedAmount - (item.allRequestAmount - item.requestedAmount);

                var disbursedLoan = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId && x.ISDISBURSED == true);
                if (disbursedLoan.Any())
                {
                    item.amountDisbursed = disbursedLoan.Sum(c => c.PRINCIPALAMOUNT);
                }

            }

            return data;
        }


        public IEnumerable<CamProcessedLoanViewModel> GetAvailedLoanApplicationDetailById(int staffId, int companyId, int applicationDetailId, int loanBookingRequestId)
        {
            
                var data = AvailedLoanApplicationsReadyForBookingByApplicationDetailId(staffId, companyId, applicationDetailId, loanBookingRequestId); //.Where(x => x.bookingRequestStatusId == (int)ApprovalStatusEnum.Approved);

                data = (from a in data where ((a.customerAvailableAmount >= 0) || (a.customerAvailableAmount == null)) select a).ToList();
                if(data.Count() == 0)
                {
                    throw new ConditionNotMetException("Customer available balance is less then the requested amount");
                }
                foreach (var item in data)
                {
                    if (item.customerAvailableAmount != 0)
                    {
                        if (!item.customerAvailableAmount.HasValue)
                            item.customerAvailableAmount = item.approvedAmount;
                    }
                }
                return data;
        }

        private decimal getDisbursableAmount(int operationId, int loanApplicationDetailId)
        {
            var appDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(loanApplicationDetailId);
            var approvedAmount = appDetail.APPROVEDAMOUNT;
            decimal? disbursableAmount = 0;
            if (operationId == (short)OperationsEnum.TermLoanBooking
                || operationId == (short)OperationsEnum.ForeignExchangeLoanBooking
                || operationId == (short)OperationsEnum.CommercialLoanBooking)
            {
                var summedPrincipal = (from l in context.TBL_LOAN
                                       where l.LOANAPPLICATIONDETAILID == loanApplicationDetailId
                                       select (decimal?)l.PRINCIPALAMOUNT).Sum() ?? 0;
                disbursableAmount = approvedAmount - summedPrincipal;
            }
            if (operationId == (short)OperationsEnum.ContigentLoanBooking)
            {
                var summedPrincipal = approvedAmount - (from l in context.TBL_LOAN_CONTINGENT
                                                        where l.LOANAPPLICATIONDETAILID == loanApplicationDetailId
                                                        select (decimal?)l.CONTINGENTAMOUNT).Sum() ?? 0;
                disbursableAmount = approvedAmount - summedPrincipal;
            }
            if (operationId == (short)OperationsEnum.RevolvingLoanBooking)
            {
                var summedPrincipal = approvedAmount - (from l in context.TBL_LOAN_REVOLVING
                                                        where l.LOANAPPLICATIONDETAILID == loanApplicationDetailId
                                                        select (decimal?)l.OVERDRAFTLIMIT).Sum() ?? 0;
                disbursableAmount = approvedAmount - summedPrincipal;
            }
            return disbursableAmount ?? 0;
        }

        private bool OfferLetterChecklistValidation(int id, int type)
        {
            int count = 0;
            if (type == 1)
            {
                var detailids = context.TBL_LOAN_APPLICATION_DETAIL.Where(x => x.LOANAPPLICATIONID == id)
                    .Select(x => x.LOANAPPLICATIONDETAILID)
                    .ToList();

                count = context.TBL_LOAN_CONDITION_PRECEDENT.Where(x => detailids.Contains(x.LOANAPPLICATIONDETAILID)
                        && x.CHECKLISTSTATUSID == (int)CheckListStatusEnum.Deferred
                        && x.ISSUBSEQUENT == false
                    )
                    .Count();
            }

            return count == 0;
        }

        //public bool AddLoanBookingRequest(int applicationStatusId, List<LoanBookingRequestViewModel> models)
        //{
        //    using (var trans = context.Database.BeginTransaction())
        //    {
        //        foreach (var model in models)
        //        {
        //            if (model.approvalStatusId != (short)ApprovalStatusEnum.Referred)
        //            {
        //                if (!AddLoanBookingRequests(applicationStatusId, model))
        //                {
        //                    //if (model.isLienPlacementForLoan)
        //                    //{
        //                    //    var twoFactorAuthDetails = new TwoFactorAutheticationViewModel
        //                    //    {
        //                    //        username = model.username,
        //                    //        passcode = model.passCode
        //                    //    };
        //                    //    PlaceLien(model.loanApplicationDetailId, twoFactorAuthDetails);
        //                    //}
        //                    trans.Rollback();
        //                    return false;
        //                }
        //            }
        //            else
        //            {
        //                if (!UpdateLoanBookingRequests(applicationStatusId, model))
        //                {
        //                    trans.Rollback();
        //                    return false;
        //                }
        //            }

        //            //if (model.isLienPlacementForLoan)
        //            //{
        //            //    var twoFactorAuthDetails = new TwoFactorAutheticationViewModel
        //            //    {
        //            //        username = model.username,
        //            //        passcode = model.passCode
        //            //    };

        //            //    PlaceLienForLoan(model, twoFactorAuthDetails);
        //            //}
        //        }
        //        trans.Commit();
        //        return true;
        //    }
        //}


        private void PlaceLien(int loanApplicationDetailId, TwoFactorAutheticationViewModel twoFactorAuthDetails, int createdBy)
        {
            //TODO fetch the AccountBalance for account from the API

            var app = context.TBL_LOAN_APPLICATION_DETAIL.Find(loanApplicationDetailId);

            List<int> collateralTypesIds = new List<int>();
            collateralTypesIds.Add((int)CollateralTypeEnum.CASA);
            collateralTypesIds.Add((int)CollateralTypeEnum.FixedDeposit);
            //collateralTypesIds.Add((int)CollateralTypeEnum.DomiciliationContract);
            collateralTypesIds.Add((int)CollateralTypeEnum.TreasuryBillsAndBonds);

            //var collateralMappings = context.TBL_LOAN_APPLICATION_COLLATERL.Where(x => x.LOANAPPLICATIONDETAILID == loanApplicationDetailId && x.DELETED == false).ToList();
            //var mappedCollateralIds = collateralMappings.Select(m => m.COLLATERALCUSTOMERID).ToList();
            //var collaterals = context.TBL_COLLATERAL_CUSTOMER.Where(x => mappedCollateralIds.Contains(x.COLLATERALCUSTOMERID) && collateralTypesIds.Contains(x.COLLATERALTYPEID));
            var loanLienDetail = context.TBL_APPLICATIONDETAIL_LIEN.Where(l => l.APPLICATIONDETAILID == loanApplicationDetailId && l.DELETED == false && l.ISRELEASED == false).ToList();
            var mappedCollateralIds = loanLienDetail.Select(m => m.COLLATERALCUSTOMERID).ToList();
            var collaterals = context.TBL_COLLATERAL_CUSTOMER.Where(x => mappedCollateralIds.Contains(x.COLLATERALCUSTOMERID) && collateralTypesIds.Contains(x.COLLATERALTYPEID));

            foreach (var item in collaterals)
            {
                TBL_CASA casa = new TBL_CASA();
                if (item.COLLATERALTYPEID == (int)CollateralTypeEnum.CASA)
                {
                    casa = context.TBL_CASA.Where(x => x.CASAACCOUNTID == item.TBL_COLLATERAL_CASA.FirstOrDefault().COLLATERALCASAID).FirstOrDefault();
                }

                var casaBalance = integration.GetCustomerAccountBalance(casa.PRODUCTACCOUNTNUMBER);

                var staffCode = context.TBL_STAFF.Where(O => O.STAFFID == createdBy).FirstOrDefault().STAFFCODE;

                var lienModel = new FlexcubeLienViewModel
                {
                    account_no = casa.PRODUCTACCOUNTNUMBER,
                    collateral_code = item.COLLATERALCODE,
                    collateral_value = item.COLLATERALVALUE.ToString(),
                    start_date = app.EFFECTIVEDATE.Value.ToString("ddMMMyyyy"),
                    end_date = app.EFFECTIVEDATE.Value.AddDays(app.APPROVEDTENOR).ToString("ddMMMyyyy"),
                    collateral_id = item.COLLATERALCUSTOMERID.ToString(),
                    contract_ref_no = app.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER,
                    collateral_contribution = casaBalance.availableBalance.ToString(),
                    branch_code = app.TBL_LOAN_APPLICATION.TBL_BRANCH.BRANCHCODE,
                    channel_code = "FINTRAK",
                    maker_id = staffCode,
                    checker_id = staffCode,
                    loanApplicationId = app.LOANAPPLICATIONID
                };

                integration.FlexcubeCasaLien(lienModel);
            }

            //var lienModel = new FlexcubeLienViewModel
            //{
            //    account_no = "0704490004",
            //    collateral_code = "1000010", //"07044900D11",
            //    collateral_value = "100",
            //    start_date = app.EFFECTIVEDATE.Value.ToString("ddMMMyyyy"),
            //    end_date = app.EFFECTIVEDATE.Value.AddDays(app.APPROVEDTENOR).ToString("ddMMMyyyy"),
            //    collateral_id = "10",
            //    contract_ref_no = "1255966785711",
            //    collateral_contribution = "200",
            //    branch_code = app.TBL_LOAN_APPLICATION.TBL_BRANCH.BRANCHCODE,
            //    channel_code = "FINTRAK",
            //    loanApplicationId = app.LOANAPPLICATIONID
            //};

            //integration.FlexcubeCasaLien(lienModel);

        }

        //private void PlaceLienForLoan(LoanBookingRequestViewModel model, TwoFactorAutheticationViewModel twoFactorAuthDetails)
        //{
        //    //TODO fetch the AccountBalance for account from the API
        //    var casa = context.TBL_CASA.Find(model.casaAccountId2);

        //    var lienModel = new CasaLienViewModel
        //    {
        //        productAccountNumber = casa.PRODUCTACCOUNTNUMBER,
        //        sourceReferenceNumber = model.loanApplicationId.ToString(),
        //        userBranchId = (short)model.userBranchId,
        //        branchId = (short)model.sourceBranchId,
        //        companyId = model.companyId,
        //        lienAmount = model.approvedAmount, //loanRecord.PRINCIPALAMOUNT + loanRecord.OUTSTANDINGINTEREST,
        //        description = "Lien for Fixed Deposit Collateral",
        //        lienTypeId = (short)LienTypeEnum.IDFBooking,
        //        createdBy = model.createdBy,
        //        userIPAddress = model.userIPAddress,
        //        applicationUrl = model.applicationUrl,
        //    };
        //    //casaLien.PlaceLien(lienModel, twoFactorAuthDetails);
        //}

        private bool UpdateLoanBookingRequests(int applicationStatusId, LoanBookingRequestViewModel model)
        {
            var request = context.TBL_LOAN_BOOKING_REQUEST.Find(model.loanBookingRequestId);

            var loanApplicationDetails = context.TBL_LOAN_APPLICATION_DETAIL.Find(request.LOANAPPLICATIONDETAILID);
            if (model.amount_Requested > loanApplicationDetails.APPROVEDAMOUNT)
            {
                throw new ConditionNotMetException("Requested Amount cannot be greater than the approved amount");
            }

            if (request != null)
            {
                model.approvalStatusId = (short)ApprovalStatusEnum.Approved;

                request.AMOUNT_REQUESTED = model.amount_Requested;
                request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Pending;
                //request.LOANAPPLICATIONDETAILID = model.loanApplicationDetailId;
                request.CASAACCOUNTID = model.casaAccountId;
                request.CASAACCOUNTID2 = model.casaAccountId2;
                request.ISUSED = false;
                request.PRODUCTID = model.productId;
                request.DATETIMEUPDATED = DateTime.Now;
                request.LASTUPDATEDBY = model.createdBy;

                workflow.StaffId = model.createdBy;
                workflow.CompanyId = model.companyId;
                workflow.StatusId = (int)ApprovalStatusEnum.Processing;
                //workflow.StatusId = ((int)model.approvalStatusId == (int)ApprovalStatusEnum.Approved) ? (int)ApprovalStatusEnum.Processing : (int)model.approvalStatusId;
                workflow.TargetId = request.LOAN_BOOKING_REQUESTID;
                workflow.Comment = model.comment != null ? model.comment : "Kindly proceeed. Update has been applied";
                workflow.OperationId = model.operationId ?? 0;
                workflow.DeferredExecution = true;
                workflow.ExternalInitialization = false;

                workflow.LogActivity();

                //return false;
                return context.SaveChanges() > 0;
            }
            return false;
        }

        private bool AddLoanBookingRequests(int applicationStatusId, LoanBookingRequestViewModel entity)
        {

            var loanApplicationDetails = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            if (entity.amount_Requested > loanApplicationDetails.APPROVEDAMOUNT)
            {
                throw new ConditionNotMetException("Requested Amount cannot be greater than the approved amount");
            }

            if (context.TBL_LOAN_BOOKING_REQUEST.Where(x => x.LOANAPPLICATIONDETAILID == entity.loanApplicationDetailId && x.APPROVALSTATUSID != (short)ApprovalStatusEnum.Approved && x.APPROVALSTATUSID != (short)ApprovalStatusEnum.Disapproved && x.DELETED == false && x.ISUSED == false).Any())
            {
                throw new ConditionNotMetException("This facility already has a running tranche disbursement request currently undergoing approval.");
            }

            //if (entity.tenor > loanApplicationDetails.APPROVEDTENOR)
            //{
            //    throw new ConditionNotMetException("Requested Tenor cannot be greater than the approved tenor");
            //}

            var requestedFacility = context.TBL_PRODUCT.Find(entity.productId);

            var operationId = 0;
            var productTypeId = requestedFacility.PRODUCTTYPEID;

            if (productTypeId == (short)LoanProductTypeEnum.TermLoan || productTypeId == (short)LoanProductTypeEnum.SelfLiquidating || productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                operationId = (short)OperationsEnum.TermLoanBooking;

            if (productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
                operationId = (short)OperationsEnum.CommercialLoanBooking;

            if (productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                operationId = (short)OperationsEnum.RevolvingLoanBooking;

            if (productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
                operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;

            if (productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                operationId = (short)OperationsEnum.ContigentLoanBooking;

            if (entity.amount_Requested > getDisbursableAmount(operationId, entity.loanApplicationDetailId))
            {
                throw new ConditionNotMetException("Requested Amount cannot be greater than the disbursable amount");
            }



            bool cleared = OfferLetterChecklistValidation(loanApplicationDetails.LOANAPPLICATIONID, 1);
            if (cleared == false) throw new SecureException("Checklist not cleared to go further!");


            if (entity.casaAccountId2 == 0) entity.casaAccountId2 = null;
            if (entity.casaAccountId == 0) entity.casaAccountId = null;
            var request = new TBL_LOAN_BOOKING_REQUEST
            {
                AMOUNT_REQUESTED = entity.amount_Requested,
                APPROVALSTATUSID = (short)ApprovalStatusEnum.Pending,
                LOANAPPLICATIONDETAILID = entity.loanApplicationDetailId,
                CASAACCOUNTID = entity.casaAccountId,
                CASAACCOUNTID2 = entity.casaAccountId2,
                ISUSED = false,
                PRODUCTID = entity.productId,
                DATETIMECREATED = DateTime.Now,
                CREATEDBY = entity.createdBy,
                TENOR = entity.tenor,

            };
            context.TBL_LOAN_BOOKING_REQUEST.Add(request);
            context.SaveChanges();

            var approvalModel = new ForwardViewModel
            {
                createdBy = entity.createdBy,
                companyId = entity.companyId,
                applicationId = request.LOAN_BOOKING_REQUESTID,
                comment = "Please approve this request for loan booking",
                amount = entity.amount_Requested,
            };

            if (requestedFacility.PRODUCTCLASSID == (short)ProductClassEnum.Creditcards)
            {
                LogApproval(approvalModel, (short)OperationsEnum.CreditCardDrawdownRequest, true, (int)ApprovalStatusEnum.Pending);
            }
            else if (loanApplicationDetails.TBL_CUSTOMER.CUSTOMERTYPEID == (short)CustomerTypeEnum.Individual)
            {
                if (requestedFacility.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID == (short)ProductClassProcessEnum.CAMBased)
                {
                    LogApproval(approvalModel, (short)OperationsEnum.CorporateDrawdownRequest, true, (int)ApprovalStatusEnum.Pending);
                }
                else LogApproval(approvalModel, (short)OperationsEnum.IndividualDrawdownRequest, true, (int)ApprovalStatusEnum.Pending);
            }
            else if (loanApplicationDetails.TBL_CUSTOMER.CUSTOMERTYPEID == (short)CustomerTypeEnum.Corporate)
            {
                LogApproval(approvalModel, (short)OperationsEnum.CorporateDrawdownRequest, true, (int)ApprovalStatusEnum.Pending);
            }


            // Audit Section ---------------------------
            var audit = new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.LoanBookingRequested,
                STAFFID = entity.createdBy,
                BRANCHID = (short)entity.userBranchId,
                DETAIL = $"Request to book loan of amount '{ entity.amount_Requested }' for customer'{entity.customerName}'",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = entity.applicationUrl,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName(),
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now
            };
            this.audit.AddAuditTrail(audit);
            // End of Audit Section ---------------------

            return context.SaveChanges() > 0;

        }

        public IEnumerable<CamProcessedLoanViewModel> GetAvailedContingentFacilityBooking(int companyId, int staffId)
        {
            var staff = context.TBL_STAFF.Find(staffId);
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            //var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

            List<int> operationIds = new List<int>();

            var bAndGStaffLevels = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == (int)OperationsEnum.ContigentLoanBooking)
                .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
                .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true),
                    mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new
                    {
                        groupPosition = mg.m.POSITION,
                        levelPosition = l.POSITION,
                        levelId = l.APPROVALLEVELID,
                        levelName = l.LEVELNAME,
                        staffRoleId = l.STAFFROLEID,
                    })
                    .OrderBy(x => x.groupPosition)
                    .ThenBy(x => x.levelPosition)
                    .ToList();

            var bAndGStaffRoleLevels = bAndGStaffLevels.Where(x => x.staffRoleId == staff.STAFFROLEID).ToList();
            var bAndGStaffRoleLevelIds = bAndGStaffRoleLevels.Select(x => x.levelId).ToList();

            if (bAndGStaffRoleLevelIds.Any())
            {
                operationIds.Add((int)OperationsEnum.ContigentLoanBooking);
            }
            var company = context.TBL_COMPANY.Find(companyId);
            IEnumerable<CamProcessedLoanViewModel> allLoans = null;
            IEnumerable<CamProcessedLoanViewModel> bookingRequestLoans = null;
            IEnumerable<CamProcessedLoanViewModel> referredBackLoans = null;

            bookingRequestLoans = (from s in context.TBL_LOAN_BOOKING_REQUEST
                                   join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                   join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                   join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                   join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                   join p in context.TBL_PRODUCT on d.APPROVEDPRODUCTID equals p.PRODUCTID
                                   join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                   where m.COMPANYID == companyId
                                   && (((atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending) || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Referred && s.ISUSED == true)))
                                   //&& ((atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing) || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending))
                                   && s.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && s.ISUSED == false && s.DELETED == false
                                   && ((bAndGStaffRoleLevelIds.Contains((int)atrail.TOAPPROVALLEVELID)) || (atrail.REQUESTSTAFFID == staffId))
                                   && operationIds.Contains(atrail.OPERATIONID)
                                   && atrail.RESPONSESTAFFID == null
                                   && s.ISDISBURSED == false
                                   //&& d.CRMSVALIDATED == true
                                   orderby s.LOAN_BOOKING_REQUESTID descending
                                   select new CamProcessedLoanViewModel()
                                   {
                                       bookingAmountRequested = s.AMOUNT_REQUESTED,
                                       loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                       bookingRequestStatusId = s.APPROVALSTATUSID,
                                       requestDate = s.DATETIMECREATED,
                                       requestedBy = "",
                                       systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                       requestedAmount = s.AMOUNT_REQUESTED,
                                       requestOperationId = (short)atrail.OPERATIONID,
                                       //requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                       approvalStatusId = atrail.APPROVALSTATUSID,
                                       approvalStatusName = atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                       loanApplicationId = m.LOANAPPLICATIONID,
                                       operationId = m.OPERATIONID,
                                       loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                       isLineFacility = d.ISLINEFACILITY,
                                       isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                       applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                       applicationStatusId = m.APPLICATIONSTATUSID,
                                       customerId = d.CUSTOMERID,
                                       customerCode = cust.CUSTOMERCODE,
                                       customerName = d.TBL_CUSTOMER.FIRSTNAME + " " + d.TBL_CUSTOMER.MIDDLENAME + " " + d.TBL_CUSTOMER.LASTNAME,
                                       customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                       customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                       customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                       customerType = d.TBL_CUSTOMER.TBL_CUSTOMER_TYPE.NAME,

                                       applicationTenor = m.APPLICATIONTENOR,
                                       effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                       expiryDate = (DateTime)d.EXPIRYDATE,
                                       currencyId = d.CURRENCYID,
                                       currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                                       exchangeRate = d.EXCHANGERATE,
                                       loanTypeId = m.LOANAPPLICATIONTYPEID,
                                       loanTypeName = m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productId = d.APPROVEDPRODUCTID,
                                       productTypeId = d.TBL_PRODUCT.PRODUCTTYPEID,
                                       productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                       productTypeName = d.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                       productName = d.TBL_PRODUCT.PRODUCTNAME,
                                       casaAccountId = s.CASAACCOUNTID,
                                       casaAccountId2 = s.CASAACCOUNTID2,

                                       interestRate = d.APPROVEDINTERESTRATE,
                                       approvedInterestRate = d.APPROVEDINTERESTRATE,
                                       approvedAmount = d.APPROVEDAMOUNT,
                                       groupApprovedAmount = m.APPROVEDAMOUNT,
                                       availmentDate = m.AVAILMENTDATE,
                                       approvedTenor = d.APPROVEDTENOR,
                                       toStaffId = atrail.TOSTAFFID,
                                       requestStaffId = atrail.REQUESTSTAFFID,
                                       currentApprovalLevelId = atrail.TOAPPROVALLEVELID,
                                       isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                       divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                   }).ToList().Take(50);

            referredBackLoans = (from s in context.TBL_LOAN_BOOKING_REQUEST
                                 join l in context.TBL_LOAN on s.LOAN_BOOKING_REQUESTID equals l.LOAN_BOOKING_REQUESTID
                                 join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                 join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                 join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                 join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                 join p in context.TBL_PRODUCT on d.APPROVEDPRODUCTID equals p.PRODUCTID
                                 join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                 where m.COMPANYID == companyId
                                 && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Referred
                                 && s.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && s.ISUSED == false && s.DELETED == false
                                 && bAndGStaffRoleLevelIds.Contains((int)atrail.TOAPPROVALLEVELID)
                                 && operationIds.Contains(atrail.OPERATIONID) && atrail.RESPONSESTAFFID == null
                                 orderby s.LOAN_BOOKING_REQUESTID descending
                                 select new CamProcessedLoanViewModel()
                                 {
                                     bookingAmountRequested = s.AMOUNT_REQUESTED,
                                     loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                     bookingRequestStatusId = s.APPROVALSTATUSID,
                                     requestDate = s.DATETIMECREATED,
                                     requestedBy = "",
                                     systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                     requestedAmount = s.AMOUNT_REQUESTED,
                                     requestOperationId = (short)atrail.OPERATIONID,
                                     //requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                     approvalStatusId = atrail.APPROVALSTATUSID,
                                     approvalStatusName = atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                     loanApplicationId = m.LOANAPPLICATIONID,
                                     operationId = m.OPERATIONID,
                                     loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                     applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                     applicationStatusId = m.APPLICATIONSTATUSID,

                                     customerId = d.CUSTOMERID,
                                     customerCode = cust.CUSTOMERCODE,
                                     customerName = d.TBL_CUSTOMER.FIRSTNAME + " " + d.TBL_CUSTOMER.MIDDLENAME + " " + d.TBL_CUSTOMER.LASTNAME,
                                     customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                     customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                     customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                     customerType = d.TBL_CUSTOMER.TBL_CUSTOMER_TYPE.NAME,

                                     applicationTenor = m.APPLICATIONTENOR,
                                     effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                     expiryDate = (DateTime)d.EXPIRYDATE,

                                     currencyId = d.CURRENCYID,
                                     currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                                     exchangeRate = d.EXCHANGERATE,
                                     loanTypeId = m.LOANAPPLICATIONTYPEID,
                                     loanTypeName = m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                     productId = d.APPROVEDPRODUCTID,
                                     productTypeId = d.TBL_PRODUCT.PRODUCTTYPEID,
                                     productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                     productTypeName = d.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                     productName = d.TBL_PRODUCT.PRODUCTNAME,

                                     interestRate = d.APPROVEDINTERESTRATE,
                                     approvedInterestRate = d.APPROVEDINTERESTRATE,
                                     approvedAmount = d.APPROVEDAMOUNT,
                                     groupApprovedAmount = m.APPROVEDAMOUNT,
                                     availmentDate = m.AVAILMENTDATE,
                                     approvedTenor = d.APPROVEDTENOR,
                                     toStaffId = atrail.TOSTAFFID,
                                     requestStaffId = atrail.REQUESTSTAFFID,
                                     currentApprovalLevelId = atrail.TOAPPROVALLEVELID,
                                     isInEditMode = true,
                                     isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                     divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                 }).ToList().Take(50);

            IEnumerable<CamProcessedLoanViewModel> lcyAndFcyLoans = bookingRequestLoans.Union(referredBackLoans);

            List<CamProcessedLoanViewModel> lcyLoans = new List<CamProcessedLoanViewModel>();
            List<CamProcessedLoanViewModel> fcyLoans = new List<CamProcessedLoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = lcyAndFcyLoans.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
            }

            if (isFCYUser == true)
            {
                fcyLoans = lcyAndFcyLoans.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
            }


            allLoans = lcyLoans.Union(fcyLoans);

            foreach (var item in allLoans)
            {
                var loanRecord = context.TBL_LOAN.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId);
                item.isBooked = loanRecord.Any();

                int operationId = (short)OperationsEnum.ContigentLoanBooking;
                if (item.isInEditMode)
                {
                    var contingentRecord = context.TBL_LOAN_CONTINGENT.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId);
                    item.loanId = contingentRecord.FirstOrDefault()?.CONTINGENTLOANID;
                }

                var trailInfo = context.TBL_APPROVAL_TRAIL.Where(x => x.OPERATIONID == operationId && x.TARGETID == item.loanBookingRequestId);
                if (trailInfo.Any())
                    item.isUnderApproval = true;

                var loans = context.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var overdrafts = context.TBL_LOAN_REVOLVING.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var contingents = context.TBL_LOAN_CONTINGENT.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);

                decimal contingentBal = 0;
                foreach (var contingent in contingents)
                {
                    if (contingent.CONTINGENTAMOUNT > 0) contingentBal = contingentBal + contingent.CONTINGENTAMOUNT;
                }
                item.customerAvailableAmount = item.approvedAmount - contingentBal;

                var disbursedLoan = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId && x.ISDISBURSED == true);
                if (disbursedLoan.Any())
                {
                    item.amountDisbursed = disbursedLoan.Sum(c => c.PRINCIPALAMOUNT);
                }
            }
            allLoans = (from a in allLoans where ((a.customerAvailableAmount >= 0)) select a).ToList();
            return allLoans;
        }

        public IEnumerable<CamProcessedLoanViewModel> GetFacilityLineAwaitingMaintenanceApproval(int staffId, int companyId)
        {
            var company = context.TBL_COMPANY.Find(companyId);
            var newApplicationDate = generalSetup.GetApplicationDate();

            var data = (from s in context.TBL_LOAN_BOOKING_REQUEST
                        join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                        join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                        join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                        where d.DELETED == false && s.DELETED == false
                        && m.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                        && s.ISUSED == true
                        && d.ISLINEFACILITY == true
                        && s.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing
                        && s.ISMAINTAINEDLINE == false
                        && s.ISDISBURSED == false

                        orderby s.DATETIMECREATED descending
                        select new CamProcessedLoanViewModel
                        {
                            bookingAmountRequested = s.AMOUNT_REQUESTED,
                            loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                            bookingRequestStatusId = s.APPROVALSTATUSID,
                            requestDate = s.DATETIMECREATED,
                            requestedBy = "",
                            systemArrivalDateTime = s.DATETIMECREATED,
                            divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                            divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                            appraisalOperationId = m.OPERATIONID,
                            requestedAmount = s.AMOUNT_REQUESTED,
                            requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                            approvalStatusId = (short)m.APPROVALSTATUSID,
                            loanApplicationId = m.LOANAPPLICATIONID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                            applicationStatusId = m.APPLICATIONSTATUSID,
                            casaAccountId = s.CASAACCOUNTID,
                            casaAccountId2 = s.CASAACCOUNTID2,
                            feeAccountName = (from t in context.TBL_CASA where t.CASAACCOUNTID == s.CASAACCOUNTID select t.PRODUCTACCOUNTNAME + "(" + t.PRODUCTACCOUNTNUMBER + ")").FirstOrDefault(),
                            customerId = d.CUSTOMERID,
                            customerCode = cust.CUSTOMERCODE,
                            customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                            customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                            customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                            customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                            isRelatedParty = m.ISRELATEDPARTY,
                            customerSensitivityLevelId = cust.CUSTOMERSENSITIVITYLEVELID,
                            customerOccupation = cust.OCCUPATION,
                            customerType = cust.TBL_CUSTOMER_TYPE.NAME,
                            isPoliticallyExposed = cust.ISPOLITICALLYEXPOSED,
                            isInvestmentGrade = m.ISINVESTMENTGRADE,
                            newApplicationDate = newApplicationDate,
                            loanInformation = m.LOANINFORMATION,
                            companyId = m.COMPANYID,
                            branchId = m.BRANCHID,
                            branchName = m.TBL_BRANCH.BRANCHNAME,
                            subSectorId = d.SUBSECTORID,
                            subSectorName = d.TBL_SUB_SECTOR.NAME,
                            sectorName = (from y in context.TBL_SECTOR.Where(i => i.SECTORID == d.TBL_SUB_SECTOR.SECTORID) select y).FirstOrDefault().NAME,
                            applicationTenor = m.APPLICATIONTENOR,
                            effectiveDate = (DateTime)d.EFFECTIVEDATE,
                            expiryDate = (DateTime)d.EXPIRYDATE,
                            relationshipManagerName = (from r in context.TBL_STAFF where r.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID.Value select r.FIRSTNAME + " " + r.LASTNAME).FirstOrDefault(),
                            currencyId = d.CURRENCYID,
                            currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                            exchangeRate = d.EXCHANGERATE,
                            loanTypeId = m.LOANAPPLICATIONTYPEID,
                            loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME,
                            productId = s.PRODUCTID,
                            productTypeId = p.PRODUCTTYPEID,
                            productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                            productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            productName = p.PRODUCTNAME,
                            productClassId = p.PRODUCTCLASSID,
                            productScheduleTypeId = p.SCHEDULETYPEID,
                            productDealTypeId = p.DEALTYPEID,
                            productDayCountConventionId = p.TBL_PRODUCT_CURRENCY.Select(x => x.DAYCOUNTCONVENTIONID).FirstOrDefault() ?? 0,
                            misCode = m.MISCODE,
                            teamMisCode = m.TEAMMISCODE,

                            interestRate = d.APPROVEDINTERESTRATE,
                            approvedInterestRate = d.APPROVEDINTERESTRATE,
                            submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                            approvedAmount = d.APPROVEDAMOUNT,
                            groupApprovedAmount = m.APPROVEDAMOUNT,
                            availmentDate = m.AVAILMENTDATE,
                            isBidbond = p.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees ? true : false,
                            isOverdraft = p.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan ? true : false,
                            repaymentTerms = d.REPAYMENTTERMS,
                            repaymentSchedule = d.TBL_REPAYMENT_TERM.REPAYMENTTERMDETAIL,
                            approvedTenor = d.APPROVEDTENOR,
                            createdBy = m.OWNEDBY,
                            applicationDate = m.APPLICATIONDATE,
                            dateTimeCreated = d.DATETIMECREATED,
                            loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,
                            isLocalCurrrency = company.CURRENCYID == d.CURRENCYID ? true : false,
                            crmsCode = s.CRMSCODE,

                        }).ToList();


            return data; //.Where(x => x.loanReferenceNumber == null);//.Distinct().ToList();
        }

        public IEnumerable<CamProcessedLoanViewModel> GetAvailedLoanApplicationsReadyForCrmsCode(int companyId, int staffId)
        {
            var staff = context.TBL_STAFF.Find(staffId);
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);

            List<int> operationIds = new List<int>();

            operationIds.Add((int)OperationsEnum.CorporateDrawdownRequest);
            operationIds.Add((int)OperationsEnum.IndividualDrawdownRequest);
            operationIds.Add((int)OperationsEnum.CreditCardDrawdownRequest);
            operationIds.Add((int)OperationsEnum.RevolvingTranchDisbursement);
            operationIds.Add((int)OperationsEnum.IBLAvailmentInProgress);
            var staffs = generalSetup.GetStaffRlieved(staffId);

            List<int> levelIds = new List<int>();
            foreach (var i in operationIds) { levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList()); }

            levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.CorporateDrawdownRequest).ToList());
            levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.IndividualDrawdownRequest).ToList());
            levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.CreditCardDrawdownRequest).ToList());
            levelIds.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.IBLAvailmentInProgress).ToList()); 

            //TEMPORARY CODE LINES TO HOLD PREVIOUS TRANSACTION BEFORE DELETE
            List<int> clpdOperationIds = new List<int>();
            clpdOperationIds.Add((int)OperationsEnum.TermLoanBooking);
            clpdOperationIds.Add((int)OperationsEnum.RevolvingLoanBooking);
            clpdOperationIds.Add((int)OperationsEnum.ForeignExchangeLoanBooking);
            clpdOperationIds.Add((int)OperationsEnum.CommercialLoanBooking);
            clpdOperationIds.Add((int)OperationsEnum.IBLAvailmentInProgress);
            //END OF TEMPORARY CODE LINES TO HOLD PREVIOUS TRANSACTION BEFORE DELETE

            var company = context.TBL_COMPANY.Find(companyId);
            IEnumerable<CamProcessedLoanViewModel> bookingRequestLoans = null;

            bookingRequestLoans = (from s in context.TBL_LOAN_BOOKING_REQUEST
                                   join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                   join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                   join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                   join cust in context.TBL_CUSTOMER on s.CUSTOMERID equals cust.CUSTOMERID
                                   join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                   join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                   where m.COMPANYID == companyId
                                   where m.COMPANYID == companyId
                                   //************************
                                   && (((atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending)
                                            && s.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                                            && s.ISUSED == false
                                            && s.DELETED == false
                                   && clpdOperationIds.Contains(atrail.OPERATIONID)
                                   && atrail.RESPONSESTAFFID == null && (s.CRMSVALIDATED == false || s.CRMSVALIDATED == null))
                                   //************************

                                   || ((atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Finishing)
                                       && s.ISUSED == false
                                       && s.DELETED == false
                                       && ((levelIds.Contains((int)atrail.TOAPPROVALLEVELID)))
                                       && (staffs.Contains(atrail.TOSTAFFID ?? 0) || atrail.TOSTAFFID == null)
                                       && operationIds.Contains(atrail.OPERATIONID)))
                                   && atrail.RESPONSESTAFFID == null //&& (s.CRMSVALIDATED == false || s.CRMSVALIDATED == null)
                                   orderby s.LOAN_BOOKING_REQUESTID descending
                                   select new CamProcessedLoanViewModel()
                                   {
                                       bookingAmountRequested = s.AMOUNT_REQUESTED,
                                       loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                       bookingRequestStatusId = s.APPROVALSTATUSID,
                                       requestDate = s.DATETIMECREATED,
                                       requestedBy = "",
                                       requestedAmount = s.AMOUNT_REQUESTED,
                                       requestOperationId = (short)s.OPERATIONID,
                                       approvalStatusId = atrail.APPROVALSTATUSID,
                                       approvalStatusName = atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                       loanApplicationId = m.LOANAPPLICATIONID,
                                       loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                       applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                       applicationStatusId = m.APPLICATIONSTATUSID,
                                       customerId = d.CUSTOMERID,
                                       customerCode = cust.CUSTOMERCODE,
                                       customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                       customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                       customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                       customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                       customerType = cust.TBL_CUSTOMER_TYPE.NAME,
                                       systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                       applicationTenor = m.APPLICATIONTENOR,
                                       effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                       expiryDate = (DateTime)d.EXPIRYDATE,
                                       currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                       currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                                       exchangeRate = d.EXCHANGERATE,
                                       loanTypeId = m.LOANAPPLICATIONTYPEID,
                                       //loanTypeName = m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productId = d.APPROVEDPRODUCTID,
                                       productTypeId = p.PRODUCTTYPEID,
                                       productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                       productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                       productName = d.TBL_PRODUCT.PRODUCTNAME,
                                       casaAccountId = s.CASAACCOUNTID,
                                       casaAccountId2 = s.CASAACCOUNTID2,
                                       interestRate = d.APPROVEDINTERESTRATE,
                                       approvedInterestRate = d.APPROVEDINTERESTRATE,
                                       approvedAmount = d.APPROVEDAMOUNT,
                                       groupApprovedAmount = m.APPROVEDAMOUNT,
                                       availmentDate = m.AVAILMENTDATE,
                                       approvedTenor = d.APPROVEDTENOR,
                                       toStaffId = atrail.TOSTAFFID,
                                       requestStaffId = atrail.REQUESTSTAFFID,
                                       // isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                   }).ToList();

            return bookingRequestLoans; // allLoans;

        }


        public IEnumerable<LookupViewModel> GetFullAndFinalStatus()
        {
            return (from k in context.TBL_LOAN_FULLANDFINAL_STATUS
                    where k.FULLANDFINALSTATUSID == (short)FullAndFinalStatusEnum.Cancelled || k.FULLANDFINALSTATUSID == (short)FullAndFinalStatusEnum.Completed
                    select (
                         new LookupViewModel
                         {
                             lookupId = k.FULLANDFINALSTATUSID,
                             lookupName = k.FULLANDFINALSTATUSID == (short)FullAndFinalStatusEnum.Cancelled ? "Cancelled" : k.FULLANDFINALSTATUSID == (short)FullAndFinalStatusEnum.Completed ? "Completed" : null
                         }));
        }


        public IEnumerable<CamProcessedLoanViewModel> GetAvailedLoanApplicationsReadyForBooking(int companyId, int staffId)
        {
            var staff = context.TBL_STAFF.Find(staffId);
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();
            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);

            var termLoanOperationStaffRoleLevelIds = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.TermLoanBooking).ToList();
            var cpOperationStaffRoleLevelIds = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.CommercialLoanBooking).ToList();
            var fxRevolvingOperationStaffRoleLevelIds = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.ForeignExchangeLoanBooking).ToList();
            var overdraftOperationStaffRoleLevelIds = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.RevolvingLoanBooking).ToList();

            var cpldStaffRoleLevelIds = termLoanOperationStaffRoleLevelIds
                                        .Union(cpOperationStaffRoleLevelIds)
                                        .Union(fxRevolvingOperationStaffRoleLevelIds)
                                        .Union(overdraftOperationStaffRoleLevelIds).Distinct();

            //var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            var canReRouteBooking = activities.Contains("booking routing");

            List<int> operationIds = new List<int>();
            if (cpldStaffRoleLevelIds.Any())
            {
                operationIds.Add((int)OperationsEnum.TermLoanBooking);
                operationIds.Add((int)OperationsEnum.RevolvingLoanBooking);
                operationIds.Add((int)OperationsEnum.ForeignExchangeLoanBooking);
                operationIds.Add((int)OperationsEnum.CommercialLoanBooking);
                operationIds.Add((int)OperationsEnum.IBLAvailmentInProgress);
            }

            var bAndGStaffRoleLevelIds = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.ContigentLoanBooking).ToList();


            if ((!cpldStaffRoleLevelIds.Any() && bAndGStaffRoleLevelIds.Any()))
            {
                operationIds.Add((int)OperationsEnum.ContigentLoanBooking);
            }

            var company = context.TBL_COMPANY.Find(companyId);
            IEnumerable<CamProcessedLoanViewModel> allLoans = null;
            IEnumerable<CamProcessedLoanViewModel> bookingRequestLoans = null;
            //IEnumerable<CamProcessedLoanViewModel> referredBackLoans = null;

            bookingRequestLoans = (from s in context.TBL_LOAN_BOOKING_REQUEST
                                   join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                   join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                   join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                   join cust in context.TBL_CUSTOMER on s.CUSTOMERID equals cust.CUSTOMERID
                                   join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                   join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                   where m.COMPANYID == companyId
                                   && (((atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending) && s.ISUSED == false) || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Referred && s.ISUSED == true))
                                   && s.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && s.DELETED == false
                                   && ((cpldStaffRoleLevelIds.Contains((int)atrail.TOAPPROVALLEVELID)) || (bAndGStaffRoleLevelIds.Contains((int)atrail.TOAPPROVALLEVELID)) || (atrail.REQUESTSTAFFID == staffId))
                                   && operationIds.Contains(atrail.OPERATIONID)
                                   && atrail.RESPONSESTAFFID == null
                                   //&& s.CRMSVALIDATED == true

                                   orderby atrail.SYSTEMARRIVALDATETIME descending
                                   select new CamProcessedLoanViewModel()
                                   {
                                       bookingAmountRequested = s.AMOUNT_REQUESTED,
                                       loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                       bookingRequestStatusId = s.APPROVALSTATUSID,
                                       isLineFacility = d.ISLINEFACILITY,
                                       isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                       isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                       requestDate = s.DATETIMECREATED,
                                       requestedBy = "",
                                       systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                       operationId = s.OPERATIONID,
                                       appraisalOperationId = m.OPERATIONID,
                                       crmsCode = s.CRMSCODE,
                                       requestedAmount = s.AMOUNT_REQUESTED,
                                       requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                       approvalStatusId = atrail.APPROVALSTATUSID,
                                       approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                       loanApplicationId = m.LOANAPPLICATIONID,

                                       loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                       applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                       applicationStatusId = m.APPLICATIONSTATUSID,
                                       divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                       customerId = d.CUSTOMERID,
                                       customerCode = cust.CUSTOMERCODE,
                                       customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                       customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                       customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                       customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                       customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                       applicationTenor = m.APPLICATIONTENOR,
                                       effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                       expiryDate = (DateTime)d.EXPIRYDATE,
                                       currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                       currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                       exchangeRate = d.EXCHANGERATE,
                                       loanTypeId = m.LOANAPPLICATIONTYPEID,
                                       loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productId = s.PRODUCTID,
                                       productTypeId = p.PRODUCTTYPEID,
                                       productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                       productTypeName = pt.PRODUCTTYPENAME,
                                       productName = p.PRODUCTNAME,
                                       casaAccountId = s.CASAACCOUNTID,
                                       casaAccountId2 = s.CASAACCOUNTID2,
                                       productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                       divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                       interestRate = d.APPROVEDINTERESTRATE,
                                       approvedInterestRate = d.APPROVEDINTERESTRATE,
                                       approvedAmount = d.APPROVEDAMOUNT,
                                       groupApprovedAmount = m.APPROVEDAMOUNT,
                                       availmentDate = m.AVAILMENTDATE,
                                       approvedTenor = d.APPROVEDTENOR,
                                       toStaffId = atrail.TOSTAFFID,
                                       requestStaffId = atrail.REQUESTSTAFFID,
                                       isInEditMode = s.ISUSED ?? false,
                                       isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                       canReRouteBooking = canReRouteBooking,
                                       approvalTrailId = atrail.APPROVALTRAILID,
                                       responseStaffId = atrail.RESPONSESTAFFID
                                   }).ToList().Take(60);

            //referredBackLoans = (from s in context.TBL_LOAN_BOOKING_REQUEST
            //                     join l in context.TBL_LOAN on s.LOAN_BOOKING_REQUESTID equals l.LOAN_BOOKING_REQUESTID
            //                     join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
            //                     join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
            //                     join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
            //                     join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
            //                     join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
            //                     join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
            //                     where m.COMPANYID == companyId
            //                     && atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Referred
            //                     && s.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && s.ISUSED == false && s.DELETED == false
            //                     && ((cpldStaffRoleLevelIds.Contains((int)atrail.TOAPPROVALLEVELID)) || (bAndGStaffRoleLevelIds.Contains((int)atrail.TOAPPROVALLEVELID)))
            //                     && operationIds.Contains(atrail.OPERATIONID) && atrail.RESPONSESTAFFID == null
            //                     && d.CRMSVALIDATED == true
            //                     orderby s.LOAN_BOOKING_REQUESTID descending
            //                     select new CamProcessedLoanViewModel()
            //                     {
            //                         bookingAmountRequested = s.AMOUNT_REQUESTED,
            //                         loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
            //                         bookingRequestStatusId = s.APPROVALSTATUSID,
            //                         requestDate = s.DATETIMECREATED,
            //                         requestedBy = "",
            //                         requestedAmount = s.AMOUNT_REQUESTED,
            //                         requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
            //                         approvalStatusId = atrail.APPROVALSTATUSID,
            //                         approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == atrail.APPROVALSTATUSID) select y).FirstOrDefault().APPROVALSTATUSNAME, //atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
            //                         loanApplicationId = m.LOANAPPLICATIONID,
            //                         loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
            //                         applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
            //                         applicationStatusId = m.APPLICATIONSTATUSID,

            //                         customerId = d.CUSTOMERID,
            //                         customerCode = cust.CUSTOMERCODE,
            //                         customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
            //                         customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
            //                         customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
            //                         customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
            //                         customerType = cust.TBL_CUSTOMER_TYPE.NAME,

            //                         applicationTenor = m.APPLICATIONTENOR,
            //                         effectiveDate = (DateTime)d.EFFECTIVEDATE,
            //                         expiryDate = (DateTime)d.EXPIRYDATE,

            //                         currencyId = d.CURRENCYID,
            //                         currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
            //                         exchangeRate = d.EXCHANGERATE,
            //                         loanTypeId = m.LOANAPPLICATIONTYPEID,
            //                         loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME,
            //                         productId = s.PRODUCTID,
            //                         productTypeId = p.PRODUCTTYPEID,
            //                         productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
            //                         productTypeName = pt.PRODUCTTYPENAME,
            //                         productName = p.PRODUCTNAME,

            //                         interestRate = d.APPROVEDINTERESTRATE,
            //                         approvedInterestRate = d.APPROVEDINTERESTRATE,
            //                         approvedAmount = d.APPROVEDAMOUNT,
            //                         groupApprovedAmount = m.APPROVEDAMOUNT,
            //                         availmentDate = m.AVAILMENTDATE,
            //                         approvedTenor = d.APPROVEDTENOR,
            //                         toStaffId = atrail.TOSTAFFID,
            //                         requestStaffId = atrail.REQUESTSTAFFID,
            //                         isInEditMode = true,
            //                         isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
            //                         canReRouteBooking = canReRouteBooking,
            //                         approvalTrailId = atrail.APPROVALTRAILID,
            //                         responseStaffId = atrail.RESPONSESTAFFID
            //                     }).ToList();

            //IEnumerable<CamProcessedLoanViewModel> lcyAndFcyLoans = bookingRequestLoans.Union(referredBackLoans);
            IEnumerable<CamProcessedLoanViewModel> lcyAndFcyLoans = bookingRequestLoans;

            List<CamProcessedLoanViewModel> lcyLoans = new List<CamProcessedLoanViewModel>();
            List<CamProcessedLoanViewModel> fcyLoans = new List<CamProcessedLoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = lcyAndFcyLoans.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
            }

            if (isFCYUser == true)
            {
                fcyLoans = lcyAndFcyLoans.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            allLoans = lcyLoans.Union(fcyLoans);

            foreach (var item in allLoans)
            {
                var loanRecord = context.TBL_LOAN.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId);
                item.isBooked = loanRecord.Any();

                int operationId = 0;
                if (item.productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                    operationId = (short)OperationsEnum.ContigentLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
                    operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
                    operationId = (short)OperationsEnum.CommercialLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.TermLoan || item.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating || item.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                    operationId = (short)OperationsEnum.TermLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                    operationId = (short)OperationsEnum.RevolvingLoanBooking;

                item.operationId = operationId;


                if (item.productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                {
                    operationId = (short)OperationsEnum.ContigentLoanBooking;
                    if (item.isInEditMode)
                    {
                        var contingentRecord = context.TBL_LOAN_CONTINGENT.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId);
                        item.loanId = contingentRecord.FirstOrDefault()?.CONTINGENTLOANID;
                    }
                }

                if (item.productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                {
                    operationId = (short)OperationsEnum.RevolvingLoanBooking;
                    if (item.isInEditMode)
                    {
                        var revolvingRecord = context.TBL_LOAN_REVOLVING.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId);
                        item.loanId = revolvingRecord.FirstOrDefault()?.REVOLVINGLOANID;
                    }
                }

                if (item.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
                {
                    operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
                    item.loanId = loanRecord.FirstOrDefault()?.TERMLOANID;
                }

                if (item.productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
                {
                    operationId = (short)OperationsEnum.CommercialLoanBooking;
                    item.loanId = loanRecord.FirstOrDefault()?.TERMLOANID;
                }

                if (item.productTypeId == (short)LoanProductTypeEnum.TermLoan || item.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating || item.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                {
                    operationId = (short)OperationsEnum.TermLoanBooking;
                    item.loanId = loanRecord.FirstOrDefault()?.TERMLOANID;
                }

                var trailInfo = context.TBL_APPROVAL_TRAIL.Where(x => x.OPERATIONID == operationId && x.TARGETID == item.loanBookingRequestId);
                if (trailInfo.Any())
                {
                    item.isUnderApproval = true;
                    foreach (var trail in trailInfo)
                    {
                        if (trail.RESPONSESTAFFID == null)
                        {
                            var routedStaffRecord = context.TBL_STAFF.Where(x => x.STAFFID == trail.TOSTAFFID).FirstOrDefault();
                            if (routedStaffRecord != null) item.routedToStaff = routedStaffRecord.FIRSTNAME + " " + routedStaffRecord.LASTNAME;
                        }

                    }
                }

                var loans = context.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var overdrafts = context.TBL_LOAN_REVOLVING.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var contingents = context.TBL_LOAN_CONTINGENT.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                switch (item.productTypeId)
                {
                    case (short)LoanProductTypeEnum.TermLoan:
                        decimal customerAvailableAmount = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount;
                        break;
                    case (short)LoanProductTypeEnum.CommercialLoan:
                        decimal customerAvailableAmount2 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount2 = customerAvailableAmount2 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount2;
                        break;
                    case (short)LoanProductTypeEnum.SelfLiquidating:
                        decimal customerAvailableAmount3 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount3 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount3;
                        break;
                    case (short)LoanProductTypeEnum.RevolvingLoan:
                        decimal overdraftBal = 0;
                        foreach (var overdraft in overdrafts)
                        {
                            if (overdraft.OVERDRAFTLIMIT > 0) overdraftBal = overdraftBal + overdraft.OVERDRAFTLIMIT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - overdraftBal;
                        break;
                    case (short)LoanProductTypeEnum.ContingentLiability:
                        decimal contingentBal = 0;
                        foreach (var contingent in contingents)
                        {
                            if (contingent.CONTINGENTAMOUNT > 0) contingentBal = contingentBal + contingent.CONTINGENTAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - contingentBal;
                        break;
                    case (short)LoanProductTypeEnum.ForeignXRevolving:
                        decimal customerAvailableAmount4 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount4 = customerAvailableAmount4 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount4;
                        break;
                    case (short)LoanProductTypeEnum.SyndicatedTermLoan:
                        decimal customerAvailableAmount5 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount5 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount5;
                        break;
                }

                if (item.productTypeId == (short)LoanProductTypeEnum.TermLoan
                    || item.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating
                    || item.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving
                    || item.productTypeId == (short)LoanProductTypeEnum.CommercialLoan
                    || item.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                {
                    var priceIndex = context.TBL_PRODUCT_PRICE_INDEX.Find(item.productPriceIndexId);
                    var interestRate = Convert.ToDouble(item.interestRate);
                    if (priceIndex != null)
                    {
                        item.interestRate = priceIndex.PRICEINDEXRATE + interestRate;
                        item.productPriceIndex = priceIndex.PRICEINDEXNAME;
                        item.productPriceDescription = priceIndex.PRICEINDEXDESCRIPTION;
                    }
                }

                var disbursedLoan = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId && x.ISDISBURSED == true);
                if (disbursedLoan.Any())
                {
                    item.amountDisbursed = disbursedLoan.Sum(c => c.PRINCIPALAMOUNT);
                }
            }
            allLoans = (from a in allLoans where ((a.customerAvailableAmount >= 0)) select a).ToList();
            return allLoans.OrderByDescending(c => c.systemArrivalDateTime);


        }

        public IEnumerable<CamProcessedLoanViewModel> getLoanFacilitiesAwaitingApprovalByParam(int companyId, int staffId, string searchString)
        {
            var staff = context.TBL_STAFF.Find(staffId);
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();
            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);

            var termLoanOperationStaffRoleLevelIds = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.TermLoanBooking).ToList();
            var cpOperationStaffRoleLevelIds = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.CommercialLoanBooking).ToList();
            var fxRevolvingOperationStaffRoleLevelIds = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.ForeignExchangeLoanBooking).ToList();
            var overdraftOperationStaffRoleLevelIds = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.RevolvingLoanBooking).ToList();

            var cpldStaffRoleLevelIds = termLoanOperationStaffRoleLevelIds
                                        .Union(cpOperationStaffRoleLevelIds)
                                        .Union(fxRevolvingOperationStaffRoleLevelIds)
                                        .Union(overdraftOperationStaffRoleLevelIds).Distinct().ToList();

            //var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            var canReRouteBooking = activities.Contains("booking routing");

            List<int> operationIds = new List<int>();
            if (cpldStaffRoleLevelIds.Any())
            {
                operationIds.Add((int)OperationsEnum.TermLoanBooking);
                operationIds.Add((int)OperationsEnum.RevolvingLoanBooking);
                operationIds.Add((int)OperationsEnum.ForeignExchangeLoanBooking);
                operationIds.Add((int)OperationsEnum.CommercialLoanBooking);
            }

            var bAndGStaffRoleLevelIds = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.ContigentLoanBooking).ToList();


            if ((!cpldStaffRoleLevelIds.Any() && bAndGStaffRoleLevelIds.Any()))
            {
                operationIds.Add((int)OperationsEnum.ContigentLoanBooking);
            }
            var company = context.TBL_COMPANY.Find(companyId);
            IEnumerable<CamProcessedLoanViewModel> allLoans = null;
            IEnumerable<CamProcessedLoanViewModel> bookingRequestLoans = null;

            bookingRequestLoans = (from s in context.TBL_LOAN_BOOKING_REQUEST
                                   join atrail in context.TBL_APPROVAL_TRAIL on s.LOAN_BOOKING_REQUESTID equals atrail.TARGETID
                                   join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                                   join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                                   join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                                   join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                                   join pt in context.TBL_PRODUCT_TYPE on p.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                                   where m.APPLICATIONREFERENCENUMBER == searchString
                                   && m.COMPANYID == companyId
                                   && (((atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending) && s.ISUSED == false) || (atrail.APPROVALSTATUSID == (short)ApprovalStatusEnum.Referred && s.ISUSED == true))
                                   && s.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved && s.DELETED == false
                                   && ((cpldStaffRoleLevelIds.Contains((int)atrail.TOAPPROVALLEVELID)) || (bAndGStaffRoleLevelIds.Contains((int)atrail.TOAPPROVALLEVELID)) || (atrail.REQUESTSTAFFID == staffId))
                                   && operationIds.Contains(atrail.OPERATIONID)
                                   && atrail.RESPONSESTAFFID == null
                                   && s.CRMSVALIDATED == true

                                   orderby atrail.SYSTEMARRIVALDATETIME descending
                                   select new CamProcessedLoanViewModel()
                                   {
                                       bookingAmountRequested = s.AMOUNT_REQUESTED,
                                       loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                                       bookingRequestStatusId = s.APPROVALSTATUSID,
                                       isLineFacility = d.ISLINEFACILITY,
                                       isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                                       isLineMaintained = m.APPROVEDLINESTATUSID != null,
                                       requestDate = s.DATETIMECREATED,
                                       requestedBy = "",
                                       systemArrivalDateTime = atrail.SYSTEMARRIVALDATETIME,
                                       operationId = s.OPERATIONID,
                                       appraisalOperationId = m.OPERATIONID,
                                       crmsCode = s.CRMSCODE,
                                       requestedAmount = s.AMOUNT_REQUESTED,
                                       requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                                       approvalStatusId = atrail.APPROVALSTATUSID,
                                       approvalStatusName = (from y in context.TBL_APPROVAL_STATUS.Where(i => i.APPROVALSTATUSID == m.APPROVALSTATUSID) select y.APPROVALSTATUSNAME).FirstOrDefault(),//atrail.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME,
                                       loanApplicationId = m.LOANAPPLICATIONID,

                                       loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                       applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                       applicationStatusId = m.APPLICATIONSTATUSID,
                                       divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == cust.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                       customerId = d.CUSTOMERID,
                                       customerCode = cust.CUSTOMERCODE,
                                       customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                                       customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                       customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                       customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                       customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                                       applicationTenor = m.APPLICATIONTENOR,
                                       effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                       expiryDate = (DateTime)d.EXPIRYDATE,
                                       currencyId = d.CURRENCYID, //d.TBL_CURRENCY.CURRENCYID,
                                       currencyCode = (from y in context.TBL_CURRENCY.Where(i => i.CURRENCYID == d.CURRENCYID) select y.CURRENCYCODE).FirstOrDefault(), //d.TBL_CURRENCY.CURRENCYCODE,
                                       exchangeRate = d.EXCHANGERATE,
                                       loanTypeId = m.LOANAPPLICATIONTYPEID,
                                       loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME, // m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productId = s.PRODUCTID,
                                       productTypeId = p.PRODUCTTYPEID,
                                       productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                                       productTypeName = pt.PRODUCTTYPENAME,
                                       productName = p.PRODUCTNAME,
                                       casaAccountId = s.CASAACCOUNTID,
                                       casaAccountId2 = s.CASAACCOUNTID2,
                                       productClassName = p.TBL_PRODUCT_CLASS.PRODUCTCLASSNAME,
                                       divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == d.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                       interestRate = d.APPROVEDINTERESTRATE,
                                       approvedInterestRate = d.APPROVEDINTERESTRATE,
                                       approvedAmount = d.APPROVEDAMOUNT,
                                       groupApprovedAmount = m.APPROVEDAMOUNT,
                                       availmentDate = m.AVAILMENTDATE,
                                       approvedTenor = d.APPROVEDTENOR,
                                       toStaffId = atrail.TOSTAFFID,
                                       requestStaffId = atrail.REQUESTSTAFFID,
                                       isInEditMode = s.ISUSED ?? false,
                                       isLocalCurrency = defaultCurrencyId == d.CURRENCYID ? true : false,
                                       canReRouteBooking = canReRouteBooking,
                                       approvalTrailId = atrail.APPROVALTRAILID,
                                       responseStaffId = atrail.RESPONSESTAFFID
                                   }).ToList().Take(60);

            IEnumerable<CamProcessedLoanViewModel> lcyAndFcyLoans = bookingRequestLoans;

            List<CamProcessedLoanViewModel> lcyLoans = new List<CamProcessedLoanViewModel>();
            List<CamProcessedLoanViewModel> fcyLoans = new List<CamProcessedLoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = lcyAndFcyLoans.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
            }

            if (isFCYUser == true)
            {
                fcyLoans = lcyAndFcyLoans.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            allLoans = lcyLoans.Union(fcyLoans);

            foreach (var item in allLoans)
            {
                var loanRecord = context.TBL_LOAN.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId);
                item.isBooked = loanRecord.Any();

                int operationId = 0;
                if (item.productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                    operationId = (short)OperationsEnum.ContigentLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
                    operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
                    operationId = (short)OperationsEnum.CommercialLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.TermLoan || item.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating || item.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                    operationId = (short)OperationsEnum.TermLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                    operationId = (short)OperationsEnum.RevolvingLoanBooking;

                item.operationId = operationId;


                if (item.productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                {
                    operationId = (short)OperationsEnum.ContigentLoanBooking;
                    if (item.isInEditMode)
                    {
                        var contingentRecord = context.TBL_LOAN_CONTINGENT.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId);
                        item.loanId = contingentRecord.FirstOrDefault()?.CONTINGENTLOANID;
                    }
                }

                if (item.productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                {
                    operationId = (short)OperationsEnum.RevolvingLoanBooking;
                    if (item.isInEditMode)
                    {
                        var revolvingRecord = context.TBL_LOAN_REVOLVING.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId);
                        item.loanId = revolvingRecord.FirstOrDefault()?.REVOLVINGLOANID;
                    }
                }

                if (item.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
                {
                    operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
                    item.loanId = loanRecord.FirstOrDefault()?.TERMLOANID;
                }

                if (item.productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
                {
                    operationId = (short)OperationsEnum.CommercialLoanBooking;
                    item.loanId = loanRecord.FirstOrDefault()?.TERMLOANID;
                }

                if (item.productTypeId == (short)LoanProductTypeEnum.TermLoan || item.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating || item.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                {
                    operationId = (short)OperationsEnum.TermLoanBooking;
                    item.loanId = loanRecord.FirstOrDefault()?.TERMLOANID;
                }

                var trailInfo = context.TBL_APPROVAL_TRAIL.Where(x => x.OPERATIONID == operationId && x.TARGETID == item.loanBookingRequestId);
                if (trailInfo.Any())
                {
                    item.isUnderApproval = true;
                    foreach (var trail in trailInfo)
                    {
                        if (trail.RESPONSESTAFFID == null)
                        {
                            var routedStaffRecord = context.TBL_STAFF.Where(x => x.STAFFID == trail.TOSTAFFID).FirstOrDefault();
                            if (routedStaffRecord != null) item.routedToStaff = routedStaffRecord.FIRSTNAME + " " + routedStaffRecord.LASTNAME;
                        }

                    }
                }

                var loans = context.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var overdrafts = context.TBL_LOAN_REVOLVING.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var contingents = context.TBL_LOAN_CONTINGENT.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                switch (item.productTypeId)
                {
                    case (short)LoanProductTypeEnum.TermLoan:
                        decimal customerAvailableAmount = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount;
                        break;
                    case (short)LoanProductTypeEnum.CommercialLoan:
                        decimal customerAvailableAmount2 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount2 = customerAvailableAmount2 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount2;
                        break;
                    case (short)LoanProductTypeEnum.SelfLiquidating:
                        decimal customerAvailableAmount3 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount3 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount3;
                        break;
                    case (short)LoanProductTypeEnum.RevolvingLoan:
                        decimal overdraftBal = 0;
                        foreach (var overdraft in overdrafts)
                        {
                            if (overdraft.OVERDRAFTLIMIT > 0) overdraftBal = overdraftBal + overdraft.OVERDRAFTLIMIT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - overdraftBal;
                        break;
                    case (short)LoanProductTypeEnum.ContingentLiability:
                        decimal contingentBal = 0;
                        foreach (var contingent in contingents)
                        {
                            if (contingent.CONTINGENTAMOUNT > 0) contingentBal = contingentBal + contingent.CONTINGENTAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - contingentBal;
                        break;
                    case (short)LoanProductTypeEnum.ForeignXRevolving:
                        decimal customerAvailableAmount4 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount4 = customerAvailableAmount4 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount4;
                        break;
                    case (short)LoanProductTypeEnum.SyndicatedTermLoan:
                        decimal customerAvailableAmount5 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount5 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount5;
                        break;
                }

                if (item.productTypeId == (short)LoanProductTypeEnum.TermLoan
                    || item.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating
                    || item.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving
                    || item.productTypeId == (short)LoanProductTypeEnum.CommercialLoan
                    || item.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                {
                    var priceIndex = context.TBL_PRODUCT_PRICE_INDEX.Find(item.productPriceIndexId);
                    var interestRate = Convert.ToDouble(item.interestRate);
                    if (priceIndex != null)
                    {
                        item.interestRate = priceIndex.PRICEINDEXRATE + interestRate;
                        item.productPriceIndex = priceIndex.PRICEINDEXNAME;
                        item.productPriceDescription = priceIndex.PRICEINDEXDESCRIPTION;
                    }
                }

                var disbursedLoan = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId && x.ISDISBURSED == true);
                if (disbursedLoan.Any())
                {
                    item.amountDisbursed = disbursedLoan.Sum(c => c.PRINCIPALAMOUNT);
                }
            }
            allLoans = (from a in allLoans where ((a.customerAvailableAmount >= 0)) select a).ToList();
            return allLoans;


        }

        private IEnumerable<CamProcessedLoanViewModel> AvailedLoanApplicationsReadyForBookingByApplicationDetailId(int staffId, int companyId, int applicationDetailId, int loanBookingRequestId)
        {
            var company = context.TBL_COMPANY.Find(companyId);
            var canReRouteBooking = context.TBL_PROFILE_ADDITIONALACTIVITY.Where(x => x.USERID == staffId && x.ACTIVITYID == 177).Any();
            var newApplicationDate = generalSetup.GetApplicationDate();
            var data = (from s in context.TBL_LOAN_BOOKING_REQUEST
                        join d in context.TBL_LOAN_APPLICATION_DETAIL on s.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                        join p in context.TBL_PRODUCT on s.PRODUCTID equals p.PRODUCTID
                        join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                        where d.LOANAPPLICATIONDETAILID == applicationDetailId && d.DELETED == false && s.DELETED == false
                        && s.LOAN_BOOKING_REQUESTID == loanBookingRequestId && m.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved

                        orderby s.LOAN_BOOKING_REQUESTID descending
                        select new CamProcessedLoanViewModel
                        {
                            isLineFacility = d.ISLINEFACILITY,
                            isLineMaintained = d.APPROVEDLINESTATUSID != null,
                            bookingAmountRequested = s.AMOUNT_REQUESTED,
                            loanBookingRequestId = s.LOAN_BOOKING_REQUESTID,
                            bookingRequestStatusId = s.APPROVALSTATUSID,
                            requestDate = s.DATETIMECREATED,
                            requestedBy = "",
                            appraisalOperationId = m.OPERATIONID,
                            requestedAmount = s.AMOUNT_REQUESTED,
                            //requestOperationId = (short)OperationsEnum.CorporateDrawdownRequest,
                            requestOperationId = (short)(s.OPERATIONID ?? 0),
                            approvalStatusId = (short)m.APPROVALSTATUSID,
                            loanApplicationId = m.LOANAPPLICATIONID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            isLineFacilityString = d.ISLINEFACILITY.HasValue ? d.ISLINEFACILITY.Value ? "Yes" : "No" : "No",
                            applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                            applicationStatusId = m.APPLICATIONSTATUSID,
                            casaAccountId = s.CASAACCOUNTID,
                            casaAccountId2 = s.CASAACCOUNTID2,
                            feeAccountName = (from t in context.TBL_CASA where t.CASAACCOUNTID == s.CASAACCOUNTID select t.PRODUCTACCOUNTNAME + "(" + t.PRODUCTACCOUNTNUMBER + ")").FirstOrDefault(),
                            customerId = d.CUSTOMERID,
                            customerCode = cust.CUSTOMERCODE,
                            customerName = cust.FIRSTNAME + " " + cust.MIDDLENAME + " " + cust.LASTNAME,
                            customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                            customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                            customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                            isRelatedParty = m.ISRELATEDPARTY,
                            customerSensitivityLevelId = cust.CUSTOMERSENSITIVITYLEVELID,

                            customerOccupation = cust.OCCUPATION,
                            customerType = cust.TBL_CUSTOMER_TYPE.NAME,

                            isPoliticallyExposed = cust.ISPOLITICALLYEXPOSED,
                            isInvestmentGrade = m.ISINVESTMENTGRADE,
                            newApplicationDate = newApplicationDate,
                            loanInformation = m.LOANINFORMATION,
                            companyId = m.COMPANYID,
                            branchId = m.BRANCHID,
                            branchName = m.TBL_BRANCH.BRANCHNAME,
                            subSectorId = d.SUBSECTORID,
                            subSectorName = d.TBL_SUB_SECTOR.NAME,
                            sectorName = (from y in context.TBL_SECTOR.Where(i => i.SECTORID == d.TBL_SUB_SECTOR.SECTORID) select y).FirstOrDefault().NAME, //d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            applicationTenor = m.APPLICATIONTENOR,
                            effectiveDate = (DateTime)d.EFFECTIVEDATE,
                            expiryDate = (DateTime)d.EXPIRYDATE,
                            canReRouteBooking = canReRouteBooking,
                            //isTemporaryOverdraft = p.TBL_PRODUCT_BEHAVIOUR.FirstOrDefault() != null ? p.TBL_PRODUCT_BEHAVIOUR.FirstOrDefault().ISTEMPORARYOVERDRAFT : false,

                            relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                            relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                            //relationshipManagerId = m.RELATIONSHIPMANAGERID,
                            //relationshipManagerName = m.TBL_STAFF1.FIRSTNAME + " " + m.TBL_STAFF1.MIDDLENAME + " " + m.TBL_STAFF1.LASTNAME,
                            relationshipManagerId = m.TBL_STAFF.SUPERVISOR_STAFFID,
                            relationshipManagerName = m.TBL_STAFF.SUPERVISOR_STAFFID != null ? context.TBL_STAFF.Where(O => O.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID).FirstOrDefault().FIRSTNAME + " " + context.TBL_STAFF.Where(O => O.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID).FirstOrDefault().MIDDLENAME + " " + context.TBL_STAFF.Where(O => O.STAFFID == m.TBL_STAFF.SUPERVISOR_STAFFID).FirstOrDefault().LASTNAME : null,


                            currencyId = d.CURRENCYID,
                            currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                            exchangeRate = d.EXCHANGERATE,
                            loanTypeId = m.LOANAPPLICATIONTYPEID,
                            loanTypeName = (from y in context.TBL_LOAN_APPLICATION_TYPE.Where(i => i.LOANAPPLICATIONTYPEID == m.LOANAPPLICATIONTYPEID) select y).FirstOrDefault().LOANAPPLICATIONTYPENAME,
                            camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                            productId = s.PRODUCTID,
                            productTypeId = p.PRODUCTTYPEID,
                            productPriceIndexId = (short)d.PRODUCTPRICEINDEXID,
                            productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            productName = p.PRODUCTNAME,
                            productClassId = p.PRODUCTCLASSID,
                            productClassProcessId = p.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                            productScheduleTypeId = p.SCHEDULETYPEID,
                            productDealTypeId = p.DEALTYPEID,
                            productDayCountConventionId = p.TBL_PRODUCT_CURRENCY.FirstOrDefault() != null ? p.TBL_PRODUCT_CURRENCY.FirstOrDefault().DAYCOUNTCONVENTIONID : 0, // p.DAYCOUNTCONVENTIONID,
                            misCode = m.MISCODE,
                            teamMisCode = m.TEAMMISCODE,

                            interestRate = d.APPROVEDINTERESTRATE,
                            approvedInterestRate = d.APPROVEDINTERESTRATE,
                            submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                            approvedAmount = d.APPROVEDAMOUNT,
                            groupApprovedAmount = m.APPROVEDAMOUNT,
                            availmentDate = m.AVAILMENTDATE,
                            isBidbond = p.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees ? true : false,
                            isOverdraft = p.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan ? true : false,
                            repaymentTerms = d.REPAYMENTTERMS,
                            repaymentSchedule = d.TBL_REPAYMENT_TERM.REPAYMENTTERMDETAIL,
                            approvedTenor = d.APPROVEDTENOR,
                            createdBy = m.OWNEDBY,
                            applicationDate = m.APPLICATIONDATE,
                            dateTimeCreated = d.DATETIMECREATED,
                            loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,
                            isLocalCurrrency = company.CURRENCYID == d.CURRENCYID ? true : false,
                            crmsCode = s.CRMSCODE,
                        }).ToList();


            foreach (var item in data)
            {
                item.isBooked = context.TBL_LOAN.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId).Any();

                int operationId = 0;
                if (item.productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                    operationId = (short)OperationsEnum.ContigentLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
                    operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.CommercialLoan)
                    operationId = (short)OperationsEnum.CommercialLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.TermLoan || item.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating || item.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan)
                    operationId = (short)OperationsEnum.TermLoanBooking;
                if (item.productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                    operationId = (short)OperationsEnum.RevolvingLoanBooking;

                item.operationId = operationId;

                var trailInfo = context.TBL_APPROVAL_TRAIL.Where(x => x.OPERATIONID == operationId && x.TARGETID == item.loanBookingRequestId);
                if (trailInfo.Any())
                {
                    item.isUnderApproval = true;
                    foreach (var trail in trailInfo)
                    {
                        if (trail.RESPONSESTAFFID == null)
                        {
                            var routedStaffRecord = context.TBL_STAFF.Where(x => x.STAFFID == trail.TOSTAFFID).FirstOrDefault();
                            if (routedStaffRecord != null) item.routedToStaff = routedStaffRecord.FIRSTNAME + " " + routedStaffRecord.LASTNAME;
                        }

                    }
                }

                var loans = context.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var overdrafts = context.TBL_LOAN_REVOLVING.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var contingents = context.TBL_LOAN_CONTINGENT.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);


                var productBehaviour = context.TBL_PRODUCT_BEHAVIOUR.Where(x => x.PRODUCTID == item.productId).FirstOrDefault();
                if (productBehaviour != null)
                    item.isTemporaryOverdraft = productBehaviour.ISTEMPORARYOVERDRAFT;

                switch (item.productTypeId)
                {
                    case (short)LoanProductTypeEnum.TermLoan:
                        decimal customerAvailableAmount = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount;
                        break;
                    case (short)LoanProductTypeEnum.CommercialLoan:
                        decimal customerAvailableAmount2 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount2 = customerAvailableAmount2 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount2;
                        break;
                    case (short)LoanProductTypeEnum.SelfLiquidating:
                        decimal customerAvailableAmount3 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount3 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount3;
                        break;
                    case (short)LoanProductTypeEnum.RevolvingLoan:
                        decimal overdraftBal = 0;
                        foreach (var overdraft in overdrafts)
                        {
                            if (overdraft.OVERDRAFTLIMIT > 0) overdraftBal = overdraftBal + overdraft.OVERDRAFTLIMIT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - overdraftBal;
                        break;
                    case (short)LoanProductTypeEnum.ContingentLiability:
                        decimal contingentBal = 0;
                        foreach (var contingent in contingents)
                        {
                            if (contingent.CONTINGENTAMOUNT > 0) contingentBal = contingentBal + contingent.CONTINGENTAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - contingentBal;
                        break;
                }

                if (item.operationId == (short)OperationsEnum.TermLoanBooking || item.operationId == (short)OperationsEnum.CommercialLoanBooking || item.operationId == (short)OperationsEnum.ForeignExchangeLoanBooking)
                {
                    var priceIndex = context.TBL_PRODUCT_PRICE_INDEX.Find(item.productPriceIndexId);
                    var interestRate = Convert.ToDouble(item.approvedInterestRate);
                    if (priceIndex != null)
                    {
                        item.interestRate = priceIndex.PRICEINDEXRATE + interestRate;
                        item.productPriceIndex = priceIndex.PRICEINDEXNAME;
                        item.productPriceDescription = priceIndex.PRICEINDEXDESCRIPTION;
                    }
                }
            }
            return data.ToList();
        }



        public LoanViewModel GetReferedBookingFacilityRecordsById(CamProcessedLoanViewModel model)
        {
            var loanId = model.loanId ?? 0;
            LoanViewModel data = new LoanViewModel();
            if (model.productTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                data = GetContingentByLoanId(loanId);

            if (model.productTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                data = GetOverdraftDetailsByLoanId(loanId);

            if (model.productTypeId == (short)LoanProductTypeEnum.TermLoan
                || model.productTypeId == (short)LoanProductTypeEnum.SelfLiquidating
                || model.productTypeId == (short)LoanProductTypeEnum.SyndicatedTermLoan
                || model.productTypeId == (short)LoanProductTypeEnum.CommercialLoan
                || model.productTypeId == (short)LoanProductTypeEnum.ForeignXRevolving)
            { data = GetLoan(loanId); }

            return data;
        }

        public IQueryable<LoanViewModel> SearchForFullAndFinalLoan(string searchQuery)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            try
            {
                IQueryable<LoanViewModel> allFilteredLoan = null;
                if (!string.IsNullOrWhiteSpace(searchQuery))
                {
                    searchQuery = searchQuery.ToLower();
                }
                if (!string.IsNullOrWhiteSpace(searchQuery.Trim()))
                {
                    var loans = (from a in context.TBL_LOAN
                                 join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                 join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                 where a.FULLANDFINALSTATUSID == (int)FullAndFinalStatusEnum.OnGoing && a.LOANSTATUSID == (int)LoanStatusEnum.Active
                                 select new LoanViewModel
                                 {
                                     loanId = a.TERMLOANID,
                                     customerId = a.CUSTOMERID,
                                     customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                     firstName = b.FIRSTNAME,
                                     lastName = b.LASTNAME,
                                     customerCode = b.CUSTOMERCODE,
                                     productAccountName = c.PRODUCTACCOUNTNAME,
                                     loanReferenceNumber = a.LOANREFERENCENUMBER,
                                     principalAmount = a.PRINCIPALAMOUNT,
                                     loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                     loanApplicationId = a.LOANAPPLICATIONDETAILID,
                                     productId = a.PRODUCTID,
                                     companyId = a.COMPANYID,
                                     casaAccountId = a.CASAACCOUNTID,
                                     customerType = b.TBL_CUSTOMER_TYPE.NAME,
                                     branchId = a.BRANCHID,

                                     branchName = context.TBL_BRANCH.Where(o => o.BRANCHID == a.BRANCHID).Select(o => o.BRANCHNAME).FirstOrDefault(),
                                     // applicationReferenceNumber = e.APPLICATIONREFERENCENUMBER ?? "N/A",
                                     principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                     principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                     interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                     interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                     principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                     interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                     relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                     misCode = a.MISCODE,
                                     teamMiscode = a.TEAMMISCODE,
                                     interestRate = a.INTERESTRATE,
                                     effectiveDate = a.EFFECTIVEDATE,
                                     maturityDate = a.MATURITYDATE,
                                     bookingDate = a.BOOKINGDATE,
                                     principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                     interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                     approvalStatusId = a.APPROVALSTATUSID,
                                     approvedBy = a.APPROVEDBY,
                                     approverComment = a.APPROVERCOMMENT,
                                     dateApproved = a.DATEAPPROVED,
                                     loanStatusId = a.LOANSTATUSID,
                                     scheduleTypeId = a.SCHEDULETYPEID,
                                     // scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                     isDisbursed = a.ISDISBURSED,
                                     disbursedBy = a.DISBURSEDBY,
                                     disburserComment = a.DISBURSERCOMMENT,
                                     disburseDate = a.DISBURSEDATE,
                                     operationId = a.OPERATIONID,
                                     operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                     subSectorName = a.TBL_SUB_SECTOR.NAME,
                                     sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                     casaAccountNumber = c.PRODUCTACCOUNTNUMBER,
                                     casaAccountNumber2 = context.TBL_CASA.Where(o => o.CASAACCOUNTID == a.CASAACCOUNTID2).Select(o => o.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                     loanStatus = a.TBL_LOAN_STATUS.ACCOUNTSTATUS,
                                     equityContribution = a.EQUITYCONTRIBUTION,
                                     firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                     firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                     outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                     outstandingInterest = a.OUTSTANDINGINTEREST,
                                     principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                     principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                     fixedPrincipal = a.FIXEDPRINCIPAL,
                                     profileLoan = a.PROFILELOAN,
                                     dischargeLetter = a.DISCHARGELETTER,
                                     suspendInterest = a.SUSPENDINTEREST,
                                     customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                     createdBy = a.CREATEDBY,
                                     dateTimeCreated = a.DATETIMECREATED,
                                     accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.TERMLOANID && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST,  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                     exchangeRate = a.EXCHANGERATE,
                                     currencyId = a.CURRENCYID,
                                 });
                    allFilteredLoan = loans.Where(x => x.loanReferenceNumber.Contains(searchQuery) || x.customerCode.ToLower().Contains(searchQuery) ||
                                       x.firstName.ToLower().Contains(searchQuery) ||
                                       x.lastName.ToLower().Contains(searchQuery) ||
                                       x.productAccountName.ToLower().Contains(searchQuery));
                }
                return allFilteredLoan;
            }
            catch (System.Exception ex)
            {
                throw ex;
            }
        }

        public bool CancelFullAndFinal(int loanId)
        {
            try
            {
                var loan = context.TBL_LOAN.Where(o => o.TERMLOANID == loanId).Select(o => o).FirstOrDefault();
                if (loan != null)
                {
                    loan.FULLANDFINALSTATUSID = (int)FullAndFinalStatusEnum.Cancelled;
                }

                if (context.SaveChanges() > 0)
                    return true;

                return false;
            }
            catch (System.Exception ex)
            {
                throw ex;
            }
        }

        public IEnumerable<CustomerCompanyInfomationViewModels> getLoanCustomerCompanyInformation(int customerId)
        {
            var companyInformation = (from a in context.TBL_CUSTOMER_COMPANYINFOMATION
                                      where a.CUSTOMERID == customerId
                                      select new CustomerCompanyInfomationViewModels
                                      {
                                          annualTurnOver = a.ANNUALTURNOVER,
                                          authorizedCapital = a.AUTHORISEDCAPITAL,
                                          companyName = a.COMPANYNAME,
                                          companyEmail = a.COMPANYEMAIL,
                                          companyWebsite = a.COMPANYWEBSITE,
                                          // corporateBusinessCategory = a.CORPORATEBUSINESSCATEGORY,
                                          paidUpCapital = a.PAIDUPCAPITAL,
                                          //creditRating = a.TBL_CUSTOMER.TBL_CUSTOMER_RISK_RATING.RISKRATING,
                                          previousCreditRating = "",
                                          //companyDirectors = (from b in context.TBL_CUSTOMER_COMPANY_DIRECTOR
                                          //                    where b.CUSTOMERID == a.CUSTOMERID
                                          //                      && ((b.COMPANYDIRECTORTYPEID == (short)CompanyDirectorTypeEnum.BoardMember)
                                          //                      || (b.COMPANYDIRECTORTYPEID == (short)CompanyDirectorTypeEnum.BoardMember_Shareholder))
                                          //                    select new CustomerCompanyDirectorsViewModels
                                          //                    {
                                          //                        numberOfShares = b.SHAREHOLDINGPERCENTAGE,
                                          //                        companyDirectorTypeName = b.TBL_CUSTOMER_COMPANY_DIREC_TYP.COMPANYDIRECTORYTYPENAME,
                                          //                        fullname = b.FIRSTNAME + " " + b.SURNAME,
                                          //                        isPoliticallyExposed = b.ISPOLITICALLYEXPOSED,
                                          //                    }).ToList(),
                                          //companyShareholders = (from e in context.TBL_CUSTOMER_COMPANY_DIRECTOR
                                          //                       where e.CUSTOMERID == a.CUSTOMERID
                                          //                       && e.COMPANYDIRECTORTYPEID == (short)CompanyDirectorTypeEnum.Shareholder
                                          //                       select new CustomerCompanyShareholdersViewModels
                                          //                       {
                                          //                           numberOfShares = e.SHAREHOLDINGPERCENTAGE,
                                          //                           companyDirectorTypeName = e.TBL_CUSTOMER_COMPANY_DIREC_TYP.COMPANYDIRECTORYTYPENAME,
                                          //                           fullname = e.FIRSTNAME + " " + e.SURNAME,
                                          //                           isPoliticallyExposed = e.ISPOLITICALLYEXPOSED,
                                          //                       }).ToList(),
                                          //companyAccountSignatories = (from e in context.TBL_CUSTOMER_COMPANY_DIRECTOR
                                          //                             where e.CUSTOMERID == a.CUSTOMERID
                                          //                             && e.COMPANYDIRECTORTYPEID == (short)CompanyDirectorTypeEnum.Account_Signatory
                                          //                             select new CustomerCompanyAccountSignatoryViewModels
                                          //                             {
                                          //                                 numberOfShares = e.SHAREHOLDINGPERCENTAGE,
                                          //                                 companyDirectorTypeName = e.TBL_CUSTOMER_COMPANY_DIREC_TYP.COMPANYDIRECTORYTYPENAME,
                                          //                                 fullname = e.FIRSTNAME + " " + e.SURNAME,
                                          //                                 isPoliticallyExposed = e.ISPOLITICALLYEXPOSED,
                                          //                             }).ToList(),
                                      });

            return companyInformation;
        }

        public List<CasaViewModel> GetLoanCustomerAccounts(int customerId, int loanApplicationDetailId)
        {
            var customerAccounts = (from k in context.TBL_CASA
                                    where k.DELETED == false
                                    && k.CUSTOMERID == customerId
                                    select (
                     new CasaViewModel
                     {
                         productAccountNumber = k.PRODUCTACCOUNTNUMBER,
                         productAccountName = k.PRODUCTACCOUNTNAME,
                         casaAccountId = k.CASAACCOUNTID,
                         currencyId = k.CURRENCYID,
                         customerCode = k.TBL_CURRENCY.CURRENCYCODE,
                         customerName = k.TBL_CURRENCY.CURRENCYNAME,
                         productId = k.PRODUCTID,
                         customerId = k.CUSTOMERID,
                         isCurrentAccount = k.ISCURRENTACCOUNT,
                         tenor = (int)k.TENOR,
                     })).ToList();
            return customerAccounts;
        }

        public List<ProductViewModel> GetLoanCommercialLoans(int companyId)
        {
            var commercialLoans = (from k in context.TBL_PRODUCT
                                   where k.DELETED == false && k.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan
                                   && k.COMPANYID == companyId
                                   select (
                                   new ProductViewModel
                                   {
                                       productId = k.PRODUCTID,
                                       productName = k.PRODUCTNAME
                                   })
                                    ).ToList();
            return commercialLoans;
        }

        public List<loanApplicationColateralViewModel> GetLoanApplicationCollateralsByApplicationId(int loanApplicationId)
        {
            var loanCollateral = (from cm in context.TBL_LOAN_APPLICATION_COLLATERL.Where(x => x.LOANAPPLICATIONID == loanApplicationId).Where(x => x.DELETED == false)
                                  select (
                                           new loanApplicationColateralViewModel
                                           {
                                               legalFeeTaken = cm.LEGAL_FEE_TAKEN.HasValue ? (bool)cm.LEGAL_FEE_TAKEN : false,
                                               legalFeeDate = (DateTime)cm.LEGAL_FEE_DATE,
                                               collateralTypeName = cm.TBL_COLLATERAL_CUSTOMER.TBL_COLLATERAL_TYPE.COLLATERALTYPENAME
                                               + "(" + cm.TBL_COLLATERAL_CUSTOMER.TBL_COLLATERAL_TYPE.TBL_COLLATERAL_TYPE_SUB.FirstOrDefault().COLLATERALSUBTYPENAME + ")",
                                               collateralCustomerId = cm.COLLATERALCUSTOMERID,
                                               collateralValue = cm.TBL_COLLATERAL_CUSTOMER.COLLATERALVALUE,
                                               hairCut = cm.TBL_COLLATERAL_CUSTOMER.HAIRCUT,
                                               valuationCycle = cm.TBL_COLLATERAL_CUSTOMER.VALUATIONCYCLE.HasValue ? (decimal)cm.TBL_COLLATERAL_CUSTOMER.VALUATIONCYCLE : 0,
                                               currencyId = cm.TBL_COLLATERAL_CUSTOMER.CURRENCYID,
                                               currencyCode = cm.TBL_COLLATERAL_CUSTOMER.TBL_CURRENCY.CURRENCYCODE,
                                               currency = cm.TBL_COLLATERAL_CUSTOMER.TBL_CURRENCY.CURRENCYNAME,
                                               loanApplicationCollateralId = cm.LOANAPPCOLLATERALID,
                                               loanApplicationId = cm.LOANAPPLICATIONID,
                                               legalFeeAmount = cm.LEGAL_FEE_AMOUNT.HasValue ? (decimal)cm.LEGAL_FEE_AMOUNT : 0

                                           })).ToList();
            return loanCollateral;
        }

        public IEnumerable<CamProcessedLoanViewModel> GetLoanApplicationDetails(int loanApplicationDetailId, int companyId)
        {
            var data = (from d in context.TBL_LOAN_APPLICATION_DETAIL
                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                        join cust in context.TBL_CUSTOMER on d.CUSTOMERID equals cust.CUSTOMERID
                        where m.COMPANYID == companyId && d.DELETED == false && d.LOANAPPLICATIONDETAILID == loanApplicationDetailId
                        select new CamProcessedLoanViewModel
                        {
                            approvalStatusId = (short)m.APPROVALSTATUSID,
                            loanApplicationId = m.LOANAPPLICATIONID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                            applicationStatusId = m.APPLICATIONSTATUSID,
                            customerId = m.CUSTOMERID ?? 0,
                            customerCode = cust.CUSTOMERCODE,
                            customerName = m.CUSTOMERID.HasValue ? m.TBL_CUSTOMER.FIRSTNAME + " " + m.TBL_CUSTOMER.MIDDLENAME + " " + m.TBL_CUSTOMER.LASTNAME : "",
                            isRelatedParty = m.ISRELATEDPARTY,
                            customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                            customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                            customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                            customerSensitivityLevelId = d.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                            customerOccupation = d.TBL_CUSTOMER.OCCUPATION,
                            customerType = d.TBL_CUSTOMER.TBL_CUSTOMER_TYPE.NAME,
                            isPoliticallyExposed = d.TBL_CUSTOMER.ISPOLITICALLYEXPOSED,
                            isInvestmentGrade = m.ISINVESTMENTGRADE,

                            customerAccounts = (from k in context.TBL_CASA
                                                where k.DELETED == false
                                                && k.CUSTOMERID == d.CUSTOMERID
                                                select (
                                 new CasaViewModel
                                 {
                                     productAccountNumber = k.PRODUCTACCOUNTNUMBER,
                                     productAccountName = k.PRODUCTACCOUNTNAME,
                                     casaAccountId = k.CASAACCOUNTID,
                                     currencyId = k.CURRENCYID,
                                     productId = k.PRODUCTID,
                                     customerId = k.CUSTOMERID,
                                     isCurrentAccount = k.ISCURRENTACCOUNT,
                                     tenor = k.TENOR ?? 0,
                                 })).ToList(),
                            loanInformation = m.LOANINFORMATION,
                            companyInformation = (from a in context.TBL_CUSTOMER_COMPANYINFOMATION
                                                  where a.CUSTOMERID == d.CUSTOMERID
                                                  select new CustomerCompanyInfomationViewModels
                                                  {
                                                      annualTurnOver = a.ANNUALTURNOVER,
                                                      authorizedCapital = a.AUTHORISEDCAPITAL,
                                                      companyName = a.COMPANYNAME,
                                                      companyEmail = a.COMPANYEMAIL,
                                                      companyWebsite = a.COMPANYWEBSITE,
                                                      corporateBusinessCategory = a.CORPORATEBUSINESSCATEGORY,
                                                      paidUpCapital = a.PAIDUPCAPITAL,
                                                      creditRating = a.TBL_CUSTOMER.TBL_CUSTOMER_RISK_RATING.RISKRATING,
                                                      previousCreditRating = "",
                                                      companyDirectors = (from b in context.TBL_CUSTOMER_COMPANY_DIRECTOR
                                                                          where b.CUSTOMERID == a.CUSTOMERID
                          && ((b.COMPANYDIRECTORTYPEID == (short)CompanyDirectorTypeEnum.BoardMember)
                                    || (b.COMPANYDIRECTORTYPEID == (short)CompanyDirectorTypeEnum.BoardMember_Shareholder))
                                                                          select new CustomerCompanyDirectorsViewModels
                                                                          {
                                                                              numberOfShares = b.SHAREHOLDINGPERCENTAGE,
                                                                              companyDirectorTypeName = b.TBL_CUSTOMER_COMPANY_DIREC_TYP.COMPANYDIRECTORYTYPENAME,
                                                                              fullname = b.FIRSTNAME + " " + b.SURNAME,
                                                                              isPoliticallyExposed = b.ISPOLITICALLYEXPOSED,
                                                                          }).ToList(),
                                                      companyShareholders = (from e in context.TBL_CUSTOMER_COMPANY_DIRECTOR
                                                                             where e.CUSTOMERID == a.CUSTOMERID
                                                                             && e.COMPANYDIRECTORTYPEID == (short)CompanyDirectorTypeEnum.Shareholder
                                                                             select new CustomerCompanyShareholdersViewModels
                                                                             {
                                                                                 numberOfShares = e.SHAREHOLDINGPERCENTAGE,
                                                                                 companyDirectorTypeName = e.TBL_CUSTOMER_COMPANY_DIREC_TYP.COMPANYDIRECTORYTYPENAME,
                                                                                 fullname = e.FIRSTNAME + " " + e.SURNAME,
                                                                                 isPoliticallyExposed = e.ISPOLITICALLYEXPOSED,
                                                                             }).ToList(),
                                                      companyAccountSignatories = (from e in context.TBL_CUSTOMER_COMPANY_DIRECTOR
                                                                                   where e.CUSTOMERID == a.CUSTOMERID
                                                                                   && e.COMPANYDIRECTORTYPEID == (short)CompanyDirectorTypeEnum.Account_Signatory
                                                                                   select new CustomerCompanyAccountSignatoryViewModels
                                                                                   {
                                                                                       numberOfShares = e.SHAREHOLDINGPERCENTAGE,
                                                                                       companyDirectorTypeName = e.TBL_CUSTOMER_COMPANY_DIREC_TYP.COMPANYDIRECTORYTYPENAME,
                                                                                       fullname = e.FIRSTNAME + " " + e.SURNAME,
                                                                                       isPoliticallyExposed = e.ISPOLITICALLYEXPOSED,
                                                                                   }).ToList(),
                                                  }).FirstOrDefault(),
                            companyId = m.COMPANYID,
                            branchId = m.BRANCHID,
                            branchName = m.TBL_BRANCH.BRANCHNAME,
                            subSectorId = d.SUBSECTORID,
                            subSectorName = d.TBL_SUB_SECTOR.NAME,
                            sectorName = d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            applicationTenor = m.APPLICATIONTENOR,
                            effectiveDate = (DateTime)d.EFFECTIVEDATE,
                            expiryDate = (DateTime)d.EXPIRYDATE,
                            relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                            relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                            relationshipManagerId = m.RELATIONSHIPMANAGERID,
                            relationshipManagerName = m.TBL_STAFF1.FIRSTNAME + " " + m.TBL_STAFF1.MIDDLENAME + " " + m.TBL_STAFF1.LASTNAME,

                            currencyId = d.CURRENCYID,
                            currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                            exchangeRate = d.EXCHANGERATE,
                            loanTypeId = m.LOANAPPLICATIONTYPEID,
                            loanTypeName = m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                            productId = d.APPROVEDPRODUCTID,
                            productTypeId = d.TBL_PRODUCT.PRODUCTTYPEID,
                            productTypeName = d.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            productName = d.TBL_PRODUCT.PRODUCTNAME,

                            misCode = m.MISCODE,
                            teamMisCode = m.TEAMMISCODE,

                            interestRate = d.APPROVEDINTERESTRATE,
                            submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                            approvedAmount = d.APPROVEDAMOUNT,
                            groupApprovedAmount = m.APPROVEDAMOUNT,

                            customerAvailableAmount = (d.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.TermLoan
                                                      || d.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan
                                                      || d.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.SelfLiquidating)
                             ? (d.APPROVEDAMOUNT - d.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == d.LOANAPPLICATIONDETAILID).Sum(s => s.PRINCIPALAMOUNT)) :
                                ((d.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan)
                                        ? (d.APPROVEDAMOUNT - d.TBL_LOAN_REVOLVING
                                            .Where(tl => tl.LOANAPPLICATIONDETAILID == d.LOANAPPLICATIONDETAILID).Sum(s => s.OVERDRAFTLIMIT)) :
                                  (d.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.ContingentLiability
                                        ? (d.APPROVEDAMOUNT - d.TBL_LOAN_CONTINGENT
                                            .Where(tl => tl.LOANAPPLICATIONDETAILID == d.LOANAPPLICATIONDETAILID).Sum(s => s.CONTINGENTAMOUNT)) :
                                            0)
                                ),
                            approvedTenor = d.APPROVEDTENOR,
                            createdBy = m.OWNEDBY,
                            newApplicationDate = m.APPLICATIONDATE,
                            dateTimeCreated = d.DATETIMECREATED,
                            loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,
                            loanCollateral = (from cm in context.TBL_LOAN_APPLICATION_COLLATERL.Where(x => x.LOANAPPLICATIONID == m.LOANAPPLICATIONID) // ------------------ REFACTOR TO LOANID!
                                              select (new LoanCollateralMappingViewModel
                                              {
                                                  collateralTypeName = cm.TBL_COLLATERAL_CUSTOMER.TBL_COLLATERAL_TYPE.COLLATERALTYPENAME
                                                           + "(" + cm.TBL_COLLATERAL_CUSTOMER.TBL_COLLATERAL_TYPE.TBL_COLLATERAL_TYPE_SUB.FirstOrDefault().COLLATERALSUBTYPENAME + ")",
                                                  collateralCustomerId = cm.COLLATERALCUSTOMERID,
                                                  loanApplicationId = cm.LOANAPPLICATIONID,
                                                  collateralValue = cm.TBL_COLLATERAL_CUSTOMER.COLLATERALVALUE,
                                                  hairCut = cm.TBL_COLLATERAL_CUSTOMER.HAIRCUT,
                                                  valuationCycle = cm.TBL_COLLATERAL_CUSTOMER.VALUATIONCYCLE,
                                                  currencyId = cm.TBL_COLLATERAL_CUSTOMER.CURRENCYID,
                                                  currencyCode = cm.TBL_COLLATERAL_CUSTOMER.TBL_CURRENCY.CURRENCYCODE,
                                                  currency = cm.TBL_COLLATERAL_CUSTOMER.TBL_CURRENCY.CURRENCYNAME
                                              })).ToList()

                        }).ToList();

            return data;
        }

        private IEnumerable<LoanViewModel> BookedLoan(int companyId)
        {
            return GetAllLoans().Where(x => x.companyId == companyId).OrderByDescending(x => x.loanId);
        }

        public IEnumerable<LoanViewModel> GetBookedLoanDetails(int companyId)
        {
            var loans = BookedLoan(companyId);
            foreach (var loan in loans)
            {
                loan.loanCovenant = GetLoanCovenant(loan.loanId);
                loan.loanChargeFee = GetLoanChargeFee(loan.loanId);
                // loan.loanGuarantor = GetLoanGuarantors(loan.loanId);
                //loan.loanCollateral = GetLoanCollaterals(loan.loanId);
            }

            return loans;
        }

        public IEnumerable<LoanViewModel> GetBookedLoanDetailsByLoanReferenceNumber(string loanReferenceNumber, int companyId)
        {
            var loans = BookedLoan(companyId).Where(x => x.loanReferenceNumber == loanReferenceNumber);
            foreach (var loan in loans)
            {
                loan.loanCovenant = GetLoanCovenant(loan.loanId);
                loan.loanChargeFee = GetLoanChargeFee(loan.loanId);
                //loan.loanGuarantor = GetLoanGuarantors(loan.loanId);
                // loan.loanCollateral = GetLoanCollaterals(loan.loanId);
            }

            return loans;
        }

        public IEnumerable<LoanViewModel> GetBookedLoanDetailsByCustomerCode(string customerCode, int companyId)
        {
            var loans = BookedLoan(companyId).Where(x => x.customerCode == customerCode);
            foreach (var loan in loans)
            {
                loan.loanCovenant = GetLoanCovenant(loan.loanId);
                loan.loanChargeFee = GetLoanChargeFee(loan.loanId);
                // loan.loanGuarantor = GetLoanGuarantors(loan.loanId);
                //loan.loanCollateral = GetLoanCollaterals(loan.loanId);
            }
            return loans;
        }

        public List<LoanCAMSOLViewModel> GetCurrentCamsolByCustomer(List<CustomerExposure> customer, int loanTypeId, int companyId)
        {
            List<LoanCAMSOLViewModel> camsol = new List<LoanCAMSOLViewModel>();
            if (loanTypeId == (int)LoanTypeEnum.CustomerGroup && customer.Count() == 1)
            {
                var customerGroupId = customer.FirstOrDefault().customerId;
                var customerGroupMapping = (from a in context.TBL_CUSTOMER_GROUP_MAPPING
                                            where a.CUSTOMERGROUPID == customerGroupId && a.DELETED == false
                                            select new CustomerGroupMappingViewModel
                                            {
                                                customerGroupMappingId = a.CUSTOMERGROUPMAPPINGID,
                                                customerGroupId = a.CUSTOMERGROUPID,
                                                relationshipTypeId = a.RELATIONSHIPTYPEID,
                                                relationshipTypeName = a.TBL_CUSTOMER_GROUP_RELATN_TYPE.RELATIONSHIPTYPENAME,
                                                customerId = a.CUSTOMERID,
                                                customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                                customerName = a.TBL_CUSTOMER.LASTNAME + " " + a.TBL_CUSTOMER.FIRSTNAME,
                                                customerType = a.TBL_CUSTOMER.TBL_CUSTOMER_TYPE.NAME,
                                            }).ToList();
                if (customerGroupMapping.Count() > 0)
                {
                    customer = customerGroupMapping.Select(m => new CustomerExposure { customerId = m.customerId }).ToList();
                }
            }

            foreach (var item in customer)
            {
                var customercode = context.TBL_CUSTOMER.Find(item.customerId)?.CUSTOMERCODE;

                camsol = (from cam in context.TBL_LOAN_CAMSOL
                          join c in context.TBL_LOAN_CAMSOL_TYPE on cam.CAMSOLTYPEID equals c.CAMSOLTYPEID
                          where cam.CUSTOMERCODE == customercode
                          select new LoanCAMSOLViewModel
                          {
                              accountname = cam.ACCOUNTNAME,
                              accountnumber = cam.ACCOUNTNUMBER,
                              balance = cam.BALANCE,
                              camsoltypeid = cam.CAMSOLTYPEID,
                              cantakeloan = cam.CANTAKELOAN,
                              customercode = cam.CUSTOMERCODE,
                              customername = cam.CUSTOMERNAME,
                              date = cam.DATE,
                              camsolType = c.CAMSOLTYPENAME,
                              loansystemtype = context.TBL_LOAN_SYSTEM_TYPE.Where(x => x.LOANSYSTEMTYPEID == cam.LOANSYSTEMTYPEID).Select(x => x.LOANSYSTEMTYPENAME).FirstOrDefault(),
                              interestinsuspense = cam.INTERESTINSUSPENSE,
                              loancamsolid = cam.LOAN_CAMSOLID,
                              loanid = cam.LOANID,
                              principal = cam.PRINCIPAL,
                              remark = cam.REMARK,
                          }).ToList();
            }
            return camsol;
        }

        public List<CurrentCustomerExposure> GetCurrentCustomerExposure(List<CustomerExposure> customer, int loanTypeId, int companyId)
        {
            IEnumerable<CurrentCustomerExposure> exposure = null;
            var customerId = customer.FirstOrDefault()?.customerId;
            var allGroupMappings = GetCustomerGroupMapping();
            List<CurrentCustomerExposure> exposures = new List<CurrentCustomerExposure>();
            
            if (loanTypeId == (int)LoanTypeEnum.CustomerGroup && customer.Count() == 1)
            {
                var customerGroupMappings = new List<CustomerGroupMappingViewModel>();
                var mappings = allGroupMappings.Where(m => m.customerGroupId == customerId).ToList();

                if (mappings.Count() > 0)
                {
                    customer = mappings.Select(m => new CustomerExposure { customerId = m.customerId }).ToList();
                }
            }
            else
            {
                var customerIsAGroupMember = allGroupMappings.Any(m => m.customerId == customerId);
                if (customerIsAGroupMember)
                {
                    var mappings = new List<CustomerGroupMappingViewModel>();
                    var customerGroups = allGroupMappings.Where(m => m.customerId == customerId).ToList();
                    var allGroupIds = customerGroups.Select(m => m.customerGroupId).Distinct().ToList();
                    foreach (var groupId in allGroupIds)
                    {
                        var mapping = allGroupMappings.Where(m => m.customerGroupId == groupId).ToList();
                        mappings.AddRange(mapping);
                    }
                    if (mappings.Count() > 0)
                    {
                        customer = mappings.Select(m => new CustomerExposure { customerId = m.customerId }).ToList();
                    }
                }
            }

            foreach (var item in customer)
            {
                var customerCode = context.TBL_CUSTOMER.FirstOrDefault(x => x.CUSTOMERID == item.customerId)?.CUSTOMERCODE.Trim();

                exposure = (from a in context.TBL_GLOBAL_EXPOSURE
                            where a.CUSTOMERID.Contains(customerCode)
                            select new CurrentCustomerExposure
                            {
                                customerName = a.CUSTOMERNAME,
                                customerCode = a.CUSTOMERID.Trim(),
                                facilityType = a.ADJFACILITYTYPE,
                                approvedAmount = a.LOANAMOUNYTCY ?? 0,
                                approvedAmountLcy = a.LOANAMOUNYLCY ?? 0,
                                currency = a.CURRENCYNAME,
                                currencyType = a.CURRENCYTYPE,
                                exposureTypeCodeString = a.EXPOSURETYPECODE,
                                adjFacilityTypeString = a.ADJFACILITYTYPE,
                                adjFacilityTypeCode = a.ADJFACILITYTYPEid.Trim(),
                                productIdString = a.PRODUCTID,
                                productCode = a.PRODUCTCODE,
                                productName = a.PRODUCTNAME,
                                currencyCode = a.ALPHACODE,
                                //existingLimit = a.PRINCIPALOUTSTANDINGBALLCY ?? 0,
                                //proposedLimit = a.LOANAMOUNYLCY ?? 0,
                                outstandings = a.PRINCIPALOUTSTANDINGBALTCY ?? 0,
                                outstandingsLcy = a.PRINCIPALOUTSTANDINGBALLCY ?? 0,
                                pastDueObligationsPrincipal = a.TOTALUNPAIDOBLIGATION ?? 0,
                                reviewDate = DateTime.Now,
                                bookingDate = a.BOOKINGDATE,
                                maturityDate = a.MATURITYDATE,
                                tenorString = a.TENOR,
                                //maturityDateString = a.MATURITYDATE,
                                loanStatus = a.CBNCLASSIFICATION,
                                referenceNumber = a.REFERENCENUMBER,
                            }).ToList();

                if (exposure.Count() > 0)
                {
                    foreach (var e in exposure)
                    {
                        e.exposureTypeId = int.Parse(e.exposureTypeCodeString);
                        e.tenor = int.Parse(String.IsNullOrEmpty(e.tenorString) ? "0" : e.tenorString);
                        e.bookingDate = e.bookingDate?.Date;
                        e.maturityDate = e.maturityDate?.Date;
                        //e.productId = int.Parse(e.productIdString);
                        e.exposureTypeCode = int.Parse(String.IsNullOrEmpty(e.exposureTypeCodeString) ? "0" : e.exposureTypeCodeString);
                        e.adjFacilityTypeId = int.Parse(String.IsNullOrEmpty(e.adjFacilityTypeCode) ? "0" : e.adjFacilityTypeCode);
                    }
                    exposures.AddRange(exposure);
                }


                //exposure = from a in context.TBL_LOAN
                //           join d in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                //           join b in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals b.LOANAPPLICATIONID
                //           where a.CUSTOMERID == item.customerId && a.COMPANYID == companyId && a.LOANSTATUSID == (int)LoanStatusEnum.Active
                //           select new CurrentCustomerExposure
                //           {
                //               facilityType = a.TBL_PRODUCT.PRODUCTNAME,
                //               existingLimit = a.PRINCIPALAMOUNT,
                //               //proposedLimit = a.OUTSTANDINGPRINCIPAL,
                //               proposedLimit = 0,
                //               //recommendedLimit = a.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,
                //               outstandings = a.OUTSTANDINGPRINCIPAL,
                //               recommendedLimit = 0,
                //               PastDueObligationsInterest = a.PASTDUEINTEREST,
                //               PastDueObligationsPrincipal = a.PASTDUEPRINCIPAL,
                //               reviewDate = DateTime.Now,
                //               prudentialGuideline = a.TBL_LOAN_PRUDENTIALGUIDELINE2.STATUSNAME,
                //               loanStatus = "Running",
                //               referenceNumber = a.LOANREFERENCENUMBER,
                //               applicationStatusId = b.APPLICATIONSTATUSID
                //           };

                //if (exposure.Count() > 0) exposures.AddRange(exposure);

                //exposure = (from a in context.TBL_LOAN_REVOLVING
                //            join b in context.TBL_LOAN_APPLICATION on a.LOANREFERENCENUMBER equals b.APPLICATIONREFERENCENUMBER
                //            where a.CUSTOMERID == item.customerId && a.COMPANYID == companyId && a.LOANSTATUSID == (int)LoanStatusEnum.Active
                //            select new CurrentCustomerExposure
                //            {
                //                facilityType = a.TBL_PRODUCT.PRODUCTNAME,
                //                existingLimit = a.OVERDRAFTLIMIT,
                //                //proposedLimit = a.OVERDRAFTLIMIT,
                //                proposedLimit = 0,
                //                //recommendedLimit = a.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,   
                //                outstandings = a.OVERDRAFTLIMIT,
                //                recommendedLimit = 0,
                //                casaAccountId = a.CASAACCOUNTID,
                //                PastDueObligationsInterest = a.PASTDUEINTEREST,
                //                PastDueObligationsPrincipal = a.PASTDUEPRINCIPAL,
                //                reviewDate = DateTime.Now,
                //                prudentialGuideline = a.TBL_LOAN_PRUDENTIALGUIDELINE2.STATUSNAME,
                //                loanStatus = "Running",
                //                referenceNumber = a.LOANREFERENCENUMBER,
                //                applicationStatusId = b.APPLICATIONSTATUSID
                //            }).ToList();
                //.Select(x =>
                //{
                //    //var availableBalance = transRepo.GetCASABalance((int)x.casaAccountId).availableBalance;
                //    var availableBalance = context.TBL_CASA.FirstOrDefault(m=>m.CASAACCOUNTID == (int)x.casaAccountId).AVAILABLEBALANCE;

                //    if ( availableBalance >= 0)
                //    {
                //        x.outstandings = 0;
                //    }
                //    else
                //    {
                //        x.outstandings = Math.Abs(availableBalance); 
                //    }
                //    return x;
                //});

                //if (exposure.Count() > 0) exposures.AddRange(exposure);

                //exposure = from a in context.TBL_LOAN_APPLICATION_DETAIL
                //           join b in context.TBL_LOAN_APPLICATION on a.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER equals b.APPLICATIONREFERENCENUMBER
                //           join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                //           where a.CUSTOMERID == item.customerId && a.TBL_LOAN_APPLICATION.COMPANYID == companyId && (a.TBL_LOAN_APPLICATION.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved || a.TBL_LOAN_APPLICATION.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved)
                //           select new CurrentCustomerExposure
                //           {

                //               applicationStatusId = b.APPLICATIONSTATUSID,
                //               customerName = c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME,
                //               customerCode = c.CUSTOMERCODE.Trim(),
                //               facilityType = a.TBL_PRODUCT.PRODUCTNAME,
                //               approvedAmount = a.APPROVEDAMOUNT,
                //               currency = a.TBL_CURRENCY.CURRENCYNAME,
                //               //exposureTypeId = int.Parse(a.EXPOSURETYPECODE),
                //               //adjFacilityType = a.ADJFACILITYTYPE,
                //               productId = a.TBL_PRODUCT.PRODUCTID,
                //               productName = a.TBL_PRODUCT.PRODUCTNAME,
                //               outstandings = 0,
                //               pastDueObligationsPrincipal = 0,
                //               reviewDate = DateTime.Now,
                //               //bookingDate = DateTime.Parse(a.BOOKINGDATE),
                //               //maturityDate = DateTime.Parse(a.MATURITYDATE),
                //               loanStatus = "Processing",
                //               referenceNumber = b.APPLICATIONREFERENCENUMBER
                //           };

                //if (exposure.Count() > 0) exposures.AddRange(exposure);


                //var staggingLoan = from a in stgCon.STG_LOAN_MART
                //                   where a.CUST_ID == customCode
                //                   select new CurrentCustomerExposure
                //                   {
                //                       facilityType = a.SCHM_TYPE,
                //                       existingLimit = a.FAC_GRANT_AMT,
                //                       //proposedLimit = a.FINAL_BALANCE,
                //                       proposedLimit = 0,
                //                       recommendedLimit = 0,
                //                       outstandings = a.FINAL_BALANCE,
                //                       PastDueObligationsInterest = a.INT_DUE,
                //                       PastDueObligationsPrincipal = a.DAYS_PAST_DUE,// 0,
                //                       reviewDate = DateTime.Now,
                //                       prudentialGuideline = a.USER_CLASSIFICATION == "1" ? "Performing" : "Non-Performing",
                //                       loanStatus = "Running"
                //                   };

                //exposures.Union(staggingLoan);

            }

            if (exposures.Count() == 0)
            {
                return exposures;
            }

            //exposures.Add(new CurrentCustomerExposure
            //{
            //    facilityType = "TOTAL",
            //    existingLimit = exposures.Sum(t => t.existingLimit),
            //    proposedLimit = exposures.Sum(t => t.proposedLimit),
            //    bookingDate = exposures.Max(t => t.bookingDate),
            //    maturityDate = exposures.Max(t => t.maturityDate),
            //    //approvedAmount = exposures.Sum(t => t.approvedAmount),
            //    recommendedLimit = exposures.Sum(t => t.recommendedLimit),
            //    outstandings = exposures.Sum(t => t.outstandings),
            //    PastDueObligationsInterest = exposures.Sum(t => t.PastDueObligationsInterest),
            //    pastDueObligationsPrincipal = exposures.Sum(t => t.pastDueObligationsPrincipal),
            //    reviewDate = DateTime.Now,
            //});

            return exposures;
        }
        public IEnumerable<CustomerGroupMappingViewModel> GetCustomerGroupMapping()
        {
            var customerGroupMapping = (from a in context.TBL_CUSTOMER_GROUP_MAPPING
                                        where a.DELETED == false
                                        select new CustomerGroupMappingViewModel
                                        {
                                            customerGroupMappingId = a.CUSTOMERGROUPMAPPINGID,
                                            customerGroupId = a.CUSTOMERGROUPID,
                                            relationshipTypeId = a.RELATIONSHIPTYPEID,
                                            //createdBy = a.CreatedBy,
                                            customerId = a.CUSTOMERID,
                                            //dateTimeCreated = a.DateTimeCreated
                                        }).ToList();

            return customerGroupMapping;
        }

        public List<CurrentCustomerExposure> GetApplicationFacilitySummary(int applicationId)
        {
            var customers = context.TBL_LOAN_APPLICATION_DETAIL
                .Where(x => x.LOANAPPLICATIONID == applicationId && x.DELETED == false)
                .Select(x => new { CUSTOMERID = x.CUSTOMERID })
                .Distinct()
                .ToList();

            IQueryable<CurrentCustomerExposure> exposure = null;
            List<CurrentCustomerExposure> exposures = new List<CurrentCustomerExposure>();

            foreach (var item in customers)
            {
                exposure = from a in context.TBL_LOAN
                           where a.CUSTOMERID == item.CUSTOMERID && a.LOANSTATUSID == (int)LoanStatusEnum.Active
                           select new CurrentCustomerExposure
                           {
                               loanId = a.TERMLOANID,
                               productTypeId = 1,
                               facilityType = a.TBL_PRODUCT.PRODUCTNAME,
                               existingLimit = a.PRINCIPALAMOUNT,
                               proposedLimit = a.OUTSTANDINGPRINCIPAL,
                               recommendedLimit = a.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,
                               PastDueObligationsInterest = a.PASTDUEINTEREST,
                               pastDueObligationsPrincipal = a.PASTDUEPRINCIPAL,
                               reviewDate = DateTime.Now,
                               prudentialGuideline = a.TBL_LOAN_PRUDENTIALGUIDELINE2.STATUSNAME,
                               loanStatus = "Running"
                           };

                if (exposure.Count() > 0) exposures.AddRange(exposure);

                exposure = from a in context.TBL_LOAN_REVOLVING
                           where a.CUSTOMERID == item.CUSTOMERID && a.LOANSTATUSID == (int)LoanStatusEnum.Active
                           select new CurrentCustomerExposure
                           {
                               loanId = a.REVOLVINGLOANID,
                               productTypeId = 2,
                               facilityType = a.TBL_PRODUCT.PRODUCTNAME,
                               existingLimit = a.OVERDRAFTLIMIT,
                               proposedLimit = a.OVERDRAFTLIMIT,
                               recommendedLimit = a.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,
                               PastDueObligationsInterest = a.PASTDUEINTEREST,
                               pastDueObligationsPrincipal = a.PASTDUEPRINCIPAL,
                               reviewDate = DateTime.Now,
                               prudentialGuideline = a.TBL_LOAN_PRUDENTIALGUIDELINE2.STATUSNAME,
                               loanStatus = "Running"
                           };

                if (exposure.Count() > 0) exposures.AddRange(exposure);

                exposure = from a in context.TBL_LOAN_APPLICATION_DETAIL
                           where a.CUSTOMERID == item.CUSTOMERID && (a.TBL_LOAN_APPLICATION.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved || a.TBL_LOAN_APPLICATION.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved)
                           select new CurrentCustomerExposure
                           {
                               loanId = 0,
                               productTypeId = 0,
                               facilityType = a.TBL_PRODUCT.PRODUCTNAME,
                               existingLimit = 0,
                               proposedLimit = a.PROPOSEDAMOUNT,
                               recommendedLimit = a.APPROVEDAMOUNT,
                               PastDueObligationsInterest = 0,
                               pastDueObligationsPrincipal = 0,
                               reviewDate = DateTime.Now,
                               prudentialGuideline = "Processing",
                               loanStatus = "Processing"
                           };

                if (exposure.Count() > 0) exposures.AddRange(exposure);
            }

            exposures.Add(new CurrentCustomerExposure
            {
                facilityType = "TOTAL",
                existingLimit = exposures.Sum(t => t.existingLimit),
                proposedLimit = exposures.Sum(t => t.proposedLimit),
                recommendedLimit = exposure.Sum(t => t.recommendedLimit),
                PastDueObligationsInterest = exposures.Sum(t => t.PastDueObligationsInterest),
                pastDueObligationsPrincipal = exposures.Sum(t => t.pastDueObligationsPrincipal),
                reviewDate = DateTime.Now,
            });

            return exposures;
        }


        public List<LoanViewModel> GetLoanReviewApplicationOverDraftRouteAndOperations(int staffId, int companyId)
        {

            var applicationDate = generalSetup.GetApplicationDate();
            //var activities = admin.GetUserActivitiesByUser(staffId);
            // var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId ).Select(x => x).FirstOrDefault().CURRENCYID;
            UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);

            var ids = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.LmsOperations).ToList();

            try
            {

                var activities = admin.GetUserActivitiesByUser(staffId);
                var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

                var currentDate = generalSetup.GetApplicationDate();
                var allFilteredLoan = (from a in context.TBL_LOAN_REVOLVING
                                       join b in context.TBL_LMSR_APPLICATION_DETAIL on a.REVOLVINGLOANID equals b.LOANID
                                       join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                       join atrail in context.TBL_APPROVAL_TRAIL on b.LOANREVIEWAPPLICATIONID equals atrail.TARGETID
                                       join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                       where a.ISDISBURSED == true //&& b.TBL_OPERATIONS.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagementOverdraft
                                       && atrail.OPERATIONID == (short)OperationsEnum.LmsOperations
                                       && (ids.Contains((int)atrail.TOAPPROVALLEVELID) || atrail.REQUESTSTAFFID == staffId)
                                       && atrail.RESPONSESTAFFID == null
                                       //&& ((cf.CanSeeLocalCurrency && a.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && a.CURRENCYID != cf.DefaultCurrencyId))
                                       // && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved 
                                       && b.OPERATIONPERFORMED == false
                                       //orderby b.DATECREATED descending
                                       select new LoanViewModel
                                       {
                                           loanReviewApplicationId = e.LOANAPPLICATIONID,
                                           loanId = a.REVOLVINGLOANID,
                                           customerId = a.CUSTOMERID,
                                           customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                           applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                           loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                           interestRate = a.INTERESTRATE,
                                           principalAmount = a.OVERDRAFTLIMIT,
                                           effectiveDate = a.EFFECTIVEDATE,
                                           maturityDate = a.MATURITYDATE,
                                           operationId = b.OPERATIONID,
                                           operationName = b.TBL_OPERATIONS.OPERATIONNAME,
                                           productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                           productName = a.TBL_PRODUCT.PRODUCTNAME,
                                           loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                           systemCurrentDate = currentDate,
                                           lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                           loanSystemTypeId = b.LOANSYSTEMTYPEID,

                                           customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                           productId = a.PRODUCTID,
                                           companyId = a.COMPANYID,
                                           casaAccountId = a.CASAACCOUNTID,
                                           branchId = a.BRANCHID,
                                           branchName = a.TBL_BRANCH.BRANCHNAME,
                                           relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                           relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                           relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                           relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                           misCode = a.MISCODE,
                                           teamMiscode = a.TEAMMISCODE,
                                           bookingDate = a.BOOKINGDATE,
                                           approvalStatusId = a.APPROVALSTATUSID,
                                           approvedBy = a.APPROVEDBY,
                                           approverComment = a.APPROVERCOMMENT,
                                           dateApproved = a.DATEAPPROVED,
                                           loanStatusId = a.LOANSTATUSID,
                                           isDisbursed = a.ISDISBURSED,
                                           disburserComment = a.DISBURSERCOMMENT,
                                           disburseDate = a.DISBURSEDATE,
                                           subSectorName = a.TBL_SUB_SECTOR.NAME,
                                           sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                           casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                           productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                           customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                           loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                           dischargeLetter = a.DISCHARGELETTER,
                                           suspendInterest = a.SUSPENDINTEREST,
                                           customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                           createdBy = a.CREATEDBY,
                                           dateTimeCreated = a.DATETIMECREATED,
                                           exchangeRate = a.EXCHANGERATE,
                                           currencyId = a.CURRENCYID,
                                           currency = a.TBL_CURRENCY.CURRENCYNAME,
                                           loanReviewOperationTypeId = b.OPERATIONID,
                                           reviewDetails = b.REVIEWDETAILS,
                                           interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                           interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                           pastDueInterest = a.PASTDUEINTEREST,
                                           pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                           timeIn = atrail.SYSTEMARRIVALDATETIME,
                                           responsiblePerson = context.TBL_STAFF
                                            .Where(s => s.STAFFID == atrail.TOSTAFFID)
                                            .Select(s => new { name = s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME })
                                            .FirstOrDefault().name ?? "",

                                           operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.REVOLVINGLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                           {
                                               loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                               operationTypeId = op.OPERATIONTYPEID,
                                               operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                               newEffectiveDate = op.EFFECTIVEDATE,
                                               reviewDetails = op.REVIEWDETAILS,
                                               prepayment = op.PREPAYMENT,
                                               newInterateRate = op.INTERATERATE,
                                               newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                               newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                               newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                               newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                               newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                               newTenor = op.TENOR,
                                               cASA_AccountId = op.CASA_ACCOUNTID,
                                               cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                               overDraftTopup = op.OVERDRAFTTOPUP,
                                               fee_Charges = op.FEE_CHARGES,
                                               scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                               scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                               scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                               scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                               scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                               newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                               newMaturityDate = op.MATURITYDATE,
                                               dateTimeCreated = op.DATECREATED
                                           }).FirstOrDefault(),
                                       }).ToList();

                List<LoanViewModel> lcyLoans = new List<LoanViewModel>();
                List<LoanViewModel> fcyLoans = new List<LoanViewModel>();

                var isLCYUser = activities.Contains("lcy-user");
                var isFCYUser = activities.Contains("fcy-user");

                if (isLCYUser == true)
                {
                    lcyLoans = allFilteredLoan.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                    //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
                }

                if (isFCYUser == true)
                {
                    fcyLoans = allFilteredLoan.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

                }

                allFilteredLoan = lcyLoans.Union(fcyLoans).ToList();


                return allFilteredLoan;
            }
            catch (System.Exception ex)
            {
                throw new SecureException(ex.Message);
            }
        }

        public IQueryable<LoanViewModel> SearchForLoan(string searchQuery)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            IQueryable<LoanViewModel> allFilteredLoan = null;

            searchQuery = searchQuery.Trim();
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                var loans = (from a in context.TBL_LOAN
                             join r in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals r.LOANID
                             join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                             join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                             where a.ISDISBURSED == true && a.MATURITYDATE >= DbFunctions.TruncateTime(applicationDate) && a.LOANSTATUSID == (int)LoanStatusEnum.Active
                             select new LoanViewModel
                             {
                                 loanId = a.TERMLOANID,
                                 customerId = a.CUSTOMERID,
                                 customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                 firstName = b.FIRSTNAME,
                                 lastName = b.LASTNAME,
                                 customerCode = b.CUSTOMERCODE,
                                 productAccountName = c.PRODUCTACCOUNTNAME,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 principalAmount = a.PRINCIPALAMOUNT,
                                 loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                 lmsApplicationDetailId = r.LOANREVIEWAPPLICATIONID,
                                 productName = a.TBL_PRODUCT.PRODUCTNAME,
                                 productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                 currencyId = a.CURRENCYID,
                                 currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                 //applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                 //principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                 //pricipalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                 //interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                 //interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                 //productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                 //productName = a.TBL_PRODUCT.PRODUCTNAME,
                                 //productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                 //principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                 //interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                 //relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                 //relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                 //relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                 //relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                 //misCode = a.MISCODE,
                                 //teamMiscode = a.TEAMMISCODE,
                                 //interestRate = a.INTERESTRATE,
                                 //effectiveDate = a.EFFECTIVEDATE,
                                 //maturityDate = a.MATURITYDATE,
                                 //bookingDate = a.BOOKINGDATE,

                                 //principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                 //interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                 //approvalStatusId = a.APPROVALSTATUSID,
                                 //approvedBy = a.APPROVEDBY,
                                 //approverComment = a.APPROVERCOMMENT,
                                 //dateApproved = a.DATEAPPROVED,
                                 //loanStatusId = a.LOANSTATUSID,
                                 //scheduleTypeId = a.SCHEDULETYPEID,
                                 //scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                 //isDisbursed = a.ISDISBURSED,
                                 //disbursedBy = a.DISBURSEDBY,
                                 //disburserComment = a.DISBURSERCOMMENT,
                                 //disburseDate = a.DISBURSEDATE,
                                 //approvedAmount = a.ApprovedAmount,
                                 //operationId = a.OPERATIONID,
                                 //operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                 //subSectorName = a.TBL_SUB_SECTOR.NAME,
                                 //sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                 //casaAccountNumber = c.PRODUCTACCOUNTNUMBER,
                                 //customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                 //loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                 //loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                 //equityContribution = a.EQUITYCONTRIBUTION,
                                 //firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                 //firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                 //outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                 //outstandingInterest = a.OUTSTANDINGINTEREST,
                                 //principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                 //principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                 //fixedPrincipal = a.FIXEDPRINCIPAL,
                                 //profileLoan = a.PROFILELOAN,
                                 //dischargeLetter = a.DISCHARGELETTER,
                                 //suspendInterest = a.SUSPENDINTEREST,
                                 //customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                 //createdBy = a.CREATEDBY,
                                 //dateTimeCreated = a.DATETIMECREATED,
                                 //isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                 //exchangeRate = a.EXCHANGERATE,
                                 //currencyId = a.CURRENCYID,
                                 //currency = a.TBL_CURRENCY.CURRENCYNAME
                             });

                allFilteredLoan = loans.Where(x => x.loanReferenceNumber.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.customerCode.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.firstName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.lastName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.productAccountName.ToLower().Contains(searchQuery.ToLower()))
                                   .Take(10).AsQueryable();

            }

            return allFilteredLoan;

        }

        public IQueryable<LoanViewModel> SearchForLoanPrepayment(string searchQuery)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            IQueryable<LoanViewModel> allFilteredLoan = null;

            searchQuery = searchQuery.Trim();
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                var loans = (from a in context.TBL_LOAN
                             join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                             join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                             where a.ISDISBURSED == true && a.MATURITYDATE >= DbFunctions.TruncateTime(applicationDate) && a.LOANSTATUSID == (int)LoanStatusEnum.Active
                             select new LoanViewModel
                             {
                                 loanId = a.TERMLOANID,
                                 customerId = a.CUSTOMERID,
                                 customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                 firstName = b.FIRSTNAME,
                                 lastName = b.LASTNAME,
                                 loanReviewApplicationId = (a.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select c.LOANREVIEWAPPLICATIONID).FirstOrDefault() :
                                                     (a.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select c.LOANREVIEWAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select c.LOANREVIEWAPPLICATIONID).FirstOrDefault(),

                                 customerCode = b.CUSTOMERCODE,
                                 productAccountName = c.PRODUCTACCOUNTNAME,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 principalAmount = a.PRINCIPALAMOUNT,
                                 loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                 productName = a.TBL_PRODUCT.PRODUCTNAME,
                                 productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                 currencyId = a.CURRENCYID,
                                 currencyCode = a.TBL_CURRENCY.CURRENCYCODE
                             });

                allFilteredLoan = loans.Where(x => x.loanReferenceNumber.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.customerCode.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.firstName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.lastName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.productAccountName.ToLower().Contains(searchQuery.ToLower()))
                                   .Take(10).AsQueryable();

            }

            return allFilteredLoan;

        }

        public IQueryable<LoanViewModel> LoanPrepaymentApprovalList()
        {
            var applicationDate = generalSetup.GetApplicationDate();
            IQueryable<LoanViewModel> allFilteredLoan = null;

            var loans = (from a in context.TBL_LOAN
                         join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                         join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                         where a.ISDISBURSED == true && a.LOANSTATUSID == (int)LoanStatusEnum.Active
                                                     && a.MATURITYDATE >= DbFunctions.TruncateTime(applicationDate)
                         select new LoanViewModel
                         {
                             loanId = a.TERMLOANID,
                             customerId = a.CUSTOMERID,
                             customerName = b.FIRSTNAME + " " + b.LASTNAME,
                             firstName = b.FIRSTNAME,
                             lastName = b.LASTNAME,
                             loanReviewApplicationId = (a.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select c.LOANREVIEWAPPLICATIONID).FirstOrDefault() :
                                                     (a.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select c.LOANREVIEWAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select c.LOANREVIEWAPPLICATIONID).FirstOrDefault(),

                             applicationReferenceNumber = (a.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join ap in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals ap.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select ap.APPLICATIONREFERENCENUMBER).FirstOrDefault() :
                                                     (a.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join ap in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals ap.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select ap.APPLICATIONREFERENCENUMBER).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join ap in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals ap.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select ap.APPLICATIONREFERENCENUMBER).FirstOrDefault(),
                             dateTimeCreated = (a.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join ap in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals ap.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select c.DATETIMECREATED).FirstOrDefault() :
                                                     (a.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join ap in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals ap.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select c.DATETIMECREATED).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join ap in context.TBL_LMSR_APPLICATION on c.LOANAPPLICATIONID equals ap.LOANAPPLICATIONID where c.LOANID == a.TERMLOANID select c.DATETIMECREATED).FirstOrDefault(),

                             customerCode = b.CUSTOMERCODE,
                             productAccountName = c.PRODUCTACCOUNTNAME,
                             loanReferenceNumber = a.LOANREFERENCENUMBER,
                             principalAmount = a.PRINCIPALAMOUNT,
                             loanSystemTypeId = a.LOANSYSTEMTYPEID,
                             productName = a.TBL_PRODUCT.PRODUCTNAME,
                             productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                             currencyId = a.CURRENCYID,
                             currencyCode = a.TBL_CURRENCY.CURRENCYCODE
                         })?.ToList();

            allFilteredLoan = loans.AsQueryable();
            return allFilteredLoan;

        }

        public List<LoanViewModel> GetApprovedLoanReviewAwaitingOperation(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            //var activities = admin.GetUserActivitiesByUser(staffId);
            // var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId ).Select(x => x).FirstOrDefault().CURRENCYID;
            UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);

            //var ids = generalSetup.GetStaffApprovalLevelIds(staffId, 0).ToList();
            var lmsOperations = context.TBL_OPERATIONS.Where(c => c.OPERATIONTYPEID == (short)OperationTypeEnum.LoanManagement
                && (c.PRODUCTTYPEID == 1 || c.PRODUCTTYPEID == null))
                .Select(x => x.OPERATIONID).ToList();


            List<int> ids = new List<int>(); //generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.LmsOperations).ToList();
            foreach (var i in lmsOperations)
            {
                ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, i).ToList());
            }

            var allFilteredLoan = (from a in context.TBL_LOAN
                                   join b in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals b.LOANID
                                   join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                   join atrail in context.TBL_APPROVAL_TRAIL on b.LOANREVIEWAPPLICATIONID equals atrail.TARGETID
                                   join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                   where //b.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                   b.OPERATIONPERFORMED == false
                                   && (a.OPERATIONID != (short)OperationsEnum.CommercialLoanBooking)
                                   && (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                                   && lmsOperations.Contains(atrail.OPERATIONID) //== (short)OperationsEnum.LmsOperations
                                   && (ids.Contains((int)atrail.TOAPPROVALLEVELID) || atrail.REQUESTSTAFFID == staffId)
                                   && atrail.RESPONSESTAFFID == null //&& b.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                   && ((cf.CanSeeLocalCurrency && a.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && a.CURRENCYID != cf.DefaultCurrencyId))
                                   orderby b.DATETIMECREATED descending
                                   select new LoanViewModel
                                   {

                                       loanReviewApplicationId = e.LOANAPPLICATIONID,
                                       loanId = a.TERMLOANID,
                                       customerId = a.CUSTOMERID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                       productId = a.PRODUCTID,
                                       companyId = a.COMPANYID,
                                       casaAccountId = a.CASAACCOUNTID,
                                       branchId = a.BRANCHID,
                                       branchName = a.TBL_BRANCH.BRANCHNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                       pricipalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                       interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                       interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                       principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                       interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                       relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                       relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                       relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                       relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                       misCode = a.MISCODE,
                                       teamMiscode = a.TEAMMISCODE,
                                       interestRate = a.INTERESTRATE,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       bookingDate = a.BOOKINGDATE,
                                       principalAmount = a.PRINCIPALAMOUNT,
                                       principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                       interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                       approvalStatusId = a.APPROVALSTATUSID,
                                       approvedBy = a.APPROVEDBY,
                                       approverComment = a.APPROVERCOMMENT,
                                       dateApproved = a.DATEAPPROVED,
                                       loanStatusId = a.LOANSTATUSID,
                                       scheduleTypeId = a.SCHEDULETYPEID,
                                       scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                       isDisbursed = a.ISDISBURSED,
                                       disbursedBy = a.DISBURSEDBY,
                                       disburserComment = a.DISBURSERCOMMENT,
                                       disburseDate = a.DISBURSEDATE,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                       //approvedAmount = a.ApprovedAmount,
                                       operationId = b.OPERATIONID,

                                       appraisalOperationId = e.OPERATIONID,
                                       appraisalApplicationId = e.LOANAPPLICATIONID,
                                       appraisalCustomerId = e.CUSTOMERID,
                                       appraisalGroupCustomerId = e.CUSTOMERGROUPID,
                                       appraisalLoanReviewApplicationId = b.LOANREVIEWAPPLICATIONID,
                                       appraisalApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,

                                       operationName = b.TBL_OPERATIONS.OPERATIONNAME, //context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                       subSectorName = a.TBL_SUB_SECTOR.NAME,
                                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                       casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                       productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                       customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                       loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       equityContribution = a.EQUITYCONTRIBUTION,
                                       firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                       firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                       outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                       outstandingInterest = a.OUTSTANDINGINTEREST,
                                       principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                       principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                       fixedPrincipal = a.FIXEDPRINCIPAL,
                                       profileLoan = a.PROFILELOAN,
                                       dischargeLetter = a.DISCHARGELETTER,
                                       suspendInterest = a.SUSPENDINTEREST,
                                       customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                       createdBy = a.CREATEDBY,
                                       dateTimeCreated = a.DATETIMECREATED,
                                       isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                       exchangeRate = a.EXCHANGERATE,
                                       currencyId = a.CURRENCYID,
                                       currency = a.TBL_CURRENCY.CURRENCYNAME,
                                       loanReviewOperationTypeId = b.OPERATIONID,
                                       reviewDetails = b.REVIEWDETAILS,
                                       interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                       interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                       pastDueInterest = a.PASTDUEINTEREST,
                                       pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                       //accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.TERMLOANID && x.DATE == applicationDate).Select(x => x.ACCRUEDINTEREST).FirstOrDefault(),  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                       accrualedAmount = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == a.LOANREFERENCENUMBER && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan && x.REPAYMENTPOSTEDSTATUS == false).Sum(x => x.DAILYACCURALAMOUNT),
                                       systemCurrentDate = applicationDate,
                                       lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                       timeIn = atrail.SYSTEMARRIVALDATETIME,
                                       responsiblePerson = context.TBL_STAFF
                                                   .Where(s => s.STAFFID == atrail.TOSTAFFID)
                                                   .Select(s => new { name = s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME })
                                                   .FirstOrDefault().name ?? "",
                                       operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.TERMLOANID && m.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                       {
                                           loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                           operationTypeId = op.OPERATIONTYPEID,
                                           operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                           newEffectiveDate = op.EFFECTIVEDATE,
                                           reviewDetails = op.REVIEWDETAILS,
                                           prepayment = op.PREPAYMENT,
                                           newInterateRate = op.INTERATERATE,
                                           newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                           newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                           newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                           newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newTenor = op.TENOR,
                                           cASA_AccountId = op.CASA_ACCOUNTID,
                                           cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                           overDraftTopup = op.OVERDRAFTTOPUP,
                                           fee_Charges = op.FEE_CHARGES,
                                           scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                           scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                           scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                           scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                           scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                           newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                           newMaturityDate = op.MATURITYDATE,
                                           dateTimeCreated = op.DATECREATED
                                       }).FirstOrDefault(),
                                   }).ToList();
            // var overdraft = GetLoanReviewApplicationOverDraftRouteAndOperations(staffId, companyId);
            //return allFilteredLoan.Union(overdraft).ToList();

            return allFilteredLoan.ToList();
        }


        //public List<LoanViewModel> GetApprovedLoanReviewAwaitingOperation(int staffId, int companyId)
        //{
        //    var applicationDate = generalSetup.GetApplicationDate();
        //    //var activities = admin.GetUserActivitiesByUser(staffId);
        //    // var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId ).Select(x => x).FirstOrDefault().CURRENCYID;
        //    UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);

        //    //var ids = generalSetup.GetStaffApprovalLevelIds(staffId, 0).ToList();
        //    var ids = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.LmsOperations).ToList();

        //    var allFilteredLoan = (from a in context.TBL_LOAN
        //                           join b in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals b.LOANID
        //                           join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
        //                           join atrail in context.TBL_APPROVAL_TRAIL on b.LOANREVIEWAPPLICATIONID equals atrail.TARGETID
        //                           join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
        //                           where //b.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
        //                           b.OPERATIONPERFORMED == false
        //                           && (a.OPERATIONID != (short)OperationsEnum.CommercialLoanBooking)
        //                           && (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
        //                           && atrail.OPERATIONID == (short)OperationsEnum.LmsOperations
        //                           && (ids.Contains((int)atrail.TOAPPROVALLEVELID) || atrail.REQUESTSTAFFID == staffId)
        //                           && atrail.RESPONSESTAFFID == null //&& b.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
        //                           && ((cf.CanSeeLocalCurrency && a.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && a.CURRENCYID != cf.DefaultCurrencyId))
        //                           orderby b.DATETIMECREATED descending
        //                           select new LoanViewModel
        //                           {

        //                               loanReviewApplicationId = e.LOANAPPLICATIONID,
        //                               loanId = a.TERMLOANID,
        //                               customerId = a.CUSTOMERID,
        //                               customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
        //                               customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
        //                               productId = a.PRODUCTID,
        //                               companyId = a.COMPANYID,
        //                               casaAccountId = a.CASAACCOUNTID,
        //                               branchId = a.BRANCHID,
        //                               branchName = a.TBL_BRANCH.BRANCHNAME,
        //                               loanReferenceNumber = a.LOANREFERENCENUMBER,
        //                               lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
        //                               applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
        //                               principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
        //                               pricipalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
        //                               interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
        //                               interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
        //                               productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
        //                               productName = a.TBL_PRODUCT.PRODUCTNAME,
        //                               productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
        //                               principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
        //                               interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
        //                               relationshipOfficerId = a.RELATIONSHIPOFFICERID,
        //                               relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
        //                               relationshipManagerId = a.RELATIONSHIPMANAGERID,
        //                               relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
        //                               misCode = a.MISCODE,
        //                               teamMiscode = a.TEAMMISCODE,
        //                               interestRate = a.INTERESTRATE,
        //                               effectiveDate = a.EFFECTIVEDATE,
        //                               maturityDate = a.MATURITYDATE,
        //                               bookingDate = a.BOOKINGDATE,
        //                               principalAmount = a.PRINCIPALAMOUNT,
        //                               principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
        //                               interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
        //                               approvalStatusId = a.APPROVALSTATUSID,
        //                               approvedBy = a.APPROVEDBY,
        //                               approverComment = a.APPROVERCOMMENT,
        //                               dateApproved = a.DATEAPPROVED,
        //                               loanStatusId = a.LOANSTATUSID,
        //                               scheduleTypeId = a.SCHEDULETYPEID,
        //                               scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
        //                               isDisbursed = a.ISDISBURSED,
        //                               disbursedBy = a.DISBURSEDBY,
        //                               disburserComment = a.DISBURSERCOMMENT,
        //                               disburseDate = a.DISBURSEDATE,
        //                               loanSystemTypeId = a.LOANSYSTEMTYPEID,
        //                               //approvedAmount = a.ApprovedAmount,
        //                               operationId = b.OPERATIONID,
        //                               operationName = b.TBL_OPERATIONS.OPERATIONNAME, //context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
        //                               subSectorName = a.TBL_SUB_SECTOR.NAME,
        //                               sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
        //                               casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
        //                               productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
        //                               customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
        //                               loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
        //                               loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
        //                               equityContribution = a.EQUITYCONTRIBUTION,
        //                               firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
        //                               firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
        //                               outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
        //                               outstandingInterest = a.OUTSTANDINGINTEREST,
        //                               principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
        //                               principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
        //                               fixedPrincipal = a.FIXEDPRINCIPAL,
        //                               profileLoan = a.PROFILELOAN,
        //                               dischargeLetter = a.DISCHARGELETTER,
        //                               suspendInterest = a.SUSPENDINTEREST,
        //                               customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
        //                               createdBy = a.CREATEDBY,
        //                               dateTimeCreated = a.DATETIMECREATED,
        //                               isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
        //                               exchangeRate = a.EXCHANGERATE,
        //                               currencyId = a.CURRENCYID,
        //                               currency = a.TBL_CURRENCY.CURRENCYNAME,
        //                               loanReviewOperationTypeId = b.OPERATIONID,
        //                               reviewDetails = b.REVIEWDETAILS,
        //                               interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
        //                               interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
        //                               pastDueInterest = a.PASTDUEINTEREST,
        //                               pastDuePrincipal = a.PASTDUEPRINCIPAL,
        //                               //accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.TERMLOANID && x.DATE == applicationDate).Select(x => x.ACCRUEDINTEREST).FirstOrDefault(),  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
        //                               accrualedAmount = context.TBL_DAILY_ACCRUAL.Where(x => x.REFERENCENUMBER == a.LOANREFERENCENUMBER && x.CATEGORYID == (short)DailyAccrualCategory.TermLoan && x.REPAYMENTPOSTEDSTATUS == false).Sum(x => x.DAILYACCURALAMOUNT),
        //                               systemCurrentDate = applicationDate,
        //                               lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
        //                               timeIn = atrail.SYSTEMARRIVALDATETIME,
        //                               responsiblePerson = context.TBL_STAFF
        //                                           .Where(s => s.STAFFID == atrail.TOSTAFFID)
        //                                           .Select(s => new { name = s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME })
        //                                           .FirstOrDefault().name ?? "",
        //                               operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.TERMLOANID && m.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
        //                               {
        //                                   loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
        //                                   operationTypeId = op.OPERATIONTYPEID,
        //                                   operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
        //                                   newEffectiveDate = op.EFFECTIVEDATE,
        //                                   reviewDetails = op.REVIEWDETAILS,
        //                                   prepayment = op.PREPAYMENT,
        //                                   newInterateRate = op.INTERATERATE,
        //                                   newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
        //                                   newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
        //                                   newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
        //                                   newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
        //                                   newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
        //                                   newTenor = op.TENOR,
        //                                   cASA_AccountId = op.CASA_ACCOUNTID,
        //                                   cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
        //                                   overDraftTopup = op.OVERDRAFTTOPUP,
        //                                   fee_Charges = op.FEE_CHARGES,
        //                                   scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
        //                                   scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
        //                                   scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
        //                                   scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
        //                                   scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
        //                                   newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
        //                                   newMaturityDate = op.MATURITYDATE,
        //                                   dateTimeCreated = op.DATECREATED
        //                               }).FirstOrDefault(),
        //                           }).ToList();
        //    var overdraft = GetLoanReviewApplicationOverDraftRouteAndOperations(staffId, companyId);
        //    return allFilteredLoan.Union(overdraft).ToList();
        //}


        public IQueryable<LoanViewModel> SearchForLoanInactiveContingent(string searchQuery)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            IQueryable<LoanViewModel> allFilteredLoan = null;

            searchQuery = searchQuery.Trim();
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                var loans = (from a in context.TBL_LOAN_CONTINGENT
                             join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                             join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                             where a.LOANSTATUSID == (int)LoanStatusEnum.Inactive
                             select new LoanViewModel
                             {
                                 loanId = a.CONTINGENTLOANID,
                                 customerId = a.CUSTOMERID,
                                 customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                 firstName = b.FIRSTNAME,
                                 lastName = b.LASTNAME,
                                 customerCode = b.CUSTOMERCODE,
                                 productAccountName = c.PRODUCTACCOUNTNAME,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 principalAmount = a.CONTINGENTAMOUNT,
                                 loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                 productName = a.TBL_PRODUCT.PRODUCTNAME,
                                 productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                 currencyId = a.CURRENCYID,
                                 currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                 systemCurrentDate = applicationDate,
                             });

                allFilteredLoan = loans.Where(x => x.loanReferenceNumber.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.customerCode.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.firstName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.lastName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.productAccountName.ToLower().Contains(searchQuery.ToLower()))
                                   .Take(10).AsQueryable();
                var test = loans.Where(x => x.loanReferenceNumber.Contains(searchQuery) ||
                                                   x.customerCode.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.firstName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.lastName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.productAccountName.ToLower().Contains(searchQuery.ToLower()))
                                   .Take(10).ToList();
            }

            return allFilteredLoan;

        }

        public IQueryable<LoanViewModel> SearchForLoanContingent(string searchQuery)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            IQueryable<LoanViewModel> allFilteredLoan = null;
            if (searchQuery != null) searchQuery = searchQuery.Trim();

            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                var loans = (from a in context.TBL_LOAN_CONTINGENT
                             join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                             join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                             where a.ISDISBURSED == true && a.MATURITYDATE >= DbFunctions.TruncateTime(applicationDate) && a.LOANSTATUSID == (int)LoanStatusEnum.Active
                             select new LoanViewModel
                             {
                                 loanId = a.CONTINGENTLOANID,
                                 customerId = a.CUSTOMERID,
                                 customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                 firstName = b.FIRSTNAME,
                                 lastName = b.LASTNAME,
                                 customerCode = b.CUSTOMERCODE,
                                 productAccountName = c.PRODUCTACCOUNTNAME,
                                 loanReferenceNumber = a.LOANREFERENCENUMBER,
                                 principalAmount = a.CONTINGENTAMOUNT,
                                 loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                 productName = a.TBL_PRODUCT.PRODUCTNAME,
                                 productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                 currencyId = a.CURRENCYID,
                                 currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                 systemCurrentDate = applicationDate,
                                 operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.CONTINGENTLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                 {
                                     loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                     operationTypeId = op.OPERATIONTYPEID,
                                     operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                     newEffectiveDate = op.EFFECTIVEDATE,
                                     reviewDetails = op.REVIEWDETAILS,
                                     prepayment = op.PREPAYMENT,
                                     newInterateRate = op.INTERATERATE,
                                     newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                     newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                     newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                     newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                     newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                     newTenor = op.TENOR,
                                     cASA_AccountId = op.CASA_ACCOUNTID,
                                     cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                     overDraftTopup = op.OVERDRAFTTOPUP,
                                     fee_Charges = op.FEE_CHARGES,
                                     scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                     scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                     scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                     scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                     scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                     newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                     newMaturityDate = op.MATURITYDATE,
                                     dateTimeCreated = op.DATECREATED
                                 }).FirstOrDefault(),
                             });

                allFilteredLoan = loans.Where(x => x.loanReferenceNumber.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.customerCode.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.firstName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.lastName.ToLower().Contains(searchQuery.ToLower()) ||
                                                   x.productAccountName.ToLower().Contains(searchQuery.ToLower()))
                                   .Take(10).AsQueryable();

            }

            return allFilteredLoan;

        }
        public IQueryable<LoanViewModel> SearchForFXRevolvingLoan(string searchQuery)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            try
            {
                IQueryable<LoanViewModel> allFilteredLoan = null;
                if (!string.IsNullOrWhiteSpace(searchQuery))
                {
                    searchQuery = searchQuery.ToLower();
                }
                if (!string.IsNullOrWhiteSpace(searchQuery.Trim()))
                {
                    var loans = (from a in context.TBL_LOAN
                                 join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                 join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                 where a.ISDISBURSED == true //&& a.MATURITYDATE >= DbFunctions.TruncateTime(applicationDate)
                                 && a.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving
                                 select new LoanViewModel
                                 {
                                     loanId = a.TERMLOANID,
                                     customerId = a.CUSTOMERID,
                                     customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                     firstName = b.FIRSTNAME,
                                     lastName = b.LASTNAME,
                                     customerCode = b.CUSTOMERCODE,
                                     productAccountName = c.PRODUCTACCOUNTNAME,
                                     loanReferenceNumber = a.LOANREFERENCENUMBER,
                                     principalAmount = a.PRINCIPALAMOUNT,
                                     nostroAccount = a.NOSTROACCOUNTID,
                                     currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                     currency = a.TBL_CURRENCY.CURRENCYNAME,
                                     productName = a.TBL_PRODUCT.PRODUCTNAME,
                                     productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                     casaAccountNumber = c.PRODUCTACCOUNTNUMBER,
                                     productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                     //applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                     //principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                     //pricipalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                     //interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                     //interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                     //productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                     //productName = a.TBL_PRODUCT.PRODUCTNAME,
                                     //productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                     //principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                     //interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                     //relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                     //relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                     //relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                     //relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                     //misCode = a.MISCODE,
                                     //teamMiscode = a.TEAMMISCODE,
                                     //interestRate = a.INTERESTRATE,
                                     //effectiveDate = a.EFFECTIVEDATE,
                                     //maturityDate = a.MATURITYDATE,
                                     //bookingDate = a.BOOKINGDATE,

                                     //principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                     //interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                     //approvalStatusId = a.APPROVALSTATUSID,
                                     //approvedBy = a.APPROVEDBY,
                                     //approverComment = a.APPROVERCOMMENT,
                                     //dateApproved = a.DATEAPPROVED,
                                     //loanStatusId = a.LOANSTATUSID,
                                     //scheduleTypeId = a.SCHEDULETYPEID,
                                     //scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                     //isDisbursed = a.ISDISBURSED,
                                     //disbursedBy = a.DISBURSEDBY,
                                     //disburserComment = a.DISBURSERCOMMENT,
                                     //disburseDate = a.DISBURSEDATE,
                                     //approvedAmount = a.ApprovedAmount,
                                     //operationId = a.OPERATIONID,
                                     //operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                     //subSectorName = a.TBL_SUB_SECTOR.NAME,
                                     //sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                     //casaAccountNumber = c.PRODUCTACCOUNTNUMBER,
                                     //customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                     //loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                     //loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                     //equityContribution = a.EQUITYCONTRIBUTION,
                                     //firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                     //firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                     //outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                     //outstandingInterest = a.OUTSTANDINGINTEREST,
                                     //principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                     //principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                     //fixedPrincipal = a.FIXEDPRINCIPAL,
                                     //profileLoan = a.PROFILELOAN,
                                     //dischargeLetter = a.DISCHARGELETTER,
                                     //suspendInterest = a.SUSPENDINTEREST,
                                     //customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                     //createdBy = a.CREATEDBY,
                                     //dateTimeCreated = a.DATETIMECREATED,
                                     //isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                     //exchangeRate = a.EXCHANGERATE,
                                     //currencyId = a.CURRENCYID,
                                     //currency = a.TBL_CURRENCY.CURRENCYNAME
                                 });
                    allFilteredLoan = loans.Where(x => x.loanReferenceNumber.ToLower().Contains(searchQuery) || x.customerCode.ToLower().Contains(searchQuery) ||
                                       x.firstName.ToLower().Contains(searchQuery) ||
                                       x.lastName.ToLower().Contains(searchQuery) ||
                                       x.currencyCode.ToLower().Contains(searchQuery) ||
                                       x.casaAccountNumber.ToLower().Contains(searchQuery) ||
                                       x.nostroAccount.ToLower().Contains(searchQuery) ||
                                       x.productAccountName.ToLower().Contains(searchQuery)).Take(10).AsQueryable();
                }
                return allFilteredLoan;
            }
            catch (System.Exception ex)
            {
                throw ex;
            }
        }

        public IQueryable<LoanViewModel> SearchRunningCommercialAndFXLoans(string searchQuery)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            IQueryable<LoanViewModel> allFilteredLoan = null;
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToLower();
            }
            try
            {
                if (!string.IsNullOrWhiteSpace(searchQuery.Trim()))
                {
                    allFilteredLoan = (from a in context.TBL_LOAN
                                       join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                       join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                       where a.ISDISBURSED == true
                                       && ((a.OPERATIONID == (short)OperationsEnum.CommercialLoanBooking) || (a.OPERATIONID == (short)OperationsEnum.ForeignExchangeLoanBooking))
                                       && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                                       && ((a.LOANREFERENCENUMBER.ToLower().Contains(searchQuery.ToLower())) ||
                                            (b.CUSTOMERCODE.ToLower().Contains(searchQuery)) ||
                                            (b.FIRSTNAME.ToLower().Contains(searchQuery)) ||
                                            (b.LASTNAME.ToLower().Contains(searchQuery)) ||
                                            (c.PRODUCTACCOUNTNUMBER.ToLower().Contains(searchQuery)))
                                       select new LoanViewModel
                                       {
                                           loanId = a.TERMLOANID,
                                           customerId = a.CUSTOMERID,
                                           customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                           customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                           currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                           productId = a.PRODUCTID,
                                           companyId = a.COMPANYID,
                                           casaAccountId = a.CASAACCOUNTID,
                                           casaAccountId2 = a.CASAACCOUNTID2,
                                           branchId = a.BRANCHID,
                                           branchName = a.TBL_BRANCH.BRANCHNAME,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                           principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                           principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                           interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                           interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                           productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                           productName = a.TBL_PRODUCT.PRODUCTNAME,
                                           productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                           principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                           interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,

                                           relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                           relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                           relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                           relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                           loanSystemTypeId = (short)a.LOANSYSTEMTYPEID,
                                           misCode = a.MISCODE,
                                           teamMiscode = a.TEAMMISCODE,
                                           interestRate = a.INTERESTRATE,
                                           effectiveDate = a.EFFECTIVEDATE,
                                           maturityDate = a.MATURITYDATE,
                                           systemCurrentDate = applicationDate,
                                           //tenorUsed = (applicationDate - a.EFFECTIVEDATE).Days,
                                           //tenorLeft = (a.MATURITYDATE - applicationDate).Days,
                                           bookingDate = a.BOOKINGDATE,
                                           principalAmount = a.PRINCIPALAMOUNT,
                                           principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                           interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                           approvalStatusId = a.APPROVALSTATUSID,
                                           approvedBy = a.APPROVEDBY,
                                           approverComment = a.APPROVERCOMMENT,
                                           dateApproved = a.DATEAPPROVED,
                                           loanStatusId = a.LOANSTATUSID,
                                           scheduleTypeId = a.SCHEDULETYPEID,
                                           scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                           isDisbursed = a.ISDISBURSED,
                                           disbursedBy = a.DISBURSEDBY,
                                           disburserComment = a.DISBURSERCOMMENT,
                                           disburseDate = a.DISBURSEDATE,
                                           //approvedAmount = a.ApprovedAmount,
                                           operationId = a.OPERATIONID,
                                           // operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                           subSectorName = a.TBL_SUB_SECTOR.NAME,
                                           sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                           casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                           productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                           customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                           loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                           loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                           equityContribution = a.EQUITYCONTRIBUTION,
                                           firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                           firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                           outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                           outstandingInterest = a.OUTSTANDINGINTEREST,
                                           principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                           principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                           fixedPrincipal = a.FIXEDPRINCIPAL,
                                           profileLoan = a.PROFILELOAN,
                                           dischargeLetter = a.DISCHARGELETTER,
                                           suspendInterest = a.SUSPENDINTEREST,
                                           customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                           createdBy = a.CREATEDBY,
                                           dateTimeCreated = a.DATETIMECREATED,
                                           isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                           exchangeRate = a.EXCHANGERATE,
                                           currencyId = a.CURRENCYID,
                                           currency = a.TBL_CURRENCY.CURRENCYNAME,
                                           // tenorUsed = (applicationDate - a.MATURITYDATE).Days
                                       }).Take(10).AsQueryable();
                }
            }
            catch (Exception ex)
            {
                throw ex;
            }

            foreach (var i in allFilteredLoan)
            {
                var casa2 = context.TBL_CASA.Find(i.casaAccountId2);
                if (casa2 != null)
                    i.payingAccountNumber = casa2.PRODUCTACCOUNTNUMBER;

                var tenorUsed = (applicationDate - i.maturityDate).Days;
                i.tenorUsed = tenorUsed;
            }

            return allFilteredLoan;

        }

        public IEnumerable<LoanViewModel> GetLoanReviewApplicationOverDraft(int staffId, int companyId)
        {
            try
            {
                //var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONTYPEID == (short)OperationTypeEnum.LoanManagement).Select(c => c.OPERATIONID).ToList();
                //List<int> ids = new List<int>();

                //foreach (var operationId in operationIds)
                //{
                //    ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
                //}
                var staffs = generalSetup.GetStaffRlieved(staffId);

                var activities = admin.GetUserActivitiesByUser(staffId);
                var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

                var operationsRecords = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.OverdraftFacility).Select(x => x.LOANREVIEWAPPLICATIONID).ToList();

                var currentDate = generalSetup.GetApplicationDate();
                var allFilteredLoan = (from a in context.TBL_LOAN_REVOLVING
                                       join b in context.TBL_LMSR_APPLICATION_DETAIL on a.REVOLVINGLOANID equals b.LOANID
                                       join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                       join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                       where a.ISDISBURSED == true
                                       && !operationsRecords.Contains(b.LOANREVIEWAPPLICATIONID) 
                                       //b.TBL_OPERATIONS.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagementOverdraft 
                                       && b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.OverdraftFacility
                                       && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                       && b.OPERATIONPERFORMED == false
                                       && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationCompleted
                                       && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationInProgress
                                       //orderby b.DATECREATED descending
                                       select new LoanViewModel
                                       {
                                           creditAppraisalOperationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                                     (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault(),


                                           creditAppraisalLoanApplicationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault(),
                                           appraisalOperationName = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == e.OPERATIONID).Select(o => o.OPERATIONNAME).FirstOrDefault(),

                                           divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == c.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                           divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                           loanReviewApplicationId = e.LOANAPPLICATIONID,
                                           loanId = a.REVOLVINGLOANID,
                                           customerId = a.CUSTOMERID,
                                           customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                           applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                           loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                           interestRate = a.INTERESTRATE,
                                           principalAmount = a.OVERDRAFTLIMIT,
                                           effectiveDate = a.EFFECTIVEDATE,
                                           maturityDate = a.MATURITYDATE,
                                           operationId = b.OPERATIONID,
                                           operationName = b.TBL_OPERATIONS.OPERATIONNAME,
                                           loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                           systemCurrentDate = currentDate,
                                           lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                           loanSystemTypeId = b.LOANSYSTEMTYPEID,
                                           operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.REVOLVINGLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                           {
                                               loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                               operationTypeId = op.OPERATIONTYPEID,
                                               operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                               newEffectiveDate = op.EFFECTIVEDATE,
                                               reviewDetails = op.REVIEWDETAILS,
                                               prepayment = op.PREPAYMENT,
                                               newInterateRate = op.INTERATERATE,
                                               newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                               newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                               newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                               newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                               newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                               newTenor = op.TENOR,
                                               cASA_AccountId = op.CASA_ACCOUNTID,
                                               cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                               overDraftTopup = op.OVERDRAFTTOPUP,
                                               fee_Charges = op.FEE_CHARGES,
                                               scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                               scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                               scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                               scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                               scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                               newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                               newMaturityDate = op.MATURITYDATE,
                                               dateTimeCreated = op.DATECREATED
                                           }).FirstOrDefault(),
                                       }).ToList();

                var referred = (from a in context.TBL_LOAN_REVOLVING
                                join op in context.TBL_LOAN_REVIEW_OPERATION on a.REVOLVINGLOANID equals op.LOANID
                                join b in context.TBL_LMSR_APPLICATION_DETAIL on a.REVOLVINGLOANID equals b.LOANID
                                join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                                join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                where a.ISDISBURSED == true
                                && b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.OverdraftFacility
                                && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                && atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                                && atrail.OPERATIONID == op.OPERATIONTYPEID
                                && atrail.RESPONSESTAFFID == null 
                                && atrail.APPROVALSTATEID != (int)ApprovalState.Ended
                                && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                && op.OPERATIONCOMPLETED == false
                                && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationCompleted
                                && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationInProgress
                                && (staffs.Contains(atrail.LOOPEDSTAFFID ?? 0))
                                select new LoanViewModel
                                {
                                    creditAppraisalOperationId = (from l in context.TBL_LOAN_APPLICATION_DETAIL join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where a.LOANAPPLICATIONDETAILID == l.LOANAPPLICATIONDETAILID select aa.OPERATIONID).FirstOrDefault(),

                                    creditAppraisalLoanApplicationId = (from l in context.TBL_LOAN_APPLICATION_DETAIL join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where a.LOANAPPLICATIONDETAILID == l.LOANAPPLICATIONDETAILID select aa.LOANAPPLICATIONID).FirstOrDefault(),

                                    appraisalOperationName = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == e.OPERATIONID).Select(o => o.OPERATIONNAME).FirstOrDefault(),

                                    divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == c.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                    divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                    loanReviewApplicationId = e.LOANAPPLICATIONID,
                                    loanId = a.REVOLVINGLOANID,
                                    customerId = a.CUSTOMERID,
                                    customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                    loanReferenceNumber = a.LOANREFERENCENUMBER,
                                    lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                    applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                    loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                    interestRate = a.INTERESTRATE,
                                    principalAmount = a.OVERDRAFTLIMIT,
                                    effectiveDate = a.EFFECTIVEDATE,
                                    maturityDate = a.MATURITYDATE,
                                    operationId = b.OPERATIONID,
                                    operationName = b.TBL_OPERATIONS.OPERATIONNAME,
                                    loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                    systemCurrentDate = currentDate,
                                    lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                    loanSystemTypeId = b.LOANSYSTEMTYPEID,
                                    operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.REVOLVINGLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                    {
                                        loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                        operationTypeId = op.OPERATIONTYPEID,
                                        operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                        newEffectiveDate = op.EFFECTIVEDATE,
                                        reviewDetails = op.REVIEWDETAILS,
                                        prepayment = op.PREPAYMENT,
                                        newInterateRate = op.INTERATERATE,
                                        newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                        newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                        newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                        newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                        newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                        newTenor = op.TENOR,
                                        cASA_AccountId = op.CASA_ACCOUNTID,
                                        cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                        overDraftTopup = op.OVERDRAFTTOPUP,
                                        fee_Charges = op.FEE_CHARGES,
                                        scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                        scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                        scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                        scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                        scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                        newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                        newMaturityDate = op.MATURITYDATE,
                                        dateTimeCreated = op.DATECREATED
                                    }).FirstOrDefault(),
                                }).ToList();

                allFilteredLoan = allFilteredLoan.Union(referred).ToList();
                List<LoanViewModel> lcyLoans = new List<LoanViewModel>();
                List<LoanViewModel> fcyLoans = new List<LoanViewModel>();

                var isLCYUser = activities.Contains("lcy-user");
                var isFCYUser = activities.Contains("fcy-user");

                if (isLCYUser == true)
                {
                    lcyLoans = allFilteredLoan.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                    //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
                }

                if (isFCYUser == true)
                {
                    fcyLoans = allFilteredLoan.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

                }

                allFilteredLoan = lcyLoans.Union(fcyLoans).ToList();


                return allFilteredLoan;
            }
            catch (System.Exception ex)
            {
                throw ex;
            }
        }

        public LoanViewModel GetOverdraftDetailsByLoanId(int revolvingLoanId)
        {
            decimal overDraftLimit = 0;
            decimal availableBalance = 0;
            var odDetail = context.TBL_LOAN_REVOLVING.Where(x => x.REVOLVINGLOANID == revolvingLoanId).Select(x => x).FirstOrDefault();
            if (odDetail != null)
            {
                overDraftLimit = odDetail.OVERDRAFTLIMIT;
                //availableBalance = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == odDetail.CASAACCOUNTID).AVAILABLEBALANCE;
                availableBalance = transRepo.GetCASABalance(odDetail.CASAACCOUNTID).availableBalance;
            }
            //var overDraftDetail = (from a in context.TBL_LOAN_REVOLVING
            //                       join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
            //                       join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
            //                       where a.REVOLVINGLOANID == revolvingLoanId
            //                       select new LoanViewModel
            //                       {
            //                           loanId = a.REVOLVINGLOANID,
            //                           customerId = a.CUSTOMERID,
            //                           customerName = b.FIRSTNAME + " " + b.LASTNAME,
            //                           customerCode = b.CUSTOMERCODE,
            //                           productId = a.PRODUCTID,
            //                           companyId = a.COMPANYID,
            //                           casaAccountId = a.CASAACCOUNTID,
            //                           branchId = a.BRANCHID,
            //                           branchName = a.TBL_BRANCH.BRANCHNAME,
            //                           loanReferenceNumber = a.LOANREFERENCENUMBER,
            //                           //applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
            //                           //loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
            //                           //productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
            //                           //productName = a.TBL_PRODUCT.PRODUCTNAME,
            //                           //productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
            //                           //relationshipOfficerId = a.RELATIONSHIPOFFICERID,
            //                           //relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
            //                           //relationshipManagerId = a.RELATIONSHIPMANAGERID,
            //                           //relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
            //                           //misCode = a.MISCODE,
            //                           //teamMiscode = a.TEAMMISCODE,
            //                           //interestRate = a.INTERESTRATE,
            //                           //effectiveDate = a.EFFECTIVEDATE,
            //                           //maturityDate = a.MATURITYDATE,
            //                           //bookingDate = a.BOOKINGDATE,
            //                           //principalAmount = a.OVERDRAFTLIMIT,
            //                           //approvalStatusId = a.APPROVALSTATUSID,
            //                           //approverComment = a.APPROVERCOMMENT,
            //                           //dateApproved = a.DATEAPPROVED,
            //                           //loanStatusId = a.LOANSTATUSID,
            //                           //isDisbursed = a.ISDISBURSED,
            //                           //disburserComment = a.DISBURSERCOMMENT,
            //                           //disburseDate = a.DISBURSEDATE,
            //                           //operationId = a.OPERATIONID,
            //                           //operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
            //                           //subSectorName = a.TBL_SUB_SECTOR.NAME,
            //                           //sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
            //                           //casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
            //                           //productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
            //                           //customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
            //                           //loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
            //                           //loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
            //                           outstandingPrincipal = availableBalance,
            //                           dischargeLetter = a.DISCHARGELETTER,
            //                           suspendInterest = a.SUSPENDINTEREST,
            //                           customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
            //                           createdBy = a.CREATEDBY,
            //                           dateTimeCreated = a.DATETIMECREATED,
            //                           exchangeRate = a.EXCHANGERATE,
            //                           currencyId = a.CURRENCYID,
            //                           currency = a.TBL_CURRENCY.CURRENCYNAME,
            //                       }).FirstOrDefault();

            var overDraftDetail = (from a in context.TBL_LOAN_REVOLVING
                                   join tt in context.TBL_OPERATIONS on a.OPERATIONID equals tt.OPERATIONID
                                   join br in context.TBL_BRANCH on a.BRANCHID equals br.BRANCHID
                                   join ld in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                   join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                   join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   join pr in context.TBL_PRODUCT on a.PRODUCTID equals pr.PRODUCTID
                                   join st in context.TBL_STAFF on a.RELATIONSHIPOFFICERID equals st.STAFFID
                                   join stm in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals stm.STAFFID
                                   where a.REVOLVINGLOANID == revolvingLoanId
                                   select new LoanViewModel
                                   {
                                       loanId = a.REVOLVINGLOANID,
                                       customerId = a.CUSTOMERID,
                                       customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                       customerCode = b.CUSTOMERCODE,
                                       productId = a.PRODUCTID,
                                       companyId = a.COMPANYID,
                                       casaAccountId = a.CASAACCOUNTID,
                                       branchId = a.BRANCHID,
                                       branchName = br.BRANCHNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = lp.LOANAPPLICATIONID,
                                       productTypeId = pr.PRODUCTTYPEID,
                                       productName = pr.PRODUCTNAME,
                                       productTypeName = pr.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                       relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                       relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                       relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                       relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                       misCode = a.MISCODE,
                                       teamMiscode = a.TEAMMISCODE,
                                       interestRate = a.INTERESTRATE,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       bookingDate = a.BOOKINGDATE,
                                       principalAmount = a.OVERDRAFTLIMIT,
                                       approvalStatusId = a.APPROVALSTATUSID,
                                       approverComment = a.APPROVERCOMMENT,
                                       dateApproved = a.DATEAPPROVED,
                                       loanStatusId = a.LOANSTATUSID,
                                       isDisbursed = a.ISDISBURSED,
                                       disburserComment = a.DISBURSERCOMMENT,
                                       disburseDate = a.DISBURSEDATE,
                                       operationId = a.OPERATIONID,
                                       operationName = tt.OPERATIONNAME,
                                       subSectorName = a.TBL_SUB_SECTOR.NAME,
                                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                       casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                       productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                       customerGroupId = lp.CUSTOMERGROUPID,
                                       loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                       loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                       outstandingPrincipal = availableBalance,
                                       dischargeLetter = a.DISCHARGELETTER,
                                       suspendInterest = a.SUSPENDINTEREST,
                                       customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                       createdBy = a.CREATEDBY,
                                       dateTimeCreated = a.DATETIMECREATED,
                                       exchangeRate = a.EXCHANGERATE,
                                       currencyId = a.CURRENCYID,
                                       currency = a.TBL_CURRENCY.CURRENCYNAME,
                                   }).FirstOrDefault();

            overDraftDetail.availableBalance = availableBalance;

            if (availableBalance >= 0)
            {
                overDraftDetail.overdraftUndrawnAmount = overDraftLimit;
                overDraftDetail.overdraftDrawnAmount = 0;
            }
            else
            {
                //overDraftDetail.overDraft = overDraftLimit - Math.Abs(availableBalance);
                overDraftDetail.overdraftUndrawnAmount = overDraftLimit - Math.Abs(availableBalance);
                overDraftDetail.overdraftDrawnAmount = Math.Abs(availableBalance);
            }

            return overDraftDetail;

        }

        public IEnumerable<LoanViewModel> GetApprovedLoanReviewRemedial(int userId, int companyId)
        {

            List<LoanViewModel> _loanViewModel = new List<LoanViewModel>();


            try
            {

                var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
                var activities = admin.GetUserActivitiesByUser(userId);
                var applicationDate = generalSetup.GetApplicationDate();
                var allFilteredLoan = new List<LoanViewModel>();
                if (activities.Contains("loan-sale-user"))
                {
                    allFilteredLoan = (from a in context.TBL_LOAN
                                       join b in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals b.LOANID
                                       join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                       join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                       //join d in context.TBL_LOAN_SCHEDULE_DAILY on a.TERMLOANID equals d.LOANID
                                       //join f in context.TBL_LOAN_CAMSOL on a.TERMLOANID equals f.LOANID
                                       where a.ISDISBURSED == true && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                       //&& b.TBL_OPERATIONS.OPERATIONID == (int)OperationsEnum.LoanSales
                                       && (b.TBL_OPERATIONS.OPERATIONID == (int)OperationsEnum.LoanRecovery || b.TBL_OPERATIONS.OPERATIONID == (int)OperationsEnum.LoanRecoveryApproval)
                                       && b.OPERATIONPERFORMED == false
                                       //&& d.DATE == DbFunctions.TruncateTime(applicationDate)
                                       //orderby b.DATECREATED descending
                                       select new LoanViewModel
                                       {
                                           divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == c.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                           divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                           lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                           loanId = a.TERMLOANID,
                                           customerId = a.CUSTOMERID,
                                           customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                           customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                           productId = a.PRODUCTID,
                                           companyId = a.COMPANYID,
                                           casaAccountId = a.CASAACCOUNTID,
                                           branchId = a.BRANCHID,
                                           branchName = a.TBL_BRANCH.BRANCHNAME,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                           principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                           principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                           interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                           interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                           productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                           productName = a.TBL_PRODUCT.PRODUCTNAME,
                                           productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                           principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                           interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,

                                           relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                           relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                           relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                           relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,

                                           misCode = a.MISCODE,
                                           teamMiscode = a.TEAMMISCODE,
                                           interestRate = a.INTERESTRATE,
                                           effectiveDate = a.EFFECTIVEDATE,
                                           maturityDate = a.MATURITYDATE,
                                           bookingDate = a.BOOKINGDATE,
                                           principalAmount = a.PRINCIPALAMOUNT,
                                           principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                           interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                           approvalStatusId = a.APPROVALSTATUSID,
                                           approvedBy = a.APPROVEDBY,
                                           approverComment = a.APPROVERCOMMENT,
                                           dateApproved = a.DATEAPPROVED,
                                           loanStatusId = a.LOANSTATUSID,
                                           scheduleTypeId = a.SCHEDULETYPEID,
                                           scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                           isDisbursed = a.ISDISBURSED,
                                           disbursedBy = a.DISBURSEDBY,
                                           disburserComment = a.DISBURSERCOMMENT,
                                           disburseDate = a.DISBURSEDATE,
                                           //approvedAmount = a.ApprovedAmount,
                                           operationId = a.OPERATIONID,
                                           operationName = b.TBL_OPERATIONS.OPERATIONNAME, //context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                           subSectorName = a.TBL_SUB_SECTOR.NAME,
                                           sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                           casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                           productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                           customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                           loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                           loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                           equityContribution = a.EQUITYCONTRIBUTION,
                                           firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                           firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                           outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                           outstandingInterest = a.OUTSTANDINGINTEREST,
                                           principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                           principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                           fixedPrincipal = a.FIXEDPRINCIPAL,
                                           profileLoan = a.PROFILELOAN,
                                           dischargeLetter = a.DISCHARGELETTER,
                                           suspendInterest = a.SUSPENDINTEREST,
                                           customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                           createdBy = a.CREATEDBY,
                                           dateTimeCreated = a.DATETIMECREATED,
                                           isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                           exchangeRate = a.EXCHANGERATE,
                                           currencyId = a.CURRENCYID,
                                           currency = a.TBL_CURRENCY.CURRENCYNAME,
                                           loanReviewOperationTypeId = b.OPERATIONID,
                                           reviewDetails = b.REVIEWDETAILS,
                                           interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                           interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                           pastDueInterest = a.PASTDUEINTEREST,
                                           lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                           userActivity = "loan-sale-user"
                                           //accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.FirstOrDefault(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).ACCRUEDINTEREST
                                       }).ToList();
                }
                else
                {
                    allFilteredLoan = (from a in context.TBL_LOAN
                                       join b in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals b.LOANID
                                       join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                       join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                       //join d in context.TBL_LOAN_SCHEDULE_DAILY on a.TERMLOANID equals d.LOANID
                                       join f in context.TBL_LOAN_CAMSOL on a.TERMLOANID equals f.LOANID
                                       where a.ISDISBURSED == true && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                      && b.TBL_OPERATIONS.OPERATIONID == (int)OperationsEnum.LoanRecovery
                                      && b.OPERATIONPERFORMED == false && a.LOANSTATUSID == (short)LoanStatusEnum.WriteOff
                                       //&& d.DATE == DbFunctions.TruncateTime(applicationDate)
                                       //orderby b.DATECREATED descending
                                       select new LoanViewModel
                                       {

                                           loanId = a.TERMLOANID,
                                           customerId = a.CUSTOMERID,
                                           customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                           customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                           productId = a.PRODUCTID,
                                           companyId = a.COMPANYID,
                                           casaAccountId = a.CASAACCOUNTID,
                                           branchId = a.BRANCHID,
                                           branchName = a.TBL_BRANCH.BRANCHNAME,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                           principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                           principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                           interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                           interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                           productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                           productName = a.TBL_PRODUCT.PRODUCTNAME,
                                           productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                           principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                           interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,

                                           relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                           relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                           relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                           relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,

                                           misCode = a.MISCODE,
                                           teamMiscode = a.TEAMMISCODE,
                                           interestRate = a.INTERESTRATE,
                                           effectiveDate = a.EFFECTIVEDATE,
                                           maturityDate = a.MATURITYDATE,
                                           bookingDate = a.BOOKINGDATE,
                                           principalAmount = a.PRINCIPALAMOUNT,
                                           principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                           interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                           approvalStatusId = a.APPROVALSTATUSID,
                                           approvedBy = a.APPROVEDBY,
                                           approverComment = a.APPROVERCOMMENT,
                                           dateApproved = a.DATEAPPROVED,
                                           loanStatusId = a.LOANSTATUSID,
                                           scheduleTypeId = a.SCHEDULETYPEID,
                                           scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                           isDisbursed = a.ISDISBURSED,
                                           disbursedBy = a.DISBURSEDBY,
                                           disburserComment = a.DISBURSERCOMMENT,
                                           disburseDate = a.DISBURSEDATE,
                                           //approvedAmount = a.ApprovedAmount,
                                           operationId = a.OPERATIONID,
                                           operationName = b.TBL_OPERATIONS.OPERATIONNAME, //context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                           subSectorName = a.TBL_SUB_SECTOR.NAME,
                                           sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                           casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                           productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                           customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                           loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                           loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                           equityContribution = a.EQUITYCONTRIBUTION,
                                           firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                           firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                           outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                           outstandingInterest = a.OUTSTANDINGINTEREST,
                                           principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                           principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                           fixedPrincipal = a.FIXEDPRINCIPAL,
                                           profileLoan = a.PROFILELOAN,
                                           dischargeLetter = a.DISCHARGELETTER,
                                           suspendInterest = a.SUSPENDINTEREST,
                                           customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                           createdBy = a.CREATEDBY,
                                           dateTimeCreated = a.DATETIMECREATED,
                                           isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                           exchangeRate = a.EXCHANGERATE,
                                           currencyId = a.CURRENCYID,
                                           currency = a.TBL_CURRENCY.CURRENCYNAME,
                                           loanReviewOperationTypeId = b.OPERATIONID,
                                           reviewDetails = b.REVIEWDETAILS,
                                           interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                           interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                           pastDueInterest = a.PASTDUEINTEREST,
                                           lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                           userActivity = "loan-recovery-user"
                                           //accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.FirstOrDefault(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).ACCRUEDINTEREST
                                       }).ToList();
                }

                List<LoanViewModel> lcyLoans = new List<LoanViewModel>();
                List<LoanViewModel> fcyLoans = new List<LoanViewModel>();

                var isLCYUser = activities.Contains("lcy-user");
                var isFCYUser = activities.Contains("fcy-user");

                if (isLCYUser == true)
                {
                    lcyLoans = allFilteredLoan.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                    //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
                }

                if (isFCYUser == true)
                {
                    fcyLoans = allFilteredLoan.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

                }

                allFilteredLoan = lcyLoans.Union(fcyLoans).ToList();


                if (allFilteredLoan.Count() == 0)
                {
                    allFilteredLoan = _loanViewModel;
                }

                return allFilteredLoan;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public IEnumerable<LoanPaymentSchedulePeriodicViewModel> GetLoanScheduleByLoanId(int loanId)
        {
            var loanSchedule = (from sch in context.TBL_LOAN_SCHEDULE_PERIODIC
                                where sch.LOANID == loanId
                                select new LoanPaymentSchedulePeriodicViewModel
                                {
                                    loanId = sch.LOANID,
                                    paymentNumber = sch.PAYMENTNUMBER,
                                    paymentDate = sch.PAYMENTDATE,
                                    startPrincipalAmount = (double)sch.STARTPRINCIPALAMOUNT,
                                    periodPaymentAmount = (double)sch.PERIODPAYMENTAMOUNT,
                                    periodInterestAmount = (double)sch.PERIODINTERESTAMOUNT,
                                    periodPrincipalAmount = (double)sch.PERIODPRINCIPALAMOUNT,
                                    endPrincipalAmount = (double)sch.ENDPRINCIPALAMOUNT,
                                    interestRate = sch.INTERESTRATE,
                                    amortisedStartPrincipalAmount = (double)sch.AMORTISEDSTARTPRINCIPALAMOUNT,
                                    amortisedPeriodPaymentAmount = (double)sch.AMORTISEDPERIODPAYMENTAMOUNT,
                                    amortisedPeriodInterestAmount = (double)sch.AMORTISEDPERIODINTERESTAMOUNT,
                                    amortisedPeriodPrincipalAmount = (double)sch.AMORTISEDPERIODPRINCIPALAMOUNT,
                                    amortisedEndPrincipalAmount = (double)sch.AMORTISEDENDPRINCIPALAMOUNT,
                                    effectiveInterestRate = sch.EFFECTIVEINTERESTRATE
                                }).ToList();
            return loanSchedule;
        }

        public IEnumerable<LoanViewModel> GetBookedLoanDetailsWithParameters(int companyId, string param)
        {
            var loans = BookedLoan(companyId);
            // .Where(x => x.loanReferenceNumber == param || x.firstName.StartsWith(param) || x.lastName.StartsWith(param) || x.middleName.StartsWith(param ) || param==null || param=="undefined");
            foreach (var loan in loans)
            {
                loan.loanCovenant = GetLoanCovenant(loan.loanId);
                loan.loanChargeFee = GetLoanChargeFee(loan.loanId);
                //loan.loanGuarantor = GetLoanGuarantors(loan.loanId);
                // loan.loanCollateral = GetLoanCollaterals(loan.loanId);
            }

            return loans;
        }

        public LoanViewModel GetDisbursedLoanByLoanId(int loanId)//GetDisbursedLoanByLoanId
        {
            LoanViewModel result;
            var data = this.context.TBL_LOAN_REVOLVING.FirstOrDefault(x => x.REVOLVINGLOANID == loanId);
            if (data != null)
            {
                result = GetDisbursedODByODId(loanId);
            }
            else
            {
                result = GetDisbursedLoanByLoan(loanId);
            }
            return result;
        }

        public LoanViewModel GetUnDisbursedLoanByLoanId(int loanId, int loanType)//GetDisbursedLoanByLoanId
        {
            LoanViewModel result;

            if (loanType == (int)LoanSystemTypeEnum.TermDisbursedFacility)
            {
                //result = GetDisbursedLoanByLoan(loanId);
                return result = null;
            }
            else if (loanType == (int)LoanSystemTypeEnum.OverdraftFacility)
            {
                //result = GetDisbursedODByODId(loanId);
                return result = null;
            }
            else if (loanType == (int)LoanSystemTypeEnum.ContingentLiability)
            {
                result = GetUnDisbursedContingentDId(loanId);
                return result;
            }

            return null;
        }

        public LoanViewModel GetDisbursedLoanByLoanId(int loanId, int loanType)//GetDisbursedLoanByLoanId
        {
            LoanViewModel result;

            if (loanType == (int)LoanSystemTypeEnum.TermDisbursedFacility)
            {
                result = GetDisbursedLoanByLoan(loanId);
                return result;
            }
            else if (loanType == (int)LoanSystemTypeEnum.OverdraftFacility)
            {
                result = GetDisbursedODByODId(loanId);
                return result;
            }
            else if (loanType == (int)LoanSystemTypeEnum.ContingentLiability)
            {
                result = GetDisbursedContingentDId(loanId);
                return result;
            }

            return null;
        }


        public LoanViewModel GetDisbursedODByODId(int loanId)//GetDisbursedODByODId
        {

            //var loanDetails = (from a in context.TBL_LOAN_REVOLVING
            //                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
            //                   join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
            //                   where a.REVOLVINGLOANID == loanId && a.ISDISBURSED == true
            //                   select new LoanViewModel
            //                   {
            //                       loanId = a.REVOLVINGLOANID,
            //                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
            //                       customerId = a.CUSTOMERID,
            //                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
            //                       customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
            //                       productId = a.PRODUCTID,
            //                       companyId = a.COMPANYID,
            //                       casaAccountId = a.CASAACCOUNTID,
            //                       branchId = a.BRANCHID,
            //                       branchName = a.TBL_BRANCH.BRANCHNAME,
            //                       loanReferenceNumber = a.LOANREFERENCENUMBER,
            //                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
            //                       //principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
            //                       //pricipalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
            //                       //interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
            //                       //interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
            //                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
            //                       productName = a.TBL_PRODUCT.PRODUCTNAME,
            //                       productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
            //                       //principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
            //                       //interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
            //                       relationshipOfficerId = a.RELATIONSHIPOFFICERID,
            //                       relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
            //                       relationshipManagerId = a.RELATIONSHIPMANAGERID,
            //                       relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
            //                       misCode = a.MISCODE,
            //                       teamMiscode = a.TEAMMISCODE,
            //                       interestRate = a.INTERESTRATE,
            //                       effectiveDate = a.EFFECTIVEDATE,
            //                       maturityDate = a.MATURITYDATE,
            //                       bookingDate = a.BOOKINGDATE,
            //                       principalAmount = a.OVERDRAFTLIMIT,
            //                       //principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
            //                       //interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
            //                       approvalStatusId = a.APPROVALSTATUSID,
            //                       //approvedBy = a.APPROVEDBY,
            //                       approverComment = a.APPROVERCOMMENT,
            //                       dateApproved = a.DATEAPPROVED,
            //                       loanStatusId = a.LOANSTATUSID,
            //                       //scheduleTypeId = a.SCHEDULETYPEID,
            //                       //scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
            //                       isDisbursed = a.ISDISBURSED,
            //                       //disbursedBy = a.DISBURSEDBY,
            //                       disburserComment = a.DISBURSERCOMMENT,
            //                       disburseDate = a.DISBURSEDATE,
            //                       operationId = a.OPERATIONID,
            //                       operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
            //                       subSectorName = a.TBL_SUB_SECTOR.NAME,
            //                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
            //                       casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
            //                       productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
            //                       customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
            //                       loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
            //                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
            //                       //equityContribution = a.EQUITYCONTRIBUTION,
            //                       //firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
            //                       //firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
            //                       //outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
            //                       //outstandingInterest = a.OUTSTANDINGINTEREST,
            //                       //principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
            //                       //principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
            //                       //fixedPrincipal = a.FIXEDPRINCIPAL,
            //                       //profileLoan = a.PROFILELOAN,
            //                       dischargeLetter = a.DISCHARGELETTER,
            //                       suspendInterest = a.SUSPENDINTEREST,
            //                       customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
            //                       createdBy = a.CREATEDBY,
            //                       dateTimeCreated = a.DATETIMECREATED,
            //                       isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.REVOLVINGLOANID).Any(),
            //                       exchangeRate = a.EXCHANGERATE,
            //                       currencyId = a.CURRENCYID,
            //                       currency = a.TBL_CURRENCY.CURRENCYNAME
            //                   }).FirstOrDefault();
            var applicationDate = generalSetup.GetApplicationDate();

            var loanDetails = (from a in context.TBL_LOAN_REVOLVING
                               join tt in context.TBL_OPERATIONS on a.OPERATIONID equals tt.OPERATIONID
                               join br in context.TBL_BRANCH on a.BRANCHID equals br.BRANCHID
                               join ld in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                               join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                               join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                               join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                               join pr in context.TBL_PRODUCT on a.PRODUCTID equals pr.PRODUCTID
                               join st in context.TBL_STAFF on a.RELATIONSHIPOFFICERID equals st.STAFFID
                               join stm in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals stm.STAFFID
                               join lr in context.TBL_LMSR_APPLICATION_DETAIL on a.REVOLVINGLOANID equals lr.LOANID into final
                               from lr in final.DefaultIfEmpty()
                               where a.REVOLVINGLOANID == loanId && a.ISDISBURSED == true
                               select new LoanViewModel
                               {
                                   loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                   loanId = a.REVOLVINGLOANID,
                                   customerId = a.CUSTOMERID,
                                   customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                   customerCode = b.CUSTOMERCODE,
                                   customerType = b.TBL_CUSTOMER_TYPE.NAME,
                                   productId = a.PRODUCTID,
                                   companyId = a.COMPANYID,
                                   casaAccountId = a.CASAACCOUNTID,
                                   branchId = a.BRANCHID,
                                   branchName = br.BRANCHNAME,
                                   loanReferenceNumber = a.LOANREFERENCENUMBER,
                                   applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER ?? "N/A",
                                   loanApplicationId = lp.LOANAPPLICATIONID,
                                   productTypeId = pr.PRODUCTTYPEID,
                                   productName = pr.PRODUCTNAME,
                                   loanPurpose = ld.LOANPURPOSE,
                                   reviewDetails = lr.REVIEWDETAILS,
                                   operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == lr.OPERATIONID).OPERATIONNAME,

                                   productTypeName = pr.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                   relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                   relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                   relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                   relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                   misCode = a.MISCODE,
                                   teamMiscode = a.TEAMMISCODE,
                                   interestRate = a.INTERESTRATE,
                                   effectiveDate = a.EFFECTIVEDATE,
                                   maturityDate = a.MATURITYDATE,
                                   bookingDate = a.BOOKINGDATE,
                                   principalAmount = a.OVERDRAFTLIMIT,
                                   approvalStatusId = a.APPROVALSTATUSID,
                                   approverComment = a.APPROVERCOMMENT,
                                   dateApproved = a.DATEAPPROVED,
                                   loanStatusId = a.LOANSTATUSID,
                                   isDisbursed = a.ISDISBURSED,
                                   disburserComment = a.DISBURSERCOMMENT,
                                   disburseDate = a.DISBURSEDATE,
                                   operationId = a.OPERATIONID,
                                   operationName = tt.OPERATIONNAME,
                                   reviewLoanDetaile = context.TBL_LMSR_APPLICATION_DETAIL.Where(r => r.LOANID == loanId).Select(r => r.REVIEWDETAILS).FirstOrDefault(),
                                   subSectorName = a.TBL_SUB_SECTOR.NAME,
                                   sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                   casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                   productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                   customerGroupId = lp.CUSTOMERGROUPID,
                                   loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                   loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                   //outstandingPrincipal = availableBalance,
                                   dischargeLetter = a.DISCHARGELETTER,
                                   suspendInterest = a.SUSPENDINTEREST,
                                   customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                   createdBy = a.CREATEDBY,
                                   dateTimeCreated = a.DATETIMECREATED,
                                   exchangeRate = a.EXCHANGERATE,
                                   currencyId = a.CURRENCYID,
                                   currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                   currency = a.TBL_CURRENCY.CURRENCYNAME,
                                   accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.REVOLVINGLOANID && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST,  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                   operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.REVOLVINGLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                   {
                                       loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                       operationTypeId = op.OPERATIONTYPEID,
                                       operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                       newEffectiveDate = op.EFFECTIVEDATE,
                                       reviewDetails = op.REVIEWDETAILS,
                                       prepayment = op.PREPAYMENT,
                                       newInterateRate = op.INTERATERATE,
                                       newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                       newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                       newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                       newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                       newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                       newTenor = op.TENOR,
                                       cASA_AccountId = op.CASA_ACCOUNTID,
                                       cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                       overDraftTopup = op.OVERDRAFTTOPUP,
                                       fee_Charges = op.FEE_CHARGES,
                                       scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                       scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                       scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                       scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                       scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                       newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                       newMaturityDate = op.MATURITYDATE,
                                       dateTimeCreated = op.DATECREATED,
                                       maturityInstructionTypeId = op.MATURITYINSTRUCTIONTYPEID,
                                   }).FirstOrDefault(),

                               }).FirstOrDefault();
            return loanDetails;
        }

        public LoanViewModel GetDisbursedLoanByLoan(int loanId)//GetDisbursedLoanByLoanId
        {
            var applicationDate = generalSetup.GetApplicationDate();
            var loanDetails = (from a in context.TBL_LOAN
                               join d in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                               join e in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                               join f in context.TBL_PRODUCT on a.PRODUCTID equals f.PRODUCTID
                               join pt in context.TBL_PRODUCT_TYPE on f.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                               join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                               join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                               join cur in context.TBL_CURRENCY on a.CURRENCYID equals cur.CURRENCYID
                               join br in context.TBL_BRANCH on a.BRANCHID equals br.BRANCHID
                               join ro in context.TBL_STAFF on a.RELATIONSHIPOFFICERID equals ro.STAFFID
                               join rm in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals rm.STAFFID
                               join ld in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals ld.LOANID into final
                               from ld in final.DefaultIfEmpty()
                               where a.TERMLOANID == loanId && a.ISDISBURSED == true
                               select new LoanViewModel
                               {
                                   appraisalOperationId = e.OPERATIONID,
                                   appraisalApplicationId = e.LOANAPPLICATIONID,
                                   appraisalCustomerId = e.CUSTOMERID,
                                   appraisalGroupCustomerId = e.CUSTOMERGROUPID,
                                   appraisalLoanReviewApplicationId = d.LOANAPPLICATIONDETAILID,
                                   appraisalApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,

                                   loanId = a.TERMLOANID,
                                   loanApplicationId = a.LOANAPPLICATIONDETAILID,
                                   customerId = a.CUSTOMERID,
                                   customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                   loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                   customerCode = b.CUSTOMERCODE,
                                   productId = a.PRODUCTID,
                                   companyId = a.COMPANYID,
                                   casaAccountId = a.CASAACCOUNTID,
                                   customerType = b.TBL_CUSTOMER_TYPE.NAME,
                                   branchId = a.BRANCHID,
                                   branchName = br.BRANCHNAME,
                                   loanReferenceNumber = a.LOANREFERENCENUMBER,
                                   applicationReferenceNumber = e.APPLICATIONREFERENCENUMBER ?? "N/A",

                                   principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                   principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                   interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                   interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                   productTypeId = f.PRODUCTTYPEID,
                                   productName = f.PRODUCTNAME,
                                   loanPurpose = d.LOANPURPOSE,
                                   productTypeName = pt.PRODUCTTYPENAME,
                                   principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                   interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                   relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                   relationshipOfficerName = ro.FIRSTNAME + " " + ro.MIDDLENAME + " " + ro.LASTNAME,
                                   relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                   relationshipManagerName = rm.FIRSTNAME + " " + rm.MIDDLENAME + " " + rm.LASTNAME,
                                   misCode = a.MISCODE,
                                   teamMiscode = a.TEAMMISCODE,
                                   interestRate = a.INTERESTRATE,
                                   effectiveDate = a.EFFECTIVEDATE,
                                   maturityDate = a.MATURITYDATE,
                                   bookingDate = a.BOOKINGDATE,
                                   principalAmount = a.PRINCIPALAMOUNT,
                                   principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                   interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                   approvalStatusId = a.APPROVALSTATUSID,
                                   approvedBy = a.APPROVEDBY,
                                   approverComment = a.APPROVERCOMMENT,
                                   dateApproved = a.DATEAPPROVED,
                                   loanStatusId = a.LOANSTATUSID,
                                   scheduleTypeId = a.SCHEDULETYPEID,
                                   // scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                   isDisbursed = a.ISDISBURSED,
                                   disbursedBy = a.DISBURSEDBY,
                                   disburserComment = a.DISBURSERCOMMENT,
                                   disburseDate = a.DISBURSEDATE,
                                   operationId = a.OPERATIONID,
                                   reviewLoanDetaile = context.TBL_LMSR_APPLICATION_DETAIL.Where(r => r.LOANID == loanId).Select(r => r.REVIEWDETAILS).FirstOrDefault(),
                                   operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                   subSectorName = a.TBL_SUB_SECTOR.NAME,
                                   sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                   casaAccountNumber = c.PRODUCTACCOUNTNUMBER,
                                   casaAccountNumber2 = context.TBL_CASA.Where(o => o.CASAACCOUNTID == a.CASAACCOUNTID2).Select(o => o.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                   productAccountName = c.PRODUCTACCOUNTNAME,
                                   customerGroupId = e.CUSTOMERGROUPID,
                                   loanTypeId = e.LOANAPPLICATIONTYPEID,
                                   //loanTypeName = e.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                   equityContribution = a.EQUITYCONTRIBUTION,
                                   firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                   firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                   outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                   outstandingInterest = a.OUTSTANDINGINTEREST,
                                   principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                   principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                   fixedPrincipal = a.FIXEDPRINCIPAL,
                                   profileLoan = a.PROFILELOAN,
                                   dischargeLetter = a.DISCHARGELETTER,
                                   suspendInterest = a.SUSPENDINTEREST,
                                   customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                   createdBy = a.CREATEDBY,
                                   dateTimeCreated = a.DATETIMECREATED,
                                   accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.TERMLOANID && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST,  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                   // isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                   exchangeRate = a.EXCHANGERATE,
                                   currencyId = a.CURRENCYID,
                                   currency = cur.CURRENCYNAME,
                                   currencyCode = cur.CURRENCYCODE,
                                   interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                   interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                   pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                   pastDueInterest = a.PASTDUEINTEREST,
                                   reviewDetails = ld.REVIEWDETAILS,
                                   operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == ld.OPERATIONID).OPERATIONNAME,
                                   operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.TERMLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                   {
                                       loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                       operationTypeId = op.OPERATIONTYPEID,
                                       operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                       newEffectiveDate = op.EFFECTIVEDATE,
                                       reviewDetails = op.REVIEWDETAILS,
                                       prepayment = op.PREPAYMENT,
                                       newInterateRate = op.INTERATERATE,
                                       newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                       newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                       newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                       newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                       newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                       newTenor = op.TENOR,
                                       cASA_AccountId = op.CASA_ACCOUNTID,
                                       cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                       overDraftTopup = op.OVERDRAFTTOPUP,
                                       fee_Charges = op.FEE_CHARGES,
                                       scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                       scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                       scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                       scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                       scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                       newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                       newMaturityDate = op.MATURITYDATE,
                                       dateTimeCreated = op.DATECREATED,
                                       maturityInstructionTypeId = op.MATURITYINSTRUCTIONTYPEID
                                   }).FirstOrDefault(),
                               }).FirstOrDefault();

            return loanDetails;

        }
        public LoanViewModel GetUnDisbursedContingentDId(int loanId)//GetDisbursedODByODId
        {


            var applicationDate = generalSetup.GetApplicationDate();

            var loanDetails = (from a in context.TBL_LOAN_CONTINGENT
                               join tt in context.TBL_OPERATIONS on a.OPERATIONID equals tt.OPERATIONID
                               join br in context.TBL_BRANCH on a.BRANCHID equals br.BRANCHID
                               join ld in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                               join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                               join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                               join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                               join pr in context.TBL_PRODUCT on a.PRODUCTID equals pr.PRODUCTID
                               join st in context.TBL_STAFF on a.RELATIONSHIPOFFICERID equals st.STAFFID
                               join stm in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals stm.STAFFID
                               where a.CONTINGENTLOANID == loanId
                               select new LoanViewModel
                               {
                                   loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                   loanId = a.CONTINGENTLOANID,
                                   customerId = a.CUSTOMERID,
                                   customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                   customerCode = b.CUSTOMERCODE,
                                   productId = a.PRODUCTID,
                                   companyId = a.COMPANYID,
                                   casaAccountId = a.CASAACCOUNTID,
                                   customerType = b.TBL_CUSTOMER_TYPE.NAME,
                                   branchId = a.BRANCHID,
                                   branchName = br.BRANCHNAME,
                                   loanReferenceNumber = a.LOANREFERENCENUMBER,
                                   applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER ?? "N/A",
                                   loanApplicationId = lp.LOANAPPLICATIONID,
                                   productTypeId = pr.PRODUCTTYPEID,
                                   productName = pr.PRODUCTNAME,
                                   productTypeName = pr.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                   relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                   relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                   relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                   relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                   misCode = a.MISCODE,
                                   teamMiscode = a.TEAMMISCODE,
                                   //interestRate = a.INTERESTRATE,
                                   effectiveDate = a.EFFECTIVEDATE,
                                   maturityDate = a.MATURITYDATE,
                                   bookingDate = a.BOOKINGDATE,
                                   principalAmount = a.CONTINGENTAMOUNT,
                                   approvalStatusId = a.APPROVALSTATUSID,
                                   approverComment = a.APPROVERCOMMENT,
                                   dateApproved = a.DATEAPPROVED,
                                   loanStatusId = a.LOANSTATUSID,
                                   isDisbursed = a.ISDISBURSED,
                                   disburserComment = a.DISBURSERCOMMENT,
                                   disburseDate = a.DISBURSEDATE,
                                   operationId = a.OPERATIONID,
                                   operationName = tt.OPERATIONNAME,
                                   reviewLoanDetaile = context.TBL_LMSR_APPLICATION_DETAIL.Where(r => r.LOANID == loanId).Select(r => r.REVIEWDETAILS).FirstOrDefault(),
                                   subSectorName = a.TBL_SUB_SECTOR.NAME,
                                   sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                   casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                   productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                   customerGroupId = lp.CUSTOMERGROUPID,
                                   loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                   loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                   loanPurpose = ld.LOANPURPOSE,
                                   //outstandingPrincipal = availableBalance,
                                   operationTypeName = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == lp.OPERATIONID).Select(o => o.OPERATIONNAME).FirstOrDefault(),
                                   dischargeLetter = a.DISCHARGELETTER,
                                   //suspendInterest = a.SUSPENDINTEREST,
                                   customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                   createdBy = a.CREATEDBY,
                                   dateTimeCreated = a.DATETIMECREATED,
                                   exchangeRate = a.EXCHANGERATE,
                                   currencyId = a.CURRENCYID,
                                   currency = a.TBL_CURRENCY.CURRENCYNAME,
                                   currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                   accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.CONTINGENTLOANID && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST,  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                   //contigentOutstandingPrincipal = (from x in context.TBL_LOAN_REVIEW_OPERATION join y in context.TBL_LOAN_CONTINGENT on x.LOANID equals y.CONTINGENTLOANID where y.RELATED_LOAN_REFERENCE_NUMBER == a.RELATED_LOAN_REFERENCE_NUMBER && y.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved select x.CONTINGENTOUTSTANDINGPRINCIPAL).FirstOrDefault(),
                                   //totalPrepayment = (from x in context.TBL_LOAN_REVIEW_OPERATION join y in context.TBL_LOAN_CONTINGENT on x.LOANID equals y.CONTINGENTLOANID where y.RELATED_LOAN_REFERENCE_NUMBER == a.RELATED_LOAN_REFERENCE_NUMBER && y.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved select x.PREPAYMENT).FirstOrDefault(),
                                   contigentOutstandingPrincipal = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == a.CONTINGENTLOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved).Sum(x => x.CONTINGENTOUTSTANDINGPRINCIPAL),
                                   totalPrepayment = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == a.CONTINGENTLOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved).Sum(x => x.PREPAYMENT),
                                   operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.CONTINGENTLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                   {
                                       contigentOutstandingPrincipal = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == op.LOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved).Sum(x => x.CONTINGENTOUTSTANDINGPRINCIPAL),
                                       totalPrepayment = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == op.LOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved).Sum(x => x.PREPAYMENT),
                                       loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                       operationTypeId = op.OPERATIONTYPEID,
                                       operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                       newEffectiveDate = op.EFFECTIVEDATE,
                                       reviewDetails = op.REVIEWDETAILS,
                                       prepayment = op.PREPAYMENT,
                                       newInterateRate = op.INTERATERATE,
                                       newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                       newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                       newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                       newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                       newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                       newTenor = op.TENOR,
                                       cASA_AccountId = op.CASA_ACCOUNTID,
                                       cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                       overDraftTopup = op.OVERDRAFTTOPUP,
                                       fee_Charges = op.FEE_CHARGES,
                                       scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                       scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                       scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                       scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                       scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                       newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                       newMaturityDate = op.MATURITYDATE,
                                       dateTimeCreated = op.DATECREATED,
                                       maturityInstructionTypeId = op.MATURITYINSTRUCTIONTYPEID
                                   }).FirstOrDefault(),

                               }).FirstOrDefault();
            return loanDetails;
        }

        public LoanViewModel GetDisbursedContingentDId(int loanId)//GetDisbursedODByODId
        {

            //var loanDetails = (from a in context.TBL_LOAN_REVOLVING
            //                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
            //                   join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
            //                   where a.REVOLVINGLOANID == loanId && a.ISDISBURSED == true
            //                   select new LoanViewModel
            //                   {
            //                       loanId = a.REVOLVINGLOANID,
            //                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
            //                       customerId = a.CUSTOMERID,
            //                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
            //                       customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
            //                       productId = a.PRODUCTID,
            //                       companyId = a.COMPANYID,
            //                       casaAccountId = a.CASAACCOUNTID,
            //                       branchId = a.BRANCHID,
            //                       branchName = a.TBL_BRANCH.BRANCHNAME,
            //                       loanReferenceNumber = a.LOANREFERENCENUMBER,
            //                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
            //                       //principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
            //                       //pricipalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
            //                       //interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
            //                       //interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
            //                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
            //                       productName = a.TBL_PRODUCT.PRODUCTNAME,
            //                       productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
            //                       //principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
            //                       //interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
            //                       relationshipOfficerId = a.RELATIONSHIPOFFICERID,
            //                       relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
            //                       relationshipManagerId = a.RELATIONSHIPMANAGERID,
            //                       relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
            //                       misCode = a.MISCODE,
            //                       teamMiscode = a.TEAMMISCODE,
            //                       interestRate = a.INTERESTRATE,
            //                       effectiveDate = a.EFFECTIVEDATE,
            //                       maturityDate = a.MATURITYDATE,
            //                       bookingDate = a.BOOKINGDATE,
            //                       principalAmount = a.OVERDRAFTLIMIT,
            //                       //principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
            //                       //interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
            //                       approvalStatusId = a.APPROVALSTATUSID,
            //                       //approvedBy = a.APPROVEDBY,
            //                       approverComment = a.APPROVERCOMMENT,
            //                       dateApproved = a.DATEAPPROVED,
            //                       loanStatusId = a.LOANSTATUSID,
            //                       //scheduleTypeId = a.SCHEDULETYPEID,
            //                       //scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
            //                       isDisbursed = a.ISDISBURSED,
            //                       //disbursedBy = a.DISBURSEDBY,
            //                       disburserComment = a.DISBURSERCOMMENT,
            //                       disburseDate = a.DISBURSEDATE,
            //                       operationId = a.OPERATIONID,
            //                       operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
            //                       subSectorName = a.TBL_SUB_SECTOR.NAME,
            //                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
            //                       casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
            //                       productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
            //                       customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
            //                       loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
            //                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
            //                       //equityContribution = a.EQUITYCONTRIBUTION,
            //                       //firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
            //                       //firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
            //                       //outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
            //                       //outstandingInterest = a.OUTSTANDINGINTEREST,
            //                       //principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
            //                       //principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
            //                       //fixedPrincipal = a.FIXEDPRINCIPAL,
            //                       //profileLoan = a.PROFILELOAN,
            //                       dischargeLetter = a.DISCHARGELETTER,
            //                       suspendInterest = a.SUSPENDINTEREST,
            //                       customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
            //                       createdBy = a.CREATEDBY,
            //                       dateTimeCreated = a.DATETIMECREATED,
            //                       isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.REVOLVINGLOANID).Any(),
            //                       exchangeRate = a.EXCHANGERATE,
            //                       currencyId = a.CURRENCYID,
            //                       currency = a.TBL_CURRENCY.CURRENCYNAME
            //                   }).FirstOrDefault();
            var applicationDate = generalSetup.GetApplicationDate();

            var loanDetails = (from a in context.TBL_LOAN_CONTINGENT
                               join tt in context.TBL_OPERATIONS on a.OPERATIONID equals tt.OPERATIONID
                               join br in context.TBL_BRANCH on a.BRANCHID equals br.BRANCHID
                               join ld in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                               join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                               join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                               join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                               join pr in context.TBL_PRODUCT on a.PRODUCTID equals pr.PRODUCTID
                               join st in context.TBL_STAFF on a.RELATIONSHIPOFFICERID equals st.STAFFID
                               join stm in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals stm.STAFFID
                               where a.CONTINGENTLOANID == loanId && a.ISDISBURSED == true
                               join lh in context.TBL_LMSR_APPLICATION_DETAIL on a.CONTINGENTLOANID equals lh.LOANID into final
                               from lh in final.DefaultIfEmpty()
                               select new LoanViewModel
                               {
                                   loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                   loanId = a.CONTINGENTLOANID,
                                   customerId = a.CUSTOMERID,
                                   customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                   customerCode = b.CUSTOMERCODE,
                                   productId = a.PRODUCTID,
                                   companyId = a.COMPANYID,
                                   casaAccountId = a.CASAACCOUNTID,
                                   customerType = b.TBL_CUSTOMER_TYPE.NAME,
                                   branchId = a.BRANCHID,
                                   branchName = br.BRANCHNAME,
                                   loanReferenceNumber = a.LOANREFERENCENUMBER,
                                   applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER ?? "N/A",
                                   loanApplicationId = lp.LOANAPPLICATIONID,
                                   productTypeId = pr.PRODUCTTYPEID,
                                   productName = pr.PRODUCTNAME,
                                   productTypeName = pr.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                   relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                   relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                   relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                   relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                   misCode = a.MISCODE,
                                   teamMiscode = a.TEAMMISCODE,
                                   loanPurpose = ld.LOANPURPOSE,
                                   legalContingentCode = a.LEGALCONTINGENTCODE == null ? "n/a" : a.LEGALCONTINGENTCODE,
                                   //interestRate = a.INTERESTRATE,
                                   effectiveDate = a.EFFECTIVEDATE,
                                   maturityDate = a.MATURITYDATE,
                                   bookingDate = a.BOOKINGDATE,
                                   principalAmount = a.CONTINGENTAMOUNT,
                                   approvalStatusId = a.APPROVALSTATUSID,
                                   approverComment = a.APPROVERCOMMENT,
                                   approvalStatusName = context.TBL_APPROVAL_STATUS.Where(l => l.APPROVALSTATUSID == a.APPROVALSTATUSID).Select(f => f.APPROVALSTATUSNAME).FirstOrDefault(),
                                   dateApproved = a.DATEAPPROVED,
                                   loanStatusId = a.LOANSTATUSID,
                                   isDisbursed = a.ISDISBURSED,
                                   isDisbursedState = a.ISDISBURSED == true ? "Yes" : "No",
                                   istenored = a.ISTENORED == true ? "Yes" : "No",
                                   isbankFormat = a.ISBANKFORMAT == true ? "Yes" : "No",
                                   disburserComment = a.DISBURSERCOMMENT,
                                   disburseDate = a.DISBURSEDATE,
                                   operationId = a.OPERATIONID,
                                   operationName = tt.OPERATIONNAME,
                                   reviewLoanDetaile = context.TBL_LMSR_APPLICATION_DETAIL.Where(r => r.LOANID == loanId).Select(r => r.REVIEWDETAILS).FirstOrDefault(),
                                   subSectorName = a.TBL_SUB_SECTOR.NAME,
                                   sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                   casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                   productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                   customerGroupId = lp.CUSTOMERGROUPID,
                                   loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                   loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                   reviewDetails = lh.REVIEWDETAILS,
                                   //outstandingPrincipal = availableBalance,
                                   dischargeLetter = a.DISCHARGELETTER,
                                   //suspendInterest = a.SUSPENDINTEREST,
                                   customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                   createdBy = a.CREATEDBY,
                                   dateTimeCreated = a.DATETIMECREATED,
                                   exchangeRate = a.EXCHANGERATE,
                                   currencyId = a.CURRENCYID,
                                   currency = a.TBL_CURRENCY.CURRENCYNAME,
                                   currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                   operationTypeName = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == lp.OPERATIONID).Select(o => o.OPERATIONNAME).FirstOrDefault(),
                                   accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.CONTINGENTLOANID && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST,  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                   //contigentOutstandingPrincipal = (from x in context.TBL_LOAN_REVIEW_OPERATION join y in context.TBL_LOAN_CONTINGENT on x.LOANID equals y.CONTINGENTLOANID where y.RELATED_LOAN_REFERENCE_NUMBER == a.RELATED_LOAN_REFERENCE_NUMBER && y.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved select x.CONTINGENTOUTSTANDINGPRINCIPAL).FirstOrDefault(),
                                   //prePayment = (from x in context.TBL_LOAN_REVIEW_OPERATION join y in context.TBL_LOAN_CONTINGENT on x.LOANID equals y.CONTINGENTLOANID where y.RELATED_LOAN_REFERENCE_NUMBER == a.RELATED_LOAN_REFERENCE_NUMBER && y.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved select x.PREPAYMENT).FirstOrDefault(),
                                   contigentOutstandingPrincipal = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == a.CONTINGENTLOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook).Sum(x => x.CONTINGENTOUTSTANDINGPRINCIPAL),
                                   totalPrepayment = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == a.CONTINGENTLOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityAmountReduction).Sum(x => x.PREPAYMENT),
                                   operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.CONTINGENTLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                   {
                                       contigentOutstandingPrincipal = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == op.LOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook).Sum(x => x.CONTINGENTOUTSTANDINGPRINCIPAL),
                                       totalPrepayment = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == op.LOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityAmountReduction).Sum(x => x.PREPAYMENT),
                                       loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                       operationTypeId = op.OPERATIONTYPEID,
                                       operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                       newEffectiveDate = op.EFFECTIVEDATE,
                                       reviewDetails = op.REVIEWDETAILS,
                                       prepayment = op.PREPAYMENT,
                                       newInterateRate = op.INTERATERATE,
                                       newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                       newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                       newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                       newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                       newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                       newTenor = op.TENOR,
                                       cASA_AccountId = op.CASA_ACCOUNTID,
                                       cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                       overDraftTopup = op.OVERDRAFTTOPUP,
                                       fee_Charges = op.FEE_CHARGES,
                                       scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                       scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                       scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                       scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                       scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                       newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                       newMaturityDate = op.MATURITYDATE,
                                       dateTimeCreated = op.DATECREATED,
                                       maturityInstructionTypeId = op.MATURITYINSTRUCTIONTYPEID
                                   }).FirstOrDefault(),

                               }).FirstOrDefault();
            return loanDetails;
        }

        public List<LoanViewModel> getDisbursedCommercialLoanTrancheDetailsById(int loanId)//GetDisbursedLoanByLoanId
        {
            var applicationDate = generalSetup.GetApplicationDate();
            TBL_LOAN loanRecord = context.TBL_LOAN.Find(loanId);
            var relatedLoanRecords = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == loanRecord.LOANAPPLICATIONDETAILID && x.LOANSTATUSID == (short)LoanStatusEnum.Active && x.ISDISBURSED == true).ToList();
            LoanViewModel loanDetails;
            List<LoanViewModel> tranches = new List<LoanViewModel>();
            foreach (var item in relatedLoanRecords)
            {
                loanDetails = (from a in context.TBL_LOAN
                               join d in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                               join e in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                               join f in context.TBL_PRODUCT on a.PRODUCTID equals f.PRODUCTID
                               join pt in context.TBL_PRODUCT_TYPE on f.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                               join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                               join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                               join cur in context.TBL_CURRENCY on a.CURRENCYID equals cur.CURRENCYID
                               join br in context.TBL_BRANCH on a.BRANCHID equals br.BRANCHID
                               join ro in context.TBL_STAFF on a.RELATIONSHIPOFFICERID equals ro.STAFFID
                               join rm in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals rm.STAFFID
                               where a.TERMLOANID == item.TERMLOANID && a.ISDISBURSED == true && a.LOANSTATUSID == (short)LoanStatusEnum.Active
                               select new LoanViewModel
                               {
                                   loanId = a.TERMLOANID,
                                   loanApplicationId = a.LOANAPPLICATIONDETAILID,
                                   customerId = a.CUSTOMERID,
                                   customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                   customerCode = b.CUSTOMERCODE,
                                   productId = a.PRODUCTID,
                                   companyId = a.COMPANYID,
                                   casaAccountId = a.CASAACCOUNTID,
                                   customerType = b.TBL_CUSTOMER_TYPE.NAME,
                                   branchId = a.BRANCHID,
                                   branchName = br.BRANCHNAME,
                                   loanReferenceNumber = a.LOANREFERENCENUMBER,
                                   applicationReferenceNumber = e.APPLICATIONREFERENCENUMBER ?? "N/A",
                                   principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                   principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                   interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                   interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                   productTypeId = f.PRODUCTTYPEID,
                                   productName = f.PRODUCTNAME,
                                   operationTypeName = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == e.OPERATIONID).Select(o => o.OPERATIONNAME).FirstOrDefault(),
                                   productTypeName = pt.PRODUCTTYPENAME,
                                   principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                   interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                   relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                   relationshipOfficerName = ro.FIRSTNAME + " " + ro.MIDDLENAME + " " + ro.LASTNAME,
                                   relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                   relationshipManagerName = rm.FIRSTNAME + " " + rm.MIDDLENAME + " " + rm.LASTNAME,
                                   misCode = a.MISCODE,
                                   teamMiscode = a.TEAMMISCODE,
                                   interestRate = a.INTERESTRATE,
                                   effectiveDate = a.EFFECTIVEDATE,
                                   maturityDate = a.MATURITYDATE,
                                   bookingDate = a.BOOKINGDATE,
                                   principalAmount = a.PRINCIPALAMOUNT,
                                   principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                   interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                   approvalStatusId = a.APPROVALSTATUSID,
                                   approvedBy = a.APPROVEDBY,
                                   approverComment = a.APPROVERCOMMENT,
                                   dateApproved = a.DATEAPPROVED,
                                   loanStatusId = a.LOANSTATUSID,
                                   scheduleTypeId = a.SCHEDULETYPEID,
                                   // scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                   isDisbursed = a.ISDISBURSED,
                                   disbursedBy = a.DISBURSEDBY,
                                   disburserComment = a.DISBURSERCOMMENT,
                                   disburseDate = a.DISBURSEDATE,
                                   operationId = a.OPERATIONID,
                                   operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                   subSectorName = a.TBL_SUB_SECTOR.NAME,
                                   sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                   casaAccountNumber = c.PRODUCTACCOUNTNUMBER,
                                   casaAccountNumber2 = context.TBL_CASA.Where(o => o.CASAACCOUNTID == a.CASAACCOUNTID2).Select(o => o.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                   productAccountName = c.PRODUCTACCOUNTNAME,
                                   customerGroupId = e.CUSTOMERGROUPID,
                                   loanTypeId = e.LOANAPPLICATIONTYPEID,
                                   //loanTypeName = e.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                   equityContribution = a.EQUITYCONTRIBUTION,
                                   firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                   firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                   outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                   outstandingInterest = a.OUTSTANDINGINTEREST,
                                   principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                   principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                   fixedPrincipal = a.FIXEDPRINCIPAL,
                                   profileLoan = a.PROFILELOAN,
                                   dischargeLetter = a.DISCHARGELETTER,
                                   suspendInterest = a.SUSPENDINTEREST,
                                   customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                   createdBy = a.CREATEDBY,
                                   dateTimeCreated = a.DATETIMECREATED,
                                   accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.TERMLOANID && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST,  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                                                                                                                                                                          // isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                   exchangeRate = a.EXCHANGERATE,
                                   currencyId = a.CURRENCYID,
                                   currency = a.TBL_CURRENCY.CURRENCYNAME, //cur.CURRENCYNAME,
                                   currencyCode = a.TBL_CURRENCY.CURRENCYCODE, //cur.CURRENCYCODE,
                                   operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.TERMLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                   {
                                       loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                       operationTypeId = op.OPERATIONTYPEID,
                                       operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                       newEffectiveDate = op.EFFECTIVEDATE,
                                       reviewDetails = op.REVIEWDETAILS,
                                       prepayment = op.PREPAYMENT,
                                       newInterateRate = op.INTERATERATE,
                                       newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                       newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                       newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                       newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                       newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                       newTenor = op.TENOR,
                                       cASA_AccountId = op.CASA_ACCOUNTID,
                                       cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                       overDraftTopup = op.OVERDRAFTTOPUP,
                                       fee_Charges = op.FEE_CHARGES,
                                       scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                       scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                       scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                       scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                       scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                       newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                       newMaturityDate = op.MATURITYDATE,
                                       dateTimeCreated = op.DATECREATED,
                                       maturityInstructionTypeId = op.MATURITYINSTRUCTIONTYPEID
                                   }).FirstOrDefault(),
                               }).FirstOrDefault();

                if (loanDetails != null) tranches.Add(loanDetails);
                loanDetails = new LoanViewModel();
            };

            return tranches;

        }


        public IEnumerable<LoanViewModel> GetRevolvingFacilityByBookingRequestId(int requestId)
        {
            var data = (from ln in context.TBL_LOAN_REVOLVING
                        join coy in context.TBL_COMPANY on ln.COMPANYID equals coy.COMPANYID
                        join req in context.TBL_LOAN_BOOKING_REQUEST on ln.LOANAPPLICATIONDETAILID equals req.LOANAPPLICATIONDETAILID
                        join br in context.TBL_BRANCH on ln.BRANCHID equals br.BRANCHID
                        where ln.LOAN_BOOKING_REQUESTID == requestId
                        orderby ln.LOAN_BOOKING_REQUESTID descending

                        select new LoanViewModel()
                        {
                            loanId = ln.REVOLVINGLOANID,
                            operationId = (int)OperationsEnum.RevolvingLoanBooking,
                            loanBookingRequestId = req.LOAN_BOOKING_REQUESTID,
                            customerId = ln.CUSTOMERID,
                            productId = ln.PRODUCTID,
                            casaAccountId = ln.CASAACCOUNTID,
                            casaAccountNumber = ln.TBL_CASA.PRODUCTACCOUNTNUMBER,
                            casaAccountDetails = ln.TBL_CASA.PRODUCTACCOUNTNUMBER + " (" + ln.TBL_CASA.PRODUCTACCOUNTNAME + ") ",
                            loanApplicationDetailId = (int)ln.LOANAPPLICATIONDETAILID,
                            loanApplicationId = ln.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
                            currencyCode = ln.TBL_CURRENCY.CURRENCYCODE,
                            branchId = ln.BRANCHID,
                            loanReferenceNumber = ln.LOANREFERENCENUMBER,
                            //applicationReferenceNumber = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER,

                            relationshipOfficerId = ln.RELATIONSHIPOFFICERID,
                            relationshipManagerId = ln.RELATIONSHIPMANAGERID,
                            misCode = ln.MISCODE,
                            teamMiscode = ln.TEAMMISCODE,
                            effectiveDate = ln.EFFECTIVEDATE,
                            maturityDate = ln.MATURITYDATE,
                            bookingDate = ln.BOOKINGDATE,
                            interestRate = ln.INTERESTRATE,
                            overdraftLimit = ln.OVERDRAFTLIMIT,
                            approvalStatusId = ln.APPROVALSTATUSID,
                            approvedBy = (int)ln.APPROVEDBY,
                            approverComment = ln.APPROVERCOMMENT,
                            dateApproved = ln.DATEAPPROVED,
                            loanStatusId = ln.LOANSTATUSID,
                            loanStatusName = ln.TBL_LOAN_STATUS.ACCOUNTSTATUS,
                            isDisbursed = ln.ISDISBURSED,
                            disburserComment = ln.DISBURSERCOMMENT,
                            disburseDate = ln.DISBURSEDATE,
                            loanSystemTypeId = ln.LOANSYSTEMTYPEID,


                            customerGroupId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                            loanTypeId = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                            subSectorId = ln.SUBSECTORID,
                            subSectorName = ln.TBL_SUB_SECTOR.NAME,
                            dischargeLetter = ln.DISCHARGELETTER,

                            customerSensitivityLevelId = ln.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                            customerSensitivityLevelName = ln.TBL_CUSTOMER.TBL_CUSTOMER_SENSITIVITY_LEVEL.DESCRIPTION,
                            firstName = ln.TBL_CUSTOMER.FIRSTNAME,
                            middleName = ln.TBL_CUSTOMER.MIDDLENAME,
                            lastName = ln.TBL_CUSTOMER.LASTNAME,
                            customerCode = ln.TBL_CUSTOMER.CUSTOMERCODE,

                            productAccountName = ln.TBL_PRODUCT.TBL_CHART_OF_ACCOUNT.ACCOUNTNAME,
                            loanTypeName = ln.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            customerName = ln.TBL_CUSTOMER.LASTNAME + " " + ln.TBL_CUSTOMER.FIRSTNAME + " " + ln.TBL_CUSTOMER.MIDDLENAME,
                            currencyId = ln.CURRENCYID,

                            branchName = ln.TBL_BRANCH.BRANCHNAME,
                            relationshipOfficerName = ln.TBL_STAFF.FIRSTNAME + " " + ln.TBL_STAFF.MIDDLENAME + " " + ln.TBL_STAFF.LASTNAME,
                            relationshipManagerName = ln.TBL_STAFF1.FIRSTNAME + " " + ln.TBL_STAFF1.MIDDLENAME + " " + ln.TBL_STAFF1.LASTNAME,

                            productName = ln.TBL_PRODUCT.PRODUCTNAME,
                            productTypeName = ln.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            createdBy = ln.CREATEDBY,
                            creatorName = ln.TBL_STAFF.LASTNAME + " " + ln.TBL_STAFF.FIRSTNAME + " (" + ln.TBL_STAFF.STAFFCODE + ")",
                            dateTimeCreated = ln.DATETIMECREATED,
                            comment = "",
                            isBidbond = ln.TBL_PRODUCT.PRODUCTCLASSID == (short)ProductClassEnum.BondAndGuarantees ? true : false,
                            isOverdraft = ln.TBL_PRODUCT.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan ? true : false,
                            scheduleDayCountConventionId = ln.DAYCOUNTCONVENTIONID,
                            //crmsRepaymentAgreementTypeId = ln.CRMSREPAYMENTAGREEMENTID,
                            revolvingTypeId = ln.REVOLVINGTYPEID,
                        });


            return data;
        }

        public LoanViewModel GetContingentByLoanId(int contingentLoanId)
        {
            //decimal overDraftLimit = 0;
            decimal availableBalance = 0;
            //var odDetail = context.TBL_LOAN_REVOLVING.FirstOrDefault(x => x.REVOLVINGLOANID == revolvingLoanId);
            var odDetail = context.TBL_LOAN_CONTINGENT.FirstOrDefault(x => x.CONTINGENTLOANID == contingentLoanId);
            if (odDetail != null)
            {
                //overDraftLimit = odDetail.OVERDRAFTLIMIT;
                availableBalance = context.TBL_CASA.FirstOrDefault(x => x.CASAACCOUNTID == odDetail.CASAACCOUNTID).AVAILABLEBALANCE;
            }
            //var overDraftDetail = (from a in context.TBL_LOAN_REVOLVING
            //                       join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
            //                       join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
            //                       where a.REVOLVINGLOANID == revolvingLoanId
            //                       select new LoanViewModel
            //                       {
            //                           loanId = a.REVOLVINGLOANID,
            //                           customerId = a.CUSTOMERID,
            //                           customerName = b.FIRSTNAME + " " + b.LASTNAME,
            //                           customerCode = b.CUSTOMERCODE,
            //                           productId = a.PRODUCTID,
            //                           companyId = a.COMPANYID,
            //                           casaAccountId = a.CASAACCOUNTID,
            //                           branchId = a.BRANCHID,
            //                           branchName = a.TBL_BRANCH.BRANCHNAME,
            //                           loanReferenceNumber = a.LOANREFERENCENUMBER,
            //                           //applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
            //                           //loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
            //                           //productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
            //                           //productName = a.TBL_PRODUCT.PRODUCTNAME,
            //                           //productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
            //                           //relationshipOfficerId = a.RELATIONSHIPOFFICERID,
            //                           //relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
            //                           //relationshipManagerId = a.RELATIONSHIPMANAGERID,
            //                           //relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
            //                           //misCode = a.MISCODE,
            //                           //teamMiscode = a.TEAMMISCODE,
            //                           //interestRate = a.INTERESTRATE,
            //                           //effectiveDate = a.EFFECTIVEDATE,
            //                           //maturityDate = a.MATURITYDATE,
            //                           //bookingDate = a.BOOKINGDATE,
            //                           //principalAmount = a.OVERDRAFTLIMIT,
            //                           //approvalStatusId = a.APPROVALSTATUSID,
            //                           //approverComment = a.APPROVERCOMMENT,
            //                           //dateApproved = a.DATEAPPROVED,
            //                           //loanStatusId = a.LOANSTATUSID,
            //                           //isDisbursed = a.ISDISBURSED,
            //                           //disburserComment = a.DISBURSERCOMMENT,
            //                           //disburseDate = a.DISBURSEDATE,
            //                           //operationId = a.OPERATIONID,
            //                           //operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
            //                           //subSectorName = a.TBL_SUB_SECTOR.NAME,
            //                           //sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
            //                           //casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
            //                           //productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
            //                           //customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
            //                           //loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
            //                           //loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
            //                           outstandingPrincipal = availableBalance,
            //                           dischargeLetter = a.DISCHARGELETTER,
            //                           suspendInterest = a.SUSPENDINTEREST,
            //                           customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
            //                           createdBy = a.CREATEDBY,
            //                           dateTimeCreated = a.DATETIMECREATED,
            //                           exchangeRate = a.EXCHANGERATE,
            //                           currencyId = a.CURRENCYID,
            //                           currency = a.TBL_CURRENCY.CURRENCYNAME,
            //                       }).FirstOrDefault();

            var overDraftDetail = (from a in context.TBL_LOAN_CONTINGENT
                                   join tt in context.TBL_OPERATIONS on a.OPERATIONID equals tt.OPERATIONID
                                   join br in context.TBL_BRANCH on a.BRANCHID equals br.BRANCHID
                                   join ld in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals ld.LOANAPPLICATIONDETAILID
                                   join lp in context.TBL_LOAN_APPLICATION on ld.LOANAPPLICATIONID equals lp.LOANAPPLICATIONID
                                   join at in context.TBL_LOAN_APPLICATION_TYPE on lp.LOANAPPLICATIONTYPEID equals at.LOANAPPLICATIONTYPEID
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   join pr in context.TBL_PRODUCT on a.PRODUCTID equals pr.PRODUCTID
                                   join st in context.TBL_STAFF on a.RELATIONSHIPOFFICERID equals st.STAFFID
                                   join stm in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals stm.STAFFID
                                   where a.CONTINGENTLOANID == contingentLoanId
                                   select new LoanViewModel
                                   {
                                       loanId = a.CONTINGENTLOANID,
                                       customerId = a.CUSTOMERID,
                                       customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                       customerCode = b.CUSTOMERCODE,
                                       productId = a.PRODUCTID,
                                       companyId = a.COMPANYID,
                                       casaAccountId = a.CASAACCOUNTID,
                                       branchId = a.BRANCHID,
                                       branchName = br.BRANCHNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       applicationReferenceNumber = lp.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       isLineFacility = ld.ISLINEFACILITY,
                                       loanApplicationId = lp.LOANAPPLICATIONID,
                                       productTypeId = pr.PRODUCTTYPEID,
                                       productName = pr.PRODUCTNAME,
                                       productTypeName = pr.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                       relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                       relationshipOfficerName = st.FIRSTNAME + " " + st.MIDDLENAME + " " + st.LASTNAME,
                                       relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                       relationshipManagerName = stm.FIRSTNAME + " " + stm.MIDDLENAME + " " + stm.LASTNAME,
                                       misCode = a.MISCODE,
                                       teamMiscode = a.TEAMMISCODE,
                                       //interestRate = a.INTERESTRATE,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       bookingDate = a.BOOKINGDATE,
                                       principalAmount = a.CONTINGENTAMOUNT,
                                       approvalStatusId = a.APPROVALSTATUSID,
                                       approverComment = a.APPROVERCOMMENT,
                                       dateApproved = a.DATEAPPROVED,
                                       loanStatusId = a.LOANSTATUSID,
                                       isDisbursed = a.ISDISBURSED,
                                       disburserComment = a.DISBURSERCOMMENT,
                                       disburseDate = a.DISBURSEDATE,
                                       operationId = a.OPERATIONID,
                                       operationName = tt.OPERATIONNAME,
                                       subSectorName = a.TBL_SUB_SECTOR.NAME,
                                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                       casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                       productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                       customerGroupId = lp.CUSTOMERGROUPID,
                                       loanTypeId = lp.LOANAPPLICATIONTYPEID,
                                       loanTypeName = at.LOANAPPLICATIONTYPENAME,
                                       //outstandingPrincipal = availableBalance,
                                       dischargeLetter = a.DISCHARGELETTER,
                                       //suspendInterest = a.SUSPENDINTEREST,
                                       customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                       createdBy = a.CREATEDBY,
                                       dateTimeCreated = a.DATETIMECREATED,
                                       exchangeRate = a.EXCHANGERATE,
                                       currencyId = a.CURRENCYID,
                                       operationTypeName = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == lp.OPERATIONID).Select(o => o.OPERATIONNAME).FirstOrDefault(),
                                       currency = a.TBL_CURRENCY.CURRENCYNAME,
                                       currencyCode = a.TBL_CURRENCY.CURRENCYCODE
                                   }).FirstOrDefault();
            //if (availableBalance > 0)
            //{
            //    contingentDetail.overDraft = overDraftLimit;
            //}
            //else
            //{
            //    overDraftDetail.overDraft = overDraftLimit - Math.Abs(availableBalance);
            //}
            return overDraftDetail;

        }
        public IEnumerable<LoanViewModel> GetContingentApprovedApplication(int staffId, int companyId)
        {
            var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            var staffs = generalSetup.GetStaffRlieved(staffId);

            var operationsRecords = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability).Select(x => x.LOANREVIEWAPPLICATIONID).ToList();
            var currentDate = generalSetup.GetApplicationDate();
            var allFilteredLoan = (from a in context.TBL_LOAN_CONTINGENT
                                   join b in context.TBL_LMSR_APPLICATION_DETAIL on a.CONTINGENTLOANID equals b.LOANID
                                   join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                   join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                   where a.ISDISBURSED == true
                                   //&& (b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTermination || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityRenewal || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTenorExtension || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityAmountReduction || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook) 
                                   && b.OPERATIONID != (int)OperationsEnum.APSReleaseApproval
                                   && b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability
                                   && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                   && b.OPERATIONPERFORMED == false
                                   && a.LOANSTATUSID != (short)LoanStatusEnum.Terminated
                                   //&& !operationsRecords.Contains(b.LOANREVIEWAPPLICATIONID)
                                   && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationCompleted
                                   && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationInProgress

                                   orderby b.DATETIMECREATED descending
                                   select new LoanViewModel
                                   {
                                       lmsLoanApplicationId = e.LOANAPPLICATIONID,
                                       lmsOperationId = e.OPERATIONID,

                                       creditAppraisalOperationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                                     (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault(),


                                       creditAppraisalLoanApplicationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault(),

                                       appraisalOperationName = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join o in context.TBL_OPERATIONS on aa.OPERATIONID equals o.OPERATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select o.OPERATIONNAME).FirstOrDefault() :
                                                     (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join o in context.TBL_OPERATIONS on aa.OPERATIONID equals o.OPERATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select o.OPERATIONNAME).FirstOrDefault() :
                                                     (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join o in context.TBL_OPERATIONS on aa.OPERATIONID equals o.OPERATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select o.OPERATIONNAME).FirstOrDefault(),

                                       divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == c.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                       divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                       loanReviewApplicationId = e.LOANAPPLICATIONID,
                                       loanReviewOperationId = e.OPERATIONID,
                                       loanId = a.CONTINGENTLOANID,
                                       customerId = a.CUSTOMERID,
                                       reviewLoanDetaile = b.REVIEWDETAILS,
                                       operationTypeName = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == e.OPERATIONID).Select(o => o.OPERATIONNAME).FirstOrDefault(),
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       currencyId = a.CURRENCYID,
                                       lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                       //interestRate = a.INTERESTRATE,
                                       principalAmount = a.CONTINGENTAMOUNT,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       operationId = b.OPERATIONID,
                                       operationName = b.TBL_OPERATIONS.OPERATIONNAME,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       systemCurrentDate = currentDate,
                                       lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                       loanSystemTypeId = b.LOANSYSTEMTYPEID,
                                       legalContingentCode = a.LEGALCONTINGENTCODE,
                                       //contigentOutstandingPrincipal = (from context.TBL_LOAN_REVIEW_OPERATION join y in context.TBL_LOAN_CONTINGENT on x.LOANID equals y.CONTINGENTLOANID where y.RELATED_LOAN_REFERENCE_NUMBER == a.RELATED_LOAN_REFERENCE_NUMBER && y.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved select  x.CONTINGENTOUTSTANDINGPRINCIPAL).FirstOrDefault(),
                                       //totalPrepayment = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.CONTINGENTLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved).Sum(m => m.PREPAYMENT),
                                       contigentOutstandingPrincipal = context.TBL_LOAN_REVIEW_OPERATION.Where(x=>x.LOANID == a.CONTINGENTLOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook).Sum(x=>x.CONTINGENTOUTSTANDINGPRINCIPAL),
                                       totalPrepayment = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == a.CONTINGENTLOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityAmountReduction).Sum(x => x.PREPAYMENT),

                                       operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.CONTINGENTLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                       {
                                           contigentOutstandingPrincipal = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == op.LOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook).Sum(x => x.CONTINGENTOUTSTANDINGPRINCIPAL),
                                           totalPrepayment = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == op.LOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityAmountReduction).Sum(x => x.PREPAYMENT),
                                           loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                           operationTypeId = op.OPERATIONTYPEID,
                                           operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                           newEffectiveDate = op.EFFECTIVEDATE,
                                           reviewDetails = op.REVIEWDETAILS,
                                           prepayment = op.PREPAYMENT,
                                           newInterateRate = op.INTERATERATE,
                                           newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                           newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                           newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                           newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newTenor = op.TENOR,
                                           cASA_AccountId = op.CASA_ACCOUNTID,
                                           cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                           overDraftTopup = op.OVERDRAFTTOPUP,
                                           fee_Charges = op.FEE_CHARGES,
                                           scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                           scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                           scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                           scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                           scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                           newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                           newMaturityDate = op.MATURITYDATE,
                                           dateTimeCreated = op.DATECREATED,
                                           legalContingentCode = op.LEGALCONTINGENTCODE,
                                       }).FirstOrDefault(),
                                   }).ToList();

            var referred = (from a in context.TBL_LOAN_CONTINGENT
                            join op in context.TBL_LOAN_REVIEW_OPERATION on a.CONTINGENTLOANID equals op.LOANID
                            join b in context.TBL_LMSR_APPLICATION_DETAIL on a.CONTINGENTLOANID equals b.LOANID
                            join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                            join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                            join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                            where a.ISDISBURSED == true
                            && b.OPERATIONID != (int)OperationsEnum.APSReleaseApproval
                            && b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability
                            && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && op.OPERATIONCOMPLETED == false
                            && a.LOANSTATUSID != (short)LoanStatusEnum.Terminated
                            && atrail.OPERATIONID != (int)OperationsEnum.GlobalInterestRateChange
                            && atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                            && atrail.RESPONSESTAFFID == null
                            && atrail.OPERATIONID == op.OPERATIONTYPEID
                            && atrail.APPROVALSTATEID != (int)ApprovalState.Ended
                            && staffs.Contains(atrail.LOOPEDSTAFFID ?? 0)
                            && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationCompleted
                            && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationInProgress

                            orderby b.DATETIMECREATED descending
                            select new LoanViewModel
                            {
                                lmsLoanApplicationId = e.LOANAPPLICATIONID,
                                lmsOperationId = e.OPERATIONID,

                                creditAppraisalOperationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                              (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                              (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault(),


                                creditAppraisalLoanApplicationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                              (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                              (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault(),

                                appraisalOperationName = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join o in context.TBL_OPERATIONS on aa.OPERATIONID equals o.OPERATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select o.OPERATIONNAME).FirstOrDefault() :
                                              (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join o in context.TBL_OPERATIONS on aa.OPERATIONID equals o.OPERATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select o.OPERATIONNAME).FirstOrDefault() :
                                              (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID join o in context.TBL_OPERATIONS on aa.OPERATIONID equals o.OPERATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select o.OPERATIONNAME).FirstOrDefault(),

                                divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == c.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                loanReviewApplicationId = e.LOANAPPLICATIONID,
                                loanReviewOperationId = e.OPERATIONID,
                                loanId = a.CONTINGENTLOANID,
                                customerId = a.CUSTOMERID,
                                reviewLoanDetaile = b.REVIEWDETAILS,
                                operationTypeName = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == e.OPERATIONID).Select(o => o.OPERATIONNAME).FirstOrDefault(),
                                customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                loanReferenceNumber = a.LOANREFERENCENUMBER,
                                currencyId = a.CURRENCYID,
                                lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                //interestRate = a.INTERESTRATE,
                                principalAmount = a.CONTINGENTAMOUNT,
                                effectiveDate = a.EFFECTIVEDATE,
                                maturityDate = a.MATURITYDATE,
                                operationId = b.OPERATIONID,
                                operationName = b.TBL_OPERATIONS.OPERATIONNAME,
                                loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                systemCurrentDate = currentDate,
                                lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                loanSystemTypeId = b.LOANSYSTEMTYPEID,
                                legalContingentCode = a.LEGALCONTINGENTCODE,
                                //contigentOutstandingPrincipal = (from context.TBL_LOAN_REVIEW_OPERATION join y in context.TBL_LOAN_CONTINGENT on x.LOANID equals y.CONTINGENTLOANID where y.RELATED_LOAN_REFERENCE_NUMBER == a.RELATED_LOAN_REFERENCE_NUMBER && y.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved select  x.CONTINGENTOUTSTANDINGPRINCIPAL).FirstOrDefault(),
                                //totalPrepayment = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.CONTINGENTLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved).Sum(m => m.PREPAYMENT),
                                contigentOutstandingPrincipal = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == a.CONTINGENTLOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook).Sum(x => x.CONTINGENTOUTSTANDINGPRINCIPAL),
                                totalPrepayment = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == a.CONTINGENTLOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityAmountReduction).Sum(x => x.PREPAYMENT),

                                operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.CONTINGENTLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                {
                                    contigentOutstandingPrincipal = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == op.LOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook).Sum(x => x.CONTINGENTOUTSTANDINGPRINCIPAL),
                                    totalPrepayment = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANID == op.LOANID && x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && x.OPERATIONTYPEID == (int)OperationsEnum.ContingentLiabilityAmountReduction).Sum(x => x.PREPAYMENT),
                                    loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                    operationTypeId = op.OPERATIONTYPEID,
                                    operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                    newEffectiveDate = op.EFFECTIVEDATE,
                                    reviewDetails = op.REVIEWDETAILS,
                                    prepayment = op.PREPAYMENT,
                                    newInterateRate = op.INTERATERATE,
                                    newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                    newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                    newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                    newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newTenor = op.TENOR,
                                    cASA_AccountId = op.CASA_ACCOUNTID,
                                    cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                    overDraftTopup = op.OVERDRAFTTOPUP,
                                    fee_Charges = op.FEE_CHARGES,
                                    scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                    scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                    scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                    scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                    scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                    newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                    newMaturityDate = op.MATURITYDATE,
                                    dateTimeCreated = op.DATECREATED,
                                    legalContingentCode = op.LEGALCONTINGENTCODE,
                                }).FirstOrDefault(),
                            }).ToList();

            allFilteredLoan = allFilteredLoan.Union(referred).ToList();
            List<LoanViewModel> lcyLoans = new List<LoanViewModel>();
            List<LoanViewModel> fcyLoans = new List<LoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            //if (isLCYUser == true)
            //{
            //    lcyLoans = allFilteredLoan.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
            //}

            //if (isFCYUser == true)
            //{
            //    fcyLoans = allFilteredLoan.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
            //}

            //allFilteredLoan = lcyLoans.Union(fcyLoans).ToList();
            return allFilteredLoan;

        }

        //public IEnumerable<LoanViewModel> GetContingentApprovedExpiredApplication(int staffId, int companyId)
        //{
        //    var activities = admin.GetUserActivitiesByUser(staffId);
        //    var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.CURRENCYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

        //    var currentDate = generalSetup.GetApplicationDate();
        //    var allFilteredLoan = (from a in context.TBL_LOAN_CONTINGENT
        //                           join b in context.TBL_LMSR_APPLICATION_DETAIL on a.CONTINGENTLOANID equals b.LOANID
        //                           join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
        //                           join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
        //                           where a.ISDISBURSED == true && (b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTermination || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityRenewal || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTenorExtension || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityAmountReduction || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook) && //(int)LoanSystemTypeEnum.OverdraftFacility &&
        //                           e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && b.OPERATIONPERFORMED == false && (a.LOANSTATUSID != (short)LoanStatusEnum.Terminated || a.LOANSTATUSID != (short)LoanStatusEnum.Expired )
        //                           && currentDate >= a.MATURITYDATE
        //                           orderby a.MATURITYDATE descending
        //                           select new LoanViewModel
        //                           {
        //                               loanReviewApplicationId = e.LOANAPPLICATIONID,
        //                               loanId = a.CONTINGENTLOANID,
        //                               customerId = a.CUSTOMERID,
        //                               customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
        //                               loanReferenceNumber = a.LOANREFERENCENUMBER,
        //                               lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
        //                               applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
        //                               loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
        //                               //interestRate = a.INTERESTRATE,
        //                               principalAmount = a.CONTINGENTAMOUNT,
        //                               effectiveDate = a.EFFECTIVEDATE,
        //                               maturityDate = a.MATURITYDATE,
        //                               operationId = b.OPERATIONID,
        //                               operationName = b.TBL_OPERATIONS.OPERATIONNAME,
        //                               loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
        //                               systemCurrentDate = currentDate,
        //                               lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
        //                               loanSystemTypeId = b.LOANSYSTEMTYPEID,
        //                               operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.CONTINGENTLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
        //                               {
        //                                   loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
        //                                   operationTypeId = op.OPERATIONTYPEID,
        //                                   operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
        //                                   newEffectiveDate = op.EFFECTIVEDATE,
        //                                   reviewDetails = op.REVIEWDETAILS,
        //                                   prepayment = op.PREPAYMENT,
        //                                   newInterateRate = op.INTERATERATE,
        //                                   newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
        //                                   newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
        //                                   newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
        //                                   newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
        //                                   newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
        //                                   newTenor = op.TENOR,
        //                                   cASA_AccountId = op.CASA_ACCOUNTID,
        //                                   cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
        //                                   overDraftTopup = op.OVERDRAFTTOPUP,
        //                                   fee_Charges = op.FEE_CHARGES,
        //                                   scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
        //                                   scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
        //                                   scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
        //                                   scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
        //                                   scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
        //                                   newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
        //                                   newMaturityDate = op.MATURITYDATE,
        //                                   dateTimeCreated = op.DATECREATED
        //                               }).FirstOrDefault(),
        //                           }).ToList();

        //    List<LoanViewModel> lcyLoans = new List<LoanViewModel>();
        //    List<LoanViewModel> fcyLoans = new List<LoanViewModel>();

        //    var isLCYUser = activities.Contains("lcy-user");
        //    var isFCYUser = activities.Contains("fcy-user");

        //    if (isLCYUser == true)
        //    {
        //        lcyLoans = allFilteredLoan.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
        //        //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
        //    }

        //    if (isFCYUser == true)
        //    {
        //        fcyLoans = allFilteredLoan.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

        //    }

        //    allFilteredLoan = lcyLoans.Union(fcyLoans).ToList();

        //    return allFilteredLoan;

        //}


        public IEnumerable<LoanViewModel> GetContingentApprovedExpiredApplication(int staffId, int companyId)
        {
            var staffRec = context.TBL_PROFILE_USER.Where(a => a.STAFFID == staffId).FirstOrDefault();

            var activities = admin.GetUserActivitiesByUser(staffRec.USERID);
            //var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

            var currentDate = generalSetup.GetApplicationDate();
            var allFilteredLoan = (from a in context.TBL_LOAN_CONTINGENT
                                       //join b in context.TBL_LMSR_APPLICATION_DETAIL on a.CONTINGENTLOANID equals b.LOANID
                                       //join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                   join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                   where a.ISDISBURSED == true
                                   //&& (b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTermination || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityRenewal || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTenorExtension || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityAmountReduction || b.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTerminateAndRebook) && //(int)LoanSystemTypeEnum.OverdraftFacility &&
                                   //e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved && b.OPERATIONPERFORMED == false && (a.LOANSTATUSID != (short)LoanStatusEnum.Terminated || a.LOANSTATUSID != (short)LoanStatusEnum.Expired )
                                   && currentDate >= a.MATURITYDATE
                                   orderby a.MATURITYDATE descending
                                   select new LoanViewModel
                                   {
                                       //loanReviewApplicationId = e.LOANAPPLICATIONID,
                                       loanId = a.CONTINGENTLOANID,
                                       customerId = a.CUSTOMERID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       //lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                       //interestRate = a.INTERESTRATE,
                                       principalAmount = a.CONTINGENTAMOUNT,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       //operationId = b.OPERATIONID,
                                       //operationName = b.TBL_OPERATIONS.OPERATIONNAME,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       systemCurrentDate = currentDate,
                                       //lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                       //loanSystemTypeId = b.LOANSYSTEMTYPEID,
                                       operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.CONTINGENTLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                       {
                                           loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                           operationTypeId = op.OPERATIONTYPEID,
                                           operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                           newEffectiveDate = op.EFFECTIVEDATE,
                                           reviewDetails = op.REVIEWDETAILS,
                                           prepayment = op.PREPAYMENT,
                                           newInterateRate = op.INTERATERATE,
                                           newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                           newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                           newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                           newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newTenor = op.TENOR,
                                           cASA_AccountId = op.CASA_ACCOUNTID,
                                           cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                           overDraftTopup = op.OVERDRAFTTOPUP,
                                           fee_Charges = op.FEE_CHARGES,
                                           scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                           scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                           scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                           scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                           scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                           newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                           newMaturityDate = op.MATURITYDATE,
                                           dateTimeCreated = op.DATECREATED
                                       }).FirstOrDefault(),
                                   }).ToList();

            List<LoanViewModel> lcyLoans = new List<LoanViewModel>();
            List<LoanViewModel> fcyLoans = new List<LoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = allFilteredLoan.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
            }

            if (isFCYUser == true)
            {
                fcyLoans = allFilteredLoan.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            allFilteredLoan = lcyLoans.Union(fcyLoans).ToList();

            return allFilteredLoan;

        }


        private IQueryable<WorkflowTrackerViewModel> GetApprovalTrail(int companyId, int staffId, int targetId, int operationId)
        {
            var loggedsStaff = context.TBL_STAFF.Find(staffId);
            var result = (from a in context.TBL_APPROVAL_TRAIL
                              // join b in context.TBL_APPROVAL_LEVEL on a.FROMAPPROVALLEVELID equals b.APPROVALLEVELID
                              //  join c in context.TBL_APPROVAL_GROUP on b.GROUPID equals c.GROUPID
                              // join d in context.TBL_APPROVAL_GROUP_MAPPING on c.GROUPID equals d.GROUPID
                              // join e in context.TBL_OPERATIONS on d.OPERATIONID equals e.OPERATIONID

                              // join i in context.TBL_STAFF on a.REQUESTSTAFFID equals i.STAFFID
                              //join j in context.TBL_STAFF on a.RESPONSESTAFFID equals j.STAFFID into apprStaff
                              // from j in apprStaff.DefaultIfEmpty()
                              // join k in context.TBL_APPROVAL_STATUS on a.APPROVALSTATUSID equals k.APPROVALSTATUSID
                          where a.COMPANYID == companyId
                          where a.TARGETID == targetId && a.OPERATIONID == operationId
                          select new WorkflowTrackerViewModel
                          {
                              arrivalDate = a.ARRIVALDATE,
                              responseApprovalLevel = a.TOAPPROVALLEVELID.HasValue ? a.TBL_APPROVAL_LEVEL1.LEVELNAME : "N/A",
                              responseDate = a.SYSTEMRESPONSEDATETIME ?? DateTime.Now,
                              systemArrivalDate = a.SYSTEMARRIVALDATETIME,
                              systemResponseDate = a.SYSTEMRESPONSEDATETIME,
                              responseStaffName = !a.TOAPPROVALLEVELID.HasValue ? "Initiation" : a.TBL_APPROVAL_LEVEL1.LEVELNAME,
                              comment = a.COMMENT,
                              requestStaffName = a.TBL_STAFF.FIRSTNAME != null ? a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.LASTNAME : null,
                              requestApprovalLevel = !a.FROMAPPROVALLEVELID.HasValue ? "Initiation" : a.TBL_APPROVAL_LEVEL.LEVELNAME,
                              TargetId = a.TARGETID,
                              approvalTrailId = a.APPROVALTRAILID,
                              // operationId = e.OPERATIONID,
                              // operationName = e.OPERATIONNAME,
                              //approvalStatus = context.TBL_APPROVAL_STATUS.Where(x=>x.APPROVALSTATUSID == a.APPROVALSTATUSID).FirstOrDefault().APPROVALSTATUSNAME
                              approvalStatus = a.TBL_APPROVAL_STATUS.APPROVALSTATUSNAME.ToUpper()
                          }).Distinct().OrderByDescending(O => O.approvalTrailId);

            var response = result.ToList();
            return result;
        }

        public async Task<IEnumerable<WorkflowTrackerViewModel>> GetApprovalTrailByOperationIdAndTargetId(int operationId, int targetId, int companyId, int staffId)
        {
            var result = GetApprovalTrail(companyId, staffId, targetId, operationId).ToList();
            return result.Distinct();
        }

        public LoanViewModel GetGroupLoanByLoanId(int loanId)
        {
            var loanDetails = (from a in context.TBL_LOAN
                               join d in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                               join e in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                               join f in context.TBL_PRODUCT on a.PRODUCTID equals f.PRODUCTID
                               join pt in context.TBL_PRODUCT_TYPE on f.PRODUCTTYPEID equals pt.PRODUCTTYPEID
                               join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                               join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                               join cur in context.TBL_CURRENCY on a.CURRENCYID equals cur.CURRENCYID
                               join br in context.TBL_BRANCH on a.BRANCHID equals br.BRANCHID
                               join ro in context.TBL_STAFF on a.RELATIONSHIPOFFICERID equals ro.STAFFID
                               join rm in context.TBL_STAFF on a.RELATIONSHIPMANAGERID equals rm.STAFFID
                               where a.TERMLOANID == loanId && a.ISDISBURSED == true
                               select new LoanViewModel
                               {
                                   loanId = a.TERMLOANID,
                                   loanApplicationId = a.LOANAPPLICATIONDETAILID,
                                   customerId = a.CUSTOMERID,
                                   customerName = b.FIRSTNAME + " " + b.LASTNAME,
                                   customerCode = b.CUSTOMERCODE,
                                   customerGroupId = e.CUSTOMERGROUPID,
                                   productId = a.PRODUCTID,
                                   companyId = a.COMPANYID,
                                   groupCustomerName = e.TBL_CUSTOMER_GROUP.GROUPNAME,
                                   casaAccountId = a.CASAACCOUNTID,
                                   branchId = a.BRANCHID,
                                   branchName = br.BRANCHNAME,
                                   loanReferenceNumber = a.LOANREFERENCENUMBER,
                                   applicationReferenceNumber = e.APPLICATIONREFERENCENUMBER ?? "N/A",
                                   principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                   principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                   interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                   interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                   productTypeId = f.PRODUCTTYPEID,
                                   productName = f.PRODUCTNAME,
                                   productTypeName = pt.PRODUCTTYPENAME,
                                   principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                   interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                   relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                   relationshipOfficerName = ro.FIRSTNAME + " " + ro.MIDDLENAME + " " + ro.LASTNAME,
                                   relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                   relationshipManagerName = rm.FIRSTNAME + " " + rm.MIDDLENAME + " " + rm.LASTNAME,
                                   misCode = a.MISCODE,
                                   teamMiscode = a.TEAMMISCODE,
                                   interestRate = a.INTERESTRATE,
                                   effectiveDate = a.EFFECTIVEDATE,
                                   maturityDate = a.MATURITYDATE,
                                   bookingDate = a.BOOKINGDATE,
                                   principalAmount = a.PRINCIPALAMOUNT,
                                   principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                   interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                   approvalStatusId = a.APPROVALSTATUSID,
                                   approvedBy = a.APPROVEDBY,
                                   approverComment = a.APPROVERCOMMENT,
                                   dateApproved = a.DATEAPPROVED,
                                   loanStatusId = a.LOANSTATUSID,
                                   scheduleTypeId = a.SCHEDULETYPEID,
                                   isDisbursed = a.ISDISBURSED,
                                   disbursedBy = a.DISBURSEDBY,
                                   disburserComment = a.DISBURSERCOMMENT,
                                   disburseDate = a.DISBURSEDATE,
                                   operationId = a.OPERATIONID,
                                   operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                   subSectorName = a.TBL_SUB_SECTOR.NAME,
                                   sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                   casaAccountNumber = c.PRODUCTACCOUNTNUMBER,
                                   productAccountName = c.PRODUCTACCOUNTNAME,
                                   loanTypeId = e.LOANAPPLICATIONTYPEID,
                                   equityContribution = a.EQUITYCONTRIBUTION,
                                   firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                   firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                   outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                   outstandingInterest = a.OUTSTANDINGINTEREST,
                                   principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                   principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                   fixedPrincipal = a.FIXEDPRINCIPAL,
                                   profileLoan = a.PROFILELOAN,
                                   dischargeLetter = a.DISCHARGELETTER,
                                   suspendInterest = a.SUSPENDINTEREST,
                                   customerSensitivityLevelId = b.CUSTOMERSENSITIVITYLEVELID,
                                   createdBy = a.CREATEDBY,
                                   dateTimeCreated = a.DATETIMECREATED,
                                   exchangeRate = a.EXCHANGERATE,
                                   currencyId = a.CURRENCYID,
                                   currency = cur.CURRENCYNAME
                               }).FirstOrDefault();

            return loanDetails;
        }

        private void PostContingentLiabilityPrincipalEntry(int debitGLId, int creditGLId, TBL_LOAN_CONTINGENT loan, decimal chargeAmount, BasicTrasactionSourceInputModel basicInput, TwoFactorAutheticationViewModel twoFactorAuth)
        {
            var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

            FinanceTransactionViewModel debit = new FinanceTransactionViewModel();
            debit.operationId = (int)OperationsEnum.ContigentLoanBooking;
            debit.description = basicInput.description;
            debit.valueDate = generalSetup.GetApplicationDate();
            debit.transactionDate = debit.valueDate;
            debit.currencyId = loan.CURRENCYID;
            debit.currencyRate = financeTransaction.GetExchangeRate(debit.valueDate, debit.currencyId, basicInput.companyId).sellingRate;
            debit.isApproved = true;
            debit.postedBy = basicInput.createdBy;
            debit.approvedBy = basicInput.createdBy;
            debit.approvedDate = debit.transactionDate;
            debit.approvedDateTime = DateTime.Now;
            debit.sourceApplicationId = basicInput.sourceApplicationId;
            debit.companyId = basicInput.companyId;
            debit.batchCode = transactionCode;
            debit.glAccountId = debitGLId; // (int)casa.TBL_PRODUCT.PRINCIPALBALANCEGL;
            debit.sourceReferenceNumber = loan.LOANREFERENCENUMBER;
            debit.casaAccountId = null;
            debit.debitAmount = chargeAmount;
            debit.creditAmount = 0;
            debit.sourceBranchId = loan.BRANCHID;
            debit.destinationBranchId = loan.BRANCHID;

            FinanceTransactionViewModel credit = new FinanceTransactionViewModel();
            credit.operationId = (int)OperationsEnum.ContigentLoanBooking;
            credit.description = basicInput.description;
            credit.valueDate = generalSetup.GetApplicationDate();
            credit.transactionDate = credit.valueDate;
            credit.currencyId = loan.CURRENCYID;
            credit.currencyRate = financeTransaction.GetExchangeRate(credit.valueDate, credit.currencyId, basicInput.companyId).sellingRate;
            credit.isApproved = true;
            credit.postedBy = basicInput.createdBy;
            credit.approvedBy = basicInput.createdBy;
            credit.approvedDate = credit.transactionDate;
            credit.approvedDateTime = DateTime.Now;
            credit.sourceApplicationId = basicInput.sourceApplicationId;
            credit.companyId = basicInput.companyId;
            credit.batchCode = transactionCode;
            credit.glAccountId = creditGLId;
            credit.sourceReferenceNumber = loan.LOANREFERENCENUMBER;
            credit.casaAccountId = null;
            credit.debitAmount = 0;
            credit.creditAmount = chargeAmount;
            credit.sourceBranchId = loan.BRANCHID;
            credit.destinationBranchId = loan.BRANCHID;

            List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();

            inputTransactions.Add(debit);
            inputTransactions.Add(credit);
            financeTransaction.PostTransaction(inputTransactions, false, twoFactorAuth);
        }

        //private void ReverseDebit(int debitGLId, int creditGLId, TBL_CASA casa, decimal chargeAmount, int? creditAccountId, BasicTrasactionSourceInputModel basicInput)
        //{
        //    var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

        //    FinanceTransactionViewModel debit = new FinanceTransactionViewModel();
        //    debit.operationId = (int)OperationsEnum.CreditBureauSearch;
        //    debit.description = basicInput.description;
        //    debit.valueDate = generalSetup.GetApplicationDate();
        //    debit.transactionDate = debit.valueDate;
        //    debit.currencyId = casa.CURRENCYID;
        //    debit.currencyRate = financeTransaction.GetExchangeRate(debit.valueDate, debit.currencyId, basicInput.companyId).sellingRate;
        //    debit.isApproved = true;
        //    debit.postedBy = basicInput.createdBy;
        //    debit.approvedBy = basicInput.createdBy;
        //    debit.approvedDate = debit.transactionDate;
        //    debit.approvedDateTime = DateTime.Now;
        //    debit.sourceApplicationId = basicInput.sourceApplicationId;
        //    debit.companyId = basicInput.companyId;
        //    debit.batchCode = transactionCode;
        //    debit.glAccountId = debitGLId;
        //    debit.sourceReferenceNumber = transactionCode;
        //    debit.casaAccountId = null;
        //    debit.debitAmount = chargeAmount;
        //    debit.creditAmount = 0;
        //    debit.sourceBranchId = basicInput.userBranchId;
        //    debit.destinationBranchId = casa.BRANCHID;

        //    FinanceTransactionViewModel credit = new FinanceTransactionViewModel();
        //    credit.operationId = (int)OperationsEnum.CreditBureauSearch;
        //    credit.description = basicInput.description;
        //    credit.valueDate = generalSetup.GetApplicationDate();
        //    credit.transactionDate = credit.valueDate;
        //    credit.currencyId = casa.CURRENCYID;
        //    credit.currencyRate = financeTransaction.GetExchangeRate(credit.valueDate, credit.currencyId, basicInput.companyId).sellingRate;
        //    credit.isApproved = true;
        //    credit.postedBy = basicInput.createdBy;
        //    credit.approvedBy = basicInput.createdBy;
        //    credit.approvedDate = credit.transactionDate;
        //    credit.approvedDateTime = DateTime.Now;
        //    credit.sourceApplicationId = basicInput.sourceApplicationId;
        //    credit.companyId = basicInput.companyId;
        //    credit.batchCode = transactionCode;
        //    credit.glAccountId = (int)casa.TBL_PRODUCT.PRINCIPALBALANCEGL;
        //    credit.sourceReferenceNumber = transactionCode;
        //    credit.casaAccountId = creditAccountId;
        //    credit.debitAmount = 0;
        //    credit.creditAmount = chargeAmount;
        //    credit.sourceBranchId = basicInput.userBranchId;
        //    credit.destinationBranchId = basicInput.userBranchId;

        //    List<FinanceTransactionViewModel> inputTransactions = new List<FinanceTransactionViewModel>();
        //    inputTransactions.Add(debit);
        //    inputTransactions.Add(credit);
        //    financeTransaction.PostTransaction(inputTransactions);
        //}


        //private IQueryable<LoanViewModel> SearchTermLoan(string searchQuery)
        //{
        //    DateTime applicationDate = getApplicationDate();

        //    if (!string.IsNullOrWhiteSpace(searchQuery))
        //    {
        //        searchQuery = searchQuery.ToUpper();
        //    }
        //    var allFilteredLoan = (from a in context.TBL_LOAN
        //                           join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
        //                           join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
        //                           where a.ISDISBURSED == true &&  // a.MATURITYDATE >=      &&  //a.LOANSTATUSID != 7 &&
        //                           (a.LOANREFERENCENUMBER.ToUpper().Contains(searchQuery.Trim()) ||
        //                           b.CUSTOMERCODE.ToUpper().Contains(searchQuery.Trim()) ||
        //                           b.FIRSTNAME.ToUpper().Contains(searchQuery.Trim()) ||
        //                           b.LASTNAME.ToUpper().Contains(searchQuery.Trim()) ||
        //                           b.CUSTOMERID.ToString().Contains(searchQuery.Trim()) ||
        //                           c.PRODUCTACCOUNTNUMBER.ToUpper().Contains(searchQuery.Trim())) 
        //                           && (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled 
        //                               || a.LOANSTATUSID != (short)LoanStatusEnum.Terminated 
        //                               || a.LOANSTATUSID != (short)LoanStatusEnum.Inactive
        //                               || a.LOANSTATUSID != (short)LoanStatusEnum.Completed
        //                           ) 
        //                          // && a.MATURITYDATE > applicationDate
        //                           select new LoanViewModel
        //                           {
        //                               loanId = a.TERMLOANID,
        //                               customerId = a.CUSTOMERID,
        //                               currencyId = a.CURRENCYID,
        //                               productId = a.PRODUCTID,
        //                               customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
        //                               loanReferenceNumber = a.LOANREFERENCENUMBER,
        //                               loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
        //                               applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
        //                               loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
        //                               interestRate = a.INTERESTRATE,
        //                               principalAmount = a.PRINCIPALAMOUNT,
        //                               effectiveDate = a.EFFECTIVEDATE,
        //                               maturityDate = a.MATURITYDATE,
        //                               //loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
        //                               productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
        //                               productName = a.TBL_PRODUCT.PRODUCTNAME,
        //                               isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == 1,
        //                               writtenOff = a.LOANSTATUSID == 7,
        //                               loanStatusId = a.LOANSTATUSID,
        //                               loanSystemTypeId = a.LOANSYSTEMTYPEID
        //                           });
        //    var j = allFilteredLoan.ToList();
        //    return allFilteredLoan;
        //}

        //private IQueryable<LoanViewModel> SearchTermLoan(string searchQuery)
        //{
        //    DateTime applicationDate = getApplicationDate();

        //    if (!string.IsNullOrWhiteSpace(searchQuery))
        //    {
        //        searchQuery = searchQuery.ToUpper().Trim();
        //    }
        //    var allFilteredLoan = (from a in context.TBL_LOAN
        //                           join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
        //                           join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
        //                           where a.ISDISBURSED == true &&  // a.MATURITYDATE >=      &&  //a.LOANSTATUSID != 7 &&
        //                           (a.LOANREFERENCENUMBER.ToUpper().Contains(searchQuery.Trim()) ||
        //                           b.CUSTOMERCODE.ToUpper().Contains(searchQuery.Trim()) ||
        //                           b.FIRSTNAME.ToUpper().Contains(searchQuery.Trim()) ||
        //                           b.LASTNAME.ToUpper().Contains(searchQuery.Trim()) ||
        //                           c.PRODUCTACCOUNTNUMBER.ToUpper().Contains(searchQuery.Trim()))
        //                           && (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled
        //                               || a.LOANSTATUSID != (short)LoanStatusEnum.Terminated
        //                               || a.LOANSTATUSID != (short)LoanStatusEnum.Inactive
        //                               || a.LOANSTATUSID != (short)LoanStatusEnum.Completed
        //                           )
        //                           // && a.MATURITYDATE > applicationDate
        //                           select new LoanViewModel
        //                           {
        //                               loanId = a.TERMLOANID,
        //                               customerId = a.CUSTOMERID,
        //                               currencyId = a.CURRENCYID,
        //                               productId = a.PRODUCTID,
        //                               customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
        //                               loanReferenceNumber = a.LOANREFERENCENUMBER,
        //                               loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
        //                               applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
        //                               loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
        //                               interestRate = a.INTERESTRATE,
        //                               principalAmount = a.PRINCIPALAMOUNT,
        //                               effectiveDate = a.EFFECTIVEDATE,
        //                               maturityDate = a.MATURITYDATE,
        //                               //loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
        //                               productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
        //                               productName = a.TBL_PRODUCT.PRODUCTNAME,
        //                               isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == 1,
        //                               writtenOff = a.LOANSTATUSID == 7,
        //                               loanStatusId = a.LOANSTATUSID,
        //                               loanSystemTypeId = a.LOANSYSTEMTYPEID
        //                           });
        //    var j = allFilteredLoan.ToList();
        //    return allFilteredLoan;
        //}

        private IEnumerable<LoanViewModel> SearchTermLoan(string searchQuery, int statusId = 0)
        {
            DateTime applicationDate = getApplicationDate();

            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToUpper().Trim();
            }
            List<short> loanStatus = new List<short>();
            if (statusId == (short)LoanStatusEnum.WriteOff)
            {
                loanStatus.Add((short)LoanStatusEnum.Cancelled);
                loanStatus.Add((short)LoanStatusEnum.Terminated);
                loanStatus.Add((short)LoanStatusEnum.Inactive);
                loanStatus.Add((short)LoanStatusEnum.Completed);
                loanStatus.Add((short)LoanStatusEnum.Active);
                loanStatus.Add((short)LoanStatusEnum.Suspended);
                loanStatus.Add((short)LoanStatusEnum.FullAndFinalWriteOff);
            }
            else
            {
                loanStatus.Add((short)LoanStatusEnum.Cancelled);
                loanStatus.Add((short)LoanStatusEnum.Terminated);
                loanStatus.Add((short)LoanStatusEnum.Inactive);
                loanStatus.Add((short)LoanStatusEnum.Completed);
                loanStatus.Add((short)LoanStatusEnum.WriteOff);
            }


            List<LoanViewModel> allFilteredLoan = new List<LoanViewModel>();

            var searchResult2 = (from a in context.TBL_LOAN
                                 join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                 join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                 where a.ISDISBURSED == true &&  // a.MATURITYDATE >=      &&  //a.LOANSTATUSID != 7 &&
                                 (a.LOANREFERENCENUMBER.ToUpper().Contains(searchQuery.Trim()) ||
                                 b.CUSTOMERCODE.ToUpper().Contains(searchQuery.Trim()) ||
                                 b.FIRSTNAME.ToUpper().Contains(searchQuery.Trim()) ||
                                 b.LASTNAME.ToUpper().Contains(searchQuery.Trim()) ||
                                 c.PRODUCTACCOUNTNUMBER.ToUpper().Contains(searchQuery.Trim()))
                                 && !loanStatus.Contains(a.LOANSTATUSID)
                                 select new LoanViewModel
                                 {
                                     loanId = a.TERMLOANID,
                                     customerId = a.CUSTOMERID,
                                     currencyId = a.CURRENCYID,
                                     applicationDetailId = (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID where p.TERMLOANID == a.TERMLOANID select l.LOANAPPLICATIONDETAILID).FirstOrDefault(),
                                     customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                     loanReferenceNumber = a.LOANREFERENCENUMBER,
                                     loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                     applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                     loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
                                     interestRate = a.INTERESTRATE,
                                     principalAmount = a.PRINCIPALAMOUNT,
                                     effectiveDate = a.EFFECTIVEDATE,
                                     maturityDate = a.MATURITYDATE,
                                     loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                     productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                     productName = a.TBL_PRODUCT.PRODUCTNAME,
                                     isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == 1,
                                     writtenOff = a.LOANSTATUSID == 7,
                                     loanStatusId = a.LOANSTATUSID,
                                     loanSystemTypeId = a.LOANSYSTEMTYPEID,

                                     productClassId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.PRODUCTCLASSID ?? 0,
                                     productId = a.PRODUCTID,
                                     productClassProcessId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.PRODUCT_CLASS_PROCESSID,
                                     loanApplicationTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                     //approvedAmount = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPROVEDAMOUNT,


                                 }).ToList();

            //allFilteredLoan = searchResult2.ToList();

            if (searchResult2.Count > 0)
            {
                allFilteredLoan.AddRange(searchResult2);
            }
            var revolving = SearchRevolvingLoan(searchQuery, statusId).ToList();
            if (revolving.Count > 0)
            {
                allFilteredLoan.AddRange(revolving);
            }
            var contingent = SearchContigentLoan(searchQuery, statusId).ToList();
            if (contingent.Count > 0)
            {
                allFilteredLoan.AddRange(contingent);
            }
            var line = SearchLoanLine(searchQuery, statusId).ToList();
            if (line.Count > 0)
            {
                allFilteredLoan.AddRange(line);
            }
            allFilteredLoan.AddRange(SearchSavedExternalFacility(searchQuery, statusId).ToList());
            //if (searchResult == null || searchResult.Count() < 1)
            //{
            //    searchRevolvingLoan = SearchRevolvingLoan(searchQuery).ToList();
            //    searchResult = searchRevolvingLoan;

            //    if (searchRevolvingLoan == null || searchRevolvingLoan.Count() < 1)
            //    {
            //        searchAllOverdraft = SearchAllOverdraft(searchQuery).ToList();
            //        searchResult = searchAllOverdraft;

            //        if (searchAllOverdraft == null || searchAllOverdraft.Count() < 1)
            //        {
            //            searchContigentLoan = SearchContigentLoan(searchQuery).ToList();
            //            searchResult = searchContigentLoan;
            //        }
            //        else
            //        {
            //            searchLoanLine = SearchLoanLine(searchQuery).ToList();
            //            searchResult = searchLoanLine;
            //        }
            //    }
            //}

            return allFilteredLoan.ToList();
        }

        //private IQueryable<LoanViewModel> SearchRevolvingLoan(string searchQuery)
        //{
        //    DateTime applicationDate = getApplicationDate();

        //    if (!string.IsNullOrWhiteSpace(searchQuery))
        //    {
        //        searchQuery = searchQuery.ToLower();
        //    }

        //    var allFilteredLoan = (from a in context.TBL_LOAN_REVOLVING
        //                           join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
        //                           join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
        //                           where a.ISDISBURSED == true && //a.LOANSTATUSID != 7 &&
        //                           (a.LOANREFERENCENUMBER.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.CUSTOMERCODE.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.FIRSTNAME.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.LASTNAME.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.CUSTOMERID.ToString().Contains(searchQuery.Trim()) ||
        //                           c.PRODUCTACCOUNTNUMBER.ToLower().Contains(searchQuery.Trim())) 
        //                           && (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled || a.LOANSTATUSID != (short)LoanStatusEnum.Terminated)  //|| a.LOANSTATUSID != (short)LoanStatusEnum.Inactive || a.LOANSTATUSID != (short)LoanStatusEnum.Completed
        //                          // && a.MATURITYDATE > applicationDate
        //                           select new LoanViewModel
        //                           {
        //                               loanId = a.REVOLVINGLOANID,
        //                               customerId = a.CUSTOMERID,
        //                               currencyId = a.CURRENCYID,
        //                               productId = a.PRODUCTID,
        //                               loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
        //                               customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
        //                               loanReferenceNumber = a.LOANREFERENCENUMBER,
        //                               applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
        //                               loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
        //                               interestRate = a.INTERESTRATE,
        //                               principalAmount = a.OVERDRAFTLIMIT,
        //                               effectiveDate = a.EFFECTIVEDATE,
        //                               maturityDate = a.MATURITYDATE,
        //                               loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
        //                               productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
        //                               productName = a.TBL_PRODUCT.PRODUCTNAME,
        //                               isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == (short)PrudentialGuidelineTypeEnum.Performing,
        //                               writtenOff = a.LOANSTATUSID == (short)LoanStatusEnum.WriteOff,
        //                               loanStatusId = a.LOANSTATUSID,
        //                               loanSystemTypeId = a.LOANSYSTEMTYPEID
        //                           });

        //    var test = allFilteredLoan.ToList();

        //    return allFilteredLoan;
        //}

        private IQueryable<LoanViewModel> SearchRevolvingLoan(string searchQuery, int statusId = 0)
        {
            DateTime applicationDate = getApplicationDate();

            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToLower();
            }
            List<short> loanStatus = new List<short>();
            if (statusId == (short)LoanStatusEnum.WriteOff)
            {
                loanStatus.Add((short)LoanStatusEnum.Cancelled);
                loanStatus.Add((short)LoanStatusEnum.Terminated);
                loanStatus.Add((short)LoanStatusEnum.Active);
                loanStatus.Add((short)LoanStatusEnum.Suspended);
                loanStatus.Add((short)LoanStatusEnum.FullAndFinalWriteOff);
            }
            else
            {
                loanStatus.Add((short)LoanStatusEnum.Cancelled);
                loanStatus.Add((short)LoanStatusEnum.Terminated);
                loanStatus.Add((short)LoanStatusEnum.WriteOff);
            }

            var allFilteredLoan = (from a in context.TBL_LOAN_REVOLVING
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                   where a.ISDISBURSED == true && //a.LOANSTATUSID != 7 &&
                                   (a.LOANREFERENCENUMBER.ToLower().Contains(searchQuery.Trim()) ||
                                   b.CUSTOMERCODE.ToLower().Contains(searchQuery.Trim()) ||
                                   b.FIRSTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                   b.LASTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                   c.PRODUCTACCOUNTNUMBER.ToLower().Contains(searchQuery.Trim()))
                                   && !loanStatus.Contains(a.LOANSTATUSID) //|| a.LOANSTATUSID != (short)LoanStatusEnum.Inactive || a.LOANSTATUSID != (short)LoanStatusEnum.Completed
                                                                           // && a.MATURITYDATE > applicationDate
                                   select new LoanViewModel
                                   {
                                       loanId = a.REVOLVINGLOANID,
                                       customerId = a.CUSTOMERID,
                                       currencyId = a.CURRENCYID,
                                       loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                       applicationDetailId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONDETAILID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                       interestRate = a.INTERESTRATE,
                                       principalAmount = a.OVERDRAFTLIMIT,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == (short)PrudentialGuidelineTypeEnum.Performing,
                                       writtenOff = a.LOANSTATUSID == (short)LoanStatusEnum.WriteOff,
                                       loanStatusId = a.LOANSTATUSID,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,

                                       productClassId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.PRODUCTCLASSID ?? 0,
                                       productId = a.PRODUCTID,
                                       productClassProcessId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.PRODUCT_CLASS_PROCESSID,
                                       loanApplicationTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                       approvedAmount = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPROVEDAMOUNT,
                                   });

            var test = allFilteredLoan.ToList();

            return allFilteredLoan;
        }

        private IQueryable<LoanViewModel> SearchSavedExternalFacility(string searchQuery, int statusId = 0)
        {
            DateTime applicationDate = getApplicationDate();

            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToLower();
            }
            List<short> loanStatus = new List<short>();
            loanStatus.Add((short)LoanStatusEnum.Cancelled);
            loanStatus.Add((short)LoanStatusEnum.Terminated);

            List<LoanViewModel> allFilteredLoan = new List<LoanViewModel>();

            var searchResult1 = (from a in context.TBL_LOAN_EXTERNAL
                                 join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                 join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                 join p in context.TBL_PRODUCT on a.PRODUCTID equals p.PRODUCTID
                                 where a.ISDISBURSED == true &&  // a.MATURITYDATE >=      &&  //a.LOANSTATUSID != 7 &&
                                 (a.LOANREFERENCENUMBER.ToLower().Contains(searchQuery.Trim()) ||
                                 b.CUSTOMERCODE.ToLower().Contains(searchQuery.Trim()) ||
                                 b.FIRSTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                 b.LASTNAME.ToUpper().Contains(searchQuery.Trim()) ||
                                 c.PRODUCTACCOUNTNUMBER.ToLower().Contains(searchQuery.Trim()))
                                 && !loanStatus.Contains(a.LOANSTATUSID)
                                 select new LoanViewModel
                                 {
                                     loanId = a.EXTERNALLOANID,
                                     customerId = a.CUSTOMERID,
                                     currencyId = a.CURRENCYID,
                                     casaAccountId = c.CASAACCOUNTID,
                                     customerCode = b.CUSTOMERCODE,
                                     //applicationDetailId = (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID where p.TERMLOANID == a.EXTERNALLOANID select l.LOANAPPLICATIONDETAILID).FirstOrDefault(),
                                     customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                     loanReferenceNumber = a.LOANREFERENCENUMBER,
                                     //loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                     //applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                     //loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
                                     interestRate = a.INTERESTRATE,
                                     principalAmount = a.PRINCIPALAMOUNT,
                                     effectiveDate = a.EFFECTIVEDATE,
                                     maturityDate = a.MATURITYDATE,
                                     //loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                     productTypeId = p.PRODUCTTYPEID,
                                     productName = p.PRODUCTNAME,
                                     isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == 1,
                                     writtenOff = a.LOANSTATUSID == 7,
                                     loanStatusId = a.LOANSTATUSID,
                                     loanSystemTypeId = a.LOANSYSTEMTYPEID,

                                     productClassId = p.PRODUCTCLASSID,
                                     productId = a.PRODUCTID,
                                     productClassProcessId = p.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                                     //loanApplicationTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                     //approvedAmount = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPROVEDAMOUNT,                                
                                     isExternalFacility = true,
                                     isSavedExternalFacility = true,
                                     //approvedAmount = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPROVEDAMOUNT,

                                 }).ToList();

            allFilteredLoan.AddRange(searchResult1);

            var searchResult2 = (from a in context.TBL_GLOBAL_EXPOSURE
                                 join p in context.TBL_PRODUCT on a.PRODUCTCODE equals p.PRODUCTCODE
                                 where (a.REFERENCENUMBER.ToLower().Trim().Contains(searchQuery.Trim()) ||
                                 a.CUSTOMERID.ToLower().Trim().Contains(searchQuery.Trim()) ||
                                 a.CUSTOMERNAME.ToLower().Trim().Contains(searchQuery.Trim()) ||
                                 a.ACCOUNTNUMBER.ToLower().Trim().Contains(searchQuery.Trim()))
                                 select new LoanViewModel
                                 {
                                     loanId = a.ID,
                                     //casaAccountId = int.Parse(a.ACCOUNTNUMBER),
                                     //customerId = Convert.ToInt16(a.CUSTOMERID),
                                     //currencyId = a.CURRENCYID,
                                     //applicationDetailId = (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID where p.TERMLOANID == a.TERMLOANID select l.LOANAPPLICATIONDETAILID).FirstOrDefault(),
                                     customerName = a.CUSTOMERNAME, //FIRSTNAME + " " + b.LASTNAME,
                                     loanReferenceNumber = a.REFERENCENUMBER,
                                     customerCode = a.CUSTOMERID,
                                     //loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                     applicationReferenceNumber = "NA", //a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                     loanApplicationId = 0,//a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
                                     //interestRate = a.INTERESTRATE != null ? a.INTERESTRATE  : 0,
                                     principalAmount = a.LOANAMOUNYLCY ?? 0,
                                     effectiveDate = a.VALUEDATE ?? DateTime.Now,
                                     maturityDate = a.MATURITYDATE ?? DateTime.Now,
                                     loanTypeName = a.CUSTOMERNAME != a.GROUPOBLIGORNAME ? "Group Customer" : "Single Customer", // a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                     productTypeId = p.PRODUCTTYPEID,
                                     productName = p.PRODUCTNAME,
                                     productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                     isPerforming = a.CBNCLASSIFICATION == "PERFORMING",
                                     writtenOff = false,
                                     //loanStatusId = a.LOANSTATUSID,
                                     loanSystemTypeId = (short)LoanSystemTypeEnum.ExternalFacility,

                                     productClassId = p.PRODUCTCLASSID,
                                     productId = p.PRODUCTID,
                                     productClassProcessId = p.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                                     //loanApplicationTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                     //approvedAmount = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPROVEDAMOUNT,                                
                                     isExternalFacility = true,
                                     isSavedExternalFacility = false,
                                     //approvedAmount = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPROVEDAMOUNT,

                                 }).ToList();

            allFilteredLoan.AddRange(searchResult2);

            return allFilteredLoan.AsQueryable();
        }

        public bool AddExistingLoan(LoanViewModel entity)
        {
                var systemDate = generalSetup.GetApplicationDate();
                var company = context.TBL_COMPANY.Find(entity.companyId);
                var localGlobalReference = context.TBL_GLOBAL_EXPOSURE.FirstOrDefault(x => x.ID == entity.loanId);
                if (localGlobalReference == null) { throw new ConditionNotMetException("Loan facility or type does not exist on Credit360 Application"); }

                var product = context.TBL_PRODUCT.Where(x => x.PRODUCTCODE == localGlobalReference.PRODUCTCODE).FirstOrDefault();
                if (product == null) { throw new ConditionNotMetException("Loan facility or type does not exist on Credit360"); }

                var customer = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == localGlobalReference.CUSTOMERID).FirstOrDefault();

                var customerSearchAccountNumber = string.Empty;
                var casaData = new List<CasaViewModel>();

                if (USE_THIRD_PARTY_INTEGRATION)
                {
                    casaData = integration.FetchCustomerAccountsByCustomerCode(localGlobalReference.CUSTOMERID);
                    //if (casaData == null || casaData.Count() <= 0) { throw new ConditionNotMetException("Not able to retrieve customer account"); }
                    if (casaData.Count > 0)
                    {
                        customerSearchAccountNumber = casaData.FirstOrDefault()?.productAccountNumber;
                        if (casaData.Count > 0 && customer != null) { SaveCustomerAccounts(customer.CUSTOMERID, casaData); }
                    }

                    if (casaData.Count <= 0)
                    {
                        customerSearchAccountNumber = localGlobalReference?.ACCOUNTNUMBER;
                    }
                }
                else { customerSearchAccountNumber = localGlobalReference?.ACCOUNTNUMBER; }

                if (customer == null)
                {
                    //FETCH CUSTOMER FROM FLEXCUBE
                    if (USE_THIRD_PARTY_INTEGRATION)
                    {
                        List<CustomerViewModels> cust = new List<CustomerViewModels>();
                        CustomerDetails customerAPI = new CustomerDetails(context);
                        Task.Run(async () => cust = await customerAPI.GetCustomerByAccountsNumber(customerSearchAccountNumber)).GetAwaiter().GetResult();

                    //if (cust == null || cust.Count() <= 0) { throw new ConditionNotMetException("Not able to retrieve customer account"); }
                    if (cust.Count() > 0)
                        {
                        
                            foreach (var item in cust)
                            {
                                item.userBranchId = entity.userBranchId;
                                item.companyId = entity.companyId;
                                item.createdBy = entity.createdBy;
                                item.customerSensitivityLevelId = entity.customerSensitivityLevelId;
                                item.relationshipOfficerId = entity.createdBy;
                                customers.AddCustomer(item);
                            }
                            customer = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == localGlobalReference.CUSTOMERID).FirstOrDefault();

                            if (casaData.Count > 0 && customer != null)
                            {
                                SaveCustomerAccounts(customer.CUSTOMERID, casaData);
                            }
                        
                        }

                        if (customer == null) { throw new ConditionNotMetException("Third-party API call returned empty."); }
                    }

                    if (customer == null) { throw new ConditionNotMetException("Customer does not exist on Credit360."); }
                }

                var casa = context.TBL_CASA.Where(x => x.PRODUCTACCOUNTNUMBER == customerSearchAccountNumber).FirstOrDefault();

                if (casa == null)
                {
                    //FETCH CUSTOMER ACCOUNT FROM FLEXCUBE
                    if (USE_THIRD_PARTY_INTEGRATION)
                    {
                        integration.AddCustomerAccounts(customer.CUSTOMERID, customer.CUSTOMERCODE);
                    }
                }

                var accountOfficer = context.TBL_STAFF.Where(x => x.STAFFID == customer.RELATIONSHIPOFFICERID).FirstOrDefault();
                //if (accountOfficer == null) { throw new ConditionNotMetException("Account Officer does not exist on Credit360!"); }

                double interestRate = Convert.ToDouble(localGlobalReference.INTERESTRATE);

                if (product != null && product.PRODUCTTYPEID == (short)LoanProductTypeEnum.TermLoan) entity.operationId = (short)OperationsEnum.TermLoanBooking;
                if (product != null && product.PRODUCTTYPEID == (short)LoanProductTypeEnum.SelfLiquidating) entity.operationId = (short)OperationsEnum.TermLoanBooking;
                if (product != null && product.PRODUCTTYPEID == (short)LoanProductTypeEnum.SyndicatedTermLoan) entity.operationId = (short)OperationsEnum.TermLoanBooking;
                if (product != null && product.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan) entity.operationId = (short)OperationsEnum.CommercialLoanBooking;
                if (product != null && product.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving) entity.operationId = (short)OperationsEnum.ForeignExchangeLoanBooking;
                if (product != null && product.PRODUCTTYPEID == (short)LoanProductTypeEnum.RevolvingLoan) entity.operationId = (short)OperationsEnum.RevolvingLoanBooking;
                if (product != null && product.PRODUCTTYPEID == (short)LoanProductTypeEnum.ContingentLiability) entity.operationId = (short)OperationsEnum.ContigentLoanBooking;

                var currency = context.TBL_CURRENCY.Where(x => x.CURRENCYCODE == localGlobalReference.ALPHACODE).FirstOrDefault();

                var sector = context.TBL_SECTOR.Where(x => x.CODE == localGlobalReference.CBNSECTORID).FirstOrDefault();

                short loanPerformanceStatus = 0;
                if (localGlobalReference.CBNCLASSIFICATION.ToUpper() == "PERFORMING") loanPerformanceStatus = (short)LoanPrudentialStatusEnum.Performing;
                if (localGlobalReference.CBNCLASSIFICATION.ToUpper() == "SUBSTANDARD") loanPerformanceStatus = (short)LoanPrudentialStatusEnum.Substandard;
                if (localGlobalReference.CBNCLASSIFICATION.ToUpper() == "LOST") loanPerformanceStatus = (short)LoanPrudentialStatusEnum.Lost;
                if (localGlobalReference.CBNCLASSIFICATION.ToUpper() == "DOUBTFUL") loanPerformanceStatus = (short)LoanPrudentialStatusEnum.Doubtful;
                if (localGlobalReference.CBNCLASSIFICATION.ToUpper() == "WATCHLIST") loanPerformanceStatus = (short)LoanPrudentialStatusEnum.WatchList;

                casa = context.TBL_CASA.Where(x => x.PRODUCTACCOUNTNUMBER == customerSearchAccountNumber).FirstOrDefault();
                if (casa == null) { throw new ConditionNotMetException($"Account Number {customerSearchAccountNumber} associated with this Loan does not exist on Flexcube!"); }

                var data = new TBL_LOAN_EXTERNAL()
                {
                    //LOAN_BOOKING_REQUESTID = entity.loanBookingRequestId,
                    //LOANAPPLICATIONDETAILID = entity.loanApplicationDetailId,
                    LOANREFERENCENUMBER = entity.loanReferenceNumber,
                    RELATED_LOAN_REFERENCE_NUMBER = entity.loanReferenceNumber,
                    LOANSTATUSID = (short)LoanStatusEnum.Active,
                    ISDISBURSED = true,
                    PRINCIPALNUMBEROFINSTALLMENT = 0,
                    INTERESTNUMBEROFINSTALLMENT = 0,
                    //SCHEDULEDPREPAYMENTAMOUNT = entity.scheduledPrepaymentAmount,
                    SCH_PREPAYMENT_FREQUENCY_TYPID = null,

                    SUBSECTORID = sector?.TBL_SUB_SECTOR.FirstOrDefault()?.SUBSECTORID ?? context.TBL_SUB_SECTOR.FirstOrDefault().SUBSECTORID,
                    CURRENCYID = (short)currency.CURRENCYID,
                    //EXCHANGERATE = currentExchangeRate,

                    DISCHARGELETTER = false,
                    SUSPENDINTEREST = false,

                    CUSTOMERID = customer.CUSTOMERID,
                    PRODUCTID = product.PRODUCTID,
                    COMPANYID = entity.companyId,
                    SCHEDULETYPEID = entity.scheduleTypeId < 1 ? (short)LoanScheduleTypeEnum.Annuity : entity.scheduleTypeId, // CHECK THIS VALUE
                    CASAACCOUNTID = casa.CASAACCOUNTID, //entity.casaAccountId, // CHECK THIS VALUE
                    CASAACCOUNTID2 = entity.casaAccountId2,
                    BRANCHID = accountOfficer.BRANCHID ?? customer.BRANCHID,
                    SHOULD_DISBURSE = false, //entity.loanScheduleInput.shouldDisburse,

                    //PRINCIPALFREQUENCYTYPEID = entity.loanScheduleInput.principalFrequency,
                    //INTERESTFREQUENCYTYPEID = entity.loanScheduleInput.interestFrequency,

                    RELATIONSHIPOFFICERID = (int)customer.RELATIONSHIPOFFICERID,
                    RELATIONSHIPMANAGERID = accountOfficer?.SUPERVISOR_STAFFID ?? (int)customer.RELATIONSHIPOFFICERID,
                    //MISCODE = localGlobalReference.MISCODE,
                    //TEAMMISCODE = application.TEAMMISCODE,
                    INTERESTRATE = interestRate,

                    PRINCIPALINSTALLMENTLEFT = 0,
                    INTERESTINSTALLMENTLEFT = 0,

                    //SCHEDULETYPEID = entity.loanScheduleInput.scheduleMethodId,

                    // PRINCIPALAMOUNT = Convert.ToDecimal(entity.loanScheduleInput.principalAmount),

                    OPERATIONID = entity.operationId, //= (int)OperationsEnum.TermLoanBooking,
                    LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.ExternalFacility,
                    EQUITYCONTRIBUTION = 0,
                    //OUTSTANDINGPRINCIPAL = Convert.ToDecimal(localGlobalReference.AMOUNTDUE),
                    OUTSTANDINGPRINCIPAL = localGlobalReference.PRINCIPALOUTSTANDINGBALLCY.Value,
                    PRINCIPALAMOUNT = localGlobalReference.LOANAMOUNYLCY.Value,
                    PRINCIPALADDITIONCOUNT = 0,
                    PRINCIPALREDUCTIONCOUNT = 0,
                    FIXEDPRINCIPAL = false,
                    PROFILELOAN = false,

                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,

                    BOOKINGDATE = generalSetup.GetApplicationDate(),
                    CREATEDBY = entity.createdBy,
                    DATETIMECREATED = DateTime.Now,
                    EFFECTIVEDATE = localGlobalReference.VALUEDATE ?? DateTime.Now, // entity.loanScheduleInput.effectiveDate,
                    MATURITYDATE = localGlobalReference.MATURITYDATE ?? DateTime.Now, //entity.loanScheduleInput.maturityDate,
                    LASTRESTRUCTUREDATE = localGlobalReference.LASTCRDATE ?? DateTime.Now, //entity.loanScheduleInput.effectiveDate,
                    FIRSTPRINCIPALPAYMENTDATE = localGlobalReference.SCHEDULEDUEDATE ?? DateTime.Now, //entity.loanScheduleInput.principalFirstpaymentDate,
                    FIRSTINTERESTPAYMENTDATE = localGlobalReference.SCHEDULEDUEDATE ?? DateTime.Now, //entity.loanScheduleInput.interestFirstpaymentDate,
                    ALLOWFORCEDEBITREPAYMENT = false,
                    SCHEDULEDAYCOUNTCONVENTIONID = entity.loanScheduleInput?.accrualBasis ?? 1, // CHECK THIS VALUE
                    USER_PRUDENTIAL_GUIDE_STATUSID = (short)loanPerformanceStatus,
                    EXT_PRUDENT_GUIDELINE_STATUSID = loanPerformanceStatus,
                    INT_PRUDENT_GUIDELINE_STATUSID = loanPerformanceStatus,
                    //CRMSREPAYMENTAGREEMENTID = entity.crmsRepaymentAgreementTypeId,
                    // REPRICINGMODEID = entity.loanScheduleInput.repricingModeId != 0 ? entity.loanScheduleInput.repricingModeId : null,
                    //REPRICINGDURATION = entity.loanScheduleInput.repricingDuration != 0 ? entity.loanScheduleInput.repricingDuration : null,

                };

                ////Audit Section ---------------------------
                var audit = new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.LoanBookingAdded,
                    STAFFID = entity.createdBy,
                    BRANCHID = (short)entity.userBranchId,
                    DETAIL = $"Imported existing loan with reference number: {entity.loanReferenceNumber}",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = entity.applicationUrl,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName(),
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now
                };
                context.TBL_AUDIT.Add(audit);
                ////end of Audit section -------------------------------

                context.TBL_LOAN_EXTERNAL.Add(data);
                return context.SaveChanges() > 0;
            
        }

        private void SaveCustomerAccounts(int customerId, List<CasaViewModel> casaDataList)
        {
            List<TBL_CASA> customerAcct = new List<TBL_CASA>();

            foreach (var item in casaDataList)
            {
                var currencyId = context.TBL_CURRENCY.FirstOrDefault(x => x.CURRENCYCODE == item.currency).CURRENCYID;
                var accountRecord = context.TBL_CASA_ACCOUNTSTATUS
                    .FirstOrDefault(x => x.ACCOUNTSTATUSNAME.ToLower() == item.accountStatusName.ToLower());

                TBL_CASA addCustomerAcct = new TBL_CASA();
                addCustomerAcct.CUSTOMERID = customerId;
                addCustomerAcct.AVAILABLEBALANCE = item.availableBalance;
                addCustomerAcct.LEDGERBALANCE = item.ledgerBalance;
                addCustomerAcct.PRODUCTACCOUNTNAME = item.productName;
                addCustomerAcct.PRODUCTACCOUNTNUMBER = item.productAccountNumber;
                addCustomerAcct.PRODUCTID = (short)DefaultProductEnum.CASA;
                addCustomerAcct.COMPANYID = 1;
                addCustomerAcct.BRANCHID = (short)(item.branchCode != null && item.branchCode != string.Empty ? context.TBL_BRANCH.FirstOrDefault(x => x.BRANCHCODE == item.branchCode).BRANCHID : 94);
                addCustomerAcct.CURRENCYID = currencyId;
                addCustomerAcct.ISCURRENTACCOUNT = true;
                addCustomerAcct.ACCOUNTSTATUSID = accountRecord != null ? (short)accountRecord.ACCOUNTSTATUSID : (short)1;
                addCustomerAcct.LIENAMOUNT = 0;
                addCustomerAcct.HASLIEN = false;
                addCustomerAcct.POSTNOSTATUSID = 1;
                addCustomerAcct.DELETED = false;
                addCustomerAcct.DATETIMECREATED = DateTime.Now;

                customerAcct.Add(addCustomerAcct);
            }
            var customerExist = this.context.TBL_CASA.FirstOrDefault(a => a.CUSTOMERID == customerId);
            if (customerExist == null)
            {
                this.context.TBL_CASA.AddRange(customerAcct);
                context.SaveChanges();
            }
            else
            {
                foreach (var a in customerAcct)
                {

                    TBL_CASA result = (from p in context.TBL_CASA
                                       where p.CUSTOMERID == a.CUSTOMERID && p.PRODUCTACCOUNTNUMBER == a.PRODUCTACCOUNTNUMBER
                                       select p).SingleOrDefault();

                    if (result == null)
                    {
                        this.context.TBL_CASA.Add(a);
                        context.SaveChanges();
                    }
                    else
                    {
                        result.AVAILABLEBALANCE = a.AVAILABLEBALANCE;
                        result.ACCOUNTSTATUSID = a.ACCOUNTSTATUSID;
                        result.LEDGERBALANCE = a.LEDGERBALANCE;
                        context.SaveChanges();
                    }
                }

            }
            context.SaveChanges();
        }


        //public IQueryable<LoanViewModel> SearchAllOverdraft(string searchQuery)
        //{

        //    if (!string.IsNullOrWhiteSpace(searchQuery))
        //    {
        //        searchQuery = searchQuery.ToLower();
        //    }

        //    var allFilteredLoan = (from a in context.TBL_LOAN_REVOLVING
        //                           join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
        //                           join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
        //                           where a.ISDISBURSED == true && 
        //                           (a.LOANREFERENCENUMBER.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.CUSTOMERCODE.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.FIRSTNAME.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.LASTNAME.ToLower().Contains(searchQuery.Trim()) ||
        //                           c.PRODUCTACCOUNTNUMBER.ToLower().Contains(searchQuery.Trim()))
        //                           && (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled || a.LOANSTATUSID != (short)LoanStatusEnum.Terminated || a.LOANSTATUSID != (short)LoanStatusEnum.Inactive)
        //                           select new LoanViewModel
        //                           {
        //                               loanId = a.REVOLVINGLOANID,
        //                               customerId = a.CUSTOMERID,
        //                               productId = a.PRODUCTID,
        //                               loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
        //                               customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
        //                               loanReferenceNumber = a.LOANREFERENCENUMBER,
        //                               applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
        //                               loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
        //                               interestRate = a.INTERESTRATE,
        //                               principalAmount = a.OVERDRAFTLIMIT,
        //                               effectiveDate = a.EFFECTIVEDATE,
        //                               maturityDate = a.MATURITYDATE,
        //                               loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
        //                               productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
        //                               productName = a.TBL_PRODUCT.PRODUCTNAME,
        //                               isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == (short)PrudentialGuidelineTypeEnum.Performing,
        //                               writtenOff = a.LOANSTATUSID == (short)LoanStatusEnum.WriteOff,
        //                               loanStatusId = a.LOANSTATUSID,
        //                               loanSystemTypeId = a.LOANSYSTEMTYPEID
        //                           });

        //    var test = allFilteredLoan.ToList();

        //    return allFilteredLoan;
        //}

        public IQueryable<LoanViewModel> SearchAllOverdraft(string searchQuery)
        {

            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToLower();
            }

            var allFilteredLoan = (from a in context.TBL_LOAN_REVOLVING
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                   where a.ISDISBURSED == true &&
                                   (a.LOANREFERENCENUMBER.ToLower().Contains(searchQuery.Trim()) ||
                                   b.CUSTOMERCODE.ToLower().Contains(searchQuery.Trim()) ||
                                   b.FIRSTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                   b.LASTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                   c.PRODUCTACCOUNTNUMBER.ToLower().Contains(searchQuery.Trim()))
                                   && (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled || a.LOANSTATUSID != (short)LoanStatusEnum.Terminated || a.LOANSTATUSID != (short)LoanStatusEnum.Inactive)
                                   select new LoanViewModel
                                   {
                                       loanId = a.REVOLVINGLOANID,
                                       customerId = a.CUSTOMERID,
                                       currencyId = a.CURRENCYID,
                                       loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                       applicationDetailId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONDETAILID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                       interestRate = a.INTERESTRATE,
                                       principalAmount = a.OVERDRAFTLIMIT,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == (short)PrudentialGuidelineTypeEnum.Performing,
                                       writtenOff = a.LOANSTATUSID == (short)LoanStatusEnum.WriteOff,
                                       loanStatusId = a.LOANSTATUSID,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,

                                       productClassId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.PRODUCTCLASSID ?? 0,
                                       productId = a.PRODUCTID,
                                       productClassProcessId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.PRODUCT_CLASS_PROCESSID,
                                       loanApplicationTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                       approvedAmount = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPROVEDAMOUNT,
                                   });

            var test = allFilteredLoan.ToList();

            return allFilteredLoan;
        }


        //private IQueryable<LoanViewModel> SearchContigentLoan(string searchQuery)
        //{
        //    DateTime applicationDate = getApplicationDate();

        //    if (!string.IsNullOrWhiteSpace(searchQuery))
        //    {
        //        searchQuery = searchQuery.ToLower();
        //    }
        //    List<short> loanStatus = new List<short>();
        //    loanStatus.Add((short)LoanStatusEnum.Cancelled);
        //    loanStatus.Add((short)LoanStatusEnum.Terminated);


        //    var allFilteredLoan = (from a in context.TBL_LOAN_CONTINGENT
        //                           join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
        //                           join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
        //                           where a.ISDISBURSED == true && //a.LOANSTATUSID != 7 && 
        //                           (a.LOANREFERENCENUMBER.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.CUSTOMERCODE.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.FIRSTNAME.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.LASTNAME.ToLower().Contains(searchQuery.Trim()) ||
        //                           b.CUSTOMERID.ToString().Contains(searchQuery.Trim()) ||
        //                           c.PRODUCTACCOUNTNUMBER.ToLower().Contains(searchQuery.Trim()))
        //                           && !loanStatus.Contains(a.LOANSTATUSID)
        //                           //&& (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled)
        //                           //|| (a.LOANSTATUSID != (short)LoanStatusEnum.Terminated)
        //                           //|| a.LOANSTATUSID != (short)LoanStatusEnum.Inactive || a.LOANSTATUSID != (short)LoanStatusEnum.Completed
        //                          // && a.MATURITYDATE > applicationDate
        //                           select new LoanViewModel
        //                           {
        //                               loanId = a.CONTINGENTLOANID,
        //                               customerId = a.CUSTOMERID,
        //                               currencyId = a.CURRENCYID,
        //                               productId = a.PRODUCTID,
        //                               customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
        //                               loanReferenceNumber = a.LOANREFERENCENUMBER,
        //                               applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
        //                               loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
        //                               interestRate = 1,
        //                               principalAmount = a.CONTINGENTAMOUNT,
        //                               effectiveDate = a.EFFECTIVEDATE,
        //                               maturityDate = a.MATURITYDATE,
        //                               loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
        //                               productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
        //                               productName = a.TBL_PRODUCT.PRODUCTNAME,
        //                               // isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == 1,
        //                               writtenOff = a.LOANSTATUSID == 7,
        //                               loanStatusId = a.LOANSTATUSID,
        //                               loanSystemTypeId = a.LOANSYSTEMTYPEID

        //                           });

        //    //var test = allFilteredLoan.Where(x=>(x.loanStatusId != (short)LoanStatusEnum.Cancelled) ||( x.loanStatusId != (short)LoanStatusEnum.Terminated)).ToList();
        //    //allFilteredLoan = test;
        //    return allFilteredLoan;
        //}

        private IQueryable<LoanViewModel> SearchContigentLoan(string searchQuery, int statusId = 0)
        {
            DateTime applicationDate = getApplicationDate();

            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToLower();
            }
            List<short> loanStatus = new List<short>();
            if (statusId == (short)LoanStatusEnum.WriteOff)
            {
                loanStatus.Add((short)LoanStatusEnum.Cancelled);
                loanStatus.Add((short)LoanStatusEnum.Terminated);
                loanStatus.Add((short)LoanStatusEnum.Active);
                loanStatus.Add((short)LoanStatusEnum.Suspended);
                loanStatus.Add((short)LoanStatusEnum.FullAndFinalWriteOff);
            }
            else
            {
                loanStatus.Add((short)LoanStatusEnum.Cancelled);
                loanStatus.Add((short)LoanStatusEnum.Terminated);
                loanStatus.Add((short)LoanStatusEnum.WriteOff);
            }


            var allFilteredLoan = (from a in context.TBL_LOAN_CONTINGENT
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                   where a.ISDISBURSED == true && //a.LOANSTATUSID != 7 && 
                                   (a.LOANREFERENCENUMBER.ToLower().Contains(searchQuery.Trim()) ||
                                   b.CUSTOMERCODE.ToLower().Contains(searchQuery.Trim()) ||
                                   b.FIRSTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                   b.LASTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                   b.CUSTOMERID.ToString().Contains(searchQuery.Trim()) ||
                                   c.PRODUCTACCOUNTNUMBER.ToLower().Contains(searchQuery.Trim()))
                                   && !loanStatus.Contains(a.LOANSTATUSID)
                                   //&& (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled)
                                   //|| (a.LOANSTATUSID != (short)LoanStatusEnum.Terminated)
                                   //|| a.LOANSTATUSID != (short)LoanStatusEnum.Inactive || a.LOANSTATUSID != (short)LoanStatusEnum.Completed
                                   // && a.MATURITYDATE > applicationDate
                                   select new LoanViewModel
                                   {
                                       loanId = a.CONTINGENTLOANID,
                                       customerId = a.CUSTOMERID,
                                       currencyId = a.CURRENCYID,
                                       applicationDetailId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONDETAILID,
                                       loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                       interestRate = 1,
                                       principalAmount = a.CONTINGENTAMOUNT,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       // isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == 1,
                                       writtenOff = a.LOANSTATUSID == 7,
                                       loanStatusId = a.LOANSTATUSID,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,

                                       productClassId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.PRODUCTCLASSID ?? 0,
                                       productId = a.PRODUCTID,
                                       productClassProcessId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.PRODUCT_CLASS_PROCESSID,
                                       loanApplicationTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                       approvedAmount = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPROVEDAMOUNT,


                                   });

            //var test = allFilteredLoan.Where(x=>(x.loanStatusId != (short)LoanStatusEnum.Cancelled) ||( x.loanStatusId != (short)LoanStatusEnum.Terminated)).ToList();
            //allFilteredLoan = test;
            return allFilteredLoan;
        }

        //private IQueryable<LoanViewModel> SearchLoanLine(string searchQuery)
        //{
        //    if (!string.IsNullOrWhiteSpace(searchQuery)) searchQuery = searchQuery.ToUpper();

        //    var allFilteredLoan = (from a in context.TBL_LOAN_APPLICATION
        //                           join d in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONID equals d.LOANAPPLICATIONID
        //                           join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
        //                           where a.APPROVALSTATUSID == 2 && d.STATUSID == 2
        //                           && (
        //                               a.APPLICATIONREFERENCENUMBER.Contains(searchQuery.Trim()) ||
        //                               b.CUSTOMERCODE.ToUpper().Contains(searchQuery.Trim()) ||
        //                               b.FIRSTNAME.ToUpper().Contains(searchQuery.Trim()) ||
        //                               b.LASTNAME.ToUpper().Contains(searchQuery.Trim()) ||
        //                               b.CUSTOMERID.ToString().Contains(searchQuery.Trim())
        //                           )
        //                           select new LoanViewModel
        //                           {
        //                               loanId = d.LOANAPPLICATIONDETAILID,
        //                               customerId = d.CUSTOMERID,
        //                               currencyId = d.CURRENCYID,
        //                               productId = d.APPROVEDPRODUCTID,
        //                               customerName = d.TBL_CUSTOMER.FIRSTNAME + " " + d.TBL_CUSTOMER.MIDDLENAME + " " + d.TBL_CUSTOMER.LASTNAME,
        //                               loanReferenceNumber = a.APPLICATIONREFERENCENUMBER,
        //                               applicationReferenceNumber = a.APPLICATIONREFERENCENUMBER,
        //                               loanApplicationId = d.LOANAPPLICATIONID,
        //                               interestRate = 1,
        //                               principalAmount = d.APPROVEDAMOUNT,
        //                               //effectiveDate = a.EFFECTIVEDATE,
        //                               //maturityDate = a.MATURITYDATE,
        //                               loanTypeName = a.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
        //                               productTypeId = d.TBL_PRODUCT1.PRODUCTTYPEID, // 1
        //                               productName = d.TBL_PRODUCT1.PRODUCTNAME, // 1
        //                               loanSystemTypeId = (int)LoanSystemTypeEnum.LineFacility,
        //                               //writtenOff = a.LOANSTATUSID == 7

        //                           });
        //    return allFilteredLoan;
        //}

        private IQueryable<LoanViewModel> SearchLoanLine(string searchQuery, int statusId = 0)
        {
            if (!string.IsNullOrWhiteSpace(searchQuery)) searchQuery = searchQuery.ToUpper();

            var allFilteredLoan = (from a in context.TBL_LOAN_APPLICATION
                                   join d in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONID equals d.LOANAPPLICATIONID
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   where a.APPROVALSTATUSID == 2 && d.STATUSID == 2
                                   && (
                                       a.APPLICATIONREFERENCENUMBER.Contains(searchQuery.Trim()) ||
                                       b.CUSTOMERCODE.ToUpper().Contains(searchQuery.Trim()) ||
                                       b.FIRSTNAME.ToUpper().Contains(searchQuery.Trim()) ||
                                       b.LASTNAME.ToUpper().Contains(searchQuery.Trim())
                                   )
                                   select new LoanViewModel
                                   {

                                       loanId = d.LOANAPPLICATIONDETAILID,
                                       loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                       applicationDetailId = d.LOANAPPLICATIONDETAILID,
                                       customerId = d.CUSTOMERID,
                                       currencyId = d.CURRENCYID,
                                       productId = d.APPROVEDPRODUCTID,
                                       customerName = d.TBL_CUSTOMER.FIRSTNAME + " " + d.TBL_CUSTOMER.MIDDLENAME + " " + d.TBL_CUSTOMER.LASTNAME,
                                       loanReferenceNumber = a.APPLICATIONREFERENCENUMBER,
                                       applicationReferenceNumber = a.APPLICATIONREFERENCENUMBER,
                                       loanApplicationId = d.LOANAPPLICATIONID,
                                       interestRate = 1,
                                       principalAmount = d.APPROVEDAMOUNT,
                                       //effectiveDate = a.EFFECTIVEDATE,
                                       //maturityDate = a.MATURITYDATE,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productTypeId = d.TBL_PRODUCT1.PRODUCTTYPEID, // 1
                                       productName = d.TBL_PRODUCT1.PRODUCTNAME, // 1
                                       loanSystemTypeId = (int)LoanSystemTypeEnum.LineFacility,
                                       //writtenOff = a.LOANSTATUSID == 7

                                       productClassId = a.PRODUCTCLASSID ?? 0,
                                       productClassProcessId = a.PRODUCT_CLASS_PROCESSID,
                                       loanApplicationTypeId = a.LOANAPPLICATIONTYPEID,
                                       approvedAmount = a.APPROVEDAMOUNT,

                                   });
            return allFilteredLoan;
        }

        private IQueryable<LoanViewModel> SearchTermLoanFeeCharge(string searchQuery)
        {
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToUpper();
            }

            List<short> productTypes = new List<short>();
            productTypes.Add((short)LoanProductTypeEnum.CommercialLoan);
            productTypes.Add((short)LoanProductTypeEnum.ForeignXRevolving);

            var allFilteredLoan = (from a in context.TBL_LOAN
                                   join f in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals f.LOANID
                                   //join lm in context.TBL_LMSR_APPLICATION on f.LOANAPPLICATIONID equals lm.LOANAPPLICATIONID
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                   where a.ISDISBURSED == true && //f.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility &&   // a.MATURITYDATE >=      &&  //a.LOANSTATUSID != 7 &&
                                   (a.LOANREFERENCENUMBER.ToUpper().Contains(searchQuery.Trim()) ||
                                   b.CUSTOMERCODE.ToUpper().Contains(searchQuery.Trim()) ||
                                   b.FIRSTNAME.ToUpper().Contains(searchQuery.Trim()) ||
                                   b.LASTNAME.ToUpper().Contains(searchQuery.Trim()) ||
                                   c.PRODUCTACCOUNTNUMBER.ToUpper().Contains(searchQuery.Trim())) && (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled || a.LOANSTATUSID != (short)LoanStatusEnum.Terminated || a.LOANSTATUSID != (short)LoanStatusEnum.Inactive || a.LOANSTATUSID != (short)LoanStatusEnum.Completed)
                                   //  && a.TBL_OPERATIONS.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagement
                                   // && a.LOANSYSTEMTYPEID != (short)LoanSystemTypeEnum.LineFacility
                                   && !productTypes.Contains(a.TBL_PRODUCT.PRODUCTTYPEID)
                                   select new LoanViewModel
                                   {
                                       loanId = a.TERMLOANID,
                                       customerId = a.CUSTOMERID,
                                       productId = a.PRODUCTID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
                                       interestRate = a.INTERESTRATE,
                                       principalAmount = a.PRINCIPALAMOUNT,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       //loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == 1,
                                       writtenOff = a.LOANSTATUSID == 7,
                                       loanStatusId = a.LOANSTATUSID,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                       lmsApplicationDetailId = f.LOANREVIEWAPPLICATIONID
                                   }).GroupBy(O => O.loanId).Select(O => O.FirstOrDefault());
            return allFilteredLoan;
        }

        private IQueryable<LoanViewModel> SearchTermLoanReviewFeeCharge(string searchQuery)
        {
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToUpper();
            }


            List<short> productTypes = new List<short>();
            productTypes.Add((short)LoanProductTypeEnum.CommercialLoan);
            productTypes.Add((short)LoanProductTypeEnum.ForeignXRevolving);


            var allFilteredLoan = (from a in context.TBL_LOAN
                                   join f in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals f.LOANID
                                   //join lm in context.TBL_LMSR_APPLICATION on f.LOANAPPLICATIONID equals lm.LOANAPPLICATIONID
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                   where a.ISDISBURSED == true && f.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility &&   // a.MATURITYDATE >=      &&  //a.LOANSTATUSID != 7 &&
                                   (a.LOANREFERENCENUMBER.ToUpper().Contains(searchQuery.Trim()) ||
                                   b.CUSTOMERCODE.ToUpper().Contains(searchQuery.Trim()) ||
                                   b.FIRSTNAME.ToUpper().Contains(searchQuery.Trim()) ||
                                   b.LASTNAME.ToUpper().Contains(searchQuery.Trim()) ||
                                   c.PRODUCTACCOUNTNUMBER.ToUpper().Contains(searchQuery.Trim())) && (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled || a.LOANSTATUSID != (short)LoanStatusEnum.Terminated || a.LOANSTATUSID != (short)LoanStatusEnum.Inactive || a.LOANSTATUSID != (short)LoanStatusEnum.Completed)
                                   //&& a.TBL_OPERATIONS.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagement
                                   // && a.LOANSYSTEMTYPEID != (short)LoanSystemTypeEnum.LineFacility
                                   && !productTypes.Contains(a.TBL_PRODUCT.PRODUCTTYPEID)
                                   select new LoanViewModel
                                   {
                                       loanId = a.TERMLOANID,
                                       customerId = a.CUSTOMERID,
                                       productId = a.PRODUCTID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.LOANAPPLICATIONID,
                                       interestRate = a.INTERESTRATE,
                                       principalAmount = a.PRINCIPALAMOUNT,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       //loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == 1,
                                       writtenOff = a.LOANSTATUSID == 7,
                                       loanStatusId = a.LOANSTATUSID,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                       lmsApplicationDetailId = f.LOANREVIEWAPPLICATIONID
                                   });
            var j = allFilteredLoan.ToList();
            return allFilteredLoan;
        }

        private IQueryable<LoanViewModel> SearchRevolvingLoanFeeCharge(string searchQuery)
        {
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToUpper();
            }

            var allFilteredLoan = (from a in context.TBL_LOAN_REVOLVING
                                   join f in context.TBL_LMSR_APPLICATION_DETAIL on a.REVOLVINGLOANID equals f.LOANID
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                   where a.ISDISBURSED == true &&// f.TBL_OPERATIONS.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagementOverdraft && //(int)LoanSystemTypeEnum.OverdraftFacility &&
                                    (a.LOANREFERENCENUMBER.ToLower().Contains(searchQuery.Trim()) ||
                                   b.CUSTOMERCODE.ToLower().Contains(searchQuery.Trim()) ||
                                   b.FIRSTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                   b.LASTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                   c.PRODUCTACCOUNTNUMBER.ToLower().Contains(searchQuery.Trim())) && (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled || a.LOANSTATUSID != (short)LoanStatusEnum.Terminated || a.LOANSTATUSID != (short)LoanStatusEnum.Inactive || a.LOANSTATUSID != (short)LoanStatusEnum.Completed)
                                   select new LoanViewModel
                                   {
                                       loanId = a.REVOLVINGLOANID,
                                       customerId = a.CUSTOMERID,
                                       productId = a.PRODUCTID,
                                       loanApplicationDetailId = a.LOANAPPLICATIONDETAILID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                       interestRate = a.INTERESTRATE,
                                       principalAmount = a.OVERDRAFTLIMIT,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == 1,
                                       writtenOff = a.LOANSTATUSID == 7,
                                       loanStatusId = a.LOANSTATUSID,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                       lmsApplicationDetailId = f.LOANREVIEWAPPLICATIONID
                                   }).GroupBy(O => O.loanId).Select(O => O.FirstOrDefault());
            return allFilteredLoan;
        }

        private IQueryable<LoanViewModel> SearchContigentLoanFeeCharge(string searchQuery)
        {
            var allFilteredLoan = (from a in context.TBL_LOAN_CONTINGENT
                                   join f in context.TBL_LMSR_APPLICATION_DETAIL on a.CONTINGENTLOANID equals f.LOANID
                                   join b in context.TBL_CUSTOMER on a.CUSTOMERID equals b.CUSTOMERID
                                   join c in context.TBL_CASA on a.CASAACCOUNTID equals c.CASAACCOUNTID
                                   where a.ISDISBURSED == true && //(f.OPERATIONID == (int)OperationsEnum.ContingentLiabilityTermination || f.OPERATIONID == (int)OperationsEnum.ContingentLiabilityRenewal) && //(int)LoanSystemTypeEnum.OverdraftFacility &&
                                   (a.LOANREFERENCENUMBER.ToLower().Contains(searchQuery.Trim()) ||
                                   b.CUSTOMERCODE.ToLower().Contains(searchQuery.Trim()) ||
                                   b.FIRSTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                   b.LASTNAME.ToLower().Contains(searchQuery.Trim()) ||
                                   c.PRODUCTACCOUNTNUMBER.ToLower().Contains(searchQuery.Trim())) && (a.LOANSTATUSID != (short)LoanStatusEnum.Cancelled || a.LOANSTATUSID != (short)LoanStatusEnum.Terminated || a.LOANSTATUSID != (short)LoanStatusEnum.Inactive || a.LOANSTATUSID != (short)LoanStatusEnum.Completed)
                                   select new LoanViewModel
                                   {
                                       loanId = a.CONTINGENTLOANID,
                                       customerId = a.CUSTOMERID,
                                       productId = a.PRODUCTID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       loanApplicationId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONID,
                                       interestRate = 1,
                                       principalAmount = a.CONTINGENTAMOUNT,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       // isPerforming = a.USER_PRUDENTIAL_GUIDE_STATUSID == 1,
                                       writtenOff = a.LOANSTATUSID == 7,
                                       loanStatusId = a.LOANSTATUSID,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                       lmsApplicationDetailId = f.LOANREVIEWAPPLICATIONID
                                   }).GroupBy(O => O.loanId).Select(O => O.FirstOrDefault());
            return allFilteredLoan;
        }

        public IEnumerable<LoanViewModel> SearchForLoanAndRevolvingLoanFeeCharge(int loanSystemTypeId, string searchQuery)
        {

            var applicationDate = generalSetup.GetApplicationDate();

            IEnumerable<LoanViewModel> allFilteredLoan = null;
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToLower();
            }

            if (!string.IsNullOrWhiteSpace(searchQuery.Trim()))
            {
                if (loanSystemTypeId == (int)LoanSystemTypeEnum.TermDisbursedFacility)
                {
                    allFilteredLoan = SearchTermLoanFeeCharge(searchQuery);//.Where(x => x.isPerforming == performing || all);
                }
                else if (loanSystemTypeId == (int)LoanSystemTypeEnum.OverdraftFacility)
                {
                    allFilteredLoan = SearchRevolvingLoanFeeCharge(searchQuery);//.Where(x => x.isPerforming == performing || all);
                }
                else if (loanSystemTypeId == (int)LoanSystemTypeEnum.ContingentLiability)
                {
                    allFilteredLoan = SearchContigentLoanFeeCharge(searchQuery);
                }
                else if (loanSystemTypeId == (int)LoanSystemTypeEnum.LineFacility)
                {
                    allFilteredLoan = SearchLoanLine(searchQuery);
                }
                else
                {
                    throw new SecureException("Not Implemented!");
                }

            }


            return allFilteredLoan;
        }

        //public IEnumerable<LoanViewModel> SearchForLoanAndRevolvingLoanReviewFeeCharge(int loanSystemTypeId, string searchQuery)
        //{

        //    var applicationDate = generalSetup.GetApplicationDate();

        //    IEnumerable<LoanViewModel> allFilteredLoan = null;
        //    if (!string.IsNullOrWhiteSpace(searchQuery))
        //    {
        //        searchQuery = searchQuery.ToLower();
        //    }

        //    if (!string.IsNullOrWhiteSpace(searchQuery.Trim()))
        //    {
        //        if (loanSystemTypeId == (int)LoanSystemTypeEnum.TermDisbursedFacility)
        //        {
        //            allFilteredLoan = SearchTermLoanReviewFeeCharge(searchQuery);//.Where(x => x.isPerforming == performing || all);
        //        }
        //        else if (loanSystemTypeId == (int)LoanSystemTypeEnum.OverdraftFacility)
        //        {
        //            allFilteredLoan = SearchRevolvingLoanFeeCharge(searchQuery);//.Where(x => x.isPerforming == performing || all);
        //        }
        //        else if (loanSystemTypeId == (int)LoanSystemTypeEnum.ContingentLiability)
        //        {
        //            allFilteredLoan = SearchContigentLoanFeeCharge(searchQuery);
        //        }
        //        else if (loanSystemTypeId == (int)LoanSystemTypeEnum.LineFacility)
        //        {
        //            allFilteredLoan = SearchLoanLine(searchQuery);
        //        }
        //        else
        //        {
        //            throw new SecureException("Not Implemented!");
        //        }

        //    }


        //    return allFilteredLoan;
        //}

        //public IEnumerable<LoanViewModel> SearchForLoanAndRevolvingLoan(int loanSystemTypeId, string searchQuery)
        //{
        //    //bool all = (performanceTypeId != 1) && (performanceTypeId != 2);
        //    //bool performing = performanceTypeId == 1;
        //    var applicationDate = generalSetup.GetApplicationDate();

        //    IEnumerable<LoanViewModel> allFilteredLoan = null;
        //    if (!string.IsNullOrWhiteSpace(searchQuery))
        //    {
        //        searchQuery = searchQuery.ToLower();
        //    }

        //    if (!string.IsNullOrWhiteSpace(searchQuery.Trim()))
        //    {
        //        if (loanSystemTypeId == (int)LoanSystemTypeEnum.TermDisbursedFacility)
        //        {
        //            allFilteredLoan = SearchTermLoan(searchQuery);//.Where(x => x.isPerforming == performing || all);
        //        }
        //        else if (loanSystemTypeId == (int)LoanSystemTypeEnum.OverdraftFacility)
        //        {
        //            allFilteredLoan = SearchRevolvingLoan(searchQuery);//.Where(x => x.isPerforming == performing || all);
        //        }
        //        else if (loanSystemTypeId == (int)LoanSystemTypeEnum.ContingentLiability)
        //        {
        //            allFilteredLoan = SearchContigentLoan(searchQuery);
        //        }
        //        else if (loanSystemTypeId == (int)LoanSystemTypeEnum.LineFacility)
        //        {
        //            allFilteredLoan = SearchLoanLine(searchQuery);
        //        }
        //        else
        //        {
        //            throw new SecureException("Not Implemented!");
        //        }

        //    }

        //    if (allFilteredLoan.Count() == 0)
        //    {
        //        throw new SecureException("Loan account is not found!");
        //    }

        //    return allFilteredLoan;
        //}

        public IEnumerable<LoanViewModel> SearchForLoanAndRevolvingLoan(string searchQuery, int statusId)
        //public IEnumerable<LoanViewModel> SearchForLoanAndRevolvingLoan(string searchQuery)
        {
            var applicationDate = generalSetup.GetApplicationDate();

            List<LoanViewModel> allFilteredLoan = new List<LoanViewModel>();
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                searchQuery = searchQuery.ToLower();
            }

            if (!string.IsNullOrWhiteSpace(searchQuery.Trim()))
            {
                allFilteredLoan = SearchTermLoan(searchQuery, statusId).ToList();
            }
            else
            {
                throw new SecureException("Not Implemented!");
            }
            return allFilteredLoan; //.Where(O => O.loanSystemTypeId == 3).OrderByDescending(O => O.loanId).Take(600);
        }

        public IEnumerable<LoanViewModel> GetBookedLoanDetails(int companyId, ReportSearchParamViewModel param)
        {
            List<short> loanStatus = new List<short>();
            loanStatus.Add((short)LoanStatusEnum.Inactive);
            loanStatus.Add((short)LoanStatusEnum.Cancelled);


            var data = (from l in context.TBL_LOAN
                        where
                          (l.BRANCHID == param.branchId || param.branchId == 0)
                         && (l.LOANREFERENCENUMBER == param.param.Trim() || param.param.Trim() == null || param.param.Trim() == "" || l.TBL_CUSTOMER.FIRSTNAME.ToLower().Contains(param.param.Trim().ToLower())  //&& param.branchId == 0
                         || l.TBL_CUSTOMER.LASTNAME.ToLower().Contains(param.param.Trim().ToLower())  // && param.branchId == 0
                         || l.TBL_CUSTOMER.MAIDENNAME.ToLower().Contains(param.param.Trim().ToLower())) // && param.branchId == 0
                         && !loanStatus.Contains(l.LOANSTATUSID) && l.CURRENCYID != 1

                        orderby l.BOOKINGDATE descending
                        select new LoanViewModel
                        {
                            facilityType = l.TBL_PRODUCT.PRODUCTNAME,
                            loanId = l.TERMLOANID,
                            customerId = l.CUSTOMERID,
                            customerName = l.TBL_CUSTOMER.FIRSTNAME + " " + l.TBL_CUSTOMER.LASTNAME,
                            productId = l.PRODUCTID,
                            companyId = l.COMPANYID,
                            casaAccountId = l.CASAACCOUNTID,
                            branchId = l.BRANCHID,
                            branchName = l.TBL_BRANCH.BRANCHNAME,
                            loanReferenceNumber = l.LOANREFERENCENUMBER,
                            interestRate = l.INTERESTRATE,
                            principalAmount = l.PRINCIPALAMOUNT,
                            approvedAmount = l.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,
                            casaAccountNumber = l.TBL_CASA.PRODUCTACCOUNTNUMBER,
                            productAccountName = l.TBL_PRODUCT.PRODUCTNAME,
                            subSectorName = l.TBL_SUB_SECTOR.NAME,
                            sectorName = l.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            outstandingPrincipal = l.OUTSTANDINGPRINCIPAL,
                            maturityDate = l.MATURITYDATE,
                            effectiveDate = l.EFFECTIVEDATE,
                            bookingDate = l.BOOKINGDATE
                        });
            return data;
        }

        public IEnumerable<LoanViewModel> GetLoanStatus(int companyId)
        {
            return (from a in context.TBL_LOAN_STATUS
                    select new LoanViewModel
                    {
                        loanStatus = a.ACCOUNTSTATUS,
                        loanStatusId = a.LOANSTATUSID
                    });
        }

        //public IEnumerable<DailyInterestAccrualViewModel> ProcessBackDatedTeamLoansInterestAccrual(DateTime effectiveDate, int loanId)
        //{
        //    try
        //    {
        //        var applicationDate = generalSetup.GetApplicationDate();
        //        bool result = false;
        //        var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

        //        var data1 = (from a in context.TBL_LOAN_SCHEDULE_DAILY
        //                     join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
        //                     join c in context.TBL_LOAN_SCHEDULE_PERIODIC on b.TERMLOANID equals c.LOANID
        //                     join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
        //                     join e in context.TBL_PRODUCT on b.PRODUCTID equals e.PRODUCTID
        //                     join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
        //                     where a.DATE == DbFunctions.TruncateTime(effectiveDate) && b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.TERMLOANID == loanId
        //                     && a.PAYMENTDATE == c.PAYMENTDATE
        //                     // && (f.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID != (short)LoanProductTypeEnum.ForeignXRevolving)

        //                     select new DailyInterestAccrualViewModel()
        //                     {
        //                         referenceNumber = b.LOANREFERENCENUMBER,
        //                         productId = b.PRODUCTID,
        //                         branchId = b.BRANCHID,
        //                         companyId = b.COMPANYID,
        //                         currencyId = b.CURRENCYID,
        //                         exchangeRate = b.EXCHANGERATE,
        //                         interestRate = a.INTERESTRATE,
        //                         date = effectiveDate,
        //                         dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT * (DateDiff(effectiveDate, applicationDate) - 1),
        //                         mainAmount = c.PERIODINTERESTAMOUNT,
        //                         categoryId = (short)DailyAccrualCategory.TermLoan,
        //                         transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
        //                         baseReferenceNumber = null,
        //                         dayCountConventionId = d.DAYCOUNTCONVENTIONID,

        //                     }).ToList();

        //        //var data2 = (from a in context.TBL_LOAN
        //        //             join e in context.TBL_PRODUCT on a.PRODUCTID equals e.PRODUCTID
        //        //             join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
        //        //             where a.LOANSTATUSID == (short)LoanStatusEnum.Active && a.TERMLOANID == loanId &&
        //        //              (f.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving)
        //        //             && a.MATURITYDATE == DbFunctions.TruncateTime(effectiveDate)


        //        //             select new DailyInterestAccrualViewModel()
        //        //             {
        //        //                 referenceNumber = a.LOANREFERENCENUMBER,
        //        //                 productId = a.PRODUCTID,
        //        //                 branchId = a.BRANCHID,
        //        //                 companyId = a.COMPANYID,
        //        //                 currencyId = a.CURRENCYID,
        //        //                 exchangeRate = a.EXCHANGERATE,
        //        //                 interestRate = a.INTERESTRATE,
        //        //                 date = effectiveDate,
        //        //                 dailyAccuralAmount = ((a.INTERESTRATE / 100) * (double)a.PRINCIPALAMOUNT * 1 / 365) * (DateDiff(effectiveDate, applicationDate) - 1),//((a.INTERESTRATE / 100) * (double)a.PRINCIPALAMOUNT * 1 / 365),
        //        //                 mainAmount = a.PRINCIPALAMOUNT,
        //        //                 categoryId = f.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan ? (short)DailyAccrualCategory.CommercialLoan : (short)DailyAccrualCategory.FXRevolvingLoan,/// change to commercial paper 
        //        //                 availableBalance = a.PRINCIPALAMOUNT,
        //        //                 transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
        //        //                 baseReferenceNumber = null,
        //        //                 dayCountConventionId = 0,
        //        //             }).ToList();

        //        List<DailyInterestAccrualViewModel> data = data1.ToList(); //data1.Union(data2).ToList();

        //        List<TBL_DAILY_ACCRUAL> transAccrual = new List<TBL_DAILY_ACCRUAL>();

        //        foreach (var item in data)
        //        {
        //            TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

        //            dailyAccrual.REFERENCENUMBER = item.referenceNumber;
        //            dailyAccrual.PRODUCTID = item.productId;
        //            dailyAccrual.BRANCHID = item.branchId;
        //            dailyAccrual.EXCHANGERATE = item.exchangeRate;
        //            dailyAccrual.CURRENCYID = item.currencyId;
        //            dailyAccrual.INTERESTRATE = item.interestRate;
        //            dailyAccrual.DATE = item.date;
        //            dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs(item.dailyAccuralAmount);
        //            dailyAccrual.MAINAMOUNT = item.mainAmount;
        //            dailyAccrual.CATEGORYID = item.categoryId;
        //            dailyAccrual.COMPANYID = item.companyId;
        //            dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
        //            dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
        //            dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;
        //            transAccrual.Add(dailyAccrual);

        //        }
        //        this.context.TBL_DAILY_ACCRUAL.AddRange(transAccrual);
        //        context.SaveChanges();


        //        var model = (from a in context.TBL_DAILY_ACCRUAL
        //                     where a.DATE == DbFunctions.TruncateTime(effectiveDate) && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan
        //                     group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID } into groupedQ
        //                     select new DailyInterestAccrualViewModel()
        //                     {
        //                         productId = groupedQ.Key.PRODUCTID,
        //                         branchId = groupedQ.Key.BRANCHID,
        //                         companyId = groupedQ.Key.COMPANYID,
        //                         currencyId = groupedQ.Key.CURRENCYID,
        //                         dailyAccuralAmount = (double)groupedQ.Sum(i => i.DAILYACCURALAMOUNT),
        //                     }).ToList();

        //        var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
        //        if (setup.USE_THIRD_PARTY_INTEGRATION)
        //        {
        //            BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

        //            result = bulkPosting.WriteBulkDailyTermLoanInterestAccuralToStaging(model, context, stgCon, finacle, financeTransaction, applicationDate);

        //        }
        //        else
        //        {
        //            foreach (var item in model)
        //            {
        //                item.date = effectiveDate;

        //                result = financeTransaction.PostDailyLoansInterestAccrual(item);
        //            }
        //        }

        //        if (result)
        //        {
        //            return model;
        //        }
        //        return null;
        //    }
        //    catch (Exception ex)
        //    {

        //        throw new SecureException(ex.Message);

        //    }

        //}

        public IEnumerable<DailyInterestAccrualViewModel> ProcessBackDatedTeamLoansInterestAccrual(DateTime effectiveDate, int loanId)
        {
            try
            {
                var applicationDate = generalSetup.GetApplicationDate();
                bool result = false;
                var transactionCode = CommonHelpers.GenerateRandomDigitCode(10);

                var data1 = (from a in context.TBL_LOAN_SCHEDULE_DAILY
                             join b in context.TBL_LOAN on a.LOANID equals b.TERMLOANID
                             join c in context.TBL_LOAN_SCHEDULE_PERIODIC on b.TERMLOANID equals c.LOANID
                             join d in context.TBL_DAY_COUNT_CONVENTION on b.SCHEDULEDAYCOUNTCONVENTIONID equals d.DAYCOUNTCONVENTIONID
                             join e in context.TBL_PRODUCT on b.PRODUCTID equals e.PRODUCTID
                             join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
                             where b.LOANSTATUSID == (short)LoanStatusEnum.Active && b.TERMLOANID == loanId
                             && a.PAYMENTDATE == c.PAYMENTDATE //&& (a.DATE >= DbFunctions.TruncateTime(effectiveDate).Value && a.DATE < DbFunctions.TruncateTime(applicationDate).Value)

                             select new DailyInterestAccrualViewModel()
                             {
                                 referenceNumber = b.LOANREFERENCENUMBER,
                                 productId = b.PRODUCTID,
                                 branchId = b.BRANCHID,
                                 companyId = b.COMPANYID,
                                 currencyId = b.CURRENCYID,
                                 exchangeRate = b.EXCHANGERATE,
                                 interestRate = a.INTERESTRATE,
                                 date = a.DATE,
                                 //dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT * (DateDiff(effectiveDate, applicationDate) - 1),
                                 dailyAccuralAmount = (double)a.DAILYINTERESTAMOUNT, //* (DateDiff(effectiveDate, applicationDate) - 1),
                                 mainAmount = c.PERIODINTERESTAMOUNT,
                                 categoryId = (short)DailyAccrualCategory.TermLoan,
                                 transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                                 baseReferenceNumber = null,
                                 dayCountConventionId = d.DAYCOUNTCONVENTIONID,

                             }).ToList();

                //var data2 = (from a in context.TBL_LOAN
                //             join e in context.TBL_PRODUCT on a.PRODUCTID equals e.PRODUCTID
                //             join f in context.TBL_PRODUCT_TYPE on e.PRODUCTTYPEID equals f.PRODUCTTYPEID
                //             where a.LOANSTATUSID == (short)LoanStatusEnum.Active && a.TERMLOANID == loanId &&
                //              (f.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan || f.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving)
                //             && a.MATURITYDATE == DbFunctions.TruncateTime(effectiveDate)


                //             select new DailyInterestAccrualViewModel()
                //             {
                //                 referenceNumber = a.LOANREFERENCENUMBER,
                //                 productId = a.PRODUCTID,
                //                 branchId = a.BRANCHID,
                //                 companyId = a.COMPANYID,
                //                 currencyId = a.CURRENCYID,
                //                 exchangeRate = a.EXCHANGERATE,
                //                 interestRate = a.INTERESTRATE,
                //                 date = effectiveDate,
                //                 dailyAccuralAmount = ((a.INTERESTRATE / 100) * (double)a.PRINCIPALAMOUNT * 1 / 365) * (DateDiff(effectiveDate, applicationDate) - 1),//((a.INTERESTRATE / 100) * (double)a.PRINCIPALAMOUNT * 1 / 365),
                //                 mainAmount = a.PRINCIPALAMOUNT,
                //                 categoryId = f.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan ? (short)DailyAccrualCategory.CommercialLoan : (short)DailyAccrualCategory.FXRevolvingLoan,/// change to commercial paper 
                //                 availableBalance = a.PRINCIPALAMOUNT,
                //                 transactionTypeId = (byte)LoanTransactionTypeEnum.Interest,
                //                 baseReferenceNumber = null,
                //                 dayCountConventionId = 0,
                //             }).ToList();


                List<DailyInterestAccrualViewModel> data = data1.Where(x => x.date <= applicationDate).ToList(); //data1.Union(data2).ToList();

                List<TBL_DAILY_ACCRUAL> transAccrual = new List<TBL_DAILY_ACCRUAL>();

                foreach (var item in data)
                {
                    TBL_DAILY_ACCRUAL dailyAccrual = new TBL_DAILY_ACCRUAL();

                    dailyAccrual.REFERENCENUMBER = item.referenceNumber;
                    dailyAccrual.PRODUCTID = item.productId;
                    dailyAccrual.BRANCHID = item.branchId;
                    dailyAccrual.EXCHANGERATE = item.exchangeRate;
                    dailyAccrual.CURRENCYID = item.currencyId;
                    dailyAccrual.INTERESTRATE = item.interestRate;
                    dailyAccrual.DATE = item.date;
                    dailyAccrual.DAILYACCURALAMOUNT = (decimal)Math.Abs(item.dailyAccuralAmount);
                    dailyAccrual.MAINAMOUNT = item.mainAmount;
                    dailyAccrual.CATEGORYID = item.categoryId;
                    dailyAccrual.COMPANYID = item.companyId;
                    dailyAccrual.DAYCOUNTCONVENTIONID = item.dayCountConventionId;
                    dailyAccrual.BASEREFERENCENUMBER = item.baseReferenceNumber;
                    dailyAccrual.TRANSACTIONTYPEID = item.transactionTypeId;
                    transAccrual.Add(dailyAccrual);
                }
                this.context.TBL_DAILY_ACCRUAL.AddRange(transAccrual);
                context.SaveChanges();


                var model = (from a in context.TBL_DAILY_ACCRUAL
                             where a.DATE == DbFunctions.TruncateTime(effectiveDate) && a.CATEGORYID == (short)DailyAccrualCategory.TermLoan
                             group a by new { a.PRODUCTID, a.BRANCHID, a.COMPANYID, a.CURRENCYID } into groupedQ
                             select new DailyInterestAccrualViewModel()
                             {
                                 productId = groupedQ.Key.PRODUCTID,
                                 branchId = groupedQ.Key.BRANCHID,
                                 companyId = groupedQ.Key.COMPANYID,
                                 currencyId = groupedQ.Key.CURRENCYID,
                                 dailyAccuralAmount = (double)groupedQ.Sum(i => i.DAILYACCURALAMOUNT),
                             }).ToList();

                var setup = context.TBL_SETUP_GLOBAL.FirstOrDefault();
                if (setup.USE_THIRD_PARTY_INTEGRATION)
                {
                    BulkTransactionPosting bulkPosting = new BulkTransactionPosting();

                    result = bulkPosting.WriteBulkDailyTermLoanInterestAccuralToStaging(model, context, stgCon, finacle, financeTransaction, applicationDate);

                }
                else
                {
                    foreach (var item in model)
                    {
                        item.date = effectiveDate;

                        result = financeTransaction.PostDailyLoansInterestAccrual(item);
                    }
                }

                if (result)
                {
                    return model;
                }
                return null;
            }
            catch (Exception ex)
            {

                throw new SecureException(ex.Message);

            }

        }

        #region Loan Disbursement 
        public IEnumerable<LoanDisbursementViewModel> GetAllLoanDisbursement(int loanId)
        {
            var loan = (from a in context.TBL_LOAN_DISBURSEMENT
                        join b in context.TBL_LOAN on a.TERMLOANID equals b.TERMLOANID
                        join c in context.TBL_CUSTOMER on b.CUSTOMERID equals c.CUSTOMERID
                        where a.TERMLOANID == loanId
                        select new LoanDisbursementViewModel
                        {
                            loanDisbursementId = a.LOANDISBURSEMENTID,
                            loanId = a.TERMLOANID,
                            //beneficiaryCurrencyCode = a.TBL_ CURRENCYID
                            // beneficiaryRateCode = a.TBL,
                            amountDisbursed = a.AMOUNTDISBURSED,
                            loanReferenceNo = b.LOANREFERENCENUMBER,
                            customerName = c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME
                        });

            return loan;
        }

        public IEnumerable<LookupViewModel> GetAllFrequencyType()
        {
            var frequencyTypes = generalSetup.GetAllFrequencyTypes();
            return frequencyTypes;
        }

        public IEnumerable<LookupViewModel> GetAllLoanStatus()
        {
            return (from data in context.TBL_LOAN_STATUS
                    select new LookupViewModel()
                    {
                        lookupId = data.LOANSTATUSID,
                        lookupName = data.ACCOUNTSTATUS,
                        //isVisible = data.ISVISIBLE,
                        //value = data.VALUE,
                    });
        }

        //public bool LoopInStaff(ApprovalViewModel model)
        //{
        //    int staffId = model.staffId;

        //    var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();

        //    workflow.StaffId = model.createdBy;
        //    workflow.OperationId = model.operationId;
        //    workflow.TargetId = model.targetId;
        //    workflow.CompanyId = model.companyId;
        //    workflow.ProductClassId = null;
        //    workflow.ProductId = null;
        //    //workflow.NextLevelId = model.approvalLevelId;
        //    //workflow.ToStaffId = staffId; 
        //    workflow.LoopedRoleId = staff.STAFFROLEID;
        //    workflow.LoopedStaffId = model.staffId;
        //    workflow.StatusId = (int)ApprovalStatusEnum.LoopedIn;
        //    workflow.Comment = model.comment;
        //    workflow.DeferredExecution = true;

        //    workflow.LogActivity();

        //    //Audit Section ---------------------------
        //    var audit = new TBL_AUDIT
        //    {
        //        AUDITTYPEID = (short)AuditTypeEnum.facilityBookingReferedBack,
        //        STAFFID = model.createdBy,
        //        BRANCHID = (short)model.BranchId,
        //        DETAIL = $"facility booking with booking account number  refered back to modifier.",
        //        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
        //        URL = model.applicationUrl,
        //        APPLICATIONDATE = generalSetup.GetApplicationDate(),
        //        SYSTEMDATETIME = DateTime.Now,
        //        DEVICENAME = CommonHelpers.GetDeviceName(),
        //        OSNAME = CommonHelpers.FriendlyName()
        //    };
        //    context.TBL_AUDIT.Add(audit);
        //    //end of Audit section -------------------------------

        //    return context.SaveChanges() > 0;
        //}

        private WorkflowResponse invokeClassifiedReferBack(ApprovalViewModel model)
        {

            var operationTypeId = context.TBL_OPERATIONS.Where(x => x.OPERATIONID == model.operationId).Select(c => c.OPERATIONTYPEID).FirstOrDefault();
            if(operationTypeId == (short)OperationTypeEnum.LoanManagement || operationTypeId == (short)OperationTypeEnum.LoanReviewApplication || operationTypeId == (short)OperationTypeEnum.LoanManagementOverdraft)
            {
               return invokeLMSClassifiedReferBack(model);
            }
            int staffId = model.staffId;
            var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();
            var backTrail = new TBL_APPROVAL_TRAIL();
            //if (model.isLms && model.isLmsOperations)
            //{

            //    List<short> drawdownPostApprovalOperations = new List<short>();
            //    drawdownPostApprovalOperations.Add((short)OperationsEnum.CorporateDrawdownRequest);
            //    drawdownPostApprovalOperations.Add((short)OperationsEnum.IndividualDrawdownRequest);
            //    drawdownPostApprovalOperations.Add((short)OperationsEnum.CreditCardDrawdownRequest);
            //    drawdownPostApprovalOperations.Add((short)OperationsEnum.RevolvingTranchDisbursement);

            //    workflow.StaffId = model.createdBy;
            //    workflow.OperationId = model.operationId;
            //    workflow.TargetId = model.targetId;
            //    workflow.CompanyId = model.companyId;
            //    workflow.ProductClassId = model.productClassId;
            //    workflow.ProductId = model.productId;
            //    workflow.NextLevelId = null;
            //    // workflow.DestinationOperationId = model.operationId;


            //    workflow.StatusId = (int)ApprovalStatusEnum.Closed;
            //    workflow.Comment = model.comment;
            //    workflow.DeferredExecution = true;

            //    workflow.LogActivity();

            //    //NEW WF ACTIVITY BEGINS
            //    TBL_LOAN_BOOKING_REQUEST request = new TBL_LOAN_BOOKING_REQUEST();
            //    request = context.TBL_LOAN_BOOKING_REQUEST.Find(model.targetId);

            //    backTrail = context.TBL_APPROVAL_TRAIL.Where(x => x.TARGETID == model.targetId && x.OPERATIONID == model.nextOperation && x.TOAPPROVALLEVELID == model.approvalLevelId).FirstOrDefault();
            //    if (model.nextOperation == null)
            //    {
            //        model.nextOperation = request?.OPERATIONID;
            //        backTrail = context.TBL_APPROVAL_TRAIL.Where(x => x.TARGETID == model.targetId && x.OPERATIONID == model.nextOperation && x.FROMAPPROVALLEVELID == model.approvalLevelId).FirstOrDefault();
            //    }

            //    if (drawdownPostApprovalOperations.Contains((short)model.nextOperation))
            //    {
            //        if (request != null) { request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Pending; }
            //    }
            //}
            //else
            //{//for normal los drawdown
                List<short> drawdownPostApprovalOperations = new List<short>();
                drawdownPostApprovalOperations.Add((short)OperationsEnum.CorporateDrawdownRequest);
                drawdownPostApprovalOperations.Add((short)OperationsEnum.IndividualDrawdownRequest);
                drawdownPostApprovalOperations.Add((short)OperationsEnum.CreditCardDrawdownRequest);
                drawdownPostApprovalOperations.Add((short)OperationsEnum.RevolvingTranchDisbursement);

                workflow.StaffId = model.createdBy;
                workflow.OperationId = model.operationId;
                workflow.TargetId = model.targetId;
                workflow.CompanyId = model.companyId;
                workflow.ProductClassId = model.productClassId;
                workflow.ProductId = model.productId;
                workflow.NextLevelId = null;
                // workflow.DestinationOperationId = model.operationId;


                workflow.StatusId = (int)ApprovalStatusEnum.Closed;
                workflow.Comment = model.comment;
                workflow.DeferredExecution = true;

                workflow.LogActivity();

                //NEW WF ACTIVITY BEGINS
                TBL_LOAN_BOOKING_REQUEST request = new TBL_LOAN_BOOKING_REQUEST();
                request = context.TBL_LOAN_BOOKING_REQUEST.Find(model.targetId);

                backTrail = context.TBL_APPROVAL_TRAIL.Where(x => x.TARGETID == model.targetId && x.OPERATIONID == model.nextOperation && x.TOAPPROVALLEVELID == model.approvalLevelId).FirstOrDefault();
                if (model.nextOperation == null)
                {
                    model.nextOperation = request?.OPERATIONID;
                    backTrail = context.TBL_APPROVAL_TRAIL.Where(x => x.TARGETID == model.targetId && x.OPERATIONID == model.nextOperation && x.FROMAPPROVALLEVELID == model.approvalLevelId).FirstOrDefault();
                }

                if (drawdownPostApprovalOperations.Contains((short)model.nextOperation))
                {
                    if (request != null) { request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Pending; }
                }
            //}
            

            
            workflow.StaffId = model.createdBy;
            workflow.OperationId = (short)model.nextOperation;
            workflow.TargetId = model.targetId;
            workflow.CompanyId = model.companyId;
            workflow.ProductClassId = model.productClassId;
            workflow.ProductId = model.productId;
            workflow.NextLevelId = model.approvalLevelId;
            workflow.IsClassifiedReferBack = true;
            workflow.ToStaffId = backTrail?.TOSTAFFID;
            workflow.DestinationOperationId = model.operationId;

            workflow.StatusId = (int)ApprovalStatusEnum.Referred;
            workflow.Comment = model.comment;
            workflow.DeferredExecution = true;

            
            //workflow.ExternalInitialization = true;

            workflow.LogActivity();

            //Audit Section ---------------------------
            //var audit = new TBL_AUDIT
            //{
            //    AUDITTYPEID = (short)AuditTypeEnum.facilityBookingReferedBack,
            //    STAFFID = model.createdBy,
            //    BRANCHID = (short)model.BranchId,
            //    DETAIL = $"facility booking with booking account number  refered back to modifier.",
            //    IPADDRESS = model.userIPAddress,
            //    URL = model.applicationUrl,
            //    APPLICATIONDATE = generalSetup.GetApplicationDate(),
            //    SYSTEMDATETIME = DateTime.Now
            //};
            //context.TBL_AUDIT.Add(audit);
            ////end of Audit section -------------------------------

            context.SaveChanges();
            return workflow.Response;
        }

        private WorkflowResponse invokeLMSClassifiedReferBack(ApprovalViewModel model)
        {
            int staffId = model.staffId;
            var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();

            List<short> drawdownPostApprovalOperations = new List<short>();

            if (model.isLmsOperations)
            {
                var operation = context.TBL_OPERATIONS.FirstOrDefault(o => o.OPERATIONID == model.operationId);
                var operationId = operation.SYNCHOPERATIONID ?? 0;
                if (operationId == 0)
                {
                    throw new SecureException("Please setup a SYNCOPERATIONID for operation " + operation.OPERATIONNAME);
                }
                var trails = context.TBL_APPROVAL_TRAIL.Where(t => t.TARGETID == model.targetId && t.OPERATIONID == operationId && t.RESPONSESTAFFID == null && t.APPROVALSTATEID != (int)ApprovalState.Ended).ToList();
                if(trails.Count > 0)
                {
                    model.operationId = operationId;
                    workflow.StaffId = model.createdBy;
                    workflow.OperationId = model.operationId;
                    workflow.TargetId = model.targetId;
                    workflow.CompanyId = model.companyId;
                    workflow.ProductClassId = model.productClassId;
                    workflow.ProductId = model.productId;
                    workflow.NextLevelId = null;

                    workflow.StatusId = (int)ApprovalStatusEnum.Closed;
                    workflow.Comment = model.comment;
                    workflow.DeferredExecution = true;

                    workflow.LogActivity();
                }
            }
            else
            {
                var trails = context.TBL_APPROVAL_TRAIL.Where(t => t.TARGETID == model.targetId && t.OPERATIONID == model.operationId && t.RESPONSESTAFFID == null && t.APPROVALSTATEID != (int)ApprovalState.Ended).ToList();
                var Unapprovedtrails = context.TBL_APPROVAL_TRAIL.Any(t => t.TARGETID == model.targetId && t.OPERATIONID == model.operationId && t.APPROVALSTATEID != (int)ApprovalState.Ended && (t.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved && t.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved));
                if (trails.Count > 0 && Unapprovedtrails)
                {
                    workflow.StaffId = model.createdBy;
                    workflow.OperationId = model.operationId;
                    workflow.TargetId = model.targetId;
                    workflow.CompanyId = model.companyId;
                    workflow.ProductClassId = model.productClassId;
                    workflow.ProductId = model.productId;
                    workflow.NextLevelId = null;

                    workflow.StatusId = (int)ApprovalStatusEnum.Closed;
                    workflow.Comment = model.comment;
                    workflow.DeferredExecution = true;

                    workflow.LogActivity();
                }
            }
            
            
            //NEW WF ACTIVITY BEGINS
            TBL_LMSR_APPLICATION request = new TBL_LMSR_APPLICATION();
            request = context.TBL_LMSR_APPLICATION.Find(model.targetId);
            request.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;

            var backTrail = context.TBL_APPROVAL_TRAIL.Where(x => x.TARGETID == model.targetId && x.OPERATIONID == model.nextOperation && x.TOAPPROVALLEVELID == model.approvalLevelId).FirstOrDefault();
            if (model.nextOperation == null)
            {
                model.nextOperation = request?.OPERATIONID;
                backTrail = context.TBL_APPROVAL_TRAIL.Where(x => x.TARGETID == model.targetId && x.OPERATIONID == model.nextOperation && x.FROMAPPROVALLEVELID == model.approvalLevelId).FirstOrDefault();
            }
            request.APPROVALSTATUSID = (short)ApprovalStatusEnum.Pending;

            workflow.StaffId = model.createdBy;
            workflow.OperationId = (short)model.nextOperation;
            workflow.TargetId = model.targetId;
            workflow.CompanyId = model.companyId;
            workflow.ProductClassId = model.productClassId;
            workflow.ProductId = model.productId;
            workflow.NextLevelId = model.approvalLevelId;
            workflow.IsClassifiedReferBack = true;
            workflow.ToStaffId = backTrail?.TOSTAFFID;
            if (model.isLmsOperations)
            {//to be changed when the LMSOPERATIONS is initiated same way as LOSOPERATIONS
                workflow.DestinationOperationId = null;
            }
            else
            {
                workflow.DestinationOperationId = model.operationId;
            }

            workflow.StatusId = (int)ApprovalStatusEnum.Referred;
            workflow.Comment = model.comment;
            workflow.DeferredExecution = true;

            workflow.LogActivity();

            //Audit Section ---------------------------
            //var audit = new TBL_AUDIT
            //{
            //    AUDITTYPEID = (short)AuditTypeEnum.facilityBookingReferedBack,
            //    STAFFID = model.createdBy,
            //    BRANCHID = (short)model.BranchId,
            //    DETAIL = $"facility booking with booking account number  refered back to modifier.",
            //    IPADDRESS = model.userIPAddress,
            //    URL = model.applicationUrl,
            //    APPLICATIONDATE = generalSetup.GetApplicationDate(),
            //    SYSTEMDATETIME = DateTime.Now
            //};
            //context.TBL_AUDIT.Add(audit);
            ////end of Audit section -------------------------------

            context.SaveChanges();
            return workflow.Response;
        }

        public WorkflowResponse ReferBackBooking(ApprovalViewModel model)
        {
            int staffId = model.staffId;
            int currentLevelIndex = 0;
            int nextLevelIndex = 0;

            //if (model.loopedStaffId != null) staffId = (int)model.loopedStaffId;

            //int staffId = model.staffId;

            var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();

            if (model.isClassified) { return invokeClassifiedReferBack(model); }

            var levels = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == model.operationId)
                .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
                .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true && x.DELETED == false),
                    mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new
                    {
                        groupPosition = mg.m.POSITION,
                        levelPosition = l.POSITION,
                        levelId = l.APPROVALLEVELID,
                        levelName = l.LEVELNAME,
                        staffRoleId = l.STAFFROLEID.Value,
                    })
                    .OrderBy(x => x.groupPosition)
                    .ThenBy(x => x.levelPosition)
                    .ToList();

            if(model.operationId == (int)OperationsEnum.IBLAvailmentInProgress)
            {
                var operationId = 6;
                
                var book = context.TBL_LOAN_BOOKING_REQUEST.Find(model.targetId);
                var appdtl = context.TBL_LOAN_APPLICATION_DETAIL.Find(book.LOANAPPLICATIONDETAILID);
                var app = context.TBL_LOAN_APPLICATION.Find(appdtl.LOANAPPLICATIONID);
                var o = context.TBL_APPROVAL_TRAIL.Find(model.targetId); // here we try to get the staffid on the trail row

                var trail = context.TBL_APPROVAL_TRAIL.FirstOrDefault(x =>
                    x.OPERATIONID == operationId
                    && x.TARGETID == app.LOANAPPLICATIONID
                    //&& x.REQUESTSTAFFID == o.REQUESTSTAFFID
                );

                workflow.StaffId = model.createdBy;
                workflow.OperationId = operationId;
                workflow.TargetId = app.LOANAPPLICATIONID;
                workflow.CompanyId = app.COMPANYID;
                workflow.ProductClassId = app.PRODUCTCLASSID;
                workflow.ProductId = 156;
                workflow.NextLevelId = trail.FROMAPPROVALLEVELID;//
                workflow.ToStaffId = app.CREATEDBY;
                workflow.StatusId = (int)ApprovalStatusEnum.Referred;
                workflow.DestinationOperationId = (int)OperationsEnum.IBLAvailmentInProgress;
                workflow.Comment = model.comment;
                workflow.DeferredExecution = true;
                workflow.ExternalInitialization = true;
                workflow.LogActivity();

                // Take out of offer letter screen
                var currentTrail = context.TBL_APPROVAL_TRAIL.FirstOrDefault(x =>
                    x.OPERATIONID == (int)OperationsEnum.IBLAvailmentInProgress
                    && x.RESPONSESTAFFID == null
                    && x.TARGETID == model.targetId
                );
                if (currentTrail != null)
                {
                    currentTrail.APPROVALSTATEID = (int)ApprovalState.Ended;
                    currentTrail.APPROVALSTATUSID = (int)ApprovalStatusEnum.Disapproved;
                    currentTrail.COMMENT = model.comment;
                    currentTrail.RESPONSESTAFFID = model.createdBy;
                    currentTrail.RESPONSEDATE = DateTime.Now;
                    //currentTrail.TOAPPROVALLEVELID = null;
                    //currentTrail.TOSTAFFID = null;
                }
                app.APPROVALSTATUSID = (int)ApprovalStatusEnum.Referred;
                app.APPLICATIONSTATUSID = (int)LoanApplicationStatusEnum.CAMInProgress;

                context.SaveChanges();
                return workflow.Response; 
            }

            if (model.myLevelId > 0)
            {
                currentLevelIndex = levels.FindIndex(p => p.levelId == model.myLevelId);
                nextLevelIndex = levels.FindIndex(p => p.levelId == model.approvalLevelId);
            }
            else
            {
                var levelStaffs = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == model.operationId)
                 .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
                 .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true && x.DELETED == false), mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new {mg, l})
                 .Join(context.TBL_APPROVAL_LEVEL_STAFF.Where(x => x.DELETED == false), mgl => mgl.l.APPROVALLEVELID, s => s.APPROVALLEVELID, (mgl, s) => new
                     {
                         groupPosition = mgl.mg.m.POSITION,
                         levelPosition = mgl.l.POSITION,
                         levelId = mgl.l.APPROVALLEVELID,
                         levelName = mgl.l.LEVELNAME,
                         staffRoleId = s.TBL_STAFF.STAFFROLEID,
                     })
                     .OrderBy(x => x.groupPosition)
                     .ThenBy(x => x.levelPosition)
                     .ToList();
                //levels.AddRange(levelStaffs);

                var staffRoleLevels = levels.Where(x => x.staffRoleId == staff.STAFFROLEID).ToList();

                if (staffRoleLevels.Count == 0)
                {
                    staffRoleLevels = levelStaffs.Where(x => x.staffRoleId == staff.STAFFROLEID).ToList();
                }
                var staffRoleLevelIds = staffRoleLevels.Select(x => x.levelId).ToList();
                var staffRoleLevelId = staffRoleLevelIds.LastOrDefault();

                currentLevelIndex = levels.FindIndex(p => p.levelId == staffRoleLevelId);
                nextLevelIndex = levels.FindIndex(p => p.levelId == model.approvalLevelId);
            }

            


            if (nextLevelIndex > currentLevelIndex)
                throw new ConditionNotMetException("The refered level is higher than the current level.");


            workflow.StaffId = model.createdBy;
            workflow.OperationId = model.operationId;
            workflow.TargetId = model.targetId;
            workflow.CompanyId = model.companyId;
            workflow.ProductClassId = model.productClassId;
            workflow.ProductId = model.productId;
            workflow.NextLevelId = model.approvalLevelId;

            //workflow.ToStaffId = staffId;
            workflow.ToStaffId = model.toStaffId;
            workflow.LoopedStaffId = model.loopedStaffId;
            workflow.StatusId = (int)ApprovalStatusEnum.Referred;
            workflow.Comment = model.comment;
            workflow.DeferredExecution = true;

            workflow.LogActivity();

            string WorkflowStageName = "";
            var WorkflowStage = context.TBL_STAFF_ROLE.Where(s => s.STAFFROLEID == staff.STAFFROLEID).Select(s => s.STAFFROLECODE).FirstOrDefault();
            if (WorkflowStage == "RM")
            {
                WorkflowStageName = "11";
            }
            if (WorkflowStage.Substring(0, 2) == "CR")
            {
                WorkflowStageName = "12";
            }
            if (WorkflowStage == "GH")
            {
                WorkflowStageName = "13";
            }

            var loanApplicationId = (from O in context.TBL_LOAN_BOOKING_REQUEST
                                     join C in context.TBL_LOAN_APPLICATION_DETAIL on O.LOANAPPLICATIONDETAILID equals C.LOANAPPLICATIONDETAILID
                                     where O.LOAN_BOOKING_REQUESTID == model.targetId
                                     select C).FirstOrDefault()?.LOANAPPLICATIONID;

            var appl = context.TBL_LOAN_APPLICATION.Where(x => x.LOANAPPLICATIONID == loanApplicationId).FirstOrDefault();
            if (appl != null && appl.APIREQUESTID != null)
            {
                var product = context.TBL_PRODUCT.Find(appl.PRODUCTID);
                if (product?.PRODUCTCODE == "EBFC" && model.forbidExternalNotification == false)
                {
                    OfferLetterResponse offerLetters = new OfferLetterResponse();
                    var staffDetail = context.TBL_STAFF.Where(s => s.STAFFID == model.createdBy).FirstOrDefault();
                    var staffFullName = staffDetail.FIRSTNAME + " " + staffDetail.LASTNAME;
                    offerLetters.Comment = model.comment;
                    offerLetters.RequestId = appl.APIREQUESTID;
                    offerLetters.WorkflowStage = WorkflowStageName;
                    offerLetters.ActionByName = staffFullName;
                    ApiOfferLetterPosting(offerLetters, appl.APPLICATIONREFERENCENUMBER);
                }
            }

            //Audit Section ---------------------------
            //var audit = new TBL_AUDIT
            //{
            //    AUDITTYPEID = (short)AuditTypeEnum.facilityBookingReferedBack,
            //    STAFFID = model.createdBy,
            //    BRANCHID = (short)model.BranchId,
            //    DETAIL = $"facility booking with booking account number  refered back to modifier.",
            //    IPADDRESS = model.userIPAddress,
            //    URL = model.applicationUrl,
            //    APPLICATIONDATE = generalSetup.GetApplicationDate(),
            //    SYSTEMDATETIME = DateTime.Now
            //};
            //context.TBL_AUDIT.Add(audit);
            ////end of Audit section -------------------------------

            context.SaveChanges();
            return workflow.Response;
        }
        #endregion

        private void getAPIURLSettings(string typeName = null)
        {
            var apiConfig = APIUrlConfig.Where(x => x.TYPENAME.ToLower() == typeName.ToLower()).FirstOrDefault();
            if (apiConfig != null)
            {
                API_URL = apiConfig.URL;
                API_KEY = apiConfig.APIKEY;
            }
            if (apiConfig == null)
            {
                apiConfig = APIUrlConfig.Where(x => x.TYPENAME.ToUpper() == "DEFAULT").FirstOrDefault();
                API_URL = apiConfig.URL;
                API_KEY = apiConfig.APIKEY;
            }
        }
        

        public async Task<ResponseMessage> ApiOfferLetterPosting(OfferLetterResponse model, string refNumber)
        {

            HttpClientHandler handler = new HttpClientHandler();
            HttpClient httpClientInstance;

            HttpClient client = new HttpClient(handler);
            var inputJson = new JavaScriptSerializer().Serialize(model);
            DateTime requestDatetime = new DateTime(), responseDateTime = new DateTime();
            HttpResponseMessage response = null;
            OfferLetterResponse responseApi = new OfferLetterResponse();
            ResponseMessage responseMsg = null;
            string responseJson = "";
            getAPIURLSettings("CASHFLOW");
            string apiUrl = "CallBack/ReferBack";

            try
            {
                var token = new AuthenticationHeaderValue("Basic", API_KEY);
                handler.UseDefaultCredentials = true;
                httpClientInstance = new HttpClient();
                httpClientInstance.DefaultRequestHeaders.ConnectionClose = false;
                client.Timeout = TimeSpan.FromSeconds(180);
                client.DefaultRequestHeaders.Authorization = token;

                client.BaseAddress = new Uri(API_URL);
                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Accept.Add(
                new MediaTypeWithQualityHeaderValue("application/json"));

                ServicePointManager.ServerCertificateValidationCallback += (sender, cert, chain, sslPolicyErrors) => true;
                requestDatetime = DateTime.Now;

                response = client.PostAsync(apiUrl, new StringContent(
                                                new JavaScriptSerializer().Serialize(model), Encoding.UTF8, "application/json")).Result;

                responseDateTime = DateTime.Now;

                if (response.IsSuccessStatusCode)
                {
                    responseApi = await response.Content.ReadAsAsync<OfferLetterResponse>();
                    var res = new OfferLetterResponse
                    {
                        StatusCode = responseApi.StatusCode,
                        RequestId = responseApi.RequestId,
                        WorkflowStage = responseApi.WorkflowStage,

                    };
                    responseMsg = new ResponseMessage
                    {
                        APIOffetResponse = res,
                        APIStatus = response.IsSuccessStatusCode,
                        Message = response
                    };
                }
                else
                {
                    responseMsg = new ResponseMessage
                    {
                        APIResponse = null,
                        APIStatus = response.IsSuccessStatusCode,
                        Message = response
                    };
                }

                responseJson = await response.Content.ReadAsStringAsync();

                responseMsg.responseMessage = responseJson;
                //handler.Dispose();
                //client.Dispose();

                return responseMsg;
            }
            catch (Exception ex)
            {
                var innerExceptionMessage = "";
                if (ex.InnerException != null)
                    innerExceptionMessage = ex.InnerException.Message;
                //if (responseJson == string.Empty) responseJson = innerExceptionMessage;
                throw new APIErrorException($"Core Banking API Error - {ex.Message} - inner exception - {innerExceptionMessage}");
            }

            finally
            {
                handler.Dispose();
                client.Dispose();

                var logs = new TBL_CUSTOM_API_LOGS
                {
                    APIURL = apiUrl,
                    LOGTYPEID = 14,
                    REFERENCENUMBER = refNumber,
                    REQUESTDATETIME = requestDatetime,
                    REQUESTMESSAGE = inputJson,
                    RESPONSEDATETIME = responseDateTime,
                    RESPONSEMESSAGE = responseJson,
                };

                FinTrakBankingContext logContext = new FinTrakBankingContext();

                logContext.TBL_CUSTOM_API_LOGS.Add(logs);

                logContext.SaveChanges();
            }

        }

        #region Line Operations

        #endregion


        public List<LoanViewModel> GetApprovedLoanReviewAwaitingRoute(int staffId, int companyId)
        {
            var applicationDate = generalSetup.GetApplicationDate();
            //var activities = admin.GetUserActivitiesByUser(staffId);
            // var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId ).Select(x => x).FirstOrDefault().CURRENCYID;
            UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);

            //var ids = generalSetup.GetStaffApprovalLevelIds(staffId, 0).ToList();
            var ids = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.LmsOperations).ToList();

            var allFilteredLoan = (from a in context.TBL_LOAN
                                   join b in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals b.LOANID
                                   join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                   join atrail in context.TBL_APPROVAL_TRAIL on b.LOANREVIEWAPPLICATIONID equals atrail.TARGETID
                                   join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                   where //b.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                   b.OPERATIONPERFORMED == false
                                   && (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                                   && atrail.OPERATIONID == (short)OperationsEnum.LmsOperations
                                   && (ids.Contains((int)atrail.TOAPPROVALLEVELID) || atrail.REQUESTSTAFFID == staffId)
                                   && atrail.RESPONSESTAFFID == null //&& b.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                   && ((cf.CanSeeLocalCurrency && a.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && a.CURRENCYID != cf.DefaultCurrencyId))
                                   orderby b.DATETIMECREATED descending
                                   select new LoanViewModel
                                   {
                                       divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == c.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                       divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                       loanReviewApplicationId = e.LOANAPPLICATIONID,
                                       loanId = a.TERMLOANID,
                                       customerId = a.CUSTOMERID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                       productId = a.PRODUCTID,
                                       companyId = a.COMPANYID,
                                       casaAccountId = a.CASAACCOUNTID,
                                       branchId = a.BRANCHID,
                                       branchName = a.TBL_BRANCH.BRANCHNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                       pricipalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                       interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                       interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                       principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                       interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                       relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                       relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                       relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                       relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                       misCode = a.MISCODE,
                                       teamMiscode = a.TEAMMISCODE,
                                       interestRate = a.INTERESTRATE,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       bookingDate = a.BOOKINGDATE,
                                       principalAmount = a.PRINCIPALAMOUNT,
                                       principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                       interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                       approvalStatusId = a.APPROVALSTATUSID,
                                       approvedBy = a.APPROVEDBY,
                                       approverComment = a.APPROVERCOMMENT,
                                       dateApproved = a.DATEAPPROVED,
                                       loanStatusId = a.LOANSTATUSID,
                                       scheduleTypeId = a.SCHEDULETYPEID,
                                       scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                       isDisbursed = a.ISDISBURSED,
                                       disbursedBy = a.DISBURSEDBY,
                                       disburserComment = a.DISBURSERCOMMENT,
                                       disburseDate = a.DISBURSEDATE,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                       //approvedAmount = a.ApprovedAmount,
                                       operationId = b.OPERATIONID,
                                       operationName = b.TBL_OPERATIONS.OPERATIONNAME, //context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                       subSectorName = a.TBL_SUB_SECTOR.NAME,
                                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                       casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                       productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                       customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                       loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       equityContribution = a.EQUITYCONTRIBUTION,
                                       firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                       firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                       outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                       outstandingInterest = a.OUTSTANDINGINTEREST,
                                       principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                       principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                       fixedPrincipal = a.FIXEDPRINCIPAL,
                                       profileLoan = a.PROFILELOAN,
                                       dischargeLetter = a.DISCHARGELETTER,
                                       suspendInterest = a.SUSPENDINTEREST,
                                       customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                       createdBy = a.CREATEDBY,
                                       dateTimeCreated = a.DATETIMECREATED,
                                       isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                       exchangeRate = a.EXCHANGERATE,
                                       currencyId = a.CURRENCYID,
                                       currency = a.TBL_CURRENCY.CURRENCYNAME,
                                       loanReviewOperationTypeId = b.OPERATIONID,
                                       reviewDetails = b.REVIEWDETAILS,
                                       interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                       interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                       pastDueInterest = a.PASTDUEINTEREST,
                                       pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                       accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.TERMLOANID && x.DATE == applicationDate).Select(x => x.ACCRUEDINTEREST).FirstOrDefault(),  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                       systemCurrentDate = applicationDate,
                                       lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                       timeIn = atrail.SYSTEMARRIVALDATETIME,
                                       responsiblePerson = context.TBL_STAFF
                                                   .Where(s => s.STAFFID == atrail.TOSTAFFID)
                                                   .Select(s => new { name = s.FIRSTNAME + " " + s.MIDDLENAME + " " + s.LASTNAME })
                                                   .FirstOrDefault().name ?? "",
                                       operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.TERMLOANID && m.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                       {
                                           loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                           operationTypeId = op.OPERATIONTYPEID,
                                           operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                           newEffectiveDate = op.EFFECTIVEDATE,
                                           reviewDetails = op.REVIEWDETAILS,
                                           prepayment = op.PREPAYMENT,
                                           newInterateRate = op.INTERATERATE,
                                           newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                           newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                           newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                           newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newTenor = op.TENOR,
                                           cASA_AccountId = op.CASA_ACCOUNTID,
                                           cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                           overDraftTopup = op.OVERDRAFTTOPUP,
                                           fee_Charges = op.FEE_CHARGES,
                                           scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                           scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                           scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                           scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                           scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                           newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                           newMaturityDate = op.MATURITYDATE,
                                           dateTimeCreated = op.DATECREATED
                                       }).FirstOrDefault(),
                                   }).ToList();
            var overdraft = GetLoanReviewApplicationOverDraftRouteAndOperations(staffId, companyId);
            return allFilteredLoan.Union(overdraft).ToList();
        }


        public IEnumerable<CamProcessedLoanViewModel> GetApprovedLineReview(int staffId, int companyId)
        {
            var systemDate = generalSetup.GetApplicationDate();
            var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            var staffs = generalSetup.GetStaffRlieved(staffId);

            var operationsRecords = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.LineFacility).Select(x => x.LOANREVIEWAPPLICATIONID).ToList();
            var applicationDate = generalSetup.GetApplicationDate();
            var data = (from d in context.TBL_LOAN_APPLICATION_DETAIL
                        join l in context.TBL_LMSR_APPLICATION_DETAIL on d.LOANAPPLICATIONDETAILID equals l.LOANID
                        join e in context.TBL_LMSR_APPLICATION on l.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                        join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                        join c in context.TBL_CUSTOMER on d.CUSTOMERID equals c.CUSTOMERID
                        where 
                          l.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility
                          && !operationsRecords.Contains(l.LOANREVIEWAPPLICATIONID)
                          && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationCompleted
                          && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationInProgress
                          && l.OPERATIONPERFORMED == false
                          && e.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                          && l.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                        select new CamProcessedLoanViewModel
                        {
                            divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == c.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                            creditAppraisalOperationId = m.OPERATIONID,
                            creditAppraisalLoanApplicationId = m.LOANAPPLICATIONID,
                            loanSystemTypeId = l.LOANSYSTEMTYPEID,
                            loanId = l.LOANID,
                            loanReviewApplicationId = e.LOANAPPLICATIONID,
                            approvalStatusId = (short)m.APPROVALSTATUSID,
                            loanApplicationId = m.LOANAPPLICATIONID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                            applicationStatusId = m.APPLICATIONSTATUSID,
                            customerId = m.CUSTOMERID ?? 0,
                            customerCode = c.CUSTOMERCODE,
                            lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                            customerName = d.TBL_CUSTOMER.FIRSTNAME + " " + d.TBL_CUSTOMER.MIDDLENAME + " " + d.TBL_CUSTOMER.LASTNAME,
                            customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                            customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                            customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                            isRelatedParty = m.ISRELATEDPARTY,
                            customerSensitivityLevelId = d.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                            customerOccupation = d.TBL_CUSTOMER.OCCUPATION,
                            customerType = d.TBL_CUSTOMER.TBL_CUSTOMER_TYPE.NAME,
                            divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == e.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                            isPoliticallyExposed = d.TBL_CUSTOMER.ISPOLITICALLYEXPOSED,
                            isInvestmentGrade = m.ISINVESTMENTGRADE,
                            operationId = l.OPERATIONID,
                            operationName = m.TBL_OPERATIONS.OPERATIONNAME,

                            companyId = m.COMPANYID,
                            branchId = m.BRANCHID,
                            branchName = m.TBL_BRANCH.BRANCHNAME,
                            subSectorId = d.SUBSECTORID,
                            subSectorName = d.TBL_SUB_SECTOR.NAME,
                            sectorName = d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                            applicationTenor = m.APPLICATIONTENOR,
                            effectiveDate = (DateTime)d.EFFECTIVEDATE,
                            expiryDate = d.EXPIRYDATE,

                            relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                            relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                            relationshipManagerId = m.RELATIONSHIPMANAGERID,
                            relationshipManagerName = m.TBL_STAFF1.FIRSTNAME + " " + m.TBL_STAFF1.MIDDLENAME + " " + m.TBL_STAFF1.LASTNAME,

                            currencyId = d.CURRENCYID,
                            currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                            exchangeRate = d.EXCHANGERATE,
                            loanTypeId = m.LOANAPPLICATIONTYPEID,
                            loanTypeName = m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                            camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                            productId = d.APPROVEDPRODUCTID,
                            productTypeId = d.TBL_PRODUCT.PRODUCTTYPEID,
                            productTypeName = d.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            productName = d.TBL_PRODUCT.PRODUCTNAME,
                            productClassProcessId = m.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                            misCode = m.MISCODE,
                            teamMisCode = m.TEAMMISCODE,

                            interestRate = d.APPROVEDINTERESTRATE,
                            submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                            approvedAmount = d.APPROVEDAMOUNT,
                            approvedDate = m.APPROVEDDATE,
                            groupApprovedAmount = m.APPROVEDAMOUNT,
                            approvedTenor = d.APPROVEDTENOR,
                            createdBy = m.OWNEDBY,
                            newApplicationDate = m.APPLICATIONDATE,
                            dateTimeCreated = d.DATETIMECREATED,
                            systemCurrentDate = systemDate,
                            loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,
                            lmsApplicationDetailId = l.LOANREVIEWAPPLICATIONID,

                        }).ToList();

            var referred = (from op in context.TBL_LOAN_REVIEW_OPERATION
                           join tt in context.TBL_OPERATIONS on op.OPERATIONTYPEID equals tt.OPERATIONID
                           join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                           join l in context.TBL_LMSR_APPLICATION_DETAIL on op.LOANID equals l.LOANID
                           join e in context.TBL_LMSR_APPLICATION on l.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                           join d in context.TBL_LOAN_APPLICATION_DETAIL on l.LOANID equals d.LOANAPPLICATIONDETAILID
                           join m in context.TBL_LOAN_APPLICATION on d.LOANAPPLICATIONID equals m.LOANAPPLICATIONID
                           join c in context.TBL_CUSTOMER on d.CUSTOMERID equals c.CUSTOMERID
                           where l.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.LineFacility
                             //&& l.OPERATIONPERFORMED == false
                           && l.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved
                           && atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                           && atrail.OPERATIONID == op.OPERATIONTYPEID
                           && atrail.RESPONSESTAFFID == null 
                           && atrail.APPROVALSTATEID != (int)ApprovalState.Ended
                           && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                           && op.OPERATIONCOMPLETED == false
                           && e.APPROVALSTATUSID != (short)ApprovalStatusEnum.Disapproved
                           && (staffs.Contains(atrail.LOOPEDSTAFFID ?? 0))
                           && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationCompleted
                           && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationInProgress
                            select new CamProcessedLoanViewModel
                            {
                                divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == c.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                creditAppraisalOperationId = m.OPERATIONID,
                                creditAppraisalLoanApplicationId = m.LOANAPPLICATIONID,
                                loanSystemTypeId = l.LOANSYSTEMTYPEID,
                                loanId = l.LOANID,
                                loanReviewApplicationId = e.LOANAPPLICATIONID,
                                approvalStatusId = (short)m.APPROVALSTATUSID,
                                loanApplicationId = m.LOANAPPLICATIONID,
                                loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                                applicationReferenceNumber = m.APPLICATIONREFERENCENUMBER,
                                applicationStatusId = m.APPLICATIONSTATUSID,
                                customerId = m.CUSTOMERID ?? 0,
                                customerCode = c.CUSTOMERCODE,
                                lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                customerName = d.TBL_CUSTOMER.FIRSTNAME + " " + d.TBL_CUSTOMER.MIDDLENAME + " " + d.TBL_CUSTOMER.LASTNAME,
                                customerGroupId = m.CUSTOMERGROUPID.HasValue ? m.CUSTOMERGROUPID : 0,
                                customerGroupName = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPNAME : "",
                                customerGroupCode = m.CUSTOMERGROUPID.HasValue ? m.TBL_CUSTOMER_GROUP.GROUPCODE : "",
                                isRelatedParty = m.ISRELATEDPARTY,
                                customerSensitivityLevelId = d.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                customerOccupation = d.TBL_CUSTOMER.OCCUPATION,
                                customerType = d.TBL_CUSTOMER.TBL_CUSTOMER_TYPE.NAME,
                                divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == e.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                isPoliticallyExposed = d.TBL_CUSTOMER.ISPOLITICALLYEXPOSED,
                                isInvestmentGrade = m.ISINVESTMENTGRADE,
                                operationId = l.OPERATIONID,
                                operationName = m.TBL_OPERATIONS.OPERATIONNAME,

                                companyId = m.COMPANYID,
                                branchId = m.BRANCHID,
                                branchName = m.TBL_BRANCH.BRANCHNAME,
                                subSectorId = d.SUBSECTORID,
                                subSectorName = d.TBL_SUB_SECTOR.NAME,
                                sectorName = d.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                applicationTenor = m.APPLICATIONTENOR,
                                effectiveDate = (DateTime)d.EFFECTIVEDATE,
                                expiryDate = d.EXPIRYDATE,

                                relationshipOfficerId = m.RELATIONSHIPOFFICERID,
                                relationshipOfficerName = m.TBL_STAFF.FIRSTNAME + " " + m.TBL_STAFF.MIDDLENAME + " " + m.TBL_STAFF.LASTNAME,
                                relationshipManagerId = m.RELATIONSHIPMANAGERID,
                                relationshipManagerName = m.TBL_STAFF1.FIRSTNAME + " " + m.TBL_STAFF1.MIDDLENAME + " " + m.TBL_STAFF1.LASTNAME,

                                currencyId = d.CURRENCYID,
                                currencyCode = d.TBL_CURRENCY.CURRENCYCODE,
                                exchangeRate = d.EXCHANGERATE,
                                loanTypeId = m.LOANAPPLICATIONTYPEID,
                                loanTypeName = m.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                camReference = m.TBL_CREDIT_APPRAISAL_MEMORANDM.FirstOrDefault().CAMREF,
                                productId = d.APPROVEDPRODUCTID,
                                productTypeId = d.TBL_PRODUCT.PRODUCTTYPEID,
                                productTypeName = d.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                productName = d.TBL_PRODUCT.PRODUCTNAME,
                                productClassProcessId = m.TBL_PRODUCT_CLASS.PRODUCT_CLASS_PROCESSID,
                                misCode = m.MISCODE,
                                teamMisCode = m.TEAMMISCODE,

                                interestRate = d.APPROVEDINTERESTRATE,
                                submittedForAppraisal = m.SUBMITTEDFORAPPRAISAL,
                                approvedAmount = d.APPROVEDAMOUNT,
                                approvedDate = m.APPROVEDDATE,
                                groupApprovedAmount = m.APPROVEDAMOUNT,
                                approvedTenor = d.APPROVEDTENOR,
                                createdBy = m.OWNEDBY,
                                newApplicationDate = m.APPLICATIONDATE,
                                dateTimeCreated = d.DATETIMECREATED,
                                systemCurrentDate = systemDate,
                                loanPreliminaryEvaluationId = m.LOANPRELIMINARYEVALUATIONID ?? 0,
                                lmsApplicationDetailId = l.LOANREVIEWAPPLICATIONID,

                            }).ToList();

            data = data.Union(referred).ToList();
            List<CamProcessedLoanViewModel> lcyLoans = new List<CamProcessedLoanViewModel>();
            List<CamProcessedLoanViewModel> fcyLoans = new List<CamProcessedLoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = data.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
            }

            if (isFCYUser == true)
            {
                fcyLoans = data.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            data = lcyLoans.Union(fcyLoans).ToList();


            foreach (var item in data)
            {
                var requests = context.TBL_LOAN_BOOKING_REQUEST.Where(r => r.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);

                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Count() > 0)
                    item.approveRequestAmount = (decimal)requests.Where(k => k.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved).Sum(s => s.AMOUNT_REQUESTED);

                if (requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                    item.pendingRequestAmount = (decimal)requests.Where(j => j.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount;

                if (requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Count() > 0)
                    item.allRequestAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Approved || n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Pending).Sum(s => s.AMOUNT_REQUESTED) - item.requestedAmount;

                item.disapprovedCount = (int)requests.Where(a => a.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Count();

                if (item.disapprovedCount > 0)
                    item.disApprovedAmount = (decimal)requests.Where(n => n.APPROVALSTATUSID == (short)ApprovalStatusEnum.Disapproved).Sum(s => s.AMOUNT_REQUESTED);

                item.customerAvailableAmount = item.approvedAmount - (item.allRequestAmount - item.requestedAmount);

                item.isBooked = context.TBL_LOAN.Where(x => x.LOAN_BOOKING_REQUESTID == item.loanBookingRequestId).Any();

                var loans = context.TBL_LOAN.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var overdrafts = context.TBL_LOAN_REVOLVING.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                var contingents = context.TBL_LOAN_CONTINGENT.Where(tl => tl.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId);
                switch (item.productTypeId)
                {
                    case (short)LoanProductTypeEnum.TermLoan:
                        decimal customerAvailableAmount = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount = customerAvailableAmount + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount;
                        break;
                    case (short)LoanProductTypeEnum.CommercialLoan:
                        decimal customerAvailableAmount2 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount2 = customerAvailableAmount2 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount2;
                        break;
                    case (short)LoanProductTypeEnum.SelfLiquidating:
                        decimal customerAvailableAmount3 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount3 = customerAvailableAmount3 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount3;
                        break;
                    case (short)LoanProductTypeEnum.RevolvingLoan:
                        decimal overdraftBal = 0;
                        foreach (var overdraft in overdrafts)
                        {
                            if (overdraft.OVERDRAFTLIMIT > 0) overdraftBal = overdraftBal + overdraft.OVERDRAFTLIMIT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - overdraftBal;
                        break;
                    case (short)LoanProductTypeEnum.ContingentLiability:
                        decimal contingentBal = 0;
                        foreach (var contingent in contingents)
                        {
                            if (contingent.CONTINGENTAMOUNT > 0) contingentBal = contingentBal + contingent.CONTINGENTAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - contingentBal;
                        break;
                    case (short)LoanProductTypeEnum.ForeignXRevolving:
                        decimal customerAvailableAmount4 = 0;
                        foreach (var loan in loans)
                        {
                            if (loan.PRINCIPALAMOUNT > 0) customerAvailableAmount4 = customerAvailableAmount4 + loan.PRINCIPALAMOUNT;
                        }
                        item.customerAvailableAmount = item.approvedAmount - customerAvailableAmount4;
                        break;
                }

                var disbursedLoan = context.TBL_LOAN.Where(x => x.LOANAPPLICATIONDETAILID == item.loanApplicationDetailId && x.ISDISBURSED == true);
                if (disbursedLoan.Any())
                {
                    item.amountDisbursed = disbursedLoan.Sum(c => c.PRINCIPALAMOUNT);
                }
                if (item.effectiveDate != null)
                {
                    item.tenorUsed = (systemDate - item.effectiveDate).Value.Days;
                }
                item.operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == item.loanApplicationDetailId && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                {
                    loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                    operationTypeId = op.OPERATIONTYPEID,
                    operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                    newEffectiveDate = op.EFFECTIVEDATE,
                    reviewDetails = op.REVIEWDETAILS,
                    prepayment = op.PREPAYMENT,
                    newInterateRate = op.INTERATERATE,
                    newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                    newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                    newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                    newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                    newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                    newTenor = op.TENOR,
                    cASA_AccountId = op.CASA_ACCOUNTID,
                    cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                    overDraftTopup = op.OVERDRAFTTOPUP,
                    fee_Charges = op.FEE_CHARGES,
                    scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                    scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                    scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                    scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                    scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                    newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                    newMaturityDate = op.MATURITYDATE,
                    dateTimeCreated = op.DATECREATED
                }).FirstOrDefault();

            }

            return data;
        }

        public IEnumerable<LoanViewModel> GetApprovedLoanReview(int companyId, int staffId)
        {
            List<short> productTypes = new List<short>();
            var applicationDate = generalSetup.GetApplicationDate();
            UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);
            var staffs = generalSetup.GetStaffRlieved(staffId);

            //var operationIds = context.TBL_OPERATIONS.Where(x => x.OPERATIONTYPEID == (short)OperationTypeEnum.LoanManagement).Select(c => c.OPERATIONID).ToList();
            //List<int> ids = new List<int>();

            //foreach (var operationId in operationIds)
            //{
            //    ids.AddRange(generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList().Distinct());
            //}

            var operationsRecords = context.TBL_LOAN_REVIEW_OPERATION.Where(x => x.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility).Select(x => x.LOANREVIEWAPPLICATIONID).ToList();
            var allFilteredLoan = (from a in context.TBL_LOAN
                                   join b in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals b.LOANID
                                   //join atrail in context.TBL_APPROVAL_TRAIL on b.LOANREVIEWAPPLICATIONID equals atrail.TARGETID
                                   join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                   join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                   where a.ISDISBURSED == true
                                  && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                  // || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                                  //&& (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending)
                                  // && ids.Contains((int)atrail.TOAPPROVALLEVELID) && operationIds.Contains(atrail.OPERATIONID)
                                  //  && atrail.RESPONSESTAFFID == null
                                  && !operationsRecords.Contains(b.LOANREVIEWAPPLICATIONID)
                                  && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationCompleted
                                  && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationInProgress
                                  && b.OPERATIONPERFORMED == false
                                  && b.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility
                                  && a.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan
                                  && ((cf.CanSeeLocalCurrency && a.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && a.CURRENCYID != cf.DefaultCurrencyId)) // currency filter                                                                                                                                  
                                   select new LoanViewModel
                                   {
                                       lmsdatecreated = b.DATETIMECREATED,
                                       //creditAppraisalOperationId = (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where p.TERMLOANID == a.TERMLOANID select aa.OPERATIONID).FirstOrDefault(),
                                       //creditAppraisalLoanApplicationId = (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where p.TERMLOANID == a.TERMLOANID select aa.LOANAPPLICATIONID).FirstOrDefault(),
                                       creditAppraisalOperationId = (from l in context.TBL_LOAN_APPLICATION_DETAIL join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where a.LOANAPPLICATIONDETAILID == l.LOANAPPLICATIONDETAILID select aa.OPERATIONID).FirstOrDefault(),


                                       creditAppraisalLoanApplicationId = (from l in context.TBL_LOAN_APPLICATION_DETAIL join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where a.LOANAPPLICATIONDETAILID == l.LOANAPPLICATIONDETAILID select aa.LOANAPPLICATIONID).FirstOrDefault(),

                                       appraisalOperationId = e.OPERATIONID,
                                       appraisalLoanApplicationId = e.LOANAPPLICATIONID,
                                       synOperationId = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == b.OPERATIONID).Select(o => o.SYNCHOPERATIONID).FirstOrDefault(),
                                       loanReviewApplicationId = e.LOANAPPLICATIONID,
                                       loanId = a.TERMLOANID,
                                       customerId = a.CUSTOMERID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                       productId = a.PRODUCTID,
                                       companyId = a.COMPANYID,
                                       casaAccountId = a.CASAACCOUNTID,
                                       branchId = a.BRANCHID,
                                       reviewLoanDetaile = b.REVIEWDETAILS,
                                       branchName = a.TBL_BRANCH.BRANCHNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                       principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                       interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                       interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                       principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                       interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                       relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                       relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                       relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                       relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                       misCode = a.MISCODE,
                                       teamMiscode = a.TEAMMISCODE,
                                       interestRate = a.INTERESTRATE,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       bookingDate = a.BOOKINGDATE,
                                       principalAmount = a.PRINCIPALAMOUNT,
                                       principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                       interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                       approvalStatusId = a.APPROVALSTATUSID,
                                       approvedBy = a.APPROVEDBY,
                                       approverComment = a.APPROVERCOMMENT,
                                       dateApproved = a.DATEAPPROVED,
                                       loanStatusId = a.LOANSTATUSID,
                                       scheduleTypeId = a.SCHEDULETYPEID,
                                       scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                       isDisbursed = a.ISDISBURSED,
                                       disbursedBy = a.DISBURSEDBY,
                                       disburserComment = a.DISBURSERCOMMENT,
                                       disburseDate = a.DISBURSEDATE,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                       businessUnit = context.TBL_PROFILE_BUSINESS_UNIT.Where(x => x.BUSINESSUNITID == c.BUSINESSUNTID).Select(x => x.BUSINESSUNITINITIALS).FirstOrDefault(),
                                       divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                       //approvedAmount = a.ApprovedAmount,
                                       operationId = b.OPERATIONID,
                                       operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == e.OPERATIONID).OPERATIONNAME,
                                       subSectorName = a.TBL_SUB_SECTOR.NAME,
                                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                       casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                       productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                       customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                       loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       equityContribution = a.EQUITYCONTRIBUTION,
                                       firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                       firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                       outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                       outstandingInterest = a.OUTSTANDINGINTEREST,
                                       principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                       principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                       fixedPrincipal = a.FIXEDPRINCIPAL,
                                       profileLoan = a.PROFILELOAN,
                                       dischargeLetter = a.DISCHARGELETTER,
                                       suspendInterest = a.SUSPENDINTEREST,
                                       customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                       createdBy = a.CREATEDBY,
                                       dateTimeCreated = a.DATETIMECREATED,
                                       isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                       exchangeRate = a.EXCHANGERATE,
                                       currencyId = a.CURRENCYID,
                                       currency = a.TBL_CURRENCY.CURRENCYNAME,
                                       loanReviewOperationTypeId = b.OPERATIONID,
                                       reviewDetails = b.REVIEWDETAILS,
                                       interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                       interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                       pastDueInterest = a.PASTDUEINTEREST,
                                       pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                       accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.TERMLOANID && x.DATE == applicationDate).Select(x => x.ACCRUEDINTEREST).FirstOrDefault(),  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                       systemCurrentDate = applicationDate,
                                       lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                       operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.TERMLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                       {

                                           loanApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                           loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                           operationTypeId = op.OPERATIONTYPEID,
                                           operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                           newEffectiveDate = op.EFFECTIVEDATE,
                                           reviewDetails = op.REVIEWDETAILS,
                                           prepayment = op.PREPAYMENT,
                                           newInterateRate = op.INTERATERATE,
                                           newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                           newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                           newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                           newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newTenor = op.TENOR,
                                           cASA_AccountId = op.CASA_ACCOUNTID,
                                           cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                           overDraftTopup = op.OVERDRAFTTOPUP,
                                           fee_Charges = op.FEE_CHARGES,
                                           scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                           scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                           scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                           scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                           scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                           newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                           newMaturityDate = op.MATURITYDATE,
                                           dateTimeCreated = op.DATECREATED
                                       }).FirstOrDefault()
                                   }).ToList();

            var referred = (from a in context.TBL_LOAN
                            join op in context.TBL_LOAN_REVIEW_OPERATION on a.TERMLOANID equals op.LOANID
                            join b in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals b.LOANID
                            join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                            join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                            join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                            where a.ISDISBURSED == true
                            && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && b.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility
                            && atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                            && atrail.APPROVALSTATEID != (int)ApprovalState.Ended
                            && atrail.OPERATIONID == op.OPERATIONTYPEID
                            && atrail.RESPONSESTAFFID == null
                            && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && op.OPERATIONCOMPLETED == false
                            && ((cf.CanSeeLocalCurrency && a.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && a.CURRENCYID != cf.DefaultCurrencyId))
                            && (staffs.Contains(atrail.LOOPEDSTAFFID ?? 0))
                            && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationCompleted
                            && e.APPLICATIONSTATUSID != (int)LoanApplicationStatusEnum.CancellationInProgress
                            select new LoanViewModel
                            {
                                lmsdatecreated = b.DATETIMECREATED,
                                //creditAppraisalOperationId = (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where p.TERMLOANID == a.TERMLOANID select aa.OPERATIONID).FirstOrDefault(),
                                //creditAppraisalLoanApplicationId = (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where p.TERMLOANID == a.TERMLOANID select aa.LOANAPPLICATIONID).FirstOrDefault(),
                                creditAppraisalOperationId = (from l in context.TBL_LOAN_APPLICATION_DETAIL join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where a.LOANAPPLICATIONDETAILID == l.LOANAPPLICATIONDETAILID select aa.OPERATIONID).FirstOrDefault(),


                                creditAppraisalLoanApplicationId = (from l in context.TBL_LOAN_APPLICATION_DETAIL join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where a.LOANAPPLICATIONDETAILID == l.LOANAPPLICATIONDETAILID select aa.LOANAPPLICATIONID).FirstOrDefault(),

                                appraisalOperationId = e.OPERATIONID,
                                appraisalLoanApplicationId = e.LOANAPPLICATIONID,
                                synOperationId = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == b.OPERATIONID).Select(o => o.SYNCHOPERATIONID).FirstOrDefault(),
                                loanReviewApplicationId = e.LOANAPPLICATIONID,
                                loanId = a.TERMLOANID,
                                customerId = a.CUSTOMERID,
                                customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                productId = a.PRODUCTID,
                                companyId = a.COMPANYID,
                                casaAccountId = a.CASAACCOUNTID,
                                branchId = a.BRANCHID,
                                reviewLoanDetaile = b.REVIEWDETAILS,
                                branchName = a.TBL_BRANCH.BRANCHNAME,
                                loanReferenceNumber = a.LOANREFERENCENUMBER,
                                lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                productName = a.TBL_PRODUCT.PRODUCTNAME,
                                productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                misCode = a.MISCODE,
                                teamMiscode = a.TEAMMISCODE,
                                interestRate = a.INTERESTRATE,
                                effectiveDate = a.EFFECTIVEDATE,
                                maturityDate = a.MATURITYDATE,
                                bookingDate = a.BOOKINGDATE,
                                principalAmount = a.PRINCIPALAMOUNT,
                                principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = a.APPROVALSTATUSID,
                                approvedBy = a.APPROVEDBY,
                                approverComment = a.APPROVERCOMMENT,
                                dateApproved = a.DATEAPPROVED,
                                loanStatusId = a.LOANSTATUSID,
                                scheduleTypeId = a.SCHEDULETYPEID,
                                scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                isDisbursed = a.ISDISBURSED,
                                disbursedBy = a.DISBURSEDBY,
                                disburserComment = a.DISBURSERCOMMENT,
                                disburseDate = a.DISBURSEDATE,
                                loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                businessUnit = context.TBL_PROFILE_BUSINESS_UNIT.Where(x => x.BUSINESSUNITID == c.BUSINESSUNTID).Select(x => x.BUSINESSUNITINITIALS).FirstOrDefault(),
                                divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                //approvedAmount = a.ApprovedAmount,
                                operationId = b.OPERATIONID,
                                operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == e.OPERATIONID).OPERATIONNAME,
                                subSectorName = a.TBL_SUB_SECTOR.NAME,
                                sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                equityContribution = a.EQUITYCONTRIBUTION,
                                firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                outstandingInterest = a.OUTSTANDINGINTEREST,
                                principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                fixedPrincipal = a.FIXEDPRINCIPAL,
                                profileLoan = a.PROFILELOAN,
                                dischargeLetter = a.DISCHARGELETTER,
                                suspendInterest = a.SUSPENDINTEREST,
                                customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                createdBy = a.CREATEDBY,
                                dateTimeCreated = a.DATETIMECREATED,
                                isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                exchangeRate = a.EXCHANGERATE,
                                currencyId = a.CURRENCYID,
                                currency = a.TBL_CURRENCY.CURRENCYNAME,
                                loanReviewOperationTypeId = b.OPERATIONID,
                                reviewDetails = b.REVIEWDETAILS,
                                interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                pastDueInterest = a.PASTDUEINTEREST,
                                pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.TERMLOANID && x.DATE == applicationDate).Select(x => x.ACCRUEDINTEREST).FirstOrDefault(),  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                systemCurrentDate = applicationDate,
                                lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.TERMLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                {

                                    loanApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                    loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                    operationTypeId = op.OPERATIONTYPEID,
                                    operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                    newEffectiveDate = op.EFFECTIVEDATE,
                                    reviewDetails = op.REVIEWDETAILS,
                                    prepayment = op.PREPAYMENT,
                                    newInterateRate = op.INTERATERATE,
                                    newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                    newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                    newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                    newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newTenor = op.TENOR,
                                    cASA_AccountId = op.CASA_ACCOUNTID,
                                    cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                    overDraftTopup = op.OVERDRAFTTOPUP,
                                    fee_Charges = op.FEE_CHARGES,
                                    scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                    scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                    scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                    scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                    scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                    newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                    newMaturityDate = op.MATURITYDATE,
                                    dateTimeCreated = op.DATECREATED
                                }).FirstOrDefault()
                            }).ToList();

            var externalLoans = GetApprovedThirdPartyLoanReview(companyId, staffId);
            var data = allFilteredLoan.Union(externalLoans).Union(referred);

            return data.OrderBy(x => x.lmsdatecreated);
        }

        public IEnumerable<LoanViewModel> GetProcessLoanReviewData(int companyId, int staffId, string searchString)
        {
            var searchVar = searchString.Trim();
            searchString = searchString.Trim().ToLower();
            var dataLoanExternal = (from e in context.TBL_LMSR_APPLICATION
                            join b in context.TBL_LMSR_APPLICATION_DETAIL on e.LOANAPPLICATIONID equals b.LOANAPPLICATIONID
                            join c in context.TBL_CUSTOMER on b.CUSTOMERID equals c.CUSTOMERID
                            join a in context.TBL_LOAN_EXTERNAL on b.LOANID equals a.EXTERNALLOANID 
                            where 
                            b.OPERATIONPERFORMED == false
                            && e.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && (e.APPLICATIONREFERENCENUMBER.Trim() == searchVar
                            || c.FIRSTNAME.Trim().ToLower() == searchString
                            || c.MIDDLENAME.Trim().ToLower() == searchString
                            || c.LASTNAME.Trim().ToLower() == searchString)

                            select new LoanViewModel
                            {
                                creditAppraisalOperationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                          (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                          (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault(),


                                creditAppraisalLoanApplicationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                          (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                          (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault(),

                                tenorModeId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault() :
                                              (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault() :
                                              (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault(),
                                appraisalOperationId = e.OPERATIONID,
                                appraisalLoanApplicationId = e.LOANAPPLICATIONID,
                                synOperationId = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == b.OPERATIONID).Select(o => o.SYNCHOPERATIONID).FirstOrDefault(),
                                loanReviewApplicationId = b.LOANREVIEWAPPLICATIONID,
                                customerId = b.CUSTOMERID == null ? context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.CUSTOMERGROUPID).FirstOrDefault() : b.CUSTOMERID,
                                loanTypeId2 = e.LOANAPPLICATIONTYPEID,
                                customerType = e.LOANAPPLICATIONTYPEID == 1 ? "Single" : "Group",
                                currencyCode = context.TBL_CURRENCY.Where(x=>x.CURRENCYID == b.CURRENCYID).Select(x=>x.CURRENCYCODE).FirstOrDefault(), //a.TBL_CURRENCY.CURRENCYCODE,
                                interestRate = b.APPROVEDINTERESTRATE,
                                currencyId = (int)a.CURRENCYID,
                                effectiveDate = a.EFFECTIVEDATE,
                                maturityDate = a.MATURITYDATE,
                                systemCurrentDate = DateTime.Now,
                                loanId = a.EXTERNALLOANID,
                                productClassProcessId2 = e.PRODUCT_CLASS_PROCESSID,
                                productClassId = e.PRODUCTCLASSID,
                                loanSystemTypeId = b.LOANSYSTEMTYPEID,
                                customerCode = b.TBL_CUSTOMER.CUSTOMERCODE == null ? context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.GROUPCODE).FirstOrDefault() : b.TBL_CUSTOMER.CUSTOMERCODE,
                                customerName = b.TBL_CUSTOMER.FIRSTNAME + " " + b.TBL_CUSTOMER.LASTNAME,
                                customerGroupName = context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.GROUPNAME).FirstOrDefault(),
                                productId = b.PRODUCTID,
                                companyId = e.COMPANYID,
                                branchId = e.BRANCHID,
                                approvedInterestRate = b.APPROVEDINTERESTRATE,
                                sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                subSectorName = a.TBL_SUB_SECTOR.NAME,
                                subSectorId = a.TBL_SUB_SECTOR.SUBSECTORID,
                                sectorId = a.TBL_SUB_SECTOR.TBL_SECTOR.SECTORID,
                                reviewLoanDetaile = b.REVIEWDETAILS,
                                branchName = e.TBL_BRANCH.BRANCHNAME,
                                lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                applicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                productTypeId = b.TBL_PRODUCT.PRODUCTTYPEID,
                                approvedAmount = b.APPROVEDAMOUNT,
                                approvedTenor = b.APPROVEDTENOR,
                                productName = b.TBL_PRODUCT.PRODUCTNAME,
                                productTypeName = b.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                relationshipOfficerId = b.CREATEDBY,
                                relationshipOfficerName = context.TBL_STAFF.Where(a => a.STAFFID == b.CREATEDBY).Select(a => a.FIRSTNAME + " " + a.MIDDLENAME + " " + a.LASTNAME).FirstOrDefault(),
                                misCode = context.TBL_STAFF.Where(a => a.STAFFID == b.CREATEDBY).Select(a => a.MISCODE).FirstOrDefault(),
                                operationId = b.OPERATIONID,
                                operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == e.OPERATIONID).OPERATIONNAME,
                                operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.EXTERNALLOANID
                                && m.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                {
                                    loanApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                    loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                    operationTypeId = op.OPERATIONTYPEID,
                                    operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                    newEffectiveDate = op.EFFECTIVEDATE,
                                    reviewDetails = op.REVIEWDETAILS,
                                    prepayment = op.PREPAYMENT,
                                    newInterateRate = op.INTERATERATE,
                                    newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                    newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                    newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                    newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newTenor = op.TENOR,
                                    cASA_AccountId = op.CASA_ACCOUNTID,
                                    cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                    overDraftTopup = op.OVERDRAFTTOPUP,
                                    fee_Charges = op.FEE_CHARGES,
                                    scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                    scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                    scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                    scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                    scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                    newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                    newMaturityDate = op.MATURITYDATE,
                                    dateTimeCreated = op.DATECREATED,
                                }).FirstOrDefault(),
                            }).ToList();

            var dataLoan = (from e in context.TBL_LMSR_APPLICATION
                            join b in context.TBL_LMSR_APPLICATION_DETAIL on e.LOANAPPLICATIONID equals b.LOANAPPLICATIONID
                            join c in context.TBL_CUSTOMER on b.CUSTOMERID equals c.CUSTOMERID
                            join a in context.TBL_LOAN on b.LOANID equals a.TERMLOANID
                            where
                            b.OPERATIONPERFORMED == false
                            && e.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && (e.APPLICATIONREFERENCENUMBER.Trim() == searchVar
                            || c.FIRSTNAME.Trim().ToLower() == searchString
                            || c.MIDDLENAME.Trim().ToLower() == searchString
                            || c.LASTNAME.Trim().ToLower() == searchString)

                            select new LoanViewModel
                            {
                                creditAppraisalOperationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                          (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                          (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault(),


                                creditAppraisalLoanApplicationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                          (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                          (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault(),

                                tenorModeId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault() :
                                              (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault() :
                                              (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault(),
                                appraisalOperationId = e.OPERATIONID,
                                appraisalLoanApplicationId = e.LOANAPPLICATIONID,
                                synOperationId = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == b.OPERATIONID).Select(o => o.SYNCHOPERATIONID).FirstOrDefault(),
                                loanReviewApplicationId = b.LOANREVIEWAPPLICATIONID,
                                customerId = b.CUSTOMERID == 0 ? context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.CUSTOMERGROUPID).FirstOrDefault() : b.CUSTOMERID,
                                loanTypeId2 = e.LOANAPPLICATIONTYPEID,
                                customerType = e.LOANAPPLICATIONTYPEID == 1 ? "Single" : "Group",
                                currencyCode = context.TBL_CURRENCY.Where(x => x.CURRENCYID == b.CURRENCYID).Select(x => x.CURRENCYCODE).FirstOrDefault(), //a.TBL_CURRENCY.CURRENCYCODE,
                                interestRate = b.APPROVEDINTERESTRATE,
                                currencyId = (int)a.CURRENCYID,
                                effectiveDate = a.EFFECTIVEDATE,
                                maturityDate = a.MATURITYDATE,
                                systemCurrentDate = DateTime.Now,
                                loanId = a.TERMLOANID,
                                productClassProcessId2 = e.PRODUCT_CLASS_PROCESSID,
                                productClassId = e.PRODUCTCLASSID,
                                loanSystemTypeId = b.LOANSYSTEMTYPEID,
                                customerCode = b.TBL_CUSTOMER.CUSTOMERCODE == null ? context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.GROUPCODE).FirstOrDefault() : b.TBL_CUSTOMER.CUSTOMERCODE,
                                customerName = b.TBL_CUSTOMER.FIRSTNAME + " " + b.TBL_CUSTOMER.LASTNAME,
                                customerGroupName = context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.GROUPNAME).FirstOrDefault(),
                                productId = b.PRODUCTID,
                                companyId = e.COMPANYID,
                                branchId = e.BRANCHID,
                                approvedInterestRate = b.APPROVEDINTERESTRATE,
                                sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                subSectorName = a.TBL_SUB_SECTOR.NAME,
                                subSectorId = a.TBL_SUB_SECTOR.SUBSECTORID,
                                sectorId = a.TBL_SUB_SECTOR.TBL_SECTOR.SECTORID,
                                reviewLoanDetaile = b.REVIEWDETAILS,
                                branchName = e.TBL_BRANCH.BRANCHNAME,
                                lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                applicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                productTypeId = b.TBL_PRODUCT.PRODUCTTYPEID,
                                approvedAmount = b.APPROVEDAMOUNT,
                                approvedTenor = b.APPROVEDTENOR,
                                productName = b.TBL_PRODUCT.PRODUCTNAME,
                                productTypeName = b.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                relationshipOfficerId = b.CREATEDBY,
                                relationshipOfficerName = context.TBL_STAFF.Where(a => a.STAFFID == b.CREATEDBY).Select(a => a.FIRSTNAME + " " + a.MIDDLENAME + " " + a.LASTNAME).FirstOrDefault(),
                                misCode = context.TBL_STAFF.Where(a => a.STAFFID == b.CREATEDBY).Select(a => a.MISCODE).FirstOrDefault(),
                                operationId = b.OPERATIONID,
                                operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == e.OPERATIONID).OPERATIONNAME,
                                operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.TERMLOANID
                                && m.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                {
                                    loanApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                    loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                    operationTypeId = op.OPERATIONTYPEID,
                                    operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                    newEffectiveDate = op.EFFECTIVEDATE,
                                    reviewDetails = op.REVIEWDETAILS,
                                    prepayment = op.PREPAYMENT,
                                    newInterateRate = op.INTERATERATE,
                                    newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                    newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                    newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                    newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newTenor = op.TENOR,
                                    cASA_AccountId = op.CASA_ACCOUNTID,
                                    cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                    overDraftTopup = op.OVERDRAFTTOPUP,
                                    fee_Charges = op.FEE_CHARGES,
                                    scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                    scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                    scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                    scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                    scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                    newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                    newMaturityDate = op.MATURITYDATE,
                                    dateTimeCreated = op.DATECREATED,
                                }).FirstOrDefault(),
                            }).ToList();

            var dataRevolving = (from e in context.TBL_LMSR_APPLICATION
                                 join b in context.TBL_LMSR_APPLICATION_DETAIL on e.LOANAPPLICATIONID equals b.LOANAPPLICATIONID
                                 join c in context.TBL_CUSTOMER on b.CUSTOMERID equals c.CUSTOMERID
                                 join a in context.TBL_LOAN_REVOLVING on b.LOANID equals a.REVOLVINGLOANID 
                                 where 
                                 b.OPERATIONPERFORMED == false
                                 && e.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                 && (e.APPLICATIONREFERENCENUMBER.Trim() == searchVar
                                 || c.FIRSTNAME.Trim().ToLower() == searchString
                                 || c.MIDDLENAME.Trim().ToLower() == searchString
                                 || c.LASTNAME.Trim().ToLower() == searchString)

                                 select new LoanViewModel
                                 {
                                     creditAppraisalOperationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                                   (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                                   (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault(),


                                     creditAppraisalLoanApplicationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                                   (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                                   (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault(),

                                     tenorModeId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault() :
                                                          (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault() :
                                                          (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault(),
                                     appraisalOperationId = e.OPERATIONID,
                                     appraisalLoanApplicationId = e.LOANAPPLICATIONID,
                                     synOperationId = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == b.OPERATIONID).Select(o => o.SYNCHOPERATIONID).FirstOrDefault(),
                                     loanReviewApplicationId = b.LOANREVIEWAPPLICATIONID,
                                     customerId = b.CUSTOMERID == 0 ? context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.CUSTOMERGROUPID).FirstOrDefault() : b.CUSTOMERID,
                                     customerCode = b.TBL_CUSTOMER.CUSTOMERCODE == null ? context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.GROUPCODE).FirstOrDefault() : b.TBL_CUSTOMER.CUSTOMERCODE,
                                     customerName = b.TBL_CUSTOMER.FIRSTNAME + " " + b.TBL_CUSTOMER.LASTNAME,
                                     customerGroupName = context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.GROUPNAME).FirstOrDefault(),
                                     productId = b.PRODUCTID,
                                     companyId = e.COMPANYID,
                                     productClassProcessId2 = e.PRODUCT_CLASS_PROCESSID,
                                     loanTypeId2 = e.LOANAPPLICATIONTYPEID,
                                     branchId = e.BRANCHID,
                                     customerType = e.LOANAPPLICATIONTYPEID == 1 ? "Single" : "Group",
                                     currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                     interestRate = b.APPROVEDINTERESTRATE,
                                     effectiveDate = a.EFFECTIVEDATE,
                                     systemCurrentDate = DateTime.Now,
                                     subSectorId = a.TBL_SUB_SECTOR.SUBSECTORID,
                                     sectorId = a.TBL_SUB_SECTOR.TBL_SECTOR.SECTORID,
                                     productClassId = e.PRODUCTCLASSID,
                                     approvedInterestRate = b.APPROVEDINTERESTRATE,
                                     loanId = a.REVOLVINGLOANID,
                                     loanSystemTypeId = b.LOANSYSTEMTYPEID,
                                     reviewLoanDetaile = b.REVIEWDETAILS,
                                     branchName = e.TBL_BRANCH.BRANCHNAME,
                                     lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                     applicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                     productTypeId = b.TBL_PRODUCT.PRODUCTTYPEID,
                                     approvedAmount = b.APPROVEDAMOUNT,
                                     approvedTenor = b.APPROVEDTENOR,
                                     sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                     subSectorName = a.TBL_SUB_SECTOR.NAME,
                                     productName = b.TBL_PRODUCT.PRODUCTNAME,
                                     productTypeName = b.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                     relationshipOfficerId = b.CREATEDBY,
                                     relationshipOfficerName = context.TBL_STAFF.Where(a => a.STAFFID == b.CREATEDBY).Select(a => a.FIRSTNAME + " " + a.MIDDLENAME + " " + a.LASTNAME).FirstOrDefault(),
                                     misCode = context.TBL_STAFF.Where(a => a.STAFFID == b.CREATEDBY).Select(a => a.MISCODE).FirstOrDefault(),
                                     operationId = b.OPERATIONID,
                                     operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == e.OPERATIONID).OPERATIONNAME,
                                     operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.REVOLVINGLOANID
                                     && m.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved && m.OPERATIONCOMPLETED == false
                                     ).Select(op => new LoanReviewOperationApprovalViewModel
                                     {

                                         loanApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                         loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                         operationTypeId = op.OPERATIONTYPEID,
                                         operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                         newEffectiveDate = op.EFFECTIVEDATE,
                                         reviewDetails = op.REVIEWDETAILS,
                                         prepayment = op.PREPAYMENT,
                                         newInterateRate = op.INTERATERATE,
                                         newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                         newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                         newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                         newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                         newTenor = op.TENOR,
                                         cASA_AccountId = op.CASA_ACCOUNTID,
                                         cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                         overDraftTopup = op.OVERDRAFTTOPUP,
                                         fee_Charges = op.FEE_CHARGES,
                                         scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                         scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                         scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                         scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                         scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                         newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                         newMaturityDate = op.MATURITYDATE,
                                         dateTimeCreated = op.DATECREATED
                                     }).FirstOrDefault(),
                                 }).ToList();

            var dataContingent = (from e in context.TBL_LMSR_APPLICATION
                                  join b in context.TBL_LMSR_APPLICATION_DETAIL on e.LOANAPPLICATIONID equals b.LOANAPPLICATIONID
                                  join c in context.TBL_CUSTOMER on b.CUSTOMERID equals c.CUSTOMERID
                                  join a in context.TBL_LOAN_CONTINGENT on b.LOANID equals a.CONTINGENTLOANID 
                                  where 
                                  b.OPERATIONPERFORMED == false
                                  && e.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                  && (e.APPLICATIONREFERENCENUMBER.Trim() == searchVar
                                  || c.FIRSTNAME.Trim().ToLower() == searchString
                                  || c.MIDDLENAME.Trim().ToLower() == searchString
                                  || c.LASTNAME.Trim().ToLower() == searchString)

                                  select new LoanViewModel
                                  {
                                      creditAppraisalOperationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                                    (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault() :
                                                    (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.OPERATIONID).FirstOrDefault(),


                                      creditAppraisalLoanApplicationId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                                    (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault() :
                                                    (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select aa.LOANAPPLICATIONID).FirstOrDefault(),

                                      tenorModeId = (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.TermDisbursedFacility) ? (from p in context.TBL_LOAN join c in context.TBL_LMSR_APPLICATION_DETAIL on p.TERMLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault() :
                                                          (b.LOANSYSTEMTYPEID == (int)LoanSystemTypeEnum.ContingentLiability) ? (from p in context.TBL_LOAN_CONTINGENT join c in context.TBL_LMSR_APPLICATION_DETAIL on p.CONTINGENTLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault() :
                                                          (from p in context.TBL_LOAN_REVOLVING join c in context.TBL_LMSR_APPLICATION_DETAIL on p.REVOLVINGLOANID equals c.LOANID join l in context.TBL_LOAN_APPLICATION_DETAIL on p.LOANAPPLICATIONDETAILID equals l.LOANAPPLICATIONDETAILID join aa in context.TBL_LOAN_APPLICATION on l.LOANAPPLICATIONID equals aa.LOANAPPLICATIONID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select l.TENORFREQUENCYTYPEID).FirstOrDefault(),
                                      appraisalOperationId = e.OPERATIONID,
                                      appraisalLoanApplicationId = e.LOANAPPLICATIONID,
                                      synOperationId = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == b.OPERATIONID).Select(o => o.SYNCHOPERATIONID).FirstOrDefault(),
                                      loanReviewApplicationId = b.LOANREVIEWAPPLICATIONID,
                                      customerId = b.CUSTOMERID == null ? context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.CUSTOMERGROUPID).FirstOrDefault() : b.CUSTOMERID,
                                      customerCode = b.TBL_CUSTOMER.CUSTOMERCODE == null ? context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.GROUPCODE).FirstOrDefault() : b.TBL_CUSTOMER.CUSTOMERCODE,
                                      customerName = b.TBL_CUSTOMER.FIRSTNAME + " " + b.TBL_CUSTOMER.LASTNAME,
                                      customerGroupName = context.TBL_CUSTOMER_GROUP.Where(c => c.CUSTOMERGROUPID == e.CUSTOMERGROUPID).Select(c => c.GROUPNAME).FirstOrDefault(),
                                      productId = b.PRODUCTID,
                                      companyId = e.COMPANYID,
                                      branchId = e.BRANCHID,
                                      customerType = e.LOANAPPLICATIONTYPEID == 1 ? "Single" : "Group",
                                      currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                      interestRate = b.APPROVEDINTERESTRATE,
                                      effectiveDate = a.EFFECTIVEDATE,
                                      systemCurrentDate = DateTime.Now,
                                      productClassProcessId2 = e.PRODUCT_CLASS_PROCESSID,
                                      loanTypeId2 = e.LOANAPPLICATIONTYPEID,
                                      productClassId = e.PRODUCTCLASSID,
                                      loanId = a.CONTINGENTLOANID,
                                      subSectorId = a.TBL_SUB_SECTOR.SUBSECTORID,
                                      sectorId = a.TBL_SUB_SECTOR.TBL_SECTOR.SECTORID,
                                      loanSystemTypeId = b.LOANSYSTEMTYPEID,
                                      sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                      subSectorName = a.TBL_SUB_SECTOR.NAME,
                                      reviewLoanDetaile = b.REVIEWDETAILS,
                                      branchName = e.TBL_BRANCH.BRANCHNAME,
                                      lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                      applicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                      productTypeId = b.TBL_PRODUCT.PRODUCTTYPEID,
                                      approvedAmount = b.APPROVEDAMOUNT,
                                      approvedTenor = b.APPROVEDTENOR,
                                      approvedInterestRate = b.APPROVEDINTERESTRATE,
                                      productName = b.TBL_PRODUCT.PRODUCTNAME,
                                      productTypeName = b.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                      relationshipOfficerId = b.CREATEDBY,
                                      relationshipOfficerName = context.TBL_STAFF.Where(a => a.STAFFID == b.CREATEDBY).Select(a => a.FIRSTNAME + " " + a.MIDDLENAME + " " + a.LASTNAME).FirstOrDefault(),
                                      misCode = context.TBL_STAFF.Where(a => a.STAFFID == b.CREATEDBY).Select(a => a.MISCODE).FirstOrDefault(),
                                      operationId = b.OPERATIONID,
                                      operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == e.OPERATIONID).OPERATIONNAME,
                                      operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.CONTINGENTLOANID
                                      && m.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved && m.OPERATIONCOMPLETED == false
                                      ).Select(op => new LoanReviewOperationApprovalViewModel
                                      {

                                          loanApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                          loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                          operationTypeId = op.OPERATIONTYPEID,
                                          operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                          newEffectiveDate = op.EFFECTIVEDATE,
                                          reviewDetails = op.REVIEWDETAILS,
                                          prepayment = op.PREPAYMENT,
                                          newInterateRate = op.INTERATERATE,
                                          newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                          newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                          newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                          newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                          newTenor = op.TENOR,
                                          cASA_AccountId = op.CASA_ACCOUNTID,
                                          cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                          overDraftTopup = op.OVERDRAFTTOPUP,
                                          fee_Charges = op.FEE_CHARGES,
                                          scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                          scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                          scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                          scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                          scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                          newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                          newMaturityDate = op.MATURITYDATE,
                                          dateTimeCreated = op.DATECREATED
                                      }).FirstOrDefault(),

                                  }).ToList();

            var data = dataLoan.Union(dataRevolving).Union(dataContingent).Union(dataLoanExternal);

            return data.GroupBy(r => r.applicationReferenceNumber)
                               .Select(p => p.OrderByDescending(r => r.applicationReferenceNumber).FirstOrDefault()).ToList();
        }

        public WorkflowResponse ApproveLMSFacilityModification(ForwardViewModel model)
        {
                using (var trans = context.Database.BeginTransaction())
                {
                    bool saved;
                    var modification = context.TBL_LMS_FACILITY_MODIFICATION.Find(model.targetId);
                    if (modification == null)
                    {
                        throw new SecureException("Facility Modification doesn't exist!");
                    }
                    workflow.OperationId = (int)OperationsEnum.LMSFacilityModificationApproval;
                    workflow.StaffId = model.createdBy;
                    workflow.TargetId = model.targetId;
                    workflow.CompanyId = model.companyId;
                    workflow.Vote = 2;
                    workflow.StatusId = model.forwardAction;
                    workflow.Comment = model.comment;
                    workflow.DeferredExecution = true;
                    workflow.LogActivity();
                    saved = context.SaveChanges() > 0;
                    if (workflow.NewState == (int)ApprovalState.Ended)
                    {
                        if (workflow.StatusId == (int)ApprovalStatusEnum.Approved)
                        {
                            modification.APPROVALSTATUSID = (int)workflow.StatusId;
                            var modified = ModifyLMSFacility(modification);
                            context.SaveChanges();
                    }
                        else
                        {
                            modification.APPROVALSTATUSID = (int)workflow.StatusId;
                            context.SaveChanges();
                     }
                    }
                    
                    if (saved)
                    {
                        trans.Commit();
                    }
                    else
                    {
                        trans.Rollback();
                    }
                }
                return workflow.Response;
            }


        public WorkflowResponse AddFacilityModification(FacilityModificationViewModel model)
        {
                using (var trans = context.Database.BeginTransaction())
                {
                    model.productClassProcessId2 = context.TBL_PRODUCT_CLASS.Find(model.productClassId).PRODUCT_CLASS_PROCESSID;
                    var entity = new TBL_LMS_FACILITY_MODIFICATION
                    {
                        LOANAPPLICATIONDETAILID = model.loanApplicationDetailId,
                        PRODUCTCLASSPROCESSID = model.productClassProcessId2,
                        APPROVEDPRODUCTID = model.approvedProductId,
                        APPROVEDINTERESTRATE = model.approvedInterestRate,
                        APPROVEDTENOR = model.approvedTenor,
                        TENORMODEID = model.tenorModeId,
                        SUBSECTORID = model.subSectorId,
                        PRODUCTCLASSID = model.productClassId,
                        APPROVEDAMOUNT = model.approvedAmount,
                        APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                        CREATEDBY = model.createdBy,
                        DATETIMECREATED = DateTime.Now,
                        REVIEWDETAILS = model.reviewDetails
                    };

                    var save = context.TBL_LMS_FACILITY_MODIFICATION.Add(entity);
                    context.SaveChanges();

                    workflow.OperationId = (int)OperationsEnum.LMSFacilityModificationApproval;
                    workflow.StaffId = model.createdBy;
                    workflow.TargetId = entity.FACILITYMODIFICATIONID;
                    workflow.CompanyId = model.companyId;
                    workflow.Vote = 2;
                    workflow.StatusId = 1;
                    workflow.Comment = "Kindly approve this lms facility modification";
                    workflow.DeferredExecution = true;
                    workflow.LogActivity();
                    var saved = context.SaveChanges() > 0;
                    if (saved)
                    {
                        trans.Commit();
                        return workflow.Response;
                    }
                    trans.Rollback();
                    return workflow.Response;
                }
        }

        public FacilityModificationViewModel GetLMSFacilityModification(int facilityModificationId)
        {
            var entity = context.TBL_LMS_FACILITY_MODIFICATION.FirstOrDefault(x => x.FACILITYMODIFICATIONID == facilityModificationId);

            return new FacilityModificationViewModel
            {
                facilityModificationId = entity.FACILITYMODIFICATIONID,
                loanApplicationDetailId = entity.LOANAPPLICATIONDETAILID,
                approvedProductId = entity.APPROVEDPRODUCTID,
                approvedInterestRate = entity.APPROVEDINTERESTRATE,
                approvedTenor = entity.APPROVEDTENOR,
                tenorModeId = entity.TENORMODEID,
                sectorId = (int)context.TBL_SUB_SECTOR.FirstOrDefault(s => s.SUBSECTORID == entity.SUBSECTORID).SECTORID,
                subSectorId = entity.SUBSECTORID,
                productClassId = entity.PRODUCTCLASSID,
                approvedAmount = entity.APPROVEDAMOUNT,
            };
        }

        public IEnumerable<FacilityModificationViewModel> GetLMSFacilityModificationsForApproval(int staffId)
        {
            var operationId = (int)OperationsEnum.LMSFacilityModificationApproval;
            var levelIds = generalSetup.GetStaffApprovalLevelIds(staffId, operationId).ToList();
            var reliefIds = generalSetup.GetStaffRlieved(staffId);

            var modifications = (from x in context.TBL_LMS_FACILITY_MODIFICATION
                                 join d in context.TBL_LMSR_APPLICATION_DETAIL on x.LOANAPPLICATIONDETAILID equals d.LOANREVIEWAPPLICATIONID
                                 join c in context.TBL_CUSTOMER on d.CUSTOMERID equals c.CUSTOMERID
                                 join t in context.TBL_APPROVAL_TRAIL on x.FACILITYMODIFICATIONID equals t.TARGETID
                                 where
                                 t.OPERATIONID == operationId
                                 && levelIds.Contains(t.TOAPPROVALLEVELID ?? 0)
                                 && t.RESPONSESTAFFID == null
                                 && t.APPROVALSTATEID != (int)ApprovalState.Ended
                                 && (reliefIds.Contains(t.TOSTAFFID ?? 0) || t.TOSTAFFID == null)
                                 select new FacilityModificationViewModel
                                 {
                                     facilityModificationId = x.FACILITYMODIFICATIONID,
                                     loanApplicationDetailId = x.LOANAPPLICATIONDETAILID,
                                     approvedProductId = x.APPROVEDPRODUCTID,
                                     approvedInterestRate = x.APPROVEDINTERESTRATE,
                                     approvedTenor = x.APPROVEDTENOR,
                                     tenorModeId = x.TENORMODEID,
                                     reviewDetails = x.REVIEWDETAILS,
                                     sectorId = (int)context.TBL_SUB_SECTOR.FirstOrDefault(s => s.SUBSECTORID == x.SUBSECTORID).SECTORID,
                                     subSectorId = x.SUBSECTORID,
                                     productClassId = x.PRODUCTCLASSID,
                                     productClassProcessId2 = x.PRODUCTCLASSPROCESSID,
                                     approvedAmount = x.APPROVEDAMOUNT,
                                     customerName = c.FIRSTNAME + " " + c.MIDDLENAME + " " + c.LASTNAME,
                                     applicationRef = d.TBL_LMSR_APPLICATION.APPLICATIONREFERENCENUMBER,
                                     systemArrivalDateTime = t.SYSTEMARRIVALDATETIME,
                                     approvalStatus = context.TBL_APPROVAL_STATUS.FirstOrDefault(s => s.APPROVALSTATUSID == t.APPROVALSTATUSID).APPROVALSTATUSNAME,
                                 }).ToList();
            return modifications;
        }

        public bool ArchiveLMSLoanApplication(int loanAppliactionId, int operationId, int applicationStatus, int archivedBy)
        {
            int applicationStatusId = 0;
            var app = context.TBL_LMSR_APPLICATION.FirstOrDefault(l => l.LOANAPPLICATIONID == loanAppliactionId);
            if (app == null)
            {
                throw new SecureException("Loan Application doesn't exist!");
            }

            if (applicationStatus == 0)
            {
                applicationStatusId = app.APPLICATIONSTATUSID;
            }
            else
            {
                applicationStatusId = applicationStatus;
            }

            var apps = context.TBL_LMSR_APPLICATION_ARCHIVE.FirstOrDefault(l => l.LOANAPPLICATIONID == loanAppliactionId);
            if (apps != null)
            {
                throw new SecureException("Loan Application already modified!");
            }

            var details = app.TBL_LMSR_APPLICATION_DETAIL.ToList();
            TBL_LMSR_APPLICATION_ARCHIVE loanApplArchive = new TBL_LMSR_APPLICATION_ARCHIVE();
            loanApplArchive.LOANAPPLICATIONID = app.LOANAPPLICATIONID;
            loanApplArchive.APPLICATIONREFERENCENUMBER = app.APPLICATIONREFERENCENUMBER;
            loanApplArchive.RELATEDREFERENCENUMBER = app.RELATEDREFERENCENUMBER;
            loanApplArchive.COMPANYID = app.COMPANYID;
            loanApplArchive.CUSTOMERID = app.CUSTOMERID;
            loanApplArchive.BRANCHID = app.BRANCHID;
            loanApplArchive.CUSTOMERGROUPID = app.CUSTOMERGROUPID;
            loanApplArchive.APPLICATIONDATE = app.APPLICATIONDATE;
            loanApplArchive.CREATEDBY = app.CREATEDBY;
            loanApplArchive.DATETIMECREATED = app.DATETIMECREATED;
            loanApplArchive.LASTUPDATEDBY = app.LASTUPDATEDBY;
            loanApplArchive.DATETIMEUPDATED = app.DATETIMEUPDATED;
            loanApplArchive.DELETED = app.DELETED;
            loanApplArchive.DELETEDBY = app.DELETEDBY;
            loanApplArchive.DATETIMEDELETED = app.DATETIMEDELETED;
            loanApplArchive.SYSTEMDATETIME = app.SYSTEMDATETIME;
            loanApplArchive.APPROVALSTATUSID = app.APPROVALSTATUSID;
            loanApplArchive.APPLICATIONSTATUSID = (short)applicationStatusId;
            loanApplArchive.FINALAPPROVAL_LEVELID = app.FINALAPPROVAL_LEVELID;
            loanApplArchive.NEXTAPPLICATIONSTATUSID = app.NEXTAPPLICATIONSTATUSID;
            loanApplArchive.APPROVEDDATE = app.APPROVEDDATE;
            loanApplArchive.AVAILMENTDATE = app.AVAILMENTDATE;
            loanApplArchive.DISPUTED = app.DISPUTED;
            loanApplArchive.REQUIRECOLLATERAL = app.REQUIRECOLLATERAL;
            loanApplArchive.CAPREGIONID = app.CAPREGIONID;
            loanApplArchive.OPERATIONID = app.OPERATIONID;
            loanApplArchive.RISKRATINGID = app.RISKRATINGID;
            loanApplArchive.PRODUCTCLASSID = app.PRODUCTCLASSID;
            loanApplArchive.PRODUCTID = app.PRODUCTID;
            loanApplArchive.LOANAPPLICATIONTYPEID = app.LOANAPPLICATIONTYPEID;
            loanApplArchive.PRODUCT_CLASS_PROCESSID = app.PRODUCT_CLASS_PROCESSID;
            loanApplArchive.APPROVEDAMOUNT = app.APPROVEDAMOUNT;
            loanApplArchive.ISPROJECTRELATED = app.ISPROJECTRELATED;
            loanApplArchive.ISONLENDING = app.ISONLENDING;
            loanApplArchive.ISINTERVENTIONFUNDS = app.ISINTERVENTIONFUNDS;
            loanApplArchive.WITHINSTRUCTION = app.WITHINSTRUCTION;
            loanApplArchive.DOMICILIATIONNOTINPLACE = app.DOMICILIATIONNOTINPLACE;
            loanApplArchive.ARCHIVEDATE = DateTime.Now;
            loanApplArchive.OWNEDBY = archivedBy;
            context.TBL_LMSR_APPLICATION_ARCHIVE.Add(loanApplArchive);
            foreach (var f in details)
            {
                ArchiveLMSLoanApplicationDetails(f.LOANREVIEWAPPLICATIONID);
            }
            return context.SaveChanges() != 0;
        }

        public void ArchiveLMSLoanApplicationDetails(int loanApplicationDetailId)
        {
            var detailRow = context.TBL_LMSR_APPLICATION_DETAIL.Find(loanApplicationDetailId);
            if (detailRow == null)
            {
                throw new SecureException("Facility doesn't exist!");
            }

            var apps = context.TBL_LMSR_APPLICATION_DETL_ARCH.FirstOrDefault(l => l.LOANREVIEWAPPLICATIONID == loanApplicationDetailId);
            if (apps != null)
            {
                throw new SecureException("Loan Application Detail already modified!");
            }

            TBL_LMSR_APPLICATION_DETL_ARCH addLoanApplDetailsArchive = new TBL_LMSR_APPLICATION_DETL_ARCH();
            addLoanApplDetailsArchive.LOANREVIEWAPPLICATIONID = detailRow.LOANREVIEWAPPLICATIONID;
            addLoanApplDetailsArchive.LOANID = detailRow.LOANID;
            addLoanApplDetailsArchive.OPERATIONID = detailRow.OPERATIONID;
            addLoanApplDetailsArchive.CUSTOMERID = detailRow.CUSTOMERID;
            addLoanApplDetailsArchive.REPAYMENTTERMS = detailRow.REPAYMENTTERMS;
            addLoanApplDetailsArchive.REPAYMENTSCHEDULEID = detailRow.REPAYMENTSCHEDULEID;
            addLoanApplDetailsArchive.REVIEWDETAILS = detailRow.REVIEWDETAILS;
            addLoanApplDetailsArchive.REVIEWSTAGEID = detailRow.REVIEWSTAGEID;
            addLoanApplDetailsArchive.APPROVALSTATUSID = detailRow.APPROVALSTATUSID;
            addLoanApplDetailsArchive.CREATEDBY = detailRow.CREATEDBY;
            addLoanApplDetailsArchive.DATETIMECREATED = detailRow.DATETIMECREATED;
            addLoanApplDetailsArchive.LOANAPPLICATIONID = detailRow.LOANAPPLICATIONID;
            addLoanApplDetailsArchive.LOANSYSTEMTYPEID = detailRow.LOANSYSTEMTYPEID;
            addLoanApplDetailsArchive.PRODUCTID = detailRow.PRODUCTID;
            addLoanApplDetailsArchive.PROPOSEDAMOUNT = detailRow.PROPOSEDAMOUNT;
            addLoanApplDetailsArchive.PROPOSEDTENOR = detailRow.PROPOSEDTENOR;
            addLoanApplDetailsArchive.PROPOSEDINTERESTRATE = detailRow.PROPOSEDINTERESTRATE;
            addLoanApplDetailsArchive.APPROVEDAMOUNT = detailRow.APPROVEDAMOUNT;
            addLoanApplDetailsArchive.APPROVEDTENOR = detailRow.APPROVEDTENOR;
            addLoanApplDetailsArchive.APPROVEDINTERESTRATE = detailRow.APPROVEDINTERESTRATE;
            addLoanApplDetailsArchive.OPERATIONPERFORMED = detailRow.OPERATIONPERFORMED;
            addLoanApplDetailsArchive.CUSTOMERPROPOSEDAMOUNT = detailRow.CUSTOMERPROPOSEDAMOUNT;
            addLoanApplDetailsArchive.MANAGEMENTPOSITION = detailRow.MANAGEMENTPOSITION;
            addLoanApplDetailsArchive.DELETED = detailRow.DELETED;
            addLoanApplDetailsArchive.CURRENCYID = detailRow.CURRENCYID;
            addLoanApplDetailsArchive.ARCHIVEDATE = DateTime.Today;
            this.context.TBL_LMSR_APPLICATION_DETL_ARCH.Add(addLoanApplDetailsArchive);
        }

        private int ConvertTenorToDays(int proposedTenor, int? tenorModeId = 1)
        {
            int tenor = 0;
            switch (tenorModeId) // UPDATED
            {
                case (int)TenorMode.Daily: tenor = proposedTenor; break;
                case (int)TenorMode.Monthly: tenor = proposedTenor * 30; break;
                case (int)TenorMode.Yearly: tenor = proposedTenor * 365; break;
            }
            return tenor;
        }

        private IEnumerable<LoanViewModel> GetApprovedThirdPartyLoanReview(int companyId, int staffId)
        {
            List<short> productTypes = new List<short>();
            var applicationDate = generalSetup.GetApplicationDate();
            UserCurrencyViewFilter cf = GetUserCurrencyViewFilter(companyId, staffId);
            var staffs = generalSetup.GetStaffRlieved(staffId);

            var allFilteredLoan = (from a in context.TBL_LOAN_EXTERNAL
                                   join b in context.TBL_LMSR_APPLICATION_DETAIL on a.EXTERNALLOANID equals b.LOANID
                                   join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                   join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                   where a.ISDISBURSED == true
                                  && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                  && b.OPERATIONPERFORMED == false
                                  && b.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.ExternalFacility
                                  //&& a.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.CommercialLoan
                                  //&& a.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.ContingentLiability
                                  //&& a.TBL_PRODUCT.PRODUCTTYPEID != (short)LoanProductTypeEnum.RevolvingLoan
                                  && ((cf.CanSeeLocalCurrency && a.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && a.CURRENCYID != cf.DefaultCurrencyId))
                                   select new LoanViewModel
                                   {
                                       lmsdatecreated = b.DATETIMECREATED,
                                       creditAppraisalOperationId = (from p in context.TBL_LOAN_EXTERNAL join c in context.TBL_LMSR_APPLICATION_DETAIL on p.EXTERNALLOANID equals c.LOANID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),
                                       creditAppraisalLoanApplicationId = 0,
                                       appraisalOperationId = e.OPERATIONID,
                                       appraisalLoanApplicationId = e.LOANAPPLICATIONID,
                                       synOperationId = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == b.OPERATIONID).Select(o => o.SYNCHOPERATIONID).FirstOrDefault(),
                                       loanReviewApplicationId = e.LOANAPPLICATIONID,
                                       loanId = a.EXTERNALLOANID,
                                       customerId = a.CUSTOMERID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                       productId = a.PRODUCTID,
                                       companyId = a.COMPANYID,
                                       casaAccountId = a.CASAACCOUNTID,
                                       branchId = a.BRANCHID,
                                       reviewLoanDetaile = b.REVIEWDETAILS,
                                       branchName = a.TBL_BRANCH.BRANCHNAME,
                                       divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                       applicationReferenceNumber = "N/A", //a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                       principalFrequencyTypeName = (from f in context.TBL_FREQUENCY_TYPE where f.FREQUENCYTYPEID == a.PRINCIPALFREQUENCYTYPEID select f.MODE).FirstOrDefault(),
                                       interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                       interestFrequencyTypeName = (from f in context.TBL_FREQUENCY_TYPE where f.FREQUENCYTYPEID == a.INTERESTFREQUENCYTYPEID select f.MODE).FirstOrDefault(),
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                       principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                       interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                       relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                       relationshipOfficerName = (from s in context.TBL_STAFF where s.STAFFID == a.RELATIONSHIPOFFICERID select s.FIRSTNAME).FirstOrDefault(),
                                       relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                       relationshipManagerName = (from s in context.TBL_STAFF where s.STAFFID == a.RELATIONSHIPOFFICERID select s.FIRSTNAME).FirstOrDefault(),
                                       misCode = a.MISCODE,
                                       teamMiscode = a.TEAMMISCODE,
                                       interestRate = a.INTERESTRATE,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       bookingDate = a.BOOKINGDATE,
                                       principalAmount = a.PRINCIPALAMOUNT,
                                       principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                       interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                       approvalStatusId = a.APPROVALSTATUSID,
                                       approvedBy = a.APPROVEDBY,
                                       approverComment = a.APPROVERCOMMENT,
                                       dateApproved = a.DATEAPPROVED,
                                       loanStatusId = a.LOANSTATUSID,
                                       scheduleTypeId = a.SCHEDULETYPEID,
                                       scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                       isDisbursed = a.ISDISBURSED,
                                       disbursedBy = a.DISBURSEDBY,
                                       disburserComment = a.DISBURSERCOMMENT,
                                       disburseDate = a.DISBURSEDATE,
                                       loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                       operationId = b.OPERATIONID,
                                       operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == e.OPERATIONID).OPERATIONNAME,
                                       subSectorName = a.TBL_SUB_SECTOR.NAME,
                                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                       casaAccountNumber = (from c in context.TBL_CASA where c.CASAACCOUNTID == a.CASAACCOUNTID select c.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                       productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                       loanTypeName = "Third-Party Facility",
                                       equityContribution = a.EQUITYCONTRIBUTION,
                                       firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                       firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                       outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                       outstandingInterest = a.OUTSTANDINGINTEREST,
                                       principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                       principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                       fixedPrincipal = a.FIXEDPRINCIPAL,
                                       profileLoan = a.PROFILELOAN,
                                       dischargeLetter = a.DISCHARGELETTER,
                                       suspendInterest = a.SUSPENDINTEREST,
                                       customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                       createdBy = a.CREATEDBY,
                                       dateTimeCreated = a.DATETIMECREATED,
                                       isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.EXTERNALLOANID).Any(),
                                       exchangeRate = a.EXCHANGERATE,
                                       currencyId = a.CURRENCYID,
                                       currency = a.TBL_CURRENCY.CURRENCYNAME,
                                       loanReviewOperationTypeId = b.OPERATIONID,
                                       reviewDetails = b.REVIEWDETAILS,
                                       interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                       interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                       pastDueInterest = a.PASTDUEINTEREST,
                                       pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                       accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.EXTERNALLOANID && x.DATE == applicationDate).Select(x => x.ACCRUEDINTEREST).FirstOrDefault(),  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                       systemCurrentDate = applicationDate,
                                       lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                       operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.EXTERNALLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                       {

                                           loanApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                           loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                           operationTypeId = op.OPERATIONTYPEID,
                                           operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                           newEffectiveDate = op.EFFECTIVEDATE,
                                           reviewDetails = op.REVIEWDETAILS,
                                           prepayment = op.PREPAYMENT,
                                           newInterateRate = op.INTERATERATE,
                                           newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                           newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                           newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                           newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                           newTenor = op.TENOR,
                                           cASA_AccountId = op.CASA_ACCOUNTID,
                                           cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                           overDraftTopup = op.OVERDRAFTTOPUP,
                                           fee_Charges = op.FEE_CHARGES,
                                           scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                           scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                           scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                           scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                           scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                           newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                           newMaturityDate = op.MATURITYDATE,
                                           dateTimeCreated = op.DATECREATED
                                       }).FirstOrDefault(),
                                   }).ToList();

            var referred = (from a in context.TBL_LOAN_EXTERNAL
                            join op in context.TBL_LOAN_REVIEW_OPERATION on a.EXTERNALLOANID equals op.LOANID
                            join b in context.TBL_LMSR_APPLICATION_DETAIL on a.EXTERNALLOANID equals b.LOANID
                            join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                            join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                            join atrail in context.TBL_APPROVAL_TRAIL on op.LOANREVIEWOPERATIONID equals atrail.TARGETID
                            where a.ISDISBURSED == true
                            && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                            && b.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.ExternalFacility
                            && atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred
                            && atrail.APPROVALSTATEID != (int)ApprovalState.Ended
                            && atrail.OPERATIONID == op.OPERATIONTYPEID
                            && atrail.RESPONSESTAFFID == null
                            && op.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                            && op.OPERATIONCOMPLETED == false
                            && ((cf.CanSeeLocalCurrency && a.CURRENCYID == cf.DefaultCurrencyId) || (cf.CanSeeForeignCurrency && a.CURRENCYID != cf.DefaultCurrencyId))
                            && (staffs.Contains(atrail.LOOPEDSTAFFID ?? 0))
                            select new LoanViewModel
                            {
                                lmsdatecreated = b.DATETIMECREATED,
                                creditAppraisalOperationId = (from p in context.TBL_LOAN_EXTERNAL join c in context.TBL_LMSR_APPLICATION_DETAIL on p.EXTERNALLOANID equals c.LOANID where c.LOANREVIEWAPPLICATIONID == b.LOANREVIEWAPPLICATIONID select c.OPERATIONID).FirstOrDefault(),
                                creditAppraisalLoanApplicationId = 0,
                                appraisalOperationId = e.OPERATIONID,
                                appraisalLoanApplicationId = e.LOANAPPLICATIONID,
                                synOperationId = context.TBL_OPERATIONS.Where(o => o.OPERATIONID == b.OPERATIONID).Select(o => o.SYNCHOPERATIONID).FirstOrDefault(),
                                loanReviewApplicationId = e.LOANAPPLICATIONID,
                                loanId = a.EXTERNALLOANID,
                                customerId = a.CUSTOMERID,
                                customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                productId = a.PRODUCTID,
                                companyId = a.COMPANYID,
                                casaAccountId = a.CASAACCOUNTID,
                                branchId = a.BRANCHID,
                                reviewLoanDetaile = b.REVIEWDETAILS,
                                branchName = a.TBL_BRANCH.BRANCHNAME,
                                divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                loanReferenceNumber = a.LOANREFERENCENUMBER,
                                lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                applicationReferenceNumber = "N/A", //a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                principalFrequencyTypeName = (from f in context.TBL_FREQUENCY_TYPE where f.FREQUENCYTYPEID == a.PRINCIPALFREQUENCYTYPEID select f.MODE).FirstOrDefault(),
                                interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                interestFrequencyTypeName = (from f in context.TBL_FREQUENCY_TYPE where f.FREQUENCYTYPEID == a.INTERESTFREQUENCYTYPEID select f.MODE).FirstOrDefault(),
                                productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                productName = a.TBL_PRODUCT.PRODUCTNAME,
                                productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                relationshipOfficerName = (from s in context.TBL_STAFF where s.STAFFID == a.RELATIONSHIPOFFICERID select s.FIRSTNAME).FirstOrDefault(),
                                relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                relationshipManagerName = (from s in context.TBL_STAFF where s.STAFFID == a.RELATIONSHIPOFFICERID select s.FIRSTNAME).FirstOrDefault(),
                                misCode = a.MISCODE,
                                teamMiscode = a.TEAMMISCODE,
                                interestRate = a.INTERESTRATE,
                                effectiveDate = a.EFFECTIVEDATE,
                                maturityDate = a.MATURITYDATE,
                                bookingDate = a.BOOKINGDATE,
                                principalAmount = a.PRINCIPALAMOUNT,
                                principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                approvalStatusId = a.APPROVALSTATUSID,
                                approvedBy = a.APPROVEDBY,
                                approverComment = a.APPROVERCOMMENT,
                                dateApproved = a.DATEAPPROVED,
                                loanStatusId = a.LOANSTATUSID,
                                scheduleTypeId = a.SCHEDULETYPEID,
                                scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                isDisbursed = a.ISDISBURSED,
                                disbursedBy = a.DISBURSEDBY,
                                disburserComment = a.DISBURSERCOMMENT,
                                disburseDate = a.DISBURSEDATE,
                                loanSystemTypeId = a.LOANSYSTEMTYPEID,
                                operationId = b.OPERATIONID,
                                operationName = context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == e.OPERATIONID).OPERATIONNAME,
                                subSectorName = a.TBL_SUB_SECTOR.NAME,
                                sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                casaAccountNumber = (from c in context.TBL_CASA where c.CASAACCOUNTID == a.CASAACCOUNTID select c.PRODUCTACCOUNTNUMBER).FirstOrDefault(),
                                productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                loanTypeName = "Third-Party Facility",
                                equityContribution = a.EQUITYCONTRIBUTION,
                                firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                outstandingInterest = a.OUTSTANDINGINTEREST,
                                principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                fixedPrincipal = a.FIXEDPRINCIPAL,
                                profileLoan = a.PROFILELOAN,
                                dischargeLetter = a.DISCHARGELETTER,
                                suspendInterest = a.SUSPENDINTEREST,
                                customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                createdBy = a.CREATEDBY,
                                dateTimeCreated = a.DATETIMECREATED,
                                isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.EXTERNALLOANID).Any(),
                                exchangeRate = a.EXCHANGERATE,
                                currencyId = a.CURRENCYID,
                                currency = a.TBL_CURRENCY.CURRENCYNAME,
                                loanReviewOperationTypeId = b.OPERATIONID,
                                reviewDetails = b.REVIEWDETAILS,
                                interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                pastDueInterest = a.PASTDUEINTEREST,
                                pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.EXTERNALLOANID && x.DATE == applicationDate).Select(x => x.ACCRUEDINTEREST).FirstOrDefault(),  //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST, //d.ACCRUEDINTEREST,
                                systemCurrentDate = applicationDate,
                                lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.EXTERNALLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                {

                                    loanApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                    loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                    operationTypeId = op.OPERATIONTYPEID,
                                    operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                    newEffectiveDate = op.EFFECTIVEDATE,
                                    reviewDetails = op.REVIEWDETAILS,
                                    prepayment = op.PREPAYMENT,
                                    newInterateRate = op.INTERATERATE,
                                    newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                    newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                    newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                    newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                    newTenor = op.TENOR,
                                    cASA_AccountId = op.CASA_ACCOUNTID,
                                    cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                    overDraftTopup = op.OVERDRAFTTOPUP,
                                    fee_Charges = op.FEE_CHARGES,
                                    scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                    scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                    scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                    scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                    scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                    newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                    newMaturityDate = op.MATURITYDATE,
                                    dateTimeCreated = op.DATECREATED
                                }).FirstOrDefault(),
                            }).ToList();
            allFilteredLoan = allFilteredLoan.Union(referred).ToList();


            return allFilteredLoan;
        }
        #region Commercial Loan Operations
        public IEnumerable<LoanViewModel> GetApprovedNonTermLoansForReview(int staffId, int companyId)
        {
            try
            {
                var activities = admin.GetUserActivitiesByUser(staffId);
                var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.COMPANYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

                var applicationDate = generalSetup.GetApplicationDate();
                List<short> productTypes = new List<short>();
                productTypes.Add((short)LoanProductTypeEnum.CommercialLoan);


                var allFilteredLoan = (from a in context.TBL_LOAN
                                       join b in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals b.LOANID
                                       join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                       join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                       where a.ISDISBURSED == true && b.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                       && b.OPERATIONPERFORMED == false
                                       && a.OPERATIONID != (short)OperationsEnum.TermLoanBooking
                                       && b.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility
                                       && productTypes.Contains(a.TBL_PRODUCT.PRODUCTTYPEID)

                                       select new LoanViewModel
                                       {
                                           loanReviewApplicationId = b.LOANAPPLICATIONID,
                                           loanId = a.TERMLOANID,
                                           customerId = a.CUSTOMERID,
                                           customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                           customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                           productId = a.PRODUCTID,
                                           companyId = a.COMPANYID,
                                           casaAccountId = a.CASAACCOUNTID,
                                           branchId = a.BRANCHID,
                                           branchName = a.TBL_BRANCH.BRANCHNAME,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                           applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                           principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                           principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                           interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                           interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                           productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                           productName = a.TBL_PRODUCT.PRODUCTNAME,
                                           productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                           principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                           interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                           relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                           relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                           relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                           relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                           misCode = a.MISCODE,
                                           teamMiscode = a.TEAMMISCODE,
                                           interestRate = a.INTERESTRATE,
                                           effectiveDate = a.EFFECTIVEDATE,
                                           maturityDate = a.MATURITYDATE,
                                           bookingDate = a.BOOKINGDATE,
                                           principalAmount = a.PRINCIPALAMOUNT,
                                           principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                           interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                           approvalStatusId = a.APPROVALSTATUSID,
                                           approvedBy = a.APPROVEDBY,
                                           approverComment = a.APPROVERCOMMENT,
                                           dateApproved = a.DATEAPPROVED,
                                           loanStatusId = a.LOANSTATUSID,
                                           scheduleTypeId = a.SCHEDULETYPEID,
                                           scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                           isDisbursed = a.ISDISBURSED,
                                           disbursedBy = a.DISBURSEDBY,
                                           disburserComment = a.DISBURSERCOMMENT,
                                           disburseDate = a.DISBURSEDATE,
                                           currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                           //approvedAmount = a.ApprovedAmount,
                                           operationId = a.OPERATIONID,
                                           operationName = b.TBL_OPERATIONS.OPERATIONNAME, //context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
                                           subSectorName = a.TBL_SUB_SECTOR.NAME,
                                           sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                           casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                           productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                           customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                           loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                           loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                           equityContribution = a.EQUITYCONTRIBUTION,
                                           firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                           firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                           outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                           outstandingInterest = a.OUTSTANDINGINTEREST,
                                           principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                           principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                           fixedPrincipal = a.FIXEDPRINCIPAL,
                                           profileLoan = a.PROFILELOAN,
                                           dischargeLetter = a.DISCHARGELETTER,
                                           suspendInterest = a.SUSPENDINTEREST,
                                           customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                           createdBy = a.CREATEDBY,
                                           dateTimeCreated = a.DATETIMECREATED,
                                           isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                           exchangeRate = a.EXCHANGERATE,
                                           currencyId = a.CURRENCYID,
                                           currency = a.TBL_CURRENCY.CURRENCYNAME,
                                           loanReviewOperationTypeId = b.OPERATIONID,
                                           reviewDetails = b.REVIEWDETAILS,
                                           interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                           interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                           pastDueInterest = a.PASTDUEINTEREST,
                                           accrualedAmount = context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.LOANID == a.TERMLOANID && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST,
                                           //accrualedAmount = d.ACCRUEDINTEREST, //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST,
                                           systemCurrentDate = applicationDate,
                                           lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                           operationReview = context.TBL_LOAN_REVIEW_OPERATION.Where(m => m.LOANID == a.TERMLOANID && m.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred && m.OPERATIONCOMPLETED == false).Select(op => new LoanReviewOperationApprovalViewModel
                                           {
                                               loanReviewOperationsId = op.LOANREVIEWOPERATIONID,
                                               operationTypeId = op.OPERATIONTYPEID,
                                               operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == op.OPERATIONTYPEID).OPERATIONNAME,
                                               newEffectiveDate = op.EFFECTIVEDATE,
                                               reviewDetails = op.REVIEWDETAILS,
                                               prepayment = op.PREPAYMENT,
                                               newInterateRate = op.INTERATERATE,
                                               newPrincipalFirstPaymentDate = op.PRINCIPALFIRSTPAYMENTDATE,
                                               newPrincipalFrequencyTypeId = op.PRINCIPALFREQUENCYTYPEID,
                                               newInterestFrequencyTypeId = op.INTERESTFREQUENCYTYPEID,
                                               newPrincipalFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.PRINCIPALFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                               newInterestFrequencyTypeName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == op.INTERESTFREQUENCYTYPEID).Select(x => x.MODE).FirstOrDefault(),
                                               newTenor = op.TENOR,
                                               cASA_AccountId = op.CASA_ACCOUNTID,
                                               cASA_AccountName = context.TBL_CASA.Where(x => x.CASAACCOUNTID == op.CASA_ACCOUNTID).Select(x => x.PRODUCTACCOUNTNAME).FirstOrDefault(),
                                               overDraftTopup = op.OVERDRAFTTOPUP,
                                               fee_Charges = op.FEE_CHARGES,
                                               scheduleDayCountConventionId = op.SCHEDULEDAYCOUNTCONVENTIONID,
                                               scheduleDayCountConventionIName = context.TBL_DAY_COUNT_CONVENTION.Where(x => x.DAYCOUNTCONVENTIONID == op.SCHEDULEDAYCOUNTCONVENTIONID).Select(x => x.DAYCOUNTCONVENTIONNAME).FirstOrDefault(),
                                               scheduleDayInterestTypeId = op.SCHEDULEDAYINTERESTTYPEID,
                                               scheduledPrepaymentFrequencyTypeId = op.SCHEDULETYPEID,
                                               scheduledPrepaymentFrequencyTypeName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == op.SCHEDULETYPEID).Select(x => x.SCHEDULETYPENAME).FirstOrDefault(),
                                               newInterestFirstPaymentDate = op.INTERESTFIRSTPAYMENTDATE,
                                               newMaturityDate = op.MATURITYDATE,
                                               dateTimeCreated = op.DATECREATED
                                           }).FirstOrDefault(),
                                       }).ToList();

                List<LoanViewModel> lcyLoans = new List<LoanViewModel>();
                List<LoanViewModel> fcyLoans = new List<LoanViewModel>();

                var isLCYUser = activities.Contains("lcy-user");
                var isFCYUser = activities.Contains("fcy-user");

                if (isLCYUser == true)
                {
                    lcyLoans = allFilteredLoan.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                    //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
                }

                if (isFCYUser == true)
                {
                    fcyLoans = allFilteredLoan.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

                }

                allFilteredLoan = lcyLoans.Union(fcyLoans).ToList();

                return allFilteredLoan;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public IEnumerable<LoanViewModel> GetApprovedNonTermLoansForReviewAwaitingApproval(int staffId, int companyId)
        {
            var activities = admin.GetUserActivitiesByUser(staffId);
            var defaultCurrencyId = context.TBL_COMPANY.Where(x => x.CURRENCYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;

            var ids = generalSetup.GetStaffApprovalLevelIds(staffId, (int)OperationsEnum.OfferLetterApproval).ToList();
            var applicationDate = generalSetup.GetApplicationDate();
            var allFilteredLoan = (from a in context.TBL_LOAN
                                   join b in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals b.LOANID
                                   join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                   join ln in context.TBL_LOAN_REVIEW_OPERATION on b.LOANREVIEWAPPLICATIONID equals ln.LOANREVIEWAPPLICATIONID //on b.LOANID equals ln.LOANID
                                   join atrail in context.TBL_APPROVAL_TRAIL on ln.LOANREVIEWOPERATIONID equals atrail.TARGETID
                                   join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                   where a.ISDISBURSED == true && b.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
                                   //   && b.OPERATIONPERFORMED == true
                                   && a.OPERATIONID != (short)OperationsEnum.TermLoanBooking
                                   && b.LOANSYSTEMTYPEID == (short)LoanSystemTypeEnum.TermDisbursedFacility
                                   && (atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Processing
                                   || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Pending
                                   || atrail.APPROVALSTATUSID == (int)ApprovalStatusEnum.Referred)
                                    && atrail.OPERATIONID == ln.OPERATIONTYPEID
                                   && ids.Contains((int)atrail.TOAPPROVALLEVELID)// == staffApprovalLevelId
                                   && atrail.RESPONSESTAFFID == null && ln.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                   && ln.OPERATIONCOMPLETED == false && b.OPERATIONPERFORMED == true
                                   select new LoanViewModel
                                   {
                                       divisionCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == c.CUSTOMERID select p.BUSINESSUNITINITIALS).FirstOrDefault(),
                                       divisionShortCode = (from p in context.TBL_PROFILE_BUSINESS_UNIT join c in context.TBL_CUSTOMER on p.BUSINESSUNITID equals c.BUSINESSUNTID where c.CUSTOMERID == a.CUSTOMERID select p.BUSINESSUNITSHORTCODE).FirstOrDefault(),
                                       lmsApplicationReferenceNumber = e.APPLICATIONREFERENCENUMBER,
                                       loanReviewApplicationId = e.LOANAPPLICATIONID,
                                       currentApprovalLevelId = (int)atrail.TOAPPROVALLEVELID,
                                       newTenor = ln.TENOR ?? 0,
                                       operationPerformed = ln.REVIEWDETAILS,
                                       newInterestRate = ln.INTERATERATE,
                                       newLineAmount = ln.PREPAYMENT,
                                       approvedTenor = a.TBL_LOAN_APPLICATION_DETAIL.APPROVEDTENOR,
                                       approvedAmount = a.TBL_LOAN_APPLICATION_DETAIL.APPROVEDAMOUNT,
                                       loanReviewOperationId = ln.LOANREVIEWOPERATIONID,
                                       instructionTypeId = ln.MATURITYINSTRUCTIONTYPEID,
                                       instructionTypeName = context.TBL_LOAN_MATURITY_INSTRU_TYPE.Where(ml => ml.INSTRUCTIONTYPEID == ln.MATURITYINSTRUCTIONTYPEID).Select(rc => rc.INSTRUCTIONTYPENAME).FirstOrDefault(),

                                       loanId = a.TERMLOANID,
                                       customerId = a.CUSTOMERID,
                                       customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                       customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
                                       productId = a.PRODUCTID,
                                       companyId = a.COMPANYID,
                                       casaAccountId = a.CASAACCOUNTID,
                                       branchId = a.BRANCHID,
                                       branchName = a.TBL_BRANCH.BRANCHNAME,
                                       loanReferenceNumber = a.LOANREFERENCENUMBER,
                                       applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                       principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
                                       principalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
                                       interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
                                       interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
                                       productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
                                       productName = a.TBL_PRODUCT.PRODUCTNAME,
                                       productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                       principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
                                       interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
                                       relationshipOfficerId = a.RELATIONSHIPOFFICERID,
                                       relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                       relationshipManagerId = a.RELATIONSHIPMANAGERID,
                                       relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                       misCode = a.MISCODE,
                                       teamMiscode = a.TEAMMISCODE,
                                       interestRate = a.INTERESTRATE,
                                       effectiveDate = a.EFFECTIVEDATE,
                                       maturityDate = a.MATURITYDATE,
                                       bookingDate = a.BOOKINGDATE,
                                       principalAmount = a.PRINCIPALAMOUNT,
                                       principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
                                       interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
                                       approvalStatusId = a.APPROVALSTATUSID,
                                       approvedBy = a.APPROVEDBY,
                                       approverComment = a.APPROVERCOMMENT,
                                       dateApproved = a.DATEAPPROVED,
                                       loanStatusId = a.LOANSTATUSID,
                                       scheduleTypeId = a.SCHEDULETYPEID,
                                       scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
                                       isDisbursed = a.ISDISBURSED,
                                       disbursedBy = a.DISBURSEDBY,
                                       disburserComment = a.DISBURSERCOMMENT,
                                       disburseDate = a.DISBURSEDATE,
                                       currencyCode = a.TBL_CURRENCY.CURRENCYCODE,
                                       //approvedAmount = a.ApprovedAmount,
                                       operationId = ln.OPERATIONTYPEID,
                                       operationName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == ln.OPERATIONTYPEID).OPERATIONNAME,
                                       operationTypeId = ln.OPERATIONTYPEID,
                                       operationTypeName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == ln.OPERATIONTYPEID).OPERATIONNAME,
                                       subSectorName = a.TBL_SUB_SECTOR.NAME,
                                       sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
                                       casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
                                       productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
                                       customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
                                       loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
                                       loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
                                       equityContribution = a.EQUITYCONTRIBUTION,
                                       firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
                                       firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
                                       outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                       outstandingInterest = a.OUTSTANDINGINTEREST,
                                       principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
                                       principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
                                       fixedPrincipal = a.FIXEDPRINCIPAL,
                                       profileLoan = a.PROFILELOAN,
                                       dischargeLetter = a.DISCHARGELETTER,
                                       suspendInterest = a.SUSPENDINTEREST,
                                       customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
                                       createdBy = a.CREATEDBY,
                                       dateTimeCreated = a.DATETIMECREATED,
                                       isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
                                       exchangeRate = a.EXCHANGERATE,
                                       currencyId = a.CURRENCYID,
                                       currency = a.TBL_CURRENCY.CURRENCYNAME,
                                       loanReviewOperationTypeId = b.OPERATIONID,
                                       reviewDetails = b.REVIEWDETAILS,
                                       interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                       interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                       pastDueInterest = a.PASTDUEINTEREST,
                                       //accrualedAmount = d.ACCRUEDINTEREST, //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST,
                                       systemCurrentDate = applicationDate,
                                       lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
                                   }).ToList();


            List<LoanViewModel> lcyLoans = new List<LoanViewModel>();
            List<LoanViewModel> fcyLoans = new List<LoanViewModel>();

            var isLCYUser = activities.Contains("lcy-user");
            var isFCYUser = activities.Contains("fcy-user");

            if (isLCYUser == true)
            {
                lcyLoans = allFilteredLoan.Where(x => x.currencyId == defaultCurrencyId && x.productTypeId != (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();
                //data = data.Where(x => x.currencyId == company.CURRENCYID).Select(x => x);
            }

            if (isFCYUser == true)
            {
                fcyLoans = allFilteredLoan.Where(x => x.currencyId != defaultCurrencyId || x.productTypeId == (short)LoanProductTypeEnum.CommercialLoan).Select(x => x).ToList();

            }

            allFilteredLoan = lcyLoans.Union(fcyLoans).ToList();

            foreach (var i in allFilteredLoan)
            {
                i.tenorUsed = (applicationDate - i.effectiveDate).Days;
                if (i.operationPerformed == "TenorChange")
                {
                    i.operationId = (int)OperationsEnum.TenorChange;
                    i.operationName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == i.operationId).OPERATIONNAME;
                }
                if (i.operationPerformed == "InterestRateChange")
                {
                    i.operationId = (int)OperationsEnum.ContractualInterestRateChange;
                    i.operationName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == i.operationId).OPERATIONNAME;
                }

                if (i.operationPerformed == "AmountChange")
                {
                    i.operationId = (int)OperationsEnum.FacilityLineAmountChange;
                    i.operationName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == i.operationId).OPERATIONNAME;
                }
                if (i.operationPerformed == "CommercialLoanSubAllocation")
                {
                    i.operationId = (int)OperationsEnum.CommercialLoanSubAllocation;
                    i.operationName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == i.operationId).OPERATIONNAME;
                }
                if (i.operationPerformed == "RollOver")
                {
                    i.operationId = (int)OperationsEnum.CommercialLoanRollOver;
                    i.operationName = context.TBL_OPERATIONS.FirstOrDefault(d => d.OPERATIONID == i.operationId).OPERATIONNAME;
                }
            };


            return allFilteredLoan;
        }

        //public IEnumerable<LoanViewModel> GetApprovedFXRevolvingLoanReview()
        //{
        //    try
        //    {
        //        var applicationDate = generalSetup.GetApplicationDate();
        //        var allFilteredLoan = (from a in context.TBL_LOAN
        //                               join b in context.TBL_LMSR_APPLICATION_DETAIL on a.TERMLOANID equals b.LOANID
        //                               join e in context.TBL_LMSR_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
        //                               join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
        //                               // d in context.TBL_LOAN_SCHEDULE_DAILY on a.TERMLOANID equals d.LOANID
        //                               where a.ISDISBURSED == true && e.APPROVALSTATUSID == (int)ApprovalStatusEnum.Approved
        //                              && b.TBL_OPERATIONS.OPERATIONTYPEID == (int)OperationTypeEnum.LoanManagement
        //                              && b.OPERATIONPERFORMED == false
        //                              && a.OPERATIONID == (short)OperationsEnum.ForeignExchangeLoanBooking
        //                               //&& d.DATE == DbFunctions.TruncateTime(applicationDate)
        //                               //orderby b.DATECREATED descending
        //                               select new LoanViewModel
        //                               {
        //                                   loanId = a.TERMLOANID,
        //                                   customerId = a.CUSTOMERID,
        //                                   customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
        //                                   customerCode = a.TBL_CUSTOMER.CUSTOMERCODE,
        //                                   productId = a.PRODUCTID,
        //                                   companyId = a.COMPANYID,
        //                                   casaAccountId = a.CASAACCOUNTID,
        //                                   branchId = a.BRANCHID,
        //                                   branchName = a.TBL_BRANCH.BRANCHNAME,
        //                                   loanReferenceNumber = a.LOANREFERENCENUMBER,
        //                                   applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
        //                                   principalFrequencyTypeId = a.PRINCIPALFREQUENCYTYPEID != null ? (short)a.PRINCIPALFREQUENCYTYPEID : (short)0,
        //                                   pricipalFrequencyTypeName = a.TBL_FREQUENCY_TYPE.MODE,
        //                                   interestFrequencyTypeId = a.INTERESTFREQUENCYTYPEID != null ? (short)a.INTERESTFREQUENCYTYPEID : (short)0,
        //                                   interestFrequencyTypeName = a.TBL_FREQUENCY_TYPE1.MODE,
        //                                   productTypeId = a.TBL_PRODUCT.PRODUCTTYPEID,
        //                                   productName = a.TBL_PRODUCT.PRODUCTNAME,
        //                                   productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
        //                                   principalNumberOfInstallment = a.PRINCIPALNUMBEROFINSTALLMENT,
        //                                   interestNumberOfInstallment = a.INTERESTNUMBEROFINSTALLMENT,
        //                                   relationshipOfficerId = a.RELATIONSHIPOFFICERID,
        //                                   relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
        //                                   relationshipManagerId = a.RELATIONSHIPMANAGERID,
        //                                   relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
        //                                   misCode = a.MISCODE,
        //                                   teamMiscode = a.TEAMMISCODE,
        //                                   interestRate = a.INTERESTRATE,
        //                                   effectiveDate = a.EFFECTIVEDATE,
        //                                   maturityDate = a.MATURITYDATE,
        //                                   bookingDate = a.BOOKINGDATE,
        //                                   principalAmount = a.PRINCIPALAMOUNT,
        //                                   principalInstallmentLeft = a.PRINCIPALINSTALLMENTLEFT,
        //                                   interestInstallmentLeft = a.INTERESTINSTALLMENTLEFT,
        //                                   approvalStatusId = a.APPROVALSTATUSID,
        //                                   approvedBy = a.APPROVEDBY,
        //                                   approverComment = a.APPROVERCOMMENT,
        //                                   dateApproved = a.DATEAPPROVED,
        //                                   loanStatusId = a.LOANSTATUSID,
        //                                   scheduleTypeId = a.SCHEDULETYPEID,
        //                                   scheduleTypeName = a.TBL_LOAN_SCHEDULE_TYPE.SCHEDULETYPENAME,
        //                                   isDisbursed = a.ISDISBURSED,
        //                                   disbursedBy = a.DISBURSEDBY,
        //                                   disburserComment = a.DISBURSERCOMMENT,
        //                                   disburseDate = a.DISBURSEDATE,
        //                                   //approvedAmount = a.ApprovedAmount,
        //                                   operationId = a.OPERATIONID,
        //                                   operationName = b.TBL_OPERATIONS.OPERATIONNAME, //context.TBL_OPERATIONS.FirstOrDefault(x => x.OPERATIONID == a.OPERATIONID).OPERATIONNAME,
        //                                   subSectorName = a.TBL_SUB_SECTOR.NAME,
        //                                   sectorName = a.TBL_SUB_SECTOR.TBL_SECTOR.NAME,
        //                                   casaAccountNumber = a.TBL_CASA.PRODUCTACCOUNTNUMBER,
        //                                   productAccountName = a.TBL_PRODUCT.PRODUCTNAME,
        //                                   customerGroupId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.CUSTOMERGROUPID,
        //                                   loanTypeId = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.LOANAPPLICATIONTYPEID,
        //                                   loanTypeName = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.TBL_LOAN_APPLICATION_TYPE.LOANAPPLICATIONTYPENAME,
        //                                   equityContribution = a.EQUITYCONTRIBUTION,
        //                                   firstPrincipalPaymentDate = a.FIRSTPRINCIPALPAYMENTDATE,
        //                                   firstInterestPaymentDate = a.FIRSTINTERESTPAYMENTDATE,
        //                                   outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
        //                                   outstandingInterest = a.OUTSTANDINGINTEREST,
        //                                   principalAdditionCount = a.PRINCIPALADDITIONCOUNT ?? 0,
        //                                   principalReductionCount = a.PRINCIPALREDUCTIONCOUNT ?? 0,
        //                                   fixedPrincipal = a.FIXEDPRINCIPAL,
        //                                   profileLoan = a.PROFILELOAN,
        //                                   dischargeLetter = a.DISCHARGELETTER,
        //                                   suspendInterest = a.SUSPENDINTEREST,
        //                                   customerSensitivityLevelId = a.TBL_CUSTOMER.CUSTOMERSENSITIVITYLEVELID,
        //                                   createdBy = a.CREATEDBY,
        //                                   dateTimeCreated = a.DATETIMECREATED,
        //                                   isCamsol = context.TBL_LOAN_CAMSOL.Where(x => x.LOANID == a.TERMLOANID).Any(),
        //                                   exchangeRate = a.EXCHANGERATE,
        //                                   currencyId = a.CURRENCYID,
        //                                   currency = a.TBL_CURRENCY.CURRENCYNAME,
        //                                   loanReviewOperationTypeId = b.OPERATIONID,
        //                                   reviewDetails = b.REVIEWDETAILS,
        //                                   interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
        //                                   interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
        //                                   pastDueInterest = a.PASTDUEINTEREST,
        //                                   //accrualedAmount = d.ACCRUEDINTEREST, //context.TBL_LOAN_SCHEDULE_DAILY.Where(x => x.TBL_LOAN.LOANREFERENCENUMBER == a.LOANREFERENCENUMBER && x.DATE == applicationDate).FirstOrDefault().ACCRUEDINTEREST,
        //                                   systemCurrentDate = applicationDate,
        //                                   lmsApplicationDetailId = b.LOANREVIEWAPPLICATIONID,
        //                               }).ToList();

        //        return allFilteredLoan;
        //    }
        //    catch (Exception ex)
        //    {
        //        throw ex;
        //    }
        //}

        public List<LoanViewModel> GetCompletedLoans()
        {
            try
            {
                var applicationDate = generalSetup.GetApplicationDate();
                var allFilteredLoan = (from a in context.TBL_LOAN
                                       join b in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals b.LOANAPPLICATIONDETAILID
                                       join e in context.TBL_LOAN_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                       join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                       where a.LOANSTATUSID == (int)LoanStatusEnum.Active
                                       && a.OUTSTANDINGPRINCIPAL <= 0
                                       && a.OUTSTANDINGINTEREST <= 0
                                       && a.PASTDUEPRINCIPAL <= 0
                                       && a.PASTDUEINTEREST <= 0
                                       && a.INTERESTONPASTDUEINTEREST <= 0
                                       && a.INTERESTONPASTDUEPRINCIPAL <= 0
                                       && applicationDate >= a.MATURITYDATE
                                       select new LoanViewModel
                                       {
                                           loanId = a.TERMLOANID,
                                           customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                           branchName = a.TBL_BRANCH.BRANCHNAME,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                           productName = a.TBL_PRODUCT.PRODUCTNAME,
                                           productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                           relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                           relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                           effectiveDate = a.EFFECTIVEDATE,
                                           maturityDate = a.MATURITYDATE,
                                           outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                           outstandingInterest = a.OUTSTANDINGINTEREST,
                                           interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                           interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                           pastDueInterest = a.PASTDUEINTEREST,
                                           pastDuePrincipal = a.PASTDUEPRINCIPAL,
                                           loanStatus = context.TBL_LOAN_STATUS.Where(o => o.LOANSTATUSID == a.LOANSTATUSID).Select(o => o.ACCOUNTSTATUS).FirstOrDefault()

                                       }).ToList();

                return allFilteredLoan;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public List<LoanViewModel> GetCompletedLoan(string searchValue)
        {
            try
            {
                var applicationDate = generalSetup.GetApplicationDate();
                var allFilteredLoan = (from a in context.TBL_LOAN
                                       join b in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals b.LOANAPPLICATIONDETAILID
                                       join e in context.TBL_LOAN_APPLICATION on b.LOANAPPLICATIONID equals e.LOANAPPLICATIONID
                                       join c in context.TBL_CUSTOMER on a.CUSTOMERID equals c.CUSTOMERID
                                       where a.LOANSTATUSID == (int)LoanStatusEnum.Active
                                       && a.OUTSTANDINGPRINCIPAL <= 0
                                       && a.OUTSTANDINGINTEREST <= 0
                                       && a.PASTDUEPRINCIPAL <= 0
                                       && a.PASTDUEINTEREST <= 0
                                       && a.INTERESTONPASTDUEINTEREST <= 0
                                       && a.INTERESTONPASTDUEPRINCIPAL <= 0
                                       && applicationDate >= a.MATURITYDATE
                                       && (e.APPLICATIONREFERENCENUMBER.Contains(searchValue) || a.LOANREFERENCENUMBER.Contains(searchValue)
                                       || c.FIRSTNAME.ToLower().StartsWith(searchValue.ToLower()) || c.LASTNAME.ToLower().StartsWith(searchValue.ToLower()))

                                       select new LoanViewModel
                                       {
                                           customerName = a.TBL_CUSTOMER.FIRSTNAME + " " + a.TBL_CUSTOMER.LASTNAME,
                                           branchName = a.TBL_BRANCH.BRANCHNAME,
                                           loanReferenceNumber = a.LOANREFERENCENUMBER,
                                           applicationReferenceNumber = a.TBL_LOAN_APPLICATION_DETAIL.TBL_LOAN_APPLICATION.APPLICATIONREFERENCENUMBER ?? "N/A",
                                           productName = a.TBL_PRODUCT.PRODUCTNAME,
                                           productTypeName = a.TBL_PRODUCT.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                                           relationshipOfficerName = a.TBL_STAFF.FIRSTNAME + " " + a.TBL_STAFF.MIDDLENAME + " " + a.TBL_STAFF.LASTNAME,
                                           relationshipManagerName = a.TBL_STAFF1.FIRSTNAME + " " + a.TBL_STAFF1.MIDDLENAME + " " + a.TBL_STAFF1.LASTNAME,
                                           effectiveDate = a.EFFECTIVEDATE,
                                           maturityDate = a.MATURITYDATE,
                                           outstandingPrincipal = a.OUTSTANDINGPRINCIPAL,
                                           outstandingInterest = a.OUTSTANDINGINTEREST,
                                           interesrtOnPastDueInterest = a.INTERESTONPASTDUEINTEREST,
                                           interestOnPastDuePrincipal = a.INTERESTONPASTDUEPRINCIPAL,
                                           pastDueInterest = a.PASTDUEINTEREST,
                                           pastDuePrincipal = a.PASTDUEPRINCIPAL,

                                       }).ToList();

                return allFilteredLoan;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        public bool GetChangeLoanStatusOfACompletedLoan(int loanId)
        {
            var loan = (from x in context.TBL_LOAN
                        where x.TERMLOANID == loanId
                        select x).FirstOrDefault();
            if (loan == null) return false;

            loan.LOANSTATUSID = (int)LoanStatusEnum.Completed;
            if (context.SaveChanges() > 0) return true;

            return false;

        }
        #endregion Commercial loan Operations

        private DateTime getApplicationDate()
        {
            if (applicationDate == null) applicationDate = generalSetup.GetApplicationDate();
            return (DateTime)applicationDate;
        }

        private UserCurrencyViewFilter GetUserCurrencyViewFilter(int companyId, int staffId)
        {
            UserCurrencyViewFilter result = new UserCurrencyViewFilter();
            result.DefaultCurrencyId = context.TBL_COMPANY.Where(x => x.CURRENCYID == companyId).Select(x => x).FirstOrDefault().CURRENCYID;
            var userId = context.TBL_PROFILE_USER.FirstOrDefault(u => u.STAFFID == staffId).USERID;
            var activities = admin.GetUserActivitiesByUser(userId);
            result.CanSeeLocalCurrency = activities.Contains("lcy-user");
            result.CanSeeForeignCurrency = activities.Contains("fcy-user");
            return result;
        }
        public bool VerifyLegalContingentCode(string legalContingentCode, int loanApplicationDetailId)
        {
            bool result = false;
            var record = (from a in context.TBL_LOAN_CONTINGENT
                              //join b in context.TBL_LOAN_APPLICATION_DETAIL on a.LOANAPPLICATIONDETAILID equals b.LOANAPPLICATIONDETAILID
                          where a.LEGALCONTINGENTCODE == legalContingentCode && a.LOANAPPLICATIONDETAILID != loanApplicationDetailId
                          select a.LEGALCONTINGENTCODE
                          ).FirstOrDefault();
            if (record == null)
            {
                result = false;
            }
            else
            {
                result = true;
            }
            return result;
        }
        public AccountBalanceViewModel GetLoanBalances(int loanId, int companyId)
        {
            return context.TBL_LOAN.Where(o => o.TERMLOANID == loanId && o.COMPANYID == companyId).Select(o => new AccountBalanceViewModel
            {
                outstandingPrincipal = o.OUTSTANDINGPRINCIPAL,
                interestOnPastDueInterest = o.INTERESTONPASTDUEINTEREST,
                interestOnPastDuePrincipal = o.INTERESTONPASTDUEPRINCIPAL,
                pastDueInterest = o.PASTDUEINTEREST,
                pastDuePrincipal = o.PASTDUEPRINCIPAL,
                accruedInterest = 0,

            }).FirstOrDefault();
        }

        public IEnumerable<multipleDisbursementOutputViewModel> GetpendingMultipleDisbursement()
        {
            var data = (from b in context.TBL_LOAN_BULK_DISBURSEMENT
                        join d in context.TBL_LOAN_APPLICATION_DETAIL on b.LOANAPPLICATIONDETAILID equals d.LOANAPPLICATIONDETAILID
                        join s in context.TBL_LOAN_BULK_DISBURSE_SCHEME on b.SCHEMECODE equals s.SCHEMECODE
                        join c in context.TBL_CUSTOMER on b.CUSTOMERID equals c.CUSTOMERID
                        join p in context.TBL_PRODUCT on s.PRODUCTID equals (int)p.PRODUCTID

                        where b.APPROVALSTATUS == (short)ApprovalStatusEnum.Pending
                        select new multipleDisbursementOutputViewModel
                        {
                            loanAmount = (int)b.LOANAMOUNT,
                            multipleBulkDisbursementId = b.MULTIPLEBULKDISBURSEMENTID,
                            applicationReferenceNumber = context.TBL_LOAN_APPLICATION.Where(l => l.LOANAPPLICATIONID == d.LOANAPPLICATIONID).FirstOrDefault().APPLICATIONREFERENCENUMBER,
                            accountNumber = context.TBL_CASA.Where(x => x.CASAACCOUNTID == b.CASAACCOUNTID).FirstOrDefault().PRODUCTACCOUNTNUMBER,
                            productName = p.PRODUCTNAME,
                            productId = s.PRODUCTID,
                            productTypeName = p.TBL_PRODUCT_TYPE.PRODUCTTYPENAME,
                            customerId = b.CUSTOMERID,
                            customerCode = c.CUSTOMERCODE,
                            tenor = s.TENOR,
                            interestRate = (double)s.INTERESTRATE,
                            effectiveDate = b.EFFECTIVEDATE,
                            maturityDate = b.MATURITYDATE,
                            schemeId = s.DISBURSESCHEMEID,
                            loanApplicationDetailId = d.LOANAPPLICATIONDETAILID,
                            schemeName = s.SCHEMENAME,
                            schemeCode = s.SCHEMECODE,
                            interestRepaymentFrequencyName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == s.INTERESTFREQUENCYTYPEID).FirstOrDefault().MODE,
                            principalRepaymentFrequencyName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == s.PRINCIPALFREQUENCYTYPEID).FirstOrDefault().MODE,
                            repaymentScheduleMethodName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == s.SCHEDULEMETHODID).FirstOrDefault().SCHEDULETYPENAME,

                        }).ToList();

            return data;
        }



        public List<multipleDisbursementOutputViewModel> startBulkLoanDisbursement(List<multipleDisbursementOutputViewModel> models, UserInfo user)
        {
            using (var trans = context.Database.BeginTransaction())
            {
                var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(models.FirstOrDefault().loanApplicationDetailId);
                if (applicationDetail != null)
                {
                    var recResponse = loanApp.SaveRac(models.FirstOrDefault().rac, (int)models.FirstOrDefault().rac?.operationId, (int)models.FirstOrDefault().rac.productId, models.FirstOrDefault().rac.productClassId, models.FirstOrDefault().loanApplicationDetailId, user.createdBy, applicationDetail.LOANAPPLICATIONID);
                    if (recResponse == null) throw new ConditionNotMetException("Risk Acceptance Criteria failed");
                }

                List<TBL_LOAN> loanTable = new List<TBL_LOAN>();
                foreach (var customerRequest in models)
                {
                    if (customerRequest.passed == true && customerRequest.shouldDisburse == true)
                    {
                        LoanViewModel loan = new LoanViewModel();
                        var scheme = context.TBL_LOAN_BULK_DISBURSE_SCHEME.Where(x => x.SCHEMECODE == customerRequest.schemeCode).FirstOrDefault();
                        loan = buildLoanModel(customerRequest, scheme, user);

                        if (context.TBL_LOAN_BOOKING_REQUEST.Where(x => x.LOANAPPLICATIONDETAILID == customerRequest.loanApplicationDetailId && x.APPROVALSTATUSID != (short)ApprovalStatusEnum.Approved && x.APPROVALSTATUSID != (short)ApprovalStatusEnum.Disapproved).Any())
                        {
                            throw new ConditionNotMetException("This facility already has a running tranche disbursement request currently undergoing approval.");
                        }
                        else
                        {
                            var facilityTypeId = context.TBL_PRODUCT.Where(x => x.PRODUCTID == customerRequest.productId).Select(x => x.PRODUCTTYPEID).FirstOrDefault();
                            List<int> facilityRequestIds = context.TBL_LOAN_BOOKING_REQUEST.Where(x => x.LOANAPPLICATIONDETAILID == customerRequest.loanApplicationDetailId).Select(x => x.LOAN_BOOKING_REQUESTID).ToList();
                            if (facilityTypeId == (short)LoanProductTypeEnum.RevolvingLoan)
                            {
                                if (context.TBL_LOAN_REVOLVING.Where(x => x.LOANSTATUSID == (short)LoanStatusEnum.Inactive
                                 && facilityRequestIds.Contains(x.LOAN_BOOKING_REQUESTID.Value)).Any())
                                {
                                    throw new ConditionNotMetException("This facility already has a running tranche disbursement request currently undergoing approval.");
                                }
                            }
                            if (facilityTypeId == (short)LoanProductTypeEnum.ContingentLiability)
                            {
                                if (context.TBL_LOAN_CONTINGENT.Where(x => x.LOANSTATUSID == (short)LoanStatusEnum.Inactive
                                 && facilityRequestIds.Contains(x.LOAN_BOOKING_REQUESTID.Value)).Any())
                                {
                                    throw new ConditionNotMetException("This facility already has a running tranche disbursement request currently undergoing approval.");
                                }
                            }
                            if (facilityTypeId != (short)LoanProductTypeEnum.ContingentLiability && facilityTypeId != (short)LoanProductTypeEnum.RevolvingLoan)
                            {
                                if (context.TBL_LOAN.Where(x => x.LOANSTATUSID == (short)LoanStatusEnum.Inactive
                                 && facilityRequestIds.Contains(x.LOAN_BOOKING_REQUESTID.Value)).Any())
                                {
                                    throw new ConditionNotMetException("This facility already has a running tranche disbursement request currently undergoing approval.");
                                }
                            }
                        }

                        var request = addBookingRequest(customerRequest, (short)ApprovalStatusEnum.Approved, user);
                        loan.loanBookingRequestId = request.LOAN_BOOKING_REQUESTID;

                        var loanData = addLoan(loan);

                        try
                        {
                            loanTable.Add(loanData);
                        }
                        catch (Exception ex)
                        {
                            customerRequest.passed = false;
                            customerRequest.errorMessages.Add("Error occured saving loan");
                        }
                    }
                }

                context.SaveChanges();

                trans.Commit();

                return models;
            }
        }

        public bool saveBulkLoanDisbursementEntries(List<multipleDisbursementOutputViewModel> models, UserInfo user)
        {
            List<TBL_LOAN_BULK_DISBURSEMENT> bulkLoanTable = new List<TBL_LOAN_BULK_DISBURSEMENT>();
            foreach (var customerRequest in models)
            {
                if (customerRequest.passed == true && customerRequest.shouldDisburse == true)
                {
                    var scheme = context.TBL_LOAN_BULK_DISBURSE_SCHEME.Where(x => x.SCHEMECODE == customerRequest.schemeCode).FirstOrDefault();
                    var loanData = addBulkLoan(customerRequest);

                    bulkLoanTable.Add(loanData);
                }
            }
            context.TBL_LOAN_BULK_DISBURSEMENT.AddRange(bulkLoanTable);
            return context.SaveChanges() > 0;
        }


        public WorkflowResponse saveBulkInsurancePolicyEntries(List<MultipleInsuranceOutputViewModel> models, UserInfo user)
        {
            try
            {
                List<TEMP_COLLATERAL_INSURANCE_TRACKING> bulkPolicyTable = new List<TEMP_COLLATERAL_INSURANCE_TRACKING>();
                var batchCode = CommonHelpers.GenerateRandomDigitCode(10);
                List<int?> policyNumbers = new List<int?>();
               using (TransactionScope transactionScope = new TransactionScope())
                {
                    foreach (var policyRequest in models)
                    {
                        policyNumbers.Add(policyRequest.policyId);
                        policyRequest.batchCode = batchCode;
                        if (policyRequest.isCollateral.ToLower() != "" && (policyRequest.isCollateral.ToLower() == "no" || policyRequest.isCollateral.ToLower() == "yes"))
                        {
                            if (policyRequest.passed == true)
                            {
                                var collateralDetail = context.TBL_COLLATERAL_CUSTOMER.Where(x => x.COLLATERALCODE == policyRequest.collateralCode).FirstOrDefault();
                                if (collateralDetail != null)
                                {
                                    policyRequest.collateralCustomerId = collateralDetail.COLLATERALCUSTOMERID;
                                    policyRequest.collateralDetails = collateralDetail.COLLATERALSUMMARY;
                                    policyRequest.collateralSubTypeId = collateralDetail.COLLATERALSUBTYPEID;
                                    policyRequest.collateralTypeId = collateralDetail.COLLATERALTYPEID;
                                }
                            }
                            var confirmIfRecordAlreadyExist = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Where(t => t.COLLATERALCUSTOMERID == policyRequest.collateralCustomerId).FirstOrDefault();
                            if (confirmIfRecordAlreadyExist == null)
                            {
                                if (policyRequest.expiryDate.Value.Date > DateTime.Now.Date)
                                {
                                    policyRequest.insuranceStatus = (int)InsuranceStatusEnum.Active;
                                }
                                else { policyRequest.insuranceStatus = (int)InsuranceStatusEnum.Expired; }

                                var insurancePolicyTypeDetail = context.TBL_INSURANCE_POLICY_TYPE.Where(x => x.DESCRIPTION == policyRequest.policyType.ToLower()).FirstOrDefault();
                                if (insurancePolicyTypeDetail != null)
                                {
                                    policyRequest.insurancePolicyTypeId = insurancePolicyTypeDetail.POLICYTYPEID;
                                }
                                else
                                {
                                    insurancePolicyTypeDetail = context.TBL_INSURANCE_POLICY_TYPE.Where(x => policyRequest.policyType.ToLower().Contains(x.DESCRIPTION.ToLower())).FirstOrDefault();
                                    if (insurancePolicyTypeDetail != null) policyRequest.insurancePolicyTypeId = insurancePolicyTypeDetail.POLICYTYPEID;
                                    
                                }
                                policyRequest.dateTimeCreated = DateTime.Now;
                                policyRequest.createdBy = user.createdBy;

                                var policyData = addBulkPolicy(policyRequest);
                                bulkPolicyTable.Add(policyData);

                            }
                        }
                        else
                        {
                            policyRequest.collateralCustomerId = null;
                            policyRequest.collateralDetails = policyRequest.collateralDescription;
                            policyRequest.collateralSubTypeId = null;
                            policyRequest.collateralTypeId = (int)CollateralTypeEnum.InsurancePolicy;
                            policyRequest.insuranceStatus = (int)InsuranceStatusEnum.Active;
                            var insurancePolicyTypeDetail = context.TBL_INSURANCE_POLICY_TYPE.Where(x => policyRequest.policyType.ToLower().Contains(x.DESCRIPTION.ToLower())).FirstOrDefault();
                            if (insurancePolicyTypeDetail != null)
                            {
                                policyRequest.insurancePolicyTypeId = insurancePolicyTypeDetail.POLICYTYPEID;
                            }

                            policyRequest.dateTimeCreated = DateTime.Now;
                            policyRequest.createdBy = user.createdBy;
                            var policyData = addBulkPolicy(policyRequest);
                            bulkPolicyTable.Add(policyData);
                        }
                    }
                    context.TEMP_COLLATERAL_INSURANCE_TRACKING.AddRange(bulkPolicyTable);
                    if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

                    TBL_BULK_INSURANCE_UPLOAD_APPROVAL insuranceOperation = new TBL_BULK_INSURANCE_UPLOAD_APPROVAL();
                    insuranceOperation = context.TBL_BULK_INSURANCE_UPLOAD_APPROVAL.Add(new TBL_BULK_INSURANCE_UPLOAD_APPROVAL
                    {
                        CREATEDBY = user.createdBy,
                        BATCHCODE = batchCode,
                        APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                        OPERATIONID = (int)OperationsEnum.InsuranceBulkUploadApproval,
                        REQUESTDATE = DateTime.Now
                    });
                    if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");


                    workflow.StaffId = user.createdBy;
                    workflow.CompanyId = user.companyId;
                    workflow.StatusId = (int)ApprovalStatusEnum.Processing;
                    workflow.TargetId = insuranceOperation.BULKINSURANCEUPLOADAPPROVALID;
                    workflow.Comment = "Kindly help approve the insurance bulk upload";
                    workflow.OperationId = (int)OperationsEnum.InsuranceBulkUploadApproval;
                    workflow.DeferredExecution = true;
                    workflow.ExternalInitialization = false;

                    var response = workflow.LogActivity();
                    context.SaveChanges();

                    transactionScope.Complete();
                    transactionScope.Dispose();
                }

                auditTrail.AddAuditTrail(new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.InsuranceBulkUpload,
                    STAFFID = user.createdBy,
                    BRANCHID = (short)user.BranchId,
                    DETAIL = $"Insurance policy has benen bulk uploaded with the following details: 'batch code:' '{ batchCode}'",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = user.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                });

                context.SaveChanges();
                return workflow.Response;

            }catch(Exception ex)
            {
                throw ex;
            }
        }

        public bool saveBulkLoanAssignmentToAgent(List<GlobalExposureApplicationViewModel> models, int accreditedConsultant, DateTime? expCompletionDate, string source, string assignmentType, UserInfo user)
        {
            bool result = false;
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);

            List<TBL_LOAN_RECOVERY_ASSIGNMENT> bulkLoanTable = new List<TBL_LOAN_RECOVERY_ASSIGNMENT>();
            if (models == null || accreditedConsultant == 0 || expCompletionDate == null)
            {
                throw new ConditionNotMetException("Kindly select an accredited consultant/expected completion date is empty.");
            }
            
                    foreach(var i in models)
                    {
                        var validate = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.ACCREDITEDCONSULTANT == accreditedConsultant
                                                                      && x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Approved
                                                                      && x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Disapproved
                                                                      && x.DELETED == false
                                                                      && x.APPLICATIONREFERENCENUMBER == i.applicationReferenceNumber
                                                                      ).ToList();
                        if (validate != null && validate.Count() > 0)
                        {
                            throw new SecureException("Request already exist and undergoing approval");
                        }

                    }
                

                GlobalExposureApplicationViewModel assignOperations = new GlobalExposureApplicationViewModel();

                foreach (var customerRequest in models)
                {
                    assignOperations.createdBy = user.createdBy;
                    assignOperations.accreditedConsultant = accreditedConsultant;
                    assignOperations.loanReferenceNumber = customerRequest.loanReferenceNumber;
                    assignOperations.expCompletionDate = expCompletionDate;
                    assignOperations.referenceId = referenceNumber;
                    assignOperations.approvalStatusId = (int)ApprovalStatusEnum.Processing;
                    assignOperations.operationId = (int)OperationsEnum.RetailRecoveryAssignmentApproval;
                    assignOperations.operationCompleted = false;
                    assignOperations.totalAmountRecovery = customerRequest.totalUnsettledAmount == null ?  customerRequest.totalAmountRecovery : (decimal)customerRequest.totalUnsettledAmount; 
                    assignOperations.source = source;
                    assignOperations.productId = customerRequest.productId;
                    assignOperations.loanId = customerRequest.loanId;
                    assignOperations.assignmentType = assignmentType;
                    assignOperations.customerId = customerRequest.customerCode == null ? customerRequest.customerId : customerRequest.customerCode;
                    assignOperations.productClassId = customerRequest.productClassId;
                    assignOperations.applicationReferenceNumber = customerRequest.applicationReferenceNumber;
                    assignOperations.isDigital = customerRequest.isDigital;
                    var loanData = addBulkLoanAssignmentToAgent(assignOperations);
                    bulkLoanTable.Add(loanData);
                }
            
                 context.TBL_LOAN_RECOVERY_ASSIGNMENT.AddRange(bulkLoanTable);
                 if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");
            
                TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL removeLienOperation = new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL();
                removeLienOperation = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Add(new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                {
                    ACCREDITEDCONSULTANTID = accreditedConsultant,
                    REFERENCEBATCHID = referenceNumber,
                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                    OPERATIONID = (int)OperationsEnum.RetailRecoveryAssignmentApproval,
                    REQUESTDATE = DateTime.Now,
                    SOURCE = source,
                    ASSIGNMENTTYPE = assignmentType
                });
                if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

            using (TransactionScope transactionScope = new TransactionScope())
            {

                    workflow.StaffId = user.createdBy;
                    workflow.CompanyId = user.companyId;
                    workflow.StatusId = (int)ApprovalStatusEnum.Processing;
                    workflow.TargetId = removeLienOperation.BULKRECOVERYAPPROVALID;
                    workflow.Comment = "Kindly help approve the loan recovery assignment to agent";
                    workflow.OperationId = (int)OperationsEnum.RetailRecoveryAssignmentApproval;
                    workflow.DeferredExecution = true;
                    workflow.ExternalInitialization = false;

                    var response = workflow.LogActivity();
                        context.SaveChanges();
                
                transactionScope.Complete();

                transactionScope.Dispose();
            }

            auditTrail.AddAuditTrail(new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryAssignment,
                    STAFFID = user.createdBy,
                    BRANCHID = (short)user.BranchId,
                    DETAIL = $"Added TBL_LOAN_RECOVERY_ASSIGNMENT '{ referenceNumber}' ",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = user.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                });

                int resultStatus = context.SaveChanges();
                if (resultStatus > 0)
                {
                    result = true;
                }

                return result;
           
        }


        public bool saveBulkLoanAssignmentToAgentRem(List<GlobalExposureApplicationViewModel> models, int accreditedConsultant, DateTime? expCompletionDate, string source, string assignmentType, UserInfo user)
        {
            
                bool result = false;
                var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);

                List<TBL_LOAN_RECOVERY_ASSIGNMENT> bulkLoanTable = new List<TBL_LOAN_RECOVERY_ASSIGNMENT>();
                if (models == null || accreditedConsultant == 0 || expCompletionDate == null)
                {
                    throw new ConditionNotMetException("Kindly select an accredited consultant/expected completion date is empty.");
                }

                GlobalExposureApplicationViewModel assignOperations = new GlobalExposureApplicationViewModel();

                foreach (var customerRequest in models)
                {
                    assignOperations.createdBy = user.createdBy;
                    assignOperations.applicationReferenceNumber = customerRequest.loanReferenceNumber;
                    assignOperations.accreditedConsultant = accreditedConsultant;
                    assignOperations.loanReferenceNumber = customerRequest.loanReferenceNumber;
                    assignOperations.expCompletionDate = expCompletionDate;
                    assignOperations.referenceId = referenceNumber;
                    assignOperations.approvalStatusId = (int)ApprovalStatusEnum.Pending;
                    assignOperations.operationId = (int)OperationsEnum.AssignRecoveryLoansToAgent;
                    assignOperations.operationCompleted = false;
                    assignOperations.totalAmountRecovery = customerRequest.totalAmountRecovery;
                    assignOperations.source = source;
                    assignOperations.productId = customerRequest.productId;
                    assignOperations.loanId = customerRequest.loanId;
                    assignOperations.assignmentType = assignmentType;
                    assignOperations.customerId = customerRequest.customerId;
                    var loanData = addBulkLoanAssignmentToAgent(assignOperations);
                    bulkLoanTable.Add(loanData);
                }

                context.TBL_LOAN_RECOVERY_ASSIGNMENT.AddRange(bulkLoanTable);
                if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

                TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL removeLienOperation = new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL();
                removeLienOperation = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Add(new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                {
                    ACCREDITEDCONSULTANTID = accreditedConsultant,
                    REFERENCEBATCHID = referenceNumber,
                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,
                    OPERATIONID = (int)OperationsEnum.AssignRecoveryLoansToAgent,
                    REQUESTDATE = DateTime.Now,
                    SOURCE = source,
                    ASSIGNMENTTYPE = assignmentType
                });
                if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

                auditTrail.AddAuditTrail(new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryAssignment,
                    STAFFID = user.createdBy,
                    BRANCHID = (short)user.BranchId,
                    DETAIL = $"Added TBL_LOAN_RECOVERY_ASSIGNMENT '{ referenceNumber}' ",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = user.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                });

                int resultStatus = context.SaveChanges();
                if (resultStatus > 0)
                {
                    result = true;
                }

                return result;
        }

        public bool saveBulkLoanReAssignmentToAgentRem(LoanRecoveryAssignmentViewModel model, UserInfo user)
        {

            bool result = false;
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);

            if (model == null)
            {
                throw new ConditionNotMetException("Kindly select an accredited consultant.");
            }

            try
            {
                TBL_LOAN_RECOVERY_ASSIGNMENT assignOperations = new TBL_LOAN_RECOVERY_ASSIGNMENT();
                var validate = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(model.loanAssignId);

                assignOperations.CREATEDBY = user.createdBy;
                assignOperations.ACCREDITEDCONSULTANT = model.accreditedConsultant;
                assignOperations.LOANREFERENCE = validate.LOANREFERENCE;
                assignOperations.APPLICATIONREFERENCENUMBER = validate.LOANREFERENCE;
                assignOperations.EXPCOMPLETIONDATE = model.expCompletionDate;
                assignOperations.REFERENCEID = referenceNumber;
                assignOperations.APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending;
                assignOperations.OPERATIONID = (int)OperationsEnum.AssignRecoveryLoansToAgent;
                assignOperations.OPERATIONCOMPLETED = false;
                assignOperations.TOTALAMOUNTRECOVERY = validate.TOTALAMOUNTRECOVERY;
                assignOperations.SOURCE = model.source;
                assignOperations.PRODUCTID = validate.PRODUCTID;
                assignOperations.LOANID = validate.LOANID;
                assignOperations.ASSIGNMENTTYPE = validate.ASSIGNMENTTYPE;
                assignOperations.CUSTOMERID = validate.CUSTOMERID;
                assignOperations.DATEASSIGNED = DateTime.Now;
                context.TBL_LOAN_RECOVERY_ASSIGNMENT.Add(assignOperations);
                if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");
            }catch(Exception ex)
            {
                throw ex;
            }
            TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL removeLienOperation = new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL();
            removeLienOperation = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Add(new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
            {
                ACCREDITEDCONSULTANTID = model.accreditedConsultant,
                REFERENCEBATCHID = referenceNumber,
                APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,
                OPERATIONID = (int)OperationsEnum.AssignRecoveryLoansToAgent,
                REQUESTDATE = DateTime.Now,
                SOURCE = model.source,
                ASSIGNMENTTYPE = "MANUAL"
            });
            if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

            var flagDelete = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(model.loanAssignId);
            flagDelete.DELETED = true;
            flagDelete.DELETEDBY = user.createdBy;
            flagDelete.DATETIMEDELETED = DateTime.Now;

            auditTrail.AddAuditTrail(new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryAssignment,
                STAFFID = user.createdBy,
                BRANCHID = (short)user.BranchId,
                DETAIL = $"Added TBL_LOAN_RECOVERY_ASSIGNMENT '{ referenceNumber}' ",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = user.applicationUrl,
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName()
            });

            int resultStatus = context.SaveChanges();
            if (resultStatus > 0)
            {
                result = true;
            }

            return result;
        }


        public WorkflowResponse saveBulkLoanReAssignmentToAgent(GlobalExposureApplicationViewModel model, UserInfo user)
        {
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);

            List<TBL_LOAN_RECOVERY_ASSIGNMENT> bulkLoanTable = new List<TBL_LOAN_RECOVERY_ASSIGNMENT>();
            if (model == null)
            {
                throw new ConditionNotMetException("Kindly select an accredited consultant.");
            }

            using (var trans = context.Database.BeginTransaction())
            {
                    var validate = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(model.loanAssignId);
                    validate.CREATEDBY = user.createdBy;
                    validate.ACCREDITEDCONSULTANT = model.accreditedConsultant;
                    validate.EXPCOMPLETIONDATE = model.expCompletionDate;
                    validate.REFERENCEID = referenceNumber;
                    validate.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    validate.OPERATIONID = (int)OperationsEnum.RetailRecoveryAssignmentApproval;
                    validate.OPERATIONCOMPLETED = false;
                    validate.SOURCE = model.source;
                    context.TBL_LOAN_RECOVERY_ASSIGNMENT.Add(validate);
                    context.SaveChanges();

                    TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL removeLienOperation = new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL();
                    removeLienOperation = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Add(new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                    {
                        ACCREDITEDCONSULTANTID = model.accreditedConsultant,
                        REFERENCEBATCHID = referenceNumber,
                        APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                        OPERATIONID = (int)OperationsEnum.RetailRecoveryAssignmentApproval,
                        REQUESTDATE = DateTime.Now,
                        SOURCE = model.source,
                        ASSIGNMENTTYPE = "MANUAL"
            });
                   context.SaveChanges();

                var flagDelete = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(model.loanAssignId);
                    flagDelete.DELETED = true;
                    flagDelete.DELETEDBY = user.createdBy;
                    flagDelete.DATETIMEDELETED = DateTime.Now;

                    var approval = new ApprovalViewModel
                    {
                        staffId = user.createdBy,
                        companyId = user.companyId,
                        approvalStatusId = (short)ApprovalStatusEnum.Processing,
                        comment = "Kindly help approve the recovery assignment",
                        targetId = removeLienOperation.BULKRECOVERYAPPROVALID,
                        operationId = removeLienOperation.OPERATIONID,
                        BranchId = user.BranchId,
                        deferredExecution = false
                    };

                    workflow.LogForApproval(approval);

                    auditTrail.AddAuditTrail(new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryAssignment,
                        STAFFID = user.createdBy,
                        BRANCHID = (short)user.BranchId,
                        DETAIL = $"Added TBL_LOAN_RECOVERY_ASSIGNMENT '{ referenceNumber}' ",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = user.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    });

                context.SaveChanges();
                trans.Commit();
            }

            return workflow.Response;
        }


        public WorkflowResponse saveBulkLoanUnAssignmentToAgent(LoanRecoveryAssignmentViewModel model, UserInfo user)
        {

                var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);

                if (model == null)
                {
                throw new ConditionNotMetException("Kindly select at least one transaction.");
                }

                using (var trans = context.Database.BeginTransaction())
                {
                    var validate = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(model.loanAssignId);
                    validate.CREATEDBY = user.createdBy;
                    validate.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    validate.OPERATIONID = (int)OperationsEnum.UnAssignRecoveryLoansFromAgent;
                    context.SaveChanges();

                    TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL data = new TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL();
                    data = context.TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL.Add(new TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL
                    {
                        ACCREDITEDCONSULTANTID = validate.ACCREDITEDCONSULTANT,
                        REFERENCEBATCHID = validate.REFERENCEID,
                        APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                        OPERATIONID = (int)OperationsEnum.UnAssignRecoveryLoansFromAgent,
                        REQUESTDATE = DateTime.Now,
                        SOURCE = validate.SOURCE,
                        LOANID = validate.LOANASSIGNID
                        
                    });
                    context.SaveChanges();

                    var approval = new ApprovalViewModel
                    {
                        staffId = user.createdBy,
                        companyId = user.companyId,
                        approvalStatusId = (short)ApprovalStatusEnum.Processing,
                        comment = "Kindly help approve the recovery unassignment",
                        targetId = data.BULKRECOVERYUNASSIGNAPPROVALID,
                        operationId = data.OPERATIONID,
                        BranchId = user.BranchId,
                        deferredExecution = false
                    };

                    workflow.LogForApproval(approval);

                    auditTrail.AddAuditTrail(new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryAssignment,
                        STAFFID = user.createdBy,
                        BRANCHID = (short)user.BranchId,
                        DETAIL = $"Added TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL '{ referenceNumber}' ",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = user.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    });

                    context.SaveChanges();
                    trans.Commit();
                }

                return workflow.Response;
            }

        public WorkflowResponse saveRetailBulkLoanUnAssignmentToAgent(LoanRecoveryAssignmentViewModel model, UserInfo user)
        {

            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);

            if (model == null)
            {
                throw new ConditionNotMetException("Kindly select at least one transaction.");
            }

            using (var trans = context.Database.BeginTransaction())
            {
                var validate = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(model.loanAssignId);
                validate.CREATEDBY = user.createdBy;
                validate.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                validate.OPERATIONID = (int)OperationsEnum.UnAssignRetailRecoveryLoansFromAgent;
                context.SaveChanges();

                TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL data = new TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL();
                data = context.TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL.Add(new TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL
                {
                    ACCREDITEDCONSULTANTID = validate.ACCREDITEDCONSULTANT,
                    REFERENCEBATCHID = validate.REFERENCEID,
                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                    OPERATIONID = (int)OperationsEnum.UnAssignRetailRecoveryLoansFromAgent,
                    REQUESTDATE = DateTime.Now,
                    SOURCE = validate.SOURCE,
                    LOANID = validate.LOANASSIGNID

                });
                context.SaveChanges();

                var approval = new ApprovalViewModel
                {
                    staffId = user.createdBy,
                    companyId = user.companyId,
                    approvalStatusId = (short)ApprovalStatusEnum.Processing,
                    comment = "Kindly help approve the recovery unassignment",
                    targetId = data.BULKRECOVERYUNASSIGNAPPROVALID,
                    operationId = data.OPERATIONID,
                    BranchId = user.BranchId,
                    deferredExecution = false
                };

                workflow.LogForApproval(approval);

                auditTrail.AddAuditTrail(new TBL_AUDIT
                {
                    AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryAssignment,
                    STAFFID = user.createdBy,
                    BRANCHID = (short)user.BranchId,
                    DETAIL = $"Added TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL '{ referenceNumber}' ",
                    IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                    URL = user.applicationUrl,
                    APPLICATIONDATE = generalSetup.GetApplicationDate(),
                    SYSTEMDATETIME = DateTime.Now,
                    DEVICENAME = CommonHelpers.GetDeviceName(),
                    OSNAME = CommonHelpers.FriendlyName()
                });

                context.SaveChanges();
                trans.Commit();
            }

            return workflow.Response;
        }


        public WorkflowResponse saveMultipleLoanReAssignmentToAgent(List<GlobalExposureApplicationViewModel> model, UserInfo user, DateTime expCompletionDate, int accreditedConsultant, string source)
            {
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);

            List<TBL_LOAN_RECOVERY_ASSIGNMENT> bulkLoanTable = new List<TBL_LOAN_RECOVERY_ASSIGNMENT>();
            if (model == null)
            {
                throw new ConditionNotMetException("Kindly select an accredited consultant.");
            }

            using (var trans = context.Database.BeginTransaction())
            {
                foreach (var r in model)
                {
                    var validate = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(r.loanAssignId);
                    validate.CREATEDBY = user.createdBy;
                    validate.ACCREDITEDCONSULTANT = accreditedConsultant;
                    validate.EXPCOMPLETIONDATE = expCompletionDate;
                    validate.REFERENCEID = referenceNumber;
                    validate.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    validate.OPERATIONID = (int)OperationsEnum.AssignRecoveryLoansToAgent;
                    validate.OPERATIONCOMPLETED = false;
                    validate.SOURCE = source;
                    context.TBL_LOAN_RECOVERY_ASSIGNMENT.Add(validate);

                    TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL removeLienOperation = new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL();
                    removeLienOperation = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Add(new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                    {
                        ACCREDITEDCONSULTANTID = accreditedConsultant,
                        REFERENCEBATCHID = referenceNumber,
                        APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                        OPERATIONID = (int)OperationsEnum.AssignRecoveryLoansToAgent,
                        REQUESTDATE = DateTime.Now,
                        SOURCE = source,
                        ASSIGNMENTTYPE = "MANUAL"
                    });
                    context.SaveChanges();

                    var flagDelete = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(r.loanAssignId);
                    flagDelete.DELETED = true;
                    flagDelete.DELETEDBY = user.createdBy;
                    flagDelete.DATETIMEDELETED = DateTime.Now;

                    var approval = new ApprovalViewModel
                    {
                        staffId = user.createdBy,
                        companyId = user.companyId,
                        approvalStatusId = (short)ApprovalStatusEnum.Processing,
                        comment = "Kindly help approve the recovery assignment",
                        targetId = removeLienOperation.BULKRECOVERYAPPROVALID,
                        operationId = removeLienOperation.OPERATIONID,
                        BranchId = user.BranchId,
                        deferredExecution = false
                    };

                    workflow.LogForApproval(approval);

                    auditTrail.AddAuditTrail(new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryAssignment,
                        STAFFID = user.createdBy,
                        BRANCHID = (short)user.BranchId,
                        DETAIL = $"Added TBL_LOAN_RECOVERY_ASSIGNMENT '{ referenceNumber}' ",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = user.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    });
                }

                context.SaveChanges();
                trans.Commit();
            }

            return workflow.Response;
        }

        public WorkflowResponse saveMultipleRetailLoanReAssignmentToAgent(List<GlobalExposureApplicationViewModel> model, UserInfo user, DateTime expCompletionDate, int accreditedConsultant, string source)
        {
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);

            List<TBL_LOAN_RECOVERY_ASSIGNMENT> bulkLoanTable = new List<TBL_LOAN_RECOVERY_ASSIGNMENT>();
            if (model == null)
            {
                throw new ConditionNotMetException("Kindly select an accredited consultant.");
            }

            using (var trans = context.Database.BeginTransaction())
            {
                foreach (var r in model)
                {
                    var validate = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(r.loanAssignId);
                    validate.CREATEDBY = user.createdBy;
                    validate.ACCREDITEDCONSULTANT = accreditedConsultant;
                    validate.EXPCOMPLETIONDATE = expCompletionDate;
                    validate.REFERENCEID = referenceNumber;
                    validate.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    validate.OPERATIONID = (int)OperationsEnum.RetailRecoveryAssignmentApproval;
                    validate.OPERATIONCOMPLETED = false;
                    validate.SOURCE = source;
                    context.TBL_LOAN_RECOVERY_ASSIGNMENT.Add(validate);

                    TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL removeLienOperation = new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL();
                    removeLienOperation = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Add(new TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL
                    {
                        ACCREDITEDCONSULTANTID = accreditedConsultant,
                        REFERENCEBATCHID = referenceNumber,
                        APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                        OPERATIONID = (int)OperationsEnum.RetailRecoveryAssignmentApproval,
                        REQUESTDATE = DateTime.Now,
                        SOURCE = source,
                        ASSIGNMENTTYPE = "MANUAL"
                    });
                    context.SaveChanges();

                    var flagDelete = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(r.loanAssignId);
                    flagDelete.DELETED = true;
                    flagDelete.DELETEDBY = user.createdBy;
                    flagDelete.DATETIMEDELETED = DateTime.Now;

                    var approval = new ApprovalViewModel
                    {
                        staffId = user.createdBy,
                        companyId = user.companyId,
                        approvalStatusId = (short)ApprovalStatusEnum.Processing,
                        comment = "Kindly help approve the recovery assignment",
                        targetId = removeLienOperation.BULKRECOVERYAPPROVALID,
                        operationId = removeLienOperation.OPERATIONID,
                        BranchId = user.BranchId,
                        deferredExecution = false
                    };

                    workflow.LogForApproval(approval);

                    auditTrail.AddAuditTrail(new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryAssignment,
                        STAFFID = user.createdBy,
                        BRANCHID = (short)user.BranchId,
                        DETAIL = $"Added TBL_LOAN_RECOVERY_ASSIGNMENT '{ referenceNumber}' ",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = user.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    });
                }

                context.SaveChanges();
                trans.Commit();
            }

            return workflow.Response;
        }


        public WorkflowResponse saveMultipleLoanUnAssignmentToAgent(List<GlobalExposureApplicationViewModel> model, UserInfo user)
        {

            if (model == null)
            {
                throw new ConditionNotMetException("Kindly select at least one transaction.");
            }

            using (var trans = context.Database.BeginTransaction())
            {
                foreach (var r in model)
                {
                    var validate = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(r.loanAssignId);
                    validate.CREATEDBY = user.createdBy;
                    validate.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    validate.OPERATIONID = (int)OperationsEnum.UnAssignRecoveryLoansFromAgent;

                    TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL data = new TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL();
                    data = context.TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL.Add(new TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL
                    {
                        ACCREDITEDCONSULTANTID = validate.ACCREDITEDCONSULTANT,
                        REFERENCEBATCHID = validate.REFERENCEID,
                        APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                        OPERATIONID = (int)OperationsEnum.UnAssignRecoveryLoansFromAgent,
                        REQUESTDATE = DateTime.Now,
                        SOURCE = validate.SOURCE,
                        LOANID = validate.LOANASSIGNID
                    });
                    context.SaveChanges();

                    var approval = new ApprovalViewModel
                    {
                        staffId = user.createdBy,
                        companyId = user.companyId,
                        approvalStatusId = (short)ApprovalStatusEnum.Processing,
                        comment = "Kindly help approve the recovery unassignment",
                        targetId = data.BULKRECOVERYUNASSIGNAPPROVALID,
                        operationId = data.OPERATIONID,
                        BranchId = user.BranchId,
                        deferredExecution = false
                    };

                    workflow.LogForApproval(approval);

                    auditTrail.AddAuditTrail(new TBL_AUDIT
                    {
                        AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryAssignment,
                        STAFFID = user.createdBy,
                        BRANCHID = (short)user.BranchId,
                        DETAIL = $"Added TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL '{ validate.REFERENCEID}' ",
                        IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                        URL = user.applicationUrl,
                        APPLICATIONDATE = generalSetup.GetApplicationDate(),
                        SYSTEMDATETIME = DateTime.Now,
                        DEVICENAME = CommonHelpers.GetDeviceName(),
                        OSNAME = CommonHelpers.FriendlyName()
                    });

                    context.SaveChanges();
                }

               
                trans.Commit();
            }

            return workflow.Response;
        }

        public WorkflowResponse saveMultipleRetailLoanUnAssignmentToAgent(List<GlobalExposureApplicationViewModel> model, UserInfo user)
        {
            
                if (model == null)
                {
                    throw new ConditionNotMetException("Kindly select at least one transaction.");
                }

                using (var trans = context.Database.BeginTransaction())
                {
                    foreach (var r in model)
                    {
                        var validate = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(r.loanAssignId);
                        validate.CREATEDBY = user.createdBy;
                        validate.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                        validate.OPERATIONID = (int)OperationsEnum.UnAssignRetailRecoveryLoansFromAgent;

                        TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL data = new TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL();
                        data = context.TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL.Add(new TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL
                        {
                            ACCREDITEDCONSULTANTID = validate.ACCREDITEDCONSULTANT,
                            REFERENCEBATCHID = validate.REFERENCEID,
                            APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing,
                            OPERATIONID = (int)OperationsEnum.UnAssignRetailRecoveryLoansFromAgent,
                            REQUESTDATE = DateTime.Now,
                            SOURCE = validate.SOURCE,
                            LOANID = validate.LOANASSIGNID
                        });
                        context.SaveChanges();

                        var approval = new ApprovalViewModel
                        {
                            staffId = user.createdBy,
                            companyId = user.companyId,
                            approvalStatusId = (short)ApprovalStatusEnum.Processing,
                            comment = "Kindly help approve the recovery unassignment",
                            targetId = data.BULKRECOVERYUNASSIGNAPPROVALID,
                            operationId = data.OPERATIONID,
                            BranchId = user.BranchId,
                            deferredExecution = false
                        };

                        workflow.LogForApproval(approval);

                        auditTrail.AddAuditTrail(new TBL_AUDIT
                        {
                            AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryAssignment,
                            STAFFID = user.createdBy,
                            BRANCHID = (short)user.BranchId,
                            DETAIL = $"Added TBL_BULK_RECOVERY_UNASSIGNMENT_AGENT_APPROVAL '{ validate.REFERENCEID}' ",
                            IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                            URL = user.applicationUrl,
                            APPLICATIONDATE = generalSetup.GetApplicationDate(),
                            SYSTEMDATETIME = DateTime.Now,
                            DEVICENAME = CommonHelpers.GetDeviceName(),
                            OSNAME = CommonHelpers.FriendlyName()
                        });

                        context.SaveChanges();
                    }


                    trans.Commit();
                }

                return workflow.Response;
            
        }

        public WorkflowResponse bulkLoanAssignmentToAgentGoForApproval(GlobalExposureApplicationViewModel models, UserInfo user)
        {
            
            if (models == null || models.accreditedConsultant == 0)
            {
                throw new ConditionNotMetException("Kindly select an accredited consultant/agent.");
            }

            var validate = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Where(x => x.REFERENCEBATCHID == models.referenceId
                                                          && (x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Pending
                                                          || x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Disapproved)
                                                          ).FirstOrDefault();
            if (validate != null)
            {
                throw new SecureException("Request already exist and undergoing approval");
            }

            using (TransactionScope transactionScope = new TransactionScope())
            {

                if (validate == null)
                {
                    var data = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Where(x => x.REFERENCEID == models.referenceId && x.DELETED == false).FirstOrDefault();
                    data.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;

                    var data2 = context.TBL_BULK_RECOVERY_ASSIGNMENT_AGENT_APPROVAL.Where(x => x.REFERENCEBATCHID == models.referenceId).FirstOrDefault();
                    data2.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;

                    workflow.StaffId = user.createdBy;
                    workflow.CompanyId = user.companyId;
                    workflow.StatusId = (int)ApprovalStatusEnum.Processing;
                    workflow.TargetId = data2.BULKRECOVERYAPPROVALID;
                    workflow.Comment = "Kindly help approve the loan recovery assign to agent";
                    workflow.OperationId = (int)OperationsEnum.AssignRecoveryLoansToAgent;
                    workflow.DeferredExecution = true;
                    workflow.ExternalInitialization = false;

                    workflow.LogActivity();
                }
                context.SaveChanges();
                transactionScope.Complete();

                transactionScope.Dispose();

            }
            return workflow.Response;
        }

        public int AddCollateralLiquidationRecovery(CollateralLiquidationRecoveryViewModel model, byte[] buffer)
        {
            bool isFullyRecovered = false;
            decimal outstandingAmount = 0;
            if (model.recoveredAmount > model.totalRecoveryAmount)
            {
                throw new SecureException("Sorry, the recovered amount cannot be greater then the total outstanding balance");
            }

            var update = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(model.loanAssignId);

            if (model.totalRecoveryAmount == model.recoveredAmount)
            {
                outstandingAmount = 0;
                isFullyRecovered = true;
                update.ISFULLYRECOVERED = true;
                context.SaveChanges();
            }
            else
            {
                outstandingAmount = (model.totalRecoveryAmount - model.recoveredAmount);
                isFullyRecovered = false;
                update.TOTALAMOUNTRECOVERY = outstandingAmount;
                context.SaveChanges();
            }
            var existing = context.TBL_COLLATERAL_LIQUIDATION_RECOVERY.Where(x => x.FILENAME == model.fileName)
            .Select(x => new CollateralLiquidationRecoveryViewModel
            {
                collateralLiquidationRecoveryId = x.COLLATERALLIQUIDATIONRECOVERYID,
                loanId = x.LOANID,
                applicationReferenceNumber = x.APPLICATIONREFERENCENUMBER,
                customerId = x.CUSTOMERID,
                accreditedConsultant = x.ACCREDITEDCONSULTANT,
                isFullyRecovered = x.ISFULLYRECOVERED,
                fileData = x.FILEDATA,
                fileName = x.FILENAME,
                fileExtension = x.FILEEXTENSION,
                fileSize = x.FILESIZE,
                fileSizeUnit = x.FILESIZEUNIT,
                receiptDate = x.RECEIPTDATE,
                totalRecoveryAmount = x.TOTALRECOVERYAMOUNT,
                recoveredAmount = x.RECOVEREDAMOUNT,
                outstandingAmount = x.OUTSTANDINGAMOUNT,
                collateralCode = x.COLLATERALCODE,
                collectionMode = x.COLLECTIONMODE,
                createdBy = x.CREATEDBY,
                dateTimeCreated = x.DATETIMECREATED,
                loanAssignId = x.LOANASSIGNID,
                percentageCommission = x.PERCENTAGECOMMISSION,
                loanReference = x.LOANREFERENCE,
            }).FirstOrDefault();

            if (existing != null && model.overwrite == false) return 3;

            var entity = new TBL_COLLATERAL_LIQUIDATION_RECOVERY
            {
                FILENAME = model.fileName,
                FILEEXTENSION = model.fileExtension.ToLower(),
                FILESIZE = model.fileSize,
                FILESIZEUNIT = model.fileSizeUnit,
                FILEDATA = buffer,
                CREATEDBY = model.createdBy,
                DATETIMECREATED = DateTime.Now,
                LOANID = model.loanId,
                APPLICATIONREFERENCENUMBER = model.applicationReferenceNumber,
                CUSTOMERID = model.customerId,
                ACCREDITEDCONSULTANT = model.accreditedConsultant,
                ISFULLYRECOVERED = isFullyRecovered,
                RECEIPTDATE = model.receiptDate,
                TOTALRECOVERYAMOUNT = model.totalRecoveryAmount,
                RECOVEREDAMOUNT = model.recoveredAmount,
                OUTSTANDINGAMOUNT = outstandingAmount,
                COLLATERALCODE = model.collateralCode,
                COLLECTIONMODE = model.collectionMode,
                LOANASSIGNID = model.loanAssignId,
                PERCENTAGECOMMISSION = model.percentageCommission,
                LOANREFERENCE = model.loanReference
            };

            context.TBL_COLLATERAL_LIQUIDATION_RECOVERY.Add(entity);
            context.SaveChanges();
            return 2;
        }

        public int AddCollateralLiquidationRecoveryWithoutFile(CollateralLiquidationRecoveryViewModel model)
        {
            bool isFullyRecovered = false;
            decimal outstandingAmount = 0;

            if (model.recoveredAmount > model.totalRecoveryAmount)
            {
                throw new SecureException("Sorry, the recovered amount cannot be greater then the total outstanding balance");
            }

            var update = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(model.loanAssignId);

            if (model.totalRecoveryAmount == model.recoveredAmount)
            {
                outstandingAmount = 0;
                isFullyRecovered = true;
                update.ISFULLYRECOVERED = true;
                update.TOTALAMOUNTRECOVERY = 0;
                context.SaveChanges();
            }
            else
            {
                outstandingAmount = (model.totalRecoveryAmount - model.recoveredAmount);
                isFullyRecovered = false;
                update.TOTALAMOUNTRECOVERY = outstandingAmount;
                context.SaveChanges();
            }
            var existing = context.TBL_COLLATERAL_LIQUIDATION_RECOVERY.Where(x => x.FILENAME == model.fileName && x.FILEDATA != null)
            .Select(x => new CollateralLiquidationRecoveryViewModel
            {
                collateralLiquidationRecoveryId = x.COLLATERALLIQUIDATIONRECOVERYID,
                loanId = x.LOANID,
                applicationReferenceNumber = x.APPLICATIONREFERENCENUMBER,
                customerId = x.CUSTOMERID,
                accreditedConsultant = x.ACCREDITEDCONSULTANT,
                isFullyRecovered = x.ISFULLYRECOVERED,
                fileData = x.FILEDATA,
                fileName = x.FILENAME,
                fileExtension = x.FILEEXTENSION,
                fileSize = x.FILESIZE,
                fileSizeUnit = x.FILESIZEUNIT,
                receiptDate = x.RECEIPTDATE,
                totalRecoveryAmount = x.TOTALRECOVERYAMOUNT,
                recoveredAmount = x.RECOVEREDAMOUNT,
                outstandingAmount = x.OUTSTANDINGAMOUNT,
                collateralCode = x.COLLATERALCODE,
                collectionMode = x.COLLECTIONMODE,
                createdBy = x.CREATEDBY,
                dateTimeCreated = x.DATETIMECREATED,
                loanAssignId = x.LOANASSIGNID,
                percentageCommission = x.PERCENTAGECOMMISSION,
                loanReference = x.LOANREFERENCE,
            }).FirstOrDefault();

            if (existing != null && model.overwrite == false) return 3;

            var entity = new TBL_COLLATERAL_LIQUIDATION_RECOVERY
            {
                CREATEDBY = model.createdBy,
                DATETIMECREATED = DateTime.Now,
                LOANID = model.loanId,
                APPLICATIONREFERENCENUMBER = model.applicationReferenceNumber,
                CUSTOMERID = model.customerId,
                ACCREDITEDCONSULTANT = model.accreditedConsultant,
                ISFULLYRECOVERED = isFullyRecovered,
                RECEIPTDATE = model.receiptDate,
                TOTALRECOVERYAMOUNT = model.totalRecoveryAmount,
                RECOVEREDAMOUNT = model.recoveredAmount,
                OUTSTANDINGAMOUNT = outstandingAmount,
                COLLATERALCODE = model.collateralCode,
                COLLECTIONMODE = model.collectionMode,
                LOANASSIGNID = model.loanAssignId,
                PERCENTAGECOMMISSION = model.percentageCommission,
                LOANREFERENCE = model.loanReference
            };

            context.TBL_COLLATERAL_LIQUIDATION_RECOVERY.Add(entity);
            context.SaveChanges();
            return 2;
        }

        public RemoveLienViewModel GetLienRemovalLetter(int lienRemovalId)
        {
            return (from x in context.TBL_LIEN_REMOVAL
                    where x.UNFREEZELIENACCOUNTID == lienRemovalId
                    select new RemoveLienViewModel
                    {
                        unfreezeLienAccountId = x.UNFREEZELIENACCOUNTID,
                        fileData = x.FILEDATA,
                        fileName = x.FILENAME,
                        fileExtension = x.FILEEXTENSION,
                    }).FirstOrDefault();
        }

        public CollateralLiquidationRecoveryViewModel GetLiquidationReceipt(int liquidationRecoveryReceiptId)
        {
            return (from x in context.TBL_COLLATERAL_LIQUIDATION_RECOVERY
                    where x.COLLATERALLIQUIDATIONRECOVERYID == liquidationRecoveryReceiptId
                    select new CollateralLiquidationRecoveryViewModel
                    {
                        collateralLiquidationRecoveryId = x.COLLATERALLIQUIDATIONRECOVERYID,
                        fileData = x.FILEDATA,
                        fileName = x.FILENAME,
                        fileExtension = x.FILEEXTENSION,
                    }).FirstOrDefault();
        }

        private TBL_LOAN_BOOKING_REQUEST addBookingRequest(multipleDisbursementOutputViewModel entity, short? approvalStatusid, UserInfo user)
        {
            var request = new TBL_LOAN_BOOKING_REQUEST
            {
                AMOUNT_REQUESTED = entity.loanAmount,
                APPROVALSTATUSID = approvalStatusid == null ? (short)ApprovalStatusEnum.Pending : (short)approvalStatusid,
                LOANAPPLICATIONDETAILID = entity.loanApplicationDetailId,
                CASAACCOUNTID = entity.casaAccountId,
                CASAACCOUNTID2 = entity.casaAccountId2,
                ISUSED = approvalStatusid == (short)ApprovalStatusEnum.Approved ? true : false,
                PRODUCTID = (short)entity.productId,
                DATETIMECREATED = DateTime.Now,
                CREATEDBY = user.createdBy,

            };
            context.TBL_LOAN_BOOKING_REQUEST.Add(request);
            context.SaveChanges();

            return request;
        }

        public Tuple<List<multipleDisbursementOutputViewModel>, bool> preBulkLoanDisbursement(byte[] file, UserInfo user, bool isFinal)
        {
            List<TBL_LOAN> loans = new List<TBL_LOAN>();
            List<multipleDisbursementOutputViewModel> loanInputs = GetBulkLoanInputs(file);
            var systemData = generalSetup.GetApplicationDate();
            bool response = true;
            List<LoanViewModel> loanViewModels = new List<LoanViewModel>();
            int ctr = 0;
            foreach (var entry in loanInputs)
            {
                ctr = ctr + 1;
                LoanPaymentScheduleInputViewModel inputSchedule = new LoanPaymentScheduleInputViewModel();
                LoanViewModel loan = new LoanViewModel();
                if (entry.passed == false)
                {
                    loan.customerCode = entry.customerCode;
                    loan.passed = entry.passed;
                    loan.errorMessage.AddRange(entry.errorMessages);
                }
                loan.passed = entry.passed;
                var scheme = context.TBL_LOAN_BULK_DISBURSE_SCHEME.Where(x => x.SCHEMECODE == entry.schemeCode).FirstOrDefault();

                loan = buildLoanModel(entry, scheme, user);
                entry.currencyCode = loan.currencyCode;
                entry.productName = loan.productName;
                entry.productId = loan.productId;
                entry.productTypeName = loan.productTypeName;
                entry.customerId = loan.customerId;
                entry.customerCode = loan.customerCode;
                entry.tenor = loan.tenor;
                entry.interestRate = loan.interestRate;
                entry.effectiveDate = loan.effectiveDate;
                entry.maturityDate = loan.maturityDate;
                entry.interestRepaymentFrequencyName = loan.interestFrequencyTypeName;
                entry.principalRepaymentFrequencyName = loan.principalFrequencyTypeName;
                entry.schemeId = scheme.DISBURSESCHEMEID;
                entry.loanApplicationDetailId = loan.loanApplicationDetailId;
                entry.repaymentScheduleMethodName = loan.scheduleTypeName;
                entry.tenor = loan.tenor;
                entry.schemeName = scheme.SCHEMENAME;
                entry.schemeCode = scheme.SCHEMECODE;
                entry.interestRepaymentFrequencyName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == scheme.INTERESTFREQUENCYTYPEID).FirstOrDefault()?.MODE;
                entry.principalRepaymentFrequencyName = context.TBL_FREQUENCY_TYPE.Where(x => x.FREQUENCYTYPEID == scheme.PRINCIPALFREQUENCYTYPEID).FirstOrDefault()?.MODE;
                entry.repaymentScheduleMethodName = context.TBL_LOAN_SCHEDULE_TYPE.Where(x => x.SCHEDULETYPEID == scheme.SCHEDULEMETHODID).FirstOrDefault()?.SCHEDULETYPENAME;
                if (loan.errorMessage != null) entry.errorMessages.AddRange(loan.errorMessage);
                //entry.loanScheduleInput = 

                inputSchedule.accrualBasis = (short)DayCountConventionEnum.Actual_Actual;
                inputSchedule.effectiveDate = DateTime.Now;
                inputSchedule.principalFirstpaymentDate = entry.firstPrincipalPaymentDate;
                inputSchedule.interestFirstpaymentDate = entry.firstInterestPaymentDate;
                inputSchedule.interestFrequencyTypeId = (short)FrequencyTypeEnum.Monthly;
                inputSchedule.interestFrequency = (short)FrequencyTypeEnum.Monthly;
                inputSchedule.principalFrequency = (short)FrequencyTypeEnum.Monthly;
                inputSchedule.scheduleMethodId = scheme.SCHEDULEMETHODID ?? (short)LoanScheduleTypeEnum.BallonPayment;
                inputSchedule.principalAmount = (double)entry.loanAmount;
                inputSchedule.maturityDate = inputSchedule.effectiveDate.AddDays(entry.tenor);

                //try { entry.periodicSchedule = loanSchedule.GeneratePeriodicLoanSchedule(inputSchedule); } catch (Exception ex) { throw new ConditionNotMetException( ex.Message + "@ row " + ctr);  }
                //entry.loanChargeFee = 

                //loanViewModels.Add(loan);
                // var loanRecord = addLoan(loan);
                //context.SaveChanges();

                // loans.Add(loanRecord);
                // entry.loanScheduleInput = BuildScheduleModel(loanRecord.TERMLOANID, user.createdBy);

                //if (isFinal && loan.passed)
                //{

                //    var loanRecord = addLoan(loan);
                //    loans.Add(loanRecord);
                //}
            }

            if (isFinal) response = context.SaveChanges() > 0;

            return new Tuple<List<multipleDisbursementOutputViewModel>, bool>(loanInputs, true);
        }


        public Tuple<List<MultipleInsuranceOutputViewModel>, bool> preBulkInsurance(byte[] file, UserInfo user, bool isFinal)
        {
            List<TBL_COLLATERAL_INSURANCE_TRACKING> insurance = new List<TBL_COLLATERAL_INSURANCE_TRACKING>();
            List<MultipleInsuranceOutputViewModel> insuranceInputs = GetBulkInsuranceInputs(file);
            
            /*var systemData = generalSetup.GetApplicationDate();
            bool response = true;
            List<InsurancePolicy> insurancePolicyViewModels = new List<InsurancePolicy>();
            int ctr = 0;
            foreach (var entry in insuranceInputs)
            {
                if (entry.isCollateral.ToLower() == "n" || entry.isCollateral.ToLower() == "no")
                {
                    ctr = ctr + 1;
                    CollateralInsuranceTrackingViewModel insurancePolicy = new CollateralInsuranceTrackingViewModel();
                    if (entry.passed == false)
                    {
                        insurancePolicy.customerCode = entry.customerCode;
                        insurancePolicy.passed = entry.passed;
                        insurancePolicy.errorMessages.AddRange(entry.errorMessages);
                    }

                    insurancePolicy.passed = entry.passed;
                    insurancePolicy = buildInsuranceModel(entry, user);

                    var insuranceTracking = context.TBL_COLLATERAL_INSURANCE_TRACKING.Add(new TBL_COLLATERAL_INSURANCE_TRACKING
                    {
                        INSURANCECOMPANYID = insurancePolicy.insuranceCompanyId,
                        ISURANCECOMPANYADDRESS = insurancePolicy.companyAddress,
                        POLICYNUMBER = insurancePolicy.referenceNumber,
                        INSURANCESTARTDATE = insurancePolicy.startDate,
                        INSURANCEENDDATE = insurancePolicy.expiryDate,
                        SUMINSURED = insurancePolicy.sumInsured,
                        PREMIUMPAID = insurancePolicy.inSurPremiumAmount,
                        INSURANCESTATUSID = insurancePolicy.insuranceStatus,
                        COLLATERALCUSTOMERID = insurancePolicy.collateralCustomerId,
                        LOANAPPLICATIONDETAILID = insurancePolicy.loanApplicationDetailId,
                        VALUATIONSTARTDATE = insurancePolicy.valuationStartDate,
                        VALUATIONENDDATE = insurancePolicy.valuationEndDate,
                        OMV = insurancePolicy.openMarketValue,
                        FSV = insurancePolicy.forcedSaleValue,
                        VALUERID = insurancePolicy.valuerId,
                        COLLATERALDETAILS = insurancePolicy.collateralDetails,
                        INSURANCEPOLICYTYPEID = insurancePolicy.insurancePolicyTypeId,
                        OTHERVALUER = insurancePolicy.otherValuer,
                        OTHERINSURANCECOMPANY = insurancePolicy.otherInsuranceCompany,
                        OTHERINSURANCEPOLICYTYPE = insurancePolicy.otherInsurancePolicyType,
                        COLLATERALTYPE = insurancePolicy.collateralTypeId,
                        COLLATERALSUBTYPE = insurancePolicy.collateralSubTypeId,
                        GPSCOORDINATES = insurancePolicy.gpsCoordinates,
                        FIRSTLOSSPAYEE = insurancePolicy.firstLossPayee,
                        INSURABLEVALUE = insurancePolicy.sumInsured,
                        COMMENT = insurancePolicy.comment,
                    });
                }

            }

            if (isFinal) try { response = context.SaveChanges() > 0; } catch (Exception e) { throw e; } */

            return new Tuple<List<MultipleInsuranceOutputViewModel>, bool>(insuranceInputs, true);
        }

        //private multipleDisbursementOutputViewModel padOutPutModel(multipleDisbursementOutputViewModel output, LoanViewModel model)
        //{
        //    return output;
        //}
        private LoanViewModel buildLoanModel(multipleDisbursementOutputViewModel input, TBL_LOAN_BULK_DISBURSE_SCHEME scheme, UserInfo user)
        {
            var model = new LoanViewModel();

            var casaAccount = context.TBL_CASA.Where(x => x.PRODUCTACCOUNTNUMBER == input.accountNumber).FirstOrDefault();
            if (casaAccount == null) { model.passed = false; model.errorMessage.Add("Account number '" + input.accountNumber + "' does not exist on Credit360"); }

            var product = context.TBL_PRODUCT.Find((short)scheme.PRODUCTID);

            int? operationId = null;
            var systemdate = generalSetup.GetApplicationDate();

            TBL_CUSTOMER customer = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == input.customerCode).FirstOrDefault();
            if (customer == null) { model.passed = false; model.errorMessage.Add("Customer does not exist on Credit360"); }

            if (product.PRODUCTTYPEID == (short)LoanProductTypeEnum.TermLoan
                || product.PRODUCTTYPEID == (short)LoanProductTypeEnum.SelfLiquidating
                || product.PRODUCTTYPEID == (short)LoanProductTypeEnum.SyndicatedTermLoan) { operationId = (short)OperationsEnum.TermLoanBooking; }
            if (product.PRODUCTTYPEID == (short)LoanProductTypeEnum.CommercialLoan) { operationId = (short)OperationsEnum.CommercialLoanBooking; }
            if (product.PRODUCTTYPEID == (short)LoanProductTypeEnum.ForeignXRevolving) { operationId = (short)OperationsEnum.ForeignExchangeLoanBooking; }

            if (operationId == null) { model.passed = false; model.errorMessage.Add("The selected scheme facility is not a loan related"); }

            var applicationDetail = context.TBL_LOAN_APPLICATION_DETAIL.Find(scheme.LOANAPPLICATIONDETAILID);

            model.loanApplicationDetailId = scheme.LOANAPPLICATIONDETAILID;
            model.customerId = customer.CUSTOMERID;
            model.customerCode = customer.CUSTOMERCODE;
            //model.currencyCode = scheme.currencyCode;
            model.productId = (short)scheme.PRODUCTID;
            model.companyId = user.companyId;
            model.casaAccountId = casaAccount.CASAACCOUNTID;
            model.branchId = (short)user.BranchId;
            model.productTypeId = product.PRODUCTTYPEID;
            model.productTypeName = product.TBL_PRODUCT_TYPE.PRODUCTTYPENAME;
            model.productName = product.PRODUCTNAME;
            model.relationshipOfficerId = customer.RELATIONSHIPOFFICERID ?? 0;
            model.relationshipManagerId = customer.RELATIONSHIPOFFICERID ?? 0;
            model.misCode = customer.MISCODE;
            model.teamMiscode = customer.MISCODE;
            model.interestRate = scheme.INTERESTRATE;
            model.effectiveDate = systemdate;
            model.maturityDate = systemdate.AddDays(input.tenor);
            model.bookingDate = DateTime.Now;
            model.principalAmount = input.loanAmount;
            model.approvalStatusId = (short)ApprovalStatusEnum.Approved;
            model.approvedBy = user.staffId;
            model.approverComment = "BULK APPROVED";
            model.dateApproved = systemdate;
            model.loanStatusId = (short)LoanStatusEnum.Active;
            model.scheduleTypeId = scheme.SCHEDULEMETHODID ?? 0;
            model.isDisbursed = true;
            model.disbursedBy = user.staffId;
            model.disburserComment = "BULK APPROVED";
            model.disburseDate = systemdate;
            model.operationId = operationId;
            model.loanTypeId = (short)LoanTypeEnum.CustomerGroup;
            model.equityContribution = 0;
            model.customerSensitivityLevelId = (short)CustomerSensitivityLevelENum.Negligible;
            model.createdBy = user.staffId;
            model.dateTimeCreated = DateTime.Now;
            model.exchangeRate = 1; //scheme.e,
            model.currencyId = 1;

            return model;
        }

        private List<multipleDisbursementOutputViewModel> GetBulkLoanInputs(byte[] file)
        {
            List<multipleDisbursementOutputViewModel> bulkEntries = new List<multipleDisbursementOutputViewModel>();


            //Limited unlicenced key : SpreadsheetInfo.SetLicense("FREE-LIMITED-KEY"); 
            SpreadsheetInfo.SetLicense("E1H4-YMDW-014G-BAQ5");

            MemoryStream ms = new MemoryStream(file);

            ExcelFile ef = ExcelFile.Load(ms, LoadOptions.XlsxDefault);

            //ExcelWorksheet ws = ef.Worksheets.ActiveWorksheet;
            ExcelWorksheet ws = ef.Worksheets[0]; //.ActiveWorksheet;

            CellRange range = ef.Worksheets.ActiveWorksheet.GetUsedCellRange(true);

            for (int j = range.FirstRowIndex; j <= range.LastRowIndex; j++)
            {
                multipleDisbursementOutputViewModel currentLine = new multipleDisbursementOutputViewModel();
                int ctr = 0;
                for (int i = range.FirstColumnIndex; i <= range.LastColumnIndex; i++)
                {
                    ExcelCell cell = range[j - range.FirstRowIndex, i - range.FirstColumnIndex];

                    string cellName = CellRange.RowColumnToPosition(j, i);
                    string cellRow = ExcelRowCollection.RowIndexToName(j);
                    string cellColumn = ExcelColumnCollection.ColumnIndexToName(i);
                    if (Convert.ToInt32(cellRow) == 1) continue;
                    ctr = Convert.ToInt32(cellRow);
                    switch (cellColumn)
                    {
                        case "A":
                            currentLine.passed = true;
                            try { currentLine.applicationReferenceNumber = cell.Value.ToString(); } catch (Exception e) { currentLine.passed = false; currentLine.errorMessages.Add(e.Message); }
                            break;
                        case "B":
                            currentLine.passed = true;
                            try { currentLine.schemeCode = cell.Value.ToString(); } catch (Exception e) { currentLine.passed = false; currentLine.errorMessages.Add(e.Message); }
                            break;
                        case "C":
                            currentLine.passed = true;
                            try { currentLine.customerCode = cell.Value.ToString(); } catch (Exception e) { currentLine.passed = false; currentLine.errorMessages.Add(e.Message); }
                            break;
                        case "D":
                            currentLine.passed = true;
                            try { currentLine.accountNumber = cell.Value.ToString(); } catch (Exception e) { currentLine.passed = false; currentLine.errorMessages.Add(e.Message); }
                            break;
                        case "E":
                            currentLine.passed = true;
                            try
                            {
                                string value = Convert.ToString(cell.Value);
                                var currency = context.TBL_CURRENCY.Where(x => x.CURRENCYCODE.ToLower() == value.ToLower()).FirstOrDefault();
                                currentLine.currencyId = currency == null ? 1 : currency.CURRENCYID;
                            }
                            catch (Exception e) { currentLine.passed = false; currentLine.errorMessages.Add(e.Message); }
                            break;
                        case "F":
                            currentLine.passed = true;
                            try { currentLine.loanAmount = Convert.ToDecimal(cell.Value); } catch (Exception e) { currentLine.passed = false; currentLine.errorMessages.Add(e.Message); }
                            break;
                        case "G":
                            currentLine.passed = true;
                            try { currentLine.tenor = Convert.ToInt16(cell.Value); } catch (Exception e) { currentLine.passed = false; currentLine.errorMessages.Add(e.Message); }
                            break;
                        case "H":
                            currentLine.passed = true;
                            try { currentLine.firstPrincipalPaymentDate = Convert.ToDateTime(cell.Value); } catch (Exception e) { currentLine.passed = false; currentLine.errorMessages.Add(e.Message); }
                            break;
                        case "I":
                            currentLine.passed = true;
                            try { currentLine.firstInterestPaymentDate = Convert.ToDateTime(cell.Value); } catch (Exception e) { currentLine.passed = false; currentLine.errorMessages.Add(e.Message); }
                            break;
                    }
                }
                if (ctr > 1) bulkEntries.Add(currentLine);
            };

            return bulkEntries;
        }


        private List<MultipleInsuranceOutputViewModel> GetBulkInsuranceInputs(byte[] file)
        {
            
                List<MultipleInsuranceOutputViewModel> bulkEntries = new List<MultipleInsuranceOutputViewModel>();
                TBL_COLLATERAL_CUSTOMER customerCollateral = null;
                
                 //Limited unlicenced key : SpreadsheetInfo.SetLicense("FREE-LIMITED-KEY"); 
                SpreadsheetInfo.SetLicense("E1H4-YMDW-014G-BAQ5");
                MemoryStream ms = new MemoryStream(file);
                ExcelFile ef = ExcelFile.Load(ms, LoadOptions.XlsxDefault);
                //ExcelWorksheet ws = ef.Worksheets.ActiveWorksheet;
                ExcelWorksheet ws = ef.Worksheets[0]; //.ActiveWorksheet;
                CellRange range = ef.Worksheets.ActiveWorksheet.GetUsedCellRange(true);

                for (int j = range.FirstRowIndex; j <= range.LastRowIndex; j++)
                {
                    MultipleInsuranceOutputViewModel currentLine = new MultipleInsuranceOutputViewModel();
                    int ctr = 0;
                    currentLine.errorMessages = new List<string>();
                    for (int i = range.FirstColumnIndex; i <= range.LastColumnIndex; i++)
                    {
                        ExcelCell cell = range[j - range.FirstRowIndex, i - range.FirstColumnIndex];
                        
                        string cellName = CellRange.RowColumnToPosition(j, i);
                        string cellRow = ExcelRowCollection.RowIndexToName(j);
                        string cellColumn = ExcelColumnCollection.ColumnIndexToName(i);
                        if (Convert.ToInt32(cellRow) == 1) continue;
                        ctr = Convert.ToInt32(cellRow);
                        switch (cellColumn)
                        {
                            case "A":
                                currentLine.passed = true;
                                try {

                                if (cell.Value == null) { currentLine.passed = false; currentLine.errorMessages.Add("<br/> Is collateral column is empty"); }
                                else currentLine.isCollateral = cell.Value.ToString(); } catch (Exception e) { currentLine.passed = false; currentLine.errorMessages.Add(e.Message); }
                                break;
                            case "B":
                                currentLine.passed = true;
                                try { currentLine.customerId = cell.Value.ToString(); }
                                catch (Exception e)
                                {
                                    currentLine.passed = false; currentLine.errorMessages.Add(e.Message);
                                }
                                break;
                            case "C":
                                currentLine.passed = true;
                                try {
                                if (currentLine.isCollateral == null) { currentLine.passed = false; currentLine.errorMessages.Add("<br/> Collateral code cannot be used for an unspecified collateral"); }
                                else if (currentLine.isCollateral.ToLower() == "y" || currentLine.isCollateral.ToLower() == "yes")
                                {
                                    currentLine.collateralCode = null;
                                }
                                else { currentLine.collateralCode = cell.Value?.ToString(); }
                                
                                }
                                catch (Exception e)
                                {
                                    currentLine.passed = false; currentLine.errorMessages.Add(e.Message);
                                }
                                break;
                            case "D":
                                currentLine.passed = true;
                                try {
                                    currentLine.referenceNumber = cell.Value.ToString();
                                    
                                }
                                catch (Exception e)
                                {
                                    currentLine.passed = false; currentLine.errorMessages.Add(e.Message);
                                }
                                break;
                            case "E":
                                currentLine.passed = true;
                                try { currentLine.policyType = cell.Value.ToString(); }
                                catch (Exception e)
                                {
                                    currentLine.passed = false; currentLine.errorMessages.Add(e.Message);
                                }
                                break;
                            case "F":
                                currentLine.passed = true;
                                try {

                                if (cell.Value == null) { currentLine.passed = false; currentLine.errorMessages.Add("<br/>Insurance Company column is empty"); }
                                else currentLine.insuranceCompany = cell.Value.ToString(); 
                            }
                                catch (Exception e)
                                {
                                    currentLine.passed = false; currentLine.errorMessages.Add(e.Message);
                                }
                                break;
                            case "G":
                                currentLine.passed = true;
                                try { currentLine.startDate = Convert.ToDateTime(cell.Value); }
                                catch (Exception e)
                                {
                                    currentLine.passed = false; //currentLine.errorMessages.Add(e.Message);
                                }
                                break;
                            case "H":
                                currentLine.passed = true;
                                try { currentLine.expiryDate = Convert.ToDateTime(cell.Value); }
                                catch (Exception e)
                                {
                                    currentLine.passed = false; //currentLine.errorMessages.Add(e.Message);
                                }
                                break;
                            case "I":
                                currentLine.passed = true;
                                try { currentLine.sumInsured = Convert.ToDecimal(cell.Value); }
                                catch (Exception e)
                                {
                                    currentLine.passed = false; //currentLine.errorMessages.Add(e.Message);
                                }
                                break;
                            case "J":
                                currentLine.passed = true;
                                try { currentLine.premiumAmount = Convert.ToDecimal(cell.Value); }
                                catch (Exception e)
                                {
                                    currentLine.passed = false; //currentLine.errorMessages.Add(e.Message);
                                }
                                break;
                            case "K":
                            currentLine.passed = true;
                            try { currentLine.collateralDescription = cell.Value.ToString(); }
                            catch (Exception e)
                            {
                                currentLine.passed = false; 
                            }
                            break;
                    }

                    }

                    if (ctr > 1) bulkEntries.Add(currentLine);

                };

                foreach (var currentLine in bulkEntries)
                {
                try
                {
                    var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);
                    var newCollateralCode = CommonHelpers.GenerateRandomDigitCode(7);
                    //========================================== other valiadation =============================
                    if (currentLine.isCollateral?.ToLower() == "y" || currentLine.isCollateral?.ToLower() == "yes")
                    {
                        currentLine.collateralCode = newCollateralCode;
                    }

                    if (currentLine.referenceNumber == "0" || currentLine.referenceNumber == "")
                    {
                        currentLine.referenceNumber = referenceNumber;
                    }
                    var customer = context.TBL_CUSTOMER.Where(x => x.CUSTOMERCODE == currentLine.customerId).FirstOrDefault();
                    if (customer == null)
                    {
                        currentLine.passed = false;
                        currentLine.errorMessages.Add("<br/>Customer with customercode " + currentLine.customerId.ToString() + " does not exist on Credit360");
                    }
                    if (currentLine.expiryDate <= currentLine.startDate)
                    {
                        currentLine.passed = false;
                        currentLine.errorMessages.Add("<br/>Insurance End Date must be greater than Insurance Start Date");
                    }

                    if (currentLine.isCollateral?.ToLower() != "")
                    {
                        if (currentLine.isCollateral?.ToLower() == "y" || currentLine.isCollateral?.ToLower() == "yes")
                        {
                            currentLine.collateralCustomerId = null;
                            currentLine.collateralDetails = currentLine.collateralDescription;
                            //currentLine.passed = false;
                            //currentLine.errorMessages.Add("<br/>Only collateral insurance policy is allowed to be uploaded. Collateral with collateralcode " + currentLine.collateralCode.ToString() + " is not an insurance policy");
                        }
                        else
                        {
                            customerCollateral = context.TBL_COLLATERAL_CUSTOMER.Where(x => x.COLLATERALCODE == currentLine.collateralCode.Trim().ToString()).FirstOrDefault();

                            if (currentLine.collateralCode != null) { currentLine.collateralDescription = context.TBL_COLLATERAL_CUSTOMER.Where(x => x.COLLATERALCODE == currentLine.collateralCode).FirstOrDefault()?.COLLATERALSUMMARY; }
                            if (currentLine.collateralDescription == null )
                            {
                                currentLine.passed = false;
                                currentLine.errorMessages.Add("<br/>Collateral Description column is null ");
                            }
                            

                            if (customerCollateral == null)
                            {
                                currentLine.passed = false;
                                currentLine.errorMessages.Add("<br/>Collateral with collateralcode " + currentLine.collateralCode?.ToString() + " does not exist on Credit360");
                            }
                            //else if(customerCollateral == null && (currentLine.collateralCode != string.Empty || currentLine.collateralCode != null))
                            //{
                            //    currentLine.passed = false;
                            //    currentLine.errorMessages.Add("<br/>Collateral with collateralcode " + currentLine.collateralCode?.ToString() + " does not exist on Credit360");
                            //}
                            else
                            { 
                                currentLine.collateralCustomerId = customerCollateral.COLLATERALCUSTOMERID;
                                currentLine.collateralDetails = customerCollateral.COLLATERALSUMMARY;
                                currentLine.collateralCode = customerCollateral.COLLATERALCODE;
                                

                                var customerExistingCollateralPolicy = context.TBL_COLLATERAL_INSURANCE_TRACKING.Where(x => x.COLLATERALCUSTOMERID == customerCollateral.COLLATERALCUSTOMERID).FirstOrDefault();
                                if (customerExistingCollateralPolicy != null)
                                {
                                    currentLine.passed = false;
                                    currentLine.errorMessages.Add("<br/>Policy with collateralcode " + currentLine.collateralCode.ToString() + " already exist on Credit360");
                                }
                                else
                                {
                                    var customerCollaterals = context.TBL_COLLATERAL_CUSTOMER.Where(c => c.COLLATERALCODE == currentLine.collateralCode).ToList();
                                    if (customerCollaterals.Count() > 0 && customerCollaterals.Count() == 1)
                                    {
                                        currentLine.collateralCustomerId = customerCollateral.COLLATERALCUSTOMERID;
                                        currentLine.collateralDetails = customerCollateral.COLLATERALSUMMARY;
                                        currentLine.collateralCode = customerCollateral.COLLATERALCODE;
                                    }
                                    else
                                    {
                                        currentLine.passed = false;
                                        currentLine.errorMessages.Add("<br/>Customer must have only single collateral for bulk upload on credit360");
                                    }
                                    var validateCollateralInsurance = context.TBL_COLLATERAL_INSURANCE_TRACKING.Where(x => x.COLLATERALCUSTOMERID == customerCollateral.COLLATERALCUSTOMERID).ToList();
                                    if (validateCollateralInsurance.Any())
                                    {
                                        currentLine.passed = false;
                                        currentLine.errorMessages.Add("<br/>Insurance already exist on Credit360");
                                    }
                                    
                                }
                            }
                        }
                    }

                    var validateInsurancePolicy = context.TBL_COLLATERAL_INSURANCE_TRACKING.Where(x => x.POLICYNUMBER.Trim() == currentLine.referenceNumber.ToString()).ToList();
                    if (validateInsurancePolicy.Any())
                    {
                        currentLine.passed = false;
                        currentLine.errorMessages.Add("<br/>Policy number " + currentLine.referenceNumber.ToString() + " already exist on Credit360");
                    }

                    var insurancePolicyTypeDetail = context.TBL_INSURANCE_POLICY_TYPE.Where(x => currentLine.policyType.ToLower().Contains(x.DESCRIPTION.ToLower())).FirstOrDefault();
                    if (insurancePolicyTypeDetail == null)
                    {
                        currentLine.passed = false;
                        currentLine.errorMessages.Add("<br/>Policy type " + currentLine.policyType.ToString() + " does not exist on Credit360");
                    }
                    else
                    {
                        currentLine.insurancePolicyTypeId = insurancePolicyTypeDetail.POLICYTYPEID;
                    }

                    var insuranceCompanyDetail = context.TBL_INSURANCE_COMPANY.Where(x => currentLine.insuranceCompany.ToString().Contains(x.COMPANYNAME)).FirstOrDefault();
                    if (insuranceCompanyDetail == null)
                    {
                        currentLine.passed = false;
                        currentLine.errorMessages.Add("<br/>Insurance company " + currentLine.insuranceCompany?.ToString() + " does not exist on Credit360");
                    }
                    else
                    {
                        currentLine.insuranceCompanyId = insuranceCompanyDetail.INSURANCECOMPANYID;
                        currentLine.companyAddress = insuranceCompanyDetail.ADDRESS;
                    }

                    if (currentLine.passed == true)
                    {
                        currentLine.validityStatus = "Passed";
                    }
                    else
                    {
                        currentLine.validityStatus = "Failed";
                    }

                    if (currentLine.isCollateral?.ToLower() == "n" || currentLine.isCollateral?.ToLower() == "no")
                    {
                        currentLine.isCollateral = "No";
                    }
                    else
                    {
                        currentLine.isCollateral = "Yes";
                    }
                }catch(Exception e)
                {
                    throw e;
                }
                }
                return bulkEntries;
            
        }

        private CollateralInsuranceTrackingViewModel buildInsuranceModel(MultipleInsuranceOutputViewModel input, UserInfo user)
        {
            var model = new CollateralInsuranceTrackingViewModel();

            if (String.IsNullOrWhiteSpace(input.referenceNumber) || String.IsNullOrEmpty(input.referenceNumber))
            {
                var refNo = CommonHelpers.GenerateRandomDigitCode(7);
                input.referenceNumber = refNo;
            }

            if (String.IsNullOrWhiteSpace(input.collateralCode) || String.IsNullOrEmpty(input.collateralCode))
            {
                var collateralCode = CommonHelpers.GenerateRandomDigitCode(7);
                input.collateralCode = collateralCode;
            }



            model.insuranceCompanyId = input.insuranceCompanyId;
            model.companyAddress = input.companyAddress;
            model.referenceNumber = input.referenceNumber;
            model.startDate = (DateTime)input.startDate;
            model.expiryDate = (DateTime)input.expiryDate;
            model.sumInsured = (decimal)input.sumInsured;
            model.inSurPremiumAmount = (decimal)input.premiumAmount;
            model.insuranceStatus = (input.expiryDate.Value > DateTime.Now) ? 1 : 2;
            model.collateralCustomerId = (int)input.collateralCustomerId;
            model.loanApplicationDetailId = 0;
            model.valuationStartDate = null;
            model.valuationEndDate = null;
            model.openMarketValue = null;
            model.forcedSaleValue = null;
            model.valuerId = null;
            model.collateralDetails = input.collateralDetails;
            model.insurancePolicyTypeId = input.insurancePolicyTypeId;
            model.otherValuer = "";
            model.otherInsuranceCompany = "";
            model.otherInsurancePolicyType = "";
            model.collateralTypeId = null;
            model.collateralSubTypeId = null;
            model.gpsCoordinates = input.gpsCoordinates;
            model.firstLossPayee = input.firstLossPayee;
            model.insurableValue = input.sumInsured;
            model.comment = input.comment;
            model.collateralCode = input.collateralCode;

            return model;
        }

        private TBL_LOAN addLoan(LoanViewModel entity)
        {
            var customer = context.TBL_CUSTOMER.Find(entity.customerId);
            var creditLine = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            var loanReferenceNumber = GenerateLoanReferenceNumber(entity.branchId, entity.productId, (short)LoanSystemTypeEnum.TermDisbursedFacility);

            if (entity.loanScheduleInput.scheduleMethodId == 0) { entity.loanScheduleInput.scheduleMethodId = (short)LoanScheduleTypeEnum.Annuity; }
            var data = new TBL_LOAN
            {
                LOAN_BOOKING_REQUESTID = entity.loanBookingRequestId,
                LOANAPPLICATIONDETAILID = entity.loanApplicationDetailId,
                LOANREFERENCENUMBER = loanReferenceNumber,
                RELATED_LOAN_REFERENCE_NUMBER = loanReferenceNumber,
                LOANSTATUSID = (short)LoanStatusEnum.Active,
                ISDISBURSED = false,
                PRINCIPALNUMBEROFINSTALLMENT = 0,
                INTERESTNUMBEROFINSTALLMENT = 0,
                SCHEDULEDPREPAYMENTAMOUNT = entity.scheduledPrepaymentAmount,
                SCH_PREPAYMENT_FREQUENCY_TYPID = null,

                SUBSECTORID = entity.subSectorId,
                CURRENCYID = (short)entity.currencyId,
                EXCHANGERATE = entity.exchangeRate,

                DISCHARGELETTER = false,
                SUSPENDINTEREST = false,

                CUSTOMERID = entity.customerId,
                PRODUCTID = entity.productId,
                COMPANYID = entity.companyId,
                CASAACCOUNTID = entity.casaAccountId,
                CASAACCOUNTID2 = entity.casaAccountId2,
                BRANCHID = entity.branchId,
                SHOULD_DISBURSE = true,

                PRINCIPALFREQUENCYTYPEID = entity.loanScheduleInput.principalFrequency,
                INTERESTFREQUENCYTYPEID = entity.loanScheduleInput.interestFrequency,

                RELATIONSHIPOFFICERID = entity.relationshipOfficerId,
                RELATIONSHIPMANAGERID = entity.relationshipManagerId,
                MISCODE = creditLine.TBL_LOAN_APPLICATION.MISCODE,
                TEAMMISCODE = creditLine.TBL_LOAN_APPLICATION.TEAMMISCODE,
                INTERESTRATE = entity.interestRate,

                PRINCIPALINSTALLMENTLEFT = 0,
                INTERESTINSTALLMENTLEFT = 0,

                SCHEDULETYPEID = entity.loanScheduleInput.scheduleMethodId,

                PRINCIPALAMOUNT = Convert.ToDecimal(entity.loanScheduleInput.principalAmount),

                OPERATIONID = entity.operationId = (int)OperationsEnum.TermLoanBooking,
                LOANSYSTEMTYPEID = (short)LoanSystemTypeEnum.TermDisbursedFacility,
                EQUITYCONTRIBUTION = 0,
                OUTSTANDINGPRINCIPAL = Convert.ToDecimal(entity.loanScheduleInput.principalAmount),
                PRINCIPALADDITIONCOUNT = 0,
                PRINCIPALREDUCTIONCOUNT = 0,
                FIXEDPRINCIPAL = false,
                PROFILELOAN = false,

                APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved,

                BOOKINGDATE = generalSetup.GetApplicationDate(),
                CREATEDBY = entity.createdBy,
                DATETIMECREATED = DateTime.Now,
                EFFECTIVEDATE = entity.loanScheduleInput.effectiveDate,
                MATURITYDATE = entity.loanScheduleInput.maturityDate,
                LASTRESTRUCTUREDATE = entity.loanScheduleInput.effectiveDate,
                FIRSTPRINCIPALPAYMENTDATE = entity.loanScheduleInput.principalFirstpaymentDate,
                FIRSTINTERESTPAYMENTDATE = entity.loanScheduleInput.interestFirstpaymentDate,
                ALLOWFORCEDEBITREPAYMENT = false,
                SCHEDULEDAYCOUNTCONVENTIONID = entity.loanScheduleInput.accrualBasis,
                USER_PRUDENTIAL_GUIDE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                EXT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,
                INT_PRUDENT_GUIDELINE_STATUSID = (short)LoanPrudentialStatusEnum.Performing,

                REPRICINGMODEID = entity.loanScheduleInput.repricingModeId != 0 ? entity.loanScheduleInput.repricingModeId : null,
                REPRICINGDURATION = entity.loanScheduleInput.repricingDuration != 0 ? entity.loanScheduleInput.repricingDuration : null,

            };
            return data;
        }

        private TBL_LOAN_BULK_DISBURSEMENT addBulkLoan(multipleDisbursementOutputViewModel entity)
        {
            var customer = context.TBL_CUSTOMER.Find(entity.customerId);
            var creditLine = context.TBL_LOAN_APPLICATION_DETAIL.Find(entity.loanApplicationDetailId);
            //var loanReferenceNumber = GenerateLoanReferenceNumber(entity.branchId, entity.productId, (short)LoanSystemTypeEnum.TermDisbursedFacility);

            //if (entity.loanScheduleInput.scheduleMethodId == 0) { entity.loanScheduleInput.scheduleMethodId = (short)LoanScheduleTypeEnum.Annuity; }
            var data = new TBL_LOAN_BULK_DISBURSEMENT
            {
                LOANAPPLICATIONDETAILID = entity.loanApplicationDetailId,
                CURRENCYID = (short)entity.currencyId,
                CUSTOMERID = entity.customerId,
                CASAACCOUNTID = entity.casaAccountId,
                CASAACCOUNTID2 = entity.casaAccountId2,
                INTERESTRATE = entity.interestRate,
                EFFECTIVEDATE = entity.effectiveDate,
                MATURITYDATE = entity.maturityDate,
                CUSTOMERCODE = entity.customerCode,
                INTERESTPAYMENTFREQUENCYID = entity.interestRepaymentFrequencyId,
                PRINCIPALPAYMENTFREQUENCYID = entity.principalRepaymentFrequencyId,
                LOANAMOUNT = (double)entity.loanAmount,
                SCHEMEID = entity.schemeId,
                SCHEMECODE = entity.schemeCode,
                SHOULDDISBURSE = entity.shouldDisburse,
                TENOR = entity.tenor,
                APPROVALSTATUS = (short)ApprovalStatusEnum.Pending
            };
            return data;
        }

        private TEMP_COLLATERAL_INSURANCE_TRACKING addBulkPolicy(MultipleInsuranceOutputViewModel insurancePolicy)
        {

            var insuranceTracking = context.TEMP_COLLATERAL_INSURANCE_TRACKING.Add(new TEMP_COLLATERAL_INSURANCE_TRACKING
            {
                CUSTOMERCODE = insurancePolicy.customerId,
                COLLATERALCODE = insurancePolicy.collateralCode,
                INSURANCECOMPANYID = insurancePolicy.insuranceCompanyId,
                ISURANCECOMPANYADDRESS = insurancePolicy.companyAddress,
                POLICYNUMBER = insurancePolicy.referenceNumber,
                INSURANCESTARTDATE = insurancePolicy.startDate,
                INSURANCEENDDATE = insurancePolicy.expiryDate,
                SUMINSURED = insurancePolicy.sumInsured,
                PREMIUMPAID = insurancePolicy.premiumAmount,
                INSURANCESTATUSID = insurancePolicy.insuranceStatus,
                COLLATERALCUSTOMERID = insurancePolicy.collateralCustomerId,
                LOANAPPLICATIONDETAILID = insurancePolicy.loanApplicationDetailId,
                VALUATIONSTARTDATE = insurancePolicy.valuationStartDate,
                VALUATIONENDDATE = insurancePolicy.valuationEndDate,
                OMV = insurancePolicy.openMarketValue,
                FSV = insurancePolicy.forcedSaleValue,
                VALUERID = insurancePolicy.valuerId,
                COLLATERALDETAILS = insurancePolicy.collateralDetails,
                INSURANCEPOLICYTYPEID = insurancePolicy.insurancePolicyTypeId,
                OTHERVALUER = insurancePolicy.otherValuer,
                OTHERINSURANCECOMPANY = insurancePolicy.otherInsuranceCompany,
                OTHERINSURANCEPOLICYTYPE = insurancePolicy.otherInsurancePolicyType,
                COLLATERALTYPE = insurancePolicy.collateralTypeId,
                COLLATERALSUBTYPE = insurancePolicy.collateralSubTypeId,
                GPSCOORDINATES = insurancePolicy.gpsCoordinates,
                FIRSTLOSSPAYEE = insurancePolicy.firstLossPayee,
                INSURABLEVALUE = insurancePolicy.sumInsured,
                COMMENT = insurancePolicy.comment,
                DATETIMECREATED = insurancePolicy.dateTimeCreated,
                CREATEDBY = insurancePolicy.createdBy,
                APPROVALSTATUSID = insurancePolicy.approvalStatusId,
                BATCHCODE = insurancePolicy.batchCode,
                VALIDITYSTATUS = insurancePolicy.passed,
                ISCOLLATERAL = (insurancePolicy.isCollateral.ToLower() == "n" || insurancePolicy.isCollateral.ToLower() == "no") ? false : true,
                COLLATERALDESCRIPTION = insurancePolicy.collateralDescription,
            });
        
            return insuranceTracking;
        }


        private TBL_LOAN_RECOVERY_ASSIGNMENT addBulkLoanAssignmentToAgent(GlobalExposureApplicationViewModel entity)
        {
            var data = new TBL_LOAN_RECOVERY_ASSIGNMENT
            {
                LOANID = entity.loanId,
                CUSTOMERID = entity.customerId,
                ACCREDITEDCONSULTANT = entity.accreditedConsultant,
                DATEASSIGNED = DateTime.Now,
                CREATEDBY = entity.createdBy,
                EXPCOMPLETIONDATE = entity.expCompletionDate,
                REFERENCEID = entity.referenceId,
                OPERATIONID = entity.operationId,
                APPROVALSTATUSID = entity.approvalStatusId,
                OPERATIONCOMPLETED = entity.operationCompleted,
                TOTALAMOUNTRECOVERY = entity.totalAmountRecovery,
                SOURCE = entity.source,
                LOANREFERENCE = entity.loanReferenceNumber,
                PRODUCTID = entity.productId,
                ASSIGNMENTTYPE = entity.assignmentType,
                APPLICATIONREFERENCENUMBER = entity.applicationReferenceNumber,
                PRODUCTCLASSID = entity.productClassId,
                ISDIGITAL = entity.isDigital
            };
            return data;
        }

        private TBL_LOAN_RECOVERY_ASSIGNMENT addBulkRecoveryAssignmentToAgent(TBL_LOAN_RECOVERY_ASSIGNMENT entity)
        {
            var data = new TBL_LOAN_RECOVERY_ASSIGNMENT
            {
                LOANID = entity.LOANID,
                APPLICATIONREFERENCENUMBER = entity.APPLICATIONREFERENCENUMBER,
                CUSTOMERID = entity.CUSTOMERID,
                ACCREDITEDCONSULTANT = entity.ACCREDITEDCONSULTANT,
                DATEASSIGNED = DateTime.Now,
                CREATEDBY = entity.CREATEDBY,
                EXPCOMPLETIONDATE = entity.EXPCOMPLETIONDATE,
                REFERENCEID = entity.REFERENCEID,
                OPERATIONID = entity.OPERATIONID,
                APPROVALSTATUSID = entity.APPROVALSTATUSID,
                OPERATIONCOMPLETED = entity.OPERATIONCOMPLETED,
                TOTALAMOUNTRECOVERY = entity.TOTALAMOUNTRECOVERY,
                SOURCE = entity.SOURCE,
                LOANREFERENCE = entity.LOANREFERENCE,
                PRODUCTCLASSID = entity.PRODUCTCLASSID,
                PRODUCTID = entity.PRODUCTID,
                ASSIGNMENTTYPE = entity.ASSIGNMENTTYPE
            };
            return data;
        }

        public IEnumerable<WorkflowTrackerViewModel> GetApprovalTrailByOperationIdAndTargetId(int operationId, int targetId, int companyId)
        {
            TBL_LOAN_BOOKING_REQUEST bookingRequestRecord = new TBL_LOAN_BOOKING_REQUEST();
            var result1 = approvalLevelStaff.GetApprovalTrailByOperationIdAndTargetId(operationId, targetId, companyId).ToList();
            var results2 = new List<WorkflowTrackerViewModel>();

            if (operationId == ((short)OperationsEnum.TermLoanBooking))
            {
                bookingRequestRecord = (from l in context.TBL_LOAN
                                        join r in context.TBL_LOAN_BOOKING_REQUEST on l.LOAN_BOOKING_REQUESTID equals r.LOAN_BOOKING_REQUESTID
                                        where l.TERMLOANID == targetId
                                        select r).FirstOrDefault();


            }

            if (bookingRequestRecord != null)
            {
                results2 = approvalLevelStaff.GetApprovalTrailByOperationIdAndTargetId(bookingRequestRecord.OPERATIONID ?? 0, bookingRequestRecord.LOAN_BOOKING_REQUESTID, companyId).ToList();
            }

            return result1.Union(results2);
        }
        //private 
        //public bool getNextApprovalLevel(ApprovalViewModel model)
        //{
        //    int staffId = model.staffId;

        //    var staff = context.TBL_STAFF.Where(x => x.STAFFID == staffId).FirstOrDefault();

        //    var levels = context.TBL_APPROVAL_GROUP_MAPPING.Where(x => x.OPERATIONID == model.operationId)
        //         .Join(context.TBL_APPROVAL_GROUP, m => m.GROUPID, g => g.GROUPID, (m, g) => new { m, g })
        //         .Join(context.TBL_APPROVAL_LEVEL.Where(x => x.ISACTIVE == true),
        //             mg => mg.g.GROUPID, l => l.GROUPID, (mg, l) => new
        //             {
        //                 groupPosition = mg.m.POSITION,
        //                 levelPosition = l.POSITION,
        //                 levelId = l.APPROVALLEVELID,
        //                 levelName = l.LEVELNAME,
        //                 staffRoleId = l.STAFFROLEID,
        //             })
        //             .OrderBy(x => x.groupPosition)
        //             .ThenBy(x => x.levelPosition)
        //             .ToList();

        //    var staffRoleLevels = levels.Where(x => x.staffRoleId == staff.STAFFROLEID);
        //    var staffRoleLevelIds = staffRoleLevels.Select(x => x.levelId);
        //    var staffRoleLevelId = staffRoleLevelIds.FirstOrDefault();

        //    int currentLevelIndex = levels.FindIndex(p => p.levelId == staffRoleLevelId);
        //    int nextLevelIndex = levels.FindIndex(p => p.levelId == model.approvalLevelId);

        //    if (nextLevelIndex > currentLevelIndex)
        //        throw new ConditionNotMetException("The refered level is higher than the current level.");

        //}



        public bool saveBulkLoanRecoveryReporting(List<LoanRecoveryReportBatchViewModel> models, UserInfo user)
        {
            bool result = false;
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);

            List<TBL_LOAN_RECOVERY_REPORTING_BATCH> bulkLoanTable = new List<TBL_LOAN_RECOVERY_REPORTING_BATCH>();
            if (models == null)
            {
                throw new ConditionNotMetException("Kindly select at least one loan.");
            }

            var validate = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Where(x => x.REFERENCEID == referenceNumber
                                                          && (x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Referred
                                                          || x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Disapproved)).FirstOrDefault();
            if (validate != null)
            {
                throw new SecureException("Request already exist and undergoing approval");
            }

            LoanRecoveryReportBatchViewModel request = new LoanRecoveryReportBatchViewModel();

            foreach (var model in models)
            {
                request.createdBy = user.createdBy;
                request.loanId = model.loanId;
                request.loanReferenceNumber = model.loanReferenceNumber;
                request.accreditedConsultant = model.accreditedConsultant;
                request.referenceId = referenceNumber;
                request.approvalStatusId = (int)ApprovalStatusEnum.Pending;
                request.operationId = (int)OperationsEnum.RecoveryReporting;
                request.operationCompleted = false;
                request.totalAmountRecovery = model.totalRecoveryAmount;
                request.amountRecovered = model.recoveredAmount;
                request.customerId = model.customerId;
                request.collateralLiquidationRecoveryId = model.collateralLiquidationRecoveryId;
                var loanData = addBulkLoanRecoveryReporting(request);
                bulkLoanTable.Add(loanData);
            }
            context.TBL_LOAN_RECOVERY_REPORTING_BATCH.AddRange(bulkLoanTable);
            if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

            TBL_LOAN_RECOVERY_REPORTING_APPROVAL requests = new TBL_LOAN_RECOVERY_REPORTING_APPROVAL();
            requests = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Add(new TBL_LOAN_RECOVERY_REPORTING_APPROVAL
            {
                REFERENCEID = referenceNumber,
                APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,
                OPERATIONID = (int)OperationsEnum.RecoveryReporting,
                DATETIMECREATED = DateTime.Now
            });
            if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

            auditTrail.AddAuditTrail(new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryReport,
                STAFFID = user.createdBy,
                BRANCHID = (short)user.BranchId,
                DETAIL = $"Added TBL_LOAN_RECOVERY_REPORTING_BATCH '{ referenceNumber}' ",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = user.applicationUrl,
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName()
            });

            int resultStatus = context.SaveChanges();
            if (resultStatus > 0)
            {
                result = true;
            }

            return result;
        }

        public WorkflowResponse bulkLoanRecoveryReportingGoForApproval(LoanRecoveryReportApprovalViewModel models, UserInfo user)
        {
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);
            if (models == null)
            {
                throw new ConditionNotMetException("Kindly select an accredited consultant/agent.");
            }

            var validate = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Where(x => x.REFERENCEID == models.referenceId
                                                          && (x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Pending
                                                          || x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Disapproved)).FirstOrDefault();
            if (validate != null)
            {
                throw new SecureException("Request already exist and undergoing approval");
            }

            using (TransactionScope transactionScope = new TransactionScope())
            {

                if (validate == null)
                {
                    var data = context.TBL_LOAN_RECOVERY_REPORTING_BATCH.Where(x => x.REFERENCEID == models.referenceId).ToList();
                    foreach (var d in data)
                    {
                        d.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    }
                    context.SaveChanges();

                    var approval = context.TBL_LOAN_RECOVERY_REPORTING_APPROVAL.Where(x => x.REFERENCEID == models.referenceId).FirstOrDefault();
                    approval.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    approval.REGION = models.region;
                    approval.COMMENT = models.comment;
                    approval.MISCODE = models.misCode;
                    approval.CREATEDBY = user.createdBy;
                    if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

                    workflow.StaffId = user.createdBy;
                    workflow.CompanyId = user.companyId;
                    workflow.StatusId = (int)ApprovalStatusEnum.Processing;
                    workflow.TargetId = approval.LOANRECOVERYREPORTAPPROVALID;
                    workflow.Comment = models.comment;
                    workflow.OperationId = (int)OperationsEnum.RecoveryReporting;
                    workflow.DeferredExecution = true;
                    workflow.ExternalInitialization = false;

                    var response = workflow.LogActivity();
                    context.SaveChanges();
                }
                transactionScope.Complete();

                transactionScope.Dispose();

            }
            return workflow.Response;
        }

        private TBL_LOAN_RECOVERY_REPORTING_BATCH addBulkLoanRecoveryReporting(LoanRecoveryReportBatchViewModel entity)
        {
            var data = new TBL_LOAN_RECOVERY_REPORTING_BATCH
            {
                LOANID = entity.loanId,
                LOANREFERENCENUMBER = entity.loanReferenceNumber,
                CUSTOMERID = entity.customerId,
                ACCREDITEDCONSULTANT = entity.accreditedConsultant,
                DATETIMECREATED = DateTime.Now,
                CREATEDBY = entity.createdBy,
                REFERENCEID = entity.referenceId,
                OPERATIONID = entity.operationId,
                APPROVALSTATUSID = entity.approvalStatusId,
                OPERATIONCOMPLETED = entity.operationCompleted,
                TOTALAMOUNTRECOVERY = entity.totalAmountRecovery,
                AMOUNTRECOVERED = entity.amountRecovered,
                COLLATERALLIQUIDATIONRECOVERYID = entity.collateralLiquidationRecoveryId

            };
            return data;
        }

        //===============recovery commission

        public bool saveBulkLoanRecoveryCommission(List<LoanRecoveryCommissionBatchViewModel> models, UserInfo user)
        {
            bool result = false;
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);

            List<TBL_LOAN_RECOVERY_COMMISSION_BATCH> bulkLoanTable = new List<TBL_LOAN_RECOVERY_COMMISSION_BATCH>();
            if (models == null)
            {
                throw new ConditionNotMetException("Kindly select at least one loan.");
            }

            //var validate = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == referenceNumber
            //                                              && (x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Referred
            //                                              || x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Disapproved)).FirstOrDefault();
            //if (validate != null)
            //{
            //    throw new SecureException("Request already exist and undergoing approval");
            //}

            LoanRecoveryCommissionBatchViewModel request = new LoanRecoveryCommissionBatchViewModel();

            foreach (var model in models)
            {
                request.createdBy = user.createdBy;
                request.loanId = model.loanId;
                request.loanReferenceNumber = model.loanReferenceNumber;
                request.accreditedConsultant = model.accreditedConsultant;
                request.referenceId = referenceNumber;
                request.approvalStatusId = (int)ApprovalStatusEnum.Pending;
                request.operationId = (int)OperationsEnum.RecoveryCommission;
                request.operationCompleted = false;
                request.totalAmountRecovery = model.totalRecoveryAmount;
                request.amountRecovered = model.recoveredAmount;
                request.customerId = model.customerId;
                request.misCode = model.recoveryMisCode;
                request.region = model.recoveryRegion;
                request.loanRecoveryReportBatchId = model.loanRecoveryReportBatchId;
                var loanData = addBulkLoanRecoveryCommission(request);
                bulkLoanTable.Add(loanData);
            }
            context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.AddRange(bulkLoanTable);
            if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

            TBL_LOAN_RECOVERY_COMMISSION_APPROVAL requests = new TBL_LOAN_RECOVERY_COMMISSION_APPROVAL();
            requests = context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL.Add(new TBL_LOAN_RECOVERY_COMMISSION_APPROVAL
            {
                REFERENCEID = referenceNumber,
                APPROVALSTATUSID = (int)ApprovalStatusEnum.Pending,
                OPERATIONID = (int)OperationsEnum.RecoveryCommission,
                DATETIMECREATED = DateTime.Now,
            });
            if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

            auditTrail.AddAuditTrail(new TBL_AUDIT
            {
                AUDITTYPEID = (short)AuditTypeEnum.BulkLoanRecoveryReport,
                STAFFID = user.createdBy,
                BRANCHID = (short)user.BranchId,
                DETAIL = $"Added TBL_LOAN_RECOVERY_COMMISSION_BATCH '{ referenceNumber}' ",
                IPADDRESS = CommonHelpers.GetLocalIpAddress(),
                URL = user.applicationUrl,
                APPLICATIONDATE = generalSetup.GetApplicationDate(),
                SYSTEMDATETIME = DateTime.Now,
                DEVICENAME = CommonHelpers.GetDeviceName(),
                OSNAME = CommonHelpers.FriendlyName()
            });

            int resultStatus = context.SaveChanges();
            if (resultStatus > 0)
            {
                result = true;
            }

            return result;
        }

        public WorkflowResponse bulkLoanRecoveryCommissionGoForApproval(LoanRecoveryCommissionApprovalViewModel models, UserInfo user)
        {
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);
            if (models == null)
            {
                throw new ConditionNotMetException("Kindly select an accredited consultant/agent.");
            }

            //var validate = context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL.Where(x => x.REFERENCEID == models.referenceId
            //                                              && (x.APPROVALSTATUSID != (int)ApprovalStatusEnum.Pending
            //                                              || x.APPROVALSTATUSID == (int)ApprovalStatusEnum.Disapproved)).FirstOrDefault();
            //if (validate != null)
            //{
            //    throw new SecureException("Request already exist and undergoing approval");
            //}
            
                using (TransactionScope transactionScope = new TransactionScope())
                {


                    var data = context.TBL_LOAN_RECOVERY_COMMISSION_BATCH.Where(x => x.REFERENCEID == models.referenceId).ToList();
                    foreach (var d in data)
                    {
                        d.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                        d.COMMISSIONAMOUNT = models.commissionAmount;
                        d.COMMISSIONAMOUNTLESSWHT = models.commissionAmountLessWht;
                        d.WHTAMOUNT = models.whtAmount;
                        d.WHTRATE = models.whtRate;
                    }
                    context.SaveChanges();

                    var approval = context.TBL_LOAN_RECOVERY_COMMISSION_APPROVAL.Where(x => x.REFERENCEID == models.referenceId).FirstOrDefault();
                    approval.APPROVALSTATUSID = (int)ApprovalStatusEnum.Processing;
                    approval.AGENTACCOUNTNUMBER = models.agentAccountNumber;
                    approval.COMMENT = models.comment;
                    approval.DATEOFENGAGEMENT = models.dateOfEngagement == null ? DateTime.Now : models.dateOfEngagement;
                    approval.CREATEDBY = user.createdBy;
                    approval.COLLECTIONDATE = models.collectionDate;
                    approval.MODEOFCOLLECTION = models.modeOfCollection;
                    approval.COMMISSIONRATE = models.commissionRate;
                    if (context.SaveChanges() == 0) throw new SecureException("Error saving operation!");

                    workflow.StaffId = user.createdBy;
                    workflow.CompanyId = user.companyId;
                    workflow.StatusId = (int)ApprovalStatusEnum.Processing;
                    workflow.TargetId = approval.LOANRECOVERYCOMMISSIONAPPROVALID;
                    workflow.Comment = models.comment;
                    workflow.OperationId = (int)OperationsEnum.RecoveryCommission;
                    workflow.DeferredExecution = true;
                    workflow.ExternalInitialization = false;

                    var response = workflow.LogActivity();
                    context.SaveChanges();

                    transactionScope.Complete();

                    transactionScope.Dispose();

                }
            
            return workflow.Response;
        }

        private TBL_LOAN_RECOVERY_COMMISSION_BATCH addBulkLoanRecoveryCommission(LoanRecoveryCommissionBatchViewModel entity)
        {
            var data = new TBL_LOAN_RECOVERY_COMMISSION_BATCH
            {
                LOANID = entity.loanId,
                LOANREFERENCENUMBER = entity.loanReferenceNumber,
                CUSTOMERID = entity.customerId,
                ACCREDITEDCONSULTANT = entity.accreditedConsultant,
                DATETIMECREATED = DateTime.Now,
                CREATEDBY = entity.createdBy,
                REFERENCEID = entity.referenceId,
                OPERATIONID = entity.operationId,
                APPROVALSTATUSID = entity.approvalStatusId,
                OPERATIONCOMPLETED = entity.operationCompleted,
                TOTALAMOUNTRECOVERY = entity.totalAmountRecovery,
                AMOUNTRECOVERED = entity.amountRecovered,
                MISCODE = entity.misCode,
                REGION = entity.region,
                LOANRECOVERYREPORTBATCHID = entity.loanRecoveryReportBatchId
            };
            return data;
        }

        public bool ModifyLMSFacility(TBL_LMS_FACILITY_MODIFICATION model)
        {
            bool saved;
                var facility = context.TBL_LMSR_APPLICATION_DETAIL.Find(model.LOANAPPLICATIONDETAILID);
                var loan = context.TBL_LMSR_APPLICATION.Find(facility.LOANAPPLICATIONID);
                if (facility != null && loan != null)
                {
                    var difference = model.APPROVEDAMOUNT - facility.APPROVEDAMOUNT;
                    ArchiveLMSLoanApplication(facility.LOANAPPLICATIONID, (int)OperationsEnum.LoanReviewApprovalAppraisal, facility.APPROVALSTATUSID, model.CREATEDBY);
                    model.APPROVEDTENOR = ConvertTenorToDays(model.APPROVEDTENOR, model.TENORMODEID);
                    facility.PRODUCTID = model.APPROVEDPRODUCTID;
                    facility.APPROVEDINTERESTRATE = model.APPROVEDINTERESTRATE;
                    facility.APPROVEDTENOR = model.APPROVEDTENOR;
                    facility.PROPOSEDTENOR = model.APPROVEDTENOR;
                    facility.APPROVEDAMOUNT = model.APPROVEDAMOUNT;
                    facility.PROPOSEDAMOUNT = model.APPROVEDAMOUNT;
                    facility.REVIEWDETAILS = model.REVIEWDETAILS;
                }
                saved = context.SaveChanges() > 0;

            return saved;
        }

        public bool RetailLoanRecoveryCommission(RetailLoanRecoveryCommissionViewModel models, UserInfo user)
        {
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);
            if (models == null)
            {
                throw new ConditionNotMetException("Kindly select an accredited consultant/agent.");
            }

            try
            {
                var updateRecord = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(models.loanAssignId);
                /*if(updateRecord != null)
                {
                    if (updateRecord.TOTALAMOUNTRECOVERY == models.amountRecovered)
                    {
                        updateRecord.TOTALAMOUNTRECOVERY = 0;
                        updateRecord.ISFULLYRECOVERED = true;
                        updateRecord.OPERATIONCOMPLETED = true;
                    }
                    if (updateRecord.TOTALAMOUNTRECOVERY != models.amountRecovered)
                    {
                        updateRecord.TOTALAMOUNTRECOVERY = (updateRecord.TOTALAMOUNTRECOVERY - models.amountRecovered);
                    }
                    context.SaveChanges();
                }*/

                var record = new TBL_LOAN_RECOVERY_COMMISSION_RETAIL
                {
                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved,
                    AGENTACCOUNTNUMBER = models.agentAccountNumber,
                    COMMENT = models.comment,
                    DATEOFENGAGEMENT = models.dateOfEngagement == null ? DateTime.Now : models.dateOfEngagement,
                    CREATEDBY = user.createdBy,
                    COLLECTIONDATE = models.collectionDate,
                    MODEOFCOLLECTION = models.modeOfCollection,
                    COMMISSIONRATE = models.commissionRate,
                    DATETIMECREATED = DateTime.Now,
                    COMMISSIONPAYABLE = models.commissionPayable,
                    TOTALRECOVERYAMOUNT = models.totalAmountRecovery,
                    AMOUNTRECOVERED = models.amountRecovered,
                    LOANASSIGNID = models.loanAssignId,
                    LOANID = models.loanId,
                    LOANREFERENCE = models.loanReferenceNumber,
                    ACCREDITEDCONSULTANT = models.accreditedConsultant,
                    REFERENCEID = referenceNumber,
                    PRODUCTCLASSID = models.productClassId,
                    PRODUCTID = (int)models.productId,
                };
                context.TBL_LOAN_RECOVERY_COMMISSION_RETAIL.Add(record);
                var status = context.SaveChanges() != 0;
                return status;
            }
            catch(Exception ex)
            {
                throw ex;
            }
           
        }

        public bool RetailLoanRecoveryCommissionInternal(RetailLoanRecoveryCommissionViewModel models, UserInfo user)
        {
            if (models == null)
            {
                throw new ConditionNotMetException("Kindly select an accredited consultant/agent.");
            }


            if (models != null)
            {
                //bool validate = context.TBL_LOAN_RECOVERY_COMMISSION_INTERNAL.Where(x => x.AMOUNTRECOVERED == models.amountRecovered && x.TOTALRECOVERYAMOUNT == models.totalAmountRecovery && x.DATETIMECREATED.Month == DateTime.Now.Month && x.CREATEDBY == user.createdBy && x.ACCREDITEDCONSULTANT == models.accreditedConsultant).Any();
                bool validate = context.TBL_LOAN_RECOVERY_COMMISSION_INTERNAL.Where(x => x.AMOUNTRECOVERED == models.amountRecovered 
                && x.TOTALRECOVERYAMOUNT == models.totalAmountRecovery 
                && x.CREATEDBY == user.createdBy && x.ACCREDITEDCONSULTANT == models.accreditedConsultant
                && context.TBL_LOAN_RECOVERY_REPORT_COLLECTION.Any(rc => rc.COLLECTIONDATE.Value.Month == models.recoveryMonth.Value.Month)).Any();
                if (validate)
                {
                    throw new ConditionNotMetException("It looks like same commission has already been captured for this Agent");
                }
                
            }

            try
            {
                //bool validation = context.TBL_LOAN_RECOVERY_COMMISSION_INTERNAL.Where(x => x.ACCREDITEDCONSULTANT == models.accreditedConsultant && x.CREATEDBY == user.createdBy).Any();

                bool validation = context.TBL_LOAN_RECOVERY_COMMISSION_INTERNAL.Where(x => x.ACCREDITEDCONSULTANT == models.accreditedConsultant && x.CREATEDBY == user.createdBy && (x.VALIDATERECOVERYMONTH.Value.Month == models.recoveryMonth.Value.Month && x.VALIDATERECOVERYMONTH.Value.Year == models.recoveryMonth.Value.Year)).Any();


                if (validation) {
                    var validateRecord = context.TBL_LOAN_RECOVERY_COMMISSION_INTERNAL.Where(x => x.ACCREDITEDCONSULTANT == models.accreditedConsultant && x.CREATEDBY == user.createdBy && (x.VALIDATERECOVERYMONTH.Value.Month == models.recoveryMonth.Value.Month && x.VALIDATERECOVERYMONTH.Value.Year == models.recoveryMonth.Value.Year)).FirstOrDefault();

                    validateRecord.AGENTACCOUNTNUMBER = models.agentAccountNumber;
                    validateRecord.COMMENT = models.comment;
                    validateRecord.CREATEDBY = user.createdBy;
                    validateRecord.COMMISSIONRATE = models.commissionRate;
                    validateRecord.DATETIMECREATED = DateTime.Now;
                    validateRecord.COMMISSIONPAYABLE = models.commissionPayable;
                    validateRecord.TOTALRECOVERYAMOUNT = models.totalAmountRecovery;
                    validateRecord.AMOUNTRECOVERED = models.amountRecovered;
                    validateRecord.ACCREDITEDCONSULTANT = models.accreditedConsultant;
                    validateRecord.VALIDATERECOVERYMONTH = models.recoveryMonth;
                }
                else
                {
                    var record = new TBL_LOAN_RECOVERY_COMMISSION_INTERNAL
                    {
                        AGENTACCOUNTNUMBER = models.agentAccountNumber,
                        COMMENT = models.comment,
                        CREATEDBY = user.createdBy,
                        COMMISSIONRATE = models.commissionRate,
                        DATETIMECREATED = DateTime.Now,
                        COMMISSIONPAYABLE = models.commissionPayable,
                        TOTALRECOVERYAMOUNT = models.totalAmountRecovery,
                        AMOUNTRECOVERED = models.amountRecovered,
                        ACCREDITEDCONSULTANT = models.accreditedConsultant,
                        VALIDATERECOVERYMONTH = models.recoveryMonth
                    };
                    context.TBL_LOAN_RECOVERY_COMMISSION_INTERNAL.Add(record);
                   
                }
                var status = context.SaveChanges() != 0;
                return status;
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        public bool RetailLoanRecoveryReportCollection(RetailLoanRecoveryCommissionViewModel models, UserInfo user)
        {
            var referenceNumber = CommonHelpers.GenerateRandomDigitCode(10);
            if (models == null)
            {
                throw new ConditionNotMetException("Kindly select a transaction.");
            }

            try
            {
                var updateRecord = context.TBL_LOAN_RECOVERY_ASSIGNMENT.Find(models.loanAssignId);
                /*if (updateRecord != null)
                {
                    if (updateRecord.TOTALAMOUNTRECOVERY == models.amountRecovered)
                    {
                        updateRecord.TOTALAMOUNTRECOVERY = 0;
                        updateRecord.ISFULLYRECOVERED = true;
                        updateRecord.OPERATIONCOMPLETED = true;
                    }else
                    {
                        updateRecord.TOTALAMOUNTRECOVERY = (updateRecord.TOTALAMOUNTRECOVERY - models.amountRecovered);
                    }
                   
                }*/


                var record = new TBL_LOAN_RECOVERY_REPORT_COLLECTION
                {
                    APPROVALSTATUSID = (int)ApprovalStatusEnum.Approved,
                    AGENTACCOUNTNUMBER = models.agentAccountNumber,
                    COMMENT = models.comment,
                    DATEOFENGAGEMENT = models.dateOfEngagement == null ? DateTime.Now : models.dateOfEngagement,
                    CREATEDBY = user.createdBy,
                    COLLECTIONDATE = models.collectionDate,
                    MODEOFCOLLECTION = models.modeOfCollection,
                    DATETIMECREATED = DateTime.Now,
                    TOTALRECOVERYAMOUNT = models.totalAmountRecovery,
                    AMOUNTRECOVERED = models.amountRecovered,
                    LOANASSIGNID = models.loanAssignId,
                    LOANREFERENCE = models.loanReferenceNumber,
                    ACCREDITEDCONSULTANT = models.accreditedConsultant,
                    REFERENCEID = referenceNumber,
                    PRODUCTCLASSID = models.productClassId,
                    PRODUCTID = (int)models.productId,
                    ISDIGITAL = updateRecord.ISDIGITAL,

                };
                context.TBL_LOAN_RECOVERY_REPORT_COLLECTION.Add(record);
                var status = context.SaveChanges() != 0;
                return status;
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }


        public CloseMannualBookingResponseViewModel GetLoanBookingDetailsFromFlexcube(CloseMannualBookingViewModel model)
        {
            
            if (model.loan_accountno == null)
            {
                throw new ConditionNotMetException("Flexcube reference number is null");
            }

            model.channel_code = "FINTRAK";

            CloseMannualBookingResponseViewModel result = null;
            Task.Run(async () => result = await transaction.ValidateMannualBookingClosure(model)).GetAwaiter().GetResult();

            if (result!= null && result?.response_code == "00")
            {
                if (result.response_message.ToLower() == "successful")
                {
                    return new CloseMannualBookingResponseViewModel { response_code = result.response_code, response_message = result.response_message.ToLower(), loandetailsresp = result.loandetailsresp };
                }
                else
                {
                    throw new ConditionNotMetException("Core Banking API Error " + result.response_message.ToLower() + " -  Kindly Contact System Administrator!");
                }
            }
            else
            {
                throw new APIErrorException("Core Banking API Error " + result.response_message.ToLower() + " -  Kindly Contact System Administrator!");
            }
        }


        private CloseMannualBookingResponseViewModel GetLoanBookingDetailFromFlexcube(string loan_accountno)
        {
            CloseMannualBookingViewModel model = new CloseMannualBookingViewModel();
            model.loan_accountno = loan_accountno;
            if (model.loan_accountno == null)
            {
                throw new ConditionNotMetException("Flexcube reference number is null");
            }

            model.channel_code = "FINTRAK";

            CloseMannualBookingResponseViewModel result = null;
            Task.Run(async () => result = await transaction.ValidateMannualBookingClosure(model)).GetAwaiter().GetResult();

            if (result != null && result.response_code == "00")
            {
                if (result.response_message.ToLower() == "successful")
                {
                    return new CloseMannualBookingResponseViewModel { response_code = result.response_code, response_message = result.response_message.ToLower(), loandetailsresp = result.loandetailsresp };
                }
                else
                {
                    throw new ConditionNotMetException("Core Banking API Error 203 " + result.response_message.ToLower() + " - Kindly Contact System Administrator!");
                }
            }
            else
            {
                throw new APIErrorException("Core Banking API Error 204 " + result.response_message.ToLower() + "- Kindly Contact System Administrator!");
            }
        }


    }
}